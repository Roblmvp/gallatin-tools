<!DOCTYPE html>
<html lang="en">
<head>
<script>
(function(){
  var rep = null;
  try { rep = JSON.parse(sessionStorage.getItem('sb_rep') || 'null'); } catch(e) {}
  if (!rep || !rep.name || !rep.role) { window.location.replace('/login.html'); }
  if (rep.role.toLowerCase() !== 'admin') { window.location.replace('/app.html'); }
})();
</script>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#06080E">
<title>Admin Console ‚Äî ServiceBridge</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Instrument+Serif:ital@0;1&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #06080E; --bg2: #0C0F18;
  --surface: #111520; --surface2: #171C2A; --surface3: #1D2333;
  --red: #E01B36; --red-soft: rgba(224,27,54,0.10); --red-glow: rgba(224,27,54,0.25);
  --gold: #D4A73A; --gold-soft: rgba(212,167,58,0.10);
  --green: #2DD4A0; --green-soft: rgba(45,212,160,0.10);
  --blue: #6C70F0; --blue-soft: rgba(108,112,240,0.10);
  --orange: #F59E0B; --orange-soft: rgba(245,158,11,0.10);
  --purple: #A855F7; --purple-soft: rgba(168,85,247,0.10);
  --text: #EDEEF2; --text2: rgba(237,238,242,0.62); --text3: rgba(237,238,242,0.34);
  --border: rgba(255,255,255,0.06); --border2: rgba(255,255,255,0.10); --border3: rgba(255,255,255,0.16);
  --r: 14px; --rsm: 10px; --rlg: 18px;
  --spring: cubic-bezier(0.16, 1, 0.3, 1);
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
html { scroll-behavior: smooth; }
body {
  background: var(--bg); color: var(--text);
  font-family: 'Plus Jakarta Sans', -apple-system, sans-serif;
  min-height: 100vh; overflow-x: hidden;
  -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
  font-size: 15px; line-height: 1.5; letter-spacing: -0.01em;
}

/* ‚îÄ‚îÄ Background ‚îÄ‚îÄ */
.bg-noise { position:fixed;inset:0;z-index:0;pointer-events:none;opacity:0.35;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E"); }
.bg-grad { position:fixed;inset:0;z-index:0;pointer-events:none;background:radial-gradient(ellipse 60% 50% at 20% 0%,rgba(108,112,240,0.06) 0%,transparent 70%),radial-gradient(ellipse 50% 60% at 80% 100%,rgba(224,27,54,0.04) 0%,transparent 70%); }

/* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
.app-header {
  display:flex;align-items:center;justify-content:space-between;
  padding:14px 24px 12px; padding-top:max(14px, env(safe-area-inset-top));
  border-bottom:1px solid var(--border);
  background:rgba(6,8,14,0.92);backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);
  position:sticky;top:0;z-index:100;
}
.app-header::after { content:'';position:absolute;bottom:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--blue),var(--purple),transparent);opacity:0.5; }
.header-left { display:flex;align-items:center;gap:12px; }
.header-logo { width:30px;height:30px;background:var(--blue);border-radius:8px;display:flex;align-items:center;justify-content:center; }
.header-logo svg { width:14px;height:14px; }
.header-title { font-family:'Instrument Serif',Georgia,serif;font-size:17px;letter-spacing:-0.01em;color:var(--text); }
.header-sep { width:1px;height:16px;background:var(--border3); }
.header-product { font-size:10px;font-weight:700;letter-spacing:0.14em;text-transform:uppercase;color:var(--text3); }
.header-right { display:flex;align-items:center;gap:10px;position:relative; }
.header-user-pill { display:flex;align-items:center;gap:8px;background:var(--surface);border:1px solid var(--border);border-radius:30px;padding:4px 12px 4px 4px; }
.header-avatar { width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,var(--gold),var(--orange));display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;color:var(--bg);flex-shrink:0;font-family:'JetBrains Mono',monospace; }
.header-user-name { font-size:12px;font-weight:600;color:var(--text);white-space:nowrap; }
.header-role-badge { font-size:9px;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;padding:2px 8px;border-radius:10px;background:var(--gold-soft);color:var(--gold);border:1px solid rgba(212,167,58,0.2); }

/* Hamburger */
.hamburger { background:none;border:1px solid var(--border2);border-radius:8px;width:34px;height:34px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;cursor:pointer;transition:all 0.18s;padding:0;flex-shrink:0; }
.hamburger:hover { border-color:rgba(255,255,255,0.18);background:rgba(255,255,255,0.03); }
.hamburger span { display:block;width:14px;height:1.5px;background:rgba(255,255,255,0.55);border-radius:2px;transition:all 0.2s; }
.hamburger.open span:nth-child(1) { transform:translateY(5.5px) rotate(45deg); }
.hamburger.open span:nth-child(2) { opacity:0; }
.hamburger.open span:nth-child(3) { transform:translateY(-5.5px) rotate(-45deg); }

/* Dropdown */
.nav-overlay { position:fixed;inset:0;z-index:190;display:none; }
.nav-overlay.open { display:block; }
.nav-dropdown { position:absolute;top:calc(100% + 8px);right:0;background:var(--surface);border:1px solid var(--border2);border-radius:var(--r);min-width:230px;padding:6px;box-shadow:0 20px 60px rgba(0,0,0,0.6);z-index:201;opacity:0;transform:translateY(-8px) scale(0.97);pointer-events:none;transition:all 0.18s var(--spring); }
.nav-dropdown.open { opacity:1;transform:translateY(0) scale(1);pointer-events:all; }
.dd-item { display:flex;align-items:center;gap:10px;padding:11px 14px;border-radius:var(--rsm);font-size:13px;font-weight:600;color:var(--text2);text-decoration:none;cursor:pointer;transition:all 0.15s; }
.dd-item:hover { background:rgba(255,255,255,0.04);color:var(--text); }
.dd-item.active-page { background:var(--blue-soft);color:var(--blue); }
.dd-item.danger { color:#FC8181; }
.dd-item.danger:hover { background:rgba(239,68,68,0.08); }
.dd-icon { font-size:14px;width:20px;text-align:center; }
.dd-divider { height:1px;background:var(--border);margin:4px 0; }
.dd-header { padding:10px 14px 6px; }
.dd-header-name { font-size:13px;font-weight:700;color:var(--text); }
.dd-header-role { font-size:11px;color:var(--text3);margin-top:1px; }

/* ‚îÄ‚îÄ Tab Navigation ‚îÄ‚îÄ */
.tab-bar {
  display:flex;gap:0;padding:0 24px;
  background:var(--bg2);border-bottom:1px solid var(--border);
  overflow-x:auto;scrollbar-width:none;position:relative;z-index:1;
}
.tab-bar::-webkit-scrollbar { display:none; }
.tab-btn {
  padding:12px 18px;font-size:11px;font-weight:700;
  letter-spacing:0.08em;text-transform:uppercase;
  color:var(--text3);border-bottom:2px solid transparent;
  cursor:pointer;transition:all 0.18s;white-space:nowrap;
  background:none;border-top:none;border-left:none;border-right:none;
  font-family:'Plus Jakarta Sans',sans-serif;
}
.tab-btn:hover { color:var(--text2); }
.tab-btn.active { color:var(--blue);border-bottom-color:var(--blue); }

/* ‚îÄ‚îÄ Page ‚îÄ‚îÄ */
.page { max-width:1200px;margin:0 auto;padding:28px 24px 80px;position:relative;z-index:1; }
.tab-panel { display:none; }
.tab-panel.active { display:block; }

/* ‚îÄ‚îÄ Section Headers ‚îÄ‚îÄ */
.sh { display:flex;align-items:flex-end;justify-content:space-between;margin:0 0 18px; }
.sh-title { font-family:'Instrument Serif',Georgia,serif;font-size:26px;letter-spacing:-0.02em;color:var(--text); }
.sh-desc { font-size:13px;color:var(--text3);margin-top:3px; }
.sh-actions { display:flex;gap:8px;flex-shrink:0; }

/* ‚îÄ‚îÄ KPI Tiles ‚îÄ‚îÄ */
.kpi-grid { display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:24px; }
.kpi-tile {
  background:var(--surface);border:1px solid var(--border);border-radius:var(--r);
  padding:18px 18px;position:relative;overflow:hidden;
  transition:transform 0.2s var(--spring);
}
.kpi-tile:hover { transform:translateY(-2px); }
.kpi-tile::before { content:'';position:absolute;top:0;left:0;right:0;height:2px; }
.k-blue::before { background:var(--blue); } .k-green::before { background:var(--green); }
.k-red::before { background:var(--red); } .k-gold::before { background:var(--gold); }
.kpi-label { font-size:9px;font-weight:700;letter-spacing:0.14em;text-transform:uppercase;color:var(--text3);margin-bottom:8px; }
.kpi-val { font-family:'Instrument Serif',Georgia,serif;font-size:36px;line-height:1; }
.k-blue .kpi-val { color:var(--blue); } .k-green .kpi-val { color:var(--green); }
.k-red .kpi-val { color:#F87171; } .k-gold .kpi-val { color:var(--gold); }

/* ‚îÄ‚îÄ Cards ‚îÄ‚îÄ */
.card {
  background:var(--surface);border:1px solid var(--border);border-radius:var(--rlg);
  padding:22px 22px;margin-bottom:14px;
}
.card-title { font-family:'Instrument Serif',Georgia,serif;font-size:18px;margin-bottom:16px;color:var(--text); }
.grid-2 { display:grid;grid-template-columns:1fr 1fr;gap:14px; }

/* ‚îÄ‚îÄ Dealer Cards ‚îÄ‚îÄ */
.dealer-card {
  background:var(--surface);border:1px solid var(--border);border-radius:var(--rlg);
  padding:22px;position:relative;overflow:hidden;
}
.dealer-card::before { content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--blue),var(--purple)); }
.dealer-name { font-family:'Instrument Serif',Georgia,serif;font-size:20px;color:var(--text);margin-bottom:3px; }
.dealer-id { font-size:10px;font-weight:600;letter-spacing:0.1em;text-transform:uppercase;color:var(--text3);margin-bottom:14px; }
.dealer-stats { display:grid;grid-template-columns:1fr 1fr;gap:8px; }
.dealer-stat { background:var(--bg2);border:1px solid var(--border);border-radius:var(--rsm);padding:10px 12px; }
.dealer-stat-val { font-family:'Instrument Serif',Georgia,serif;font-size:22px;color:var(--blue); }
.dealer-stat-lbl { font-size:9px;font-weight:600;letter-spacing:0.1em;text-transform:uppercase;color:var(--text3);margin-top:2px; }
.dealer-footer { margin-top:14px;display:flex;align-items:center;justify-content:space-between; }
.status-badge { display:inline-flex;align-items:center;gap:5px;padding:4px 12px;border-radius:20px;font-size:10px;font-weight:700;letter-spacing:0.06em; }
.s-active { background:var(--green-soft);color:var(--green);border:1px solid rgba(45,212,160,0.2); }
.dealer-add {
  border:2px dashed var(--border2);background:transparent;border-radius:var(--rlg);
  padding:22px;display:flex;flex-direction:column;align-items:center;justify-content:center;
  min-height:220px;cursor:pointer;transition:all 0.2s;
}
.dealer-add:hover { border-color:var(--border3);background:rgba(255,255,255,0.02); }
.dealer-add-icon { font-size:32px;margin-bottom:10px;opacity:0.4; }
.dealer-add-title { font-family:'Instrument Serif',Georgia,serif;font-size:16px;color:var(--text2); }
.dealer-add-sub { font-size:12px;color:var(--text3);margin-top:4px; }

/* ‚îÄ‚îÄ Form Elements ‚îÄ‚îÄ */
.form-group { margin-bottom:14px; }
.form-label { font-size:10px;font-weight:700;letter-spacing:0.12em;text-transform:uppercase;color:var(--text3);display:block;margin-bottom:6px; }
.form-input {
  width:100%;background:var(--bg2);border:1.5px solid var(--border2);border-radius:var(--rsm);
  color:var(--text);font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;
  padding:10px 14px;outline:none;transition:border-color 0.18s;-webkit-appearance:none;
}
.form-input:focus { border-color:var(--blue);box-shadow:0 0 0 3px rgba(108,112,240,0.1); }
.form-input::placeholder { color:var(--text3);opacity:0.5; }
select.form-input {
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath fill='rgba(237,238,242,0.34)' d='M5 6L0 0h10z'/%3E%3C/svg%3E");
  background-repeat:no-repeat;background-position:right 12px center;padding-right:32px;cursor:pointer;
}
select.form-input option { background:var(--surface); }

/* ‚îÄ‚îÄ Buttons ‚îÄ‚îÄ */
.btn-primary { background:var(--blue);color:#fff;border:none;border-radius:var(--rsm);font-family:'Plus Jakarta Sans',sans-serif;font-size:12px;font-weight:700;letter-spacing:0.04em;padding:10px 22px;cursor:pointer;transition:all 0.18s var(--spring); }
.btn-primary:hover { transform:translateY(-1px);box-shadow:0 4px 16px rgba(108,112,240,0.3); }
.btn-dark { background:var(--surface2);color:var(--text);border:1.5px solid var(--border2);border-radius:var(--rsm);font-family:'Plus Jakarta Sans',sans-serif;font-size:12px;font-weight:700;letter-spacing:0.04em;padding:10px 22px;cursor:pointer;transition:all 0.18s; }
.btn-dark:hover { border-color:var(--border3);background:var(--surface3); }
.btn-outline { background:transparent;color:var(--blue);border:1.5px solid rgba(108,112,240,0.3);border-radius:var(--rsm);font-family:'Plus Jakarta Sans',sans-serif;font-size:12px;font-weight:700;letter-spacing:0.04em;padding:9px 18px;cursor:pointer;transition:all 0.18s; }
.btn-outline:hover { background:var(--blue-soft); }
.btn-red { background:var(--red-soft);color:#FC8181;border:1px solid rgba(224,27,54,0.25);border-radius:var(--rsm);font-family:'Plus Jakarta Sans',sans-serif;font-size:12px;font-weight:700;padding:9px 18px;cursor:pointer;transition:all 0.18s; }
.btn-red:hover { background:rgba(224,27,54,0.18); }
.btn-sm { padding:6px 14px;font-size:11px; }

/* ‚îÄ‚îÄ Table ‚îÄ‚îÄ */
.tbl-wrap { overflow-x:auto;border-radius:var(--rsm);border:1px solid var(--border); }
table { width:100%;border-collapse:collapse;font-size:12px; }
thead tr { background:var(--surface2); }
thead th { padding:10px 14px;text-align:left;font-size:9px;font-weight:700;letter-spacing:0.12em;text-transform:uppercase;color:var(--text3);white-space:nowrap; }
tbody tr { border-bottom:1px solid var(--border);transition:background 0.12s; }
tbody tr:hover { background:rgba(108,112,240,0.03); }
td { padding:10px 14px;color:var(--text2);font-size:12px; }
td:first-child { font-family:'JetBrains Mono',monospace;color:var(--text3);font-size:11px; }

/* ‚îÄ‚îÄ Rep Rows ‚îÄ‚îÄ */
.rep-row { display:flex;align-items:center;justify-content:space-between;padding:14px 0;border-bottom:1px solid var(--border); }
.rep-row:last-child { border-bottom:none; }
.rep-info { display:flex;align-items:center;gap:12px; }
.rep-avatar { width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:#fff;font-family:'JetBrains Mono',monospace;flex-shrink:0; }
.rep-name-lg { font-weight:700;font-size:14px;color:var(--text); }
.rep-meta { font-size:11px;color:var(--text3);margin-top:1px; }
.rep-actions { display:flex;align-items:center;gap:10px; }
.rep-count { font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--text3); }

/* ‚îÄ‚îÄ Email Log ‚îÄ‚îÄ */
.email-log-row { display:flex;align-items:flex-start;gap:12px;padding:12px 0;border-bottom:1px solid var(--border); }
.email-log-row:last-child { border-bottom:none; }
.email-dot { width:8px;height:8px;border-radius:50%;margin-top:5px;flex-shrink:0; }
.dot-hot { background:var(--red); } .dot-daily { background:var(--blue); } .dot-system { background:var(--text3); }
.email-log-subject { font-size:13px;font-weight:600;color:var(--text); }
.email-log-meta { font-size:11px;color:var(--text3);margin-top:2px; }

/* ‚îÄ‚îÄ Export Bar ‚îÄ‚îÄ */
.export-bar { display:flex;gap:8px;margin-bottom:18px;flex-wrap:wrap; }
.export-btn { display:inline-flex;align-items:center;gap:6px;padding:9px 16px;border-radius:var(--rsm);font-size:12px;font-weight:700;cursor:pointer;border:none;font-family:'Plus Jakarta Sans',sans-serif;transition:all 0.18s; }
.export-csv { background:var(--green-soft);border:1px solid rgba(45,212,160,0.2);color:var(--green); }
.export-csv:hover { background:rgba(45,212,160,0.18);transform:translateY(-1px); }
.export-pdf { background:var(--red-soft);border:1px solid rgba(224,27,54,0.2);color:#FC8181; }
.export-pdf:hover { background:rgba(224,27,54,0.18);transform:translateY(-1px); }

/* ‚îÄ‚îÄ Alert ‚îÄ‚îÄ */
.alert { padding:12px 16px;border-radius:var(--rsm);font-size:12px;font-weight:600;margin-bottom:14px;display:none; }
.alert.show { display:block; }
.alert-success { background:var(--green-soft);color:var(--green);border:1px solid rgba(45,212,160,0.2); }
.alert-error { background:var(--red-soft);color:#FC8181;border:1px solid rgba(224,27,54,0.2); }

/* ‚îÄ‚îÄ Loading ‚îÄ‚îÄ */
.loading { text-align:center;padding:40px;color:var(--text3);font-size:13px; }
.spinner { display:inline-block;width:16px;height:16px;border:2px solid var(--border2);border-top-color:var(--blue);border-radius:50%;animation:spin 0.7s linear infinite;margin-right:8px;vertical-align:middle; }
@keyframes spin { to{transform:rotate(360deg);} }

/* ‚îÄ‚îÄ Modal ‚îÄ‚îÄ */
.modal-overlay { position:fixed;inset:0;background:rgba(0,0,0,0.7);display:none;align-items:center;justify-content:center;z-index:500;padding:20px; }
.modal-overlay.open { display:flex; }
.modal {
  background:var(--surface);border:1px solid var(--border2);border-radius:var(--rlg);
  padding:28px;width:100%;max-width:480px;position:relative;
}
.modal::before { content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--blue),var(--purple));border-radius:var(--rlg) var(--rlg) 0 0; }
.modal-title { font-family:'Instrument Serif',Georgia,serif;font-size:24px;margin-bottom:4px; }
.modal-desc { font-size:13px;color:var(--text3);margin-bottom:22px; }
.modal-actions { display:flex;gap:10px;justify-content:flex-end;margin-top:22px; }

/* ‚îÄ‚îÄ Sync Label ‚îÄ‚îÄ */
.sync-label { font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--text3); }

/* ‚îÄ‚îÄ Responsive ‚îÄ‚îÄ */
@media(max-width:900px){
  .kpi-grid { grid-template-columns:repeat(2,1fr); }
  .grid-2 { grid-template-columns:1fr; }
  .header-user-name { display:none; }
}
@media(max-width:600px){
  .page { padding:20px 16px 80px; }
  .card { padding:18px 16px; }
  .app-header { padding:12px 16px; }
}

@keyframes fadeUp { from{opacity:0;transform:translateY(12px);} to{opacity:1;transform:translateY(0);} }
.fade-in { animation:fadeUp 0.4s ease both; }
</style>
</head>
<body>

<div class="bg-noise"></div>
<div class="bg-grad"></div>

<!-- ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ -->
<header class="app-header">
  <div class="header-left">
    <div class="header-logo">
      <svg viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2.5" stroke-linecap="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
    </div>
    <div class="header-title">ServiceBridge</div>
    <div class="header-sep"></div>
    <div class="header-product">Admin Console</div>
  </div>
  <div class="header-right">
    <div class="header-user-pill">
      <div class="header-avatar" id="nav-avatar">RL</div>
      <span class="header-user-name" id="nav-name"></span>
      <span class="header-role-badge">Admin</span>
    </div>
    <button class="hamburger" id="hamburger" onclick="toggleMenu()" aria-label="Menu">
      <span></span><span></span><span></span>
    </button>
    <div class="nav-dropdown" id="nav-dropdown">
      <div class="dd-header">
        <div class="dd-header-name" id="dd-name"></div>
        <div class="dd-header-role">Admin ¬∑ ServiceBridge</div>
      </div>
      <div class="dd-divider"></div>
      <a href="app.html" class="dd-item"><span class="dd-icon">üè†</span> Home</a>
      <a href="service-to-sales-log.html" class="dd-item"><span class="dd-icon">üìã</span> S2S Entry</a>
      <a href="manager-dashboard.html" class="dd-item"><span class="dd-icon">üìä</span> Dashboard</a>
      <a href="scorecards.html" class="dd-item"><span class="dd-icon">üèÜ</span> Scorecards</a>
      <div class="dd-divider"></div>
      <a href="admin-panel.html" class="dd-item active-page"><span class="dd-icon">‚öôÔ∏è</span> Admin Panel</a>
      <div class="dd-divider"></div>
      <button class="dd-item danger" onclick="signOut()"><span class="dd-icon">üö™</span> Sign Out</button>
    </div>
  </div>
</header>
<div class="nav-overlay" id="nav-overlay" onclick="closeMenu()"></div>

<!-- ‚îÄ‚îÄ TAB BAR ‚îÄ‚îÄ -->
<div class="tab-bar">
  <button class="tab-btn active" onclick="showTab('overview',this)">üìä Overview</button>
  <button class="tab-btn" onclick="showTab('dealers',this)">üè¢ Dealers</button>
  <button class="tab-btn" onclick="showTab('reps',this)">üë§ Rep Management</button>
  <button class="tab-btn" onclick="showTab('emails',this)">üìß Email Settings</button>
  <button class="tab-btn" onclick="showTab('data',this)">üóÑ Data</button>
</div>

<div class="page">

  <div class="export-bar fade-in" style="margin-top:4px;">
    <button class="export-btn export-csv" onclick="adminExportCSV()">‚¨á S2S Entries ‚Äî CSV</button>
    <button class="export-btn export-pdf" onclick="adminExportPDF()">üñ® S2S Entries ‚Äî Print</button>
  </div>

  <!-- ‚ïê‚ïê‚ïê OVERVIEW ‚ïê‚ïê‚ïê -->
  <div class="tab-panel active fade-in" id="tab-overview">
    <div class="sh">
      <div><div class="sh-title">Platform Overview</div><div class="sh-desc">ServiceBridge across all dealers</div></div>
      <div class="sync-label" id="overview-sync">‚Äî</div>
    </div>
    <div class="kpi-grid">
      <div class="kpi-tile k-blue"><div class="kpi-label">Total Dealers</div><div class="kpi-val">1</div></div>
      <div class="kpi-tile k-green"><div class="kpi-label">Total Entries</div><div class="kpi-val" id="kpi-entries">‚Äî</div></div>
      <div class="kpi-tile k-gold"><div class="kpi-label">Vehicles Sold</div><div class="kpi-val" id="kpi-sold">‚Äî</div></div>
      <div class="kpi-tile k-red"><div class="kpi-label">Hot Leads</div><div class="kpi-val" id="kpi-hot">‚Äî</div></div>
    </div>
    <div class="grid-2">
      <div class="card">
        <div class="card-title">Recent Entries</div>
        <div id="recent-list"><div class="loading"><span class="spinner"></span> Loading...</div></div>
      </div>
      <div class="card">
        <div class="card-title">Email Notification Log</div>
        <div id="email-log">
          <div class="email-log-row"><div class="email-dot dot-system"></div><div><div class="email-log-subject">System initializing...</div><div class="email-log-meta">Waiting for first activity</div></div></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê DEALERS ‚ïê‚ïê‚ïê -->
  <div class="tab-panel" id="tab-dealers">
    <div class="sh">
      <div><div class="sh-title">Dealer Management</div><div class="sh-desc">All ServiceBridge dealer accounts</div></div>
      <button class="btn-primary" onclick="openModal('dealer-modal')">+ Add Dealer</button>
    </div>
    <div class="grid-2">
      <div class="dealer-card">
        <div class="dealer-name">Gallatin CDJR</div>
        <div class="dealer-id">Dealer ID: gallatin-cdjr ¬∑ WeAuto Group</div>
        <div class="dealer-stats">
          <div class="dealer-stat"><div class="dealer-stat-val" id="gs-entries">‚Äî</div><div class="dealer-stat-lbl">Total Entries</div></div>
          <div class="dealer-stat"><div class="dealer-stat-val" id="gs-sold">‚Äî</div><div class="dealer-stat-lbl">Sold</div></div>
          <div class="dealer-stat"><div class="dealer-stat-val" id="gs-conv">‚Äî</div><div class="dealer-stat-lbl">Conv. Rate</div></div>
          <div class="dealer-stat"><div class="dealer-stat-val" id="gs-hot">‚Äî</div><div class="dealer-stat-lbl">Hot Leads</div></div>
        </div>
        <div class="dealer-footer">
          <span class="status-badge s-active">‚óè Active</span>
          <div style="display:flex;gap:8px;">
            <a href="manager-dashboard.html" class="btn-outline btn-sm">Dashboard</a>
            <a href="service-to-sales-log.html" class="btn-dark btn-sm">Form</a>
          </div>
        </div>
      </div>
      <div class="dealer-add" onclick="openModal('dealer-modal')">
        <div class="dealer-add-icon">+</div>
        <div class="dealer-add-title">Add New Dealer</div>
        <div class="dealer-add-sub">Onboard next ServiceBridge client</div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê REP MANAGEMENT ‚ïê‚ïê‚ïê -->
  <div class="tab-panel" id="tab-reps">
    <div class="sh">
      <div><div class="sh-title">Rep Management</div><div class="sh-desc">Gallatin CDJR S2S Team</div></div>
      <button class="btn-primary" onclick="openModal('rep-modal')">+ Add Rep</button>
    </div>
    <div class="card">
      <div id="alert-rep" class="alert"></div>
      <div id="reps-list"></div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê EMAIL SETTINGS ‚ïê‚ïê‚ïê -->
  <div class="tab-panel" id="tab-emails">
    <div class="sh"><div><div class="sh-title">Email Notifications</div><div class="sh-desc">Alert and reporting configuration</div></div></div>
    <div class="grid-2">
      <div class="card">
        <div class="card-title">üî• Hot Lead Alerts</div>
        <p style="font-size:13px;color:var(--text3);margin-bottom:16px;">Instant email when buying temp of 8+ is submitted.</p>
        <div class="form-group"><label class="form-label">Status</label>
          <select class="form-input" id="hot-status"><option value="enabled">‚úÖ Enabled</option><option value="disabled">‚ùå Disabled</option></select>
        </div>
        <div class="form-group"><label class="form-label">Trigger Threshold</label>
          <select class="form-input" id="hot-threshold"><option value="8">8+ (Hot leads only)</option><option value="7">7+ (Warm & hot)</option><option value="9">9+ (Very hot only)</option></select>
        </div>
        <button class="btn-primary" onclick="alert('Hot lead alert settings saved.')">Save Settings</button>
      </div>
      <div class="card">
        <div class="card-title">üìÖ Daily Summary Report</div>
        <p style="font-size:13px;color:var(--text3);margin-bottom:16px;">Morning email with previous day's S2S activity.</p>
        <div class="form-group"><label class="form-label">Status</label>
          <select class="form-input" id="daily-status"><option value="enabled">‚úÖ Enabled</option><option value="disabled">‚ùå Disabled</option></select>
        </div>
        <div class="form-group"><label class="form-label">Send Time (CT)</label>
          <select class="form-input" id="daily-time"><option value="9:00">9:00 AM CT</option><option value="7:00">7:00 AM CT</option><option value="8:00">8:00 AM CT</option><option value="10:00">10:00 AM CT</option></select>
        </div>
        <button class="btn-primary" onclick="alert('Daily summary settings saved.')">Save Settings</button>
      </div>
    </div>
    <div class="card">
      <div class="card-title">üì¨ Notification Recipients</div>
      <p style="font-size:13px;color:var(--text3);margin-bottom:14px;">All emails below receive hot lead alerts and daily reports.</p>
      <div id="recipients-list"></div>
      <div style="display:flex;gap:10px;margin-top:14px;">
        <input class="form-input" type="email" id="new-recipient" placeholder="Add email address..." style="flex:1;">
        <button class="btn-primary" onclick="addRecipient()">Add</button>
      </div>
    </div>
    <div class="card">
      <div class="card-title">üß™ Test Email System</div>
      <p style="font-size:13px;color:var(--text3);margin-bottom:14px;">Send a test to verify the system is working.</p>
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
        <input class="form-input" type="email" id="test-email" placeholder="Send test to..." style="width:260px;" value="Rob.l@gallatincdjr.com">
        <button class="btn-outline" onclick="sendTestEmail()">Send Test Alert</button>
        <button class="btn-dark" onclick="sendTestSummary()">Send Test Summary</button>
      </div>
      <div id="test-result" class="alert" style="margin-top:12px;"></div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê DATA ‚ïê‚ïê‚ïê -->
  <div class="tab-panel" id="tab-data">
    <div class="sh">
      <div><div class="sh-title">Data Management</div><div class="sh-desc">View and manage all S2S entries</div></div>
      <div class="sh-actions">
        <button class="btn-dark" onclick="exportAllCSV()">‚¨á Export All CSV</button>
        <button class="btn-red" onclick="confirmDeleteAll()">‚úï Delete All</button>
      </div>
    </div>
    <div class="card" style="padding:0;overflow:hidden;">
      <div class="tbl-wrap">
        <table>
          <thead><tr><th>ID</th><th>Date</th><th>Submitter</th><th>Customer</th><th>Outcome</th><th>Temp</th><th>Vehicle</th><th>Actions</th></tr></thead>
          <tbody id="data-tbody"><tr><td colspan="8"><div class="loading"><span class="spinner"></span> Loading...</div></td></tr></tbody>
        </table>
      </div>
    </div>
  </div>

</div>

<!-- ‚ïê‚ïê‚ïê ADD DEALER MODAL ‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="dealer-modal">
  <div class="modal">
    <div class="modal-title">Add New Dealer</div>
    <div class="modal-desc">Onboard a new ServiceBridge client with their own isolated data.</div>
    <div class="form-group"><label class="form-label">Dealership Name</label><input class="form-input" id="new-dealer-name" placeholder="e.g. Nashville CDJR"></div>
    <div class="form-group"><label class="form-label">Dealer Group</label><input class="form-input" id="new-dealer-group" placeholder="e.g. WeAuto Group"></div>
    <div class="form-group"><label class="form-label">Primary Contact Email</label><input class="form-input" type="email" id="new-dealer-email" placeholder="manager@dealership.com"></div>
    <div class="form-group"><label class="form-label">City, State</label><input class="form-input" id="new-dealer-location" placeholder="Nashville, TN"></div>
    <div class="modal-actions">
      <button class="btn-outline" onclick="closeModalById('dealer-modal')">Cancel</button>
      <button class="btn-primary" onclick="addDealer()">Create Dealer</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê ADD REP MODAL ‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="rep-modal">
  <div class="modal">
    <div class="modal-title">Add Rep</div>
    <div class="modal-desc">Add a new salesperson to the Gallatin CDJR S2S team.</div>
    <div class="form-group"><label class="form-label">Full Name</label><input class="form-input" id="new-rep-name" placeholder="e.g. John Smith"></div>
    <div class="form-group"><label class="form-label">Role</label>
      <select class="form-input" id="new-rep-role"><option>Sales</option><option>S2S Manager</option><option>Finance Manager</option></select>
    </div>
    <div class="modal-actions">
      <button class="btn-outline" onclick="closeModalById('rep-modal')">Cancel</button>
      <button class="btn-primary" onclick="addRep()">Add Rep</button>
    </div>
  </div>
</div>

<script>
const SB_URL='https://jbkgwtohwsbaorhvuuqb.supabase.co';
const SB_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impia2d3dG9od3NiYW9yaHZ1dXFiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5NjkwNDIsImV4cCI6MjA4NzU0NTA0Mn0.GRXOYbIuVDxU9-FEBYmyd1QmytVUrMIAxbnOSfepzuU';
const H={'apikey':SB_KEY,'Authorization':'Bearer '+SB_KEY,'Content-Type':'application/json'};

let RECIPIENTS=['Rob.l@gallatincdjr.com','Tyler.d@gallatincdjr.com','Joe.s@gallatincdjr.com','Jbarba@weauto.us','dominick.f@gallatincdjr.com','Mich.s@gallatincdjr.com'];
let REPS=[{name:'Tyler Doyle',role:'S2S Manager',color:'linear-gradient(135deg,#D4A73A,#F59E0B)'},{name:'Andrew Kirk',role:'Sales',color:'linear-gradient(135deg,#6C70F0,#A855F7)'},{name:'DJ Rogers',role:'Sales',color:'linear-gradient(135deg,#2DD4A0,#14B8A6)'},{name:'Kody McCann',role:'Sales',color:'linear-gradient(135deg,#E01B36,#F87171)'}];
let ALL_ENTRIES=[];
let emailLog=[];

// ‚îÄ‚îÄ Session & Nav ‚îÄ‚îÄ
const currentRep=JSON.parse(sessionStorage.getItem('sb_rep')||'null');
(function initNav(){
  if(!currentRep) return;
  document.getElementById('nav-avatar').textContent=currentRep.initials||currentRep.name.slice(0,2).toUpperCase();
  document.getElementById('nav-name').textContent=currentRep.name.split(' ')[0];
  document.getElementById('dd-name').textContent=currentRep.name;
})();

function toggleMenu(){
  const hb=document.getElementById('hamburger'),dd=document.getElementById('nav-dropdown'),ov=document.getElementById('nav-overlay');
  const isOpen=dd.classList.contains('open');
  hb.classList.toggle('open',!isOpen);dd.classList.toggle('open',!isOpen);ov.classList.toggle('open',!isOpen);
}
function closeMenu(){
  document.getElementById('hamburger').classList.remove('open');
  document.getElementById('nav-dropdown').classList.remove('open');
  document.getElementById('nav-overlay').classList.remove('open');
}
function signOut(){sessionStorage.removeItem('sb_rep');window.location.replace('/login.html');}

// ‚îÄ‚îÄ Tabs ‚îÄ‚îÄ
function showTab(id,el){
  document.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(t=>t.classList.remove('active'));
  document.getElementById('tab-'+id).classList.add('active');
  el.classList.add('active');
}

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ
async function init(){
  await loadEntries();
  renderOverview();renderReps();renderRecipients();renderDataTable();updateDealerStats();
  document.getElementById('overview-sync').textContent='Last sync: '+new Date().toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:true});
}

async function loadEntries(){
  try{const res=await fetch(`${SB_URL}/rest/v1/s2s_entries?select=*&order=id.desc&limit=1000`,{headers:H});if(res.ok)ALL_ENTRIES=await res.json();}catch(e){console.error(e);}
}

// ‚îÄ‚îÄ Overview ‚îÄ‚îÄ
function renderOverview(){
  const n=ALL_ENTRIES.length;
  const sold=ALL_ENTRIES.filter(e=>e.outcome&&(e.outcome.includes('New')||e.outcome.includes('Used'))).length;
  const hot=ALL_ENTRIES.filter(e=>parseInt(e.eng_score)>=8).length;
  document.getElementById('kpi-entries').textContent=n;
  document.getElementById('kpi-sold').textContent=sold;
  document.getElementById('kpi-hot').textContent=hot;
  const recent=ALL_ENTRIES.slice(0,6);
  document.getElementById('recent-list').innerHTML=recent.length?recent.map(e=>`
    <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border);">
      <div><div style="font-weight:700;font-size:13px;color:var(--text);">${e.first_name||''} ${e.last_name||''}</div>
      <div style="font-size:11px;color:var(--text3);">${e.submitter||'‚Äî'} ¬∑ ${e.timestamp||'‚Äî'}</div></div>
      <div style="text-align:right;">
        <div style="font-size:11px;font-weight:700;color:${e.outcome&&e.outcome.includes('Sold')?'var(--green)':e.outcome==='Follow-Up Required'?'var(--gold)':'var(--text3)'};">${e.outcome||'‚Äî'}</div>
        <div style="font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--text3);">Temp: ${e.eng_score||'‚Äî'}</div>
      </div>
    </div>`).join(''):'<div style="text-align:center;padding:30px;color:var(--text3);">No entries yet</div>';
}

function updateDealerStats(){
  const n=ALL_ENTRIES.length;
  const sold=ALL_ENTRIES.filter(e=>e.outcome&&(e.outcome.includes('New')||e.outcome.includes('Used'))).length;
  const hot=ALL_ENTRIES.filter(e=>parseInt(e.eng_score)>=8).length;
  document.getElementById('gs-entries').textContent=n;
  document.getElementById('gs-sold').textContent=sold;
  document.getElementById('gs-conv').textContent=n?Math.round((sold/n)*100)+'%':'0%';
  document.getElementById('gs-hot').textContent=hot;
}

// ‚îÄ‚îÄ Rep Management ‚îÄ‚îÄ
function renderReps(){
  document.getElementById('reps-list').innerHTML=REPS.map((r,i)=>`
    <div class="rep-row">
      <div class="rep-info">
        <div class="rep-avatar" style="background:${r.color||'var(--surface3)'};">${r.name.split(' ').map(w=>w[0]).join('')}</div>
        <div><div class="rep-name-lg">${r.name}</div><div class="rep-meta">${r.role} ¬∑ Gallatin CDJR</div></div>
      </div>
      <div class="rep-actions">
        <span class="rep-count">${ALL_ENTRIES.filter(e=>e.submitter===r.name).length} entries</span>
        <button class="btn-red btn-sm" onclick="removeRep(${i})">Remove</button>
      </div>
    </div>`).join('');
}

function addRep(){
  const name=document.getElementById('new-rep-name').value.trim();
  const role=document.getElementById('new-rep-role').value;
  if(!name){alert('Enter a name.');return;}
  REPS.push({name,role,color:'linear-gradient(135deg,var(--blue),var(--purple))'});
  renderReps();closeModalById('rep-modal');document.getElementById('new-rep-name').value='';
  showAlert('rep','Rep added successfully. Update the S2S form HTML to include this rep.',true);
}
function removeRep(i){if(!confirm(`Remove ${REPS[i].name}?`))return;REPS.splice(i,1);renderReps();}

// ‚îÄ‚îÄ Email Recipients ‚îÄ‚îÄ
function renderRecipients(){
  document.getElementById('recipients-list').innerHTML=RECIPIENTS.map((r,i)=>`
    <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border);">
      <span style="font-size:13px;color:var(--text);">${r}</span>
      <button class="btn-red btn-sm" onclick="removeRecipient(${i})">Remove</button>
    </div>`).join('');
}
function addRecipient(){
  const v=document.getElementById('new-recipient').value.trim();
  if(!v||!v.includes('@')){alert('Enter a valid email.');return;}
  RECIPIENTS.push(v);renderRecipients();document.getElementById('new-recipient').value='';
}
function removeRecipient(i){RECIPIENTS.splice(i,1);renderRecipients();}

// ‚îÄ‚îÄ Email Sending ‚îÄ‚îÄ
async function sendEmail(to,subject,html){
  try{
    const res=await fetch('/api/send-email',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({to:Array.isArray(to)?to:[to],subject,html})});
    const data=await res.json();
    addEmailLog(subject,data.success?'sent':'failed');
    return data.success?{success:true}:{success:false,error:data.error};
  }catch(err){addEmailLog(subject,'failed');return{success:false,error:err.message};}
}

function addEmailLog(subject,status){
  emailLog.unshift({subject,status,time:new Date().toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:true})});
  const el=document.getElementById('email-log');
  if(el)el.innerHTML=emailLog.slice(0,8).map(e=>`
    <div class="email-log-row"><div class="email-dot ${e.status==='sent'?'dot-daily':'dot-hot'}"></div><div><div class="email-log-subject">${e.subject}</div><div class="email-log-meta">${e.status==='sent'?'‚úì Sent':'‚úó Failed'} ¬∑ ${e.time}</div></div></div>`).join('');
}

async function sendTestEmail(){
  const to=document.getElementById('test-email').value;
  const result=document.getElementById('test-result');
  result.className='alert show';result.style.display='block';result.textContent='Sending...';result.style.color='var(--text2)';result.style.background='var(--surface2)';result.style.borderColor='var(--border2)';
  const html=buildHotLeadEmail({first_name:'Test',last_name:'Customer',phone:'(615) 555-0100',veh_year:'2019',veh_make:'Ram',veh_model:'1500',eng_score:9,outcome:'Follow-Up Required',submitter:'Tyler Doyle',visit_reason:'Major Mechanical Repair',repair_cost:'$3,200',trade_equity:'Positive Equity',timeline:'Within 30 Days',notes:'Test alert from Admin Console',timestamp:new Date().toLocaleString()});
  const res=await sendEmail(to,'üî• [TEST] Hot Lead Alert ‚Äî ServiceBridge',html);
  result.className=`alert alert-${res.success?'success':'error'} show`;
  result.textContent=res.success?'‚úì Test email sent! Check your inbox.':'‚úó Failed: '+(res.error||'Check API setup');
}

async function sendTestSummary(){
  const to=document.getElementById('test-email').value;
  const result=document.getElementById('test-result');
  result.className='alert show';result.style.display='block';result.textContent='Sending summary...';result.style.color='var(--text2)';result.style.background='var(--surface2)';result.style.borderColor='var(--border2)';
  const html=buildDailySummaryEmail(ALL_ENTRIES.slice(0,5));
  const res=await sendEmail(to,'üìä [TEST] Daily S2S Summary ‚Äî Gallatin CDJR',html);
  result.className=`alert alert-${res.success?'success':'error'} show`;
  result.textContent=res.success?'‚úì Summary sent! Check your inbox.':'‚úó Failed: '+(res.error||'Check API setup');
}

// ‚îÄ‚îÄ Email Templates ‚îÄ‚îÄ
function buildHotLeadEmail(e){
  const tc=parseInt(e.eng_score)>=9?'#C8102E':'#C49A2A';
  return`<!DOCTYPE html><html><body style="margin:0;padding:0;background:#F5F4F1;font-family:Arial,sans-serif;"><div style="max-width:600px;margin:0 auto;padding:24px 16px;"><div style="background:#0C0C14;border-radius:12px 12px 0 0;padding:24px 28px;"><div style="font-size:11px;font-weight:600;letter-spacing:0.2em;text-transform:uppercase;color:rgba(255,255,255,0.4);margin-bottom:6px;">Vyaxis ¬∑ ServiceBridge</div><div style="font-size:24px;font-weight:700;color:#fff;margin-bottom:4px;">üî• Hot Lead Alert</div><div style="font-size:13px;color:rgba(255,255,255,0.5);">Gallatin CDJR ¬∑ Service Drive</div></div><div style="background:#fff;padding:28px;border-left:1px solid #E4E2DC;border-right:1px solid #E4E2DC;"><div style="display:inline-block;background:${tc};color:#fff;border-radius:6px;padding:6px 16px;font-size:13px;font-weight:700;margin-bottom:20px;">üå° Buying Temp: ${e.eng_score}/10</div><table style="width:100%;border-collapse:collapse;">${[['Customer',`${e.first_name} ${e.last_name}`],['Phone',e.phone||'‚Äî'],['Vehicle',`${e.veh_year||''} ${e.veh_make||''} ${e.veh_model||''}`],['Visit Reason',e.visit_reason||'‚Äî'],['Repair Cost',e.repair_cost||'‚Äî'],['Equity',e.trade_equity||'‚Äî'],['Timeline',e.timeline||'‚Äî'],['Logged By',e.submitter||'‚Äî'],['Outcome',e.outcome||'‚Äî']].map(([k,v])=>`<tr><td style="padding:8px 0;border-bottom:1px solid #F0EEEB;font-size:11px;font-weight:600;letter-spacing:0.1em;text-transform:uppercase;color:#8C897F;width:35%;">${k}</td><td style="padding:8px 0;border-bottom:1px solid #F0EEEB;font-size:13px;">${v}</td></tr>`).join('')}</table>${e.notes?`<div style="background:#F5F4F1;border-radius:6px;padding:14px 16px;margin-top:16px;"><div style="font-size:10px;font-weight:600;letter-spacing:0.1em;text-transform:uppercase;color:#8C897F;margin-bottom:6px;">Notes</div><div style="font-size:13px;">${e.notes}</div></div>`:''}<div style="margin-top:20px;"><a href="https://servicebridge.vyaxis.com/manager-dashboard.html" style="display:inline-block;background:#C8102E;color:#fff;text-decoration:none;border-radius:6px;padding:12px 24px;font-size:13px;font-weight:600;">View in Dashboard ‚Üí</a></div></div><div style="background:#EDECEA;border:1px solid #E4E2DC;border-top:none;border-radius:0 0 12px 12px;padding:16px 28px;text-align:center;"><div style="font-size:11px;color:#8C897F;">ServiceBridge by Vyaxis ¬∑ Gallatin CDJR ¬∑ ${e.timestamp||new Date().toLocaleString()}</div></div></div></body></html>`;
}

function buildDailySummaryEmail(entries){
  const n=entries.length,sold=entries.filter(e=>e.outcome&&(e.outcome.includes('New')||e.outcome.includes('Used'))).length;
  const appts=entries.filter(e=>e.outcome==='Appointment Set').length,hot=entries.filter(e=>parseInt(e.eng_score)>=8).length;
  const temps=entries.map(e=>parseInt(e.eng_score)).filter(t=>!isNaN(t));
  const avg=temps.length?(temps.reduce((a,b)=>a+b,0)/temps.length).toFixed(1):'‚Äî';
  return`<!DOCTYPE html><html><body style="margin:0;padding:0;background:#F5F4F1;font-family:Arial,sans-serif;"><div style="max-width:600px;margin:0 auto;padding:24px 16px;"><div style="background:#0C0C14;border-radius:12px 12px 0 0;padding:24px 28px;"><div style="font-size:11px;font-weight:600;letter-spacing:0.2em;text-transform:uppercase;color:rgba(255,255,255,0.4);margin-bottom:6px;">Vyaxis ¬∑ ServiceBridge</div><div style="font-size:24px;font-weight:700;color:#fff;margin-bottom:4px;">üìä Daily S2S Summary</div></div><div style="background:#fff;padding:28px;border-left:1px solid #E4E2DC;border-right:1px solid #E4E2DC;"><div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:24px;">${[['Total',n,'#0C0C14'],['Sold',sold,'#166534'],['Appts',appts,'#1E3A8A'],['Follow-Ups',entries.filter(e=>e.outcome==='Follow-Up Required').length,'#C49A2A'],['Hot (8+)',hot,'#C8102E'],['Avg Temp',avg,'#7C3AED']].map(([l,v,c])=>`<div style="background:#F5F4F1;border-radius:8px;padding:14px;text-align:center;"><div style="font-size:24px;font-weight:700;color:${c};">${v}</div><div style="font-size:10px;font-weight:600;letter-spacing:0.1em;text-transform:uppercase;color:#8C897F;margin-top:4px;">${l}</div></div>`).join('')}</div>${n>0?`<table style="width:100%;border-collapse:collapse;"><tr style="background:#0C0C14;"><th style="padding:8px 12px;text-align:left;font-size:10px;font-weight:600;letter-spacing:0.1em;text-transform:uppercase;color:rgba(255,255,255,0.7);">Customer</th><th style="padding:8px 12px;text-align:left;font-size:10px;font-weight:600;letter-spacing:0.1em;text-transform:uppercase;color:rgba(255,255,255,0.7);">Rep</th><th style="padding:8px 12px;text-align:left;font-size:10px;font-weight:600;letter-spacing:0.1em;text-transform:uppercase;color:rgba(255,255,255,0.7);">Temp</th><th style="padding:8px 12px;text-align:left;font-size:10px;font-weight:600;letter-spacing:0.1em;text-transform:uppercase;color:rgba(255,255,255,0.7);">Outcome</th></tr>${entries.slice(0,8).map((e,i)=>`<tr style="background:${i%2?'#FAFAF8':'#fff'};"><td style="padding:8px 12px;font-size:12px;">${e.first_name||''} ${e.last_name||''}</td><td style="padding:8px 12px;font-size:12px;">${e.submitter||'‚Äî'}</td><td style="padding:8px 12px;font-size:12px;font-weight:700;">${e.eng_score||'‚Äî'}</td><td style="padding:8px 12px;font-size:12px;">${e.outcome||'‚Äî'}</td></tr>`).join('')}</table>`:'<div style="text-align:center;padding:30px;color:#8C897F;">No entries.</div>'}<div style="margin-top:20px;"><a href="https://servicebridge.vyaxis.com/manager-dashboard.html" style="display:inline-block;background:#0C0C14;color:#fff;text-decoration:none;border-radius:6px;padding:12px 24px;font-size:13px;font-weight:600;">Open Dashboard ‚Üí</a></div></div><div style="background:#EDECEA;border:1px solid #E4E2DC;border-top:none;border-radius:0 0 12px 12px;padding:16px 28px;text-align:center;"><div style="font-size:11px;color:#8C897F;">ServiceBridge ¬∑ Daily report ¬∑ 9:00 AM CT</div></div></div></body></html>`;
}

// ‚îÄ‚îÄ Data Table ‚îÄ‚îÄ
function renderDataTable(){
  const tbody=document.getElementById('data-tbody');
  if(!ALL_ENTRIES.length){tbody.innerHTML='<tr><td colspan="8" style="text-align:center;padding:30px;color:var(--text3);">No entries yet</td></tr>';return;}
  tbody.innerHTML=ALL_ENTRIES.map(e=>`<tr>
    <td>${e.id}</td>
    <td style="font-size:11px;color:var(--text2);">${e.timestamp||'‚Äî'}</td>
    <td style="font-weight:700;color:var(--text);">${e.submitter||'‚Äî'}</td>
    <td style="color:var(--text);">${e.first_name||''} ${e.last_name||''}</td>
    <td><span style="font-size:11px;font-weight:700;color:${e.outcome&&e.outcome.includes('Sold')?'var(--green)':e.outcome==='Follow-Up Required'?'var(--gold)':'var(--text2)'};">${e.outcome||'‚Äî'}</span></td>
    <td style="font-family:'JetBrains Mono',monospace;font-weight:700;color:${parseInt(e.eng_score)>=8?'#F87171':parseInt(e.eng_score)>=5?'var(--gold)':'var(--text3)'};">${e.eng_score||'‚Äî'}</td>
    <td style="font-size:11px;">${[e.veh_year,e.veh_make,e.veh_model].filter(Boolean).join(' ')||'‚Äî'}</td>
    <td><button class="btn-red btn-sm" onclick="deleteEntry(${e.id})">Delete</button></td>
  </tr>`).join('');
}

async function deleteEntry(id){
  if(!confirm(`Delete entry #${id}?`))return;
  await fetch(`${SB_URL}/rest/v1/s2s_entries?id=eq.${id}`,{method:'DELETE',headers:H});
  ALL_ENTRIES=ALL_ENTRIES.filter(e=>e.id!==id);
  renderDataTable();renderOverview();updateDealerStats();
}

// ‚îÄ‚îÄ Exports ‚îÄ‚îÄ
function toCSV(rows,headers){
  const esc=v=>{if(v==null)return'';const s=String(v).replace(/"/g,'""');return s.includes(',')||s.includes('"')||s.includes('\n')?`"${s}"`:s;};
  return[headers.join(','),...rows.map(r=>headers.map(h=>esc(r[h])).join(','))].join('\n');
}

function exportAllCSV(){
  if(!ALL_ENTRIES.length)return alert('No entries.');
  const keys=Object.keys(ALL_ENTRIES[0]);
  const blob=new Blob([[keys.join(','),...ALL_ENTRIES.map(e=>keys.map(k=>`"${(e[k]??'').toString().replace(/"/g,'""')}"`).join(','))].join('\n')],{type:'text/csv'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`ServiceBridge_AllData_${new Date().toISOString().slice(0,10)}.csv`;a.click();
}

async function adminExportCSV(){
  const res=await fetch(`${SB_URL}/rest/v1/s2s_entries?select=*&order=id.desc&limit=2000`,{headers:H});
  const data=await res.json();
  if(!data.length)return alert('No entries found.');
  const hdrs=['id','submitter','first_name','last_name','phone','email','veh_year','veh_make','veh_model','repair_cost','eng_score','outcome','followup_status','manager_outcome','manager_claimed_by','manager_notes','notes','created_at'];
  const blob=new Blob([toCSV(data,hdrs)],{type:'text/csv'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`s2s-entries-${new Date().toISOString().slice(0,10)}.csv`;a.click();
}

async function adminExportPDF(){
  const res=await fetch(`${SB_URL}/rest/v1/s2s_entries?select=*&order=id.desc&limit=2000`,{headers:H});
  const data=await res.json();
  if(!data.length)return alert('No entries found.');
  const date=new Date().toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
  const rows=data.map(e=>`<tr><td>${e.submitter||'‚Äî'}</td><td>${e.first_name||''} ${e.last_name||''}</td><td>${e.phone||'‚Äî'}</td><td>${e.veh_year||''} ${e.veh_make||''} ${e.veh_model||''}</td><td>${e.repair_cost?'$'+e.repair_cost:'‚Äî'}</td><td style="text-align:center;font-weight:700;">${e.eng_score||'‚Äî'}</td><td>${e.outcome||'‚Äî'}</td><td>${e.followup_status||'Pending'}</td><td>${e.created_at?new Date(e.created_at).toLocaleString('en-US',{month:'short',day:'numeric',hour:'numeric',minute:'2-digit'}):'‚Äî'}</td></tr>`).join('');
  const w=window.open('','_blank');
  w.document.write(`<!DOCTYPE html><html><head><title>S2S Export</title><style>body{font-family:Arial,sans-serif;font-size:11px;padding:24px;}h1{font-size:18px;margin-bottom:4px;}.sub{color:#666;font-size:12px;margin-bottom:16px;}table{width:100%;border-collapse:collapse;}th{background:#0C0C14;color:#fff;padding:8px 10px;text-align:left;font-size:10px;text-transform:uppercase;letter-spacing:0.08em;}td{padding:7px 10px;border-bottom:1px solid #eee;}tr:nth-child(even) td{background:#f9f9f9;}</style></head><body><h1>ServiceBridge ‚Äî S2S Entries</h1><div class="sub">Gallatin CDJR ¬∑ Exported ${date} ¬∑ ${data.length} entries</div><table><thead><tr><th>Rep</th><th>Customer</th><th>Phone</th><th>Vehicle</th><th>Repair $</th><th>Temp</th><th>Outcome</th><th>Follow-Up</th><th>Date</th></tr></thead><tbody>${rows}</tbody></table></body></html>`);
  w.document.close();setTimeout(()=>w.print(),500);
}

async function confirmDeleteAll(){
  if(!confirm('DELETE ALL entries? This cannot be undone.'))return;
  const code=prompt('Type CONFIRM:');
  if(code!=='CONFIRM'){alert('Cancelled.');return;}
  await fetch(`${SB_URL}/rest/v1/s2s_entries?id=gte.0`,{method:'DELETE',headers:H});
  ALL_ENTRIES=[];renderDataTable();renderOverview();updateDealerStats();
}

// ‚îÄ‚îÄ Dealers ‚îÄ‚îÄ
function addDealer(){
  const name=document.getElementById('new-dealer-name').value.trim();
  if(!name){alert('Enter dealer name.');return;}
  alert(`Dealer "${name}" created. Next: clone form/dashboard HTML, update dealer_id, deploy to subdomain.`);
  closeModalById('dealer-modal');
}

// ‚îÄ‚îÄ Utils ‚îÄ‚îÄ
function openModal(id){document.getElementById(id).classList.add('open');}
function closeModalById(id){document.getElementById(id).classList.remove('open');}
function showAlert(id,msg,success){
  const el=document.getElementById('alert-'+id);
  el.className=`alert ${success?'alert-success':'alert-error'} show`;
  el.textContent=msg;setTimeout(()=>el.classList.remove('show'),4000);
}
document.querySelectorAll('.modal-overlay').forEach(m=>m.addEventListener('click',e=>{if(e.target===m)m.classList.remove('open');}));

init();
</script>
</body>
</html>
