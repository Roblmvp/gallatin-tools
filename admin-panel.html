<!DOCTYPE html>
<html lang="en">
<head>
  <script>
(function(){
  const rep = JSON.parse(sessionStorage.getItem('sb_rep') || 'null');
  if (!rep || rep.role !== 'Admin') {
    window.location.replace('/login.html');
  }
})();
</script>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ServiceBridge Admin ‚Äî Vyaxis</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Serif+Display:ital@0;1&family=DM+Sans:wght@300;400;500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root{
  --ink:#0C0C14;--ink2:#15151F;--surface:#F5F4F1;--card:#FFFFFF;
  --border:#E4E2DC;--muted:#8C897F;--text:#18171A;--subtext:#6A6760;
  --red:#C8102E;--red-dark:#9B0D22;--red-light:#FEF2F3;
  --gold:#C49A2A;--gold-light:#FDF9EF;
  --green:#14532D;--green-mid:#166534;--green-light:#F0FDF4;
  --blue:#1E3A8A;--blue-light:#EFF6FF;
  --purple:#7C3AED;--purple-light:#F5F3FF;
  --r:10px;--rsm:6px;
  --sh:0 1px 3px rgba(0,0,0,0.06),0 4px 20px rgba(0,0,0,0.05);
  --sh-lg:0 12px 48px rgba(0,0,0,0.14);
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
body{background:var(--surface);color:var(--text);font-family:'DM Sans',sans-serif;min-height:100vh;-webkit-font-smoothing:antialiased;}

/* ‚ïê‚ïê NAV ‚ïê‚ïê */
.admin-nav{
  background:var(--ink);
  height:62px;
  display:flex;align-items:center;justify-content:space-between;
  padding:0 28px;
  position:sticky;top:0;z-index:200;
  border-bottom:1px solid rgba(255,255,255,0.08);
}
.admin-nav::after{content:'';position:absolute;bottom:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--purple),var(--blue));}
.nav-brand{font-family:'Bebas Neue',sans-serif;font-size:22px;letter-spacing:0.06em;background:linear-gradient(90deg,#fff,rgba(255,255,255,0.6));-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.nav-sep{width:1px;height:18px;background:rgba(255,255,255,0.15);}
.nav-product{font-size:10px;font-weight:700;letter-spacing:0.16em;text-transform:uppercase;color:rgba(255,255,255,0.4);}
.nav-left{display:flex;align-items:center;gap:14px;}
.nav-right{display:flex;align-items:center;gap:10px;}

/* User pill */
.nav-user-pill{
  display:flex;align-items:center;gap:8px;
  background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);
  border-radius:100px;padding:4px 14px 4px 4px;cursor:pointer;
}
.nav-avatar{
  width:32px;height:32px;border-radius:50%;
  background:linear-gradient(135deg,var(--purple),var(--blue));
  display:flex;align-items:center;justify-content:center;
  font-size:11px;font-weight:700;color:#fff;letter-spacing:0.04em;
}
.nav-user-name{font-size:13px;font-weight:600;color:#fff;}
.nav-role-pill{
  font-size:9px;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;
  background:rgba(124,58,237,0.2);color:#A78BFA;
  padding:3px 8px;border-radius:4px;
}

/* Hamburger */
.hamburger{width:36px;height:36px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:5px;cursor:pointer;background:none;border:none;padding:0;}
.hamburger span{width:20px;height:2px;background:#fff;border-radius:2px;transition:all 0.25s;}
.hamburger.open span:nth-child(1){transform:rotate(45deg) translate(5px,5px);}
.hamburger.open span:nth-child(2){opacity:0;}
.hamburger.open span:nth-child(3){transform:rotate(-45deg) translate(5px,-5px);}

/* Dropdown */
.nav-dropdown{
  position:fixed;top:62px;right:16px;width:260px;
  background:var(--ink2);border:1px solid rgba(255,255,255,0.1);
  border-radius:var(--r);box-shadow:var(--sh-lg);
  transform:translateY(-8px);opacity:0;pointer-events:none;
  transition:all 0.2s;z-index:300;padding:8px;
}
.nav-dropdown.open{transform:translateY(4px);opacity:1;pointer-events:auto;}
.dd-header{padding:14px 12px;border-bottom:1px solid rgba(255,255,255,0.08);margin-bottom:4px;}
.dd-header-name{font-weight:700;color:#fff;font-size:14px;}
.dd-header-role{font-size:11px;color:rgba(255,255,255,0.4);margin-top:2px;}
.dd-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:var(--rsm);font-size:13px;font-weight:500;color:rgba(255,255,255,0.7);text-decoration:none;cursor:pointer;transition:background 0.15s;border:none;background:none;width:100%;font-family:inherit;}
.dd-item:hover{background:rgba(255,255,255,0.06);color:#fff;}
.dd-item.danger{color:#F87171;}
.dd-item.danger:hover{background:rgba(248,113,113,0.1);}
.dd-icon{font-size:16px;width:22px;text-align:center;}
.dd-divider{height:1px;background:rgba(255,255,255,0.08);margin:4px 0;}

/* Nav Tabs */
.nav-wrap{
  display:flex;gap:0;background:var(--card);border-bottom:1px solid var(--border);
  padding:0 28px;overflow-x:auto;-webkit-overflow-scrolling:touch;
}
.nav-tab{
  padding:14px 20px;font-size:12px;font-weight:600;letter-spacing:0.04em;
  color:var(--muted);cursor:pointer;border-bottom:2px solid transparent;
  white-space:nowrap;transition:all 0.18s;
}
.nav-tab:hover{color:var(--text);}
.nav-tab.active{color:var(--purple);border-bottom-color:var(--purple);}

/* Page */
.page{max-width:1200px;margin:0 auto;padding:20px 28px 80px;}
.tab-panel{display:none;}
.tab-panel.active{display:block;}

/* Section header */
.sh{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;gap:16px;flex-wrap:wrap;}
.sh-title{font-family:'DM Serif Display',serif;font-size:22px;color:var(--text);}
.sh-desc{font-size:12px;color:var(--muted);margin-top:2px;}

/* Cards */
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--r);padding:24px;box-shadow:var(--sh);}
.card-title{font-weight:700;font-size:14px;margin-bottom:16px;display:flex;align-items:center;gap:8px;}

/* KPI Grid */
.grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px;}
.kpi-tile{background:var(--card);border:1px solid var(--border);border-radius:var(--r);padding:20px;box-shadow:var(--sh);}
.kpi-label{font-size:11px;font-weight:600;letter-spacing:0.08em;text-transform:uppercase;color:var(--muted);margin-bottom:8px;}
.kpi-val{font-family:'DM Mono',monospace;font-size:28px;font-weight:700;}
.k-purple .kpi-val{color:var(--purple);}
.k-green .kpi-val{color:var(--green);}
.k-blue .kpi-val{color:var(--blue);}
.k-red .kpi-val{color:var(--red);}

/* Forms */
.form-group{margin-bottom:16px;}
.form-label{display:block;font-size:11px;font-weight:600;letter-spacing:0.08em;text-transform:uppercase;color:var(--muted);margin-bottom:6px;}
.form-input{
  width:100%;padding:10px 14px;border:1.5px solid var(--border);border-radius:var(--rsm);
  font-family:'DM Sans',sans-serif;font-size:13px;color:var(--text);
  background:#FAFAF8;transition:border-color 0.18s;
}
.form-input:focus{outline:none;border-color:var(--purple);box-shadow:0 0 0 3px rgba(124,58,237,0.1);}
.form-input::placeholder{color:#C2BFB9;}
select.form-input{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath fill='%238C897F' d='M5 6L0 0h10z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center;padding-right:32px;cursor:pointer;appearance:none;}

/* BTNS */
.btn-primary{background:var(--purple);color:#fff;border:none;border-radius:var(--rsm);font-family:'DM Sans',sans-serif;font-size:12px;font-weight:600;letter-spacing:0.06em;padding:10px 22px;cursor:pointer;transition:background 0.18s;}
.btn-primary:hover{background:#6D28D9;}
.btn-dark{background:var(--ink);color:#fff;border:none;border-radius:var(--rsm);font-family:'DM Sans',sans-serif;font-size:12px;font-weight:600;letter-spacing:0.06em;padding:10px 22px;cursor:pointer;transition:background 0.18s;}
.btn-dark:hover{background:#000;}
.btn-outline{background:transparent;color:var(--purple);border:1.5px solid var(--purple);border-radius:var(--rsm);font-family:'DM Sans',sans-serif;font-size:12px;font-weight:600;letter-spacing:0.06em;padding:9px 20px;cursor:pointer;transition:all 0.18s;}
.btn-outline:hover{background:var(--purple-light);}
.btn-red{background:var(--red);color:#fff;border:none;border-radius:var(--rsm);font-family:'DM Sans',sans-serif;font-size:12px;font-weight:600;letter-spacing:0.06em;padding:9px 20px;cursor:pointer;transition:background 0.18s;}
.btn-red:hover{background:var(--red-dark);}
.btn-sm{padding:6px 14px;font-size:11px;}
.btn-green{background:var(--green);color:#fff;border:none;border-radius:var(--rsm);font-family:'DM Sans',sans-serif;font-size:12px;font-weight:600;letter-spacing:0.06em;padding:9px 20px;cursor:pointer;transition:background 0.18s;}
.btn-green:hover{background:var(--green-mid);}

/* REP TABLE */
.rep-row{display:flex;align-items:center;justify-content:space-between;padding:14px 0;border-bottom:1px solid var(--border);}
.rep-row:last-child{border-bottom:none;}
.rep-info{display:flex;flex-direction:column;gap:3px;}
.rep-name-lg{font-weight:600;font-size:14px;}
.rep-meta{font-size:11px;color:var(--muted);}
.rep-actions{display:flex;align-items:center;gap:8px;}

/* EMAIL LOG */
.email-log-row{display:flex;align-items:flex-start;gap:14px;padding:14px 0;border-bottom:1px solid var(--border);}
.email-log-row:last-child{border-bottom:none;}
.email-dot{width:8px;height:8px;border-radius:50%;margin-top:4px;flex-shrink:0;}
.dot-hot{background:var(--red);}
.dot-daily{background:var(--blue);}
.dot-system{background:var(--muted);}
.email-log-info{flex:1;}
.email-log-subject{font-weight:600;font-size:13px;}
.email-log-meta{font-size:11px;color:var(--muted);margin-top:2px;}

/* Tables */
.tbl-wrap{overflow-x:auto;}
table{width:100%;border-collapse:collapse;font-size:12px;}
th{text-align:left;padding:10px 12px;font-size:10px;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;color:var(--muted);border-bottom:2px solid var(--border);}
td{padding:10px 12px;border-bottom:1px solid var(--border);vertical-align:middle;}

/* Status badges */
.status-badge{font-size:10px;font-weight:700;padding:3px 10px;border-radius:100px;letter-spacing:0.04em;}
.s-active{background:var(--green-light);color:var(--green);}
.s-inactive{background:var(--red-light);color:var(--red);}

/* Loading */
.loading{text-align:center;padding:40px;color:var(--muted);}
.spinner{display:inline-block;width:18px;height:18px;border:2px solid var(--border);border-top-color:var(--purple);border-radius:50%;animation:spin 0.6s linear infinite;margin-right:8px;vertical-align:middle;}
@keyframes spin{to{transform:rotate(360deg)}}

/* Alert */
.alert{padding:12px 16px;border-radius:var(--rsm);font-size:13px;font-weight:500;display:none;margin-bottom:16px;}
.alert.show{display:block;}
.alert.success{background:var(--green-light);color:var(--green);border:1px solid rgba(20,83,45,0.15);}
.alert.error{background:var(--red-light);color:var(--red);border:1px solid rgba(200,16,46,0.15);}
.alert.info{background:var(--blue-light);color:var(--blue);border:1px solid rgba(30,58,138,0.15);}

/* Modal */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:500;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity 0.2s;backdrop-filter:blur(4px);}
.modal-overlay.open{opacity:1;pointer-events:auto;}
.modal{background:var(--card);border-radius:12px;padding:32px;max-width:560px;width:90%;max-height:90vh;overflow-y:auto;box-shadow:var(--sh-lg);transform:translateY(8px);transition:transform 0.2s;}
.modal-overlay.open .modal{transform:translateY(0);}
.modal-title{font-family:'DM Serif Display',serif;font-size:20px;margin-bottom:4px;}
.modal-desc{font-size:13px;color:var(--muted);margin-bottom:24px;}
.modal-actions{display:flex;justify-content:flex-end;gap:10px;margin-top:24px;padding-top:20px;border-top:1px solid var(--border);}

/* Dealer cards */
.dealer-card{background:var(--card);border:1px solid var(--border);border-radius:var(--r);padding:24px;box-shadow:var(--sh);}
.dealer-name{font-family:'DM Serif Display',serif;font-size:18px;margin-bottom:4px;}
.dealer-id{font-size:11px;color:var(--muted);margin-bottom:16px;}
.dealer-stats{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;padding:16px 0;border-top:1px solid var(--border);border-bottom:1px solid var(--border);}
.dealer-stat-val{font-family:'DM Mono',monospace;font-weight:700;font-size:18px;}
.dealer-stat-lbl{font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:0.06em;margin-top:2px;}

/* Export bar */
.export-bar{display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap;}
.export-btn{padding:10px 20px;border-radius:var(--rsm);font-family:'DM Sans',sans-serif;font-size:12px;font-weight:600;cursor:pointer;border:1.5px solid var(--border);background:var(--card);color:var(--text);transition:all 0.18s;}
.export-btn:hover{border-color:var(--purple);color:var(--purple);}

/* ‚ïê‚ïê USER PROFILE CARDS ‚ïê‚ïê */
.user-profile-card{
  background:var(--card);border:1px solid var(--border);border-radius:12px;
  padding:0;box-shadow:var(--sh);margin-bottom:16px;overflow:hidden;
  transition:box-shadow 0.2s,border-color 0.2s;
}
.user-profile-card:hover{box-shadow:0 4px 24px rgba(0,0,0,0.08);border-color:rgba(124,58,237,0.2);}
.user-profile-card.editing{border-color:var(--purple);box-shadow:0 4px 24px rgba(124,58,237,0.12);}

.upc-header{
  display:flex;align-items:center;justify-content:space-between;
  padding:20px 24px;cursor:pointer;
}
.upc-left{display:flex;align-items:center;gap:16px;flex:1;min-width:0;}
.upc-avatar{
  width:48px;height:48px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  font-size:16px;font-weight:700;color:#fff;letter-spacing:0.04em;
  flex-shrink:0;
}
.upc-avatar.role-admin{background:linear-gradient(135deg,var(--purple),var(--blue));}
.upc-avatar.role-manager{background:linear-gradient(135deg,var(--gold),#E5B83A);}
.upc-avatar.role-sales{background:linear-gradient(135deg,#059669,#10B981);}
.upc-avatar.role-finance{background:linear-gradient(135deg,var(--blue),#3B82F6);}

.upc-info{flex:1;min-width:0;}
.upc-name{font-weight:700;font-size:16px;display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
.upc-role-badge{
  font-size:9px;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;
  padding:3px 10px;border-radius:4px;
}
.upc-role-badge.admin{background:rgba(124,58,237,0.12);color:var(--purple);}
.upc-role-badge.manager{background:rgba(196,154,42,0.12);color:var(--gold);}
.upc-role-badge.sales{background:rgba(5,150,105,0.12);color:#059669;}
.upc-role-badge.finance{background:rgba(30,58,138,0.12);color:var(--blue);}
.upc-role-badge.s2s-manager{background:rgba(196,154,42,0.12);color:var(--gold);}

.upc-subtitle{font-size:12px;color:var(--muted);margin-top:3px;display:flex;align-items:center;gap:12px;flex-wrap:wrap;}
.upc-subtitle span{display:flex;align-items:center;gap:4px;}

.upc-actions{display:flex;align-items:center;gap:8px;flex-shrink:0;}
.upc-expand-btn{
  width:32px;height:32px;border-radius:8px;
  background:rgba(0,0,0,0.03);border:1px solid var(--border);
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;transition:all 0.18s;font-size:14px;color:var(--muted);
}
.upc-expand-btn:hover{background:var(--purple-light);color:var(--purple);border-color:var(--purple);}
.upc-expand-btn.open{transform:rotate(180deg);}

/* Expandable body */
.upc-body{
  max-height:0;overflow:hidden;transition:max-height 0.35s ease;
  border-top:0px solid transparent;
}
.upc-body.open{max-height:800px;border-top:1px solid var(--border);}

.upc-body-inner{padding:24px;}
.upc-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;}
.upc-field{display:flex;flex-direction:column;gap:4px;}
.upc-field-label{font-size:10px;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;color:var(--muted);}
.upc-field-value{font-size:13px;font-weight:500;color:var(--text);word-break:break-word;}
.upc-field-value.empty{color:var(--muted);font-style:italic;}

.upc-edit-input{
  width:100%;padding:8px 12px;border:1.5px solid var(--border);border-radius:var(--rsm);
  font-family:'DM Sans',sans-serif;font-size:13px;color:var(--text);
  background:#FAFAF8;transition:border-color 0.18s;
}
.upc-edit-input:focus{outline:none;border-color:var(--purple);box-shadow:0 0 0 3px rgba(124,58,237,0.1);}
.upc-edit-select{
  width:100%;padding:8px 12px;border:1.5px solid var(--border);border-radius:var(--rsm);
  font-family:'DM Sans',sans-serif;font-size:13px;color:var(--text);
  background:#FAFAF8;appearance:none;cursor:pointer;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath fill='%238C897F' d='M5 6L0 0h10z'/%3E%3C/svg%3E");
  background-repeat:no-repeat;background-position:right 12px center;padding-right:32px;
}
.upc-edit-select:focus{outline:none;border-color:var(--purple);box-shadow:0 0 0 3px rgba(124,58,237,0.1);}

.upc-footer{
  display:flex;align-items:center;justify-content:space-between;
  padding:16px 24px;background:rgba(0,0,0,0.02);border-top:1px solid var(--border);
  gap:12px;flex-wrap:wrap;
}
.upc-footer-left{display:flex;align-items:center;gap:8px;}
.upc-footer-right{display:flex;align-items:center;gap:8px;}

/* Access toggles */
.access-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:16px;}
.access-item{
  display:flex;align-items:center;justify-content:space-between;
  padding:10px 14px;border-radius:var(--rsm);
  background:rgba(0,0,0,0.02);border:1px solid var(--border);
}
.access-label{font-size:12px;font-weight:600;color:var(--text);}
.access-desc{font-size:10px;color:var(--muted);margin-top:1px;}

/* Toggle Switch */
.toggle{
  position:relative;width:40px;height:22px;cursor:pointer;flex-shrink:0;
}
.toggle input{display:none;}
.toggle-slider{
  position:absolute;inset:0;border-radius:11px;
  background:#D1D5DB;transition:background 0.2s;
}
.toggle-slider::after{
  content:'';position:absolute;left:2px;top:2px;
  width:18px;height:18px;border-radius:50%;
  background:#fff;box-shadow:0 1px 3px rgba(0,0,0,0.2);
  transition:transform 0.2s;
}
.toggle input:checked + .toggle-slider{background:var(--purple);}
.toggle input:checked + .toggle-slider::after{transform:translateX(18px);}
.toggle input:disabled + .toggle-slider{opacity:0.5;cursor:not-allowed;}

/* Responsive */
@media(max-width:900px){
  .grid-4{grid-template-columns:1fr 1fr;}
  .grid-2{grid-template-columns:1fr;}
  .upc-grid{grid-template-columns:1fr;}
  .access-grid{grid-template-columns:1fr;}
  .upc-header{padding:16px;}
  .upc-body-inner{padding:16px;}
  .upc-footer{padding:12px 16px;}
}
@media(max-width:600px){
  .admin-nav{padding:0 16px;}
  .nav-wrap{padding:0 16px;}
  .page{padding:16px 16px 80px;}
  .grid-4{grid-template-columns:1fr 1fr;}
  .upc-subtitle{flex-direction:column;gap:4px;align-items:flex-start;}
}

/* Toast */
.admin-toast{
  position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(80px);
  background:var(--ink);color:#fff;font-size:13px;font-weight:600;
  padding:12px 24px;border-radius:100px;box-shadow:var(--sh-lg);
  z-index:999;transition:transform 0.3s ease;white-space:nowrap;
}
.admin-toast.show{transform:translateX(-50%) translateY(0);}
</style>
</head>
<body>

<header class="admin-nav">
  <div class="nav-left">
    <div class="nav-brand">ServiceBridge</div>
    <div class="nav-sep"></div>
    <div class="nav-product">Admin Console</div>
  </div>
  <div class="nav-right">
    <div class="nav-user-pill">
      <div class="nav-avatar" id="nav-avatar">RL</div>
      <span class="nav-user-name" id="nav-name"></span>
      <span class="nav-role-pill">Admin</span>
    </div>
    <div class="hamburger" id="hamburger" onclick="toggleMenu(event)">
      <span></span><span></span><span></span>
    </div>
  </div>
</header>

<!-- ‚ïê‚ïê DROPDOWN ‚ïê‚ïê -->
<div class="nav-dropdown" id="nav-dropdown">
  <div class="dd-header">
    <div class="dd-header-name" id="dd-name"></div>
    <div class="dd-header-role">Admin ¬∑ ServiceBridge</div>
  </div>
  <a href="manager-dashboard.html" class="dd-item"><span class="dd-icon">üìä</span> Manager Dashboard</a>
  <a href="app.html" class="dd-item"><span class="dd-icon">üìã</span> S2S Entry</a>
  <a href="scorecards.html" class="dd-item"><span class="dd-icon">üèÜ</span> Scorecards</a>
  <div class="dd-divider"></div>
  <button class="dd-item danger" onclick="signOut()"><span class="dd-icon">üö™</span> Sign Out</button>
</div>

<!-- PAGE NAV TABS -->
<div class="nav-wrap">
  <div class="nav-tab active" onclick="showTab('overview',this)">üìä Overview</div>
  <div class="nav-tab" onclick="showTab('dealers',this)">üè¢ Dealers</div>
  <div class="nav-tab" onclick="showTab('reps',this)">üë§ Rep Management</div>
  <div class="nav-tab" onclick="showTab('emails',this)">üìß Email Settings</div>
  <div class="nav-tab" onclick="showTab('data',this)">üóÑ Data</div>
</div>

<div class="page">

  <div class="export-bar" style="margin-top:20px;">
    <button class="export-btn export-csv" onclick="adminExportS2SCSV()">‚¨á S2S Entries ‚Äî CSV</button>
    <button class="export-btn export-pdf" onclick="adminExportS2SPDF()">üñ® S2S Entries ‚Äî Print / PDF</button>
  </div>

  <!-- OVERVIEW -->
  <div class="tab-panel active" id="tab-overview">
    <div class="sh">
      <div><div class="sh-title">Platform Overview</div><div class="sh-desc">ServiceBridge across all dealers</div></div>
      <div style="font-size:11px;color:var(--muted);" id="overview-sync">‚Äî</div>
    </div>
    <div class="grid-4" style="margin-bottom:20px;">
      <div class="kpi-tile k-purple"><div class="kpi-label">Total Dealers</div><div class="kpi-val" id="kpi-dealers">1</div></div>
      <div class="kpi-tile k-green"><div class="kpi-label">Total Entries</div><div class="kpi-val" id="kpi-entries">‚Äî</div></div>
      <div class="kpi-tile k-blue"><div class="kpi-label">Vehicles Sold</div><div class="kpi-val" id="kpi-sold">‚Äî</div></div>
      <div class="kpi-tile k-red"><div class="kpi-label">Hot Leads</div><div class="kpi-val" id="kpi-hot">‚Äî</div></div>
    </div>
    <div class="grid-2">
      <div class="card">
        <div class="card-title">Recent Entries</div>
        <div id="recent-entries-list"><div class="loading"><span class="spinner"></span>Loading...</div></div>
      </div>
      <div class="card">
        <div class="card-title">Email Notification Log</div>
        <div id="email-log-list">
          <div class="email-log-row">
            <div class="email-dot dot-system"></div>
            <div class="email-log-info">
              <div class="email-log-subject">Email system initializing...</div>
              <div class="email-log-meta">Waiting for DNS verification on vyaxis.com</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- DEALERS -->
  <div class="tab-panel" id="tab-dealers">
    <div class="sh">
      <div><div class="sh-title">Dealer Management</div><div class="sh-desc">All ServiceBridge dealer accounts</div></div>
      <button class="btn-primary" onclick="openAddDealer()">+ Add Dealer</button>
    </div>
    <div id="dealers-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
      <div class="dealer-card">
        <div class="dealer-name">Gallatin CDJR</div>
        <div class="dealer-id">Dealer ID: gallatin-cdjr ¬∑ WeAuto Group</div>
        <div class="dealer-stats" id="gallatin-stats">
          <div class="dealer-stat"><div class="dealer-stat-val" id="gs-entries">‚Äî</div><div class="dealer-stat-lbl">Total Entries</div></div>
          <div class="dealer-stat"><div class="dealer-stat-val" id="gs-sold">‚Äî</div><div class="dealer-stat-lbl">Sold</div></div>
          <div class="dealer-stat"><div class="dealer-stat-val" id="gs-conv">‚Äî</div><div class="dealer-stat-lbl">Conv. Rate</div></div>
          <div class="dealer-stat"><div class="dealer-stat-val" id="gs-hot">‚Äî</div><div class="dealer-stat-lbl">Hot Leads</div></div>
        </div>
        <div style="margin-top:14px;display:flex;align-items:center;justify-content:space-between;">
          <span class="status-badge s-active">‚óè Active</span>
          <div style="display:flex;gap:8px;">
            <a href="manager-dashboard.html" target="_blank" class="btn-outline btn-sm">View Dashboard</a>
            <a href="service-to-sales-log.html" target="_blank" class="btn-dark btn-sm">View Form</a>
          </div>
        </div>
      </div>
      <div class="dealer-card" style="border:2px dashed var(--border);background:transparent;box-shadow:none;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:200px;cursor:pointer;" onclick="openAddDealer()">
        <div style="font-size:32px;margin-bottom:12px;">+</div>
        <div style="font-family:'DM Serif Display',serif;font-size:16px;color:var(--subtext);">Add New Dealer</div>
        <div style="font-size:12px;color:var(--muted);margin-top:6px;">Onboard next ServiceBridge client</div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <!-- REP MANAGEMENT ‚Äî UPGRADED WITH FULL PROFILE EDITING   -->
  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="tab-panel" id="tab-reps">
    <div class="sh">
      <div><div class="sh-title">Rep Management</div><div class="sh-desc">Gallatin CDJR S2S Team ‚Äî edit profiles, roles & access</div></div>
      <button class="btn-primary" onclick="openAddRep()">+ Add Rep</button>
    </div>
    <div id="alert-rep" class="alert"></div>
    <div id="reps-list">
      <div class="loading"><span class="spinner"></span>Loading team...</div>
    </div>
  </div>

  <!-- EMAIL SETTINGS -->
  <div class="tab-panel" id="tab-emails">
    <div class="sh"><div><div class="sh-title">Email Notifications</div><div class="sh-desc">Alert and reporting configuration</div></div></div>
    <div class="grid-2">
      <div class="card">
        <div class="card-title">üî• Hot Lead Alerts</div>
        <p style="font-size:13px;color:var(--subtext);margin-bottom:18px;">Instant email when a buying temperature of 8, 9, or 10 is submitted.</p>
        <div class="form-group"><label class="form-label">Recipients</label><div id="recipients-list"></div></div>
        <div style="display:flex;gap:8px;">
          <input class="form-input" id="new-recipient" placeholder="email@example.com" style="flex:1;">
          <button class="btn-outline" onclick="addRecipient()">Add</button>
        </div>
        <div style="margin-top:16px;"><button class="btn-primary" onclick="saveHotAlertSettings()">Save Settings</button></div>
      </div>
      <div class="card">
        <div class="card-title">üìä Daily Summary</div>
        <p style="font-size:13px;color:var(--subtext);margin-bottom:18px;">End-of-day recap emailed automatically at 6:00 PM CT.</p>
        <div class="form-group"><label class="form-label">Send Time</label>
          <select class="form-input" id="summary-time"><option>5:00 PM</option><option selected>6:00 PM</option><option>7:00 PM</option><option>8:00 PM</option></select>
        </div>
        <div class="form-group"><label class="form-label">Include</label>
          <div style="display:flex;flex-direction:column;gap:8px;">
            <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer;"><input type="checkbox" checked> Entry count by rep</label>
            <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer;"><input type="checkbox" checked> Hot lead highlights</label>
            <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer;"><input type="checkbox" checked> Vehicles sold</label>
          </div>
        </div>
        <div style="margin-top:16px;"><button class="btn-primary" onclick="saveDailySettings()">Save Settings</button></div>
      </div>
    </div>
    <div class="card" style="margin-top:16px;">
      <div class="card-title">üß™ Test Email</div>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
        <input class="form-input" id="test-email-to" style="flex:1;min-width:200px;" value="Rob.l@gallatincdjr.com">
        <button class="btn-outline" onclick="sendTestEmail()">Send Test Email</button>
        <button class="btn-dark" onclick="sendTestDailySummary()">Send Test Summary</button>
      </div>
      <div id="test-result" class="alert" style="margin-top:14px;"></div>
    </div>
  </div>

  <!-- DATA -->
  <div class="tab-panel" id="tab-data">
    <div class="sh">
      <div><div class="sh-title">Data Management</div><div class="sh-desc">View and manage all S2S entries</div></div>
      <div style="display:flex;gap:10px;">
        <button class="btn-dark" onclick="exportAllCSV()">‚¨á Export All CSV</button>
        <button class="btn-red" onclick="confirmDeleteAll()">‚úï Delete All</button>
      </div>
    </div>
    <div class="card">
      <div class="tbl-wrap">
        <table>
          <thead><tr>
            <th>ID</th><th>Date</th><th>Submitter</th><th>Customer</th><th>Outcome</th><th>Temp</th><th>Vehicle</th><th>Actions</th>
          </tr></thead>
          <tbody id="data-tbody"><tr><td colspan="8"><div class="loading"><span class="spinner"></span>Loading...</div></td></tr></tbody>
        </table>
      </div>
    </div>
  </div>

</div>

<!-- ADD DEALER MODAL -->
<div class="modal-overlay" id="dealer-modal">
  <div class="modal">
    <div class="modal-title">Add New Dealer</div>
    <div class="modal-desc">Onboard a new ServiceBridge client. They'll get their own isolated data and branded dashboard.</div>
    <div class="form-group"><label class="form-label">Dealership Name</label><input class="form-input" id="new-dealer-name" placeholder="e.g. Nashville CDJR"></div>
    <div class="form-group"><label class="form-label">Dealer Group</label><input class="form-input" id="new-dealer-group" placeholder="e.g. WeAuto Group"></div>
    <div class="form-group"><label class="form-label">Primary Contact Email</label><input class="form-input" type="email" id="new-dealer-email" placeholder="manager@dealership.com"></div>
    <div class="form-group"><label class="form-label">City, State</label><input class="form-input" id="new-dealer-location" placeholder="Nashville, TN"></div>
    <div class="modal-actions">
      <button class="btn-outline" onclick="closeModal('dealer-modal')">Cancel</button>
      <button class="btn-primary" onclick="addDealer()">Create Dealer Account</button>
    </div>
  </div>
</div>

<!-- ADD REP MODAL -->
<div class="modal-overlay" id="rep-modal">
  <div class="modal">
    <div class="modal-title">Add New Team Member</div>
    <div class="modal-desc">Add a new person to the Gallatin CDJR ServiceBridge team.</div>
    <div class="form-group"><label class="form-label">Full Name</label><input class="form-input" id="new-rep-name" placeholder="e.g. John Smith"></div>
    <div class="form-group"><label class="form-label">Role / Title</label>
      <select class="form-input" id="new-rep-role">
        <option value="Sales">Sales Rep</option>
        <option value="S2S Manager">S2S Manager</option>
        <option value="Finance Manager">Finance Manager</option>
        <option value="Admin">Admin</option>
      </select>
    </div>
    <div class="form-group"><label class="form-label">Email</label><input class="form-input" type="email" id="new-rep-email" placeholder="name@gallatincdjr.com"></div>
    <div class="form-group"><label class="form-label">Phone</label><input class="form-input" type="tel" id="new-rep-phone" placeholder="(615) 555-0000"></div>
    <div class="modal-actions">
      <button class="btn-outline" onclick="closeModal('rep-modal')">Cancel</button>
      <button class="btn-primary" onclick="addRep()">Add Team Member</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="admin-toast" id="admin-toast"></div>

<script>
const SB_URL  = 'https://jbkgwtohwsbaorhvuuqb.supabase.co';
const SB_KEY  = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impia2d3dG9od3NiYW9yaHZ1dXFiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5NjkwNDIsImV4cCI6MjA4NzU0NTA0Mn0.GRXOYbIuVDxU9-FEBYmyd1QmytVUrMIAxbnOSfepzuU';
const HEADERS = {'apikey':SB_KEY,'Authorization':'Bearer '+SB_KEY,'Content-Type':'application/json'};

let RECIPIENTS = ['Rob.l@gallatincdjr.com','Tyler.d@gallatincdjr.com','Joe.s@gallatincdjr.com','Jbarba@weauto.us','dominick.f@gallatincdjr.com','Mich.s@gallatincdjr.com'];

// ‚îÄ‚îÄ REPS data with full profiles ‚îÄ‚îÄ
let REPS = [
  {name:'Robert Lisowski', role:'Admin',        email:'Rob.l@gallatincdjr.com',      phone:'',    title:'General Sales Manager', active:true, access:{dashboard:true,s2s:true,scorecards:true,admin:true,upboard:true}},
  {name:'Tyler Doyle',     role:'S2S Manager',  email:'Tyler.d@gallatincdjr.com',    phone:'',    title:'S2S Manager',           active:true, access:{dashboard:true,s2s:true,scorecards:true,admin:false,upboard:true}},
  {name:'Andrew Kirk',     role:'Sales',        email:'',                            phone:'',    title:'Sales Consultant',      active:true, access:{dashboard:false,s2s:true,scorecards:true,admin:false,upboard:true}},
  {name:'DJ Rogers',       role:'Sales',        email:'',                            phone:'',    title:'Sales Consultant',      active:true, access:{dashboard:false,s2s:true,scorecards:true,admin:false,upboard:true}},
  {name:'Kody McCann',     role:'Sales',        email:'',                            phone:'',    title:'Sales Consultant',      active:true, access:{dashboard:false,s2s:true,scorecards:true,admin:false,upboard:true}},
  {name:'Joe Smith',       role:'Sales',        email:'Joe.s@gallatincdjr.com',      phone:'',    title:'Sales Consultant',      active:true, access:{dashboard:false,s2s:true,scorecards:true,admin:false,upboard:true}},
  {name:'Dominick Ferrara',role:'Sales',        email:'dominick.f@gallatincdjr.com', phone:'',    title:'Sales Consultant',      active:true, access:{dashboard:false,s2s:true,scorecards:true,admin:false,upboard:true}},
  {name:'Mich Shelton',    role:'Sales',        email:'Mich.s@gallatincdjr.com',     phone:'',    title:'Sales Consultant',      active:true, access:{dashboard:false,s2s:true,scorecards:true,admin:false,upboard:true}},
];

// Load persisted reps from localStorage if available
(function loadPersistedReps(){
  try {
    const saved = localStorage.getItem('sb_admin_reps');
    if (saved) REPS = JSON.parse(saved);
  } catch(e){}
})();

function persistReps(){ localStorage.setItem('sb_admin_reps', JSON.stringify(REPS)); }

let ALL_ENTRIES = [];
let emailLog = [];
let expandedCards = {};
let editingCards = {};

// ‚îÄ‚îÄ Session & Nav ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const currentRep = JSON.parse(sessionStorage.getItem('sb_rep') || 'null');
(function initNav(){
  if (!currentRep) return;
  document.getElementById('nav-avatar').textContent = currentRep.initials || currentRep.name.slice(0,2).toUpperCase();
  document.getElementById('nav-name').textContent = currentRep.name.split(' ')[0];
  document.getElementById('dd-name').textContent = currentRep.name;
})();

// ‚îÄ‚îÄ Hamburger ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleMenu(e){
  e.stopPropagation();
  document.getElementById('hamburger').classList.toggle('open');
  document.getElementById('nav-dropdown').classList.toggle('open');
}
document.addEventListener('click', () => {
  document.getElementById('hamburger').classList.remove('open');
  document.getElementById('nav-dropdown').classList.remove('open');
});
document.getElementById('nav-dropdown').addEventListener('click', e => e.stopPropagation());

function signOut(){
  sessionStorage.removeItem('sb_rep');
  window.location.replace('/login.html');
}

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(async function init(){
  await loadEntries();
  renderOverview();
  renderGallatinStats();
  renderReps();
  renderRecipients();
  renderDataTable();
  document.getElementById('overview-sync').textContent = 'Last sync: ' + new Date().toLocaleTimeString();
})();

// ‚îÄ‚îÄ Tab Switching ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showTab(id, el){
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  document.getElementById('tab-'+id).classList.add('active');
  el.classList.add('active');
}

// ‚îÄ‚îÄ Toast ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showToast(msg){
  const t = document.getElementById('admin-toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(()=> t.classList.remove('show'), 3000);
}

function showAlert(id, msg, success){
  const el = document.getElementById('alert-'+id);
  if (!el) return;
  el.textContent = msg;
  el.className = 'alert show ' + (success ? 'success' : 'error');
  setTimeout(()=> el.classList.remove('show'), 4000);
}

// ‚îÄ‚îÄ Supabase Data ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadEntries(){
  try {
    const res = await fetch(SB_URL+'/rest/v1/s2s_entries?select=*&order=id.desc', {headers:HEADERS});
    ALL_ENTRIES = await res.json();
  } catch(e){ console.warn('Load entries failed:', e); ALL_ENTRIES = []; }
}

// ‚îÄ‚îÄ Overview ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderOverview(){
  const n = ALL_ENTRIES.length;
  const sold = ALL_ENTRIES.filter(e => e.outcome && (e.outcome.includes('Sold') || e.outcome.includes('New') || e.outcome.includes('Used'))).length;
  const hot = ALL_ENTRIES.filter(e => parseInt(e.eng_score) >= 8).length;
  document.getElementById('kpi-entries').textContent = n;
  document.getElementById('kpi-sold').textContent = sold;
  document.getElementById('kpi-hot').textContent = hot;

  const recent = ALL_ENTRIES.slice(0,8);
  document.getElementById('recent-entries-list').innerHTML = recent.length === 0
    ? '<p style="color:var(--muted);font-size:13px;">No entries yet.</p>'
    : recent.map(e => {
        const d = new Date(e.created_at);
        const ts = d.toLocaleDateString('en-US',{month:'short',day:'numeric'}) + ' ' + d.toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'});
        return `<div style="display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border);">
          <div><div style="font-weight:600;font-size:13px;">${e.customer_first||''} ${e.customer_last||''}</div><div style="font-size:11px;color:var(--muted);">${e.submitter||'‚Äî'} ¬∑ ${ts}</div></div>
          <div style="font-family:'DM Mono',monospace;font-size:13px;font-weight:700;color:${parseInt(e.eng_score)>=8?'var(--red)':parseInt(e.eng_score)>=5?'var(--gold)':'var(--muted)'};">${e.eng_score||'‚Äî'}/10</div>
        </div>`;
      }).join('');
}

function renderGallatinStats(){
  const n = ALL_ENTRIES.length;
  const sold = ALL_ENTRIES.filter(e => e.outcome && (e.outcome.includes('Sold') || e.outcome.includes('New') || e.outcome.includes('Used'))).length;
  const hot = ALL_ENTRIES.filter(e => parseInt(e.eng_score) >= 8).length;
  document.getElementById('gs-entries').textContent = n;
  document.getElementById('gs-sold').textContent = sold;
  document.getElementById('gs-conv').textContent = n > 0 ? Math.round((sold/n)*100)+'%' : '0%';
  document.getElementById('gs-hot').textContent = hot;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  REP MANAGEMENT ‚Äî FULL PROFILE CARDS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getInitials(name){
  const parts = name.trim().split(/\s+/);
  if (parts.length >= 2) return (parts[0][0] + parts[parts.length-1][0]).toUpperCase();
  return name.slice(0,2).toUpperCase();
}

function getRoleClass(role){
  const r = (role||'').toLowerCase();
  if (r === 'admin') return 'admin';
  if (r.includes('manager') || r === 's2s manager') return 'manager';
  if (r.includes('finance')) return 'finance';
  return 'sales';
}

function getEntryCount(name){
  return ALL_ENTRIES.filter(e => e.submitter === name).length;
}

function getLastLogin(name){
  try {
    const logs = JSON.parse(localStorage.getItem('sb_login_log') || '[]');
    const match = logs.find(l => l.name === name);
    if (match) {
      const d = new Date(match.time);
      return d.toLocaleDateString('en-US',{month:'short',day:'numeric'}) + ', ' + d.toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'});
    }
  } catch(e){}
  return 'Never';
}

function renderReps(){
  const container = document.getElementById('reps-list');
  container.innerHTML = REPS.map((rep, idx) => {
    const initials = getInitials(rep.name);
    const roleClass = getRoleClass(rep.role);
    const entries = getEntryCount(rep.name);
    const lastLogin = getLastLogin(rep.name);
    const isExpanded = expandedCards[idx];
    const isEditing = editingCards[idx];

    return `
    <div class="user-profile-card ${isEditing ? 'editing' : ''}" id="upc-${idx}">
      <div class="upc-header" onclick="toggleExpand(${idx})">
        <div class="upc-left">
          <div class="upc-avatar role-${roleClass}">${initials}</div>
          <div class="upc-info">
            <div class="upc-name">
              ${rep.name}
              <span class="upc-role-badge ${roleClass}">${rep.role}</span>
              ${!rep.active ? '<span class="status-badge s-inactive">Inactive</span>' : ''}
            </div>
            <div class="upc-subtitle">
              <span>üìä ${entries} entries</span>
              <span>üïê Last login: ${lastLogin}</span>
              ${rep.email ? `<span>‚úâ ${rep.email}</span>` : ''}
            </div>
          </div>
        </div>
        <div class="upc-actions">
          <div class="upc-expand-btn ${isExpanded ? 'open' : ''}" title="Expand">‚ñæ</div>
        </div>
      </div>

      <div class="upc-body ${isExpanded ? 'open' : ''}" id="upc-body-${idx}">
        <div class="upc-body-inner">
          ${isEditing ? renderEditMode(rep, idx) : renderViewMode(rep, idx)}
        </div>
        <div class="upc-footer">
          <div class="upc-footer-left">
            ${isEditing
              ? `<button class="btn-primary btn-sm" onclick="saveProfile(${idx})">‚úì Save Changes</button>
                 <button class="btn-outline btn-sm" onclick="cancelEdit(${idx})">Cancel</button>`
              : `<button class="btn-outline btn-sm" onclick="startEdit(${idx})">‚úèÔ∏è Edit Profile</button>`
            }
          </div>
          <div class="upc-footer-right">
            ${rep.name !== 'Robert Lisowski'
              ? `<button class="btn-red btn-sm" onclick="removeRep(${idx})">Remove</button>`
              : `<span style="font-size:11px;color:var(--muted);">Primary admin ‚Äî cannot remove</span>`
            }
          </div>
        </div>
      </div>
    </div>`;
  }).join('');
}

function renderViewMode(rep, idx){
  const ac = rep.access || {};
  return `
    <div class="upc-grid">
      <div class="upc-field">
        <div class="upc-field-label">Full Name</div>
        <div class="upc-field-value">${rep.name}</div>
      </div>
      <div class="upc-field">
        <div class="upc-field-label">Job Title</div>
        <div class="upc-field-value ${rep.title ? '' : 'empty'}">${rep.title || 'Not set'}</div>
      </div>
      <div class="upc-field">
        <div class="upc-field-label">Role / Access Level</div>
        <div class="upc-field-value">${rep.role}</div>
      </div>
      <div class="upc-field">
        <div class="upc-field-label">Status</div>
        <div class="upc-field-value">${rep.active !== false ? '<span class="status-badge s-active">‚óè Active</span>' : '<span class="status-badge s-inactive">‚óè Inactive</span>'}</div>
      </div>
      <div class="upc-field">
        <div class="upc-field-label">Email</div>
        <div class="upc-field-value ${rep.email ? '' : 'empty'}">${rep.email || 'Not set'}</div>
      </div>
      <div class="upc-field">
        <div class="upc-field-label">Phone</div>
        <div class="upc-field-value ${rep.phone ? '' : 'empty'}">${rep.phone || 'Not set'}</div>
      </div>
    </div>
    <div style="margin-top:20px;">
      <div class="upc-field-label" style="margin-bottom:10px;">Page Access</div>
      <div class="access-grid">
        <div class="access-item">
          <div><div class="access-label">S2S Entry Form</div></div>
          <span style="font-size:12px;font-weight:600;color:${ac.s2s !== false ? 'var(--green)' : 'var(--red)'};">${ac.s2s !== false ? '‚úì Granted' : '‚úï Denied'}</span>
        </div>
        <div class="access-item">
          <div><div class="access-label">Manager Dashboard</div></div>
          <span style="font-size:12px;font-weight:600;color:${ac.dashboard ? 'var(--green)' : 'var(--red)'};">${ac.dashboard ? '‚úì Granted' : '‚úï Denied'}</span>
        </div>
        <div class="access-item">
          <div><div class="access-label">Scorecards</div></div>
          <span style="font-size:12px;font-weight:600;color:${ac.scorecards !== false ? 'var(--green)' : 'var(--red)'};">${ac.scorecards !== false ? '‚úì Granted' : '‚úï Denied'}</span>
        </div>
        <div class="access-item">
          <div><div class="access-label">Admin Console</div></div>
          <span style="font-size:12px;font-weight:600;color:${ac.admin ? 'var(--green)' : 'var(--red)'};">${ac.admin ? '‚úì Granted' : '‚úï Denied'}</span>
        </div>
        <div class="access-item">
          <div><div class="access-label">UP Board</div></div>
          <span style="font-size:12px;font-weight:600;color:${ac.upboard !== false ? 'var(--green)' : 'var(--red)'};">${ac.upboard !== false ? '‚úì Granted' : '‚úï Denied'}</span>
        </div>
      </div>
    </div>`;
}

function renderEditMode(rep, idx){
  const ac = rep.access || {};
  const isProtected = rep.name === 'Robert Lisowski';
  return `
    <div class="upc-grid">
      <div class="upc-field">
        <div class="upc-field-label">Full Name</div>
        <input class="upc-edit-input" id="edit-name-${idx}" value="${escHtml(rep.name)}" placeholder="Full name">
      </div>
      <div class="upc-field">
        <div class="upc-field-label">Job Title</div>
        <input class="upc-edit-input" id="edit-title-${idx}" value="${escHtml(rep.title||'')}" placeholder="e.g. Sales Consultant">
      </div>
      <div class="upc-field">
        <div class="upc-field-label">Role / Access Level</div>
        <select class="upc-edit-select" id="edit-role-${idx}" ${isProtected ? 'disabled' : ''}>
          <option value="Sales" ${rep.role==='Sales'?'selected':''}>Sales Rep</option>
          <option value="S2S Manager" ${rep.role==='S2S Manager'?'selected':''}>S2S Manager</option>
          <option value="Finance Manager" ${rep.role==='Finance Manager'?'selected':''}>Finance Manager</option>
          <option value="Admin" ${rep.role==='Admin'?'selected':''}>Admin</option>
        </select>
      </div>
      <div class="upc-field">
        <div class="upc-field-label">Status</div>
        <select class="upc-edit-select" id="edit-active-${idx}" ${isProtected ? 'disabled' : ''}>
          <option value="true" ${rep.active !== false ? 'selected' : ''}>Active</option>
          <option value="false" ${rep.active === false ? 'selected' : ''}>Inactive</option>
        </select>
      </div>
      <div class="upc-field">
        <div class="upc-field-label">Email</div>
        <input class="upc-edit-input" id="edit-email-${idx}" type="email" value="${escHtml(rep.email||'')}" placeholder="name@gallatincdjr.com">
      </div>
      <div class="upc-field">
        <div class="upc-field-label">Phone</div>
        <input class="upc-edit-input" id="edit-phone-${idx}" type="tel" value="${escHtml(rep.phone||'')}" placeholder="(615) 555-0000">
      </div>
    </div>
    <div style="margin-top:20px;">
      <div class="upc-field-label" style="margin-bottom:10px;">Page Access Privileges</div>
      <div class="access-grid">
        <div class="access-item">
          <div><div class="access-label">S2S Entry Form</div><div class="access-desc">Log service-to-sales contacts</div></div>
          <label class="toggle"><input type="checkbox" id="edit-ac-s2s-${idx}" ${ac.s2s !== false ? 'checked' : ''}><span class="toggle-slider"></span></label>
        </div>
        <div class="access-item">
          <div><div class="access-label">Manager Dashboard</div><div class="access-desc">View all entries & analytics</div></div>
          <label class="toggle"><input type="checkbox" id="edit-ac-dashboard-${idx}" ${ac.dashboard ? 'checked' : ''}><span class="toggle-slider"></span></label>
        </div>
        <div class="access-item">
          <div><div class="access-label">Scorecards</div><div class="access-desc">Performance leaderboard</div></div>
          <label class="toggle"><input type="checkbox" id="edit-ac-scorecards-${idx}" ${ac.scorecards !== false ? 'checked' : ''}><span class="toggle-slider"></span></label>
        </div>
        <div class="access-item">
          <div><div class="access-label">Admin Console</div><div class="access-desc">Full system administration</div></div>
          <label class="toggle"><input type="checkbox" id="edit-ac-admin-${idx}" ${ac.admin ? 'checked' : ''} ${isProtected ? 'disabled' : ''}><span class="toggle-slider"></span></label>
        </div>
        <div class="access-item">
          <div><div class="access-label">UP Board</div><div class="access-desc">Floor rotation tracker</div></div>
          <label class="toggle"><input type="checkbox" id="edit-ac-upboard-${idx}" ${ac.upboard !== false ? 'checked' : ''}><span class="toggle-slider"></span></label>
        </div>
      </div>
    </div>`;
}

function escHtml(s){
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

function toggleExpand(idx){
  expandedCards[idx] = !expandedCards[idx];
  if (!expandedCards[idx]) editingCards[idx] = false;
  renderReps();
}

function startEdit(idx){
  editingCards[idx] = true;
  expandedCards[idx] = true;
  renderReps();
  // Focus the name field
  setTimeout(() => {
    const nameInput = document.getElementById('edit-name-'+idx);
    if (nameInput) nameInput.focus();
  }, 50);
}

function cancelEdit(idx){
  editingCards[idx] = false;
  renderReps();
}

function saveProfile(idx){
  const rep = REPS[idx];
  const newName = (document.getElementById('edit-name-'+idx).value || '').trim();
  if (!newName) { showToast('Name is required'); return; }

  const oldName = rep.name;
  rep.name   = newName;
  rep.title  = (document.getElementById('edit-title-'+idx).value || '').trim();
  rep.role   = document.getElementById('edit-role-'+idx).value;
  rep.active = document.getElementById('edit-active-'+idx).value === 'true';
  rep.email  = (document.getElementById('edit-email-'+idx).value || '').trim();
  rep.phone  = formatPhone(document.getElementById('edit-phone-'+idx).value || '');

  rep.access = {
    s2s:        document.getElementById('edit-ac-s2s-'+idx).checked,
    dashboard:  document.getElementById('edit-ac-dashboard-'+idx).checked,
    scorecards: document.getElementById('edit-ac-scorecards-'+idx).checked,
    admin:      document.getElementById('edit-ac-admin-'+idx).checked,
    upboard:    document.getElementById('edit-ac-upboard-'+idx).checked,
  };

  editingCards[idx] = false;
  persistReps();
  renderReps();

  // If name changed, update entries in Supabase
  if (oldName !== newName && oldName) {
    updateSubmitterName(oldName, newName);
  }

  showToast(`${newName} profile updated`);
}

function formatPhone(raw){
  const digits = raw.replace(/\D/g, '');
  if (digits.length === 10) return `(${digits.slice(0,3)}) ${digits.slice(3,6)}-${digits.slice(6)}`;
  if (digits.length === 11 && digits[0] === '1') return `(${digits.slice(1,4)}) ${digits.slice(4,7)}-${digits.slice(7)}`;
  return raw.trim();
}

async function updateSubmitterName(oldName, newName){
  try {
    await fetch(SB_URL+'/rest/v1/s2s_entries?submitter=eq.'+encodeURIComponent(oldName), {
      method: 'PATCH',
      headers: {...HEADERS, 'Prefer': 'return=minimal'},
      body: JSON.stringify({submitter: newName})
    });
  } catch(e){ console.warn('Name update in entries failed:', e); }
}

function removeRep(idx){
  const rep = REPS[idx];
  if (rep.name === 'Robert Lisowski') { showToast('Cannot remove primary admin'); return; }
  if (!confirm(`Remove ${rep.name} from the team?\n\nThis will not delete their existing S2S entries.`)) return;
  REPS.splice(idx, 1);
  delete expandedCards[idx];
  delete editingCards[idx];
  // Reindex
  const newExpanded = {}, newEditing = {};
  Object.keys(expandedCards).forEach(k => { const ki = parseInt(k); if (ki > idx) newExpanded[ki-1] = expandedCards[k]; else newExpanded[ki] = expandedCards[k]; });
  Object.keys(editingCards).forEach(k => { const ki = parseInt(k); if (ki > idx) newEditing[ki-1] = editingCards[k]; else newEditing[ki] = editingCards[k]; });
  expandedCards = newExpanded;
  editingCards = newEditing;
  persistReps();
  renderReps();
  showToast(`${rep.name} removed`);
}

// ‚îÄ‚îÄ Add Rep ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openAddRep(){ document.getElementById('rep-modal').classList.add('open'); }

function addRep(){
  const name  = document.getElementById('new-rep-name').value.trim();
  const role  = document.getElementById('new-rep-role').value;
  const email = document.getElementById('new-rep-email').value.trim();
  const phone = formatPhone(document.getElementById('new-rep-phone').value || '');

  if (!name) { alert('Please enter a name.'); return; }

  const isAdmin   = role === 'Admin';
  const isManager = role.includes('Manager');

  REPS.push({
    name,
    role,
    email,
    phone,
    title: role === 'Sales' ? 'Sales Consultant' : role,
    active: true,
    access: {
      s2s: true,
      dashboard: isAdmin || isManager,
      scorecards: true,
      admin: isAdmin,
      upboard: true,
    }
  });

  persistReps();
  renderReps();
  closeModal('rep-modal');

  // Clear form
  document.getElementById('new-rep-name').value = '';
  document.getElementById('new-rep-email').value = '';
  document.getElementById('new-rep-phone').value = '';
  document.getElementById('new-rep-role').selectedIndex = 0;

  showToast(`${name} added to team`);
  showAlert('rep', `${name} added successfully. They will appear in the S2S form submitter dropdown after the form page is updated.`, true);
}

// ‚îÄ‚îÄ Email / Recipients ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderRecipients(){
  document.getElementById('recipients-list').innerHTML = RECIPIENTS.map((r,i)=>`
    <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border);">
      <span style="font-size:13px;">${r}</span>
      <button class="btn-red btn-sm" onclick="removeRecipient(${i})">Remove</button>
    </div>`).join('');
}
function addRecipient(){
  const v = document.getElementById('new-recipient').value.trim();
  if (!v||!v.includes('@')){ alert('Enter a valid email.'); return; }
  RECIPIENTS.push(v); renderRecipients();
  document.getElementById('new-recipient').value = '';
}
function removeRecipient(i){ RECIPIENTS.splice(i,1); renderRecipients(); }
function saveHotAlertSettings(){ showToast('Hot lead alert settings saved'); }
function saveDailySettings(){ showToast('Daily summary settings saved'); }

// ‚îÄ‚îÄ Email Sending ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function sendEmail(to, subject, html){
  try{
    const res = await fetch('/api/send-email',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({to:Array.isArray(to)?to:[to],subject,html})});
    const data = await res.json();
    addEmailLog(subject, data.success?'sent':'failed');
    return data.success;
  }catch(e){ addEmailLog(subject,'failed'); return false; }
}
function addEmailLog(subject, status){
  emailLog.unshift({subject,status,time:new Date().toISOString()});
  renderEmailLog();
}
function renderEmailLog(){
  if (!emailLog.length) return;
  document.getElementById('email-log-list').innerHTML = emailLog.slice(0,10).map(l=>{
    const d = new Date(l.time);
    const ts = d.toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'});
    const dot = l.subject.includes('Hot') ? 'dot-hot' : l.subject.includes('Summary') ? 'dot-daily' : 'dot-system';
    return `<div class="email-log-row"><div class="email-dot ${dot}"></div><div class="email-log-info"><div class="email-log-subject">${l.subject}</div><div class="email-log-meta">${l.status} ¬∑ ${ts}</div></div></div>`;
  }).join('');
}

function sendTestEmail(){
  const to = document.getElementById('test-email-to').value.trim();
  if (!to) return;
  const el = document.getElementById('test-result');
  el.className = 'alert show info'; el.textContent = 'Sending test email...';
  sendEmail(to, 'üß™ ServiceBridge Test Email', '<h2>Test Email</h2><p>If you received this, email notifications are working.</p>')
    .then(ok => { el.className = 'alert show '+(ok?'success':'error'); el.textContent = ok?'Test email sent!':'Failed ‚Äî check server logs.'; });
}
function sendTestDailySummary(){
  const to = document.getElementById('test-email-to').value.trim();
  if (!to) return;
  const el = document.getElementById('test-result');
  el.className = 'alert show info'; el.textContent = 'Sending test summary...';
  const n = ALL_ENTRIES.length;
  const sold = ALL_ENTRIES.filter(e=>e.outcome&&e.outcome.includes('Sold')).length;
  const html = `<h2>üìä Daily S2S Summary</h2><p>Total entries: ${n}</p><p>Vehicles sold: ${sold}</p><p>This is a test summary.</p>`;
  sendEmail(to, 'üìä ServiceBridge Daily Summary (Test)', html)
    .then(ok => { el.className = 'alert show '+(ok?'success':'error'); el.textContent = ok?'Summary sent!':'Failed ‚Äî check server logs.'; });
}

// ‚îÄ‚îÄ Data Table ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderDataTable(){
  const tbody = document.getElementById('data-tbody');
  if (!ALL_ENTRIES.length){ tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:var(--muted);padding:40px;">No entries found.</td></tr>'; return; }
  tbody.innerHTML = ALL_ENTRIES.map(e => {
    const d = new Date(e.created_at);
    const ts = d.toLocaleDateString('en-US',{month:'short',day:'numeric'});
    return `<tr>
      <td style="font-family:'DM Mono',monospace;font-size:11px;">${e.id}</td>
      <td>${ts}</td>
      <td>${e.submitter||'‚Äî'}</td>
      <td>${(e.customer_first||'')+' '+(e.customer_last||'')}</td>
      <td>${e.outcome||'‚Äî'}</td>
      <td style="font-family:'DM Mono',monospace;font-weight:700;color:${parseInt(e.eng_score)>=8?'var(--red)':parseInt(e.eng_score)>=5?'var(--gold)':'var(--muted)'};">${e.eng_score||'‚Äî'}</td>
      <td>${(e.vehicle_year||'')+' '+(e.vehicle_make||'')+' '+(e.vehicle_model||'')}</td>
      <td><button class="btn-red btn-sm" onclick="deleteEntry(${e.id})">Delete</button></td>
    </tr>`;
  }).join('');
}

async function deleteEntry(id){
  if (!confirm('Delete this entry permanently?')) return;
  try{
    await fetch(SB_URL+'/rest/v1/s2s_entries?id=eq.'+id, {method:'DELETE',headers:HEADERS});
    ALL_ENTRIES = ALL_ENTRIES.filter(e=>e.id!==id);
    renderDataTable(); renderOverview(); renderGallatinStats();
    showToast('Entry deleted');
  }catch(e){ showToast('Delete failed'); }
}

async function confirmDeleteAll(){
  if (!confirm('‚ö†Ô∏è DELETE ALL ENTRIES?\n\nThis cannot be undone. Type "DELETE" to confirm.')) return;
  const answer = prompt('Type DELETE to confirm:');
  if (answer !== 'DELETE') return;
  try{
    await fetch(SB_URL+'/rest/v1/s2s_entries?id=gt.0', {method:'DELETE',headers:HEADERS});
    ALL_ENTRIES = [];
    renderDataTable(); renderOverview(); renderGallatinStats();
    showToast('All entries deleted');
  }catch(e){ showToast('Delete failed'); }
}

// ‚îÄ‚îÄ Export ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function adminExportS2SCSV(){ exportCSV(ALL_ENTRIES, 'servicebridge-s2s-all.csv'); }
function adminExportS2SPDF(){
  const w = window.open('','_blank');
  w.document.write('<html><head><title>S2S Entries</title><style>body{font-family:sans-serif;font-size:11px;}table{width:100%;border-collapse:collapse;}th,td{padding:6px 8px;border:1px solid #ddd;text-align:left;}th{background:#f5f5f5;font-size:10px;}</style></head><body>');
  w.document.write('<h2>ServiceBridge S2S Entries</h2><p>Exported: '+new Date().toLocaleString()+'</p>');
  w.document.write('<table><thead><tr><th>ID</th><th>Date</th><th>Submitter</th><th>Customer</th><th>Vehicle</th><th>Score</th><th>Outcome</th></tr></thead><tbody>');
  ALL_ENTRIES.forEach(e=>{
    w.document.write(`<tr><td>${e.id}</td><td>${new Date(e.created_at).toLocaleDateString()}</td><td>${e.submitter||''}</td><td>${(e.customer_first||'')+' '+(e.customer_last||'')}</td><td>${(e.vehicle_year||'')+' '+(e.vehicle_make||'')+' '+(e.vehicle_model||'')}</td><td>${e.eng_score||''}</td><td>${e.outcome||''}</td></tr>`);
  });
  w.document.write('</tbody></table></body></html>');
  w.document.close();
  w.print();
}
function exportAllCSV(){ exportCSV(ALL_ENTRIES, 'servicebridge-all-data.csv'); }
function exportCSV(data, filename){
  if (!data.length) return;
  const keys = Object.keys(data[0]);
  const csv = [keys.join(','), ...data.map(r => keys.map(k => `"${(r[k]||'').toString().replace(/"/g,'""')}"`).join(','))].join('\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
}

// ‚îÄ‚îÄ Modal helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function closeModal(id){ document.getElementById(id).classList.remove('open'); }
function openAddDealer(){ document.getElementById('dealer-modal').classList.add('open'); }
function addDealer(){ showToast('Multi-dealer support coming soon'); closeModal('dealer-modal'); }

// Close modals on overlay click
document.querySelectorAll('.modal-overlay').forEach(m => {
  m.addEventListener('click', e => { if (e.target === m) m.classList.remove('open'); });
});
</script>
</body>
</html>
