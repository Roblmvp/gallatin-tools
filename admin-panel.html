<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ServiceBridge Admin â€” Vyaxis</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
:root{
  --ink:#0C0C14;--ink2:#15151F;--surface:#F5F4F1;--card:#FFFFFF;
  --border:#E4E2DC;--muted:#8C897F;--text:#18171A;--subtext:#6A6760;
  --red:#C8102E;--red-dark:#9B0D22;--red-light:#FEF2F3;
  --gold:#C49A2A;--gold-light:#FDF9EF;
  --green:#14532D;--green-mid:#166534;--green-light:#F0FDF4;
  --blue:#1E3A8A;--blue-light:#EFF6FF;
  --purple:#7C3AED;--purple-light:#F5F3FF;
  --r:10px;--rsm:6px;
  --sh:0 1px 3px rgba(0,0,0,0.06),0 4px 20px rgba(0,0,0,0.05);
  --sh-lg:0 12px 48px rgba(0,0,0,0.14);
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
body{background:var(--surface);color:var(--text);font-family:'DM Sans',sans-serif;min-height:100vh;-webkit-font-smoothing:antialiased;}

/* LOGIN */
#login-screen{position:fixed;inset:0;background:var(--ink);display:flex;align-items:center;justify-content:center;z-index:1000;}
#login-screen::before{content:'';position:absolute;inset:0;background:radial-gradient(ellipse 80% 60% at 50% 40%,rgba(124,58,237,0.12) 0%,transparent 70%);pointer-events:none;}
.login-box{background:var(--ink2);border:1px solid rgba(255,255,255,0.08);border-radius:16px;padding:48px 44px;width:100%;max-width:420px;position:relative;box-shadow:var(--sh-lg);}
.login-box::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--purple),var(--blue));border-radius:16px 16px 0 0;}
.login-brand{text-align:center;margin-bottom:32px;}
.login-brand-top{font-size:10px;font-weight:600;letter-spacing:0.2em;text-transform:uppercase;color:rgba(255,255,255,0.3);margin-bottom:8px;}
.login-brand-name{font-family:'DM Serif Display',serif;font-size:28px;color:#fff;}
.login-brand-product{font-size:13px;color:rgba(255,255,255,0.4);margin-top:4px;}
.login-field{margin-bottom:18px;}
.login-label{font-size:10px;font-weight:600;letter-spacing:0.12em;text-transform:uppercase;color:rgba(255,255,255,0.4);display:block;margin-bottom:8px;}
.login-input{width:100%;background:rgba(255,255,255,0.06);border:1.5px solid rgba(255,255,255,0.1);border-radius:var(--rsm);color:#fff;font-family:'DM Sans',sans-serif;font-size:15px;padding:13px 16px;outline:none;transition:border-color 0.18s;-webkit-appearance:none;}
.login-input:focus{border-color:var(--purple);}
.login-input::placeholder{color:rgba(255,255,255,0.2);}
.login-btn{width:100%;background:var(--purple);color:#fff;border:none;border-radius:var(--rsm);font-family:'DM Sans',sans-serif;font-size:14px;font-weight:600;letter-spacing:0.06em;padding:14px;cursor:pointer;margin-top:8px;transition:background 0.18s;}
.login-btn:hover{background:#6D28D9;}
.login-error{background:rgba(200,16,46,0.15);border:1px solid rgba(200,16,46,0.3);color:#FCA5A5;border-radius:var(--rsm);padding:10px 14px;font-size:12px;font-weight:500;margin-top:14px;text-align:center;display:none;}
.login-error.show{display:block;}

/* APP */
#app{display:none;}
#app.visible{display:block;}

/* HEADER */
.header{background:var(--ink);padding:0 36px;display:flex;align-items:center;justify-content:space-between;height:64px;position:sticky;top:0;z-index:100;}
.header::after{content:'';position:absolute;bottom:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--purple),var(--blue));}
.header-brand{display:flex;align-items:center;gap:12px;}
.header-vyaxis{font-family:'DM Serif Display',serif;font-size:20px;color:#fff;}
.header-sep{width:1px;height:20px;background:rgba(255,255,255,0.15);}
.header-product{font-size:11px;font-weight:600;letter-spacing:0.12em;text-transform:uppercase;color:rgba(255,255,255,0.4);}
.header-right{display:flex;align-items:center;gap:12px;}
.admin-badge{background:rgba(124,58,237,0.2);color:#C4B5FD;border:1px solid rgba(124,58,237,0.3);border-radius:20px;font-size:10px;font-weight:600;letter-spacing:0.1em;text-transform:uppercase;padding:4px 12px;}
.logout-btn{background:rgba(255,255,255,0.08);color:rgba(255,255,255,0.6);border:1px solid rgba(255,255,255,0.12);border-radius:var(--rsm);font-family:'DM Sans',sans-serif;font-size:11px;font-weight:600;letter-spacing:0.06em;padding:7px 14px;cursor:pointer;transition:all 0.18s;}
.logout-btn:hover{background:rgba(200,16,46,0.2);color:#fff;}

/* NAV */
.nav-wrap{background:var(--card);border-bottom:1px solid var(--border);padding:0 36px;display:flex;gap:0;}
.nav-tab{padding:14px 20px 14px 0;font-size:11px;font-weight:600;letter-spacing:0.09em;text-transform:uppercase;color:var(--muted);border-bottom:2px solid transparent;cursor:pointer;transition:all 0.18s;margin-right:20px;}
.nav-tab:hover{color:var(--text);}
.nav-tab.active{color:var(--purple);border-bottom-color:var(--purple);}

/* PAGE */
.page{max-width:1200px;margin:0 auto;padding:32px 24px 80px;}
.sh{display:flex;align-items:flex-end;justify-content:space-between;margin:0 0 20px;}
.sh-title{font-family:'DM Serif Display',serif;font-size:24px;}
.sh-desc{font-size:12px;color:var(--muted);margin-top:4px;}

/* CARDS */
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--r);padding:24px 26px;box-shadow:var(--sh);margin-bottom:16px;}
.card-title{font-family:'DM Serif Display',serif;font-size:18px;margin-bottom:18px;}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px;}
.grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;}
.grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;}

/* KPI */
.kpi-tile{background:var(--card);border:1px solid var(--border);border-radius:var(--r);padding:18px 20px;box-shadow:var(--sh);position:relative;overflow:hidden;}
.kpi-tile::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;}
.k-purple::before{background:var(--purple);}
.k-green::before{background:var(--green-mid);}
.k-blue::before{background:var(--blue);}
.k-red::before{background:var(--red);}
.kpi-label{font-size:9px;font-weight:600;letter-spacing:0.16em;text-transform:uppercase;color:var(--muted);margin-bottom:8px;}
.kpi-val{font-family:'DM Serif Display',serif;font-size:30px;line-height:1;}
.k-purple .kpi-val{color:var(--purple);}
.k-green .kpi-val{color:var(--green-mid);}
.k-blue .kpi-val{color:var(--blue);}
.k-red .kpi-val{color:var(--red);}

/* TABLE */
.tbl-wrap{overflow-x:auto;border-radius:var(--rsm);border:1px solid var(--border);}
table{width:100%;border-collapse:collapse;font-size:12px;}
thead tr{background:var(--ink);}
thead th{padding:10px 14px;text-align:left;font-size:9px;font-weight:600;letter-spacing:0.12em;text-transform:uppercase;color:rgba(255,255,255,0.7);white-space:nowrap;}
tbody tr{border-bottom:1px solid var(--border);transition:background 0.12s;}
tbody tr:hover{background:rgba(124,58,237,0.03);}
td{padding:10px 14px;color:var(--text);font-size:12px;}

/* DEALER CARDS */
.dealer-card{background:var(--card);border:1px solid var(--border);border-radius:var(--r);padding:20px;box-shadow:var(--sh);position:relative;overflow:hidden;}
.dealer-card::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:linear-gradient(90deg,var(--purple),var(--blue));}
.dealer-name{font-family:'DM Serif Display',serif;font-size:18px;margin-bottom:4px;}
.dealer-id{font-size:10px;font-weight:600;letter-spacing:0.1em;text-transform:uppercase;color:var(--muted);margin-bottom:14px;}
.dealer-stats{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
.dealer-stat{background:var(--surface);border-radius:var(--rsm);padding:8px 12px;}
.dealer-stat-val{font-family:'DM Serif Display',serif;font-size:20px;color:var(--purple);}
.dealer-stat-lbl{font-size:9px;font-weight:600;letter-spacing:0.1em;text-transform:uppercase;color:var(--muted);margin-top:2px;}
.status-badge{display:inline-flex;align-items:center;gap:5px;padding:3px 10px;border-radius:20px;font-size:10px;font-weight:600;}
.s-active{background:var(--green-light);color:var(--green-mid);}
.s-inactive{background:#F0EEEB;color:var(--muted);}

/* FORM ELEMENTS */
.form-group{margin-bottom:16px;}
.form-label{font-size:10px;font-weight:600;letter-spacing:0.12em;text-transform:uppercase;color:var(--muted);display:block;margin-bottom:8px;}
.form-input{width:100%;background:var(--surface);border:1.5px solid var(--border);border-radius:var(--rsm);color:var(--text);font-family:'DM Sans',sans-serif;font-size:13px;padding:10px 14px;outline:none;transition:border-color 0.18s;-webkit-appearance:none;}
.form-input:focus{border-color:var(--purple);}
.form-input::placeholder{color:#C2BFB9;}
select.form-input{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath fill='%238C897F' d='M5 6L0 0h10z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center;padding-right:32px;cursor:pointer;}

/* BTNS */
.btn-primary{background:var(--purple);color:#fff;border:none;border-radius:var(--rsm);font-family:'DM Sans',sans-serif;font-size:12px;font-weight:600;letter-spacing:0.06em;padding:10px 22px;cursor:pointer;transition:background 0.18s;}
.btn-primary:hover{background:#6D28D9;}
.btn-dark{background:var(--ink);color:#fff;border:none;border-radius:var(--rsm);font-family:'DM Sans',sans-serif;font-size:12px;font-weight:600;letter-spacing:0.06em;padding:10px 22px;cursor:pointer;transition:background 0.18s;}
.btn-dark:hover{background:#000;}
.btn-outline{background:transparent;color:var(--purple);border:1.5px solid var(--purple);border-radius:var(--rsm);font-family:'DM Sans',sans-serif;font-size:12px;font-weight:600;letter-spacing:0.06em;padding:9px 20px;cursor:pointer;transition:all 0.18s;}
.btn-outline:hover{background:var(--purple-light);}
.btn-red{background:var(--red);color:#fff;border:none;border-radius:var(--rsm);font-family:'DM Sans',sans-serif;font-size:12px;font-weight:600;letter-spacing:0.06em;padding:9px 20px;cursor:pointer;transition:background 0.18s;}
.btn-red:hover{background:var(--red-dark);}
.btn-sm{padding:6px 14px;font-size:11px;}

/* REP TABLE */
.rep-row{display:flex;align-items:center;justify-content:space-between;padding:14px 0;border-bottom:1px solid var(--border);}
.rep-row:last-child{border-bottom:none;}
.rep-info{display:flex;flex-direction:column;gap:3px;}
.rep-name-lg{font-weight:600;font-size:14px;}
.rep-meta{font-size:11px;color:var(--muted);}
.rep-actions{display:flex;align-items:center;gap:8px;}

/* EMAIL LOG */
.email-log-row{display:flex;align-items:flex-start;gap:14px;padding:14px 0;border-bottom:1px solid var(--border);}
.email-log-row:last-child{border-bottom:none;}
.email-dot{width:8px;height:8px;border-radius:50%;margin-top:4px;flex-shrink:0;}
.dot-hot{background:var(--red);}
.dot-daily{background:var(--blue);}
.dot-system{background:var(--muted);}
.email-log-info{flex:1;}
.email-log-subject{font-size:13px;font-weight:600;color:var(--text);}
.email-log-meta{font-size:11px;color:var(--muted);margin-top:3px;}

/* TAB PANELS */
.tab-panel{display:none;}
.tab-panel.active{display:block;}

/* MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:500;display:none;}
.modal-overlay.open{display:flex;}
.modal{background:var(--card);border-radius:var(--r);padding:32px;width:100%;max-width:480px;box-shadow:var(--sh-lg);}
.modal-title{font-family:'DM Serif Display',serif;font-size:22px;margin-bottom:6px;}
.modal-desc{font-size:13px;color:var(--muted);margin-bottom:24px;}
.modal-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:24px;}

/* ALERT */
.alert{padding:12px 16px;border-radius:var(--rsm);font-size:12px;font-weight:500;margin-bottom:16px;display:none;}
.alert.show{display:block;}
.alert-success{background:var(--green-light);color:var(--green-mid);border:1px solid #BBF7D0;}
.alert-error{background:var(--red-light);color:var(--red);border:1px solid #FECACA;}

/* LOADING */
.loading{text-align:center;padding:40px;color:var(--muted);font-size:13px;}
.spinner{display:inline-block;width:18px;height:18px;border:2px solid var(--border);border-top-color:var(--purple);border-radius:50%;animation:spin 0.7s linear infinite;margin-right:8px;vertical-align:middle;}
@keyframes spin{to{transform:rotate(360deg);}}
@keyframes fadeUp{from{opacity:0;transform:translateY(12px);}to{opacity:1;transform:translateY(0);}}

/* â”€â”€ Export Buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.export-bar{display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap;}
.export-btn{display:inline-flex;align-items:center;gap:7px;padding:9px 18px;border-radius:9px;font-size:12px;font-weight:700;cursor:pointer;border:none;font-family:'DM Sans',sans-serif;transition:all 0.18s;}
.export-csv{background:rgba(34,197,94,0.12);border:1px solid rgba(34,197,94,0.3);color:#4ADE80;}
.export-csv:hover{background:rgba(34,197,94,0.2);transform:translateY(-1px);}
.export-pdf{background:rgba(200,16,46,0.12);border:1px solid rgba(200,16,46,0.3);color:#FC8181;}
.export-pdf:hover{background:rgba(200,16,46,0.2);transform:translateY(-1px);}
.export-greet-csv{background:rgba(91,79,232,0.12);border:1px solid rgba(91,79,232,0.3);color:#7B72F0;}
.export-greet-csv:hover{background:rgba(91,79,232,0.2);transform:translateY(-1px);}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="login-screen">
  <div class="login-box">
    <div class="login-brand">
      <div class="login-brand-top">Vyaxis Platform</div>
      <div class="login-brand-name">ServiceBridge</div>
      <div class="login-brand-product">Admin Console Â· Restricted Access</div>
    </div>
    <div class="login-field">
      <label class="login-label">Admin Username</label>
      <input class="login-input" type="text" id="login-user" placeholder="Enter username" autocomplete="username">
    </div>
    <div class="login-field">
      <label class="login-label">Password</label>
      <input class="login-input" type="password" id="login-pass" placeholder="Enter password" autocomplete="current-password">
    </div>
    <button class="login-btn" onclick="doLogin()">Access Admin Console â†’</button>
    <div class="login-error" id="login-err">Invalid credentials. Admin access only.</div>
  </div>
</div>

<!-- APP -->
<div id="app">
  <header class="header">
    <div class="header-brand">
      <div class="header-vyaxis">Vyaxis</div>
      <div class="header-sep"></div>
      <div class="header-product">ServiceBridge Admin</div>
    </div>
    <div class="header-right">
      <div class="admin-badge">âš¡ Admin Console</div>
      <button class="logout-btn" onclick="doLogout()">Sign Out</button>
    </div>
  </header>

  <div class="nav-wrap">
    <div class="nav-tab active" onclick="showTab('overview',this)">ğŸ“Š Overview</div>
    <div class="nav-tab" onclick="showTab('dealers',this)">ğŸ¢ Dealers</div>
    <div class="nav-tab" onclick="showTab('reps',this)">ğŸ‘¤ Rep Management</div>
    <div class="nav-tab" onclick="showTab('emails',this)">ğŸ“§ Email Settings</div>
    <div class="nav-tab" onclick="showTab('data',this)">ğŸ—„ Data</div>
  </div>

  <div class="page">

  <!-- Export Bar -->
  <div class="export-bar" id="admin-export-bar" style="margin-top:20px;">
    <button class="export-btn export-csv" onclick="adminExportS2SCSV()">â¬‡ S2S Entries â€” CSV</button>
    <button class="export-btn export-pdf" onclick="adminExportS2SPDF()">ğŸ–¨ S2S Entries â€” Print / PDF</button>
  </div>


    <!-- OVERVIEW -->
    <div class="tab-panel active" id="tab-overview">
      <div class="sh">
        <div><div class="sh-title">Platform Overview</div><div class="sh-desc">ServiceBridge across all dealers</div></div>
        <div style="font-size:11px;color:var(--muted);" id="overview-sync">â€”</div>
      </div>
      <div class="grid-4" style="margin-bottom:20px;">
        <div class="kpi-tile k-purple"><div class="kpi-label">Total Dealers</div><div class="kpi-val" id="kpi-dealers">1</div></div>
        <div class="kpi-tile k-green"><div class="kpi-label">Total Entries</div><div class="kpi-val" id="kpi-entries">â€”</div></div>
        <div class="kpi-tile k-blue"><div class="kpi-label">Vehicles Sold</div><div class="kpi-val" id="kpi-sold">â€”</div></div>
        <div class="kpi-tile k-red"><div class="kpi-label">Hot Leads</div><div class="kpi-val" id="kpi-hot">â€”</div></div>
      </div>
      <div class="grid-2">
        <div class="card">
          <div class="card-title">Recent Entries</div>
          <div id="recent-entries-list"><div class="loading"><span class="spinner"></span>Loading...</div></div>
        </div>
        <div class="card">
          <div class="card-title">Email Notification Log</div>
          <div id="email-log-list">
            <div class="email-log-row">
              <div class="email-dot dot-system"></div>
              <div class="email-log-info">
                <div class="email-log-subject">Email system initializing...</div>
                <div class="email-log-meta">Waiting for DNS verification on vyaxis.com</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- DEALERS -->
    <div class="tab-panel" id="tab-dealers">
      <div class="sh">
        <div><div class="sh-title">Dealer Management</div><div class="sh-desc">All ServiceBridge dealer accounts</div></div>
        <button class="btn-primary" onclick="openAddDealer()">+ Add Dealer</button>
      </div>
      <div id="dealers-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
        <!-- Gallatin CDJR hardcoded as dealer 1 -->
        <div class="dealer-card">
          <div class="dealer-name">Gallatin CDJR</div>
          <div class="dealer-id">Dealer ID: gallatin-cdjr Â· WeAuto Group</div>
          <div class="dealer-stats" id="gallatin-stats">
            <div class="dealer-stat"><div class="dealer-stat-val" id="gs-entries">â€”</div><div class="dealer-stat-lbl">Total Entries</div></div>
            <div class="dealer-stat"><div class="dealer-stat-val" id="gs-sold">â€”</div><div class="dealer-stat-lbl">Sold</div></div>
            <div class="dealer-stat"><div class="dealer-stat-val" id="gs-conv">â€”</div><div class="dealer-stat-lbl">Conv. Rate</div></div>
            <div class="dealer-stat"><div class="dealer-stat-val" id="gs-hot">â€”</div><div class="dealer-stat-lbl">Hot Leads</div></div>
          </div>
          <div style="margin-top:14px;display:flex;align-items:center;justify-content:space-between;">
            <span class="status-badge s-active">â— Active</span>
            <div style="display:flex;gap:8px;">
              <a href="manager-dashboard.html" target="_blank" class="btn-outline btn-sm">View Dashboard</a>
              <a href="service-to-sales-log.html" target="_blank" class="btn-dark btn-sm">View Form</a>
            </div>
          </div>
        </div>
        <div class="dealer-card" style="border:2px dashed var(--border);background:transparent;box-shadow:none;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:200px;cursor:pointer;" onclick="openAddDealer()">
          <div style="font-size:32px;margin-bottom:12px;">+</div>
          <div style="font-family:'DM Serif Display',serif;font-size:16px;color:var(--subtext);">Add New Dealer</div>
          <div style="font-size:12px;color:var(--muted);margin-top:6px;">Onboard next ServiceBridge client</div>
        </div>
      </div>
    </div>

    <!-- REP MANAGEMENT -->
    <div class="tab-panel" id="tab-reps">
      <div class="sh">
        <div><div class="sh-title">Rep Management</div><div class="sh-desc">Gallatin CDJR S2S Team</div></div>
        <button class="btn-primary" onclick="openAddRep()">+ Add Rep</button>
      </div>
      <div class="card">
        <div id="alert-rep" class="alert"></div>
        <div id="reps-list"></div>
      </div>
    </div>

    <!-- EMAIL SETTINGS -->
    <div class="tab-panel" id="tab-emails">
      <div class="sh"><div><div class="sh-title">Email Notifications</div><div class="sh-desc">Alert and reporting configuration</div></div></div>

      <div class="grid-2">
        <div class="card">
          <div class="card-title">ğŸ”¥ Hot Lead Alerts</div>
          <p style="font-size:13px;color:var(--subtext);margin-bottom:18px;">Instant email when a buying temperature of 8, 9, or 10 is submitted. Sent to all recipients below.</p>
          <div class="form-group">
            <label class="form-label">Status</label>
            <select class="form-input" id="hot-alert-status">
              <option value="enabled">âœ… Enabled</option>
              <option value="disabled">âŒ Disabled</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Trigger Threshold (Min Buying Temp)</label>
            <select class="form-input" id="hot-threshold">
              <option value="8">8+ (Hot leads only)</option>
              <option value="7">7+ (Warm & hot)</option>
              <option value="9">9+ (Very hot only)</option>
            </select>
          </div>
          <button class="btn-primary" onclick="saveHotAlertSettings()">Save Settings</button>
        </div>

        <div class="card">
          <div class="card-title">ğŸ“… Daily Summary Report</div>
          <p style="font-size:13px;color:var(--subtext);margin-bottom:18px;">Morning email with previous day's S2S activity, outcomes, top leads, and team performance.</p>
          <div class="form-group">
            <label class="form-label">Status</label>
            <select class="form-input" id="daily-status">
              <option value="enabled">âœ… Enabled</option>
              <option value="disabled">âŒ Disabled</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Send Time (CT)</label>
            <select class="form-input" id="daily-time">
              <option value="9:00">9:00 AM CT</option>
              <option value="7:00">7:00 AM CT</option>
              <option value="8:00">8:00 AM CT</option>
              <option value="10:00">10:00 AM CT</option>
            </select>
          </div>
          <button class="btn-primary" onclick="saveDailySettings()">Save Settings</button>
        </div>
      </div>

      <div class="card">
        <div class="card-title">ğŸ“¬ Notification Recipients</div>
        <p style="font-size:13px;color:var(--subtext);margin-bottom:18px;">All emails below will receive hot lead alerts and daily summary reports.</p>
        <div id="recipients-list"></div>
        <div style="display:flex;gap:10px;margin-top:16px;">
          <input class="form-input" type="email" id="new-recipient" placeholder="Add email address..." style="flex:1;">
          <button class="btn-primary" onclick="addRecipient()">Add</button>
        </div>
      </div>

      <div class="card">
        <div class="card-title">ğŸ§ª Test Email System</div>
        <p style="font-size:13px;color:var(--subtext);margin-bottom:18px;">Send a test email to verify the system is working correctly.</p>
        <div style="display:flex;gap:10px;align-items:center;">
          <input class="form-input" type="email" id="test-email" placeholder="Send test to..." style="width:280px;" value="Rob.l@gallatincdjr.com">
          <button class="btn-outline" onclick="sendTestEmail()">Send Test Email</button>
          <button class="btn-dark" onclick="sendTestDailySummary()">Send Test Summary</button>
        </div>
        <div id="test-result" class="alert" style="margin-top:14px;"></div>
      </div>
    </div>

    <!-- DATA -->
    <div class="tab-panel" id="tab-data">
      <div class="sh">
        <div><div class="sh-title">Data Management</div><div class="sh-desc">View and manage all S2S entries</div></div>
        <div style="display:flex;gap:10px;">
          <button class="btn-dark" onclick="exportAllCSV()">â¬‡ Export All CSV</button>
          <button class="btn-red" onclick="confirmDeleteAll()">âœ• Delete All</button>
        </div>
      </div>
      <div class="card">
        <div class="tbl-wrap">
          <table>
            <thead><tr>
              <th>ID</th><th>Date</th><th>Submitter</th><th>Customer</th><th>Outcome</th><th>Temp</th><th>Vehicle</th><th>Actions</th>
            </tr></thead>
            <tbody id="data-tbody"><tr><td colspan="8"><div class="loading"><span class="spinner"></span>Loading...</div></td></tr></tbody>
          </table>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- ADD DEALER MODAL -->
<div class="modal-overlay" id="dealer-modal">
  <div class="modal">
    <div class="modal-title">Add New Dealer</div>
    <div class="modal-desc">Onboard a new ServiceBridge client. They'll get their own isolated data and branded dashboard.</div>
    <div class="form-group"><label class="form-label">Dealership Name</label><input class="form-input" id="new-dealer-name" placeholder="e.g. Nashville CDJR"></div>
    <div class="form-group"><label class="form-label">Dealer Group</label><input class="form-input" id="new-dealer-group" placeholder="e.g. WeAuto Group"></div>
    <div class="form-group"><label class="form-label">Primary Contact Email</label><input class="form-input" type="email" id="new-dealer-email" placeholder="manager@dealership.com"></div>
    <div class="form-group"><label class="form-label">City, State</label><input class="form-input" id="new-dealer-location" placeholder="Nashville, TN"></div>
    <div class="modal-actions">
      <button class="btn-outline" onclick="closeModal('dealer-modal')">Cancel</button>
      <button class="btn-primary" onclick="addDealer()">Create Dealer Account</button>
    </div>
  </div>
</div>

<!-- ADD REP MODAL -->
<div class="modal-overlay" id="rep-modal">
  <div class="modal">
    <div class="modal-title">Add Rep</div>
    <div class="modal-desc">Add a new salesperson to the Gallatin CDJR S2S team.</div>
    <div class="form-group"><label class="form-label">Full Name</label><input class="form-input" id="new-rep-name" placeholder="e.g. John Smith"></div>
    <div class="form-group"><label class="form-label">Role</label><select class="form-input" id="new-rep-role"><option>Sales</option><option>S2S Manager</option><option>Finance Manager</option></select></div>
    <div class="modal-actions">
      <button class="btn-outline" onclick="closeModal('rep-modal')">Cancel</button>
      <button class="btn-primary" onclick="addRep()">Add Rep</button>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SB_URL  = 'https://jbkgwtohwsbaorhvuuqb.supabase.co';
const SB_KEY  = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impia2d3dG9od3NiYW9yaHZ1dXFiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5NjkwNDIsImV4cCI6MjA4NzU0NTA0Mn0.GRXOYbIuVDxU9-FEBYmyd1QmytVUrMIAxbnOSfepzuU';
const HEADERS = {'apikey':SB_KEY,'Authorization':'Bearer '+SB_KEY,'Content-Type':'application/json'};
const RESEND_KEY = 're_YQ2WKxeU_3uf47V8XekvjuK9GGzQYoKHC';

const ADMIN_CREDS = { 'robert': 'vyaxis2025!' };

// Email recipients
let RECIPIENTS = [
  'Rob.l@gallatincdjr.com',
  'Tyler.d@gallatincdjr.com',
  'Joe.s@gallatincdjr.com',
  'Jbarba@weauto.us',
  'dominick.f@gallatincdjr.com',
  'Mich.s@gallatincdjr.com'
];

// Reps
let REPS = [
  {name:'Tyler Doyle', role:'S2S Manager'},
  {name:'Andrew Kirk', role:'Sales'},
  {name:'DJ Rogers', role:'Sales'},
  {name:'Kody McCann', role:'Sales'}
];

let ALL_ENTRIES = [];
let emailLog = [];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function doLogin(){
  const u=document.getElementById('login-user').value.trim().toLowerCase();
  const p=document.getElementById('login-pass').value;
  if(ADMIN_CREDS[u]&&ADMIN_CREDS[u]===p){
    sessionStorage.setItem('admin_auth','1');
    document.getElementById('login-screen').style.display='none';
    document.getElementById('app').style.display='block';
    init();
  } else {
    document.getElementById('login-err').classList.add('show');
  }
}
function doLogout(){sessionStorage.removeItem('admin_auth');location.reload();}
document.addEventListener('keydown',e=>{if(e.key==='Enter'&&document.getElementById('login-screen').style.display!=='none')doLogin();});
if(sessionStorage.getItem('admin_auth')==='1'){
  document.getElementById('login-screen').style.display='none';
  document.getElementById('app').style.display='block';
  init();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function init(){
  await loadEntries();
  renderOverview();
  renderReps();
  renderRecipients();
  renderDataTable();
  updateDealerStats();
  document.getElementById('overview-sync').textContent=`Last updated: ${new Date().toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:true})}`;
}

async function loadEntries(){
  try{
    const res=await fetch(`${SB_URL}/rest/v1/s2s_entries?select=*&order=id.desc&limit=1000`,{headers:HEADERS});
    if(res.ok) ALL_ENTRIES=await res.json();
  }catch(e){console.error(e);}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// OVERVIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderOverview(){
  const n=ALL_ENTRIES.length;
  const sold=ALL_ENTRIES.filter(e=>e.outcome&&(e.outcome.includes('New')||e.outcome.includes('Used'))).length;
  const hot=ALL_ENTRIES.filter(e=>parseInt(e.eng_score)>=8).length;
  document.getElementById('kpi-entries').textContent=n;
  document.getElementById('kpi-sold').textContent=sold;
  document.getElementById('kpi-hot').textContent=hot;

  // Recent entries
  const recent=ALL_ENTRIES.slice(0,5);
  document.getElementById('recent-entries-list').innerHTML=recent.length?recent.map(e=>`
    <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border);">
      <div>
        <div style="font-weight:600;font-size:13px;">${e.first_name||''} ${e.last_name||''}</div>
        <div style="font-size:11px;color:var(--muted);">${e.submitter||'â€”'} Â· ${e.timestamp||'â€”'}</div>
      </div>
      <div style="text-align:right;">
        <div style="font-size:11px;font-weight:600;color:${e.outcome&&e.outcome.includes('Sold')?'var(--green-mid)':e.outcome==='Follow-Up Required'?'var(--gold)':'var(--muted)'};">${e.outcome||'â€”'}</div>
        <div style="font-size:11px;color:var(--muted);">Temp: ${e.eng_score||'â€”'}</div>
      </div>
    </div>`).join(''):`<div style="text-align:center;padding:30px;color:var(--muted);">No entries yet</div>`;
}

function updateDealerStats(){
  const n=ALL_ENTRIES.length;
  const sold=ALL_ENTRIES.filter(e=>e.outcome&&(e.outcome.includes('New')||e.outcome.includes('Used'))).length;
  const hot=ALL_ENTRIES.filter(e=>parseInt(e.eng_score)>=8).length;
  const conv=n?Math.round((sold/n)*100)+'%':'0%';
  document.getElementById('gs-entries').textContent=n;
  document.getElementById('gs-sold').textContent=sold;
  document.getElementById('gs-conv').textContent=conv;
  document.getElementById('gs-hot').textContent=hot;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// REP MANAGEMENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderReps(){
  document.getElementById('reps-list').innerHTML=REPS.map((r,i)=>`
    <div class="rep-row">
      <div class="rep-info">
        <div class="rep-name-lg">${r.name}</div>
        <div class="rep-meta">${r.role} Â· Gallatin CDJR</div>
      </div>
      <div class="rep-actions">
        <span style="font-size:11px;color:var(--muted);">Entries: ${ALL_ENTRIES.filter(e=>e.submitter===r.name).length}</span>
        <button class="btn-red btn-sm" onclick="removeRep(${i})">Remove</button>
      </div>
    </div>`).join('');
}

function openAddRep(){document.getElementById('rep-modal').classList.add('open');}
function addRep(){
  const name=document.getElementById('new-rep-name').value.trim();
  const role=document.getElementById('new-rep-role').value;
  if(!name){alert('Enter a name.');return;}
  REPS.push({name,role});
  renderReps();
  closeModal('rep-modal');
  document.getElementById('new-rep-name').value='';
  showAlert('rep','Rep added successfully. Update the form HTML to include this rep.',true);
}
function removeRep(i){
  if(!confirm(`Remove ${REPS[i].name}?`))return;
  REPS.splice(i,1);
  renderReps();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EMAIL / RECIPIENTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderRecipients(){
  document.getElementById('recipients-list').innerHTML=RECIPIENTS.map((r,i)=>`
    <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border);">
      <span style="font-size:13px;">${r}</span>
      <button class="btn-red btn-sm" onclick="removeRecipient(${i})">Remove</button>
    </div>`).join('');
}
function addRecipient(){
  const v=document.getElementById('new-recipient').value.trim();
  if(!v||!v.includes('@')){alert('Enter a valid email.');return;}
  RECIPIENTS.push(v);
  renderRecipients();
  document.getElementById('new-recipient').value='';
}
function removeRecipient(i){RECIPIENTS.splice(i,1);renderRecipients();}
function saveHotAlertSettings(){alert('Hot lead alert settings saved.');}
function saveDailySettings(){alert('Daily summary settings saved.');}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EMAIL SENDING VIA RESEND
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function sendEmail(to, subject, html){
  try{
    const res=await fetch('/api/send-email',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({to:Array.isArray(to)?to:[to],subject,html})
    });
    const data=await res.json();
    if(data.success){
      addEmailLog(subject,'sent');
      return {success:true,id:data.id};
    } else {
      addEmailLog(subject,'failed');
      return {success:false,error:data.error};
    }
  }catch(err){
    addEmailLog(subject,'failed');
    return {success:false,error:err.message};
  }
}

function addEmailLog(subject, status){
  emailLog.unshift({subject, status, time:new Date().toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:true})});
  const el=document.getElementById('email-log-list');
  if(el){
    el.innerHTML=emailLog.slice(0,8).map(e=>`
      <div class="email-log-row">
        <div class="email-dot ${e.status==='sent'?'dot-daily':'dot-hot'}"></div>
        <div class="email-log-info">
          <div class="email-log-subject">${e.subject}</div>
          <div class="email-log-meta">${e.status==='sent'?'âœ“ Sent':'âœ— Failed'} Â· ${e.time}</div>
        </div>
      </div>`).join('');
  }
}

async function sendTestEmail(){
  const to=document.getElementById('test-email').value;
  const result=document.getElementById('test-result');
  result.className='alert show';result.style.display='block';
  result.textContent='Sending...';

  const html=buildHotLeadEmail({
    first_name:'Test',last_name:'Customer',phone:'(615) 555-0100',
    veh_year:'2019',veh_make:'Ram',veh_model:'1500',veh_miles:'62000',
    eng_score:9,outcome:'Follow-Up Required',submitter:'Tyler Doyle',
    visit_reason:'Major Mechanical Repair',repair_cost:'$3,200',
    trade_equity:'Positive Equity',timeline:'Within 30 Days',notes:'Test alert from ServiceBridge Admin',
    timestamp:new Date().toLocaleString()
  });

  const res=await sendEmail(to,'ğŸ”¥ [TEST] Hot Lead Alert â€” ServiceBridge',html);
  if(res.success){
    result.className='alert alert-success show';
    result.textContent='âœ“ Test email sent successfully! Check your inbox.';
  } else {
    result.className='alert alert-error show';
    result.textContent=`âœ— Failed: ${res.error}. DNS may still be propagating â€” try again in a few minutes.`;
  }
}

async function sendTestDailySummary(){
  const to=document.getElementById('test-email').value;
  const result=document.getElementById('test-result');
  result.className='alert show';result.style.display='block';
  result.textContent='Sending daily summary test...';

  const html=buildDailySummaryEmail(ALL_ENTRIES.slice(0,5));
  const res=await sendEmail(to,'ğŸ“Š [TEST] Daily S2S Summary â€” Gallatin CDJR',html);
  if(res.success){
    result.className='alert alert-success show';
    result.textContent='âœ“ Daily summary test sent! Check your inbox.';
  } else {
    result.className='alert alert-error show';
    result.textContent=`âœ— Failed: ${res.error}. DNS may still be propagating.`;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EMAIL TEMPLATES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildHotLeadEmail(e){
  const tempColor=parseInt(e.eng_score)>=9?'#C8102E':parseInt(e.eng_score)>=8?'#C49A2A':'#166534';
  return `<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0"></head>
<body style="margin:0;padding:0;background:#F5F4F1;font-family:'Helvetica Neue',Arial,sans-serif;">
<div style="max-width:600px;margin:0 auto;padding:24px 16px;">
  <div style="background:#0C0C14;border-radius:12px 12px 0 0;padding:24px 28px;background-image:linear-gradient(135deg,#0C0C14 0%,#1a1a2e 100%);">
    <div style="font-size:11px;font-weight:600;letter-spacing:0.2em;text-transform:uppercase;color:rgba(255,255,255,0.4);margin-bottom:6px;">Vyaxis Â· ServiceBridge</div>
    <div style="font-size:24px;font-weight:700;color:#fff;margin-bottom:4px;">ğŸ”¥ Hot Lead Alert</div>
    <div style="font-size:13px;color:rgba(255,255,255,0.5);">Gallatin CDJR Â· Service Drive</div>
  </div>
  <div style="background:#fff;padding:28px;border-left:1px solid #E4E2DC;border-right:1px solid #E4E2DC;">
    <div style="display:inline-block;background:${tempColor};color:#fff;border-radius:6px;padding:6px 16px;font-size:13px;font-weight:700;margin-bottom:20px;">
      ğŸŒ¡ Buying Temperature: ${e.eng_score}/10
    </div>
    <table style="width:100%;border-collapse:collapse;margin-bottom:20px;">
      <tr><td style="padding:8px 0;border-bottom:1px solid #F0EEEB;font-size:11px;font-weight:600;letter-spacing:0.1em;text-transform:uppercase;color:#8C897F;width:40%;">Customer</td>
      <td style="padding:8px 0;border-bottom:1px solid #F0EEEB;font-size:13px;font-weight:600;">${e.first_name} ${e.last_name}</td></tr>
      <tr><td style="padding:8px 0;border-bottom:1px solid #F0EEEB;font-size:11px;font-weight:600;letter-spacing:0.1em;text-transform:uppercase;color:#8C897F;">Phone</td>
      <td style="padding:8px 0;border-bottom:1px solid #F0EEEB;font-size:13px;">${e.phone||'â€”'}</td></tr>
      <tr><td style="padding:8px 0;border-bottom:1px solid #F0EEEB;font-size:11px;font-weight:600;letter-spacing:0.1em;text-transform:uppercase;color:#8C897F;">Vehicle</td>
      <td style="padding:8px 0;border-bottom:1px solid #F0EEEB;font-size:13px;">${e.veh_year||''} ${e.veh_make||''} ${e.veh_model||''} ${e.veh_miles?'Â· '+Number(e.veh_miles).toLocaleString()+' mi':''}</td></tr>
      <tr><td style="padding:8px 0;border-bottom:1px solid #F0EEEB;font-size:11px;font-weight:600;letter-spacing:0.1em;text-transform:uppercase;color:#8C897F;">Visit Reason</td>
      <td style="padding:8px 0;border-bottom:1px solid #F0EEEB;font-size:13px;">${e.visit_reason||'â€”'}</td></tr>
      <tr><td style="padding:8px 0;border-bottom:1px solid #F0EEEB;font-size:11px;font-weight:600;letter-spacing:0.1em;text-transform:uppercase;color:#8C897F;">Repair Cost</td>
      <td style="padding:8px 0;border-bottom:1px solid #F0EEEB;font-size:13px;">${e.repair_cost||'â€”'}</td></tr>
      <tr><td style="padding:8px 0;border-bottom:1px solid #F0EEEB;font-size:11px;font-weight:600;letter-spacing:0.1em;text-transform:uppercase;color:#8C897F;">Equity</td>
      <td style="padding:8px 0;border-bottom:1px solid #F0EEEB;font-size:13px;">${e.trade_equity||'â€”'}</td></tr>
      <tr><td style="padding:8px 0;border-bottom:1px solid #F0EEEB;font-size:11px;font-weight:600;letter-spacing:0.1em;text-transform:uppercase;color:#8C897F;">Timeline</td>
      <td style="padding:8px 0;border-bottom:1px solid #F0EEEB;font-size:13px;">${e.timeline||'â€”'}</td></tr>
      <tr><td style="padding:8px 0;border-bottom:1px solid #F0EEEB;font-size:11px;font-weight:600;letter-spacing:0.1em;text-transform:uppercase;color:#8C897F;">Logged By</td>
      <td style="padding:8px 0;border-bottom:1px solid #F0EEEB;font-size:13px;">${e.submitter||'â€”'}</td></tr>
      <tr><td style="padding:8px 0;font-size:11px;font-weight:600;letter-spacing:0.1em;text-transform:uppercase;color:#8C897F;">Outcome</td>
      <td style="padding:8px 0;font-size:13px;font-weight:600;color:#C49A2A;">${e.outcome||'â€”'}</td></tr>
    </table>
    ${e.notes?`<div style="background:#F5F4F1;border-radius:6px;padding:14px 16px;margin-bottom:20px;"><div style="font-size:10px;font-weight:600;letter-spacing:0.1em;text-transform:uppercase;color:#8C897F;margin-bottom:6px;">Notes</div><div style="font-size:13px;">${e.notes}</div></div>`:''}
    <a href="https://servicebridge.vyaxis.com/manager-dashboard.html" style="display:inline-block;background:#C8102E;color:#fff;text-decoration:none;border-radius:6px;padding:12px 24px;font-size:13px;font-weight:600;letter-spacing:0.04em;">View in Dashboard â†’</a>
  </div>
  <div style="background:#EDECEA;border:1px solid #E4E2DC;border-top:none;border-radius:0 0 12px 12px;padding:16px 28px;text-align:center;">
    <div style="font-size:11px;color:#8C897F;">ServiceBridge by Vyaxis Â· Gallatin CDJR Â· ${e.timestamp||new Date().toLocaleString()}</div>
  </div>
</div>
</body></html>`;
}

function buildDailySummaryEmail(entries){
  const today=new Date();
  const yesterday=new Date(today);yesterday.setDate(yesterday.getDate()-1);
  const dateStr=yesterday.toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric'});
  const n=entries.length;
  const sold=entries.filter(e=>e.outcome&&(e.outcome.includes('New')||e.outcome.includes('Used'))).length;
  const appts=entries.filter(e=>e.outcome==='Appointment Set').length;
  const fu=entries.filter(e=>e.outcome==='Follow-Up Required').length;
  const hot=entries.filter(e=>parseInt(e.eng_score)>=8).length;
  const conv=n?Math.round((sold/n)*100):0;
  const temps=entries.map(e=>parseInt(e.eng_score)).filter(t=>!isNaN(t));
  const avgTemp=temps.length?(temps.reduce((a,b)=>a+b,0)/temps.length).toFixed(1):'â€”';

  return `<!DOCTYPE html><html><head><meta charset="UTF-8"></head>
<body style="margin:0;padding:0;background:#F5F4F1;font-family:'Helvetica Neue',Arial,sans-serif;">
<div style="max-width:600px;margin:0 auto;padding:24px 16px;">
  <div style="background:#0C0C14;border-radius:12px 12px 0 0;padding:24px 28px;">
    <div style="font-size:11px;font-weight:600;letter-spacing:0.2em;text-transform:uppercase;color:rgba(255,255,255,0.4);margin-bottom:6px;">Vyaxis Â· ServiceBridge</div>
    <div style="font-size:24px;font-weight:700;color:#fff;margin-bottom:4px;">ğŸ“Š Daily S2S Summary</div>
    <div style="font-size:13px;color:rgba(255,255,255,0.5);">Gallatin CDJR Â· ${dateStr}</div>
  </div>
  <div style="background:#fff;padding:28px;border-left:1px solid #E4E2DC;border-right:1px solid #E4E2DC;">
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:24px;">
      ${[['Total Entries',n,'#0C0C14'],['Vehicles Sold',sold,'#166534'],['Appts Set',appts,'#1E3A8A'],['Follow-Ups',fu,'#C49A2A'],['Hot Leads (8+)',hot,'#C8102E'],['Avg Buy Temp',avgTemp,'#7C3AED']].map(([l,v,c])=>`
      <div style="background:#F5F4F1;border-radius:8px;padding:14px;text-align:center;">
        <div style="font-size:24px;font-weight:700;color:${c};font-family:Georgia,serif;">${v}</div>
        <div style="font-size:10px;font-weight:600;letter-spacing:0.1em;text-transform:uppercase;color:#8C897F;margin-top:4px;">${l}</div>
      </div>`).join('')}
    </div>
    <div style="font-size:13px;font-weight:600;margin-bottom:12px;color:#0C0C14;">Conversion Rate: ${conv}%</div>
    ${n>0?`<table style="width:100%;border-collapse:collapse;margin-bottom:20px;">
      <tr style="background:#0C0C14;"><th style="padding:8px 12px;text-align:left;font-size:10px;font-weight:600;letter-spacing:0.1em;text-transform:uppercase;color:rgba(255,255,255,0.7);">Customer</th>
      <th style="padding:8px 12px;text-align:left;font-size:10px;font-weight:600;letter-spacing:0.1em;text-transform:uppercase;color:rgba(255,255,255,0.7);">Rep</th>
      <th style="padding:8px 12px;text-align:left;font-size:10px;font-weight:600;letter-spacing:0.1em;text-transform:uppercase;color:rgba(255,255,255,0.7);">Temp</th>
      <th style="padding:8px 12px;text-align:left;font-size:10px;font-weight:600;letter-spacing:0.1em;text-transform:uppercase;color:rgba(255,255,255,0.7);">Outcome</th></tr>
      ${entries.slice(0,8).map((e,i)=>`<tr style="background:${i%2?'#FAFAF8':'#fff'};"><td style="padding:8px 12px;font-size:12px;">${e.first_name||''} ${e.last_name||''}</td>
      <td style="padding:8px 12px;font-size:12px;">${e.submitter||'â€”'}</td>
      <td style="padding:8px 12px;font-size:12px;font-weight:700;">${e.eng_score||'â€”'}</td>
      <td style="padding:8px 12px;font-size:12px;">${e.outcome||'â€”'}</td></tr>`).join('')}
    </table>`:`<div style="text-align:center;padding:30px;color:#8C897F;">No entries logged yesterday.</div>`}
    <a href="https://servicebridge.vyaxis.com/manager-dashboard.html" style="display:inline-block;background:#0C0C14;color:#fff;text-decoration:none;border-radius:6px;padding:12px 24px;font-size:13px;font-weight:600;">Open Full Dashboard â†’</a>
  </div>
  <div style="background:#EDECEA;border:1px solid #E4E2DC;border-top:none;border-radius:0 0 12px 12px;padding:16px 28px;text-align:center;">
    <div style="font-size:11px;color:#8C897F;">ServiceBridge by Vyaxis Â· Daily report sent at 9:00 AM CT</div>
  </div>
</div>
</body></html>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA TABLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderDataTable(){
  const tbody=document.getElementById('data-tbody');
  if(!ALL_ENTRIES.length){tbody.innerHTML=`<tr><td colspan="8" style="text-align:center;padding:30px;color:var(--muted);">No entries yet</td></tr>`;return;}
  tbody.innerHTML=ALL_ENTRIES.map(e=>`<tr>
    <td style="color:var(--muted);">${e.id}</td>
    <td style="font-size:11px;">${e.timestamp||'â€”'}</td>
    <td style="font-weight:600;">${e.submitter||'â€”'}</td>
    <td>${e.first_name||''} ${e.last_name||''}</td>
    <td>${e.outcome||'â€”'}</td>
    <td style="font-weight:700;">${e.eng_score||'â€”'}</td>
    <td style="font-size:11px;">${[e.veh_year,e.veh_make,e.veh_model].filter(Boolean).join(' ')||'â€”'}</td>
    <td><button class="btn-red btn-sm" onclick="deleteEntry(${e.id})">Delete</button></td>
  </tr>`).join('');
}

async function deleteEntry(id){
  if(!confirm(`Delete entry #${id}?`))return;
  await fetch(`${SB_URL}/rest/v1/s2s_entries?id=eq.${id}`,{method:'DELETE',headers:HEADERS});
  ALL_ENTRIES=ALL_ENTRIES.filter(e=>e.id!==id);
  renderDataTable();renderOverview();updateDealerStats();
}

function exportAllCSV(){
  if(!ALL_ENTRIES.length){alert('No entries.');return;}
  const keys=Object.keys(ALL_ENTRIES[0]);
  const blob=new Blob([[keys.join(','),...ALL_ENTRIES.map(e=>keys.map(k=>`"${(e[k]??'').toString().replace(/"/g,'""')}"`).join(','))].join('\n')],{type:'text/csv'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`ServiceBridge_AllData_${new Date().toISOString().slice(0,10)}.csv`;a.click();
}

async function confirmDeleteAll(){
  if(!confirm('DELETE ALL entries from ALL dealers? This cannot be undone.'))return;
  const code=prompt('Type CONFIRM:');
  if(code!=='CONFIRM'){alert('Cancelled.');return;}
  await fetch(`${SB_URL}/rest/v1/s2s_entries?id=gte.0`,{method:'DELETE',headers:HEADERS});
  ALL_ENTRIES=[];renderDataTable();renderOverview();updateDealerStats();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DEALERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openAddDealer(){document.getElementById('dealer-modal').classList.add('open');}
function addDealer(){
  const name=document.getElementById('new-dealer-name').value.trim();
  if(!name){alert('Enter dealer name.');return;}
  alert(`Dealer "${name}" account created. Next step: clone the form and dashboard HTML, update the dealer_id field, and deploy to a new subdomain under vyaxis.com.`);
  closeModal('dealer-modal');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showTab(id,el){
  document.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t=>t.classList.remove('active'));
  document.getElementById('tab-'+id).classList.add('active');
  el.classList.add('active');
}
function closeModal(id){document.getElementById(id).classList.remove('open');}
function showAlert(id,msg,success){
  const el=document.getElementById('alert-'+id);
  el.className=`alert ${success?'alert-success':'alert-error'} show`;
  el.textContent=msg;
  setTimeout(()=>el.classList.remove('show'),4000);
}

// Close modals on overlay click
document.querySelectorAll('.modal-overlay').forEach(m=>m.addEventListener('click',e=>{if(e.target===m)m.classList.remove('open');}));

const ADMIN_SB_URL = 'https://jbkgwtohwsbaorhvuuqb.supabase.co';
const ADMIN_SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impia2d3dG9od3NiYW9yaHZ1dXFiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5NjkwNDIsImV4cCI6MjA4NzU0NTA0Mn0.GRXOYbIuVDxU9-FEBYmyd1QmytVUrMIAxbnOSfepzuU';
const ADMIN_H = {'apikey':ADMIN_SB_KEY,'Authorization':'Bearer '+ADMIN_SB_KEY,'Content-Type':'application/json'};

function toCSVAdmin(rows, headers) {
  const escape = v => { if (v == null) return ''; const s = String(v).replace(/"/g,'""'); return s.includes(',') || s.includes('"') || s.includes('\n') ? `"${s}"` : s; };
  return [headers.join(','), ...rows.map(r => headers.map(h => escape(r[h])).join(','))].join('\n');
}
function downloadCSVAdmin(csv, filename) {
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename; a.click();
  URL.revokeObjectURL(url);
}

async function adminExportS2SCSV() {
  const res = await fetch(`${ADMIN_SB_URL}/rest/v1/s2s_entries?select=*&order=id.desc&limit=2000`, {headers: ADMIN_H});
  const data = await res.json();
  if (!data.length) return alert('No S2S entries found.');
  const headers = ['id','submitter','first_name','last_name','phone','email','veh_year','veh_make','veh_model','repair_cost','eng_score','outcome','followup_status','manager_outcome','manager_claimed_by','manager_notes','notes','created_at'];
  downloadCSVAdmin(toCSVAdmin(data, headers), `s2s-entries-${new Date().toISOString().slice(0,10)}.csv`);
}


async function adminExportS2SPDF() {
  const res = await fetch(`${ADMIN_SB_URL}/rest/v1/s2s_entries?select=*&order=id.desc&limit=2000`, {headers: ADMIN_H});
  const data = await res.json();
  if (!data.length) return alert('No entries found.');
  const date = new Date().toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
  const rows = data.map(e => `<tr><td>${e.submitter||'â€”'}</td><td>${e.first_name||''} ${e.last_name||''}</td><td>${e.phone||'â€”'}</td><td>${e.veh_year||''} ${e.veh_make||''} ${e.veh_model||''}</td><td>${e.repair_cost?'$'+e.repair_cost:'â€”'}</td><td style="text-align:center;font-weight:700;">${e.eng_score||'â€”'}</td><td>${e.outcome||'â€”'}</td><td>${e.followup_status||'Pending'}</td><td>${e.created_at?new Date(e.created_at).toLocaleString('en-US',{month:'short',day:'numeric',hour:'numeric',minute:'2-digit'}):'â€”'}</td></tr>`).join('');
  const html = `<!DOCTYPE html><html><head><title>S2S Export</title><style>body{font-family:Arial,sans-serif;font-size:11px;padding:24px;}h1{font-size:18px;margin-bottom:4px;}.sub{color:#666;font-size:12px;margin-bottom:16px;}table{width:100%;border-collapse:collapse;}th{background:#1a1a2e;color:#fff;padding:8px 10px;text-align:left;font-size:10px;text-transform:uppercase;letter-spacing:0.08em;}td{padding:7px 10px;border-bottom:1px solid #eee;}tr:nth-child(even) td{background:#f9f9f9;}@media print{body{padding:0;}}</style></head><body><h1>ServiceBridge â€” S2S Entries</h1><div class="sub">Gallatin CDJR Â· Exported ${date} Â· ${data.length} entries</div><table><thead><tr><th>Rep</th><th>Customer</th><th>Phone</th><th>Vehicle</th><th>Repair $</th><th>Temp</th><th>Outcome</th><th>Follow-Up</th><th>Date</th></tr></thead><tbody>${rows}</tbody></table></body></html>`;
  const w = window.open('','_blank'); w.document.write(html); w.document.close(); setTimeout(()=>w.print(),500);
}


</script>
</body>
</html>
