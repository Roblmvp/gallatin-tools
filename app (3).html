<!DOCTYPE html>
<html lang="en">
<head>
  <script>
(function(){
  var rep = null;
  try { rep = JSON.parse(sessionStorage.getItem('sb_rep') || 'null'); } catch(e) {}
  if (!rep || !rep.name || !rep.role) { window.location.replace('/login.html'); }
})();
</script>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="ServiceBridge">
<meta name="theme-color" content="#080B14">
<title>ServiceBridge</title>
<link rel="manifest" href="/manifest.json">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=DM+Serif+Display:ital@0;1&display=swap" rel="stylesheet">
<style>
  :root {
    --ink: #080B14; --ink2: #0F1628; --ink3: #182040;
    --red: #C8102E; --gold: #C49A2A; --green: #22C55E; --blue: #6366F1;
    --text: #FFFFFF; --muted: rgba(255,255,255,0.45); --muted2: rgba(255,255,255,0.22);
    --border: rgba(255,255,255,0.08); --border2: rgba(255,255,255,0.14);
    --card: rgba(255,255,255,0.04); --card2: rgba(255,255,255,0.07);
    --r: 16px; --rsm: 10px;
  }
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
  html, body { height: 100%; background: var(--ink); color: var(--text); font-family: 'DM Sans', sans-serif; overflow: hidden; }
  .screen { position: fixed; inset: 0; display: flex; flex-direction: column; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; overflow-y: auto; -webkit-overflow-scrolling: touch; }
  .screen.active { opacity: 1; pointer-events: all; }
  .bg-grid { position: fixed; inset: 0; background-image: linear-gradient(rgba(255,255,255,0.025) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.025) 1px, transparent 1px); background-size: 40px 40px; pointer-events: none; z-index: 0; }
  .bg-glow { position: fixed; width: 600px; height: 600px; border-radius: 50%; filter: blur(120px); pointer-events: none; z-index: 0; }
  .bg-glow-red  { background: radial-gradient(circle, rgba(200,16,46,0.12) 0%, transparent 70%); top: -200px; left: -100px; }
  .bg-glow-blue { background: radial-gradient(circle, rgba(99,102,241,0.08) 0%, transparent 70%); bottom: -200px; right: -100px; }
  .nav-bar { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(8,11,20,0.95); border-top: 1px solid var(--border); padding: 12px 0 max(12px, env(safe-area-inset-bottom)); display: none; justify-content: space-around; align-items: center; z-index: 100; backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); }
  .nav-bar.visible { display: flex; }
  .nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; cursor: pointer; padding: 6px 16px; border-radius: 12px; transition: all 0.15s; min-width: 60px; }
  .nav-item.active .nav-icon { color: var(--red); }
  .nav-item.active .nav-label { color: var(--text); }
  .nav-icon  { font-size: 20px; color: var(--muted); transition: color 0.15s; line-height: 1; }
  .nav-label { font-size: 10px; font-weight: 600; letter-spacing: 0.04em; color: var(--muted); transition: color 0.15s; }
  .app-header { display: flex; align-items: center; justify-content: space-between; padding: 16px 20px 12px; padding-top: max(16px, env(safe-area-inset-top)); border-bottom: 1px solid var(--border); background: rgba(8,11,20,0.9); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); position: sticky; top: 0; z-index: 50; }
  .header-left  { display: flex; align-items: center; gap: 10px; }
  .header-logo  { width: 32px; height: 32px; background: var(--red); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 14px; }
  .header-title { font-family: 'DM Serif Display', serif; font-size: 17px; letter-spacing: -0.01em; }
  .header-right { display: flex; align-items: center; gap: 10px; position: relative; }
  .header-user  { font-size: 11px; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: 0.08em; }
  .header-logout { width: 32px; height: 32px; border-radius: 8px; background: var(--card); border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 14px; transition: all 0.15s; }
  .header-logout:active { background: var(--card2); }
  .hamburger { background: none; border: 1px solid var(--border2); border-radius: 8px; width: 32px; height: 32px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; cursor: pointer; transition: all 0.18s; padding: 0; flex-shrink: 0; }
  .hamburger:hover { border-color: rgba(255,255,255,0.25); background: rgba(255,255,255,0.04); }
  .hamburger span { display: block; width: 14px; height: 1.5px; background: rgba(255,255,255,0.7); border-radius: 2px; transition: all 0.2s; }
  .hamburger.open span:nth-child(1) { transform: translateY(5.5px) rotate(45deg); }
  .hamburger.open span:nth-child(2) { opacity: 0; }
  .hamburger.open span:nth-child(3) { transform: translateY(-5.5px) rotate(-45deg); }
  .nav-overlay { position: fixed; inset: 0; z-index: 190; display: none; }
  .nav-overlay.open { display: block; }
  .nav-dropdown { position: absolute; top: calc(100% + 8px); right: 0; background: #0F1628; border: 1px solid var(--border2); border-radius: 14px; min-width: 220px; padding: 6px; box-shadow: 0 20px 60px rgba(0,0,0,0.7); z-index: 201; opacity: 0; transform: translateY(-8px) scale(0.97); pointer-events: none; transition: all 0.18s cubic-bezier(0.16,1,0.3,1); }
  .nav-dropdown.open { opacity: 1; transform: translateY(0) scale(1); pointer-events: all; }
  .dd-item { display: flex; align-items: center; gap: 10px; padding: 11px 14px; border-radius: 9px; font-size: 13px; font-weight: 600; color: var(--muted); text-decoration: none; cursor: pointer; transition: all 0.15s; }
  .dd-item:hover { background: rgba(255,255,255,0.05); color: var(--text); }
  .dd-item.active-page { background: rgba(200,16,46,0.12); color: #FC8181; }
  .dd-icon { font-size: 15px; width: 20px; text-align: center; }
  .dd-divider { height: 1px; background: var(--border); margin: 4px 0; }
  .dd-admin { display: none; }
  .dd-admin.show { display: flex; }
  .dd-divider.dd-admin.show { display: block; }
  .nav-user-info { display: flex; align-items: center; justify-content: space-between; padding: 8px 14px 4px; }
  .nav-user-display { font-size: 11px; font-weight: 600; color: var(--muted); letter-spacing: 0.06em; }
  .nav-role-pill { font-size: 9px; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; padding: 3px 8px; border-radius: 20px; }
  .role-admin { background: rgba(99,102,241,0.2); color: #818CF8; border: 1px solid rgba(99,102,241,0.3); }
  .role-manager { background: rgba(196,154,42,0.15); color: var(--gold); border: 1px solid rgba(196,154,42,0.25); }
  .role-sales { background: rgba(255,255,255,0.08); color: rgba(255,255,255,0.6); border: 1px solid rgba(255,255,255,0.15); }
  .home-content { padding: 20px 20px 100px; flex: 1; position: relative; z-index: 1; }
  .home-greeting { margin-bottom: 28px; }
  .home-greeting-sub  { font-size: 12px; font-weight: 600; letter-spacing: 0.12em; text-transform: uppercase; color: var(--muted); margin-bottom: 4px; }
  .home-greeting-name { font-family: 'DM Serif Display', serif; font-size: 30px; letter-spacing: -0.02em; line-height: 1.1; }
  .cta-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
  .cta-card { background: var(--ink2); border: 1px solid var(--border); border-radius: var(--r); padding: 20px 18px; cursor: pointer; transition: all 0.2s; text-decoration: none; display: flex; flex-direction: column; gap: 12px; position: relative; overflow: hidden; }
  .cta-card::before { content: ''; position: absolute; inset: 0; opacity: 0; transition: opacity 0.2s; }
  .cta-card:active { transform: scale(0.97); }
  .cta-card:active::before { opacity: 1; }
  .cta-card.red::before    { background: rgba(200,16,46,0.08); }
  .cta-card.gold::before   { background: rgba(196,154,42,0.08); }
  .cta-card.blue::before   { background: rgba(99,102,241,0.08); }
  .cta-card.green::before  { background: rgba(34,197,94,0.08); }
  .cta-card.purple::before { background: rgba(168,85,247,0.08); }
  .cta-card.teal::before   { background: rgba(20,184,166,0.08); }
  .cta-icon { width: 44px; height: 44px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
  .cta-icon.red    { background: rgba(200,16,46,0.15); }
  .cta-icon.gold   { background: rgba(196,154,42,0.15); }
  .cta-icon.blue   { background: rgba(99,102,241,0.15); }
  .cta-icon.green  { background: rgba(34,197,94,0.15); }
  .cta-icon.purple { background: rgba(168,85,247,0.15); }
  .cta-icon.teal   { background: rgba(20,184,166,0.15); }
  .cta-label { font-size: 13px; font-weight: 700; color: var(--text); line-height: 1.2; }
  .cta-sub   { font-size: 11px; color: var(--muted); margin-top: 2px; }
  .cta-card.wide { grid-column: 1 / -1; flex-direction: row; align-items: center; padding: 18px 20px; gap: 16px; }
  .cta-card.wide .cta-text { flex: 1; }
  .cta-arrow { font-size: 16px; color: var(--muted); }
  #screen-admin .home-content { padding-top: 0; }
  .admin-section { margin-bottom: 28px; }
  .admin-section-title { font-size: 10px; font-weight: 700; letter-spacing: 0.14em; text-transform: uppercase; color: var(--muted); margin-bottom: 12px; padding: 0 2px; }
  .user-row { background: var(--ink2); border: 1px solid var(--border); border-radius: 14px; padding: 14px 16px; display: flex; align-items: center; gap: 14px; margin-bottom: 8px; }
  .user-avatar { width: 40px; height: 40px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: 700; flex-shrink: 0; font-family: 'DM Serif Display', serif; }
  .user-avatar.sales   { background: rgba(200,16,46,0.15); color: var(--red); }
  .user-avatar.manager { background: rgba(196,154,42,0.15); color: var(--gold); }
  .user-avatar.admin   { background: rgba(99,102,241,0.15); color: var(--blue); }
  .user-info { flex: 1; min-width: 0; }
  .user-name { font-size: 14px; font-weight: 700; }
  .user-meta { font-size: 11px; color: var(--muted); margin-top: 2px; }
  .user-controls { display: flex; align-items: center; gap: 8px; }
  .toggle-switch { width: 44px; height: 24px; border-radius: 12px; background: var(--border); position: relative; cursor: pointer; transition: background 0.2s; flex-shrink: 0; border: none; }
  .toggle-switch.on { background: var(--green); }
  .toggle-switch::after { content: ''; position: absolute; top: 3px; left: 3px; width: 18px; height: 18px; border-radius: 50%; background: white; transition: transform 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
  .toggle-switch.on::after { transform: translateX(20px); }
  .role-badge { font-size: 10px; font-weight: 700; letter-spacing: 0.08em; text-transform: uppercase; padding: 3px 8px; border-radius: 6px; }
  .role-badge.sales   { background: rgba(200,16,46,0.15); color: var(--red); }
  .role-badge.manager { background: rgba(196,154,42,0.15); color: var(--gold); }
  .role-badge.admin   { background: rgba(99,102,241,0.15); color: var(--blue); }
  .log-item { display: flex; align-items: center; gap: 12px; padding: 12px 0; border-bottom: 1px solid var(--border); }
  .log-item:last-child { border-bottom: none; }
  .log-dot  { width: 8px; height: 8px; border-radius: 50%; background: var(--green); flex-shrink: 0; }
  .log-info { flex: 1; }
  .log-name { font-size: 13px; font-weight: 600; }
  .log-time { font-size: 11px; color: var(--muted); margin-top: 2px; }
  .stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 24px; }
  .stat-card { background: var(--ink2); border: 1px solid var(--border); border-radius: 14px; padding: 14px 12px; text-align: center; }
  .stat-val { font-family: 'DM Serif Display', serif; font-size: 24px; color: var(--text); line-height: 1; margin-bottom: 4px; }
  .stat-lbl { font-size: 10px; font-weight: 600; color: var(--muted); letter-spacing: 0.06em; text-transform: uppercase; }
  .toast { position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%) translateY(20px); background: var(--ink3); border: 1px solid var(--border2); border-radius: 12px; padding: 12px 20px; font-size: 13px; font-weight: 600; color: var(--text); white-space: nowrap; z-index: 999; opacity: 0; transition: all 0.3s; pointer-events: none; }
  .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
  .safe-bottom { padding-bottom: max(90px, calc(70px + env(safe-area-inset-bottom))); }
  ::-webkit-scrollbar { width: 4px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 2px; }
</style>
</head>
<body>
<div class="bg-grid"></div>
<div class="bg-glow bg-glow-red"></div>
<div class="bg-glow bg-glow-blue"></div>

<!-- HOME SCREEN -->
<div class="screen" id="screen-home">
  <div class="app-header">
    <div class="header-left">
      <div class="header-logo">ğŸ›¡</div>
      <div class="header-title">ServiceBridge</div>
    </div>
    <div class="header-right">
      <span class="header-user" id="header-user-name"></span>
      <div class="header-logout" onclick="logout()" title="Sign Out">â†©</div>
      <button class="hamburger" id="home-hamburger" onclick="toggleAppMenu('home')" aria-label="Menu">
        <span></span><span></span><span></span>
      </button>
      <div class="nav-dropdown" id="home-dropdown">
        <div class="nav-user-info">
          <span class="nav-user-display" id="home-nav-user"></span>
          <span class="nav-role-pill" id="home-nav-pill"></span>
        </div>
        <div class="dd-divider"></div>
        <a href="app.html" class="dd-item active-page"><span class="dd-icon">ğŸ </span> Home</a>
        <a href="service-to-sales-log.html" class="dd-item"><span class="dd-icon">ğŸ“‹</span> S2S Entry</a>
        <a href="manager-dashboard.html" class="dd-item"><span class="dd-icon">ğŸ“Š</span> Performance Dashboard</a>
        <a href="scorecards.html" class="dd-item"><span class="dd-icon">ğŸ†</span> Scorecards</a>
        <div class="dd-divider dd-admin" id="home-admin-divider"></div>
        <a href="admin-panel.html" class="dd-item dd-admin" id="home-admin-link"><span class="dd-icon">âš™ï¸</span> Admin Panel</a>
      </div>
    </div>
  </div>
  <div class="home-content safe-bottom" id="home-content"></div>
</div>

<!-- ADMIN SCREEN -->
<div class="screen" id="screen-admin">
  <div class="app-header">
    <div class="header-left">
      <div class="header-logo" style="background:var(--blue)">âš™</div>
      <div class="header-title">Admin Panel</div>
    </div>
    <div class="header-right">
      <div class="header-logout" onclick="showScreen('screen-home')" title="Back">â†</div>
      <div class="header-logout" onclick="logout()" title="Sign Out">â†©</div>
      <button class="hamburger" id="admin-hamburger" onclick="toggleAppMenu('admin')" aria-label="Menu">
        <span></span><span></span><span></span>
      </button>
      <div class="nav-dropdown" id="admin-dropdown">
        <div class="nav-user-info">
          <span class="nav-user-display" id="admin-nav-user"></span>
          <span class="nav-role-pill" id="admin-nav-pill"></span>
        </div>
        <div class="dd-divider"></div>
        <a href="app.html" class="dd-item"><span class="dd-icon">ğŸ </span> Home</a>
        <a href="service-to-sales-log.html" class="dd-item"><span class="dd-icon">ğŸ“‹</span> S2S Entry</a>
        <a href="manager-dashboard.html" class="dd-item"><span class="dd-icon">ğŸ“Š</span> Performance Dashboard</a>
        <a href="scorecards.html" class="dd-item"><span class="dd-icon">ğŸ†</span> Scorecards</a>
        <div class="dd-divider dd-admin show" id="admin-admin-divider"></div>
        <a href="admin-panel.html" class="dd-item dd-admin show" id="admin-admin-link"><span class="dd-icon">âš™ï¸</span> Admin Panel</a>
      </div>
    </div>
  </div>
  <div class="home-content safe-bottom" id="admin-content"></div>
</div>

<div class="nav-bar" id="nav-bar"></div>
<div class="nav-overlay" id="app-nav-overlay" onclick="closeAllMenus()"></div>
<div class="toast" id="app-toast"></div>

<script>
// â”€â”€ Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SUPABASE_URL  = 'https://jbkgwtohwsbaorhvuuqb.supabase.co';
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impia2d3dG9od3NiYW9yaHZ1dXFiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkwNTI0NzksImV4cCI6MjA2NDYyODQ3OX0.a3SZsBz5hm3yBa3PbbTs_-mCAGkHT5KM_r7JRM-JIeQ';

// â”€â”€ Session (read-only from sessionStorage â€” no credentials stored) â”€â”€
let currentUser = null;

function getSession() {
  try {
    const raw = sessionStorage.getItem('sb_rep');
    if (!raw) return null;
    const s = JSON.parse(raw);
    if (s && s.name && s.role) return s;
    return null;
  } catch { return null; }
}

function clearSession() {
  sessionStorage.removeItem('sb_rep');
  sessionStorage.removeItem('sb_session');
}

// â”€â”€ Login log (local analytics â€” no secrets) â”€â”€
function addLoginLog(user) {
  var logs = getLoginLogs();
  logs.unshift({ name: user.name, role: user.role, time: new Date().toISOString() });
  localStorage.setItem('sb_login_log', JSON.stringify(logs.slice(0, 50)));
}
function getLoginLogs() { try { return JSON.parse(localStorage.getItem('sb_login_log') || '[]'); } catch { return []; } }

// â”€â”€ Screen management â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(function(s) { s.classList.remove('active'); s.style.pointerEvents = 'none'; });
  var el = document.getElementById(id);
  if (el) { el.classList.add('active'); el.style.pointerEvents = 'all'; el.scrollTop = 0; }
  document.getElementById('nav-bar').classList.toggle('visible', id === 'screen-home' || id === 'screen-admin');
  updateNav(id);
}

function buildNav() {
  var nav = document.getElementById('nav-bar');
  if (!currentUser) { nav.innerHTML = ''; return; }
  var items = [{ icon: 'ğŸ ', label: 'Home', screen: 'screen-home' }];
  if (currentUser.role === 'admin' || currentUser.role === 'manager') {
    items.push({ icon: 'âš™ï¸', label: 'Admin', screen: 'screen-admin' });
  }
  nav.innerHTML = items.map(function(i) {
    return '<div class="nav-item" onclick="navGo(\'' + i.screen + '\')" data-screen="' + i.screen + '"><div class="nav-icon">' + i.icon + '</div><div class="nav-label">' + i.label + '</div></div>';
  }).join('');
}

function navGo(screen) {
  if (screen === 'screen-admin') buildAdminPanel();
  showScreen(screen);
}

function updateNav(activeScreen) {
  document.querySelectorAll('.nav-item').forEach(function(i) {
    i.classList.toggle('active', i.dataset.screen === activeScreen);
  });
}

// â”€â”€ Hamburger menu â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleAppMenu(which) {
  var hb = document.getElementById(which + '-hamburger');
  var dd = document.getElementById(which + '-dropdown');
  var ov = document.getElementById('app-nav-overlay');
  var isOpen = dd.classList.contains('open');
  closeAllMenus();
  if (!isOpen) { hb.classList.add('open'); dd.classList.add('open'); ov.classList.add('open'); }
}

function closeAllMenus() {
  ['home','admin'].forEach(function(w) {
    var hb = document.getElementById(w + '-hamburger');
    var dd = document.getElementById(w + '-dropdown');
    if (hb) hb.classList.remove('open');
    if (dd) dd.classList.remove('open');
  });
  document.getElementById('app-nav-overlay').classList.remove('open');
}

function initAppNav() {
  if (!currentUser) return;
  var role = currentUser.role;
  var rc = role === 'admin' ? 'role-admin' : role === 'manager' ? 'role-manager' : 'role-sales';
  var rl = role.charAt(0).toUpperCase() + role.slice(1);
  var firstName = currentUser.first_name || currentUser.name.split(' ')[0];

  ['home','admin'].forEach(function(w) {
    var ne = document.getElementById(w + '-nav-user');
    var pe = document.getElementById(w + '-nav-pill');
    if (ne) ne.textContent = firstName;
    if (pe) { pe.textContent = rl; pe.className = 'nav-role-pill ' + rc; }
    if (role === 'admin') {
      var lnk = document.getElementById(w + '-admin-link');
      var div = document.getElementById(w + '-admin-divider');
      if (lnk) lnk.classList.add('show');
      if (div) div.classList.add('show');
    }
  });
}

// â”€â”€ Build home screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildHome() {
  var firstName = currentUser.first_name || currentUser.name.split(' ')[0];
  document.getElementById('header-user-name').textContent = firstName;
  var hour = new Date().getHours();
  var greet = hour < 12 ? 'Good morning' : hour < 17 ? 'Good afternoon' : 'Good evening';
  var cards = '';
  var role = currentUser.role;

  if (role === 'sales') {
    cards = '<div class="cta-grid">' +
      '<div class="cta-card red" onclick="goTo(\'service-to-sales-log.html\')"><div class="cta-icon red">ğŸ“‹</div><div><div class="cta-label">S2S Entry</div><div class="cta-sub">Log a lead</div></div></div>' +
      '<div class="cta-card blue" onclick="goTo(\'scorecards.html\')"><div class="cta-icon blue">ğŸ†</div><div><div class="cta-label">Scoreboard</div><div class="cta-sub">Team standings</div></div></div>' +
      '</div>' +
      '<div class="cta-card wide green" onclick="goTo(\'manager-dashboard.html\')"><div class="cta-icon green">ğŸ“Š</div><div class="cta-text"><div class="cta-label">View Dashboard</div><div class="cta-sub">All entries & analytics</div></div><div class="cta-arrow">â†’</div></div>';
  }
  if (role === 'manager') {
    cards = '<div class="cta-grid">' +
      '<div class="cta-card gold" onclick="goTo(\'manager-dashboard.html\')"><div class="cta-icon gold">ğŸ“Š</div><div><div class="cta-label">Dashboard</div><div class="cta-sub">All entries</div></div></div>' +
      '<div class="cta-card blue" onclick="goTo(\'scorecards.html\')"><div class="cta-icon blue">ğŸ†</div><div><div class="cta-label">Scoreboard</div><div class="cta-sub">Leaderboard</div></div></div>' +
      '<div class="cta-card red" onclick="goTo(\'service-to-sales-log.html\')"><div class="cta-icon red">ğŸ“‹</div><div><div class="cta-label">S2S Entry</div><div class="cta-sub">Log a lead</div></div></div>' +
      '<div class="cta-card teal" onclick="goTo(\'upboard.html\')"><div class="cta-icon teal">ğŸ”„</div><div><div class="cta-label">UP Board</div><div class="cta-sub">Floor rotation</div></div></div>' +
      '</div>' +
      '<div class="cta-card wide purple" onclick="navGo(\'screen-admin\')"><div class="cta-icon purple">âš™ï¸</div><div class="cta-text"><div class="cta-label">Admin Panel</div><div class="cta-sub">Manage users & access</div></div><div class="cta-arrow">â†’</div></div>';
  }
  if (role === 'admin') {
    cards = '<div class="cta-grid">' +
      '<div class="cta-card gold" onclick="goTo(\'manager-dashboard.html\')"><div class="cta-icon gold">ğŸ“Š</div><div><div class="cta-label">Dashboard</div><div class="cta-sub">All entries</div></div></div>' +
      '<div class="cta-card blue" onclick="goTo(\'scorecards.html\')"><div class="cta-icon blue">ğŸ†</div><div><div class="cta-label">Scoreboard</div><div class="cta-sub">Leaderboard</div></div></div>' +
      '<div class="cta-card red" onclick="goTo(\'service-to-sales-log.html\')"><div class="cta-icon red">ğŸ“‹</div><div><div class="cta-label">S2S Entry</div><div class="cta-sub">Log a lead</div></div></div>' +
      '<div class="cta-card teal" onclick="goTo(\'upboard.html\')"><div class="cta-icon teal">ğŸ”„</div><div><div class="cta-label">UP Board</div><div class="cta-sub">Floor rotation</div></div></div>' +
      '</div>' +
      '<div class="cta-card wide purple" onclick="goTo(\'admin-panel.html\')"><div class="cta-icon purple">âš™ï¸</div><div class="cta-text"><div class="cta-label">Admin Console</div><div class="cta-sub">Users, data & email settings</div></div><div class="cta-arrow">â†’</div></div>';
  }

  document.getElementById('home-content').innerHTML =
    '<div class="home-greeting"><div class="home-greeting-sub">' + greet + '</div><div class="home-greeting-name">' + firstName + '.</div></div>' +
    cards +
    '<div style="margin-top:12px;"><button id="notif-toggle-btn" onclick="toggleNotifications()" style="background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px 24px;font-size:13px;font-weight:600;color:var(--muted);cursor:pointer;font-family:\'DM Sans\',sans-serif;width:100%;transition:all 0.18s;">ğŸ”• Enable Notifications</button></div>';
  initNotifButton();
}

function goTo(url) { window.location.href = url; }

// â”€â”€ Admin panel (fetches user list from Supabase) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function buildAdminPanel() {
  var container = document.getElementById('admin-content');
  container.innerHTML = '<div style="text-align:center;padding:40px 0;color:var(--muted);font-size:13px;">Loading usersâ€¦</div>';

  var users = [];
  try {
    var res = await fetch(
      SUPABASE_URL + '/rest/v1/sb_users?select=id,name,first_name,role,active,last_login&order=role.asc,name.asc',
      {
        headers: {
          'apikey': SUPABASE_ANON,
          'Authorization': 'Bearer ' + SUPABASE_ANON,
        }
      }
    );
    if (res.ok) users = await res.json();
  } catch (e) {
    console.warn('Failed to load users for admin panel:', e);
  }

  var logs = getLoginLogs();
  var todayLogs = logs.filter(function(l) { return new Date(l.time).toDateString() === new Date().toDateString(); });
  var activeCount = users.filter(function(u) { return u.active; }).length;

  var userRows = '';
  if (users.length > 0) {
    userRows = users.map(function(u) {
      var initial = u.first_name ? u.first_name[0] : u.name[0];
      var lastLogin = u.last_login ? new Date(u.last_login).toLocaleString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' }) : 'Never';
      return '<div class="user-row">' +
        '<div class="user-avatar ' + u.role + '">' + initial + '</div>' +
        '<div class="user-info"><div class="user-name">' + u.name + '</div>' +
        '<div class="user-meta"><span class="role-badge ' + u.role + '">' + u.role + '</span>&nbsp;Last: ' + lastLogin + '</div></div>' +
        '<div class="user-controls"><div class="role-badge ' + (u.active ? 'sales' : '') + '" style="' + (u.active ? 'background:rgba(34,197,94,0.15);color:var(--green)' : 'background:rgba(255,255,255,0.05);color:var(--muted)') + '">' + (u.active ? 'Active' : 'Inactive') + '</div></div></div>';
    }).join('');
  } else {
    userRows = '<p style="color:var(--muted);font-size:13px;padding:12px 0;">Could not load user data. Check connection.</p>';
  }

  var logItems = logs.length === 0 ? '<p style="color:var(--muted);font-size:13px;padding:12px 0;">No login activity yet.</p>'
    : logs.slice(0, 15).map(function(l) {
        var d = new Date(l.time);
        var ts = d.toLocaleString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' });
        return '<div class="log-item"><div class="log-dot" style="background:' + (l.role === 'admin' ? 'var(--blue)' : l.role === 'manager' ? 'var(--gold)' : 'var(--green)') + '"></div><div class="log-info"><div class="log-name">' + l.name + '</div><div class="log-time">' + ts + '</div></div><span class="role-badge ' + l.role + '">' + l.role + '</span></div>';
      }).join('');

  container.innerHTML =
    '<div class="stat-grid" style="margin-top:20px;">' +
    '<div class="stat-card"><div class="stat-val">' + users.length + '</div><div class="stat-lbl">Users</div></div>' +
    '<div class="stat-card"><div class="stat-val">' + activeCount + '</div><div class="stat-lbl">Active</div></div>' +
    '<div class="stat-card"><div class="stat-val">' + todayLogs.length + '</div><div class="stat-lbl">Logins Today</div></div>' +
    '</div>' +
    '<div class="admin-section"><div class="admin-section-title">User Access</div>' + userRows + '</div>' +
    '<div class="admin-section"><div class="admin-section-title">Recent Login Activity</div><div style="background:var(--ink2);border:1px solid var(--border);border-radius:14px;padding:4px 16px;">' + logItems + '</div></div>' +
    '<div class="admin-section"><div class="admin-section-title">Quick Actions</div>' +
    '<div class="cta-card wide red" onclick="clearLoginLog()" style="margin-bottom:10px;"><div class="cta-icon red">ğŸ—‘</div><div class="cta-text"><div class="cta-label">Clear Login Log</div><div class="cta-sub">Remove all login history</div></div></div>' +
    '<div class="cta-card wide gold" onclick="goTo(\'admin-panel.html\')"><div class="cta-icon gold">âš™ï¸</div><div class="cta-text"><div class="cta-label">Full Admin Console</div><div class="cta-sub">Email, data & dealer settings</div></div><div class="cta-arrow">â†’</div></div>' +
    '</div>';
}

function clearLoginLog() {
  if (!confirm('Clear all login history?')) return;
  localStorage.removeItem('sb_login_log');
  buildAdminPanel();
  showToast('Login log cleared');
}

function logout() {
  currentUser = null;
  clearSession();
  unsubscribeFromPush();
  document.getElementById('nav-bar').classList.remove('visible');
  window.location.replace('/login.html');
}

function showToast(msg) {
  var t = document.getElementById('app-toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(function() { t.classList.remove('show'); }, 2500);
}

// â”€â”€ Push notifications â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var VAPID_PUBLIC_KEY = 'BFYqM0IN3sQtNJiq1iTFIh1Ex3LCEboUq7hB966WA5UT_Z5_q58_VPbuIUY__m36IyinsOTKlTHhg-PG5JN-JU4';
function urlBase64ToUint8Array(b) { var p = '='.repeat((4 - b.length % 4) % 4); var d = (b + p).replace(/-/g, '+').replace(/_/g, '/'); return Uint8Array.from([].slice.call(atob(d)).map(function(c) { return c.charCodeAt(0); })); }

async function subscribeToPush(user) {
  if (!('Notification' in window) || !('serviceWorker' in navigator)) return;
  if (Notification.permission === 'denied') return;
  try {
    var reg = await navigator.serviceWorker.ready;
    var sub = await reg.pushManager.getSubscription();
    if (!sub) {
      var perm = await Notification.requestPermission();
      if (perm !== 'granted') return;
      sub = await reg.pushManager.subscribe({ userVisibleOnly: true, applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY) });
    }
    await fetch('/api/save-subscription', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ subscription: sub.toJSON(), user_id: user.id || '', user_name: user.name, user_role: user.role })
    });
  } catch (e) { console.warn('Push failed:', e); }
}

async function unsubscribeFromPush() {
  try {
    var reg = await navigator.serviceWorker.ready;
    var sub = await reg.pushManager.getSubscription();
    if (sub) {
      await fetch('/api/save-subscription', { method: 'DELETE', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ endpoint: sub.endpoint }) });
      await sub.unsubscribe();
    }
  } catch (e) {}
}

async function toggleNotifications() {
  try {
    var reg = await navigator.serviceWorker.ready;
    var sub = await reg.pushManager.getSubscription();
    if (sub) { await unsubscribeFromPush(); updateNotifButton(false); }
    else { await subscribeToPush(currentUser); updateNotifButton(true); }
  } catch (e) { showToast('Notifications not available'); }
}

async function checkNotifStatus() {
  if (!('PushManager' in window)) return false;
  try { var reg = await navigator.serviceWorker.ready; return !!(await reg.pushManager.getSubscription()); }
  catch (e) { return false; }
}

function updateNotifButton(enabled) {
  var btn = document.getElementById('notif-toggle-btn');
  if (!btn) return;
  btn.textContent = enabled ? 'ğŸ”” Notifications On' : 'ğŸ”• Enable Notifications';
  btn.style.borderColor = enabled ? 'rgba(34,197,94,0.4)' : 'var(--border)';
  btn.style.color = enabled ? 'var(--green)' : 'var(--muted)';
  btn.style.background = enabled ? 'rgba(34,197,94,0.08)' : 'var(--card)';
}

async function initNotifButton() { updateNotifButton(await checkNotifStatus()); }

if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() { navigator.serviceWorker.register('/sw.js').catch(function() {}); });
}

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function init() {
  currentUser = getSession();
  if (!currentUser) {
    window.location.replace('/login.html');
    return;
  }
  addLoginLog(currentUser);
  buildHome();
  buildNav();
  initAppNav();
  showScreen('screen-home');
  subscribeToPush(currentUser);
}

init();
</script>
</body>
</html>
