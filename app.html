<!DOCTYPE html>
<html lang="en">
<head>
  <!-- â•â• SUPABASE AUTH â•â• -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script src="/auth-guard.js"></script>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="ServiceBridge">
<meta name="theme-color" content="#080B14">
<title>ServiceBridge</title>
<link rel="manifest" href="/manifest.json">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=DM+Serif+Display:ital@0;1&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --ink: #080B14; --ink2: #0F1628; --ink3: #182040;
    --red: #C8102E; --gold: #C49A2A; --green: #22C55E; --blue: #6366F1;
    --text: #FFFFFF; --muted: rgba(255,255,255,0.45); --muted2: rgba(255,255,255,0.22);
    --border: rgba(255,255,255,0.08); --border2: rgba(255,255,255,0.14);
    --card: rgba(255,255,255,0.04); --card2: rgba(255,255,255,0.07);
    --r: 16px; --rsm: 10px;
  }
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
  html, body { height: 100%; background: var(--ink); color: var(--text); font-family: 'DM Sans', sans-serif; overflow: hidden; }
  .screen { position: fixed; inset: 0; display: flex; flex-direction: column; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; overflow-y: auto; -webkit-overflow-scrolling: touch; }
  .screen.active { opacity: 1; pointer-events: all; }

  /* â”€â”€ ATMOSPHERIC BG â”€â”€ */
  .bg-grid { position: fixed; inset: 0; background-image: linear-gradient(rgba(255,255,255,0.018) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.018) 1px, transparent 1px); background-size: 48px 48px; pointer-events: none; z-index: 0; }
  .bg-glow { position: fixed; border-radius: 50%; filter: blur(100px); pointer-events: none; z-index: 0; opacity: 0; animation: glowIn 1.2s ease forwards; }
  .bg-glow-red  { width: 500px; height: 500px; background: radial-gradient(circle, rgba(200,16,46,0.1) 0%, transparent 70%); top: -180px; left: -80px; animation-delay: 0.2s; }
  .bg-glow-blue { width: 450px; height: 450px; background: radial-gradient(circle, rgba(99,102,241,0.07) 0%, transparent 70%); bottom: -150px; right: -80px; animation-delay: 0.4s; }
  @keyframes glowIn { to { opacity: 1; } }

  /* â”€â”€ NAV BAR (BOTTOM) â”€â”€ */
  .nav-bar { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(8,11,20,0.95); border-top: 1px solid var(--border); padding: 12px 0 max(12px, env(safe-area-inset-bottom)); display: none; justify-content: space-around; align-items: center; z-index: 100; backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); }
  .nav-bar.visible { display: flex; }
  .nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; cursor: pointer; padding: 6px 16px; border-radius: 12px; transition: all 0.15s; min-width: 60px; }
  .nav-item.active .nav-icon { color: var(--red); }
  .nav-item.active .nav-label { color: var(--text); }
  .nav-icon  { font-size: 20px; color: var(--muted); transition: color 0.15s; line-height: 1; }
  .nav-label { font-size: 10px; font-weight: 600; letter-spacing: 0.04em; color: var(--muted); transition: color 0.15s; }

  /* â”€â”€ HEADER â”€â”€ */
  .app-header { display: flex; align-items: center; justify-content: space-between; padding: 16px 20px 12px; padding-top: max(16px, env(safe-area-inset-top)); border-bottom: 1px solid var(--border); background: rgba(8,11,20,0.9); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); position: sticky; top: 0; z-index: 50; }
  .header-left  { display: flex; align-items: center; gap: 10px; }
  .header-logo  { width: 32px; height: 32px; background: var(--red); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 14px; }
  .header-title { font-family: 'DM Serif Display', serif; font-size: 17px; letter-spacing: -0.01em; }
  .header-right { display: flex; align-items: center; gap: 10px; position: relative; }
  .header-user  { font-size: 11px; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: 0.08em; }
  .header-logout { width: 32px; height: 32px; border-radius: 8px; background: var(--card); border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 14px; transition: all 0.15s; }
  .header-logout:active { background: var(--card2); }

  /* â”€â”€ HAMBURGER â”€â”€ */
  .hamburger { background: none; border: 1px solid var(--border2); border-radius: 8px; width: 32px; height: 32px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; cursor: pointer; transition: all 0.18s; padding: 0; flex-shrink: 0; }
  .hamburger:hover { border-color: rgba(255,255,255,0.25); background: rgba(255,255,255,0.04); }
  .hamburger span { display: block; width: 14px; height: 1.5px; background: rgba(255,255,255,0.7); border-radius: 2px; transition: all 0.2s; }
  .hamburger.open span:nth-child(1) { transform: translateY(5.5px) rotate(45deg); }
  .hamburger.open span:nth-child(2) { opacity: 0; }
  .hamburger.open span:nth-child(3) { transform: translateY(-5.5px) rotate(-45deg); }

  /* â”€â”€ OVERLAY + DROPDOWN â”€â”€ */
  .nav-overlay { position: fixed; inset: 0; z-index: 190; display: none; }
  .nav-overlay.open { display: block; }
  .nav-dropdown { position: absolute; top: calc(100% + 8px); right: 0; background: #0F1628; border: 1px solid var(--border2); border-radius: 14px; min-width: 220px; padding: 6px; box-shadow: 0 20px 60px rgba(0,0,0,0.7); z-index: 201; opacity: 0; transform: translateY(-8px) scale(0.97); pointer-events: none; transition: all 0.18s cubic-bezier(0.16,1,0.3,1); }
  .nav-dropdown.open { opacity: 1; transform: translateY(0) scale(1); pointer-events: all; }
  .dd-item { display: flex; align-items: center; gap: 10px; padding: 11px 14px; border-radius: 9px; font-size: 13px; font-weight: 600; color: var(--muted); text-decoration: none; cursor: pointer; transition: all 0.15s; }
  .dd-item:hover { background: rgba(255,255,255,0.05); color: var(--text); }
  .dd-item.active-page { background: rgba(200,16,46,0.12); color: #FC8181; }
  .dd-icon { font-size: 15px; width: 20px; text-align: center; }
  .dd-divider { height: 1px; background: var(--border); margin: 4px 0; }
  .dd-admin { display: none; }
  .dd-admin.show { display: flex; }
  .dd-divider.dd-admin.show { display: block; }
  .nav-user-info { display: flex; align-items: center; justify-content: space-between; padding: 8px 14px 4px; }
  .nav-user-display { font-size: 11px; font-weight: 600; color: var(--muted); letter-spacing: 0.06em; }
  .nav-role-pill { font-size: 9px; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; padding: 3px 8px; border-radius: 20px; }
  .role-admin { background: rgba(99,102,241,0.2); color: #818CF8; border: 1px solid rgba(99,102,241,0.3); }
  .role-manager { background: rgba(196,154,42,0.15); color: var(--gold); border: 1px solid rgba(196,154,42,0.25); }
  .role-sales { background: rgba(255,255,255,0.08); color: rgba(255,255,255,0.6); border: 1px solid rgba(255,255,255,0.15); }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     HOME BODY â€” REDESIGNED
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .home-content { padding: 0 20px 120px; flex: 1; position: relative; z-index: 1; }

  /* â”€â”€ HERO GREETING â”€â”€ */
  .hero {
    padding: 32px 0 28px;
    position: relative;
  }
  .hero-eyebrow {
    font-size: 10px; font-weight: 700; letter-spacing: 0.18em; text-transform: uppercase;
    color: var(--red);
    margin-bottom: 8px;
    opacity: 0; animation: fadeUp 0.5s ease forwards 0.1s;
  }
  .hero-name {
    font-family: 'DM Serif Display', serif;
    font-size: 32px; letter-spacing: -0.02em; line-height: 1.1;
    opacity: 0; animation: fadeUp 0.5s ease forwards 0.2s;
  }
  .hero-sub {
    font-size: 13px; color: var(--muted); margin-top: 8px; line-height: 1.5;
    opacity: 0; animation: fadeUp 0.5s ease forwards 0.3s;
  }
  .hero-sub strong { color: rgba(255,255,255,0.7); font-weight: 600; }
  .hero-date {
    display: inline-flex; align-items: center; gap: 6px;
    margin-top: 14px; padding: 6px 14px;
    background: var(--card); border: 1px solid var(--border2); border-radius: 100px;
    font-size: 11px; font-weight: 600; color: var(--muted);
    font-family: 'DM Mono', monospace;
    opacity: 0; animation: fadeUp 0.5s ease forwards 0.4s;
  }
  .hero-date .pulse { width: 6px; height: 6px; border-radius: 50%; background: var(--green); animation: pulse 2s ease infinite; }

  /* â”€â”€ LIVE STATS ROW â”€â”€ */
  .stats-row {
    display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;
    margin-bottom: 24px;
    opacity: 0; animation: fadeUp 0.5s ease forwards 0.45s;
  }
  .stat-tile {
    background: var(--ink2); border: 1px solid var(--border);
    border-radius: 14px; padding: 16px 14px;
    position: relative; overflow: hidden;
    transition: border-color 0.2s, transform 0.2s;
  }
  .stat-tile:active { transform: scale(0.97); }
  .stat-tile::before {
    content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px;
  }
  .stat-tile.s-red::before { background: linear-gradient(90deg, var(--red), rgba(200,16,46,0.3)); }
  .stat-tile.s-green::before { background: linear-gradient(90deg, var(--green), rgba(34,197,94,0.3)); }
  .stat-tile.s-gold::before { background: linear-gradient(90deg, var(--gold), rgba(196,154,42,0.3)); }
  .stat-num {
    font-family: 'DM Mono', monospace; font-size: 24px; font-weight: 700;
    line-height: 1; margin-bottom: 4px;
  }
  .stat-tile.s-red .stat-num { color: #FC8181; }
  .stat-tile.s-green .stat-num { color: #86EFAC; }
  .stat-tile.s-gold .stat-num { color: #FCD34D; }
  .stat-label {
    font-size: 9px; font-weight: 700; letter-spacing: 0.14em; text-transform: uppercase;
    color: var(--muted);
  }

  /* â”€â”€ SECTION TITLES â”€â”€ */
  .section-label {
    font-size: 10px; font-weight: 700; letter-spacing: 0.14em; text-transform: uppercase;
    color: var(--muted); margin-bottom: 12px; padding-left: 2px;
    display: flex; align-items: center; gap: 8px;
  }
  .section-label::after {
    content: ''; flex: 1; height: 1px; background: var(--border);
  }

  /* â”€â”€ NAVIGATION CARDS â”€â”€ */
  .nav-cards {
    display: grid; grid-template-columns: 1fr 1fr; gap: 12px;
    margin-bottom: 24px;
  }
  .nav-card {
    background: var(--ink2); border: 1px solid var(--border);
    border-radius: var(--r); padding: 0; cursor: pointer;
    transition: all 0.25s cubic-bezier(0.16,1,0.3,1);
    text-decoration: none; position: relative; overflow: hidden;
    display: flex; flex-direction: column;
  }
  .nav-card:active { transform: scale(0.96); }
  .nav-card:hover { border-color: var(--border2); }

  .nav-card-top {
    padding: 20px 18px 16px;
    flex: 1;
    position: relative;
  }
  .nav-card-icon {
    width: 42px; height: 42px; border-radius: 12px;
    display: flex; align-items: center; justify-content: center;
    font-size: 18px; margin-bottom: 16px;
    position: relative;
  }
  .nav-card-icon::after {
    content: ''; position: absolute; inset: -4px; border-radius: 16px;
    opacity: 0.15; z-index: -1;
  }
  .nav-card.c-red .nav-card-icon    { background: rgba(200,16,46,0.15); }
  .nav-card.c-red .nav-card-icon::after { background: rgba(200,16,46,0.4); }
  .nav-card.c-gold .nav-card-icon   { background: rgba(196,154,42,0.15); }
  .nav-card.c-gold .nav-card-icon::after { background: rgba(196,154,42,0.4); }
  .nav-card.c-blue .nav-card-icon   { background: rgba(99,102,241,0.15); }
  .nav-card.c-blue .nav-card-icon::after { background: rgba(99,102,241,0.4); }
  .nav-card.c-teal .nav-card-icon   { background: rgba(20,184,166,0.15); }
  .nav-card.c-teal .nav-card-icon::after { background: rgba(20,184,166,0.4); }
  .nav-card.c-green .nav-card-icon  { background: rgba(34,197,94,0.15); }
  .nav-card.c-green .nav-card-icon::after { background: rgba(34,197,94,0.4); }
  .nav-card.c-purple .nav-card-icon { background: rgba(168,85,247,0.15); }
  .nav-card.c-purple .nav-card-icon::after { background: rgba(168,85,247,0.4); }

  .nav-card-label {
    font-size: 14px; font-weight: 700; color: var(--text); line-height: 1.2;
    margin-bottom: 3px;
  }
  .nav-card-desc {
    font-size: 11px; color: var(--muted); line-height: 1.4;
  }
  .nav-card-footer {
    padding: 10px 18px;
    border-top: 1px solid var(--border);
    display: flex; align-items: center; justify-content: space-between;
  }
  .nav-card-stat {
    font-family: 'DM Mono', monospace; font-size: 10px; font-weight: 500; color: var(--muted2);
    letter-spacing: 0.02em;
  }
  .nav-card-arrow {
    font-size: 12px; color: var(--muted2); transition: transform 0.2s, color 0.2s;
  }
  .nav-card:hover .nav-card-arrow { transform: translateX(3px); color: var(--muted); }

  /* Wide full-width card */
  .nav-card.wide {
    grid-column: 1 / -1;
    flex-direction: row;
    align-items: center;
  }
  .nav-card.wide .nav-card-top {
    flex-direction: row; display: flex; align-items: center; gap: 16px;
    padding: 16px 18px;
  }
  .nav-card.wide .nav-card-icon { margin-bottom: 0; }
  .nav-card.wide .nav-card-info { flex: 1; }
  .nav-card.wide .nav-card-footer {
    border-top: none; border-left: 1px solid var(--border);
    padding: 16px 18px;
    flex-direction: column; justify-content: center;
  }

  /* â”€â”€ RECENT ACTIVITY FEED â”€â”€ */
  .activity-feed {
    margin-bottom: 24px;
  }
  .activity-item {
    display: flex; align-items: flex-start; gap: 12px;
    padding: 14px 0;
    border-bottom: 1px solid var(--border);
    opacity: 0; animation: fadeUp 0.4s ease forwards;
  }
  .activity-item:last-child { border-bottom: none; }
  .activity-dot {
    width: 8px; height: 8px; border-radius: 50%; margin-top: 5px; flex-shrink: 0;
  }
  .activity-dot.hot { background: var(--red); box-shadow: 0 0 8px rgba(200,16,46,0.5); }
  .activity-dot.warm { background: var(--gold); }
  .activity-dot.cool { background: var(--muted2); }
  .activity-dot.sold { background: var(--green); box-shadow: 0 0 8px rgba(34,197,94,0.4); }
  .activity-body { flex: 1; min-width: 0; }
  .activity-title {
    font-size: 13px; font-weight: 600; color: rgba(255,255,255,0.85);
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }
  .activity-meta {
    font-size: 11px; color: var(--muted); margin-top: 2px;
    display: flex; align-items: center; gap: 8px; flex-wrap: wrap;
  }
  .activity-tag {
    font-size: 9px; font-weight: 700; letter-spacing: 0.06em; text-transform: uppercase;
    padding: 2px 7px; border-radius: 4px;
  }
  .activity-tag.tag-hot { background: rgba(200,16,46,0.15); color: #FC8181; }
  .activity-tag.tag-sold { background: rgba(34,197,94,0.15); color: #86EFAC; }
  .activity-tag.tag-appt { background: rgba(99,102,241,0.15); color: #A5B4FC; }
  .activity-temp {
    font-family: 'DM Mono', monospace; font-size: 12px; font-weight: 700;
    min-width: 32px; text-align: center;
    padding: 4px 0; border-radius: 6px;
    flex-shrink: 0; align-self: center;
  }
  .activity-temp.t-hot { background: rgba(200,16,46,0.15); color: #FC8181; }
  .activity-temp.t-warm { background: rgba(196,154,42,0.15); color: #FCD34D; }
  .activity-temp.t-cool { background: rgba(255,255,255,0.06); color: var(--muted); }

  .activity-empty {
    text-align: center; padding: 32px 16px; color: var(--muted);
  }
  .activity-empty-icon { font-size: 32px; margin-bottom: 8px; opacity: 0.4; }
  .activity-empty-text { font-size: 13px; font-weight: 500; }

  /* â”€â”€ NOTIFICATIONS SECTION â”€â”€ */
  .notif-section {
    margin-bottom: 20px;
    opacity: 0; animation: fadeUp 0.5s ease forwards 0.7s;
  }
  .notif-card {
    background: var(--card); border: 1px solid var(--border); border-radius: 14px;
    padding: 14px 18px;
    display: flex; align-items: center; justify-content: space-between; gap: 14px;
    cursor: pointer; transition: all 0.2s;
  }
  .notif-card:active { transform: scale(0.97); }
  .notif-card.on { border-color: rgba(34,197,94,0.3); background: rgba(34,197,94,0.06); }
  .notif-left { display: flex; align-items: center; gap: 12px; }
  .notif-icon { font-size: 18px; }
  .notif-text { font-size: 13px; font-weight: 600; color: var(--muted); }
  .notif-card.on .notif-text { color: var(--green); }
  .notif-check {
    width: 24px; height: 24px; border-radius: 50%;
    border: 2px solid var(--border2);
    display: flex; align-items: center; justify-content: center;
    font-size: 12px; color: transparent; transition: all 0.2s;
  }
  .notif-card.on .notif-check {
    background: var(--green); border-color: var(--green); color: #fff;
  }

  /* â”€â”€ ADMIN SCREEN (existing) â”€â”€ */
  #screen-admin .home-content { padding-top: 0; }
  .admin-section { margin-bottom: 28px; }
  .admin-section-title { font-size: 10px; font-weight: 700; letter-spacing: 0.14em; text-transform: uppercase; color: var(--muted); margin-bottom: 12px; padding: 0 2px; }
  .user-row { background: var(--ink2); border: 1px solid var(--border); border-radius: 14px; padding: 14px 16px; display: flex; align-items: center; gap: 14px; margin-bottom: 8px; }
  .user-avatar { width: 40px; height: 40px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: 700; flex-shrink: 0; font-family: 'DM Serif Display', serif; }
  .user-avatar.sales   { background: rgba(200,16,46,0.15); color: var(--red); }
  .user-avatar.manager { background: rgba(196,154,42,0.15); color: var(--gold); }
  .user-avatar.admin   { background: rgba(99,102,241,0.15); color: var(--blue); }
  .user-info { flex: 1; min-width: 0; }
  .user-name { font-size: 14px; font-weight: 700; }
  .user-meta { font-size: 11px; color: var(--muted); margin-top: 2px; }
  .user-controls { display: flex; align-items: center; gap: 8px; }
  .toggle-switch { width: 44px; height: 24px; border-radius: 12px; background: var(--border); position: relative; cursor: pointer; transition: background 0.2s; flex-shrink: 0; border: none; }
  .toggle-switch.on { background: var(--green); }
  .toggle-switch::after { content: ''; position: absolute; top: 3px; left: 3px; width: 18px; height: 18px; border-radius: 50%; background: white; transition: transform 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
  .toggle-switch.on::after { transform: translateX(20px); }
  .role-badge { font-size: 10px; font-weight: 700; letter-spacing: 0.08em; text-transform: uppercase; padding: 3px 8px; border-radius: 6px; }
  .role-badge.sales   { background: rgba(200,16,46,0.15); color: var(--red); }
  .role-badge.manager { background: rgba(196,154,42,0.15); color: var(--gold); }
  .role-badge.admin   { background: rgba(99,102,241,0.15); color: var(--blue); }
  .log-item { display: flex; align-items: center; gap: 12px; padding: 12px 0; border-bottom: 1px solid var(--border); }
  .log-item:last-child { border-bottom: none; }
  .log-dot  { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
  .log-info { flex: 1; }
  .log-name { font-size: 13px; font-weight: 600; }
  .log-time { font-size: 11px; color: var(--muted); margin-top: 2px; }
  .stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 24px; }
  .stat-card { background: var(--ink2); border: 1px solid var(--border); border-radius: 14px; padding: 14px 12px; text-align: center; }
  .stat-val { font-family: 'DM Serif Display', serif; font-size: 24px; color: var(--text); line-height: 1; margin-bottom: 4px; }
  .stat-lbl { font-size: 10px; font-weight: 600; color: var(--muted); letter-spacing: 0.06em; text-transform: uppercase; }

  /* â”€â”€ ANIMATIONS â”€â”€ */
  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(12px); }
    to   { opacity: 1; transform: translateY(0); }
  }
  @keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.5; transform: scale(1.3); }
  }

  /* â”€â”€ TOAST â”€â”€ */
  .toast { position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%) translateY(20px); background: var(--ink3); border: 1px solid var(--border2); border-radius: 12px; padding: 12px 20px; font-size: 13px; font-weight: 600; color: var(--text); white-space: nowrap; z-index: 999; opacity: 0; transition: all 0.3s; pointer-events: none; }
  .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

  .safe-bottom { padding-bottom: max(90px, calc(70px + env(safe-area-inset-bottom))); }
  ::-webkit-scrollbar { width: 4px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 2px; }

  /* â”€â”€ LOADING SKELETON â”€â”€ */
  .skel { background: linear-gradient(90deg, var(--card) 25%, var(--card2) 50%, var(--card) 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: 6px; }
  @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
</style>
</head>
<body>
<div class="bg-grid"></div>
<div class="bg-glow bg-glow-red"></div>
<div class="bg-glow bg-glow-blue"></div>

<!-- HOME SCREEN -->
<div class="screen" id="screen-home">
  <div class="app-header">
    <div class="header-left">
      <div class="header-logo">ğŸ›¡</div>
      <div class="header-title">ServiceBridge</div>
    </div>
    <div class="header-right">
      <span class="header-user" id="header-user-name"></span>
      <div class="header-logout" onclick="logout()" title="Sign Out">â†©</div>
      <button class="hamburger" id="home-hamburger" onclick="toggleAppMenu('home')" aria-label="Menu">
        <span></span><span></span><span></span>
      </button>
      <div class="nav-dropdown" id="home-dropdown">
        <div class="nav-user-info">
          <span class="nav-user-display" id="home-nav-user"></span>
          <span class="nav-role-pill" id="home-nav-pill"></span>
        </div>
        <div class="dd-divider"></div>
        <a href="app.html" class="dd-item active-page"><span class="dd-icon">ğŸ </span> Home</a>
        <a href="service-to-sales-log.html" class="dd-item"><span class="dd-icon">ğŸ“‹</span> S2S Entry</a>
        <a href="manager-dashboard.html" class="dd-item"><span class="dd-icon">ğŸ“Š</span> Performance Dashboard</a>
        <a href="scorecards.html" class="dd-item"><span class="dd-icon">ğŸ†</span> Scorecards</a>
        <div class="dd-divider dd-admin" id="home-admin-divider"></div>
        <a href="admin-panel.html" class="dd-item dd-admin" id="home-admin-link"><span class="dd-icon">âš™ï¸</span> Admin Panel</a>
      </div>
    </div>
  </div>
  <div class="home-content safe-bottom" id="home-content"></div>
</div>

<!-- ADMIN SCREEN -->
<div class="screen" id="screen-admin">
  <div class="app-header">
    <div class="header-left">
      <div class="header-logo" style="background:var(--blue)">âš™</div>
      <div class="header-title">Admin Panel</div>
    </div>
    <div class="header-right">
      <div class="header-logout" onclick="showScreen('screen-home')" title="Back">â†</div>
      <div class="header-logout" onclick="logout()" title="Sign Out">â†©</div>
      <button class="hamburger" id="admin-hamburger" onclick="toggleAppMenu('admin')" aria-label="Menu">
        <span></span><span></span><span></span>
      </button>
      <div class="nav-dropdown" id="admin-dropdown">
        <div class="nav-user-info">
          <span class="nav-user-display" id="admin-nav-user"></span>
          <span class="nav-role-pill" id="admin-nav-pill"></span>
        </div>
        <div class="dd-divider"></div>
        <a href="app.html" class="dd-item"><span class="dd-icon">ğŸ </span> Home</a>
        <a href="service-to-sales-log.html" class="dd-item"><span class="dd-icon">ğŸ“‹</span> S2S Entry</a>
        <a href="manager-dashboard.html" class="dd-item"><span class="dd-icon">ğŸ“Š</span> Performance Dashboard</a>
        <a href="scorecards.html" class="dd-item"><span class="dd-icon">ğŸ†</span> Scorecards</a>
        <div class="dd-divider dd-admin show" id="admin-admin-divider"></div>
        <a href="admin-panel.html" class="dd-item dd-admin show" id="admin-admin-link"><span class="dd-icon">âš™ï¸</span> Admin Panel</a>
      </div>
    </div>
  </div>
  <div class="home-content safe-bottom" id="admin-content"></div>
</div>

<div class="nav-bar" id="nav-bar"></div>
<div class="nav-overlay" id="app-nav-overlay" onclick="closeAllMenus()"></div>
<div class="toast" id="app-toast"></div>

<script>
const SB_URL = 'https://jbkgwtohwsbaorhvuuqb.supabase.co';
const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impia2d3dG9od3NiYW9yaHZ1dXFiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5NjkwNDIsImV4cCI6MjA4NzU0NTA0Mn0.GRXOYbIuVDxU9-FEBYmyd1QmytVUrMIAxbnOSfepzuU';
const SB_HEADERS = {'apikey':SB_KEY,'Authorization':'Bearer '+SB_KEY};
function _authH(){ const t=window.sbSession?.access_token||SB_KEY; return {'apikey':SB_KEY,'Authorization':'Bearer '+t}; }

// USERS removed â€” auth via SB_AUTH + user_profiles table
let currentUser = null;
let homeEntries = [];

function saveSession(user) { sessionStorage.setItem('sb_session', JSON.stringify({ id: user.id, time: Date.now() })); }
function loadSession() {
  try {
    const s = JSON.parse(sessionStorage.getItem('sb_session') || 'null');
    if (!s || Date.now() - s.time > 8*60*60*1000) return null;
    return s || null; // Legacy compat â€” returns raw session object
  } catch { return null; }
}
function clearSession() { sessionStorage.removeItem('sb_session'); sessionStorage.removeItem('sb_rep'); }
function ensureSbRep(user) {
  const roleLabel = user.role === 'admin' ? 'Admin' : user.role === 'manager' ? 'Manager' : 'Sales';
  const initials = user.name.split(' ').map(w=>w[0]).join('').toUpperCase().slice(0,2);
  sessionStorage.setItem('sb_rep', JSON.stringify({name:user.name, role:roleLabel, initials:initials}));
}
function addLoginLog(user) {
  const logs = getLoginLogs();
  logs.unshift({ name: user.name, role: user.role, time: new Date().toISOString(), id: user.id });
  localStorage.setItem('sb_login_log', JSON.stringify(logs.slice(0, 50)));
}
function getLoginLogs() { try { return JSON.parse(localStorage.getItem('sb_login_log') || '[]'); } catch { return []; } }
function getUserActive(id) { const s = localStorage.getItem('sb_active_' + id); return s === null ? true : s === 'true'; }
function setUserActive(id, val) { localStorage.setItem('sb_active_' + id, val); }

// â”€â”€ SCREENS â”€â”€
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => { s.classList.remove('active'); s.style.pointerEvents = 'none'; });
  const el = document.getElementById(id);
  if (el) { el.classList.add('active'); el.style.pointerEvents = 'all'; el.scrollTop = 0; }
  document.getElementById('nav-bar').classList.toggle('visible', id === 'screen-home' || id === 'screen-admin');
  updateNav(id);
}
function buildNav() {
  const nav = document.getElementById('nav-bar');
  if (!currentUser) { nav.innerHTML = ''; return; }
  const items = [{ icon: 'ğŸ ', label: 'Home', screen: 'screen-home' }];
  if (currentUser.role === 'admin' || currentUser.role === 'manager') items.push({ icon: 'âš™ï¸', label: 'Admin', screen: 'screen-admin' });
  nav.innerHTML = items.map(i => `<div class="nav-item" onclick="navGo('${i.screen}')" data-screen="${i.screen}"><div class="nav-icon">${i.icon}</div><div class="nav-label">${i.label}</div></div>`).join('');
}
function navGo(screen) {
  if (screen === 'screen-admin') {
    window.location.href = 'https://servicebridge.vyaxis.com/admin-panel.html';
    return;
  }
  showScreen(screen);
}
function updateNav(activeScreen) { document.querySelectorAll('.nav-item').forEach(i => i.classList.toggle('active', i.dataset.screen === activeScreen)); }

// â”€â”€ HAMBURGER â”€â”€
function toggleAppMenu(which) {
  const hb = document.getElementById(which + '-hamburger');
  const dd = document.getElementById(which + '-dropdown');
  const ov = document.getElementById('app-nav-overlay');
  const isOpen = dd.classList.contains('open');
  closeAllMenus();
  if (!isOpen) { hb.classList.add('open'); dd.classList.add('open'); ov.classList.add('open'); }
}
function closeAllMenus() {
  ['home','admin'].forEach(w => {
    const hb = document.getElementById(w+'-hamburger'); const dd = document.getElementById(w+'-dropdown');
    if (hb) hb.classList.remove('open'); if (dd) dd.classList.remove('open');
  });
  document.getElementById('app-nav-overlay').classList.remove('open');
}
function initAppNav() {
  if (!currentUser) return;
  const role = currentUser.role;
  const rc = role==='admin'?'role-admin':role==='manager'?'role-manager':'role-sales';
  const rl = role.charAt(0).toUpperCase()+role.slice(1);
  ['home','admin'].forEach(w => {
    const ne = document.getElementById(w+'-nav-user'); const pe = document.getElementById(w+'-nav-pill');
    if (ne) ne.textContent = currentUser.first;
    if (pe) { pe.textContent = rl; pe.className = 'nav-role-pill ' + rc; }
    if (role === 'admin') {
      const lnk = document.getElementById(w+'-admin-link'); const div = document.getElementById(w+'-admin-divider');
      if (lnk) lnk.classList.add('show'); if (div) div.classList.add('show');
    }
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BUILD HOME â€” REDESIGNED
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function buildHome() {
  document.getElementById('header-user-name').textContent = currentUser.first;
  const hour = new Date().getHours();
  const greet = hour < 12 ? 'Good morning' : hour < 17 ? 'Good afternoon' : 'Good evening';
  const dateStr = new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
  const role = currentUser.role;
  const isAdmin = role === 'admin';
  const isManager = role === 'manager';

  // Role-specific subtitle
  let roleLine = '';
  if (isAdmin) roleLine = 'Admin overview â€” <strong>Gallatin CDJR</strong>';
  else if (isManager) roleLine = 'S2S Manager â€” <strong>Gallatin CDJR</strong>';
  else roleLine = 'Sales Consultant â€” <strong>Gallatin CDJR</strong>';

  // Show skeleton while loading
  const container = document.getElementById('home-content');
  container.innerHTML = `
    <div class="hero">
      <div class="hero-eyebrow">${greet}</div>
      <div class="hero-name">${currentUser.first}.</div>
      <div class="hero-sub">${roleLine}</div>
      <div class="hero-date"><span class="pulse"></span> ${dateStr}</div>
    </div>
    <div class="stats-row">
      <div class="stat-tile s-red"><div class="stat-num skel" style="width:40px;height:24px;">&nbsp;</div><div class="stat-label">Entries</div></div>
      <div class="stat-tile s-green"><div class="stat-num skel" style="width:40px;height:24px;">&nbsp;</div><div class="stat-label">Sold</div></div>
      <div class="stat-tile s-gold"><div class="stat-num skel" style="width:40px;height:24px;">&nbsp;</div><div class="stat-label">Hot Leads</div></div>
    </div>
    <div class="section-label">Quick Actions</div>
    <div id="home-nav-cards"></div>
    <div class="section-label" id="activity-label" style="display:none;">Recent Activity</div>
    <div class="activity-feed" id="activity-feed"></div>
    <div class="notif-section">
      <div class="section-label">Notifications</div>
      <div class="notif-card" id="notif-toggle-card" onclick="toggleNotifications()">
        <div class="notif-left">
          <span class="notif-icon">ğŸ””</span>
          <span class="notif-text" id="notif-text">Push Notifications</span>
        </div>
        <div class="notif-check" id="notif-check">âœ“</div>
      </div>
    </div>`;

  // Build nav cards based on role
  buildNavCards(role);

  // Fetch live data from Supabase
  try {
    const res = await fetch(SB_URL + '/rest/v1/s2s_entries?select=*&order=id.desc&limit=200', { headers: _authH() });
    homeEntries = await res.json();
  } catch(e) { homeEntries = []; }

  renderStats();
  renderActivity();
  initNotifButton();
}

function buildNavCards(role) {
  const isAdmin = role === 'admin';
  const isManager = role === 'manager';
  const base = 'https://servicebridge.vyaxis.com';
  let html = '<div class="nav-cards">';

  if (isAdmin || isManager) {
    html += navCard('c-gold', 'ğŸ“Š', 'Dashboard', 'All entries & analytics', base+'/manager-dashboard.html', '');
    html += navCard('c-blue', 'ğŸ†', 'Scorecards', 'Team leaderboard', base+'/scorecards.html', '');
  }

  html += navCard('c-red', 'ğŸ“‹', 'S2S Entry', 'Log a new service lead', base+'/service-to-sales-log.html', '');
  html += navCard('c-teal', 'ğŸ”„', 'UP Board', 'Floor rotation tracker', base+'/upboard.html', '');

  if (!isAdmin && !isManager) {
    html += navCard('c-green', 'ğŸ“Š', 'View Dashboard', 'All entries & analytics', base+'/manager-dashboard.html', '', true);
  }

  if (isAdmin) {
    html += navCard('c-purple', 'âš™ï¸', 'Admin Console', 'Users, data & email settings', base+'/admin-panel.html', '', true);
  }
  if (isManager) {
    html += navCard('c-purple', 'âš™ï¸', 'Admin Panel', 'Manage users & access', base+'/admin-panel.html', '', true);
  }

  html += '</div>';
  document.getElementById('home-nav-cards').innerHTML = html;

  // Stagger animation
  document.querySelectorAll('.nav-card').forEach((card, i) => {
    card.style.opacity = '0';
    card.style.animation = `fadeUp 0.4s ease forwards ${0.5 + i * 0.08}s`;
  });
}

function navCard(cls, icon, label, desc, url, stat, wide) {
  if (wide) {
    return `<div class="nav-card ${cls} wide" onclick="goTo('${url}')">
      <div class="nav-card-top">
        <div class="nav-card-icon">${icon}</div>
        <div class="nav-card-info">
          <div class="nav-card-label">${label}</div>
          <div class="nav-card-desc">${desc}</div>
        </div>
      </div>
      <div class="nav-card-footer">
        <span class="nav-card-arrow">â†’</span>
      </div>
    </div>`;
  }
  return `<div class="nav-card ${cls}" onclick="goTo('${url}')">
    <div class="nav-card-top">
      <div class="nav-card-icon">${icon}</div>
      <div class="nav-card-label">${label}</div>
      <div class="nav-card-desc">${desc}</div>
    </div>
    <div class="nav-card-footer">
      <span class="nav-card-stat">${stat}</span>
      <span class="nav-card-arrow">â†’</span>
    </div>
  </div>`;
}

function renderStats() {
  const now = new Date();
  const startOfWeek = new Date(now); startOfWeek.setDate(now.getDate() - now.getDay()); startOfWeek.setHours(0,0,0,0);

  let pool = homeEntries;
  // For sales reps, show only their entries
  if (currentUser.role === 'sales') {
    pool = homeEntries.filter(e => e.submitter === currentUser.name);
  }

  const weekEntries = pool.filter(e => new Date(e.created_at) >= startOfWeek);
  const totalWeek = weekEntries.length;
  const soldWeek = weekEntries.filter(e => e.outcome && (e.outcome.includes('Sold') || e.outcome.includes('New') || e.outcome.includes('Used'))).length;
  const hotWeek = weekEntries.filter(e => parseInt(e.eng_score) >= 8).length;

  const tiles = document.querySelectorAll('.stat-tile');
  if (tiles[0]) tiles[0].innerHTML = `<div class="stat-num">${totalWeek}</div><div class="stat-label">This Week</div>`;
  if (tiles[1]) tiles[1].innerHTML = `<div class="stat-num">${soldWeek}</div><div class="stat-label">Sold</div>`;
  if (tiles[2]) tiles[2].innerHTML = `<div class="stat-num">${hotWeek}</div><div class="stat-label">Hot Leads</div>`;

  // Update nav card stats
  document.querySelectorAll('.nav-card-stat').forEach(el => {
    const card = el.closest('.nav-card');
    if (!card) return;
    const label = card.querySelector('.nav-card-label');
    if (!label) return;
    const text = label.textContent;
    if (text === 'S2S Entry') el.textContent = totalWeek + ' this week';
    if (text === 'Dashboard') el.textContent = homeEntries.length + ' total';
    if (text === 'Scorecards') el.textContent = soldWeek + ' sold';
    if (text === 'UP Board') el.textContent = 'Live';
  });
}

function renderActivity() {
  const feed = document.getElementById('activity-feed');
  const label = document.getElementById('activity-label');

  let pool = homeEntries;
  if (currentUser.role === 'sales') {
    pool = homeEntries.filter(e => e.submitter === currentUser.name);
  }

  const recent = pool.slice(0, 6);
  if (!recent.length) {
    feed.innerHTML = `<div class="activity-empty"><div class="activity-empty-icon">ğŸ“‹</div><div class="activity-empty-text">No entries yet â€” log your first S2S lead</div></div>`;
    label.style.display = 'flex';
    return;
  }

  label.style.display = 'flex';
  feed.innerHTML = recent.map((e, i) => {
    const sc = parseInt(e.eng_score) || 0;
    const dotClass = sc >= 8 ? 'hot' : sc >= 5 ? 'warm' : 'cool';
    const tempClass = sc >= 8 ? 't-hot' : sc >= 5 ? 't-warm' : 't-cool';
    const isSold = e.outcome && (e.outcome.includes('Sold') || e.outcome.includes('New') || e.outcome.includes('Used'));
    if (isSold) { /* override */ }
    const d = new Date(e.created_at);
    const ago = timeAgo(d);
    const name = ((e.customer_first || e.first_name || '') + ' ' + (e.customer_last || e.last_name || '')).trim() || 'Unknown';
    const vehicle = [e.vehicle_year || e.veh_year, e.vehicle_make || e.veh_make, e.vehicle_model || e.veh_model].filter(Boolean).join(' ');

    let tags = '';
    if (sc >= 8) tags += '<span class="activity-tag tag-hot">ğŸ”¥ Hot</span>';
    if (isSold) tags += '<span class="activity-tag tag-sold">âœ“ Sold</span>';
    if (e.outcome && e.outcome.includes('Appt')) tags += '<span class="activity-tag tag-appt">ğŸ“… Appt</span>';

    return `<div class="activity-item" style="animation-delay:${0.6 + i * 0.07}s">
      <div class="activity-dot ${isSold ? 'sold' : dotClass}"></div>
      <div class="activity-body">
        <div class="activity-title">${name}</div>
        <div class="activity-meta">
          <span>${e.submitter || 'â€”'}</span>
          ${vehicle ? `<span>Â· ${vehicle}</span>` : ''}
          <span>Â· ${ago}</span>
          ${tags}
        </div>
      </div>
      <div class="activity-temp ${tempClass}">${sc || 'â€”'}</div>
    </div>`;
  }).join('');
}

function timeAgo(date) {
  const diff = Date.now() - date.getTime();
  const mins = Math.floor(diff / 60000);
  if (mins < 1) return 'Just now';
  if (mins < 60) return mins + 'm ago';
  const hrs = Math.floor(mins / 60);
  if (hrs < 24) return hrs + 'h ago';
  const days = Math.floor(hrs / 24);
  if (days === 1) return 'Yesterday';
  if (days < 7) return days + 'd ago';
  return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}

function goTo(url) { window.location.href = url; }

// â”€â”€ ADMIN PANEL (in-page) â”€â”€
function buildAdminPanel() {
  const logs = getLoginLogs();
  const todayLogs = logs.filter(l => new Date(l.time).toDateString() === new Date().toDateString());
  const logItems = logs.length === 0 ? '<p style="color:var(--muted);font-size:13px;padding:12px 0;">No login activity yet.</p>'
    : logs.slice(0,15).map(l => {
        const d = new Date(l.time);
        const ts = d.toLocaleString('en-US',{month:'short',day:'numeric',hour:'numeric',minute:'2-digit'});
        return `<div class="log-item"><div class="log-dot" style="background:${l.role==='admin'?'var(--blue)':l.role==='manager'?'var(--gold)':'var(--green)'}"></div><div class="log-info"><div class="log-name">${l.name}</div><div class="log-time">${ts}</div></div><span class="role-badge ${l.role}">${l.role}</span></div>`;
      }).join('');
  document.getElementById('admin-content').innerHTML = `
    <div class="stat-grid" style="margin-top:20px;">
      <div class="stat-card"><div class="stat-val">${todayLogs.length}</div><div class="stat-lbl">Logins Today</div></div>
    </div>
    <div class="admin-section"><div class="admin-section-title">User Management</div><p style="color:var(--muted);font-size:13px;padding:12px 0;">User management has moved to the <a href="admin-panel.html" style="color:var(--red);">Admin Panel</a>.</p></div>
    <div class="admin-section"><div class="admin-section-title">Recent Login Activity</div><div style="background:var(--ink2);border:1px solid var(--border);border-radius:14px;padding:4px 16px;">${logItems}</div></div>
    <div class="admin-section"><div class="admin-section-title">Quick Actions</div>
      <div style="background:var(--ink2);border:1px solid var(--border);border-radius:14px;padding:16px;cursor:pointer;margin-bottom:10px;" onclick="clearLoginLog()">
        <div style="display:flex;align-items:center;gap:12px;"><span style="font-size:18px;">ğŸ—‘</span><div><div style="font-size:13px;font-weight:700;">Clear Login Log</div><div style="font-size:11px;color:var(--muted);margin-top:2px;">Remove all login history</div></div></div>
      </div>
      <div style="background:var(--ink2);border:1px solid var(--border);border-radius:14px;padding:16px;cursor:pointer;" onclick="goTo('https://servicebridge.vyaxis.com/admin-panel.html')">
        <div style="display:flex;align-items:center;gap:12px;"><span style="font-size:18px;">âš™ï¸</span><div style="flex:1;"><div style="font-size:13px;font-weight:700;">Full Admin Console</div><div style="font-size:11px;color:var(--muted);margin-top:2px;">Email, data & dealer settings</div></div><span style="color:var(--muted);">â†’</span></div>
      </div>
    </div>`;
}

function toggleUserActive(id) {
  if (id === 'rl') return;
  const current = getUserActive(id); setUserActive(id, !current);
  const tog = document.getElementById('tog-' + id); if (tog) tog.classList.toggle('on', !current);
  showToast(`User ${!current?'activated':'deactivated'}`);
}
function clearLoginLog() { if (!confirm('Clear all login history?')) return; localStorage.removeItem('sb_login_log'); buildAdminPanel(); showToast('Login log cleared'); }
function logout() { currentUser = null; clearSession(); unsubscribeFromPush(); document.getElementById('nav-bar').classList.remove('visible'); if(window.signOut) window.signOut(); else window.location.replace('/login.html'); }
function showToast(msg) { const t = document.getElementById('app-toast'); t.textContent = msg; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 2500); }

// â”€â”€ PUSH NOTIFICATIONS â”€â”€
const VAPID_PUBLIC_KEY = 'BFYqM0IN3sQtNJiq1iTFIh1Ex3LCEboUq7hB966WA5UT_Z5_q58_VPbuIUY__m36IyinsOTKlTHhg-PG5JN-JU4';
function urlBase64ToUint8Array(b) { const p='='.repeat((4-b.length%4)%4); const d=(b+p).replace(/-/g,'+').replace(/_/g,'/'); return Uint8Array.from([...atob(d)].map(c=>c.charCodeAt(0))); }
async function subscribeToPush(user) {
  if (!('Notification' in window)||!('serviceWorker' in navigator)) return;
  if (Notification.permission==='denied') return;
  try {
    const reg = await navigator.serviceWorker.ready; let sub = await reg.pushManager.getSubscription();
    if (!sub) { const perm = await Notification.requestPermission(); if (perm!=='granted') return; sub = await reg.pushManager.subscribe({userVisibleOnly:true,applicationServerKey:urlBase64ToUint8Array(VAPID_PUBLIC_KEY)}); }
    await fetch('/api/save-subscription',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({subscription:sub.toJSON(),user_id:user.id,user_name:user.name,user_role:user.role})});
  } catch(e){console.warn('Push failed:',e);}
}
async function unsubscribeFromPush() {
  try { const reg=await navigator.serviceWorker.ready; const sub=await reg.pushManager.getSubscription(); if(sub){await fetch('/api/save-subscription',{method:'DELETE',headers:{'Content-Type':'application/json'},body:JSON.stringify({endpoint:sub.endpoint})});await sub.unsubscribe();} } catch{}
}
async function toggleNotifications() {
  try { const reg=await navigator.serviceWorker.ready; const sub=await reg.pushManager.getSubscription(); if(sub){await unsubscribeFromPush();updateNotifButton(false);}else{await subscribeToPush(currentUser);updateNotifButton(true);} } catch{showToast('Notifications not available');}
}
async function checkNotifStatus() { if(!('PushManager' in window)) return false; try{const reg=await navigator.serviceWorker.ready;return !!(await reg.pushManager.getSubscription());}catch{return false;} }
function updateNotifButton(enabled) {
  const card = document.getElementById('notif-toggle-card');
  const text = document.getElementById('notif-text');
  const check = document.getElementById('notif-check');
  if (!card) return;
  if (enabled) {
    card.classList.add('on');
    text.textContent = 'Push Notifications On';
    check.textContent = 'âœ“';
  } else {
    card.classList.remove('on');
    text.textContent = 'Enable Notifications';
    check.textContent = '';
  }
}
async function initNotifButton() { updateNotifButton(await checkNotifStatus()); }
if ('serviceWorker' in navigator) { window.addEventListener('load',()=>{navigator.serviceWorker.register('/sw.js').catch(()=>{})}); }

// â”€â”€ INIT â”€â”€
// â”€â”€ AUTH-GATED INIT â”€â”€
async function init() {
  const { currentUser: authUser } = await SB_AUTH.init({ requiredRole: 'any' });

  // Map auth user to legacy currentUser shape
  currentUser = {
    id: authUser.id,
    name: authUser.name,
    first: authUser.first,
    role: authUser.role.toLowerCase(),
    pin: '****',
  };

  ensureSbRep(currentUser);
  addLoginLog(currentUser);
  saveSession(currentUser);
  buildHome();
  buildNav();
  initAppNav();
  showScreen('screen-home');
  subscribeToPush(currentUser);
}
init();
</script>
</body>
</html>
