<!DOCTYPE html>
<html lang="en">
<head>
  <script>
(function(){
  const rep = JSON.parse(sessionStorage.getItem('sb_rep') || 'null');
  if (!rep) { window.location.replace('/login.html'); }
})();
</script>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="ServiceBridge">
<meta name="theme-color" content="#080B14">
<title>ServiceBridge</title>
<link rel="manifest" href="/manifest.json">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=DM+Serif+Display:ital@0;1&display=swap" rel="stylesheet">
<style>
  :root {
    --ink: #080B14; --ink2: #0F1628; --ink3: #182040;
    --red: #C8102E; --gold: #C49A2A; --green: #22C55E; --blue: #6366F1;
    --text: #FFFFFF; --muted: rgba(255,255,255,0.45); --muted2: rgba(255,255,255,0.22);
    --border: rgba(255,255,255,0.08); --border2: rgba(255,255,255,0.14);
    --card: rgba(255,255,255,0.04); --card2: rgba(255,255,255,0.07);
    --r: 16px; --rsm: 10px;
  }
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
  html, body { height: 100%; background: var(--ink); color: var(--text); font-family: 'DM Sans', sans-serif; overflow: hidden; }

  .screen { position: fixed; inset: 0; display: flex; flex-direction: column; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; overflow-y: auto; -webkit-overflow-scrolling: touch; }
  .screen.active { opacity: 1; pointer-events: all; }

  .bg-grid { position: fixed; inset: 0; background-image: linear-gradient(rgba(255,255,255,0.025) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.025) 1px, transparent 1px); background-size: 40px 40px; pointer-events: none; z-index: 0; }
  .bg-glow { position: fixed; width: 600px; height: 600px; border-radius: 50%; filter: blur(120px); pointer-events: none; z-index: 0; }
  .bg-glow-red  { background: radial-gradient(circle, rgba(200,16,46,0.12) 0%, transparent 70%); top: -200px; left: -100px; }
  .bg-glow-blue { background: radial-gradient(circle, rgba(99,102,241,0.08) 0%, transparent 70%); bottom: -200px; right: -100px; }

  /* NAV BAR */
  .nav-bar { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(8,11,20,0.95); border-top: 1px solid var(--border); padding: 12px 0 max(12px, env(safe-area-inset-bottom)); display: none; justify-content: space-around; align-items: center; z-index: 100; backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); }
  .nav-bar.visible { display: flex; }
  .nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; cursor: pointer; padding: 6px 16px; border-radius: 12px; transition: all 0.15s; min-width: 60px; }
  .nav-item.active .nav-icon { color: var(--red); }
  .nav-item.active .nav-label { color: var(--text); }
  .nav-icon  { font-size: 20px; color: var(--muted); transition: color 0.15s; line-height: 1; }
  .nav-label { font-size: 10px; font-weight: 600; letter-spacing: 0.04em; color: var(--muted); transition: color 0.15s; }

  /* HEADER */
  .app-header { display: flex; align-items: center; justify-content: space-between; padding: 16px 20px 12px; padding-top: max(16px, env(safe-area-inset-top)); border-bottom: 1px solid var(--border); background: rgba(8,11,20,0.9); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); position: sticky; top: 0; z-index: 50; }
  .header-left  { display: flex; align-items: center; gap: 10px; }
  .header-logo  { width: 32px; height: 32px; background: var(--red); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 14px; }
  .header-title { font-family: 'DM Serif Display', serif; font-size: 17px; letter-spacing: -0.01em; }
  .header-right { display: flex; align-items: center; gap: 12px; }
  .header-user  { font-size: 11px; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: 0.08em; }
  .header-logout { width: 32px; height: 32px; border-radius: 8px; background: var(--card); border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 14px; transition: all 0.15s; }
  .header-logout:active { background: var(--card2); }

  /* HOME */
  .home-content { padding: 20px 20px 100px; flex: 1; position: relative; z-index: 1; }
  .home-greeting { margin-bottom: 28px; }
  .home-greeting-sub  { font-size: 12px; font-weight: 600; letter-spacing: 0.12em; text-transform: uppercase; color: var(--muted); margin-bottom: 4px; }
  .home-greeting-name { font-family: 'DM Serif Display', serif; font-size: 30px; letter-spacing: -0.02em; line-height: 1.1; }

  .cta-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
  .cta-card { background: var(--ink2); border: 1px solid var(--border); border-radius: var(--r); padding: 20px 18px; cursor: pointer; transition: all 0.2s; text-decoration: none; display: flex; flex-direction: column; gap: 12px; position: relative; overflow: hidden; }
  .cta-card::before { content: ''; position: absolute; inset: 0; opacity: 0; transition: opacity 0.2s; }
  .cta-card:active { transform: scale(0.97); }
  .cta-card:active::before { opacity: 1; }
  .cta-card.red::before    { background: rgba(200,16,46,0.08); }
  .cta-card.gold::before   { background: rgba(196,154,42,0.08); }
  .cta-card.blue::before   { background: rgba(99,102,241,0.08); }
  .cta-card.green::before  { background: rgba(34,197,94,0.08); }
  .cta-card.purple::before { background: rgba(168,85,247,0.08); }
  .cta-card.teal::before   { background: rgba(20,184,166,0.08); }
  .cta-icon { width: 44px; height: 44px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
  .cta-icon.red    { background: rgba(200,16,46,0.15); }
  .cta-icon.gold   { background: rgba(196,154,42,0.15); }
  .cta-icon.blue   { background: rgba(99,102,241,0.15); }
  .cta-icon.green  { background: rgba(34,197,94,0.15); }
  .cta-icon.purple { background: rgba(168,85,247,0.15); }
  .cta-icon.teal   { background: rgba(20,184,166,0.15); }
  .cta-label { font-size: 13px; font-weight: 700; color: var(--text); line-height: 1.2; }
  .cta-sub   { font-size: 11px; color: var(--muted); margin-top: 2px; }
  .cta-card.wide { grid-column: 1 / -1; flex-direction: row; align-items: center; padding: 18px 20px; gap: 16px; }
  .cta-card.wide .cta-text { flex: 1; }
  .cta-arrow { font-size: 16px; color: var(--muted); }

  /* ADMIN */
  #screen-admin .home-content { padding-top: 0; }
  .admin-section { margin-bottom: 28px; }
  .admin-section-title { font-size: 10px; font-weight: 700; letter-spacing: 0.14em; text-transform: uppercase; color: var(--muted); margin-bottom: 12px; padding: 0 2px; }
  .user-row { background: var(--ink2); border: 1px solid var(--border); border-radius: 14px; padding: 14px 16px; display: flex; align-items: center; gap: 14px; margin-bottom: 8px; }
  .user-avatar { width: 40px; height: 40px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: 700; flex-shrink: 0; font-family: 'DM Serif Display', serif; }
  .user-avatar.sales   { background: rgba(200,16,46,0.15); color: var(--red); }
  .user-avatar.manager { background: rgba(196,154,42,0.15); color: var(--gold); }
  .user-avatar.admin   { background: rgba(99,102,241,0.15); color: var(--blue); }
  .user-info { flex: 1; min-width: 0; }
  .user-name { font-size: 14px; font-weight: 700; }
  .user-meta { font-size: 11px; color: var(--muted); margin-top: 2px; }
  .user-controls { display: flex; align-items: center; gap: 8px; }
  .toggle-switch { width: 44px; height: 24px; border-radius: 12px; background: var(--border); position: relative; cursor: pointer; transition: background 0.2s; flex-shrink: 0; border: none; }
  .toggle-switch.on { background: var(--green); }
  .toggle-switch::after { content: ''; position: absolute; top: 3px; left: 3px; width: 18px; height: 18px; border-radius: 50%; background: white; transition: transform 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
  .toggle-switch.on::after { transform: translateX(20px); }
  .role-badge { font-size: 10px; font-weight: 700; letter-spacing: 0.08em; text-transform: uppercase; padding: 3px 8px; border-radius: 6px; }
  .role-badge.sales   { background: rgba(200,16,46,0.15); color: var(--red); }
  .role-badge.manager { background: rgba(196,154,42,0.15); color: var(--gold); }
  .role-badge.admin   { background: rgba(99,102,241,0.15); color: var(--blue); }
  .log-item { display: flex; align-items: center; gap: 12px; padding: 12px 0; border-bottom: 1px solid var(--border); }
  .log-item:last-child { border-bottom: none; }
  .log-dot  { width: 8px; height: 8px; border-radius: 50%; background: var(--green); flex-shrink: 0; }
  .log-info { flex: 1; }
  .log-name { font-size: 13px; font-weight: 600; }
  .log-time { font-size: 11px; color: var(--muted); margin-top: 2px; }

  /* STAT CARDS */
  .stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 24px; }
  .stat-card { background: var(--ink2); border: 1px solid var(--border); border-radius: 14px; padding: 14px 12px; text-align: center; }
  .stat-val { font-family: 'DM Serif Display', serif; font-size: 24px; color: var(--text); line-height: 1; margin-bottom: 4px; }
  .stat-lbl { font-size: 10px; font-weight: 600; color: var(--muted); letter-spacing: 0.06em; text-transform: uppercase; }

  /* TOAST */
  .toast { position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%) translateY(20px); background: var(--ink3); border: 1px solid var(--border2); border-radius: 12px; padding: 12px 20px; font-size: 13px; font-weight: 600; color: var(--text); white-space: nowrap; z-index: 999; opacity: 0; transition: all 0.3s; pointer-events: none; }
  .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

  .safe-bottom { padding-bottom: max(90px, calc(70px + env(safe-area-inset-bottom))); }
  ::-webkit-scrollbar { width: 4px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 2px; }
</style>
</head>
<body>

<div class="bg-grid"></div>
<div class="bg-glow bg-glow-red"></div>
<div class="bg-glow bg-glow-blue"></div>

<!-- â•â• HOME â•â• -->
<div class="screen" id="screen-home">
  <div class="app-header">
    <div class="header-left">
      <div class="header-logo">ğŸ›¡</div>
      <div class="header-title">ServiceBridge</div>
    </div>
    <div class="header-right">
      <span class="header-user" id="header-user-name"></span>
      <div class="header-logout" onclick="logout()" title="Sign Out">â†©</div>
    </div>
  </div>
  <div class="home-content safe-bottom" id="home-content"></div>
</div>

<!-- â•â• ADMIN â•â• -->
<div class="screen" id="screen-admin">
  <div class="app-header">
    <div class="header-left">
      <div class="header-logo" style="background:var(--blue)">âš™</div>
      <div class="header-title">Admin Panel</div>
    </div>
    <div class="header-right">
      <div class="header-logout" onclick="showScreen('screen-home')" title="Back">â†</div>
      <div class="header-logout" onclick="logout()" title="Sign Out">â†©</div>
    </div>
  </div>
  <div class="home-content safe-bottom" id="admin-content"></div>
</div>

<!-- NAV BAR -->
<div class="nav-bar" id="nav-bar"></div>
<div class="toast" id="app-toast"></div>

<script>
const USERS = [
  { id: 'rl', name: 'Robert Lisowski', first: 'Robert', role: 'admin',   pin: '5757' },
  { id: 'td', name: 'Tyler Doyle',     first: 'Tyler',  role: 'manager', pin: '1234' },
  { id: 'ak', name: 'Andrew Kirk',     first: 'Andrew', role: 'sales',   pin: '1234' },
  { id: 'dj', name: 'DJ Rogers',       first: 'DJ',     role: 'sales',   pin: '1234' },
  { id: 'km', name: 'Kody McCann',     first: 'Kody',   role: 'sales',   pin: '1234' },
];

let currentUser = null;

// â”€â”€ SESSION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function saveSession(user) {
  sessionStorage.setItem('sb_session', JSON.stringify({ id: user.id, time: Date.now() }));
}
function loadSession() {
  try {
    const s = JSON.parse(sessionStorage.getItem('sb_session') || 'null');
    if (!s) return null;
    if (Date.now() - s.time > 8 * 60 * 60 * 1000) return null;
    return USERS.find(u => u.id === s.id) || null;
  } catch { return null; }
}
function clearSession() {
  sessionStorage.removeItem('sb_session');
  sessionStorage.removeItem('sb_rep');
}

// â”€â”€ ACTIVITY LOG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addLoginLog(user) {
  const logs = getLoginLogs();
  logs.unshift({ name: user.name, role: user.role, time: new Date().toISOString(), id: user.id });
  localStorage.setItem('sb_login_log', JSON.stringify(logs.slice(0, 50)));
}
function getLoginLogs() {
  try { return JSON.parse(localStorage.getItem('sb_login_log') || '[]'); } catch { return []; }
}

// â”€â”€ ACTIVE STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getUserActive(id) {
  const stored = localStorage.getItem('sb_active_' + id);
  return stored === null ? true : stored === 'true';
}
function setUserActive(id, val) { localStorage.setItem('sb_active_' + id, val); }

// â”€â”€ SCREENS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => { s.classList.remove('active'); s.style.pointerEvents = 'none'; });
  const el = document.getElementById(id);
  if (el) { el.classList.add('active'); el.style.pointerEvents = 'all'; el.scrollTop = 0; }
  const nav = document.getElementById('nav-bar');
  nav.classList.toggle('visible', id === 'screen-home' || id === 'screen-admin');
  updateNav(id);
}

// â”€â”€ NAV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildNav() {
  const nav = document.getElementById('nav-bar');
  if (!currentUser) { nav.innerHTML = ''; return; }
  const items = [{ icon: 'ğŸ ', label: 'Home', screen: 'screen-home' }];
  if (currentUser.role === 'admin' || currentUser.role === 'manager') {
    items.push({ icon: 'âš™ï¸', label: 'Admin', screen: 'screen-admin' });
  }
  nav.innerHTML = items.map(item => `
    <div class="nav-item" onclick="navGo('${item.screen}')" data-screen="${item.screen}">
      <div class="nav-icon">${item.icon}</div>
      <div class="nav-label">${item.label}</div>
    </div>`).join('');
}
function navGo(screen) {
  if (screen === 'screen-admin') buildAdminPanel();
  showScreen(screen);
}
function updateNav(activeScreen) {
  document.querySelectorAll('.nav-item').forEach(item => {
    item.classList.toggle('active', item.dataset.screen === activeScreen);
  });
}

// â”€â”€ HOME â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildHome() {
  document.getElementById('header-user-name').textContent = currentUser.first;
  const hour = new Date().getHours();
  const greet = hour < 12 ? 'Good morning' : hour < 17 ? 'Good afternoon' : 'Good evening';
  let cards = '';

  if (currentUser.role === 'sales') {
    cards = `
      <div class="cta-grid">
        <div class="cta-card red" onclick="goTo('https://servicebridge.vyaxis.com/service-to-sales-log.html')">
          <div class="cta-icon red">ğŸ“‹</div>
          <div><div class="cta-label">S2S Entry</div><div class="cta-sub">Log a lead</div></div>
        </div>
        <div class="cta-card blue" onclick="goTo('https://servicebridge.vyaxis.com/scorecards.html')">
          <div class="cta-icon blue">ğŸ†</div>
          <div><div class="cta-label">Scoreboard</div><div class="cta-sub">Team standings</div></div>
        </div>
      </div>
      <div class="cta-card wide green" onclick="goTo('https://servicebridge.vyaxis.com/manager-dashboard.html')">
        <div class="cta-icon green">ğŸ“Š</div>
        <div class="cta-text"><div class="cta-label">View Dashboard</div><div class="cta-sub">All entries & analytics</div></div>
        <div class="cta-arrow">â†’</div>
      </div>`;
  }

  if (currentUser.role === 'manager') {
    cards = `
      <div class="cta-grid">
        <div class="cta-card gold" onclick="goTo('https://servicebridge.vyaxis.com/manager-dashboard.html')">
          <div class="cta-icon gold">ğŸ“Š</div>
          <div><div class="cta-label">Dashboard</div><div class="cta-sub">All entries</div></div>
        </div>
        <div class="cta-card blue" onclick="goTo('https://servicebridge.vyaxis.com/scorecards.html')">
          <div class="cta-icon blue">ğŸ†</div>
          <div><div class="cta-label">Scoreboard</div><div class="cta-sub">Leaderboard</div></div>
        </div>
        <div class="cta-card red" onclick="goTo('https://servicebridge.vyaxis.com/service-to-sales-log.html')">
          <div class="cta-icon red">ğŸ“‹</div>
          <div><div class="cta-label">S2S Entry</div><div class="cta-sub">Log a lead</div></div>
        </div>
        <div class="cta-card teal" onclick="goTo('https://servicebridge.vyaxis.com/upboard.html')">
          <div class="cta-icon teal">ğŸ”„</div>
          <div><div class="cta-label">UP Board</div><div class="cta-sub">Floor rotation</div></div>
        </div>
      </div>
      <div class="cta-card wide purple" onclick="navGo('screen-admin')">
        <div class="cta-icon purple">âš™ï¸</div>
        <div class="cta-text"><div class="cta-label">Admin Panel</div><div class="cta-sub">Manage users & access</div></div>
        <div class="cta-arrow">â†’</div>
      </div>`;
  }

  if (currentUser.role === 'admin') {
    cards = `
      <div class="cta-grid">
        <div class="cta-card gold" onclick="goTo('https://servicebridge.vyaxis.com/manager-dashboard.html')">
          <div class="cta-icon gold">ğŸ“Š</div>
          <div><div class="cta-label">Dashboard</div><div class="cta-sub">All entries</div></div>
        </div>
        <div class="cta-card blue" onclick="goTo('https://servicebridge.vyaxis.com/scorecards.html')">
          <div class="cta-icon blue">ğŸ†</div>
          <div><div class="cta-label">Scoreboard</div><div class="cta-sub">Leaderboard</div></div>
        </div>
        <div class="cta-card red" onclick="goTo('https://servicebridge.vyaxis.com/service-to-sales-log.html')">
          <div class="cta-icon red">ğŸ“‹</div>
          <div><div class="cta-label">S2S Entry</div><div class="cta-sub">Log a lead</div></div>
        </div>
        <div class="cta-card teal" onclick="goTo('https://servicebridge.vyaxis.com/upboard.html')">
          <div class="cta-icon teal">ğŸ”„</div>
          <div><div class="cta-label">UP Board</div><div class="cta-sub">Floor rotation</div></div>
        </div>
      </div>
      <div class="cta-card wide purple" onclick="goTo('https://servicebridge.vyaxis.com/admin-panel.html')">
        <div class="cta-icon purple">âš™ï¸</div>
        <div class="cta-text"><div class="cta-label">Admin Console</div><div class="cta-sub">Users, data & email settings</div></div>
        <div class="cta-arrow">â†’</div>
      </div>`;
  }

  document.getElementById('home-content').innerHTML = `
    <div class="home-greeting">
      <div class="home-greeting-sub">${greet}</div>
      <div class="home-greeting-name">${currentUser.first}.</div>
    </div>
    ${cards}
    <div style="margin-top:12px;">
      <button id="notif-toggle-btn" onclick="toggleNotifications()"
        style="background:var(--card);border:1px solid var(--border);border-radius:12px;
               padding:12px 24px;font-size:13px;font-weight:600;color:var(--muted);
               cursor:pointer;font-family:'DM Sans',sans-serif;width:100%;transition:all 0.18s;">
        ğŸ”• Enable Notifications
      </button>
    </div>`;
  initNotifButton();
}

// â”€â”€ NAVIGATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Direct page navigation â€” sessionStorage is preserved, no iframe issues
function goTo(url) {
  window.location.href = url;
}

// â”€â”€ ADMIN PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildAdminPanel() {
  const logs = getLoginLogs();
  const todayLogs = logs.filter(l => new Date(l.time).toDateString() === new Date().toDateString());
  const activeCount = USERS.filter(u => getUserActive(u.id)).length;

  const userRows = USERS.map(u => {
    const active = getUserActive(u.id);
    return `
      <div class="user-row">
        <div class="user-avatar ${u.role}">${u.first[0]}</div>
        <div class="user-info">
          <div class="user-name">${u.name}</div>
          <div class="user-meta"><span class="role-badge ${u.role}">${u.role}</span>&nbsp;PIN: ${u.pin}</div>
        </div>
        <div class="user-controls">
          <button class="toggle-switch ${active ? 'on' : ''}" id="tog-${u.id}"
                  onclick="toggleUserActive('${u.id}')"
                  ${u.id === 'rl' ? 'disabled style="opacity:0.4;cursor:not-allowed"' : ''}>
          </button>
        </div>
      </div>`;
  }).join('');

  const logItems = logs.length === 0
    ? '<p style="color:var(--muted);font-size:13px;padding:12px 0;">No login activity yet.</p>'
    : logs.slice(0, 15).map(l => {
        const d = new Date(l.time);
        const timeStr = d.toLocaleString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' });
        return `
          <div class="log-item">
            <div class="log-dot" style="background:${l.role==='admin'?'var(--blue)':l.role==='manager'?'var(--gold)':'var(--green)'}"></div>
            <div class="log-info"><div class="log-name">${l.name}</div><div class="log-time">${timeStr}</div></div>
            <span class="role-badge ${l.role}">${l.role}</span>
          </div>`;
      }).join('');

  document.getElementById('admin-content').innerHTML = `
    <div class="stat-grid" style="margin-top:20px;">
      <div class="stat-card"><div class="stat-val">${USERS.length}</div><div class="stat-lbl">Users</div></div>
      <div class="stat-card"><div class="stat-val">${activeCount}</div><div class="stat-lbl">Active</div></div>
      <div class="stat-card"><div class="stat-val">${todayLogs.length}</div><div class="stat-lbl">Logins Today</div></div>
    </div>
    <div class="admin-section">
      <div class="admin-section-title">User Access</div>
      ${userRows}
    </div>
    <div class="admin-section">
      <div class="admin-section-title">Recent Login Activity</div>
      <div style="background:var(--ink2);border:1px solid var(--border);border-radius:14px;padding:4px 16px;">${logItems}</div>
    </div>
    <div class="admin-section">
      <div class="admin-section-title">Quick Actions</div>
      <div class="cta-card wide red" onclick="clearLoginLog()" style="margin-bottom:10px;">
        <div class="cta-icon red">ğŸ—‘</div>
        <div class="cta-text"><div class="cta-label">Clear Login Log</div><div class="cta-sub">Remove all login history</div></div>
      </div>
      <div class="cta-card wide gold" onclick="goTo('https://servicebridge.vyaxis.com/admin-panel.html')">
        <div class="cta-icon gold">âš™ï¸</div>
        <div class="cta-text"><div class="cta-label">Full Admin Console</div><div class="cta-sub">Email, data & dealer settings</div></div>
        <div class="cta-arrow">â†’</div>
      </div>
    </div>`;
}

function toggleUserActive(id) {
  if (id === 'rl') return;
  const current = getUserActive(id);
  setUserActive(id, !current);
  const tog = document.getElementById('tog-' + id);
  if (tog) tog.classList.toggle('on', !current);
  const user = USERS.find(u => u.id === id);
  showToast(`${user.first} ${!current ? 'activated' : 'deactivated'}`);
}

function clearLoginLog() {
  if (!confirm('Clear all login history?')) return;
  localStorage.removeItem('sb_login_log');
  buildAdminPanel();
  showToast('Login log cleared');
}

// â”€â”€ LOGOUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function logout() {
  currentUser = null;
  clearSession();
  unsubscribeFromPush();
  document.getElementById('nav-bar').classList.remove('visible');
  window.location.replace('/login.html');
}

// â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showToast(msg) {
  const t = document.getElementById('app-toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
}

// â”€â”€ PUSH NOTIFICATIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const VAPID_PUBLIC_KEY = 'BFYqM0IN3sQtNJiq1iTFIh1Ex3LCEboUq7hB966WA5UT_Z5_q58_VPbuIUY__m36IyinsOTKlTHhg-PG5JN-JU4';

function urlBase64ToUint8Array(base64String) {
  const padding = '='.repeat((4 - base64String.length % 4) % 4);
  const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
  const rawData = window.atob(base64);
  return Uint8Array.from([...rawData].map(c => c.charCodeAt(0)));
}

async function subscribeToPush(user) {
  if (!('Notification' in window) || !('serviceWorker' in navigator)) return;
  if (Notification.permission === 'denied') return;
  try {
    const reg = await navigator.serviceWorker.ready;
    let sub = await reg.pushManager.getSubscription();
    if (!sub) {
      const perm = await Notification.requestPermission();
      if (perm !== 'granted') return;
      sub = await reg.pushManager.subscribe({ userVisibleOnly: true, applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY) });
    }
    await fetch('/api/save-subscription', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ subscription: sub.toJSON(), user_id: user.id, user_name: user.name, user_role: user.role })
    });
  } catch (err) { console.warn('Push subscription failed:', err); }
}

async function unsubscribeFromPush() {
  try {
    const reg = await navigator.serviceWorker.ready;
    const sub = await reg.pushManager.getSubscription();
    if (sub) {
      await fetch('/api/save-subscription', { method: 'DELETE', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ endpoint: sub.endpoint }) });
      await sub.unsubscribe();
    }
  } catch (err) { console.warn('Unsubscribe failed:', err); }
}

async function toggleNotifications() {
  try {
    const reg = await navigator.serviceWorker.ready;
    const sub = await reg.pushManager.getSubscription();
    if (sub) { await unsubscribeFromPush(); updateNotifButton(false); }
    else { await subscribeToPush(currentUser); updateNotifButton(true); }
  } catch { showToast('Notifications not available'); }
}

async function checkNotifStatus() {
  if (!('PushManager' in window)) return false;
  try { const reg = await navigator.serviceWorker.ready; return !!(await reg.pushManager.getSubscription()); }
  catch { return false; }
}

function updateNotifButton(enabled) {
  const btn = document.getElementById('notif-toggle-btn');
  if (!btn) return;
  btn.textContent = enabled ? 'ğŸ”” Notifications On' : 'ğŸ”• Enable Notifications';
  btn.style.borderColor = enabled ? 'rgba(34,197,94,0.4)' : 'var(--border)';
  btn.style.color = enabled ? 'var(--green)' : 'var(--muted)';
  btn.style.background = enabled ? 'rgba(34,197,94,0.08)' : 'var(--card)';
}

async function initNotifButton() {
  const enabled = await checkNotifStatus();
  updateNotifButton(enabled);
}

if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => { navigator.serviceWorker.register('/sw.js').catch(() => {}); });
}

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function init() {
  // Primary: read sb_rep set by login.html
  const sbRep = JSON.parse(sessionStorage.getItem('sb_rep') || 'null');
  if (sbRep) {
    const matched = USERS.find(u => u.name === sbRep.name);
    if (matched) {
      currentUser = matched;
      addLoginLog(currentUser);
      saveSession(currentUser);
      buildHome();
      buildNav();
      showScreen('screen-home');
      subscribeToPush(currentUser);
      return;
    }
  }

  // Fallback: internal 8hr session (returning user, tab reload)
  const saved = loadSession();
  if (saved) {
    currentUser = saved;
    buildHome();
    buildNav();
    showScreen('screen-home');
    return;
  }

  // No valid session â€” back to login
  window.location.replace('/login.html');
}

init();
</script>
</body>
</html>
