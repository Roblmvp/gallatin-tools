<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ServiceBridge ‚Äî Gallatin CDJR</title>

<!-- Open Graph / Link Preview -->
<meta property="og:type" content="website">
<meta property="og:url" content="https://servicebridge.vyaxis.com/login.html">
<meta property="og:title" content="ServiceBridge ‚Äî Vyaxis">
<meta property="og:description" content="Service ‚Üí Sales Platform. Log S2S contacts, track hot leads, and view your personal performance dashboard.">
<meta property="og:image" content="https://res.cloudinary.com/di5ujiwjp/image/upload/v1771987751/servicebridge-preview_fynjod.png">
<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="630">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://res.cloudinary.com/di5ujiwjp/image/upload/v1771987751/servicebridge-preview_fynjod.png">

<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --ink: #0A0A0F; --ink2: #111118;
  --purple: #5B4FE8; --purple-light: #7B72F0; --purple-glow: rgba(91,79,232,0.35);
  --red: #C8102E; --red-glow: rgba(200,16,46,0.25);
  --gold: #E8B84B; --green: #22C55E;
  --surface: #16161F; --surface2: #1C1C27;
  --border: rgba(255,255,255,0.08); --border-bright: rgba(255,255,255,0.15);
  --text: #F0EEF8; --muted: rgba(240,238,248,0.45); --muted2: rgba(240,238,248,0.25);
  --r: 12px;
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
body { background: var(--ink); color: var(--text); font-family: 'DM Sans', sans-serif; min-height: 100vh; overflow-x: hidden; -webkit-font-smoothing: antialiased; }

.bg-grid { position:fixed;inset:0;z-index:0;background-image:linear-gradient(rgba(255,255,255,0.03) 1px,transparent 1px),linear-gradient(90deg,rgba(255,255,255,0.03) 1px,transparent 1px);background-size:48px 48px;pointer-events:none; }
.bg-orb1 { position:fixed;top:-200px;right:-200px;width:600px;height:600px;border-radius:50%;background:radial-gradient(circle,rgba(91,79,232,0.18) 0%,transparent 70%);pointer-events:none;z-index:0; }
.bg-orb2 { position:fixed;bottom:-200px;left:-100px;width:500px;height:500px;border-radius:50%;background:radial-gradient(circle,rgba(200,16,46,0.12) 0%,transparent 70%);pointer-events:none;z-index:0; }

.screen { display:none;position:relative;z-index:1; }
.screen.active { display:flex; }

/* LOGIN */
#screen-login { min-height:100vh;flex-direction:column;align-items:center;justify-content:center;padding:24px; }

.brand-lockup { text-align:center;margin-bottom:48px;animation:fadeDown 0.6s ease both; }
.brand-powered { font-size:10px;font-weight:600;letter-spacing:0.18em;text-transform:uppercase;color:var(--muted2);margin-bottom:10px; }
.brand-name { font-family:'Bebas Neue',sans-serif;font-size:52px;letter-spacing:0.04em;background:linear-gradient(135deg,#fff 0%,rgba(255,255,255,0.6) 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;line-height:1; }
.brand-product { display:inline-flex;align-items:center;gap:8px;margin-top:10px;background:linear-gradient(135deg,var(--purple),var(--purple-light));-webkit-background-clip:text;-webkit-text-fill-color:transparent;font-family:'Bebas Neue',sans-serif;font-size:28px;letter-spacing:0.08em; }
.brand-dealer { font-size:11px;font-weight:500;color:var(--muted);margin-top:6px;letter-spacing:0.06em; }

.login-card { background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:40px 36px;width:100%;max-width:420px;box-shadow:0 32px 80px rgba(0,0,0,0.5);animation:fadeUp 0.6s 0.1s ease both;position:relative;overflow:hidden; }
.login-card::before { content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--purple),var(--purple-light),var(--red)); }

.card-label { font-size:10px;font-weight:600;letter-spacing:0.18em;text-transform:uppercase;color:var(--muted);margin-bottom:18px; }
.card-title { font-family:'DM Sans',sans-serif;font-size:22px;font-weight:700;margin-bottom:6px; }
.card-sub { font-size:13px;color:var(--muted);margin-bottom:32px;line-height:1.5; }

.rep-grid { display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:28px; }
.rep-btn { background:var(--surface2);border:1.5px solid var(--border);border-radius:var(--r);padding:14px 12px;cursor:pointer;transition:all 0.18s;text-align:left;position:relative;overflow:hidden; }
.rep-btn:hover { border-color:var(--border-bright);background:rgba(255,255,255,0.06); }
.rep-btn.selected { border-color:var(--purple);background:rgba(91,79,232,0.12);box-shadow:0 0 0 1px var(--purple); }
.rep-btn.selected::after { content:'‚úì';position:absolute;top:8px;right:10px;font-size:11px;color:var(--purple);font-weight:700; }
.rep-avatar { width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,var(--purple),var(--purple-light));display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:#fff;margin-bottom:8px; }
.rep-btn.selected .rep-avatar { background:linear-gradient(135deg,var(--purple),var(--red)); }
.rep-btn-name { font-size:13px;font-weight:600;color:var(--text);line-height:1.2; }
.rep-btn-role { font-size:10px;color:var(--muted);margin-top:2px;font-weight:500;letter-spacing:0.04em; }

.pin-section { display:none; }
.pin-section.show { display:block; }
.pin-label { font-size:10px;font-weight:600;letter-spacing:0.14em;text-transform:uppercase;color:var(--muted);margin-bottom:12px; }
.pin-dots { display:flex;gap:10px;justify-content:center;margin-bottom:20px; }
.pin-dot { width:14px;height:14px;border-radius:50%;border:2px solid var(--border-bright);transition:all 0.15s; }
.pin-dot.filled { background:var(--purple);border-color:var(--purple);box-shadow:0 0 8px var(--purple-glow); }
.pin-dot.error { background:var(--red);border-color:var(--red);animation:shake 0.3s ease; }
.pin-pad { display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:16px; }
.pin-key { background:var(--surface2);border:1px solid var(--border);border-radius:10px;height:52px;font-family:'DM Sans',sans-serif;font-size:18px;font-weight:600;color:var(--text);cursor:pointer;transition:all 0.12s;display:flex;align-items:center;justify-content:center;-webkit-tap-highlight-color:transparent;user-select:none; }
.pin-key:hover { background:rgba(255,255,255,0.08);border-color:var(--border-bright); }
.pin-key:active { transform:scale(0.94);background:rgba(91,79,232,0.2);border-color:var(--purple); }
.pin-error { text-align:center;font-size:12px;color:#FC8181;font-weight:500;height:18px;margin-bottom:8px; }

/* DASHBOARD */
#screen-dashboard { min-height:100vh;flex-direction:column; }
.dash-header { background:var(--ink2);border-bottom:1px solid var(--border);padding:0 24px;height:60px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:50;flex-shrink:0; }
.dash-header::after { content:'';position:absolute;bottom:0;left:0;right:0;height:1px;background:linear-gradient(90deg,var(--purple),transparent,var(--red),transparent); }
.dash-brand { font-family:'Bebas Neue',sans-serif;font-size:22px;letter-spacing:0.06em;background:linear-gradient(90deg,#fff,rgba(255,255,255,0.6));-webkit-background-clip:text;-webkit-text-fill-color:transparent; }
.dash-rep-pill { display:flex;align-items:center;gap:8px;background:var(--surface);border:1px solid var(--border);border-radius:30px;padding:6px 14px 6px 6px; }
.dash-rep-avatar { width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,var(--purple),var(--red));display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;color:#fff; }
.dash-rep-name { font-size:12px;font-weight:600; }
.dash-logout { background:transparent;border:none;color:var(--muted);font-size:11px;font-weight:600;letter-spacing:0.06em;cursor:pointer;padding:6px 12px;border-radius:6px;transition:color 0.18s;font-family:'DM Sans',sans-serif; }
.dash-logout:hover { color:var(--text); }

.dash-body { max-width:540px;margin:0 auto;padding:32px 20px 80px;width:100%; }
.dash-welcome { margin-bottom:24px;animation:fadeUp 0.4s ease both; }
.dash-greeting { font-size:11px;font-weight:600;letter-spacing:0.14em;text-transform:uppercase;color:var(--muted);margin-bottom:6px; }
.dash-name { font-family:'Bebas Neue',sans-serif;font-size:42px;letter-spacing:0.04em;line-height:1; }
.dash-date { font-size:12px;color:var(--muted);margin-top:4px;font-family:'DM Mono',monospace; }

/* KPI row ‚Äî 6 stats */
.kpi-row { display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:20px;animation:fadeUp 0.4s 0.1s ease both; }
.kpi-card { background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:14px;position:relative;overflow:hidden; }
.kpi-card::before { content:'';position:absolute;top:0;left:0;right:0;height:2px; }
.kpi-purple::before { background:var(--purple); }
.kpi-red::before { background:var(--red); }
.kpi-gold::before { background:var(--gold); }
.kpi-green::before { background:var(--green); }
.kpi-lbl { font-size:8px;font-weight:600;letter-spacing:0.14em;text-transform:uppercase;color:var(--muted);margin-bottom:4px; }
.kpi-val { font-family:'Bebas Neue',sans-serif;font-size:30px;line-height:1; }
.kpi-purple .kpi-val { color:var(--purple-light); }
.kpi-red .kpi-val { color:#FC8181; }
.kpi-gold .kpi-val { color:var(--gold); }
.kpi-green .kpi-val { color:#4ADE80; }

/* Section label */
.section-lbl { font-size:9px;font-weight:700;letter-spacing:0.16em;text-transform:uppercase;color:var(--muted);margin-bottom:12px;display:flex;align-items:center;gap:8px; }
.section-lbl::before { content:'';display:inline-block;width:14px;height:2px;border-radius:2px; }
.lbl-s2s::before { background:var(--purple); }
.lbl-greet::before { background:var(--green); }

/* Action buttons */
.action-btn { width:100%;background:linear-gradient(135deg,var(--purple),var(--purple-light));border:none;border-radius:14px;padding:20px 24px;display:flex;align-items:center;justify-content:space-between;cursor:pointer;transition:all 0.2s;text-decoration:none;margin-bottom:12px;box-shadow:0 8px 24px var(--purple-glow); }
.action-btn:hover { transform:translateY(-2px);box-shadow:0 12px 32px var(--purple-glow); }
.action-btn.green { background:linear-gradient(135deg,var(--green),#16A34A);box-shadow:0 8px 24px rgba(34,197,94,0.3); }
.action-btn.green:hover { box-shadow:0 12px 32px rgba(34,197,94,0.4); }
.action-btn-left { text-align:left; }
.action-btn-eyebrow { font-size:10px;font-weight:600;letter-spacing:0.14em;text-transform:uppercase;color:rgba(255,255,255,0.65);margin-bottom:4px; }
.action-btn-title { font-family:'Bebas Neue',sans-serif;font-size:24px;letter-spacing:0.04em;color:#fff;line-height:1; }
.action-btn-arrow { width:40px;height:40px;border-radius:50%;background:rgba(255,255,255,0.15);display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0; }

/* Entries */
.entry-card { background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:14px 16px;margin-bottom:8px;display:flex;align-items:center;justify-content:space-between;transition:border-color 0.18s; }
.entry-card:hover { border-color:var(--border-bright); }
.entry-name { font-size:14px;font-weight:600; }
.entry-meta { font-size:11px;color:var(--muted);margin-top:3px; }
.entry-outcome { font-size:11px;font-weight:700;padding:3px 10px;border-radius:20px;display:inline-block; }
.out-sold { background:rgba(34,197,94,0.15);color:#4ADE80; }
.out-appt { background:rgba(91,79,232,0.15);color:var(--purple-light); }
.out-follow { background:rgba(232,184,75,0.15);color:var(--gold); }
.out-other { background:rgba(255,255,255,0.06);color:var(--muted); }
.entry-temp { font-size:11px;color:var(--muted);margin-top:4px;font-family:'DM Mono',monospace; }

/* Greet entry */
.greet-card { background:var(--surface);border:1px solid rgba(34,197,94,0.15);border-radius:var(--r);padding:14px 16px;margin-bottom:8px;display:flex;align-items:center;justify-content:space-between; }
.greet-source { font-size:10px;font-weight:700;letter-spacing:0.08em;text-transform:uppercase;color:#4ADE80;margin-bottom:3px; }
.greet-name { font-size:14px;font-weight:600; }
.greet-meta { font-size:11px;color:var(--muted);margin-top:2px; }
.greet-outcome { font-size:11px;font-weight:700;padding:3px 10px;border-radius:20px;background:rgba(34,197,94,0.12);color:#4ADE80;border:1px solid rgba(34,197,94,0.2); }

.empty-state { text-align:center;padding:32px 20px;color:var(--muted);font-size:13px;background:var(--surface);border:1px dashed var(--border);border-radius:var(--r); }
.empty-icon { font-size:28px;margin-bottom:8px;opacity:0.5; }

.loading-dots span { display:inline-block;width:6px;height:6px;border-radius:50%;background:var(--purple);margin:0 3px;animation:pulse 1.2s ease infinite; }
.loading-dots span:nth-child(2){animation-delay:0.2s;} .loading-dots span:nth-child(3){animation-delay:0.4s;}

@keyframes fadeUp{from{opacity:0;transform:translateY(16px);}to{opacity:1;transform:translateY(0);}}
@keyframes fadeDown{from{opacity:0;transform:translateY(-12px);}to{opacity:1;transform:translateY(0);}}
@keyframes shake{0%,100%{transform:translateX(0);}25%{transform:translateX(-6px);}75%{transform:translateX(6px);}}
@keyframes pulse{0%,100%{opacity:1;}50%{opacity:0.4;}}
</style>
</head>
<body>
<div class="bg-grid"></div>
<div class="bg-orb1"></div>
<div class="bg-orb2"></div>

<!-- ‚ïê‚ïê‚ïê LOGIN ‚ïê‚ïê‚ïê -->
<div class="screen active" id="screen-login">
  <div style="width:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;padding:24px;">
    <div class="brand-lockup">
      <div class="brand-powered">Powered by Vyaxis</div>
      <div class="brand-name">GALLATIN CDJR</div>
      <div class="brand-product">‚ö° ServiceBridge</div>
      <div class="brand-dealer">Service ‚Üí Sales Platform ¬∑ S2S Team Access</div>
    </div>
    <div class="login-card">
      <div id="step-name">
        <div class="card-label">Step 1 of 2</div>
        <div class="card-title">Who are you?</div>
        <div class="card-sub">Select your name to continue</div>
        <div class="rep-grid" id="rep-grid"></div>
        <button onclick="goToPin()" id="next-btn" style="width:100%;background:linear-gradient(135deg,var(--purple),var(--purple-light));border:none;border-radius:10px;color:#fff;font-family:'DM Sans',sans-serif;font-size:14px;font-weight:700;padding:14px;cursor:pointer;transition:all 0.18s;opacity:0.4;pointer-events:none;letter-spacing:0.04em;">Continue ‚Üí</button>
      </div>
      <div id="step-pin" class="pin-section">
        <div class="card-label">Step 2 of 2</div>
        <div class="card-title">Enter your PIN</div>
        <div class="card-sub" id="pin-sub">Enter your 4-digit PIN</div>
        <div class="pin-dots">
          <div class="pin-dot" id="dot-0"></div><div class="pin-dot" id="dot-1"></div>
          <div class="pin-dot" id="dot-2"></div><div class="pin-dot" id="dot-3"></div>
        </div>
        <div class="pin-pad">
          <button class="pin-key" onclick="pinPress('1')">1</button><button class="pin-key" onclick="pinPress('2')">2</button><button class="pin-key" onclick="pinPress('3')">3</button>
          <button class="pin-key" onclick="pinPress('4')">4</button><button class="pin-key" onclick="pinPress('5')">5</button><button class="pin-key" onclick="pinPress('6')">6</button>
          <button class="pin-key" onclick="pinPress('7')">7</button><button class="pin-key" onclick="pinPress('8')">8</button><button class="pin-key" onclick="pinPress('9')">9</button>
          <button class="pin-key" onclick="goBackToName()">‚Üê</button><button class="pin-key" onclick="pinPress('0')">0</button><button class="pin-key" onclick="pinDelete()">‚å´</button>
        </div>
        <div class="pin-error" id="pin-error"></div>
      </div>
    </div>
    <div style="margin-top:20px;font-size:11px;color:var(--muted2);text-align:center;">
      Manager: <a href="manager-dashboard.html" style="color:var(--purple-light);text-decoration:none;">Dashboard</a> ¬∑
      <a href="scorecards.html" style="color:var(--purple-light);text-decoration:none;">Scorecards</a> ¬∑
      <a href="admin-panel.html" style="color:var(--muted);text-decoration:none;">Admin</a>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê DASHBOARD ‚ïê‚ïê‚ïê -->
<div class="screen" id="screen-dashboard">
  <div style="width:100%;display:flex;flex-direction:column;">
    <div class="dash-header">
      <div class="dash-brand">ServiceBridge</div>
      <div style="display:flex;align-items:center;gap:12px;">
        <div class="dash-rep-pill">
          <div class="dash-rep-avatar" id="dash-avatar"></div>
          <div class="dash-rep-name" id="dash-repname"></div>
        </div>
        <button class="dash-logout" onclick="doLogout()">Sign Out</button>
      </div>
    </div>

    <div class="dash-body">
      <div class="dash-welcome">
        <div class="dash-greeting">Welcome back</div>
        <div class="dash-name" id="dash-fullname"></div>
        <div class="dash-date" id="dash-date"></div>
      </div>

      <!-- KPIs -->
      <div class="kpi-row" style="animation:fadeUp 0.4s 0.1s ease both;">
        <div class="kpi-card kpi-purple"><div class="kpi-lbl">S2S Entries</div><div class="kpi-val" id="kpi-entries">‚Äî</div></div>
        <div class="kpi-card kpi-red"><div class="kpi-lbl">Hot Leads</div><div class="kpi-val" id="kpi-hot">‚Äî</div></div>
        <div class="kpi-card kpi-gold"><div class="kpi-lbl">Sold</div><div class="kpi-val" id="kpi-sold">‚Äî</div></div>
        <div class="kpi-card kpi-green"><div class="kpi-lbl">Greets Today</div><div class="kpi-val" id="kpi-greets">‚Äî</div></div>
        <div class="kpi-card kpi-purple"><div class="kpi-lbl">Demos</div><div class="kpi-val" id="kpi-demos">‚Äî</div></div>
        <div class="kpi-card kpi-gold"><div class="kpi-lbl">Appts Set</div><div class="kpi-val" id="kpi-appts">‚Äî</div></div>
      </div>

      <!-- S2S Section -->
      <div class="section-lbl lbl-s2s" style="animation:fadeUp 0.4s 0.2s ease both;">S2S Log</div>
      <a href="service-to-sales-log.html" class="action-btn" style="animation:fadeUp 0.4s 0.25s ease both;">
        <div class="action-btn-left">
          <div class="action-btn-eyebrow">Log New Entry</div>
          <div class="action-btn-title">S2S Contact Form</div>
        </div>
        <div class="action-btn-arrow">‚Üí</div>
      </a>

      <!-- Greet Section -->
      <div class="section-lbl lbl-greet" style="animation:fadeUp 0.4s 0.3s ease both;margin-top:4px;">Greet Log</div>
      <a href="greet.html" class="action-btn green" style="animation:fadeUp 0.4s 0.35s ease both;">
        <div class="action-btn-left">
          <div class="action-btn-eyebrow">Log New Up</div>
          <div class="action-btn-title">Greet & Traffic Log</div>
        </div>
        <div class="action-btn-arrow">ü§ù</div>
      </a>

      <!-- Recent S2S -->
      <div class="section-lbl lbl-s2s" style="animation:fadeUp 0.4s 0.4s ease both;margin-top:8px;">My Recent S2S</div>
      <div id="s2s-list" style="animation:fadeUp 0.4s 0.45s ease both;">
        <div style="text-align:center;padding:24px;color:var(--muted);"><span class="loading-dots"><span></span><span></span><span></span></span></div>
      </div>

      <!-- Recent Greets -->
      <div class="section-lbl lbl-greet" style="animation:fadeUp 0.4s 0.5s ease both;margin-top:16px;">My Recent Greets</div>
      <div id="greet-list" style="animation:fadeUp 0.4s 0.55s ease both;">
        <div style="text-align:center;padding:24px;color:var(--muted);"><span class="loading-dots"><span></span><span></span><span></span></span></div>
      </div>
    </div>
  </div>
</div>

<script>
const SB_URL = 'https://jbkgwtohwsbaorhvuuqb.supabase.co';
const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impia2d3dG9od3NiYW9yaHZ1dXFiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5NjkwNDIsImV4cCI6MjA4NzU0NTA0Mn0.GRXOYbIuVDxU9-FEBYmyd1QmytVUrMIAxbnOSfepzuU';
const H = {'apikey':SB_KEY,'Authorization':'Bearer '+SB_KEY};

const REPS = [
  {name:'Tyler Doyle',initials:'TD',role:'S2S Manager',pin:'1234'},
  {name:'Andrew Kirk',initials:'AK',role:'Sales',pin:'1234'},
  {name:'DJ Rogers',initials:'DJ',role:'Sales',pin:'1234'},
  {name:'Kody McCann',initials:'KM',role:'Sales',pin:'1234'},
];

let selectedRep = null, pinEntry = '';

function init() {
  renderRepGrid();
  const saved = sessionStorage.getItem('sb_rep');
  if (saved) { selectedRep = JSON.parse(saved); showDashboard(); }
  document.getElementById('dash-date').textContent = new Date().toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric',year:'numeric'});
}

function renderRepGrid() {
  document.getElementById('rep-grid').innerHTML = REPS.map((r,i)=>`
    <button class="rep-btn" onclick="selectRep(${i})" id="rep-${i}">
      <div class="rep-avatar">${r.initials}</div>
      <div class="rep-btn-name">${r.name}</div>
      <div class="rep-btn-role">${r.role}</div>
    </button>`).join('');
}

function selectRep(i) {
  selectedRep = REPS[i];
  document.querySelectorAll('.rep-btn').forEach(b=>b.classList.remove('selected'));
  document.getElementById('rep-'+i).classList.add('selected');
  const btn = document.getElementById('next-btn');
  btn.style.opacity='1'; btn.style.pointerEvents='auto';
}

function goToPin() {
  if (!selectedRep) return;
  document.getElementById('step-name').style.display='none';
  document.getElementById('step-pin').classList.add('show');
  document.getElementById('pin-sub').textContent=`Welcome, ${selectedRep.name.split(' ')[0]}. Enter your PIN.`;
  pinEntry=''; updateDots();
}
function goBackToName() {
  document.getElementById('step-name').style.display='block';
  document.getElementById('step-pin').classList.remove('show');
  pinEntry=''; updateDots();
  document.getElementById('pin-error').textContent='';
}
function pinPress(d) {
  if (pinEntry.length>=4) return;
  pinEntry+=d; updateDots();
  if (pinEntry.length===4) setTimeout(checkPin,120);
}
function pinDelete() { pinEntry=pinEntry.slice(0,-1); updateDots(); document.getElementById('pin-error').textContent=''; }
function updateDots() {
  for(let i=0;i<4;i++){const dot=document.getElementById('dot-'+i);dot.classList.toggle('filled',i<pinEntry.length);dot.classList.remove('error');}
}
function checkPin() {
  if (pinEntry===selectedRep.pin) {
    sessionStorage.setItem('sb_rep',JSON.stringify(selectedRep));
    showDashboard();
  } else {
    for(let i=0;i<4;i++){const dot=document.getElementById('dot-'+i);dot.classList.remove('filled');dot.classList.add('error');}
    document.getElementById('pin-error').textContent='Incorrect PIN. Try again.';
    pinEntry=''; setTimeout(()=>{updateDots();},600);
  }
}

function showDashboard() {
  document.getElementById('screen-login').classList.remove('active');
  document.getElementById('screen-dashboard').classList.add('active');
  document.getElementById('dash-avatar').textContent=selectedRep.initials;
  document.getElementById('dash-repname').textContent=selectedRep.name.split(' ')[0];
  document.getElementById('dash-fullname').textContent=selectedRep.name.toUpperCase();
  document.getElementById('dash-date').textContent=new Date().toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric',year:'numeric'});
  loadData();
}

async function loadData() {
  try {
    const [s2sRes, greetRes] = await Promise.all([
      fetch(`${SB_URL}/rest/v1/s2s_entries?select=*&submitter=eq.${encodeURIComponent(selectedRep.name)}&order=id.desc&limit=50`, {headers:H}),
      fetch(`${SB_URL}/rest/v1/greet_log?select=*&rep_name=eq.${encodeURIComponent(selectedRep.name)}&order=id.desc&limit=50`, {headers:H}),
    ]);
    const s2s = await s2sRes.json();
    const greets = await greetRes.json();

    // S2S KPIs
    const hot = s2s.filter(e=>parseInt(e.eng_score)>=8).length;
    const sold = s2s.filter(e=>e.outcome&&(e.outcome.includes('New')||e.outcome.includes('Used')||e.outcome.toLowerCase().includes('sold'))).length;
    document.getElementById('kpi-entries').textContent=s2s.length;
    document.getElementById('kpi-hot').textContent=hot;
    document.getElementById('kpi-sold').textContent=sold;

    // Greet KPIs (today)
    const today = new Date().toDateString();
    const todayGreets = greets.filter(g=>new Date(g.created_at).toDateString()===today);
    const demos = greets.filter(g=>g.outcome&&g.outcome.includes('Demo')).length;
    const appts = greets.filter(g=>g.outcome&&g.outcome.includes('Appointment')).length;
    document.getElementById('kpi-greets').textContent=todayGreets.length;
    document.getElementById('kpi-demos').textContent=demos;
    document.getElementById('kpi-appts').textContent=appts;

    // S2S list
    const s2sList = document.getElementById('s2s-list');
    if (!s2s.length) {
      s2sList.innerHTML='<div class="empty-state"><div class="empty-icon">üìã</div>No S2S entries yet.</div>';
    } else {
      s2sList.innerHTML = s2s.slice(0,8).map(e=>{
        const oc = e.outcome&&(e.outcome.includes('Sold')||e.outcome.includes('New')||e.outcome.includes('Used'))?'out-sold':e.outcome==='Appointment Set'?'out-appt':e.outcome&&e.outcome.includes('Follow')?'out-follow':'out-other';
        return `<div class="entry-card"><div><div class="entry-name">${e.first_name||''} ${e.last_name||''}</div><div class="entry-meta">${e.veh_year||''} ${e.veh_make||''} ${e.veh_model||''} ¬∑ ${e.timestamp?e.timestamp.split(' at ')[0]:'‚Äî'}</div></div><div style="text-align:right;"><div class="entry-outcome ${oc}">${e.outcome||'‚Äî'}</div><div class="entry-temp">üå° ${e.eng_score||'‚Äî'}/10</div></div></div>`;
      }).join('');
    }

    // Greet list
    const greetList = document.getElementById('greet-list');
    if (!greets.length) {
      greetList.innerHTML='<div class="empty-state"><div class="empty-icon">ü§ù</div>No greets logged yet. Tap the button above to log your first up.</div>';
    } else {
      greetList.innerHTML = greets.slice(0,8).map(g=>`
        <div class="greet-card">
          <div>
            <div class="greet-source">${g.up_source||'‚Äî'}</div>
            <div class="greet-name">${g.customer_name||'Walk-In'}</div>
            <div class="greet-meta">${g.voi_type||''} ${g.voi?'¬∑ '+g.voi:''} ¬∑ ${new Date(g.created_at).toLocaleString('en-US',{month:'short',day:'numeric',hour:'numeric',minute:'2-digit'})}</div>
          </div>
          <div class="greet-outcome">${g.outcome||'‚Äî'}</div>
        </div>`).join('');
    }
  } catch(e) {
    document.getElementById('kpi-entries').textContent='‚Äî';
  }
}

function doLogout() { sessionStorage.removeItem('sb_rep'); location.reload(); }
init();
</script>
</body>
</html>
