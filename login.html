<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ServiceBridge — Gallatin CDJR</title>

<meta property="og:type" content="website">
<meta property="og:url" content="https://servicebridge.vyaxis.com/login.html">
<meta property="og:title" content="ServiceBridge — Vyaxis">
<meta property="og:description" content="Service → Sales Platform. Log S2S contacts, track hot leads, and view your personal performance dashboard.">
<meta property="og:image" content="https://res.cloudinary.com/di5ujiwjp/image/upload/v1771987751/servicebridge-preview_fynjod.png">
<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="630">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://res.cloudinary.com/di5ujiwjp/image/upload/v1771987751/servicebridge-preview_fynjod.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0A0A0F">

<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --ink: #0A0A0F; --ink2: #111118;
  --purple: #6366F1; --purple-light: #818CF8; --purple-glow: rgba(91,79,232,0.35);
  --red: #C8102E; --red-glow: rgba(200,16,46,0.25);
  --gold: #E8B84B; --green: #22C55E;
  --surface: #16161F; --surface2: #1C1C27;
  --border: rgba(255,255,255,0.08); --border-bright: rgba(255,255,255,0.15);
  --text: #F0EEF8; --muted: rgba(240,238,248,0.45); --muted2: rgba(240,238,248,0.25);
  --r: 12px;
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
body { background: var(--ink); color: var(--text); font-family: 'DM Sans', sans-serif; min-height: 100vh; overflow-x: hidden; -webkit-font-smoothing: antialiased; }

.bg-grid { position:fixed;inset:0;z-index:0;background-image:linear-gradient(rgba(255,255,255,0.03) 1px,transparent 1px),linear-gradient(90deg,rgba(255,255,255,0.03) 1px,transparent 1px);background-size:48px 48px;pointer-events:none; }
.bg-orb1 { position:fixed;top:-200px;right:-200px;width:600px;height:600px;border-radius:50%;background:radial-gradient(circle,rgba(91,79,232,0.18) 0%,transparent 70%);pointer-events:none;z-index:0; }
.bg-orb2 { position:fixed;bottom:-200px;left:-100px;width:500px;height:500px;border-radius:50%;background:radial-gradient(circle,rgba(200,16,46,0.12) 0%,transparent 70%);pointer-events:none;z-index:0; }

.screen { display:none;position:relative;z-index:1; }
.screen.active { display:flex; }

#screen-login { min-height:100vh;flex-direction:column;align-items:center;justify-content:center;padding:24px; }

.brand-lockup { text-align:center;margin-bottom:48px;animation:fadeDown 0.6s ease both; }
.brand-powered { font-size:10px;font-weight:600;letter-spacing:0.18em;text-transform:uppercase;color:var(--muted2);margin-bottom:10px; }
.brand-name { font-family:'Bebas Neue',sans-serif;font-size:52px;letter-spacing:0.04em;background:linear-gradient(135deg,#fff 0%,rgba(255,255,255,0.6) 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;line-height:1; }
.brand-product { display:inline-flex;align-items:center;gap:8px;margin-top:10px;background:linear-gradient(135deg,var(--purple),var(--purple-light));-webkit-background-clip:text;-webkit-text-fill-color:transparent;font-family:'Bebas Neue',sans-serif;font-size:28px;letter-spacing:0.08em; }
.brand-dealer { font-size:11px;font-weight:500;color:var(--muted);margin-top:6px;letter-spacing:0.06em; }

.login-card { background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:40px 36px;width:100%;max-width:420px;box-shadow:0 32px 80px rgba(0,0,0,0.5);animation:fadeUp 0.6s 0.1s ease both;position:relative;overflow:hidden; }
.login-card::before { content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--purple),var(--purple-light),var(--red)); }

.card-label { font-size:10px;font-weight:600;letter-spacing:0.18em;text-transform:uppercase;color:var(--muted);margin-bottom:18px; }
.card-title { font-family:'DM Sans',sans-serif;font-size:22px;font-weight:700;margin-bottom:6px; }
.card-sub { font-size:13px;color:var(--muted);margin-bottom:32px;line-height:1.5; }

.rep-grid { display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:28px; }
.rep-btn { background:var(--surface2);border:1.5px solid var(--border);border-radius:var(--r);padding:14px 12px;cursor:pointer;transition:all 0.18s;text-align:left;position:relative;overflow:hidden; }
.rep-btn:hover { border-color:var(--border-bright);background:rgba(255,255,255,0.06); }
.rep-btn.selected { border-color:var(--purple);background:rgba(91,79,232,0.12);box-shadow:0 0 0 1px var(--purple); }
.rep-btn.selected::after { content:'✓';position:absolute;top:8px;right:10px;font-size:11px;color:var(--purple);font-weight:700; }
.rep-avatar { width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,var(--purple),var(--purple-light));display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:#fff;margin-bottom:8px; }
.rep-btn.selected .rep-avatar { background:linear-gradient(135deg,var(--purple),var(--red)); }
.rep-btn-name { font-size:13px;font-weight:600;color:var(--text);line-height:1.2; }
.rep-btn-role { font-size:10px;margin-top:2px;font-weight:600;letter-spacing:0.04em; }
.role-admin   { color: var(--gold); }
.role-manager { color: var(--purple-light); }
.role-sales   { color: var(--muted); }

.pin-section { display:none; }
.pin-section.show { display:block; }
.pin-dots { display:flex;gap:10px;justify-content:center;margin-bottom:20px; }
.pin-dot { width:14px;height:14px;border-radius:50%;border:2px solid var(--border-bright);transition:all 0.15s; }
.pin-dot.filled { background:var(--purple);border-color:var(--purple);box-shadow:0 0 8px var(--purple-glow); }
.pin-dot.error { background:var(--red);border-color:var(--red);animation:shake 0.3s ease; }
.pin-pad { display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:16px; }
.pin-key { background:var(--surface2);border:1px solid var(--border);border-radius:10px;height:52px;font-family:'DM Sans',sans-serif;font-size:18px;font-weight:600;color:var(--text);cursor:pointer;transition:all 0.12s;display:flex;align-items:center;justify-content:center;-webkit-tap-highlight-color:transparent;user-select:none; }
.pin-key:hover { background:rgba(255,255,255,0.08);border-color:var(--border-bright); }
.pin-key:active { transform:scale(0.94);background:rgba(91,79,232,0.2);border-color:var(--purple); }
.pin-key.disabled { opacity:0.4;pointer-events:none; }
.pin-error { text-align:center;font-size:12px;color:#FC8181;font-weight:500;min-height:18px;margin-bottom:8px; }

/* Loading states */
.loading-grid { display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:28px; }
.loading-card { background:var(--surface2);border:1.5px solid var(--border);border-radius:var(--r);padding:14px 12px;height:90px;position:relative;overflow:hidden; }
.loading-card::after { content:'';position:absolute;inset:0;background:linear-gradient(90deg,transparent 0%,rgba(255,255,255,0.04) 50%,transparent 100%);animation:shimmer 1.5s infinite; }
.loading-text { text-align:center;font-size:13px;color:var(--muted);padding:20px 0; }
.error-box { background:rgba(200,16,46,0.1);border:1px solid rgba(200,16,46,0.25);border-radius:var(--r);padding:16px;text-align:center;margin-bottom:20px; }
.error-box p { font-size:13px;color:#FC8181;margin-bottom:10px; }
.error-box button { background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:8px 20px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:12px;font-weight:600;cursor:pointer; }

.spinner { display:inline-block;width:16px;height:16px;border:2px solid rgba(255,255,255,0.2);border-top-color:white;border-radius:50%;animation:spin 0.6s linear infinite;vertical-align:middle;margin-right:6px; }

@keyframes fadeUp{from{opacity:0;transform:translateY(16px);}to{opacity:1;transform:translateY(0);}}
@keyframes fadeDown{from{opacity:0;transform:translateY(-12px);}to{opacity:1;transform:translateY(0);}}
@keyframes shake{0%,100%{transform:translateX(0);}25%{transform:translateX(-6px);}75%{transform:translateX(6px);}}
@keyframes shimmer{0%{transform:translateX(-100%);}100%{transform:translateX(100%);}}
@keyframes spin{to{transform:rotate(360deg);}}
</style>
</head>
<body>
<div class="bg-grid"></div>
<div class="bg-orb1"></div>
<div class="bg-orb2"></div>

<div class="screen active" id="screen-login">
  <div style="width:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;padding:24px;">
    <div class="brand-lockup">
      <div class="brand-powered">Powered by Vyaxis</div>
      <div class="brand-name">GALLATIN CDJR</div>
      <div class="brand-product">⚡ ServiceBridge</div>
      <div class="brand-dealer">Service → Sales Platform · S2S Team Access</div>
    </div>
    <div class="login-card">
      <div id="step-name">
        <div class="card-label">Step 1 of 2</div>
        <div class="card-title">Who are you?</div>
        <div class="card-sub">Select your name to continue</div>
        <div id="rep-grid-container">
          <!-- Loading skeleton shown until reps load -->
          <div class="loading-grid" id="rep-loading">
            <div class="loading-card"></div><div class="loading-card"></div>
            <div class="loading-card"></div><div class="loading-card"></div>
          </div>
          <div class="rep-grid" id="rep-grid" style="display:none;"></div>
          <div id="rep-error" style="display:none;"></div>
        </div>
        <button onclick="goToPin()" id="next-btn" style="width:100%;background:linear-gradient(135deg,var(--purple),var(--purple-light));border:none;border-radius:10px;color:#fff;font-family:'DM Sans',sans-serif;font-size:14px;font-weight:700;padding:14px;cursor:pointer;transition:all 0.18s;opacity:0.4;pointer-events:none;letter-spacing:0.04em;">Continue →</button>
      </div>
      <div id="step-pin" class="pin-section">
        <div class="card-label">Step 2 of 2</div>
        <div class="card-title">Enter your PIN</div>
        <div class="card-sub" id="pin-sub">Enter your 4-digit PIN</div>
        <div class="pin-dots">
          <div class="pin-dot" id="dot-0"></div><div class="pin-dot" id="dot-1"></div>
          <div class="pin-dot" id="dot-2"></div><div class="pin-dot" id="dot-3"></div>
        </div>
        <div class="pin-pad" id="pin-pad">
          <button class="pin-key" onclick="pinPress('1')">1</button><button class="pin-key" onclick="pinPress('2')">2</button><button class="pin-key" onclick="pinPress('3')">3</button>
          <button class="pin-key" onclick="pinPress('4')">4</button><button class="pin-key" onclick="pinPress('5')">5</button><button class="pin-key" onclick="pinPress('6')">6</button>
          <button class="pin-key" onclick="pinPress('7')">7</button><button class="pin-key" onclick="pinPress('8')">8</button><button class="pin-key" onclick="pinPress('9')">9</button>
          <button class="pin-key" onclick="goBackToName()">←</button><button class="pin-key" onclick="pinPress('0')">0</button><button class="pin-key" onclick="pinDelete()">⌫</button>
        </div>
        <div class="pin-error" id="pin-error"></div>
      </div>
    </div>
  </div>
</div>

<script>
// ── Config ──────────────────────────────────────────────────
const SUPABASE_URL  = 'https://jbkgwtohwsbaorhvuuqb.supabase.co';
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impia2d3dG9od3NiYW9yaHZ1dXFiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkwNTI0NzksImV4cCI6MjA2NDYyODQ3OX0.a3SZsBz5hm3yBa3PbbTs_-mCAGkHT5KM_r7JRM-JIeQ';
const AUTH_ENDPOINT = SUPABASE_URL + '/functions/v1/auth';

const ROLE_REDIRECT = {
  admin:   'admin-panel.html',
  manager: 'manager-dashboard.html',
  sales:   'app.html'
};

// ── State ───────────────────────────────────────────────────
let reps = [];
let selectedRep = null;
let pinEntry = '';
let isAuthenticating = false;

// ── Init ────────────────────────────────────────────────────
async function init() {
  // If already logged in, redirect
  const existing = JSON.parse(sessionStorage.getItem('sb_rep') || 'null');
  if (existing && existing.name && existing.role) {
    window.location.replace(ROLE_REDIRECT[existing.role.toLowerCase()] || 'app.html');
    return;
  }
  await loadReps();
}

// ── Fetch active reps from Supabase (public view, no secrets) ──
async function loadReps() {
  const loadingEl = document.getElementById('rep-loading');
  const gridEl    = document.getElementById('rep-grid');
  const errorEl   = document.getElementById('rep-error');

  loadingEl.style.display = '';
  gridEl.style.display = 'none';
  errorEl.style.display = 'none';

  try {
    const res = await fetch(
      SUPABASE_URL + '/rest/v1/sb_users_public?select=id,name,first_name,role&order=role.asc,name.asc',
      {
        headers: {
          'apikey': SUPABASE_ANON,
          'Authorization': 'Bearer ' + SUPABASE_ANON,
        }
      }
    );

    if (!res.ok) throw new Error('HTTP ' + res.status);

    reps = await res.json();
    if (!reps || reps.length === 0) throw new Error('No active users found');

    renderRepGrid();
    loadingEl.style.display = 'none';
    gridEl.style.display = '';
  } catch (err) {
    console.error('Failed to load reps:', err);
    loadingEl.style.display = 'none';
    errorEl.style.display = '';
    errorEl.innerHTML = '<div class="error-box"><p>Unable to load team members. Check your connection.</p><button onclick="loadReps()">Retry</button></div>';
  }
}

// ── Render ──────────────────────────────────────────────────
function getInitials(name) {
  const parts = name.trim().split(/\s+/);
  if (parts.length === 1) return parts[0].substring(0, 2).toUpperCase();
  return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
}

function getRoleClass(role) {
  const r = role.toLowerCase();
  if (r === 'admin')   return 'role-admin';
  if (r === 'manager') return 'role-manager';
  return 'role-sales';
}

function renderRepGrid() {
  const grid = document.getElementById('rep-grid');
  grid.innerHTML = reps.map((r, i) => `
    <button class="rep-btn" onclick="selectRep(${i})" id="rep-${i}">
      <div class="rep-avatar">${getInitials(r.name)}</div>
      <div class="rep-btn-name">${r.name}</div>
      <div class="rep-btn-role ${getRoleClass(r.role)}">${r.role.charAt(0).toUpperCase() + r.role.slice(1)}</div>
    </button>`).join('');
}

function selectRep(i) {
  selectedRep = reps[i];
  document.querySelectorAll('.rep-btn').forEach(b => b.classList.remove('selected'));
  document.getElementById('rep-' + i).classList.add('selected');
  const btn = document.getElementById('next-btn');
  btn.style.opacity = '1';
  btn.style.pointerEvents = 'auto';
}

// ── PIN Flow ────────────────────────────────────────────────
function goToPin() {
  if (!selectedRep) return;
  document.getElementById('step-name').style.display = 'none';
  document.getElementById('step-pin').classList.add('show');
  document.getElementById('pin-sub').textContent = 'Welcome, ' + selectedRep.first_name + '. Enter your PIN.';
  pinEntry = '';
  updateDots();
  document.getElementById('pin-error').textContent = '';
  setPinPadEnabled(true);
}

function goBackToName() {
  if (isAuthenticating) return;
  document.getElementById('step-name').style.display = 'block';
  document.getElementById('step-pin').classList.remove('show');
  pinEntry = '';
  updateDots();
  document.getElementById('pin-error').textContent = '';
}

function pinPress(d) {
  if (isAuthenticating || pinEntry.length >= 4) return;
  pinEntry += d;
  updateDots();
  if (pinEntry.length === 4) setTimeout(authenticate, 120);
}

function pinDelete() {
  if (isAuthenticating) return;
  pinEntry = pinEntry.slice(0, -1);
  updateDots();
  document.getElementById('pin-error').textContent = '';
}

function updateDots() {
  for (let i = 0; i < 4; i++) {
    const dot = document.getElementById('dot-' + i);
    dot.classList.toggle('filled', i < pinEntry.length);
    dot.classList.remove('error');
  }
}

function setPinPadEnabled(enabled) {
  document.querySelectorAll('#pin-pad .pin-key').forEach(k => {
    k.classList.toggle('disabled', !enabled);
  });
}

function showPinError(msg) {
  for (let i = 0; i < 4; i++) {
    const dot = document.getElementById('dot-' + i);
    dot.classList.remove('filled');
    dot.classList.add('error');
  }
  document.getElementById('pin-error').textContent = msg;
  pinEntry = '';
  setTimeout(() => { updateDots(); }, 600);
}

// ── Server-side authentication ──────────────────────────────
async function authenticate() {
  if (isAuthenticating) return;
  isAuthenticating = true;
  setPinPadEnabled(false);
  document.getElementById('pin-error').innerHTML = '<span class="spinner"></span> Verifying…';

  try {
    const res = await fetch(AUTH_ENDPOINT, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        name: selectedRep.name,
        pin: pinEntry
      })
    });

    const data = await res.json();

    if (res.ok && data.success) {
      // Store session — no secrets, just identity
      sessionStorage.setItem('sb_rep', JSON.stringify({
        id:         data.user.id,
        name:       data.user.name,
        first_name: data.user.first_name,
        role:       data.user.role,
      }));

      // Determine redirect
      const dest = ROLE_REDIRECT[data.user.role] || 'app.html';
      window.location.href = dest;
      return;
    }

    // Handle specific error codes
    if (res.status === 403) {
      showPinError(data.error || 'Account deactivated.');
    } else if (res.status === 401) {
      showPinError('Incorrect PIN. Try again.');
    } else {
      showPinError(data.error || 'Login failed. Try again.');
    }
  } catch (err) {
    console.error('Auth fetch error:', err);
    showPinError('Connection error. Check your network.');
  } finally {
    isAuthenticating = false;
    setPinPadEnabled(true);
  }
}

// ── Keyboard support (desktop) ──────────────────────────────
document.addEventListener('keydown', function(e) {
  const pinVisible = document.getElementById('step-pin').classList.contains('show');
  if (!pinVisible) return;
  if (e.key >= '0' && e.key <= '9') pinPress(e.key);
  else if (e.key === 'Backspace') pinDelete();
  else if (e.key === 'Escape') goBackToName();
});

init();
</script>
</body>
</html>
