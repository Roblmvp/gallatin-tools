<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ServiceBridge — Gallatin CDJR</title>
<meta property="og:type" content="website">
<meta property="og:url" content="https://servicebridge.vyaxis.com/login.html">
<meta property="og:title" content="ServiceBridge — Vyaxis">
<meta property="og:description" content="Service → Sales Platform. Log S2S contacts, track hot leads, and view your personal performance dashboard.">
<meta property="og:image" content="https://res.cloudinary.com/di5ujiwjp/image/upload/v1771987751/servicebridge-preview_fynjod.png">
<meta property="og:image:width" content="1200"><meta property="og:image:height" content="630">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://res.cloudinary.com/di5ujiwjp/image/upload/v1771987751/servicebridge-preview_fynjod.png">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --ink: #0A0A0F; --ink2: #111118;
  --purple: #6366F1; --purple-light: #818CF8; --purple-glow: rgba(91,79,232,0.35);
  --red: #C8102E; --red-glow: rgba(200,16,46,0.25);
  --gold: #E8B84B; --green: #22C55E;
  --surface: #16161F; --surface2: #1C1C27;
  --border: rgba(255,255,255,0.08); --border-bright: rgba(255,255,255,0.15);
  --text: #F0EEF8; --muted: rgba(240,238,248,0.45); --muted2: rgba(240,238,248,0.25);
  --r: 12px;
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
body { background: var(--ink); color: var(--text); font-family: 'DM Sans', sans-serif; min-height: 100vh; overflow-x: hidden; -webkit-font-smoothing: antialiased; }

.bg-grid { position:fixed;inset:0;z-index:0;background-image:linear-gradient(rgba(255,255,255,0.03) 1px,transparent 1px),linear-gradient(90deg,rgba(255,255,255,0.03) 1px,transparent 1px);background-size:48px 48px;pointer-events:none; }
.bg-orb1 { position:fixed;top:-200px;right:-200px;width:600px;height:600px;border-radius:50%;background:radial-gradient(circle,rgba(91,79,232,0.18) 0%,transparent 70%);pointer-events:none;z-index:0; }
.bg-orb2 { position:fixed;bottom:-200px;left:-100px;width:500px;height:500px;border-radius:50%;background:radial-gradient(circle,rgba(200,16,46,0.12) 0%,transparent 70%);pointer-events:none;z-index:0; }

.page-wrap { display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;padding:24px;position:relative;z-index:1; }

/* ── BRAND ── */
.brand-lockup { text-align:center;margin-bottom:48px;animation:fadeDown 0.6s ease both; }
.brand-powered { font-size:10px;font-weight:600;letter-spacing:0.18em;text-transform:uppercase;color:var(--muted2);margin-bottom:10px; }
.brand-name { font-family:'Bebas Neue',sans-serif;font-size:52px;letter-spacing:0.04em;background:linear-gradient(135deg,#fff 0%,rgba(255,255,255,0.6) 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;line-height:1; }
.brand-product { display:inline-flex;align-items:center;gap:8px;margin-top:10px;background:linear-gradient(135deg,var(--purple),var(--purple-light));-webkit-background-clip:text;-webkit-text-fill-color:transparent;font-family:'Bebas Neue',sans-serif;font-size:28px;letter-spacing:0.08em; }
.brand-dealer { font-size:11px;font-weight:500;color:var(--muted);margin-top:6px;letter-spacing:0.06em; }

/* ── CARD ── */
.login-card { background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:40px 36px;width:100%;max-width:440px;box-shadow:0 32px 80px rgba(0,0,0,0.5);animation:fadeUp 0.6s 0.1s ease both;position:relative;overflow:hidden; }
.login-card::before { content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--purple),var(--purple-light),var(--red)); }

.step-label { font-size:10px;font-weight:600;letter-spacing:0.18em;text-transform:uppercase;color:var(--muted);margin-bottom:18px;display:flex;align-items:center;gap:8px; }
.step-label .step-badge { background:rgba(99,102,241,0.15);color:var(--purple-light);padding:2px 8px;border-radius:10px;font-size:9px;font-weight:700; }
.card-title { font-size:22px;font-weight:700;margin-bottom:6px; }
.card-sub { font-size:13px;color:var(--muted);margin-bottom:28px;line-height:1.5; }

/* ── TABS (Email vs PIN) ── */
.login-tabs { display:flex;gap:0;margin-bottom:28px;border-radius:var(--r);overflow:hidden;border:1px solid var(--border); }
.login-tab { flex:1;padding:10px;text-align:center;font-size:12px;font-weight:700;letter-spacing:0.04em;color:var(--muted);cursor:pointer;transition:all 0.18s;background:transparent; }
.login-tab.active { background:rgba(99,102,241,0.15);color:var(--purple-light); }
.login-tab:hover:not(.active) { background:rgba(255,255,255,0.03); }

/* ── FORM INPUTS ── */
.form-field { margin-bottom:18px; }
.form-label { display:block;font-size:10px;font-weight:700;letter-spacing:0.12em;text-transform:uppercase;color:var(--muted);margin-bottom:8px; }
.form-input {
  width:100%;padding:12px 16px;
  background:var(--surface2);border:1.5px solid var(--border-bright);border-radius:var(--r);
  font-family:'DM Sans',sans-serif;font-size:14px;color:var(--text);
  transition:border-color 0.18s,box-shadow 0.18s;
  outline:none;
}
.form-input:focus { border-color:var(--purple);box-shadow:0 0 0 3px var(--purple-glow); }
.form-input::placeholder { color:var(--muted2); }
.form-input.error { border-color:var(--red);box-shadow:0 0 0 3px var(--red-glow); }

.form-row { display:flex;gap:12px; }
.form-row .form-field { flex:1; }

/* ── BUTTONS ── */
.btn-primary {
  width:100%;padding:14px;border:none;border-radius:var(--r);
  background:linear-gradient(135deg,var(--purple),var(--purple-light));
  color:#fff;font-family:'DM Sans',sans-serif;font-size:14px;font-weight:700;
  cursor:pointer;transition:all 0.18s;letter-spacing:0.04em;
  display:flex;align-items:center;justify-content:center;gap:8px;
}
.btn-primary:hover { filter:brightness(1.1);transform:translateY(-1px); }
.btn-primary:active { transform:scale(0.98); }
.btn-primary:disabled { opacity:0.4;cursor:not-allowed;filter:none;transform:none; }

.btn-secondary {
  width:100%;padding:12px;border:1.5px solid var(--border-bright);border-radius:var(--r);
  background:transparent;color:var(--muted);font-family:'DM Sans',sans-serif;
  font-size:13px;font-weight:600;cursor:pointer;transition:all 0.18s;
  margin-top:10px;
}
.btn-secondary:hover { border-color:var(--purple);color:var(--purple-light); }

.text-link { font-size:12px;color:var(--purple-light);text-decoration:none;font-weight:600;cursor:pointer;transition:color 0.15s; }
.text-link:hover { color:#A5B4FC; }

/* ── ERROR / SUCCESS ── */
.msg-box { padding:12px 16px;border-radius:var(--r);font-size:12px;font-weight:600;margin-bottom:18px;display:none; }
.msg-box.show { display:block; }
.msg-box.error { background:rgba(200,16,46,0.12);color:#FC8181;border:1px solid rgba(200,16,46,0.2); }
.msg-box.success { background:rgba(34,197,94,0.12);color:#86EFAC;border:1px solid rgba(34,197,94,0.2); }
.msg-box.info { background:rgba(99,102,241,0.12);color:#A5B4FC;border:1px solid rgba(99,102,241,0.2); }

/* ── USER SELECT GRID (legacy mode) ── */
.rep-grid { display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:28px; }
.rep-btn { background:var(--surface2);border:1.5px solid var(--border);border-radius:var(--r);padding:14px 12px;cursor:pointer;transition:all 0.18s;text-align:left;position:relative;overflow:hidden; }
.rep-btn:hover { border-color:var(--border-bright);background:rgba(255,255,255,0.06); }
.rep-btn.selected { border-color:var(--purple);background:rgba(91,79,232,0.12);box-shadow:0 0 0 1px var(--purple); }
.rep-btn.selected::after { content:'✓';position:absolute;top:8px;right:10px;font-size:11px;color:var(--purple);font-weight:700; }
.rep-avatar { width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:#fff;margin-bottom:8px; }
.rep-avatar.role-admin { background:linear-gradient(135deg,var(--purple),#4338CA); }
.rep-avatar.role-manager,.rep-avatar.role-s2s-manager { background:linear-gradient(135deg,var(--gold),#D97706); }
.rep-avatar.role-sales { background:linear-gradient(135deg,#059669,#10B981); }
.rep-avatar.role-finance-manager { background:linear-gradient(135deg,#1E3A8A,#3B82F6); }
.rep-btn-name { font-size:13px;font-weight:600;color:var(--text);line-height:1.2; }
.rep-btn-role { font-size:10px;margin-top:2px;font-weight:600;letter-spacing:0.04em; }
.role-admin   { color: var(--purple-light); }
.role-manager,.role-s2s-manager { color: var(--gold); }
.role-sales   { color: var(--muted); }
.role-finance-manager { color: #60A5FA; }

/* ── PIN PAD ── */
.pin-section { display:none; }
.pin-section.show { display:block; }
.pin-dots { display:flex;gap:10px;justify-content:center;margin-bottom:20px; }
.pin-dot { width:14px;height:14px;border-radius:50%;border:2px solid var(--border-bright);transition:all 0.15s; }
.pin-dot.filled { background:var(--purple);border-color:var(--purple);box-shadow:0 0 8px var(--purple-glow); }
.pin-dot.error { background:var(--red);border-color:var(--red);animation:shake 0.3s ease; }
.pin-pad { display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:16px; }
.pin-key { background:var(--surface2);border:1px solid var(--border);border-radius:10px;height:52px;font-family:'DM Sans',sans-serif;font-size:18px;font-weight:600;color:var(--text);cursor:pointer;transition:all 0.12s;display:flex;align-items:center;justify-content:center;user-select:none; }
.pin-key:hover { background:rgba(255,255,255,0.08);border-color:var(--border-bright); }
.pin-key:active { transform:scale(0.94);background:rgba(91,79,232,0.2);border-color:var(--purple); }
.pin-error { text-align:center;font-size:12px;color:#FC8181;font-weight:500;height:18px;margin-bottom:8px; }

/* ── 2FA CODE INPUT ── */
.code-inputs { display:flex;gap:8px;justify-content:center;margin-bottom:24px; }
.code-digit {
  width:48px;height:56px;text-align:center;
  background:var(--surface2);border:1.5px solid var(--border-bright);border-radius:var(--r);
  font-family:'DM Mono',monospace;font-size:22px;font-weight:700;color:var(--text);
  outline:none;transition:border-color 0.18s,box-shadow 0.18s;
}
.code-digit:focus { border-color:var(--purple);box-shadow:0 0 0 3px var(--purple-glow); }

/* ── LOADING ── */
.btn-loading { position:relative;color:transparent!important; }
.btn-loading::after {
  content:'';position:absolute;width:20px;height:20px;
  border:2px solid rgba(255,255,255,0.3);border-top-color:#fff;
  border-radius:50%;animation:spin 0.6s linear infinite;
}
@keyframes spin { to { transform:rotate(360deg); } }

/* ── STEP TRANSITIONS ── */
.step { display:none; }
.step.active { display:block;animation:fadeUp 0.3s ease both; }

/* ── DIVIDER ── */
.divider { display:flex;align-items:center;gap:12px;margin:24px 0; }
.divider::before,.divider::after { content:'';flex:1;height:1px;background:var(--border); }
.divider span { font-size:11px;font-weight:600;color:var(--muted2);letter-spacing:0.06em; }

/* ── ANIMATIONS ── */
@keyframes fadeUp { from { opacity:0;transform:translateY(16px); } to { opacity:1;transform:translateY(0); } }
@keyframes fadeDown { from { opacity:0;transform:translateY(-12px); } to { opacity:1;transform:translateY(0); } }
@keyframes shake { 0%,100%{transform:translateX(0);}25%{transform:translateX(-6px);}75%{transform:translateX(6px);} }

/* ── RESPONSIVE ── */
@media(max-width:480px) {
  .brand-name { font-size:40px; }
  .brand-product { font-size:22px; }
  .login-card { padding:32px 24px; }
  .code-digit { width:42px;height:50px;font-size:20px; }
}
</style>
</head>
<body>
<div class="bg-grid"></div>
<div class="bg-orb1"></div>
<div class="bg-orb2"></div>

<div class="page-wrap">
  <div class="brand-lockup">
    <div class="brand-powered">Powered by Vyaxis</div>
    <div class="brand-name">GALLATIN CDJR</div>
    <div class="brand-product">⚡ ServiceBridge</div>
    <div class="brand-dealer">Service → Sales Platform · S2S Team Access</div>
  </div>

  <div class="login-card">
    <!-- ══ STEP 1: LOGIN METHOD ══ -->
    <div class="step active" id="step-login">
      <div class="step-label"><span class="step-badge">Secure Login</span></div>
      <div class="card-title">Sign in</div>
      <div class="card-sub">Enter your email and password to access ServiceBridge.</div>

      <div class="msg-box" id="login-msg"></div>

      <div class="form-field">
        <label class="form-label">Email</label>
        <input class="form-input" id="login-email" type="email" placeholder="name@gallatincdjr.com" autocomplete="email" autofocus>
      </div>
      <div class="form-field">
        <label class="form-label">Password</label>
        <input class="form-input" id="login-password" type="password" placeholder="Enter your password" autocomplete="current-password">
      </div>

      <div style="display:flex;justify-content:flex-end;margin-bottom:20px;">
        <span class="text-link" onclick="showStep('step-forgot')">Forgot password?</span>
      </div>

      <button class="btn-primary" id="btn-login" onclick="doEmailLogin()">Sign In →</button>

      <div class="divider"><span>or</span></div>

      <button class="btn-secondary" onclick="showStep('step-pin-select')">Sign in with PIN (legacy)</button>
    </div>

    <!-- ══ STEP 2: 2FA VERIFICATION ══ -->
    <div class="step" id="step-2fa">
      <div class="step-label"><span class="step-badge">2-Factor Auth</span></div>
      <div class="card-title">Verify your identity</div>
      <div class="card-sub" id="2fa-sub">We sent a 6-digit code to your phone ending in ****1234.</div>

      <div class="msg-box" id="2fa-msg"></div>

      <div class="code-inputs">
        <input class="code-digit" id="code-0" type="text" maxlength="1" inputmode="numeric" autocomplete="one-time-code">
        <input class="code-digit" id="code-1" type="text" maxlength="1" inputmode="numeric">
        <input class="code-digit" id="code-2" type="text" maxlength="1" inputmode="numeric">
        <input class="code-digit" id="code-3" type="text" maxlength="1" inputmode="numeric">
        <input class="code-digit" id="code-4" type="text" maxlength="1" inputmode="numeric">
        <input class="code-digit" id="code-5" type="text" maxlength="1" inputmode="numeric">
      </div>

      <button class="btn-primary" id="btn-verify" onclick="verify2FA()">Verify →</button>

      <div style="text-align:center;margin-top:16px;">
        <span class="text-link" id="resend-link" onclick="resend2FA()">Resend code</span>
        <span style="color:var(--muted2);font-size:11px;margin-left:8px;" id="resend-timer"></span>
      </div>

      <button class="btn-secondary" onclick="showStep('step-login')">← Back to sign in</button>
    </div>

    <!-- ══ STEP 3: FORGOT PASSWORD ══ -->
    <div class="step" id="step-forgot">
      <div class="step-label"><span class="step-badge">Password Reset</span></div>
      <div class="card-title">Reset your password</div>
      <div class="card-sub">Enter your email and we'll send you a link to create a new password.</div>

      <div class="msg-box" id="forgot-msg"></div>

      <div class="form-field">
        <label class="form-label">Email</label>
        <input class="form-input" id="forgot-email" type="email" placeholder="name@gallatincdjr.com">
      </div>

      <button class="btn-primary" onclick="doForgotPassword()">Send Reset Link →</button>
      <button class="btn-secondary" onclick="showStep('step-login')">← Back to sign in</button>
    </div>

    <!-- ══ STEP 4: SET NEW PASSWORD (first login / reset) ══ -->
    <div class="step" id="step-set-password">
      <div class="step-label"><span class="step-badge">First Time Setup</span></div>
      <div class="card-title">Set your password</div>
      <div class="card-sub" id="set-pw-sub">Welcome! Create a secure password for your account.</div>

      <div class="msg-box" id="setpw-msg"></div>

      <div class="form-field">
        <label class="form-label">New Password</label>
        <input class="form-input" id="new-password" type="password" placeholder="At least 8 characters">
      </div>
      <div class="form-field">
        <label class="form-label">Confirm Password</label>
        <input class="form-input" id="confirm-password" type="password" placeholder="Re-enter your password">
      </div>

      <button class="btn-primary" onclick="doSetPassword()">Set Password & Continue →</button>
    </div>

    <!-- ══ STEP 5: LEGACY PIN SELECT ══ -->
    <div class="step" id="step-pin-select">
      <div class="step-label"><span class="step-badge">Legacy Login</span></div>
      <div class="card-title">Who are you?</div>
      <div class="card-sub">Select your name to continue with PIN login.</div>

      <div class="rep-grid" id="rep-grid"></div>

      <button class="btn-primary" id="next-btn" onclick="goToPin()" disabled>Continue →</button>
      <button class="btn-secondary" onclick="showStep('step-login')">← Sign in with email</button>
    </div>

    <!-- ══ STEP 6: LEGACY PIN ENTRY ══ -->
    <div class="step" id="step-pin-enter">
      <div class="step-label"><span class="step-badge">Legacy Login</span></div>
      <div class="card-title">Enter your PIN</div>
      <div class="card-sub" id="pin-sub">Enter your 4-digit PIN</div>

      <div class="pin-dots">
        <div class="pin-dot" id="dot-0"></div><div class="pin-dot" id="dot-1"></div>
        <div class="pin-dot" id="dot-2"></div><div class="pin-dot" id="dot-3"></div>
      </div>
      <div class="pin-pad">
        <button class="pin-key" onclick="pinPress('1')">1</button><button class="pin-key" onclick="pinPress('2')">2</button><button class="pin-key" onclick="pinPress('3')">3</button>
        <button class="pin-key" onclick="pinPress('4')">4</button><button class="pin-key" onclick="pinPress('5')">5</button><button class="pin-key" onclick="pinPress('6')">6</button>
        <button class="pin-key" onclick="pinPress('7')">7</button><button class="pin-key" onclick="pinPress('8')">8</button><button class="pin-key" onclick="pinPress('9')">9</button>
        <button class="pin-key" onclick="showStep('step-pin-select')">←</button><button class="pin-key" onclick="pinPress('0')">0</button><button class="pin-key" onclick="pinDelete()">⌫</button>
      </div>
      <div class="pin-error" id="pin-error"></div>
    </div>
  </div>
</div>

<script>
const SB_URL = 'https://jbkgwtohwsbaorhvuuqb.supabase.co';
const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impia2d3dG9od3NiYW9yaHZ1dXFiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5NjkwNDIsImV4cCI6MjA4NzU0NTA0Mn0.GRXOYbIuVDxU9-FEBYmyd1QmytVUrMIAxbnOSfepzuU';
const H = {'apikey':SB_KEY,'Authorization':'Bearer '+SB_KEY,'Content-Type':'application/json'};

let profiles = [];
let selectedProfile = null;
let pinEntry = '';
let pendingUser = null;
let resendCooldown = 0;

// ── Load profiles from Supabase on page load ──
async function loadProfiles() {
  try {
    const res = await fetch(SB_URL + '/rest/v1/user_profiles?active=eq.true&order=name.asc', { headers: H });
    if (res.ok) {
      profiles = await res.json();
    }
  } catch(e) {
    console.warn('Could not load profiles from Supabase, falling back to defaults');
  }
  // Fallback if table doesn't exist yet
  if (!profiles.length) {
    profiles = [
      {name:'Robert Lisowski', first_name:'Robert', initials:'RL', role:'Admin',       title:'General Sales Manager', email:'Rob.l@gallatincdjr.com', pin:'5757', two_factor_enabled:false},
      {name:'Tyler Doyle',     first_name:'Tyler',  initials:'TD', role:'S2S Manager',  title:'S2S Manager',           email:'Tyler.d@gallatincdjr.com', pin:'1234', two_factor_enabled:false},
      {name:'Andrew Kirk',     first_name:'Andrew', initials:'AK', role:'Sales',        title:'Sales Consultant',      email:'', pin:'1234', two_factor_enabled:false},
      {name:'DJ Rogers',       first_name:'DJ',     initials:'DR', role:'Sales',        title:'Sales Consultant',      email:'', pin:'1234', two_factor_enabled:false},
      {name:'Kody McCann',     first_name:'Kody',   initials:'KM', role:'Sales',        title:'Sales Consultant',      email:'', pin:'1234', two_factor_enabled:false},
      {name:'Joe Smith',       first_name:'Joe',    initials:'JS', role:'Sales',        title:'Sales Consultant',      email:'Joe.s@gallatincdjr.com', pin:'', two_factor_enabled:false},
      {name:'Dominick Ferrara',first_name:'Dominick',initials:'DF',role:'Sales',        title:'Sales Consultant',      email:'dominick.f@gallatincdjr.com', pin:'', two_factor_enabled:false},
      {name:'Mich Shelton',    first_name:'Mich',   initials:'MS', role:'Sales',        title:'Sales Consultant',      email:'Mich.s@gallatincdjr.com', pin:'', two_factor_enabled:false},
    ];
  }
  renderRepGrid();
}

// ── Step Navigation ──
function showStep(id) {
  document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
  const el = document.getElementById(id);
  if (el) el.classList.add('active');
  // Auto-focus first input
  setTimeout(() => {
    const input = el.querySelector('input:not([type="hidden"])');
    if (input) input.focus();
  }, 100);
}

function showMsg(boxId, msg, type) {
  const box = document.getElementById(boxId);
  if (!box) return;
  box.textContent = msg;
  box.className = 'msg-box show ' + type;
}

function hideMsg(boxId) {
  const box = document.getElementById(boxId);
  if (box) box.className = 'msg-box';
}

// ═══════════════════════════════════════════════════════════
//  EMAIL/PASSWORD LOGIN
// ═══════════════════════════════════════════════════════════
async function doEmailLogin() {
  const email = document.getElementById('login-email').value.trim().toLowerCase();
  const password = document.getElementById('login-password').value;
  hideMsg('login-msg');

  if (!email || !email.includes('@')) { showMsg('login-msg', 'Please enter a valid email address.', 'error'); return; }
  if (!password) { showMsg('login-msg', 'Please enter your password.', 'error'); return; }

  const btn = document.getElementById('btn-login');
  btn.classList.add('btn-loading'); btn.disabled = true;

  try {
    // Authenticate with Supabase Auth
    const res = await fetch(SB_URL + '/auth/v1/token?grant_type=password', {
      method: 'POST',
      headers: { 'apikey': SB_KEY, 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password })
    });
    const data = await res.json();

    if (!res.ok || data.error) {
      showMsg('login-msg', data.error_description || data.msg || 'Invalid email or password.', 'error');
      btn.classList.remove('btn-loading'); btn.disabled = false;
      return;
    }

    // Find matching profile
    const profile = profiles.find(p => p.email && p.email.toLowerCase() === email);
    if (!profile) {
      showMsg('login-msg', 'No ServiceBridge profile found for this email. Contact your admin.', 'error');
      btn.classList.remove('btn-loading'); btn.disabled = false;
      return;
    }

    // Check if must reset password on first login
    if (profile.must_reset_password) {
      pendingUser = { ...profile, auth_token: data.access_token };
      document.getElementById('set-pw-sub').textContent = `Welcome, ${profile.first_name}! Create a secure password for your account.`;
      btn.classList.remove('btn-loading'); btn.disabled = false;
      showStep('step-set-password');
      return;
    }

    // Check if 2FA is enabled
    if (profile.two_factor_enabled && profile.two_factor_phone) {
      pendingUser = { ...profile, auth_token: data.access_token };
      const masked = maskPhone(profile.two_factor_phone || profile.phone);
      document.getElementById('2fa-sub').textContent = `We sent a 6-digit code to your phone ending in ${masked}.`;
      btn.classList.remove('btn-loading'); btn.disabled = false;
      send2FACode(profile);
      showStep('step-2fa');
      return;
    }

    // Success — no 2FA
    completeLogin(profile, data.access_token);

  } catch(e) {
    showMsg('login-msg', 'Connection error. Please try again.', 'error');
    btn.classList.remove('btn-loading'); btn.disabled = false;
  }
}

// ═══════════════════════════════════════════════════════════
//  2FA (SMS) — Direct Twilio API + Supabase table
//  No Edge Functions required
// ═══════════════════════════════════════════════════════════
const TWILIO_SID  = 'AC5cc95b34834d0a145c3e4423b3fd8be0';
const TWILIO_TOK  = 'c872954e2df6ae422c4961caa67ef288';
const TWILIO_FROM = '+16292495579';

function generate2FACode() {
  return String(Math.floor(100000 + Math.random() * 900000));
}

async function send2FACode(profile) {
  const phone = profile.two_factor_phone || profile.phone;
  if (!phone) { console.warn('No phone for 2FA'); return; }

  // Generate code and store in Supabase
  const code = generate2FACode();
  const expiresAt = new Date(Date.now() + 5 * 60 * 1000).toISOString();

  // Delete any existing code for this user, then insert new one
  await fetch(SB_URL + '/rest/v1/two_factor_codes?user_id=eq.' + profile.id, {
    method: 'DELETE', headers: { ...H, 'Prefer': 'return=minimal' }
  }).catch(() => {});

  await fetch(SB_URL + '/rest/v1/two_factor_codes', {
    method: 'POST',
    headers: { ...H, 'Prefer': 'return=minimal' },
    body: JSON.stringify({ user_id: profile.id, code, expires_at: expiresAt, used: false })
  });

  // Send SMS via Twilio
  let toPhone = phone.replace(/\D/g, '');
  if (toPhone.length === 10) toPhone = '1' + toPhone;
  if (!toPhone.startsWith('+')) toPhone = '+' + toPhone;

  try {
    const twilioUrl = `https://api.twilio.com/2010-04-01/Accounts/${TWILIO_SID}/Messages.json`;
    await fetch(twilioUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'Authorization': 'Basic ' + btoa(TWILIO_SID + ':' + TWILIO_TOK)
      },
      body: new URLSearchParams({
        To: toPhone,
        From: TWILIO_FROM,
        Body: `Your ServiceBridge verification code is: ${code}. It expires in 5 minutes.`
      })
    });
  } catch(e) { console.warn('Twilio send failed:', e); }

  // Start cooldown
  resendCooldown = 60;
  const timer = document.getElementById('resend-timer');
  const link = document.getElementById('resend-link');
  link.style.opacity = '0.4'; link.style.pointerEvents = 'none';
  const interval = setInterval(() => {
    resendCooldown--;
    timer.textContent = resendCooldown > 0 ? `(${resendCooldown}s)` : '';
    if (resendCooldown <= 0) {
      clearInterval(interval);
      link.style.opacity = '1'; link.style.pointerEvents = 'auto';
    }
  }, 1000);
}

function resend2FA() {
  if (resendCooldown > 0 || !pendingUser) return;
  send2FACode(pendingUser);
  showMsg('2fa-msg', 'New code sent!', 'success');
  setTimeout(() => hideMsg('2fa-msg'), 3000);
}

async function verify2FA() {
  const code = Array.from({length:6}, (_, i) => document.getElementById('code-'+i).value).join('');
  if (code.length < 6) { showMsg('2fa-msg', 'Please enter all 6 digits.', 'error'); return; }
  hideMsg('2fa-msg');

  const btn = document.getElementById('btn-verify');
  btn.classList.add('btn-loading'); btn.disabled = true;

  try {
    // Look up the code in Supabase
    const res = await fetch(SB_URL + '/rest/v1/two_factor_codes?user_id=eq.' + pendingUser.id + '&used=eq.false&select=*', {
      headers: H
    });
    const rows = await res.json();
    const record = rows && rows[0];

    if (!record) {
      showMsg('2fa-msg', 'No active code found. Request a new one.', 'error');
      btn.classList.remove('btn-loading'); btn.disabled = false;
      return;
    }

    // Check expiry
    if (new Date(record.expires_at) < new Date()) {
      showMsg('2fa-msg', 'Code expired. Request a new one.', 'error');
      btn.classList.remove('btn-loading'); btn.disabled = false;
      return;
    }

    // Check match
    if (record.code !== code) {
      showMsg('2fa-msg', 'Invalid code. Please try again.', 'error');
      for (let i=0; i<6; i++) document.getElementById('code-'+i).value = '';
      document.getElementById('code-0').focus();
      btn.classList.remove('btn-loading'); btn.disabled = false;
      return;
    }

    // Mark as used
    await fetch(SB_URL + '/rest/v1/two_factor_codes?id=eq.' + record.id, {
      method: 'PATCH',
      headers: { ...H, 'Prefer': 'return=minimal' },
      body: JSON.stringify({ used: true })
    });

    // Success
    completeLogin(pendingUser, pendingUser.auth_token);
      btn.classList.remove('btn-loading'); btn.disabled = false;
    }
  } catch(e) {
    showMsg('2fa-msg', 'Verification failed. Please try again.', 'error');
    btn.classList.remove('btn-loading'); btn.disabled = false;
  }
}

// ── 2FA code input auto-advance ──
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('.code-digit').forEach((input, idx) => {
    input.addEventListener('input', (e) => {
      const val = e.target.value.replace(/\D/g, '');
      e.target.value = val.slice(0, 1);
      if (val && idx < 5) document.getElementById('code-' + (idx + 1)).focus();
    });
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Backspace' && !e.target.value && idx > 0) {
        document.getElementById('code-' + (idx - 1)).focus();
      }
    });
    input.addEventListener('paste', (e) => {
      e.preventDefault();
      const paste = (e.clipboardData.getData('text') || '').replace(/\D/g, '').slice(0, 6);
      paste.split('').forEach((ch, i) => {
        const el = document.getElementById('code-' + i);
        if (el) el.value = ch;
      });
      if (paste.length === 6) document.getElementById('code-5').focus();
    });
  });
});

// ═══════════════════════════════════════════════════════════
//  FORGOT PASSWORD
// ═══════════════════════════════════════════════════════════
async function doForgotPassword() {
  const email = document.getElementById('forgot-email').value.trim().toLowerCase();
  hideMsg('forgot-msg');
  if (!email || !email.includes('@')) { showMsg('forgot-msg', 'Please enter a valid email.', 'error'); return; }

  try {
    const res = await fetch(SB_URL + '/auth/v1/recover', {
      method: 'POST',
      headers: { 'apikey': SB_KEY, 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, gotrue_meta_security: {}, options: {} })
    });
    showMsg('forgot-msg', 'If an account exists with this email, you will receive a password reset link.', 'success');
  } catch(e) {
    showMsg('forgot-msg', 'Could not send reset email. Please try again.', 'error');
  }
}

// ═══════════════════════════════════════════════════════════
//  SET PASSWORD (first login)
// ═══════════════════════════════════════════════════════════
async function doSetPassword() {
  const pw = document.getElementById('new-password').value;
  const confirm = document.getElementById('confirm-password').value;
  hideMsg('setpw-msg');

  if (pw.length < 8) { showMsg('setpw-msg', 'Password must be at least 8 characters.', 'error'); return; }
  if (pw !== confirm) { showMsg('setpw-msg', 'Passwords do not match.', 'error'); return; }

  if (!pendingUser || !pendingUser.auth_token) {
    showMsg('setpw-msg', 'Session expired. Please use "Forgot password" to get a new link.', 'error');
    return;
  }

  try {
    // Update password via Supabase Auth
    const res = await fetch(SB_URL + '/auth/v1/user', {
      method: 'PUT',
      headers: { 'apikey': SB_KEY, 'Authorization': 'Bearer ' + pendingUser.auth_token, 'Content-Type': 'application/json' },
      body: JSON.stringify({ password: pw })
    });

    if (res.ok) {
      // Clear the must_reset flag if we have a profile ID
      if (pendingUser.id) {
        await fetch(SB_URL + '/rest/v1/user_profiles?id=eq.' + pendingUser.id, {
          method: 'PATCH',
          headers: { ...H, 'Prefer': 'return=minimal' },
          body: JSON.stringify({ must_reset_password: false })
        }).catch(() => {});
      }

      // If this was a reset flow (not first login through email/pw), show success and redirect to login
      if (pendingUser.fromReset) {
        showMsg('setpw-msg', 'Password set successfully! Redirecting to sign in...', 'success');
        setTimeout(() => {
          showStep('step-login');
          hideMsg('setpw-msg');
          showMsg('login-msg', 'Password updated. Sign in with your new password.', 'success');
        }, 1500);
      } else {
        completeLogin(pendingUser, pendingUser.auth_token);
      }
    } else {
      const errData = await res.json().catch(() => ({}));
      showMsg('setpw-msg', errData.msg || errData.error_description || 'Could not set password. The link may have expired — try "Forgot password" again.', 'error');
    }
  } catch(e) {
    showMsg('setpw-msg', 'Connection error. Please try again.', 'error');
  }
}

// ═══════════════════════════════════════════════════════════
//  LEGACY PIN LOGIN
// ═══════════════════════════════════════════════════════════
function renderRepGrid() {
  const grid = document.getElementById('rep-grid');
  if (!grid) return;
  grid.innerHTML = profiles.map((p, i) => {
    const roleClass = 'role-' + (p.role || 'Sales').toLowerCase().replace(/\s+/g, '-');
    const initials = p.initials || p.name.split(' ').map(w=>w[0]).join('').toUpperCase().slice(0,2);
    const displayRole = p.title || p.role || 'Sales';
    return `<button class="rep-btn" onclick="selectRep(${i})" id="rep-${i}">
      <div class="rep-avatar ${roleClass}">${initials}</div>
      <div class="rep-btn-name">${p.name}</div>
      <div class="rep-btn-role ${roleClass}">${displayRole}</div>
    </button>`;
  }).join('');
}

function selectRep(i) {
  selectedProfile = profiles[i];
  document.querySelectorAll('.rep-btn').forEach(b => b.classList.remove('selected'));
  document.getElementById('rep-'+i).classList.add('selected');
  document.getElementById('next-btn').disabled = false;
}

function goToPin() {
  if (!selectedProfile) return;
  document.getElementById('pin-sub').textContent = `Welcome, ${selectedProfile.first_name || selectedProfile.name.split(' ')[0]}. Enter your PIN.`;
  pinEntry = ''; updateDots();
  showStep('step-pin-enter');
}

function pinPress(d) {
  if (pinEntry.length >= 4) return;
  pinEntry += d; updateDots();
  if (pinEntry.length === 4) setTimeout(checkPin, 120);
}

function pinDelete() { pinEntry = pinEntry.slice(0,-1); updateDots(); document.getElementById('pin-error').textContent = ''; }

function updateDots() {
  for (let i=0; i<4; i++) {
    const dot = document.getElementById('dot-'+i);
    dot.classList.toggle('filled', i < pinEntry.length);
    dot.classList.remove('error');
  }
}

function checkPin() {
  if (pinEntry === (selectedProfile.pin || '')) {
    if (!selectedProfile.pin) {
      document.getElementById('pin-error').textContent = 'No PIN set. Use email login or contact admin.';
      pinEntry = '';
      setTimeout(updateDots, 600);
      return;
    }
    completeLogin(selectedProfile);
  } else {
    for (let i=0; i<4; i++) {
      const dot = document.getElementById('dot-'+i);
      dot.classList.remove('filled');
      dot.classList.add('error');
    }
    document.getElementById('pin-error').textContent = 'Incorrect PIN. Try again.';
    pinEntry = '';
    setTimeout(updateDots, 600);
  }
}

// ═══════════════════════════════════════════════════════════
//  COMPLETE LOGIN — SHARED ACROSS ALL METHODS
// ═══════════════════════════════════════════════════════════
function completeLogin(profile, authToken) {
  const roleLabel = profile.role === 'Admin' ? 'Admin'
    : profile.role.includes('Manager') ? 'Manager'
    : 'Sales';
  const initials = profile.initials || profile.name.split(' ').map(w=>w[0]).join('').toUpperCase().slice(0,2);

  // Set session for all other pages
  sessionStorage.setItem('sb_rep', JSON.stringify({
    name:     profile.name,
    initials: initials,
    role:     roleLabel,
    title:    profile.title || profile.role,
    email:    profile.email || '',
  }));

  if (authToken) {
    sessionStorage.setItem('sb_auth_token', authToken);
  }

  // Update last_login in Supabase
  if (profile.id) {
    fetch(SB_URL + '/rest/v1/user_profiles?id=eq.' + profile.id, {
      method: 'PATCH',
      headers: { ...H, 'Prefer': 'return=minimal' },
      body: JSON.stringify({ last_login: new Date().toISOString() })
    }).catch(() => {});
  }

  // Redirect based on role
  const redirect = roleLabel === 'Admin' ? 'app.html'
    : roleLabel === 'Manager' ? 'app.html'
    : 'app.html';
  window.location.href = redirect;
}

function maskPhone(phone) {
  if (!phone) return '****';
  const digits = phone.replace(/\D/g, '');
  return '****' + digits.slice(-4);
}

// ── Enter key handling ──
document.addEventListener('keydown', (e) => {
  if (e.key !== 'Enter') return;
  const active = document.querySelector('.step.active');
  if (!active) return;
  if (active.id === 'step-login') doEmailLogin();
  if (active.id === 'step-forgot') doForgotPassword();
  if (active.id === 'step-set-password') doSetPassword();
  if (active.id === 'step-2fa') verify2FA();
});

// ── DETECT PASSWORD RESET TOKEN FROM URL ──
function checkForResetToken() {
  // Supabase sends tokens in the URL hash: #access_token=xxx&type=recovery
  const hash = window.location.hash.substring(1);
  const params = new URLSearchParams(hash);
  const accessToken = params.get('access_token');
  const type = params.get('type');

  // Also check query params (some Supabase versions use these)
  const query = new URLSearchParams(window.location.search);
  const qToken = query.get('access_token');
  const qType = query.get('type');

  const token = accessToken || qToken;
  const tokenType = type || qType;

  if (token && (tokenType === 'recovery' || tokenType === 'signup' || tokenType === 'invite')) {
    // We have a valid recovery/invite token — show set password form
    pendingUser = { auth_token: token, fromReset: true };

    // Try to get the user info from the token
    fetch(SB_URL + '/auth/v1/user', {
      headers: { 'apikey': SB_KEY, 'Authorization': 'Bearer ' + token }
    }).then(r => r.json()).then(userData => {
      if (userData && userData.email) {
        // Find matching profile
        const profile = profiles.find(p => p.email && p.email.toLowerCase() === userData.email.toLowerCase());
        if (profile) {
          pendingUser = { ...profile, auth_token: token, fromReset: true };
          document.getElementById('set-pw-sub').textContent = `Welcome back, ${profile.first_name || profile.name.split(' ')[0]}! Set your new password below.`;
        } else {
          document.getElementById('set-pw-sub').textContent = `Set your new password for ${userData.email}.`;
        }
      }
    }).catch(() => {});

    // Clean the URL so the token isn't visible
    history.replaceState(null, '', window.location.pathname);

    showStep('step-set-password');
    return true;
  }
  return false;
}

// ── INIT ──
loadProfiles().then(() => {
  checkForResetToken();
});
</script>
</body>
</html>
