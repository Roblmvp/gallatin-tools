<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ServiceBridge ‚Äî Manager Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #090C14;
  --surface: #111828;
  --surface2: #1A2438;
  --surface3: #212E45;
  --border: rgba(255,255,255,0.12);
  --border2: rgba(255,255,255,0.20);
  --text: #FFFFFF;
  --muted: rgba(255,255,255,0.70);
  --muted2: rgba(255,255,255,0.45);
  --purple: #6366F1;
  --purple2: #818CF8;
  --red: #EF4444;
  --green: #22C55E;
  --gold: #F59E0B;
  --orange: #F97316;
  --r: 12px;
}
* { margin:0; padding:0; box-sizing:border-box; }
body {
  background: var(--bg);
  color: var(--text);
  font-family: 'DM Sans', sans-serif;
  min-height: 100vh;
  -webkit-font-smoothing: antialiased;
}

/* BG */
.bg-orb1 { position:fixed; top:-200px; right:-150px; width:600px; height:600px; border-radius:50%; background:radial-gradient(circle,rgba(91,79,232,0.12) 0%,transparent 70%); pointer-events:none; z-index:0; }
.bg-orb2 { position:fixed; bottom:-200px; left:-100px; width:500px; height:500px; border-radius:50%; background:radial-gradient(circle,rgba(200,16,46,0.08) 0%,transparent 70%); pointer-events:none; z-index:0; }

/* NAV */
nav {
  position: sticky; top:0; z-index:100;
  background: rgba(7,7,14,0.92);
  backdrop-filter: blur(16px);
  border-bottom: 1px solid var(--border);
  padding: 0 28px;
  height: 58px;
  display: flex; align-items:center; justify-content:space-between;
}
nav::after { content:''; position:absolute; bottom:0; left:0; right:0; height:1px; background:linear-gradient(90deg,var(--purple),transparent,var(--red),transparent); }
.nav-brand { font-family:'Bebas Neue',sans-serif; font-size:22px; letter-spacing:0.06em; background:linear-gradient(90deg,#fff,rgba(255,255,255,0.6)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
.nav-right { display:flex; align-items:center; gap:16px; }
.nav-badge { font-size:11px; font-weight:600; padding:4px 12px; border-radius:20px; background:rgba(91,79,232,0.2); border:1px solid rgba(91,79,232,0.4); color:var(--purple2); }
.nav-link { font-size:12px; font-weight:600; color:var(--muted); text-decoration:none; padding:6px 12px; border-radius:7px; transition:all 0.18s; }
.nav-link:hover { color:var(--text); background:rgba(255,255,255,0.05); }
.refresh-btn { font-size:12px; font-weight:600; padding:7px 14px; border-radius:8px; background:rgba(255,255,255,0.06); border:1px solid var(--border2); color:var(--muted); cursor:pointer; transition:all 0.18s; font-family:'DM Sans',sans-serif; }
.refresh-btn:hover { color:var(--text); border-color:var(--border2); }

/* LAYOUT */
.page { max-width:1400px; margin:0 auto; padding:28px 28px 80px; position:relative; z-index:1; }

/* KPI ROW */
.kpi-grid { display:grid; grid-template-columns:repeat(6,1fr); gap:12px; margin-bottom:28px; }
.kpi-card {
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:var(--r);
  padding:18px 16px;
  position:relative; overflow:hidden;
  transition: transform 0.2s;
}
.kpi-card:hover { transform:translateY(-2px); }
.kpi-card::before { content:''; position:absolute; top:0; left:0; right:0; height:2px; }
.kpi-p::before { background:var(--purple); }
.kpi-r::before { background:var(--red); }
.kpi-g::before { background:var(--green); }
.kpi-o::before { background:var(--orange); }
.kpi-gold::before { background:var(--gold); }
.kpi-b::before { background:#38BDF8; }
.kpi-lbl { font-size:9px; font-weight:700; letter-spacing:0.16em; text-transform:uppercase; color:rgba(255,255,255,0.55); margin-bottom:6px; }
.kpi-val { font-family:'Bebas Neue',sans-serif; font-size:40px; line-height:1; }
.kpi-p .kpi-val { color:var(--purple2); }
.kpi-r .kpi-val { color:#FC8181; }
.kpi-g .kpi-val { color:#4ADE80; }
.kpi-o .kpi-val { color:var(--orange); }
.kpi-gold .kpi-val { color:var(--gold); }
.kpi-b .kpi-val { color:#38BDF8; }
.kpi-sub { font-size:10px; color:rgba(255,255,255,0.45); margin-top:2px; }

/* SECTION HEADER */
.section-hd {
  display:flex; align-items:center; justify-content:space-between;
  margin-bottom:14px;
}
.section-title {
  font-size:11px; font-weight:700;
  letter-spacing:0.16em; text-transform:uppercase;
  color:rgba(255,255,255,0.75);
  display:flex; align-items:center; gap:8px;
}
.section-title::before { content:''; display:inline-block; width:16px; height:2px; background:var(--purple); border-radius:2px; }
.section-count { font-size:11px; font-weight:600; color:var(--muted2); }

/* TABS */
.tabs { display:flex; gap:4px; margin-bottom:20px; background:var(--surface); border:1px solid var(--border); border-radius:10px; padding:4px; width:fit-content; }
.tab { padding:8px 18px; border-radius:7px; font-size:12px; font-weight:600; color:var(--muted); cursor:pointer; transition:all 0.18s; border:none; background:transparent; font-family:'DM Sans',sans-serif; display:flex; align-items:center; gap:6px; }
.tab.active { background:var(--surface3); color:var(--text); }
.tab-badge { font-size:10px; font-weight:700; padding:1px 7px; border-radius:10px; background:var(--red); color:#fff; }
.tab-badge.purple { background:var(--purple); }

/* ALERT BANNER */
.alert-banner {
  background: rgba(200,16,46,0.12);
  border: 1px solid rgba(200,16,46,0.3);
  border-radius:var(--r);
  padding:14px 18px;
  margin-bottom:16px;
  display:flex; align-items:center; gap:12px;
  animation: pulse-border 2s ease infinite;
}
@keyframes pulse-border {
  0%,100% { border-color:rgba(200,16,46,0.3); }
  50% { border-color:rgba(200,16,46,0.6); }
}
.alert-dot { width:10px; height:10px; border-radius:50%; background:var(--red); animation:pulse-dot 1.5s ease infinite; flex-shrink:0; }
@keyframes pulse-dot { 0%,100%{opacity:1;transform:scale(1);} 50%{opacity:0.5;transform:scale(0.8);} }
.alert-text { font-size:13px; font-weight:600; color:#FC8181; }
.alert-sub { font-size:11px; color:rgba(252,129,129,0.6); margin-top:1px; }

/* ENTRY CARDS */
.entries-list { display:flex; flex-direction:column; gap:10px; }

.entry-card {
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:16px;
  overflow:hidden;
  transition:all 0.2s;
}
.entry-card:hover { border-color:var(--border2); }
.entry-card.hot { border-color:rgba(200,16,46,0.35); background:rgba(200,16,46,0.04); }
.entry-card.aging { border-color:rgba(249,115,22,0.35); background:rgba(249,115,22,0.04); }
.entry-card.claimed { border-color:rgba(34,197,94,0.25); }

.entry-main {
  padding:18px 20px;
  display:grid;
  grid-template-columns:auto 1fr auto auto;
  gap:16px;
  align-items:start;
}

/* Temp badge */
.temp-badge {
  width:52px; height:52px; border-radius:12px;
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  flex-shrink:0;
  font-family:'Bebas Neue',sans-serif;
}
.temp-badge .temp-num { font-size:26px; line-height:1; }
.temp-badge .temp-lbl { font-size:8px; letter-spacing:0.1em; opacity:0.7; }
.temp-hot { background:rgba(200,16,46,0.2); border:1px solid rgba(200,16,46,0.4); color:#FC8181; }
.temp-warm { background:rgba(249,115,22,0.2); border:1px solid rgba(249,115,22,0.4); color:var(--orange); }
.temp-cool { background:rgba(91,79,232,0.15); border:1px solid rgba(91,79,232,0.3); color:var(--purple2); }

/* Entry info */
.entry-info {}
.entry-name { font-size:16px; font-weight:700; margin-bottom:3px; }
.entry-meta { font-size:12px; color:var(--muted); display:flex; flex-wrap:wrap; gap:12px; margin-bottom:6px; }
.entry-meta span { display:flex; align-items:center; gap:4px; }
.entry-tags { display:flex; flex-wrap:wrap; gap:6px; }
.entry-tag {
  font-size:10px; font-weight:600;
  padding:3px 10px; border-radius:20px;
  letter-spacing:0.04em;
}
.tag-outcome-sold { background:rgba(34,197,94,0.15); color:#4ADE80; border:1px solid rgba(34,197,94,0.2); }
.tag-outcome-appt { background:rgba(91,79,232,0.15); color:var(--purple2); border:1px solid rgba(91,79,232,0.2); }
.tag-outcome-follow { background:rgba(232,184,75,0.15); color:var(--gold); border:1px solid rgba(232,184,75,0.2); }
.tag-outcome-other { background:rgba(255,255,255,0.06); color:var(--muted); border:1px solid var(--border); }
.tag-followup { background:rgba(249,115,22,0.15); color:var(--orange); border:1px solid rgba(249,115,22,0.25); }
.tag-claimed { background:rgba(34,197,94,0.12); color:#4ADE80; border:1px solid rgba(34,197,94,0.2); }
.tag-pending { background:rgba(255,255,255,0.05); color:var(--muted); border:1px solid var(--border); }
.tag-hot { background:rgba(200,16,46,0.15); color:#FC8181; border:1px solid rgba(200,16,46,0.25); animation:pulse-dot 2s ease infinite; }

/* Entry right side */
.entry-right { display:flex; flex-direction:column; align-items:flex-end; gap:8px; flex-shrink:0; }
.entry-time { font-size:11px; color:var(--muted2); font-family:'DM Mono',monospace; }
.claim-btn {
  padding:8px 16px; border-radius:8px;
  font-size:12px; font-weight:700;
  background:linear-gradient(135deg,var(--purple),var(--purple2));
  color:#fff; border:none; cursor:pointer;
  font-family:'DM Sans',sans-serif;
  transition:all 0.18s;
  white-space:nowrap;
}
.claim-btn:hover { transform:translateY(-1px); box-shadow:0 4px 12px rgba(91,79,232,0.4); }
.claimed-by { font-size:11px; color:#4ADE80; font-weight:600; text-align:right; }

/* Expand panel */
.entry-expand {
  border-top:1px solid var(--border);
  padding:18px 20px;
  display:none;
  background:var(--surface2);
}
.entry-expand.open { display:block; }
.expand-grid { display:grid; grid-template-columns:1fr 1fr 1fr; gap:16px; margin-bottom:16px; }
.expand-section-title { font-size:10px; font-weight:700; letter-spacing:0.14em; text-transform:uppercase; color:var(--muted2); margin-bottom:10px; }
.expand-row { display:flex; justify-content:space-between; align-items:baseline; padding:5px 0; border-bottom:1px solid rgba(255,255,255,0.04); }
.expand-row:last-child { border-bottom:none; }
.expand-key { font-size:11px; color:var(--muted); }
.expand-val { font-size:12px; font-weight:600; color:var(--text); text-align:right; max-width:180px; word-break:break-word; }

/* Manager action panel */
.manager-panel {
  background:var(--surface3);
  border:1px solid var(--border2);
  border-radius:10px;
  padding:16px;
  margin-top:16px;
}
.manager-panel-title { font-size:10px; font-weight:700; letter-spacing:0.14em; text-transform:uppercase; color:var(--purple2); margin-bottom:12px; display:flex; align-items:center; gap:6px; }
.manager-fields { display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:12px; }
.field-group { display:flex; flex-direction:column; gap:6px; }
.field-label { font-size:10px; font-weight:600; letter-spacing:0.1em; text-transform:uppercase; color:var(--muted2); }
.field-select, .field-textarea, .field-input {
  background:var(--surface);
  border:1px solid var(--border2);
  border-radius:8px;
  color:var(--text);
  font-family:'DM Sans',sans-serif;
  font-size:13px;
  padding:9px 12px;
  width:100%;
  transition:border-color 0.18s;
}
.field-select:focus, .field-textarea:focus, .field-input:focus {
  outline:none; border-color:var(--purple);
}
.field-textarea { resize:vertical; min-height:70px; }
.field-select option { background:var(--surface2); }
.save-btn {
  padding:9px 20px; border-radius:8px;
  font-size:12px; font-weight:700;
  background:linear-gradient(135deg,var(--purple),var(--purple2));
  color:#fff; border:none; cursor:pointer;
  font-family:'DM Sans',sans-serif;
  transition:all 0.18s;
}
.save-btn:hover { transform:translateY(-1px); box-shadow:0 4px 12px rgba(91,79,232,0.4); }
.save-success { font-size:11px; color:#4ADE80; font-weight:600; margin-left:10px; opacity:0; transition:opacity 0.3s; }

/* Toggle expand btn */
.expand-toggle {
  width:100%; background:none; border:none;
  border-top:1px solid var(--border);
  color:var(--muted); font-size:11px; font-weight:600;
  padding:10px; cursor:pointer; font-family:'DM Sans',sans-serif;
  transition:all 0.18s; letter-spacing:0.04em;
  display:flex; align-items:center; justify-content:center; gap:6px;
}
.expand-toggle:hover { color:var(--text); background:rgba(255,255,255,0.03); }

/* SCORECARDS PAGE */
.score-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:16px; margin-bottom:28px; }
.score-card {
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:16px;
  overflow:hidden;
  transition:transform 0.2s;
}
.score-card:hover { transform:translateY(-3px); }
.score-card-header {
  padding:20px 20px 14px;
  display:flex; align-items:center; gap:12px;
  border-bottom:1px solid var(--border);
}
.score-avatar {
  width:44px; height:44px; border-radius:50%;
  background:linear-gradient(135deg,var(--purple),var(--purple2));
  display:flex; align-items:center; justify-content:center;
  font-size:14px; font-weight:700; color:#fff; flex-shrink:0;
}
.score-avatar.rank1 { background:linear-gradient(135deg,#E8B84B,#F59E0B); }
.score-avatar.rank2 { background:linear-gradient(135deg,#94A3B8,#64748B); }
.score-avatar.rank3 { background:linear-gradient(135deg,#C87B4B,#92400E); }
.score-name { font-size:15px; font-weight:700; }
.score-role { font-size:11px; color:var(--muted); }
.score-rank { margin-left:auto; font-family:'Bebas Neue',sans-serif; font-size:28px; color:var(--muted2); }
.score-rank.rank1 { color:var(--gold); }
.score-stats { padding:16px 20px; display:grid; grid-template-columns:1fr 1fr; gap:10px; }
.score-stat { text-align:center; }
.score-stat-val { font-family:'Bebas Neue',sans-serif; font-size:28px; line-height:1; }
.score-stat-lbl { font-size:9px; font-weight:600; letter-spacing:0.12em; text-transform:uppercase; color:var(--muted2); margin-top:2px; }
.score-bar-wrap { padding:0 20px 16px; }
.score-bar-label { display:flex; justify-content:space-between; font-size:10px; color:var(--muted2); margin-bottom:5px; }
.score-bar-track { height:4px; background:rgba(255,255,255,0.07); border-radius:2px; overflow:hidden; }
.score-bar-fill { height:100%; border-radius:2px; background:linear-gradient(90deg,var(--purple),var(--purple2)); transition:width 1s ease; }

/* LEADERBOARD TABLE */
.leaderboard {
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:16px;
  overflow:hidden;
}
.lb-header {
  display:grid;
  grid-template-columns:40px 1fr 80px 80px 80px 80px 100px;
  padding:12px 20px;
  background:var(--surface2);
  border-bottom:1px solid var(--border);
}
.lb-col-hd { font-size:9px; font-weight:700; letter-spacing:0.14em; text-transform:uppercase; color:var(--muted2); text-align:center; }
.lb-col-hd:nth-child(2) { text-align:left; }
.lb-row {
  display:grid;
  grid-template-columns:40px 1fr 80px 80px 80px 80px 100px;
  padding:14px 20px;
  border-bottom:1px solid var(--border);
  align-items:center;
  transition:background 0.15s;
}
.lb-row:last-child { border-bottom:none; }
.lb-row:hover { background:rgba(255,255,255,0.025); }
.lb-rank { font-family:'Bebas Neue',sans-serif; font-size:20px; color:var(--muted2); text-align:center; }
.lb-rank.r1 { color:var(--gold); }
.lb-rank.r2 { color:#94A3B8; }
.lb-rank.r3 { color:#C87B4B; }
.lb-name-cell { display:flex; align-items:center; gap:10px; }
.lb-avatar { width:32px; height:32px; border-radius:50%; background:linear-gradient(135deg,var(--purple),var(--purple2)); display:flex; align-items:center; justify-content:center; font-size:11px; font-weight:700; color:#fff; flex-shrink:0; }
.lb-name { font-size:13px; font-weight:600; }
.lb-role { font-size:10px; color:var(--muted); }
.lb-cell { text-align:center; font-size:13px; font-weight:600; }
.lb-cell.hot { color:#FC8181; }
.lb-cell.sold { color:#4ADE80; }
.lb-conv { text-align:center; }
.conv-pill { display:inline-block; padding:3px 10px; border-radius:20px; font-size:11px; font-weight:700; }
.conv-high { background:rgba(34,197,94,0.15); color:#4ADE80; }
.conv-mid { background:rgba(232,184,75,0.15); color:var(--gold); }
.conv-low { background:rgba(255,255,255,0.06); color:var(--muted); }

/* EMPTY */
.empty-state { text-align:center; padding:48px 24px; color:var(--muted); }
.empty-icon { font-size:36px; margin-bottom:12px; opacity:0.5; }
.empty-text { font-size:14px; }

/* LOADING */
.loading { text-align:center; padding:40px; color:var(--muted); }
.dots span { display:inline-block; width:7px; height:7px; border-radius:50%; background:var(--purple); margin:0 3px; animation:dotpulse 1.2s ease infinite; }
.dots span:nth-child(2){animation-delay:0.2s;} .dots span:nth-child(3){animation-delay:0.4s;}
@keyframes dotpulse{0%,100%{opacity:1;}50%{opacity:0.3;}}

@keyframes fadeUp { from{opacity:0;transform:translateY(12px);}to{opacity:1;transform:translateY(0);} }
.fade-in { animation:fadeUp 0.4s ease both; }

@media(max-width:1100px){ .kpi-grid{grid-template-columns:repeat(3,1fr);} .score-grid{grid-template-columns:repeat(2,1fr);} }
@media(max-width:768px){
  .page{padding:16px 16px 60px;}
  .kpi-grid{grid-template-columns:repeat(2,1fr);}
  .entry-main{grid-template-columns:auto 1fr; grid-template-rows:auto auto;}
  .entry-right{flex-direction:row; align-items:center; grid-column:1/-1;}
  .expand-grid{grid-template-columns:1fr;}
  .manager-fields{grid-template-columns:1fr;}
  .score-grid{grid-template-columns:1fr 1fr;}
  .lb-header,.lb-row{grid-template-columns:32px 1fr 60px 60px 70px;}
  .lb-col-hd:nth-child(4),.lb-cell.hot,.lb-col-hd:nth-child(6){display:none;}
}

/* ‚îÄ‚îÄ Export Buttons ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.export-bar{display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap;}
.export-btn{display:inline-flex;align-items:center;gap:7px;padding:9px 18px;border-radius:9px;font-size:12px;font-weight:700;cursor:pointer;border:none;font-family:'DM Sans',sans-serif;transition:all 0.18s;letter-spacing:0.02em;}
.export-csv{background:rgba(34,197,94,0.12);border:1px solid rgba(34,197,94,0.3);color:#4ADE80;}
.export-csv:hover{background:rgba(34,197,94,0.2);transform:translateY(-1px);}
.export-pdf{background:rgba(200,16,46,0.12);border:1px solid rgba(200,16,46,0.3);color:#FC8181;}
.export-pdf:hover{background:rgba(200,16,46,0.2);transform:translateY(-1px);}
.export-greet-csv{background:rgba(91,79,232,0.12);border:1px solid rgba(91,79,232,0.3);color:#7B72F0;}
.export-greet-csv:hover{background:rgba(91,79,232,0.2);transform:translateY(-1px);}

.range-btn{padding:6px 13px;border-radius:7px;background:var(--surface2);border:1px solid var(--border2);color:var(--muted);font-family:'DM Sans',sans-serif;font-size:11px;font-weight:600;cursor:pointer;transition:all 0.18s;}
.range-btn:hover{color:var(--text);border-color:var(--purple2);background:rgba(99,102,241,0.1);}
.rpt-row{display:flex;align-items:center;gap:10px;margin-bottom:10px;}
.rpt-bar-wrap{flex:1;height:8px;background:rgba(255,255,255,0.07);border-radius:4px;overflow:hidden;}
.rpt-bar{height:100%;border-radius:4px;transition:width 0.6s ease;}
.rpt-label{font-size:12px;font-weight:600;color:var(--text);min-width:140px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.rpt-count{font-family:'DM Mono',monospace;font-size:12px;font-weight:600;color:var(--muted);min-width:28px;text-align:right;}
.rpt-pct{font-size:10px;font-weight:700;color:var(--muted2);min-width:36px;text-align:right;}
.rpt-kpi-card{background:var(--surface);border:1px solid var(--border2);border-radius:14px;padding:18px;position:relative;overflow:hidden;}
.rpt-kpi-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;}
.rpt-kpi-lbl{font-size:9px;font-weight:700;letter-spacing:0.14em;text-transform:uppercase;color:rgba(255,255,255,0.45);margin-bottom:6px;}
.rpt-kpi-val{font-family:'Bebas Neue',sans-serif;font-size:44px;line-height:1;color:#fff;}
.rpt-kpi-sub{font-size:11px;color:rgba(255,255,255,0.4);margin-top:3px;}
</style>
</head>
<body>
<div class="bg-orb1"></div>
<div class="bg-orb2"></div>

<nav>
  <div style="display:flex;align-items:center;gap:16px;">
    <div class="nav-brand">ServiceBridge</div>
    <div class="nav-badge" id="live-badge">‚óè LIVE</div>
  </div>
  <div class="nav-right">
    <a href="login.html" class="nav-link">Rep Login</a>
    <a href="scorecards.html" class="nav-link">Scorecards</a>
    <a href="admin-panel.html" class="nav-link">Admin</a>
    <button class="refresh-btn" onclick="loadAll()">‚Üª Refresh</button>
  </div>
</nav>

<div class="page">

  <!-- KPIs -->
  <div class="kpi-grid fade-in" id="kpi-row">
    <div class="kpi-card kpi-p"><div class="kpi-lbl">Today's Entries</div><div class="kpi-val" id="kpi-today">‚Äî</div></div>
    <div class="kpi-card kpi-r"><div class="kpi-lbl">Hot Leads</div><div class="kpi-val" id="kpi-hot">‚Äî</div><div class="kpi-sub">Score 8-10</div></div>
    <div class="kpi-card kpi-g"><div class="kpi-lbl">Sold Today</div><div class="kpi-val" id="kpi-sold">‚Äî</div></div>
    <div class="kpi-card kpi-o"><div class="kpi-lbl">Unclaimed</div><div class="kpi-val" id="kpi-unclaimed">‚Äî</div><div class="kpi-sub">Hot leads</div></div>
    <div class="kpi-card kpi-gold"><div class="kpi-lbl">Avg Temp</div><div class="kpi-val" id="kpi-avg">‚Äî</div><div class="kpi-sub">Today</div></div>
    <div class="kpi-card kpi-b"><div class="kpi-lbl">Follow-Up Due</div><div class="kpi-val" id="kpi-followup">‚Äî</div><div class="kpi-sub">No contact 24h+</div></div>
  </div>

  <!-- Hot lead alert banner -->
  <div id="hot-banner" style="display:none;" class="alert-banner fade-in">
    <div class="alert-dot"></div>
    <div>
      <div class="alert-text" id="hot-banner-text">üî• Unclaimed hot leads need attention</div>
      <div class="alert-sub">Claim and action these leads before they leave the lot</div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab active" onclick="switchTab('all',this)">All Entries <span class="tab-badge purple" id="tab-all-count">0</span></button>
    <button class="tab" onclick="switchTab('hot',this)">üî• Hot Leads <span class="tab-badge" id="tab-hot-count">0</span></button>
    <button class="tab" onclick="switchTab('aging',this)">‚ö†Ô∏è Needs Follow-Up <span class="tab-badge" id="tab-aging-count">0</span></button>
    <button class="tab" onclick="switchTab('unclaimed',this)">Unclaimed <span class="tab-badge" id="tab-unclaimed-count">0</span></button>
    <button class="tab" onclick="switchTab('reports',this)">üìä Reports</button>
  </div>


  <!-- Export Bar -->
  <div class="export-bar">
    <button class="export-btn export-csv" onclick="exportS2SCSV()">‚¨á S2S Entries ‚Äî CSV</button>
    <button class="export-btn export-pdf" onclick="exportS2SPDF()">üñ® S2S Entries ‚Äî Print / PDF</button>
    <button class="export-btn export-greet-csv" onclick="exportGreetCSV()">‚¨á Greet Log ‚Äî CSV</button>
    <button class="export-btn export-pdf" onclick="exportGreetPDF()">üñ® Greet Log ‚Äî Print / PDF</button>
  </div>
  <div class="section-hd">
    <div class="section-title">S2S Entries</div>
    <div class="section-count" id="showing-count"></div>
  </div>


  <!-- Reports Panel -->
  <div id="reports-panel" style="display:none;">

    <!-- Date Range + Filters -->
    <div style="background:var(--surface);border:1px solid var(--border2);border-radius:16px;padding:24px;margin-bottom:20px;">
      <div style="font-size:10px;font-weight:700;letter-spacing:0.16em;text-transform:uppercase;color:var(--muted2);margin-bottom:16px;">üìÖ Report Filters</div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr auto;gap:12px;align-items:end;flex-wrap:wrap;">
        <div>
          <div style="font-size:10px;font-weight:600;letter-spacing:0.1em;text-transform:uppercase;color:var(--muted2);margin-bottom:6px;">From</div>
          <input type="date" id="rpt-from" style="width:100%;background:var(--surface2);border:1.5px solid var(--border2);border-radius:9px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:13px;padding:10px 12px;outline:none;">
        </div>
        <div>
          <div style="font-size:10px;font-weight:600;letter-spacing:0.1em;text-transform:uppercase;color:var(--muted2);margin-bottom:6px;">To</div>
          <input type="date" id="rpt-to" style="width:100%;background:var(--surface2);border:1.5px solid var(--border2);border-radius:9px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:13px;padding:10px 12px;outline:none;">
        </div>
        <div>
          <div style="font-size:10px;font-weight:600;letter-spacing:0.1em;text-transform:uppercase;color:var(--muted2);margin-bottom:6px;">Rep / User</div>
          <select id="rpt-rep" style="width:100%;background:var(--surface2);border:1.5px solid var(--border2);border-radius:9px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:13px;padding:10px 12px;outline:none;-webkit-appearance:none;">
            <option value="">All Reps</option>
            <option>Tyler Doyle</option>
            <option>Andrew Kirk</option>
            <option>DJ Rogers</option>
            <option>Kody McCann</option>
          </select>
        </div>
        <div>
          <div style="font-size:10px;font-weight:600;letter-spacing:0.1em;text-transform:uppercase;color:var(--muted2);margin-bottom:6px;">Data Source</div>
          <select id="rpt-source" style="width:100%;background:var(--surface2);border:1.5px solid var(--border2);border-radius:9px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:13px;padding:10px 12px;outline:none;-webkit-appearance:none;">
            <option value="greet">Greet Log</option>
            <option value="s2s">Service-to-Sales</option>
            <option value="both">Both Combined</option>
          </select>
        </div>
        <button onclick="runReport()" style="padding:10px 22px;border-radius:9px;background:linear-gradient(135deg,var(--purple),var(--purple2));color:#fff;border:none;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:700;cursor:pointer;white-space:nowrap;transition:all 0.18s;">Run Report ‚Üí</button>
      </div>
      <!-- Quick range buttons -->
      <div style="display:flex;gap:8px;margin-top:14px;flex-wrap:wrap;">
        <span style="font-size:10px;font-weight:600;color:var(--muted2);align-self:center;text-transform:uppercase;letter-spacing:0.08em;">Quick:</span>
        <button onclick="setRange('today')" class="range-btn">Today</button>
        <button onclick="setRange('yesterday')" class="range-btn">Yesterday</button>
        <button onclick="setRange('week')" class="range-btn">This Week</button>
        <button onclick="setRange('month')" class="range-btn">This Month</button>
        <button onclick="setRange('last30')" class="range-btn">Last 30 Days</button>
        <button onclick="setRange('all')" class="range-btn">All Time</button>
      </div>
    </div>

    <!-- Report Output -->
    <div id="rpt-output" style="display:none;">

      <!-- Summary KPIs -->
      <div id="rpt-kpis" style="display:grid;grid-template-columns:repeat(5,1fr);gap:12px;margin-bottom:20px;"></div>

      <!-- Two-column: By Rep + By Source -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px;">
        <div style="background:var(--surface);border:1px solid var(--border2);border-radius:16px;padding:22px;">
          <div style="font-size:10px;font-weight:700;letter-spacing:0.14em;text-transform:uppercase;color:var(--muted2);margin-bottom:16px;">By Rep</div>
          <div id="rpt-by-rep"></div>
        </div>
        <div style="background:var(--surface);border:1px solid var(--border2);border-radius:16px;padding:22px;">
          <div style="font-size:10px;font-weight:700;letter-spacing:0.14em;text-transform:uppercase;color:var(--muted2);margin-bottom:16px;" id="rpt-source-label">By Up Source</div>
          <div id="rpt-by-source"></div>
        </div>
      </div>

      <!-- Two-column: By Outcome + By VOI Type -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px;">
        <div style="background:var(--surface);border:1px solid var(--border2);border-radius:16px;padding:22px;">
          <div style="font-size:10px;font-weight:700;letter-spacing:0.14em;text-transform:uppercase;color:var(--muted2);margin-bottom:16px;">By Outcome</div>
          <div id="rpt-by-outcome"></div>
        </div>
        <div style="background:var(--surface);border:1px solid var(--border2);border-radius:16px;padding:22px;">
          <div style="font-size:10px;font-weight:700;letter-spacing:0.14em;text-transform:uppercase;color:var(--muted2);margin-bottom:16px;" id="rpt-col2-label">By Vehicle Type</div>
          <div id="rpt-by-voi"></div>
        </div>
      </div>

      <!-- Daily breakdown table -->
      <div style="background:var(--surface);border:1px solid var(--border2);border-radius:16px;overflow:hidden;margin-bottom:20px;">
        <div style="padding:18px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;">
          <div style="font-size:10px;font-weight:700;letter-spacing:0.14em;text-transform:uppercase;color:var(--muted2);">Daily Breakdown</div>
          <button onclick="exportReportCSV()" style="padding:7px 14px;border-radius:7px;background:rgba(34,197,94,0.12);border:1px solid rgba(34,197,94,0.3);color:#4ADE80;font-size:11px;font-weight:700;cursor:pointer;font-family:'DM Sans',sans-serif;">‚¨á Export CSV</button>
        </div>
        <div style="overflow-x:auto;">
          <table style="width:100%;border-collapse:collapse;" id="rpt-daily-table">
            <thead>
              <tr style="background:var(--surface2);">
                <th style="padding:10px 16px;text-align:left;font-size:10px;font-weight:700;letter-spacing:0.12em;text-transform:uppercase;color:var(--muted2);">Date</th>
                <th style="padding:10px 16px;text-align:center;font-size:10px;font-weight:700;letter-spacing:0.12em;text-transform:uppercase;color:var(--muted2);">Total Greets</th>
                <th style="padding:10px 16px;text-align:center;font-size:10px;font-weight:700;letter-spacing:0.12em;text-transform:uppercase;color:var(--muted2);">Sold</th>
                <th style="padding:10px 16px;text-align:center;font-size:10px;font-weight:700;letter-spacing:0.12em;text-transform:uppercase;color:var(--muted2);">Demos</th>
                <th style="padding:10px 16px;text-align:center;font-size:10px;font-weight:700;letter-spacing:0.12em;text-transform:uppercase;color:var(--muted2);">Appointments</th>
                <th style="padding:10px 16px;text-align:center;font-size:10px;font-weight:700;letter-spacing:0.12em;text-transform:uppercase;color:var(--muted2);">Write-Ups</th>
                <th style="padding:10px 16px;text-align:center;font-size:10px;font-weight:700;letter-spacing:0.12em;text-transform:uppercase;color:var(--muted2);">Close %</th>
              </tr>
            </thead>
            <tbody id="rpt-daily-body"></tbody>
          </table>
        </div>
      </div>

      <!-- Manager Involved / Time on Lot -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px;">
        <div style="background:var(--surface);border:1px solid var(--border2);border-radius:16px;padding:22px;">
          <div style="font-size:10px;font-weight:700;letter-spacing:0.14em;text-transform:uppercase;color:var(--muted2);margin-bottom:16px;">Manager Involvement</div>
          <div id="rpt-mgr-inv"></div>
        </div>
        <div style="background:var(--surface);border:1px solid var(--border2);border-radius:16px;padding:22px;">
          <div style="font-size:10px;font-weight:700;letter-spacing:0.14em;text-transform:uppercase;color:var(--muted2);margin-bottom:16px;">Time on Lot</div>
          <div id="rpt-time-lot"></div>
        </div>
      </div>

    </div>

    <div id="rpt-empty" style="text-align:center;padding:60px 24px;color:var(--muted);">
      <div style="font-size:48px;margin-bottom:16px;opacity:0.4;">üìä</div>
      <div style="font-size:16px;font-weight:600;margin-bottom:8px;">Select a date range and run your report</div>
      <div style="font-size:13px;color:var(--muted2);">Filter by rep, date range, or data source to generate insights</div>
    </div>
  </div>

  <div class="entries-list fade-in" id="entries-list">
    <div class="loading"><div class="dots"><span></span><span></span><span></span></div></div>
  </div>

</div>

<script>
const SB_URL = 'https://jbkgwtohwsbaorhvuuqb.supabase.co';
const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impia2d3dG9od3NiYW9yaHZ1dXFiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5NjkwNDIsImV4cCI6MjA4NzU0NTA0Mn0.GRXOYbIuVDxU9-FEBYmyd1QmytVUrMIAxbnOSfepzuU';
const H = { 'apikey': SB_KEY, 'Authorization': 'Bearer ' + SB_KEY, 'Content-Type': 'application/json' };

let allEntries = [];
let currentTab = 'all';
const MANAGER = 'Manager'; // could be dynamic

async function loadAll() {
  try {
    const res = await fetch(`${SB_URL}/rest/v1/s2s_entries?select=*&order=id.desc&limit=200`, { headers: H });
    allEntries = await res.json();
    renderKPIs();
    renderEntries();
  } catch(e) {
    document.getElementById('entries-list').innerHTML = '<div class="empty-state"><div class="empty-icon">‚ö†Ô∏è</div><div class="empty-text">Failed to load. Check connection.</div></div>';
  }
}

function isHot(e) { return parseInt(e.eng_score) >= 8; }
function isAging(e) {
  if (!e.created_at) return false;
  const hrs = (Date.now() - new Date(e.created_at)) / 36e5;
  return hrs >= 24 && (!e.followup_status || e.followup_status === 'Pending') && !e.manager_claimed_by;
}
function isUnclaimed(e) { return isHot(e) && !e.manager_claimed_by; }

function renderKPIs() {
  const today = allEntries.filter(e => {
    const d = new Date(e.created_at);
    const now = new Date();
    return d.toDateString() === now.toDateString();
  });
  const hot = allEntries.filter(isHot);
  const unclaimed = allEntries.filter(isUnclaimed);
  const aging = allEntries.filter(isAging);
  const sold = today.filter(e => e.outcome && (e.outcome.includes('New') || e.outcome.includes('Used') || e.outcome.toLowerCase().includes('sold')));
  const temps = today.filter(e => e.eng_score).map(e => parseInt(e.eng_score));
  const avg = temps.length ? (temps.reduce((a,b)=>a+b,0)/temps.length).toFixed(1) : '‚Äî';

  document.getElementById('kpi-today').textContent = today.length;
  document.getElementById('kpi-hot').textContent = hot.length;
  document.getElementById('kpi-sold').textContent = sold.length;
  document.getElementById('kpi-unclaimed').textContent = unclaimed.length;
  document.getElementById('kpi-avg').textContent = avg;
  document.getElementById('kpi-followup').textContent = aging.length;

  document.getElementById('tab-all-count').textContent = allEntries.length;
  document.getElementById('tab-hot-count').textContent = hot.length;
  document.getElementById('tab-aging-count').textContent = aging.length;
  document.getElementById('tab-unclaimed-count').textContent = unclaimed.length;

  const banner = document.getElementById('hot-banner');
  if (unclaimed.length > 0) {
    banner.style.display = 'flex';
    document.getElementById('hot-banner-text').textContent = `üî• ${unclaimed.length} unclaimed hot lead${unclaimed.length>1?'s':''} need immediate attention`;
  } else {
    banner.style.display = 'none';
  }
}

function switchTab(tab, el) {
  currentTab = tab;
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  if (tab === 'reports') {
    document.getElementById('reports-panel').style.display = 'block';
    document.getElementById('entries-list').style.display = 'none';
    document.querySelector('.section-hd').style.display = 'none';
    // Set default dates if empty
    if (!document.getElementById('rpt-from').value) {
      const now = new Date();
      const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
      document.getElementById('rpt-from').value = firstDay.toISOString().slice(0,10);
      document.getElementById('rpt-to').value = now.toISOString().slice(0,10);
    }
  } else {
    document.getElementById('reports-panel').style.display = 'none';
    document.getElementById('entries-list').style.display = 'flex';
    document.querySelector('.section-hd').style.display = 'flex';
    renderEntries();
  }
}

function renderEntries() {
  let filtered = allEntries;
  if (currentTab === 'hot') filtered = allEntries.filter(isHot);
  else if (currentTab === 'aging') filtered = allEntries.filter(isAging);
  else if (currentTab === 'unclaimed') filtered = allEntries.filter(isUnclaimed);

  document.getElementById('showing-count').textContent = `${filtered.length} entries`;
  const list = document.getElementById('entries-list');

  if (!filtered.length) {
    list.innerHTML = '<div class="empty-state"><div class="empty-icon">‚úÖ</div><div class="empty-text">No entries in this view.</div></div>';
    return;
  }

  list.innerHTML = filtered.map(e => buildEntryCard(e)).join('');
}

function tempClass(score) {
  const s = parseInt(score);
  if (s >= 8) return 'temp-hot';
  if (s >= 5) return 'temp-warm';
  return 'temp-cool';
}

function outcomeTag(outcome) {
  if (!outcome) return `<span class="entry-tag tag-outcome-other">‚Äî</span>`;
  if (outcome.includes('New') || outcome.includes('Used') || outcome.toLowerCase().includes('sold')) return `<span class="entry-tag tag-outcome-sold">‚úì ${outcome}</span>`;
  if (outcome.includes('Appt') || outcome.includes('Appointment')) return `<span class="entry-tag tag-outcome-appt">üìÖ ${outcome}</span>`;
  if (outcome.includes('Follow')) return `<span class="entry-tag tag-outcome-follow">‚Ü© ${outcome}</span>`;
  return `<span class="entry-tag tag-outcome-other">${outcome}</span>`;
}

function followupTag(e) {
  const status = e.followup_status || 'Pending';
  if (status === 'Pending') return `<span class="entry-tag tag-pending">‚è≥ Follow-Up Pending</span>`;
  if (status === 'Closed') return `<span class="entry-tag tag-claimed">‚úì Closed</span>`;
  return `<span class="entry-tag tag-followup">‚Ü© ${status}</span>`;
}

function buildEntryCard(e) {
  const score = parseInt(e.eng_score) || 0;
  const hot = score >= 8;
  const aging = isAging(e);
  const claimed = !!e.manager_claimed_by;
  const cardClass = hot ? 'hot' : aging ? 'aging' : claimed ? 'claimed' : '';

  const timeStr = e.timestamp || (e.created_at ? new Date(e.created_at).toLocaleString('en-US',{month:'short',day:'numeric',hour:'numeric',minute:'2-digit'}) : '‚Äî');

  return `<div class="entry-card ${cardClass}" id="card-${e.id}">
    <div class="entry-main">
      <div class="temp-badge ${tempClass(score)}">
        <div class="temp-num">${score || '‚Äî'}</div>
        <div class="temp-lbl">TEMP</div>
      </div>
      <div class="entry-info">
        <div class="entry-name">${e.first_name||''} ${e.last_name||''}</div>
        <div class="entry-meta">
          <span>üë§ ${e.submitter||'Unknown'}</span>
          ${e.veh_year||e.veh_make ? `<span>üöó ${e.veh_year||''} ${e.veh_make||''} ${e.veh_model||''}</span>` : ''}
          ${e.repair_cost ? `<span>üîß $${e.repair_cost}</span>` : ''}
          ${e.phone ? `<span>üìû ${e.phone}</span>` : ''}
        </div>
        <div class="entry-tags">
          ${outcomeTag(e.outcome)}
          ${followupTag(e)}
          ${hot ? '<span class="entry-tag tag-hot">üî• HOT LEAD</span>' : ''}
          ${claimed ? `<span class="entry-tag tag-claimed">‚úì Claimed: ${e.manager_claimed_by}</span>` : ''}
          ${aging ? '<span class="entry-tag tag-followup">‚ö†Ô∏è 24h No Contact</span>' : ''}
        </div>
      </div>
      <div class="entry-right">
        <div class="entry-time">${timeStr}</div>
        ${!claimed && hot ? `<button class="claim-btn" onclick="claimLead(${e.id})">‚ö° Claim Lead</button>` : ''}
        ${claimed ? `<div class="claimed-by">‚úì ${e.manager_claimed_by}</div>` : ''}
      </div>
    </div>
    <button class="expand-toggle" onclick="toggleExpand(${e.id}, this)">
      <span>‚ñº</span> View Details & Action
    </button>
    <div class="entry-expand" id="expand-${e.id}">
      <div class="expand-grid">
        <div>
          <div class="expand-section-title">Customer</div>
          ${expandRow('Phone', e.phone)} ${expandRow('Email', e.email)} ${expandRow('Contact Pref', e.contact_pref)} ${expandRow('Best Time', e.best_time)} ${expandRow('Emotion', e.cust_emotion)}
        </div>
        <div>
          <div class="expand-section-title">Vehicle & Service</div>
          ${expandRow('Vehicle', [e.veh_year,e.veh_make,e.veh_model,e.veh_trim].filter(Boolean).join(' '))}
          ${expandRow('Mileage', e.veh_miles)} ${expandRow('Ownership', e.veh_ownership)} ${expandRow('RO #', e.ro_num)} ${expandRow('Advisor', e.svc_advisor)} ${expandRow('Repair Cost', e.repair_cost ? '$'+e.repair_cost : null)} ${expandRow('Repair Ratio', e.repair_ratio)}
        </div>
        <div>
          <div class="expand-section-title">Trade & Finance</div>
          ${expandRow('Trade Interest', e.trade_interest)} ${expandRow('Trade ACV', e.trade_acv ? '$'+e.trade_acv : null)} ${expandRow('Expected', e.trade_expect ? '$'+e.trade_expect : null)} ${expandRow('Equity', e.trade_equity)} ${expandRow('VOI', e.voi)} ${expandRow('Budget', e.voi_budget)} ${expandRow('Timeline', e.timeline)} ${expandRow('Finance Conv', e.finance_conv)}
        </div>
      </div>
      ${e.notes ? `<div style="background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:14px;font-size:13px;color:var(--muted);"><strong style="color:var(--text);">Rep Notes:</strong> ${e.notes}</div>` : ''}
      <div class="manager-panel">
        <div class="manager-panel-title">‚ö° Manager Action</div>
        <div class="manager-fields">
          <div class="field-group">
            <div class="field-label">Follow-Up Status</div>
            <select class="field-select" id="fs-${e.id}">
              ${['Pending','Called','Left VM','Texted','Came Back In','Appointment Set','No Contact','Closed'].map(s=>`<option value="${s}" ${(e.followup_status||'Pending')===s?'selected':''}>${s}</option>`).join('')}
            </select>
          </div>
          <div class="field-group">
            <div class="field-label">Manager Outcome</div>
            <select class="field-select" id="mo-${e.id}">
              ${['','Sold New','Sold Used','Appointment Set','Working Deal','Not Interested','Needs Follow-Up','No Show'].map(s=>`<option value="${s}" ${(e.manager_outcome||'')===s?'selected':''}>${s||'‚Äî Select ‚Äî'}</option>`).join('')}
            </select>
          </div>
        </div>
        <div class="field-group" style="margin-bottom:12px;">
          <div class="field-label">Coaching / Action Notes</div>
          <textarea class="field-textarea" id="mn-${e.id}" placeholder="What action was taken? Who worked this customer? Any coaching notes...">${e.manager_notes||''}</textarea>
        </div>
        <div style="display:flex;align-items:center;gap:12px;">
          <button class="save-btn" onclick="saveAction(${e.id})">Save Action</button>
          <span class="save-success" id="saved-${e.id}">‚úì Saved</span>
          ${e.manager_claimed_by ? `<span style="font-size:11px;color:var(--muted);">Claimed by ${e.manager_claimed_by} ¬∑ ${e.manager_claimed_at||''}</span>` : ''}
        </div>
      </div>
    </div>
  </div>`;
}

function expandRow(key, val) {
  if (!val || val.trim() === '') return '';
  return `<div class="expand-row"><span class="expand-key">${key}</span><span class="expand-val">${val}</span></div>`;
}

function toggleExpand(id, btn) {
  const panel = document.getElementById('expand-'+id);
  const open = panel.classList.contains('open');
  panel.classList.toggle('open');
  btn.querySelector('span').textContent = open ? '‚ñº' : '‚ñ≤';
}

async function claimLead(id) {
  const claimedAt = new Date().toLocaleString('en-US',{month:'short',day:'numeric',hour:'numeric',minute:'2-digit'});
  const managerName = prompt('Your name (claiming this lead):','Manager') || 'Manager';
  try {
    await fetch(`${SB_URL}/rest/v1/s2s_entries?id=eq.${id}`, {
      method: 'PATCH',
      headers: H,
      body: JSON.stringify({ manager_claimed_by: managerName, manager_claimed_at: claimedAt, followup_status: 'Called' })
    });
    await loadAll();
  } catch(e) { alert('Error claiming lead'); }
}

async function saveAction(id) {
  const followup_status = document.getElementById('fs-'+id)?.value;
  const manager_outcome = document.getElementById('mo-'+id)?.value;
  const manager_notes = document.getElementById('mn-'+id)?.value;
  try {
    await fetch(`${SB_URL}/rest/v1/s2s_entries?id=eq.${id}`, {
      method: 'PATCH',
      headers: H,
      body: JSON.stringify({ followup_status, manager_outcome, manager_notes })
    });
    const saved = document.getElementById('saved-'+id);
    saved.style.opacity = '1';
    setTimeout(() => { saved.style.opacity = '0'; }, 2500);
    // Update local data
    const idx = allEntries.findIndex(e => e.id === id);
    if (idx !== -1) { allEntries[idx].followup_status = followup_status; allEntries[idx].manager_outcome = manager_outcome; allEntries[idx].manager_notes = manager_notes; }
    renderKPIs();
  } catch(e) { alert('Error saving'); }
}

loadAll();
setInterval(loadAll, 60000);

// ‚îÄ‚îÄ REPORTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setRange(r) {
  const now = new Date();
  const fmt = d => d.toISOString().slice(0,10);
  const start = d => { const x = new Date(d); x.setHours(0,0,0,0); return x; };
  let from, to;
  if (r === 'today')     { from = start(now); to = now; }
  else if (r === 'yesterday') { const y = new Date(now); y.setDate(y.getDate()-1); from = start(y); to = new Date(y); to.setHours(23,59,59); }
  else if (r === 'week') { from = start(new Date(now.setDate(now.getDate()-now.getDay()))); to = new Date(); }
  else if (r === 'month'){ from = new Date(new Date().getFullYear(), new Date().getMonth(), 1); to = new Date(); }
  else if (r === 'last30'){ from = new Date(Date.now() - 30*864e5); to = new Date(); }
  else { from = new Date('2025-01-01'); to = new Date(); }
  document.getElementById('rpt-from').value = fmt(from);
  document.getElementById('rpt-to').value = fmt(to);
  runReport();
}

let rptData = { greet: [], s2s: [] };
let rptFiltered = [];

async function runReport() {
  const from = document.getElementById('rpt-from').value;
  const to = document.getElementById('rpt-to').value;
  const rep = document.getElementById('rpt-rep').value;
  const src = document.getElementById('rpt-source').value;

  if (!from || !to) { alert('Please select a date range.'); return; }

  const toEnd = to + 'T23:59:59';
  const SB = 'https://jbkgwtohwsbaorhvuuqb.supabase.co';
  const KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impia2d3dG9od3NiYW9yaHZ1dXFiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5NjkwNDIsImV4cCI6MjA4NzU0NTA0Mn0.GRXOYbIuVDxU9-FEBYmyd1QmytVUrMIAxbnOSfepzuU';
  const H2 = {'apikey':KEY,'Authorization':'Bearer '+KEY};

  document.getElementById('rpt-empty').style.display = 'none';
  document.getElementById('rpt-output').style.display = 'none';

  // Fetch greet log
  if (src === 'greet' || src === 'both') {
    let url = `${SB}/rest/v1/greet_log?select=*&created_at=gte.${from}T00:00:00&created_at=lte.${toEnd}&order=created_at.asc&limit=2000`;
    if (rep) url += `&rep_name=eq.${encodeURIComponent(rep)}`;
    const r = await fetch(url, {headers: H2});
    rptData.greet = await r.json();
  } else { rptData.greet = []; }

  // Fetch s2s
  if (src === 's2s' || src === 'both') {
    let url = `${SB}/rest/v1/s2s_entries?select=*&created_at=gte.${from}T00:00:00&created_at=lte.${toEnd}&order=created_at.asc&limit=2000`;
    if (rep) url += `&submitter=eq.${encodeURIComponent(rep)}`;
    const r = await fetch(url, {headers: H2});
    rptData.s2s = await r.json();
  } else { rptData.s2s = []; }

  renderReport(src);
}

function renderReport(src) {
  const greet = rptData.greet;
  const s2s = rptData.s2s;
  const all = [...greet, ...s2s];

  if (!all.length) {
    document.getElementById('rpt-empty').style.display = 'block';
    document.getElementById('rpt-empty').innerHTML = '<div style="font-size:48px;margin-bottom:16px;opacity:0.4;">üì≠</div><div style="font-size:16px;font-weight:600;color:var(--muted);">No entries found for this date range</div>';
    return;
  }

  document.getElementById('rpt-output').style.display = 'block';

  // ‚îÄ‚îÄ KPIs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const totalGreets = greet.length;
  const totalS2S = s2s.length;
  const soldCount = greet.filter(e => (e.outcome||'').includes('Sold')).length + s2s.filter(e => (e.outcome||'').toLowerCase().includes('sold')).length;
  const demoCount = greet.filter(e => (e.outcome||'').includes('Demo')).length;
  const apptCount = greet.filter(e => (e.outcome||'').includes('Appointment')).length + s2s.filter(e => (e.outcome||'').includes('Appointment')).length;
  const closeRate = totalGreets > 0 ? Math.round(soldCount / totalGreets * 100) : 0;

  const kpiData = [
    { lbl: src==='s2s'?'S2S Entries':src==='both'?'Total Entries':'Total Greets', val: src==='both'?all.length:src==='s2s'?totalS2S:totalGreets, color:'#6366F1', sub:'in date range' },
    { lbl: 'Sold', val: soldCount, color:'#22C55E', sub:'closed deals' },
    { lbl: 'Demos / Test Drives', val: demoCount, color:'#F59E0B', sub:'from greet log' },
    { lbl: 'Appointments', val: apptCount, color:'#60A5FA', sub:'set' },
    { lbl: 'Close Rate', val: closeRate + '%', color:'#F97316', sub:'greets to sold' },
  ];
  document.getElementById('rpt-kpis').innerHTML = kpiData.map(k => `
    <div class="rpt-kpi-card" style="border-top-color:${k.color};">
      <div class="rpt-kpi-lbl">${k.lbl}</div>
      <div class="rpt-kpi-val" style="color:${k.color};">${k.val}</div>
      <div class="rpt-kpi-sub">${k.sub}</div>
    </div>
  `).join('');

  // ‚îÄ‚îÄ BY REP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const repCounts = {};
  greet.forEach(e => { const r = e.rep_name||'Unknown'; repCounts[r] = (repCounts[r]||0)+1; });
  s2s.forEach(e => { const r = e.submitter||'Unknown'; repCounts[r] = (repCounts[r]||0)+1; });
  renderBarChart('rpt-by-rep', repCounts, '#6366F1', all.length);

  // ‚îÄ‚îÄ BY SOURCE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  document.getElementById('rpt-source-label').textContent = src==='s2s' ? 'By Outcome' : 'By Up Source';
  const srcCounts = {};
  if (src === 's2s') {
    s2s.forEach(e => { const v = e.outcome||'Unknown'; srcCounts[v] = (srcCounts[v]||0)+1; });
  } else {
    greet.forEach(e => { const v = e.up_source||'Unknown'; srcCounts[v] = (srcCounts[v]||0)+1; });
    if (src === 'both') s2s.forEach(e => { const v = 'S2S: '+(e.outcome||'Unknown'); srcCounts[v] = (srcCounts[v]||0)+1; });
  }
  renderBarChart('rpt-by-source', srcCounts, '#F59E0B', all.length);

  // ‚îÄ‚îÄ BY OUTCOME ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const outCounts = {};
  greet.forEach(e => { const v = e.outcome||'Unknown'; outCounts[v] = (outCounts[v]||0)+1; });
  if (src !== 'greet') s2s.forEach(e => { const v = e.outcome||'Unknown'; outCounts[v] = (outCounts[v]||0)+1; });
  renderBarChart('rpt-by-outcome', outCounts, '#22C55E', all.length);

  // ‚îÄ‚îÄ BY VOI / TIME ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  document.getElementById('rpt-col2-label').textContent = src==='s2s' ? 'By Temp Score Range' : 'By Vehicle Type';
  const voiCounts = {};
  if (src === 's2s') {
    s2s.forEach(e => {
      const s = parseInt(e.eng_score||0);
      const bucket = s>=8?'üî• Hot (8-10)':s>=5?'üå° Warm (5-7)':'‚ùÑ Cool (1-4)';
      voiCounts[bucket] = (voiCounts[bucket]||0)+1;
    });
  } else {
    greet.forEach(e => { const v = e.voi_type||'Unknown'; voiCounts[v] = (voiCounts[v]||0)+1; });
  }
  renderBarChart('rpt-by-voi', voiCounts, '#60A5FA', all.length);

  // ‚îÄ‚îÄ MANAGER INVOLVEMENT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const mgrYes = greet.filter(e => e.manager_involved==='Yes').length;
  const mgrNo = greet.filter(e => e.manager_involved!=='Yes').length;
  document.getElementById('rpt-mgr-inv').innerHTML = `
    ${renderBarRow('Manager Involved', mgrYes, greet.length, '#6366F1')}
    ${renderBarRow('No Manager', mgrNo, greet.length, '#374151')}
    <div style="margin-top:14px;font-size:11px;color:var(--muted2);">Based on ${greet.length} greet log entries</div>
  `;

  // ‚îÄ‚îÄ TIME ON LOT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const timeCounts = {};
  greet.forEach(e => { const v = e.time_on_lot||'Not logged'; timeCounts[v] = (timeCounts[v]||0)+1; });
  renderBarChart('rpt-time-lot', timeCounts, '#F97316', greet.length);

  // ‚îÄ‚îÄ DAILY BREAKDOWN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const byDay = {};
  [...greet,...s2s].forEach(e => {
    const d = e.created_at ? e.created_at.slice(0,10) : 'Unknown';
    if (!byDay[d]) byDay[d] = { total:0, sold:0, demo:0, appt:0, writeup:0 };
    byDay[d].total++;
    const o = (e.outcome||'').toLowerCase();
    if (o.includes('sold')) byDay[d].sold++;
    if (o.includes('demo') || o.includes('test')) byDay[d].demo++;
    if (o.includes('appt') || o.includes('appointment')) byDay[d].appt++;
    if (o.includes('write') || o.includes('working')) byDay[d].writeup++;
  });

  const sorted = Object.entries(byDay).sort((a,b) => b[0].localeCompare(a[0]));
  rptExportData = sorted;
  document.getElementById('rpt-daily-body').innerHTML = sorted.map(([date, d]) => {
    const cr = d.total > 0 ? Math.round(d.sold/d.total*100) : 0;
    const dateLabel = new Date(date+'T12:00:00').toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'});
    return `<tr style="border-bottom:1px solid var(--border);">
      <td style="padding:10px 16px;font-size:13px;font-weight:600;">${dateLabel}</td>
      <td style="padding:10px 16px;text-align:center;font-family:'DM Mono',monospace;font-size:13px;font-weight:700;color:var(--purple2);">${d.total}</td>
      <td style="padding:10px 16px;text-align:center;font-size:13px;font-weight:700;color:#4ADE80;">${d.sold||'‚Äî'}</td>
      <td style="padding:10px 16px;text-align:center;font-size:13px;color:var(--muted);">${d.demo||'‚Äî'}</td>
      <td style="padding:10px 16px;text-align:center;font-size:13px;color:var(--muted);">${d.appt||'‚Äî'}</td>
      <td style="padding:10px 16px;text-align:center;font-size:13px;color:var(--muted);">${d.writeup||'‚Äî'}</td>
      <td style="padding:10px 16px;text-align:center;font-size:13px;font-weight:700;color:${cr>=20?'#4ADE80':cr>=10?'#F59E0B':'#FC8181'};">${cr}%</td>
    </tr>`;
  }).join('');
}

function renderBarChart(id, counts, color, total) {
  const sorted = Object.entries(counts).sort((a,b)=>b[1]-a[1]);
  const max = sorted[0]?.[1] || 1;
  document.getElementById(id).innerHTML = sorted.length
    ? sorted.map(([label, count]) => renderBarRow(label, count, max, color)).join('')
    : '<div style="color:var(--muted2);font-size:13px;">No data</div>';
}

function renderBarRow(label, count, max, color) {
  const pct = Math.round(count/max*100);
  const share = Math.round(count/(max||1)*100);
  return `<div class="rpt-row">
    <div class="rpt-label" title="${label}">${label}</div>
    <div class="rpt-bar-wrap"><div class="rpt-bar" style="width:${pct}%;background:${color};"></div></div>
    <div class="rpt-count">${count}</div>
  </div>`;
}

let rptExportData = [];
function exportReportCSV() {
  if (!rptExportData.length) return alert('Run a report first.');
  const headers = ['Date','Total','Sold','Demo','Appointment','WriteUp','CloseRate'];
  const rows = rptExportData.map(([date, d]) => {
    const cr = d.total > 0 ? Math.round(d.sold/d.total*100)+'%' : '0%';
    return [date, d.total, d.sold, d.demo, d.appt, d.writeup, cr].join(',');
  });
  const csv = [headers.join(','), ...rows].join('\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='report.csv'; a.click();
  URL.revokeObjectURL(url);
}


// ‚îÄ‚îÄ CSV Export ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toCSV(rows, headers) {
  const escape = v => {
    if (v == null) return '';
    const s = String(v).replace(/"/g, '""');
    return s.includes(',') || s.includes('"') || s.includes('\n') ? `"${s}"` : s;
  };
  return [headers.join(','), ...rows.map(r => headers.map(h => escape(r[h])).join(','))].join('\n');
}

function downloadCSV(csv, filename) {
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename; a.click();
  URL.revokeObjectURL(url);
}

function exportS2SCSV() {
  if (!allEntries.length) return alert('No entries loaded yet.');
  const headers = ['id','submitter','first_name','last_name','phone','email','veh_year','veh_make','veh_model','veh_trim','veh_miles','repair_cost','eng_score','outcome','followup_status','manager_outcome','manager_claimed_by','manager_notes','notes','created_at'];
  const csv = toCSV(allEntries, headers);
  const date = new Date().toISOString().slice(0,10);
  downloadCSV(csv, `s2s-entries-${date}.csv`);
}

async function exportGreetCSV() {
  const res = await fetch(`${SB_URL}/rest/v1/greet_log?select=*&order=id.desc&limit=1000`, {headers: H});
  const data = await res.json();
  if (!data.length) return alert('No greet log entries found.');
  const headers = ['id','rep_name','customer_name','up_source','voi_type','voi','outcome','time_on_lot','manager_involved','handed_off_to','notes','created_at'];
  const csv = toCSV(data, headers);
  const date = new Date().toISOString().slice(0,10);
  downloadCSV(csv, `greet-log-${date}.csv`);
}

// ‚îÄ‚îÄ PDF / Print Export ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function exportS2SPDF() {
  if (!allEntries.length) return alert('No entries loaded yet.');
  const date = new Date().toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
  const rows = allEntries.map(e => `
    <tr>
      <td>${e.submitter||'‚Äî'}</td>
      <td>${e.first_name||''} ${e.last_name||''}</td>
      <td>${e.phone||'‚Äî'}</td>
      <td>${e.veh_year||''} ${e.veh_make||''} ${e.veh_model||''}</td>
      <td>${e.repair_cost ? '$'+e.repair_cost : '‚Äî'}</td>
      <td style="text-align:center;font-weight:700;">${e.eng_score||'‚Äî'}</td>
      <td>${e.outcome||'‚Äî'}</td>
      <td>${e.followup_status||'Pending'}</td>
      <td>${e.created_at ? new Date(e.created_at).toLocaleString('en-US',{month:'short',day:'numeric',hour:'numeric',minute:'2-digit'}) : '‚Äî'}</td>
    </tr>
  `).join('');
  const html = `<!DOCTYPE html><html><head><title>ServiceBridge S2S Export</title>
  <style>
    body{font-family:Arial,sans-serif;font-size:11px;color:#111;padding:24px;}
    h1{font-size:20px;margin-bottom:4px;}
    .sub{color:#666;font-size:12px;margin-bottom:16px;}
    table{width:100%;border-collapse:collapse;}
    th{background:#1a1a2e;color:#fff;padding:8px 10px;text-align:left;font-size:10px;text-transform:uppercase;letter-spacing:0.08em;}
    td{padding:7px 10px;border-bottom:1px solid #eee;vertical-align:top;}
    tr:nth-child(even) td{background:#f9f9f9;}
    @media print{body{padding:0;} h1{font-size:16px;}}
  
.range-btn{padding:6px 13px;border-radius:7px;background:var(--surface2);border:1px solid var(--border2);color:var(--muted);font-family:'DM Sans',sans-serif;font-size:11px;font-weight:600;cursor:pointer;transition:all 0.18s;}
.range-btn:hover{color:var(--text);border-color:var(--purple2);background:rgba(99,102,241,0.1);}
.rpt-row{display:flex;align-items:center;gap:10px;margin-bottom:10px;}
.rpt-bar-wrap{flex:1;height:8px;background:rgba(255,255,255,0.07);border-radius:4px;overflow:hidden;}
.rpt-bar{height:100%;border-radius:4px;transition:width 0.6s ease;}
.rpt-label{font-size:12px;font-weight:600;color:var(--text);min-width:140px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.rpt-count{font-family:'DM Mono',monospace;font-size:12px;font-weight:600;color:var(--muted);min-width:28px;text-align:right;}
.rpt-pct{font-size:10px;font-weight:700;color:var(--muted2);min-width:36px;text-align:right;}
.rpt-kpi-card{background:var(--surface);border:1px solid var(--border2);border-radius:14px;padding:18px;position:relative;overflow:hidden;}
.rpt-kpi-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;}
.rpt-kpi-lbl{font-size:9px;font-weight:700;letter-spacing:0.14em;text-transform:uppercase;color:rgba(255,255,255,0.45);margin-bottom:6px;}
.rpt-kpi-val{font-family:'Bebas Neue',sans-serif;font-size:44px;line-height:1;color:#fff;}
.rpt-kpi-sub{font-size:11px;color:rgba(255,255,255,0.4);margin-top:3px;}
</style></head><body>
  <h1>ServiceBridge ‚Äî S2S Entries</h1>
  <div class="sub">Gallatin CDJR ¬∑ Exported ${date} ¬∑ ${allEntries.length} entries</div>
  <table>
    <thead><tr><th>Rep</th><th>Customer</th><th>Phone</th><th>Vehicle</th><th>Repair $</th><th>Temp</th><th>Outcome</th><th>Follow-Up</th><th>Date</th></tr></thead>
    <tbody>${rows}</tbody>
  </table>
  </body></html>`;
  const w = window.open('','_blank');
  w.document.write(html);
  w.document.close();
  setTimeout(() => w.print(), 500);
}

async function exportGreetPDF() {
  const res = await fetch(`${SB_URL}/rest/v1/greet_log?select=*&order=id.desc&limit=500`, {headers: H});
  const data = await res.json();
  if (!data.length) return alert('No greet log entries found.');
  const date = new Date().toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
  const rows = data.map(e => `
    <tr>
      <td>${e.rep_name||'‚Äî'}</td>
      <td>${e.customer_name||'‚Äî'}</td>
      <td>${e.up_source||'‚Äî'}</td>
      <td>${e.voi_type||'‚Äî'}</td>
      <td>${e.voi||'‚Äî'}</td>
      <td>${e.outcome||'‚Äî'}</td>
      <td>${e.time_on_lot||'‚Äî'}</td>
      <td>${e.manager_involved||'‚Äî'}</td>
      <td>${e.created_at ? new Date(e.created_at).toLocaleString('en-US',{month:'short',day:'numeric',hour:'numeric',minute:'2-digit'}) : '‚Äî'}</td>
    </tr>
  `).join('');
  const html = `<!DOCTYPE html><html><head><title>ServiceBridge Greet Log Export</title>
  <style>
    body{font-family:Arial,sans-serif;font-size:11px;color:#111;padding:24px;}
    h1{font-size:20px;margin-bottom:4px;}
    .sub{color:#666;font-size:12px;margin-bottom:16px;}
    table{width:100%;border-collapse:collapse;}
    th{background:#1a1a2e;color:#fff;padding:8px 10px;text-align:left;font-size:10px;text-transform:uppercase;letter-spacing:0.08em;}
    td{padding:7px 10px;border-bottom:1px solid #eee;vertical-align:top;}
    tr:nth-child(even) td{background:#f9f9f9;}
    @media print{body{padding:0;}}
  
.range-btn{padding:6px 13px;border-radius:7px;background:var(--surface2);border:1px solid var(--border2);color:var(--muted);font-family:'DM Sans',sans-serif;font-size:11px;font-weight:600;cursor:pointer;transition:all 0.18s;}
.range-btn:hover{color:var(--text);border-color:var(--purple2);background:rgba(99,102,241,0.1);}
.rpt-row{display:flex;align-items:center;gap:10px;margin-bottom:10px;}
.rpt-bar-wrap{flex:1;height:8px;background:rgba(255,255,255,0.07);border-radius:4px;overflow:hidden;}
.rpt-bar{height:100%;border-radius:4px;transition:width 0.6s ease;}
.rpt-label{font-size:12px;font-weight:600;color:var(--text);min-width:140px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.rpt-count{font-family:'DM Mono',monospace;font-size:12px;font-weight:600;color:var(--muted);min-width:28px;text-align:right;}
.rpt-pct{font-size:10px;font-weight:700;color:var(--muted2);min-width:36px;text-align:right;}
.rpt-kpi-card{background:var(--surface);border:1px solid var(--border2);border-radius:14px;padding:18px;position:relative;overflow:hidden;}
.rpt-kpi-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;}
.rpt-kpi-lbl{font-size:9px;font-weight:700;letter-spacing:0.14em;text-transform:uppercase;color:rgba(255,255,255,0.45);margin-bottom:6px;}
.rpt-kpi-val{font-family:'Bebas Neue',sans-serif;font-size:44px;line-height:1;color:#fff;}
.rpt-kpi-sub{font-size:11px;color:rgba(255,255,255,0.4);margin-top:3px;}
</style></head><body>
  <h1>ServiceBridge ‚Äî Greet Log</h1>
  <div class="sub">Gallatin CDJR ¬∑ Exported ${date} ¬∑ ${data.length} entries</div>
  <table>
    <thead><tr><th>Rep</th><th>Customer</th><th>Source</th><th>VOI Type</th><th>Vehicle</th><th>Outcome</th><th>Time on Lot</th><th>Mgr?</th><th>Date</th></tr></thead>
    <tbody>${rows}</tbody>
  </table>
  </body></html>`;
  const w = window.open('','_blank');
  w.document.write(html);
  w.document.close();
  setTimeout(() => w.print(), 500);
}

</script>
</body>
</html>
