<!DOCTYPE html>
<html lang="en">
<head>
<script>
(function(){
  var rep = null;
  try { rep = JSON.parse(sessionStorage.getItem('sb_rep') || 'null'); } catch(e) {}
  if (!rep || !rep.name || !rep.role) { window.location.replace('/login.html'); }
})();
</script>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#06080E">
<title>Dashboard ‚Äî ServiceBridge</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Instrument+Serif:ital@0;1&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #06080E; --bg2: #0C0F18;
  --surface: #111520; --surface2: #171C2A; --surface3: #1D2333;
  --red: #E01B36; --red-soft: rgba(224,27,54,0.10);
  --gold: #D4A73A; --gold-soft: rgba(212,167,58,0.10);
  --green: #2DD4A0; --green-soft: rgba(45,212,160,0.10);
  --blue: #6C70F0; --blue-soft: rgba(108,112,240,0.10);
  --orange: #F59E0B; --orange-soft: rgba(245,158,11,0.10);
  --purple: #A855F7;
  --text: #EDEEF2; --text2: rgba(237,238,242,0.62); --text3: rgba(237,238,242,0.34);
  --border: rgba(255,255,255,0.06); --border2: rgba(255,255,255,0.10); --border3: rgba(255,255,255,0.16);
  --r: 14px; --rsm: 10px; --rlg: 18px;
  --spring: cubic-bezier(0.16, 1, 0.3, 1);
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
html{scroll-behavior:smooth;}
body{background:var(--bg);color:var(--text);font-family:'Plus Jakarta Sans',-apple-system,sans-serif;min-height:100vh;overflow-x:hidden;-webkit-font-smoothing:antialiased;font-size:15px;line-height:1.5;letter-spacing:-0.01em;}
.bg-noise{position:fixed;inset:0;z-index:0;pointer-events:none;opacity:0.35;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E");}
.bg-grad{position:fixed;inset:0;z-index:0;pointer-events:none;background:radial-gradient(ellipse 60% 50% at 20% 0%,rgba(224,27,54,0.06) 0%,transparent 70%),radial-gradient(ellipse 50% 60% at 80% 100%,rgba(108,112,240,0.04) 0%,transparent 70%);}

/* Header */
.hdr{display:flex;align-items:center;justify-content:space-between;padding:14px 20px 12px;padding-top:max(14px,env(safe-area-inset-top));border-bottom:1px solid var(--border);background:rgba(6,8,14,0.92);backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);position:sticky;top:0;z-index:100;}
.hdr::after{content:'';position:absolute;bottom:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--red),var(--blue),transparent);opacity:0.4;}
.hdr-l{display:flex;align-items:center;gap:10px;}
.hdr-logo{width:30px;height:30px;background:var(--red);border-radius:8px;display:flex;align-items:center;justify-content:center;}
.hdr-logo svg{width:14px;height:14px;}
.hdr-t{font-family:'Instrument Serif',Georgia,serif;font-size:17px;letter-spacing:-0.01em;}
.hdr-r{display:flex;align-items:center;gap:8px;position:relative;}
.live{font-size:10px;font-weight:700;padding:4px 10px;border-radius:20px;background:var(--green-soft);border:1px solid rgba(45,212,160,0.25);color:var(--green);letter-spacing:0.06em;display:flex;align-items:center;gap:5px;}
.live-dot{width:6px;height:6px;border-radius:50%;background:var(--green);animation:pulse 2s ease infinite;}
@keyframes pulse{0%,100%{opacity:1;}50%{opacity:0.4;}}
.hdr-user{font-size:11px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:0.1em;}
.ham{background:none;border:1px solid var(--border2);border-radius:8px;width:32px;height:32px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;cursor:pointer;transition:all 0.18s;padding:0;flex-shrink:0;}
.ham:hover{border-color:rgba(255,255,255,0.18);background:rgba(255,255,255,0.03);}
.ham span{display:block;width:14px;height:1.5px;background:rgba(255,255,255,0.55);border-radius:2px;transition:all 0.2s;}
.ham.open span:nth-child(1){transform:translateY(5.5px) rotate(45deg);}
.ham.open span:nth-child(2){opacity:0;}
.ham.open span:nth-child(3){transform:translateY(-5.5px) rotate(-45deg);}
.nav-ov{position:fixed;inset:0;z-index:190;display:none;}
.nav-ov.open{display:block;}
.nav-dd{position:absolute;top:calc(100% + 8px);right:0;background:var(--surface);border:1px solid var(--border2);border-radius:var(--r);min-width:230px;padding:6px;box-shadow:0 20px 60px rgba(0,0,0,0.6);z-index:201;opacity:0;transform:translateY(-8px) scale(0.97);pointer-events:none;transition:all 0.18s var(--spring);}
.nav-dd.open{opacity:1;transform:translateY(0) scale(1);pointer-events:all;}
.di{display:flex;align-items:center;gap:10px;padding:11px 14px;border-radius:var(--rsm);font-size:13px;font-weight:600;color:var(--text2);text-decoration:none;cursor:pointer;transition:all 0.15s;}
.di:hover{background:rgba(255,255,255,0.04);color:var(--text);}
.di.ap{background:var(--red-soft);color:#F87171;}
.di-ic{font-size:14px;width:20px;text-align:center;}
.ddv{height:1px;background:var(--border);margin:4px 0;}
.dd-admin{display:none;}
.dd-admin.show{display:flex;}
.ddv.dd-admin.show{display:block;}
.nui{display:flex;align-items:center;justify-content:space-between;padding:8px 14px 4px;}
.nud{font-size:11px;font-weight:700;color:var(--text3);letter-spacing:0.08em;}
.nrp{font-size:9px;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;padding:3px 8px;border-radius:20px;}
.r-admin{background:var(--blue-soft);color:var(--blue);border:1px solid rgba(108,112,240,0.2);}
.r-manager{background:var(--gold-soft);color:var(--gold);border:1px solid rgba(212,167,58,0.2);}
.r-sales{background:rgba(255,255,255,0.05);color:var(--text2);border:1px solid rgba(255,255,255,0.08);}

/* Page */
.page{max-width:1200px;margin:0 auto;padding:22px 20px 80px;position:relative;z-index:1;}

/* KPI row */
.kpis{display:grid;grid-template-columns:repeat(6,1fr);gap:10px;margin-bottom:18px;}
.kpi{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:15px 14px;position:relative;overflow:hidden;transition:transform 0.2s var(--spring);}
.kpi:hover{transform:translateY(-2px);}
.kpi::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;}
.kb::before{background:var(--blue);}.kr::before{background:var(--red);}.kg::before{background:var(--green);}
.ko::before{background:var(--orange);}.kd::before{background:var(--gold);}.kp::before{background:var(--purple);}
.kpi-l{font-size:9px;font-weight:700;letter-spacing:0.12em;text-transform:uppercase;color:var(--text3);margin-bottom:5px;}
.kpi-v{font-family:'Instrument Serif',Georgia,serif;font-size:34px;line-height:1;}
.kb .kpi-v{color:var(--blue);}.kr .kpi-v{color:#F87171;}.kg .kpi-v{color:var(--green);}
.ko .kpi-v{color:var(--orange);}.kd .kpi-v{color:var(--gold);}.kp .kpi-v{color:var(--purple);}

/* Alert banner */
.alert-banner{background:var(--red-soft);border:1px solid rgba(224,27,54,0.25);border-radius:var(--r);padding:14px 18px;margin-bottom:14px;display:none;align-items:center;gap:12px;animation:pBorder 2s ease infinite;}
@keyframes pBorder{0%,100%{border-color:rgba(224,27,54,0.25);}50%{border-color:rgba(224,27,54,0.5);}}
.a-dot{width:10px;height:10px;border-radius:50%;background:var(--red);animation:pulse 1.5s ease infinite;flex-shrink:0;}
.a-txt{font-size:13px;font-weight:700;color:#F87171;}
.a-sub{font-size:11px;color:rgba(248,113,113,0.6);margin-top:1px;}

/* Tabs */
.tabs{display:flex;gap:4px;margin-bottom:14px;background:var(--surface);border:1px solid var(--border);border-radius:var(--rsm);padding:4px;width:fit-content;overflow-x:auto;}
.tb{padding:8px 14px;border-radius:7px;font-size:12px;font-weight:700;color:var(--text3);cursor:pointer;transition:all 0.18s;border:none;background:transparent;font-family:'Plus Jakarta Sans',sans-serif;display:flex;align-items:center;gap:6px;white-space:nowrap;}
.tb.ac{background:var(--surface3);color:var(--text);}
.tb-badge{font-size:10px;font-weight:700;padding:1px 7px;border-radius:10px;background:var(--red);color:#fff;}

/* Export */
.exp-bar{display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap;}
.exp{display:inline-flex;align-items:center;gap:6px;padding:8px 14px;border-radius:var(--rsm);font-size:12px;font-weight:700;cursor:pointer;border:none;font-family:'Plus Jakarta Sans',sans-serif;transition:all 0.18s;}
.exp-csv{background:var(--green-soft);border:1px solid rgba(45,212,160,0.2);color:var(--green);}
.exp-csv:hover{background:rgba(45,212,160,0.18);}
.exp-pdf{background:var(--red-soft);border:1px solid rgba(224,27,54,0.2);color:#F87171;}
.exp-pdf:hover{background:rgba(224,27,54,0.18);}

.sh{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;}
.sh-t{font-size:10px;font-weight:700;letter-spacing:0.14em;text-transform:uppercase;color:var(--text3);}
.sh-c{font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--text3);}

/* Entry cards */
.el{display:flex;flex-direction:column;gap:8px;}
.ec{background:var(--surface);border:1px solid var(--border);border-radius:16px;overflow:hidden;transition:all 0.2s;}
.ec:hover{border-color:var(--border2);}
.ec.hot{border-color:rgba(224,27,54,0.3);background:rgba(224,27,54,0.03);}
.ec.aging{border-color:rgba(245,158,11,0.3);background:rgba(245,158,11,0.03);}
.em{padding:14px 16px;display:grid;grid-template-columns:auto 1fr auto;gap:12px;align-items:start;}
.tb2{width:46px;height:46px;border-radius:12px;display:flex;flex-direction:column;align-items:center;justify-content:center;flex-shrink:0;font-family:'JetBrains Mono',monospace;}
.tb2 .tn{font-size:20px;font-weight:700;line-height:1;}
.tb2 .tl{font-size:8px;font-weight:600;letter-spacing:0.06em;opacity:0.7;}
.t-hot{background:var(--red-soft);border:1px solid rgba(224,27,54,0.3);color:#F87171;}
.t-warm{background:var(--orange-soft);border:1px solid rgba(245,158,11,0.3);color:var(--orange);}
.t-cool{background:var(--blue-soft);border:1px solid rgba(108,112,240,0.3);color:var(--blue);}
.en{font-size:15px;font-weight:700;margin-bottom:3px;}
.emeta{font-size:12px;color:var(--text3);display:flex;flex-wrap:wrap;gap:8px;margin-bottom:5px;}
.emeta span{display:flex;align-items:center;gap:3px;}
.etags{display:flex;flex-wrap:wrap;gap:5px;}
.et{font-size:10px;font-weight:700;padding:3px 10px;border-radius:20px;letter-spacing:0.03em;}
.et-sold{background:var(--green-soft);color:var(--green);border:1px solid rgba(45,212,160,0.2);}
.et-appt{background:var(--blue-soft);color:var(--blue);border:1px solid rgba(108,112,240,0.2);}
.et-follow{background:var(--gold-soft);color:var(--gold);border:1px solid rgba(212,167,58,0.2);}
.et-other{background:rgba(255,255,255,0.04);color:var(--text3);border:1px solid var(--border);}
.et-hot{background:var(--red-soft);color:#F87171;border:1px solid rgba(224,27,54,0.2);animation:pulse 2s ease infinite;}
.et-claimed{background:var(--green-soft);color:var(--green);border:1px solid rgba(45,212,160,0.2);}
.et-aging{background:var(--orange-soft);color:var(--orange);border:1px solid rgba(245,158,11,0.2);}
.eright{display:flex;flex-direction:column;align-items:flex-end;gap:5px;flex-shrink:0;}
.etime{font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--text3);}
.cbtn{padding:6px 13px;border-radius:8px;font-size:11px;font-weight:700;background:var(--blue);color:#fff;border:none;cursor:pointer;font-family:'Plus Jakarta Sans',sans-serif;transition:all 0.18s;white-space:nowrap;}
.cbtn:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(108,112,240,0.3);}
.clby{font-size:11px;color:var(--green);font-weight:600;text-align:right;}
.ebtn{padding:5px 11px;border-radius:8px;font-size:11px;font-weight:700;background:var(--blue-soft);border:1px solid rgba(108,112,240,0.2);color:var(--blue);cursor:pointer;font-family:'Plus Jakarta Sans',sans-serif;transition:all 0.18s;white-space:nowrap;}
.ebtn:hover{background:rgba(108,112,240,0.18);}
.crm{padding:5px 11px;border-radius:8px;font-size:11px;font-weight:700;background:var(--green-soft);border:1px solid rgba(45,212,160,0.2);color:var(--green);cursor:pointer;font-family:'Plus Jakarta Sans',sans-serif;transition:all 0.18s;white-space:nowrap;}
.crm:hover{background:rgba(45,212,160,0.18);}
.crm:disabled{opacity:0.4;pointer-events:none;}
.crm-ok{font-size:9px;font-weight:700;padding:2px 7px;border-radius:10px;background:var(--green-soft);color:var(--green);border:1px solid rgba(45,212,160,0.2);white-space:nowrap;}

/* Expand toggle */
.ext{width:100%;background:none;border:none;border-top:1px solid var(--border);color:var(--text3);font-size:11px;font-weight:600;padding:9px;cursor:pointer;font-family:'Plus Jakarta Sans',sans-serif;transition:all 0.18s;display:flex;align-items:center;justify-content:center;gap:5px;}
.ext:hover{color:var(--text);background:rgba(255,255,255,0.02);}
.ee{border-top:1px solid var(--border);padding:16px;display:none;background:var(--surface2);}
.ee.open{display:block;}
.eg{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px;margin-bottom:12px;}
.est{font-size:9px;font-weight:700;letter-spacing:0.12em;text-transform:uppercase;color:var(--text3);margin-bottom:8px;}
.er{display:flex;justify-content:space-between;align-items:baseline;padding:3px 0;border-bottom:1px solid var(--border);}
.er:last-child{border-bottom:none;}
.erk{font-size:11px;color:var(--text3);}
.erv{font-size:12px;font-weight:600;color:var(--text);text-align:right;max-width:160px;word-break:break-word;}

/* Manager action panel */
.mp{background:var(--surface3);border:1px solid var(--border2);border-radius:var(--rsm);padding:14px;margin-top:12px;}
.mp-t{font-size:10px;font-weight:700;letter-spacing:0.12em;text-transform:uppercase;color:var(--blue);margin-bottom:10px;}
.mf{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px;}
.fg{display:flex;flex-direction:column;gap:4px;}
.fl{font-size:9px;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;color:var(--text3);}
.fi{background:var(--surface);border:1px solid var(--border2);border-radius:8px;color:var(--text);font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;padding:9px 12px;width:100%;transition:border-color 0.18s;-webkit-appearance:none;}
.fi:focus{outline:none;border-color:var(--blue);box-shadow:0 0 0 3px rgba(108,112,240,0.08);}
.fi option{background:var(--surface2);}
textarea.fi{resize:vertical;min-height:60px;}
.sv{padding:8px 16px;border-radius:8px;font-size:12px;font-weight:700;background:var(--blue);color:#fff;border:none;cursor:pointer;font-family:'Plus Jakarta Sans',sans-serif;transition:all 0.18s;}
.sv:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(108,112,240,0.3);}
.sv-ok{font-size:11px;color:var(--green);font-weight:600;margin-left:10px;opacity:0;transition:opacity 0.3s;}

/* Reports tab */
.rpt-f{background:var(--surface);border:1px solid var(--border);border-radius:var(--rlg);padding:20px;margin-bottom:16px;}
.rpt-ft{font-size:10px;font-weight:700;letter-spacing:0.14em;text-transform:uppercase;color:var(--text3);margin-bottom:12px;}
.rpt-g{display:grid;grid-template-columns:1fr 1fr 1fr 1fr auto;gap:10px;align-items:end;}
.rpt-l{font-size:9px;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;color:var(--text3);margin-bottom:4px;}
.rpt-i{width:100%;background:var(--bg2);border:1.5px solid var(--border2);border-radius:var(--rsm);color:var(--text);font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;padding:10px 12px;outline:none;-webkit-appearance:none;}
.rpt-i:focus{border-color:var(--blue);}
.rpt-i option{background:var(--surface);}
.rpt-run{padding:10px 20px;border-radius:var(--rsm);background:var(--blue);color:#fff;border:none;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;font-weight:700;cursor:pointer;white-space:nowrap;transition:all 0.18s;}
.rpt-run:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(108,112,240,0.3);}
.rbns{display:flex;gap:6px;margin-top:10px;flex-wrap:wrap;align-items:center;}
.rb-lbl{font-size:10px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:0.08em;}
.rb{padding:5px 12px;border-radius:7px;background:var(--surface2);border:1px solid var(--border2);color:var(--text3);font-family:'Plus Jakarta Sans',sans-serif;font-size:11px;font-weight:600;cursor:pointer;transition:all 0.18s;}
.rb:hover{color:var(--text);border-color:var(--blue);background:var(--blue-soft);}
.rkpis{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-bottom:16px;}
.rkpi{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:14px;position:relative;overflow:hidden;}
.rkpi::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;}
.rkpi-l{font-size:9px;font-weight:700;letter-spacing:0.12em;text-transform:uppercase;color:var(--text3);margin-bottom:5px;}
.rkpi-v{font-family:'Instrument Serif',Georgia,serif;font-size:38px;line-height:1;color:#fff;}
.rkpi-s{font-size:11px;color:var(--text3);margin-top:3px;}
.rpt-bar-row{display:flex;align-items:center;gap:10px;margin-bottom:7px;}
.rpt-bar-label{font-size:12px;font-weight:600;color:var(--text);min-width:120px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.rpt-bar-wrap{flex:1;height:8px;background:rgba(255,255,255,0.06);border-radius:4px;overflow:hidden;}
.rpt-bar{height:100%;border-radius:4px;transition:width 0.6s ease;}
.rpt-bar-count{font-family:'JetBrains Mono',monospace;font-size:12px;font-weight:600;color:var(--text3);min-width:28px;text-align:right;}
.rpt-c{background:var(--surface);border:1px solid var(--border);border-radius:var(--rlg);padding:18px;margin-bottom:14px;}
.rpt-ct{font-size:10px;font-weight:700;letter-spacing:0.14em;text-transform:uppercase;color:var(--text3);margin-bottom:12px;}

/* Edit Modal */
.mo{position:fixed;inset:0;background:rgba(0,0,0,0.75);z-index:600;display:none;align-items:center;justify-content:center;padding:20px;}
.mo.open{display:flex;}
.mb{background:var(--surface);border:1px solid var(--border2);border-radius:var(--rlg);width:100%;max-width:660px;max-height:90vh;overflow-y:auto;position:relative;}
.mb::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--blue),var(--red));border-radius:var(--rlg) var(--rlg) 0 0;}
.mh{padding:22px 24px 0;display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;}
.mt{font-family:'Instrument Serif',Georgia,serif;font-size:24px;color:var(--text);}
.mc{background:none;border:none;color:var(--text3);font-size:20px;cursor:pointer;padding:4px 8px;border-radius:6px;transition:color 0.15s;}
.mc:hover{color:var(--text);}
.mbd{padding:0 24px 24px;}
.msec{font-size:9px;font-weight:700;letter-spacing:0.14em;text-transform:uppercase;color:var(--blue);margin:16px 0 10px;padding-bottom:4px;border-bottom:1px solid var(--border);}
.mg{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.mg3{grid-template-columns:1fr 1fr 1fr;}
.mfl{display:flex;flex-direction:column;gap:4px;}
.mlbl{font-size:9px;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;color:var(--text3);}
.min{background:var(--bg2);border:1.5px solid var(--border2);border-radius:var(--rsm);color:var(--text);font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;padding:9px 12px;transition:border-color 0.18s;-webkit-appearance:none;width:100%;}
.min:focus{outline:none;border-color:var(--blue);box-shadow:0 0 0 3px rgba(108,112,240,0.08);}
.min option{background:var(--surface);}
textarea.min{resize:vertical;min-height:70px;}
.mfoot{display:flex;gap:10px;margin-top:18px;}
.msave{flex:1;padding:12px;border-radius:var(--rsm);background:var(--blue);color:#fff;border:none;font-family:'Plus Jakarta Sans',sans-serif;font-size:14px;font-weight:700;cursor:pointer;transition:all 0.18s;}
.msave:hover{transform:translateY(-1px);box-shadow:0 6px 16px rgba(108,112,240,0.3);}
.mcan{padding:12px 18px;border-radius:var(--rsm);background:var(--bg2);border:1.5px solid var(--border2);color:var(--text3);font-family:'Plus Jakarta Sans',sans-serif;font-size:14px;font-weight:600;cursor:pointer;}
.mcan:hover{color:var(--text);}
.mdel{padding:12px 14px;border-radius:var(--rsm);background:var(--red-soft);border:1px solid rgba(224,27,54,0.25);color:#FC8181;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;font-weight:600;cursor:pointer;}
.mdel:hover{background:rgba(224,27,54,0.18);}

/* Toast */
.toast{position:fixed;bottom:28px;left:50%;transform:translateX(-50%) translateY(80px);background:var(--surface);border:1px solid var(--border2);border-radius:12px;padding:12px 22px;font-size:13px;font-weight:600;color:var(--text);z-index:999;transition:transform 0.35s var(--spring);box-shadow:0 12px 32px rgba(0,0,0,0.4);white-space:nowrap;}
.toast.show{transform:translateX(-50%) translateY(0);}
.toast.grn{border-color:rgba(45,212,160,0.3);color:var(--green);}

/* Loading */
.ld{text-align:center;padding:40px;color:var(--text3);font-size:13px;}
.sp{display:inline-block;width:16px;height:16px;border:2px solid var(--border2);border-top-color:var(--blue);border-radius:50%;animation:spin 0.7s linear infinite;margin-right:8px;vertical-align:middle;}
@keyframes spin{to{transform:rotate(360deg);}}
.empty{text-align:center;padding:50px 20px;color:var(--text3);}
.empty-icon{font-size:32px;margin-bottom:10px;opacity:0.4;}
.empty-t{font-family:'Instrument Serif',Georgia,serif;font-size:18px;color:var(--text2);margin-bottom:4px;}
.empty-s{font-size:12px;}

@keyframes fadeUp{from{opacity:0;transform:translateY(12px);}to{opacity:1;transform:translateY(0);}}
.fi-in{animation:fadeUp 0.4s ease both;}

@media(max-width:900px){.kpis{grid-template-columns:repeat(3,1fr);}.eg{grid-template-columns:1fr 1fr;}.rpt-g{grid-template-columns:1fr 1fr;}.rkpis{grid-template-columns:repeat(3,1fr);}}
@media(max-width:600px){.page{padding:16px 14px 80px;}.kpis{grid-template-columns:repeat(2,1fr);}.em{grid-template-columns:auto 1fr;}.eright{flex-direction:row;flex-wrap:wrap;}.eg{grid-template-columns:1fr;}.mf{grid-template-columns:1fr;}.mg,.mg3{grid-template-columns:1fr;}.rpt-g{grid-template-columns:1fr;}.rkpis{grid-template-columns:1fr 1fr;}}
</style>
</head>
<body>
<div class="bg-noise"></div>
<div class="bg-grad"></div>

<header class="hdr">
  <div class="hdr-l">
    <div class="hdr-logo"><svg viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2.5" stroke-linecap="round"><path d="M3 3v18h18"/><path d="M7 16l4-8 4 4 4-6"/></svg></div>
    <div class="hdr-t">Dashboard</div>
  </div>
  <div class="hdr-r">
    <div class="live"><div class="live-dot"></div> LIVE</div>
    <span class="hdr-user" id="hdr-user"></span>
    <button class="ham" id="ham" onclick="toggleMenu()" aria-label="Menu"><span></span><span></span><span></span></button>
    <div class="nav-dd" id="nav-dd">
      <div class="nui"><span class="nud" id="nud"></span><span class="nrp" id="nrp"></span></div>
      <div class="ddv"></div>
      <a href="app.html" class="di"><span class="di-ic">üè†</span> Home</a>
      <a href="service-to-sales-log.html" class="di"><span class="di-ic">üìã</span> S2S Entry</a>
      <a href="manager-dashboard.html" class="di ap"><span class="di-ic">üìä</span> Dashboard</a>
      <a href="scorecards.html" class="di"><span class="di-ic">üèÜ</span> Scorecards</a>
      <div class="ddv dd-admin" id="ddv-admin"></div>
      <a href="admin-panel.html" class="di dd-admin" id="dd-admin"><span class="di-ic">‚öôÔ∏è</span> Admin Panel</a>
    </div>
  </div>
</header>
<div class="nav-ov" id="nav-ov" onclick="closeMenu()"></div>

<div class="page">
  <!-- KPIs -->
  <div class="kpis fi-in">
    <div class="kpi kb"><div class="kpi-l">Total Contacts</div><div class="kpi-v" id="k-total">‚Äî</div></div>
    <div class="kpi kr"><div class="kpi-l">Hot Leads (8+)</div><div class="kpi-v" id="k-hot">‚Äî</div></div>
    <div class="kpi kg"><div class="kpi-l">Sold</div><div class="kpi-v" id="k-sold">‚Äî</div></div>
    <div class="kpi ko"><div class="kpi-l">Appt Set</div><div class="kpi-v" id="k-appt">‚Äî</div></div>
    <div class="kpi kd"><div class="kpi-l">Avg Temp</div><div class="kpi-v" id="k-avg">‚Äî</div></div>
    <div class="kpi kp"><div class="kpi-l">Conv Rate</div><div class="kpi-v" id="k-conv">‚Äî</div></div>
  </div>

  <!-- Alert -->
  <div class="alert-banner" id="alert-banner">
    <div class="a-dot"></div>
    <div><div class="a-txt" id="alert-txt">üî• Hot leads need attention</div><div class="a-sub" id="alert-sub"></div></div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tb ac" onclick="showTab('all',this)">All <span class="tb-badge" id="badge-all">0</span></button>
    <button class="tb" onclick="showTab('hot',this)">üî• Hot</button>
    <button class="tb" onclick="showTab('aging',this)">‚è∞ Aging</button>
    <button class="tb" onclick="showTab('unclaimed',this)">üì≠ Unclaimed</button>
    <button class="tb" onclick="showTab('reports',this)">üìä Reports</button>
  </div>

  <div class="exp-bar fi-in">
    <button class="exp exp-csv" onclick="exportCSV()">‚¨á Export CSV</button>
    <button class="exp exp-pdf" onclick="exportPrint()">üñ® Print View</button>
  </div>

  <!-- ENTRIES -->
  <div id="tab-entries">
    <div class="sh"><div class="sh-t" id="sh-label">All Entries</div><div class="sh-c" id="sh-count">‚Äî</div></div>
    <div class="el" id="entries-list"><div class="ld"><span class="sp"></span> Loading...</div></div>
  </div>

  <!-- REPORTS -->
  <div id="tab-reports" style="display:none;">
    <div class="rpt-f">
      <div class="rpt-ft">Filter Report</div>
      <div class="rpt-g">
        <div><div class="rpt-l">From</div><input type="date" class="rpt-i" id="rpt-from"></div>
        <div><div class="rpt-l">To</div><input type="date" class="rpt-i" id="rpt-to"></div>
        <div><div class="rpt-l">Rep</div><select class="rpt-i" id="rpt-rep"><option value="">All Reps</option><option>Tyler Doyle</option><option>Andrew Kirk</option><option>DJ Rogers</option><option>Kody McCann</option></select></div>
        <div><div class="rpt-l">Outcome</div><select class="rpt-i" id="rpt-outcome"><option value="">All</option><option>Sold</option><option>Appointment Set</option><option>Follow-Up Required</option><option>Not Interested</option></select></div>
        <button class="rpt-run" onclick="runReport()">Run Report</button>
      </div>
      <div class="rbns">
        <span class="rb-lbl">Quick:</span>
        <button class="rb" onclick="setRange(7)">7 Days</button>
        <button class="rb" onclick="setRange(14)">14 Days</button>
        <button class="rb" onclick="setRange(30)">30 Days</button>
        <button class="rb" onclick="setRange(90)">90 Days</button>
        <button class="rb" onclick="setRange(0)">All Time</button>
      </div>
    </div>
    <div class="rkpis" id="rpt-kpis"></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;" id="rpt-charts">
      <div class="rpt-c"><div class="rpt-ct">Entries by Rep</div><div id="chart-rep"></div></div>
      <div class="rpt-c"><div class="rpt-ct">Outcome Distribution</div><div id="chart-outcome"></div></div>
    </div>
  </div>
</div>

<!-- EDIT MODAL -->
<div class="mo" id="edit-modal">
  <div class="mb">
    <div class="mh"><div class="mt">Edit Entry</div><button class="mc" onclick="closeModal()">‚úï</button></div>
    <div class="mbd">
      <input type="hidden" id="ed-id">
      <div class="msec">Customer Info</div>
      <div class="mg">
        <div class="mfl"><label class="mlbl">First Name</label><input class="min" id="ed-first"></div>
        <div class="mfl"><label class="mlbl">Last Name</label><input class="min" id="ed-last"></div>
        <div class="mfl"><label class="mlbl">Phone</label><input class="min" id="ed-phone"></div>
        <div class="mfl"><label class="mlbl">Email</label><input class="min" id="ed-email"></div>
      </div>
      <div class="msec">Vehicle</div>
      <div class="mg mg3">
        <div class="mfl"><label class="mlbl">Year</label><input class="min" id="ed-year"></div>
        <div class="mfl"><label class="mlbl">Make</label><input class="min" id="ed-make"></div>
        <div class="mfl"><label class="mlbl">Model</label><input class="min" id="ed-model"></div>
      </div>
      <div class="msec">Status</div>
      <div class="mg">
        <div class="mfl"><label class="mlbl">Repair Cost</label><input class="min" id="ed-repair"></div>
        <div class="mfl"><label class="mlbl">Engagement Score</label><input class="min" id="ed-score" type="number" min="1" max="10"></div>
        <div class="mfl"><label class="mlbl">Outcome</label><select class="min" id="ed-outcome"><option>New Vehicle Sold</option><option>Used Vehicle Sold</option><option>Appointment Set</option><option>Follow-Up Required</option><option>Not Interested</option></select></div>
        <div class="mfl"><label class="mlbl">Submitter</label><select class="min" id="ed-submitter"><option>Tyler Doyle</option><option>Andrew Kirk</option><option>DJ Rogers</option><option>Kody McCann</option></select></div>
      </div>
      <div class="msec">Notes</div>
      <div class="mfl"><textarea class="min" id="ed-notes" rows="3"></textarea></div>
      <div class="mfoot">
        <button class="mcan" onclick="closeModal()">Cancel</button>
        <button class="mdel" onclick="deleteEntry()">üóë Delete</button>
        <button class="msave" onclick="saveEdit()">‚úì Save Changes</button>
      </div>
    </div>
  </div>
</div>
<div class="toast" id="toast"></div>

<script>
const SB_URL='https://jbkgwtohwsbaorhvuuqb.supabase.co';
const SB_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impia2d3dG9od3NiYW9yaHZ1dXFiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5NjkwNDIsImV4cCI6MjA4NzU0NTA0Mn0.GRXOYbIuVDxU9-FEBYmyd1QmytVUrMIAxbnOSfepzuU';
const H={'apikey':SB_KEY,'Authorization':'Bearer '+SB_KEY,'Content-Type':'application/json'};
const rep=JSON.parse(sessionStorage.getItem('sb_rep')||'null');
let ALL=[];let currentTab='all';

// Nav
(function(){
  if(!rep)return;
  const first=rep.first_name||rep.name.split(' ')[0];
  document.getElementById('hdr-user').textContent=first;
  document.getElementById('nud').textContent=rep.name;
  const p=document.getElementById('nrp');
  const r=(rep.role||'sales').toLowerCase();
  p.textContent=r.charAt(0).toUpperCase()+r.slice(1);
  p.className='nrp '+(r==='admin'?'r-admin':r==='manager'?'r-manager':'r-sales');
  if(r==='admin'){document.getElementById('dd-admin').classList.add('show');document.getElementById('ddv-admin').classList.add('show');}
})();

function toggleMenu(){const h=document.getElementById('ham'),d=document.getElementById('nav-dd'),o=document.getElementById('nav-ov');const op=d.classList.contains('open');h.classList.toggle('open',!op);d.classList.toggle('open',!op);o.classList.toggle('open',!op);}
function closeMenu(){document.getElementById('ham').classList.remove('open');document.getElementById('nav-dd').classList.remove('open');document.getElementById('nav-ov').classList.remove('open');}

// Load
async function init(){
  try{const res=await fetch(`${SB_URL}/rest/v1/s2s_entries?select=*&order=id.desc&limit=1000`,{headers:H});if(res.ok)ALL=await res.json();}catch(e){console.error(e);}
  renderKPIs();renderEntries();
  // set default report dates
  const now=new Date(),d30=new Date(now);d30.setDate(d30.getDate()-30);
  document.getElementById('rpt-from').value=d30.toISOString().slice(0,10);
  document.getElementById('rpt-to').value=now.toISOString().slice(0,10);
}

function renderKPIs(){
  const n=ALL.length;
  const sold=ALL.filter(e=>e.outcome&&(e.outcome.includes('New')||e.outcome.includes('Used'))).length;
  const hot=ALL.filter(e=>parseInt(e.eng_score)>=8).length;
  const appt=ALL.filter(e=>e.outcome==='Appointment Set').length;
  const temps=ALL.map(e=>parseInt(e.eng_score)).filter(t=>!isNaN(t));
  const avg=temps.length?(temps.reduce((a,b)=>a+b,0)/temps.length).toFixed(1):'‚Äî';
  document.getElementById('k-total').textContent=n;
  document.getElementById('k-hot').textContent=hot;
  document.getElementById('k-sold').textContent=sold;
  document.getElementById('k-appt').textContent=appt;
  document.getElementById('k-avg').textContent=avg;
  document.getElementById('k-conv').textContent=n?Math.round((sold/n)*100)+'%':'0%';
  document.getElementById('badge-all').textContent=n;
  // hot alert
  const unclaimed=ALL.filter(e=>parseInt(e.eng_score)>=8&&!e.manager_claimed_by);
  const ab=document.getElementById('alert-banner');
  if(unclaimed.length>0){ab.style.display='flex';document.getElementById('alert-txt').textContent=`üî• ${unclaimed.length} hot lead${unclaimed.length>1?'s':''} unclaimed`;document.getElementById('alert-sub').textContent='Claim these leads before they go cold';}
}

function getFiltered(){
  const now=Date.now();
  const dayMs=86400000;
  if(currentTab==='hot')return ALL.filter(e=>parseInt(e.eng_score)>=8);
  if(currentTab==='aging')return ALL.filter(e=>{if(!e.created_at)return false;const age=now-new Date(e.created_at).getTime();return age>2*dayMs&&(!e.outcome||e.outcome==='Follow-Up Required');});
  if(currentTab==='unclaimed')return ALL.filter(e=>!e.manager_claimed_by);
  return ALL;
}

function renderEntries(){
  const list=getFiltered();
  const labels={'all':'All Entries','hot':'Hot Leads (8+)','aging':'Aging Follow-Ups','unclaimed':'Unclaimed Entries'};
  document.getElementById('sh-label').textContent=labels[currentTab]||'All Entries';
  document.getElementById('sh-count').textContent=list.length+' entries';
  const el=document.getElementById('entries-list');
  if(!list.length){el.innerHTML='<div class="empty"><div class="empty-icon">üì≠</div><div class="empty-t">No entries found</div><div class="empty-s">Adjust filters or check back later.</div></div>';return;}
  el.innerHTML=list.map(e=>{
    const sc=parseInt(e.eng_score)||0;
    const tcls=sc>=8?'t-hot':sc>=5?'t-warm':'t-cool';
    const cls=sc>=8?'hot':(currentTab==='aging'?'aging':'');
    const veh=[e.veh_year,e.veh_make,e.veh_model].filter(Boolean).join(' ')||'‚Äî';
    const otag=!e.outcome?'et-other':e.outcome.includes('Sold')?'et-sold':e.outcome==='Appointment Set'?'et-appt':e.outcome==='Follow-Up Required'?'et-follow':'et-other';
    const time=e.created_at?new Date(e.created_at).toLocaleString('en-US',{month:'short',day:'numeric',hour:'numeric',minute:'2-digit'}):(e.timestamp||'‚Äî');
    const claimed=e.manager_claimed_by;
    const crmDone=e.crm_entry&&e.crm_entry.toLowerCase().includes('yes');
    // age check
    let ageTag='';
    if(e.created_at){const hrs=(Date.now()-new Date(e.created_at).getTime())/3600000;if(hrs>48&&(!e.outcome||e.outcome==='Follow-Up Required'))ageTag='<span class="et et-aging">‚è∞ Aging</span>';}
    return`<div class="ec ${cls}" id="ec-${e.id}">
      <div class="em">
        <div class="tb2 ${tcls}"><div class="tn">${sc||'?'}</div><div class="tl">temp</div></div>
        <div>
          <div class="en">${e.first_name||''} ${e.last_name||''}</div>
          <div class="emeta"><span>üöó ${veh}</span><span>üë§ ${e.submitter||'‚Äî'}</span>${e.phone?`<span>üìû ${e.phone}</span>`:''}</div>
          <div class="etags">
            <span class="et ${otag}">${e.outcome||'Pending'}</span>
            ${sc>=8?'<span class="et et-hot">üî• Hot Lead</span>':''}
            ${claimed?`<span class="et et-claimed">‚úì ${claimed}</span>`:''}
            ${crmDone?'<span class="crm-ok">CRM ‚úì</span>':''}
            ${ageTag}
          </div>
        </div>
        <div class="eright">
          <div class="etime">${time}</div>
          ${!claimed?`<button class="cbtn" onclick="claimEntry(${e.id},event)">Claim</button>`:`<div class="clby">Claimed by ${claimed}</div>`}
          <div style="display:flex;gap:5px;margin-top:2px;">
            <button class="ebtn" onclick="openEdit(${e.id})">Edit</button>
            <button class="crm" onclick="pushCRM(${e.id})" ${crmDone?'disabled':''}>CRM${crmDone?' ‚úì':''}</button>
          </div>
        </div>
      </div>
      <button class="ext" onclick="toggleExpand(${e.id})">Details ‚ñæ</button>
      <div class="ee" id="ee-${e.id}">
        <div class="eg">
          <div><div class="est">Customer</div>
            ${[['Name',`${e.first_name||''} ${e.last_name||''}`],['Phone',e.phone||'‚Äî'],['Email',e.email||'‚Äî'],['Contact Pref',e.contact_pref||'‚Äî']].map(([k,v])=>`<div class="er"><span class="erk">${k}</span><span class="erv">${v}</span></div>`).join('')}
          </div>
          <div><div class="est">Vehicle</div>
            ${[['Vehicle',veh],['Mileage',e.veh_miles?Number(e.veh_miles).toLocaleString()+' mi':'‚Äî'],['Ownership',e.veh_ownership||'‚Äî'],['Condition',e.veh_condition||'‚Äî']].map(([k,v])=>`<div class="er"><span class="erk">${k}</span><span class="erv">${v}</span></div>`).join('')}
          </div>
          <div><div class="est">Service & Sales</div>
            ${[['Visit Reason',e.visit_reason||'‚Äî'],['Repair Cost',e.repair_cost||'‚Äî'],['Cost vs Value',e.repair_ratio||'‚Äî'],['Emotion',e.cust_emotion||'‚Äî'],['Timeline',e.timeline||'‚Äî'],['Finance',e.finance_conv||'‚Äî']].map(([k,v])=>`<div class="er"><span class="erk">${k}</span><span class="erv">${v}</span></div>`).join('')}
          </div>
        </div>
        ${e.notes?`<div style="background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:12px;"><div class="est">Notes</div><div style="font-size:13px;color:var(--text2);">${e.notes}</div></div>`:''}
        <div class="mp">
          <div class="mp-t">Manager Action Panel</div>
          <div class="mf">
            <div class="fg"><label class="fl">Mgr Outcome</label><select class="fi" id="mo-${e.id}"><option value="">Select...</option><option>Verified Sold</option><option>Appointment Confirmed</option><option>Working ‚Äî Active</option><option>Lost ‚Äî No Follow-Up</option><option>Lost ‚Äî Competitor</option><option>Lost ‚Äî Financing</option></select></div>
            <div class="fg"><label class="fl">Follow-Up Status</label><select class="fi" id="fs-${e.id}"><option value="">Select...</option><option>Pending</option><option>Contacted</option><option>Scheduled</option><option>Complete</option><option>No Response</option></select></div>
          </div>
          <div class="fg" style="margin-bottom:10px;"><label class="fl">Manager Notes</label><textarea class="fi" id="mn-${e.id}" rows="2" placeholder="Add notes...">${e.manager_notes||''}</textarea></div>
          <div style="display:flex;align-items:center;"><button class="sv" onclick="saveMgr(${e.id})">Save</button><span class="sv-ok" id="svok-${e.id}">‚úì Saved</span></div>
        </div>
      </div>
    </div>`;
  }).join('');
  // pre-fill manager selects
  list.forEach(e=>{
    if(e.manager_outcome){const s=document.getElementById('mo-'+e.id);if(s)s.value=e.manager_outcome;}
    if(e.followup_status){const s=document.getElementById('fs-'+e.id);if(s)s.value=e.followup_status;}
  });
}

function showTab(tab,btn){
  currentTab=tab;
  document.querySelectorAll('.tb').forEach(t=>t.classList.remove('ac'));
  btn.classList.add('ac');
  if(tab==='reports'){document.getElementById('tab-entries').style.display='none';document.getElementById('tab-reports').style.display='block';runReport();}
  else{document.getElementById('tab-entries').style.display='block';document.getElementById('tab-reports').style.display='none';renderEntries();}
}

function toggleExpand(id){const el=document.getElementById('ee-'+id);el.classList.toggle('open');}

async function claimEntry(id,evt){
  const name=rep?rep.name:'Manager';
  await fetch(`${SB_URL}/rest/v1/s2s_entries?id=eq.${id}`,{method:'PATCH',headers:H,body:JSON.stringify({manager_claimed_by:name})});
  const e=ALL.find(x=>x.id===id);if(e)e.manager_claimed_by=name;
  renderEntries();renderKPIs();showToast('‚úì Lead claimed by '+name);
}

async function pushCRM(id){
  await fetch(`${SB_URL}/rest/v1/s2s_entries?id=eq.${id}`,{method:'PATCH',headers:H,body:JSON.stringify({crm_entry:'Yes ‚Äî entered in CRM'})});
  const e=ALL.find(x=>x.id===id);if(e)e.crm_entry='Yes ‚Äî entered in CRM';
  renderEntries();showToast('‚úì CRM status updated');
}

async function saveMgr(id){
  const mo=document.getElementById('mo-'+id).value;
  const fs=document.getElementById('fs-'+id).value;
  const mn=document.getElementById('mn-'+id).value;
  await fetch(`${SB_URL}/rest/v1/s2s_entries?id=eq.${id}`,{method:'PATCH',headers:H,body:JSON.stringify({manager_outcome:mo,followup_status:fs,manager_notes:mn})});
  const e=ALL.find(x=>x.id===id);if(e){e.manager_outcome=mo;e.followup_status=fs;e.manager_notes=mn;}
  const ok=document.getElementById('svok-'+id);ok.style.opacity='1';setTimeout(()=>ok.style.opacity='0',2000);
}

// Edit modal
async function openEdit(id){
  const e=ALL.find(x=>x.id===id);if(!e)return;
  document.getElementById('ed-id').value=e.id;
  document.getElementById('ed-first').value=e.first_name||'';
  document.getElementById('ed-last').value=e.last_name||'';
  document.getElementById('ed-phone').value=e.phone||'';
  document.getElementById('ed-email').value=e.email||'';
  document.getElementById('ed-year').value=e.veh_year||'';
  document.getElementById('ed-make').value=e.veh_make||'';
  document.getElementById('ed-model').value=e.veh_model||'';
  document.getElementById('ed-repair').value=e.repair_cost||'';
  document.getElementById('ed-score').value=e.eng_score||'';
  document.getElementById('ed-outcome').value=e.outcome||'';
  document.getElementById('ed-submitter').value=e.submitter||'';
  document.getElementById('ed-notes').value=e.notes||'';
  document.getElementById('edit-modal').classList.add('open');
}
function closeModal(){document.getElementById('edit-modal').classList.remove('open');}
document.getElementById('edit-modal').addEventListener('click',function(ev){if(ev.target===this)closeModal();});

async function saveEdit(){
  const id=document.getElementById('ed-id').value;
  const p={first_name:document.getElementById('ed-first').value,last_name:document.getElementById('ed-last').value,phone:document.getElementById('ed-phone').value,email:document.getElementById('ed-email').value,veh_year:document.getElementById('ed-year').value,veh_make:document.getElementById('ed-make').value,veh_model:document.getElementById('ed-model').value,repair_cost:document.getElementById('ed-repair').value,eng_score:document.getElementById('ed-score').value,outcome:document.getElementById('ed-outcome').value,submitter:document.getElementById('ed-submitter').value,notes:document.getElementById('ed-notes').value};
  await fetch(`${SB_URL}/rest/v1/s2s_entries?id=eq.${id}`,{method:'PATCH',headers:H,body:JSON.stringify(p)});
  const e=ALL.find(x=>x.id==id);if(e)Object.assign(e,p);
  closeModal();renderEntries();renderKPIs();showToast('‚úì Entry updated','grn');
}

async function deleteEntry(){
  if(!confirm('Delete this entry?'))return;
  const id=document.getElementById('ed-id').value;
  await fetch(`${SB_URL}/rest/v1/s2s_entries?id=eq.${id}`,{method:'DELETE',headers:H});
  ALL=ALL.filter(x=>x.id!=id);closeModal();renderEntries();renderKPIs();showToast('Entry deleted');
}

// Reports
function setRange(days){
  const to=new Date();
  document.getElementById('rpt-to').value=to.toISOString().slice(0,10);
  if(days===0){document.getElementById('rpt-from').value='2024-01-01';}
  else{const fr=new Date(to);fr.setDate(fr.getDate()-days);document.getElementById('rpt-from').value=fr.toISOString().slice(0,10);}
  runReport();
}

function runReport(){
  const from=document.getElementById('rpt-from').value;
  const to=document.getElementById('rpt-to').value;
  const repF=document.getElementById('rpt-rep').value;
  const outF=document.getElementById('rpt-outcome').value;
  let data=ALL.filter(e=>{
    if(!e.created_at)return true;
    const d=e.created_at.slice(0,10);
    if(from&&d<from)return false;if(to&&d>to)return false;
    if(repF&&e.submitter!==repF)return false;
    if(outF){if(outF==='Sold')return e.outcome&&(e.outcome.includes('New')||e.outcome.includes('Used'));return e.outcome===outF;}
    return true;
  });
  const n=data.length;
  const sold=data.filter(e=>e.outcome&&(e.outcome.includes('New')||e.outcome.includes('Used'))).length;
  const hot=data.filter(e=>parseInt(e.eng_score)>=8).length;
  const appt=data.filter(e=>e.outcome==='Appointment Set').length;
  const temps=data.map(e=>parseInt(e.eng_score)).filter(t=>!isNaN(t));
  const avg=temps.length?(temps.reduce((a,b)=>a+b,0)/temps.length).toFixed(1):'‚Äî';
  const colors=['var(--blue)','var(--red)','var(--green)','var(--orange)','var(--gold)'];
  document.getElementById('rpt-kpis').innerHTML=[
    ['Total Contacts',n],['Hot Leads',hot],['Sold',sold],['Appointments',appt],['Avg Temp',avg]
  ].map(([l,v],i)=>`<div class="rkpi" style="--c:${colors[i]};"><div style="position:absolute;top:0;left:0;right:0;height:2px;background:${colors[i]};"></div><div class="rkpi-l">${l}</div><div class="rkpi-v" style="color:${colors[i]};">${v}</div></div>`).join('');

  // Rep bars
  const reps={};data.forEach(e=>{const s=e.submitter||'Unknown';reps[s]=(reps[s]||0)+1;});
  const maxR=Math.max(...Object.values(reps),1);
  const repColors={'Tyler Doyle':'var(--gold)','Andrew Kirk':'var(--blue)','DJ Rogers':'var(--green)','Kody McCann':'var(--red)'};
  document.getElementById('chart-rep').innerHTML=Object.entries(reps).sort((a,b)=>b[1]-a[1]).map(([name,count])=>`<div class="rpt-bar-row"><div class="rpt-bar-label">${name}</div><div class="rpt-bar-wrap"><div class="rpt-bar" style="width:${(count/maxR)*100}%;background:${repColors[name]||'var(--purple)'};"></div></div><div class="rpt-bar-count">${count}</div></div>`).join('')||'<div style="color:var(--text3);font-size:12px;padding:12px;">No data</div>';

  // Outcome bars
  const outcomes={};data.forEach(e=>{const o=e.outcome||'Pending';outcomes[o]=(outcomes[o]||0)+1;});
  const maxO=Math.max(...Object.values(outcomes),1);
  const oColors={'New Vehicle Sold':'var(--green)','Used Vehicle Sold':'var(--green)','Appointment Set':'var(--blue)','Follow-Up Required':'var(--gold)','Not Interested':'var(--text3)'};
  document.getElementById('chart-outcome').innerHTML=Object.entries(outcomes).sort((a,b)=>b[1]-a[1]).map(([name,count])=>`<div class="rpt-bar-row"><div class="rpt-bar-label">${name}</div><div class="rpt-bar-wrap"><div class="rpt-bar" style="width:${(count/maxO)*100}%;background:${oColors[name]||'var(--purple)'};"></div></div><div class="rpt-bar-count">${count}</div></div>`).join('')||'<div style="color:var(--text3);font-size:12px;padding:12px;">No data</div>';
}

// Exports
function exportCSV(){
  if(!ALL.length)return alert('No entries.');
  const keys=Object.keys(ALL[0]);
  const csv=[keys.join(','),...ALL.map(e=>keys.map(k=>`"${(e[k]??'').toString().replace(/"/g,'""')}"`).join(','))].join('\n');
  const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'}));a.download=`s2s-dashboard-${new Date().toISOString().slice(0,10)}.csv`;a.click();
}
function exportPrint(){
  const date=new Date().toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
  const rows=ALL.map(e=>`<tr><td>${e.submitter||'‚Äî'}</td><td>${e.first_name||''} ${e.last_name||''}</td><td>${e.phone||'‚Äî'}</td><td>${[e.veh_year,e.veh_make,e.veh_model].filter(Boolean).join(' ')||'‚Äî'}</td><td style="text-align:center;font-weight:700;">${e.eng_score||'‚Äî'}</td><td>${e.outcome||'‚Äî'}</td><td>${e.manager_claimed_by||'Unclaimed'}</td><td>${e.followup_status||'‚Äî'}</td></tr>`).join('');
  const w=window.open('','_blank');
  w.document.write(`<!DOCTYPE html><html><head><title>S2S Dashboard</title><style>body{font-family:Arial,sans-serif;font-size:11px;padding:24px;}h1{font-size:18px;margin-bottom:4px;}.sub{color:#666;font-size:12px;margin-bottom:16px;}table{width:100%;border-collapse:collapse;}th{background:#0C0C14;color:#fff;padding:8px 10px;text-align:left;font-size:10px;text-transform:uppercase;letter-spacing:0.08em;}td{padding:7px 10px;border-bottom:1px solid #eee;}tr:nth-child(even) td{background:#f9f9f9;}</style></head><body><h1>ServiceBridge ‚Äî Dashboard Export</h1><div class="sub">Gallatin CDJR ¬∑ ${date} ¬∑ ${ALL.length} entries</div><table><thead><tr><th>Rep</th><th>Customer</th><th>Phone</th><th>Vehicle</th><th>Temp</th><th>Outcome</th><th>Claimed By</th><th>Follow-Up</th></tr></thead><tbody>${rows}</tbody></table></body></html>`);
  w.document.close();setTimeout(()=>w.print(),500);
}

function showToast(msg,cls){const t=document.getElementById('toast');t.textContent=msg;t.className='toast show'+(cls?' '+cls:'');setTimeout(()=>t.className='toast',3000);}

init();
</script>
</body>
</html>
