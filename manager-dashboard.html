<!DOCTYPE html>
<html lang="en">
<head>
  <!-- ‚ïê‚ïê SUPABASE AUTH ‚ïê‚ïê -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script src="/auth-guard.js"></script>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ServiceBridge ‚Äî Performance Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #090C14;
  --surface: #111828;
  --surface2: #1A2438;
  --surface3: #212E45;
  --border: rgba(255,255,255,0.12);
  --border2: rgba(255,255,255,0.20);
  --text: #FFFFFF;
  --muted: rgba(255,255,255,0.70);
  --muted2: rgba(255,255,255,0.45);
  --purple: #6366F1;
  --purple2: #818CF8;
  --red: #EF4444;
  --green: #22C55E;
  --gold: #F59E0B;
  --orange: #F97316;
  --r: 12px;
}
* { margin:0; padding:0; box-sizing:border-box; }
body { background:var(--bg); color:var(--text); font-family:'DM Sans',sans-serif; min-height:100vh; -webkit-font-smoothing:antialiased; }
.bg-orb1 { position:fixed; top:-200px; right:-150px; width:600px; height:600px; border-radius:50%; background:radial-gradient(circle,rgba(91,79,232,0.12) 0%,transparent 70%); pointer-events:none; z-index:0; }
.bg-orb2 { position:fixed; bottom:-200px; left:-100px; width:500px; height:500px; border-radius:50%; background:radial-gradient(circle,rgba(200,16,46,0.08) 0%,transparent 70%); pointer-events:none; z-index:0; }

/* NAV */
nav { position:sticky; top:0; z-index:200; background:rgba(7,7,14,0.95); backdrop-filter:blur(16px); border-bottom:1px solid var(--border); padding:0 24px; height:58px; display:flex; align-items:center; justify-content:space-between; }
nav::after { content:''; position:absolute; bottom:0; left:0; right:0; height:1px; background:linear-gradient(90deg,var(--purple),transparent,var(--red),transparent); }
.nav-brand { font-family:'Bebas Neue',sans-serif; font-size:22px; letter-spacing:0.06em; background:linear-gradient(90deg,#fff,rgba(255,255,255,0.6)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
.nav-live { font-size:11px; font-weight:600; padding:4px 12px; border-radius:20px; background:rgba(91,79,232,0.2); border:1px solid rgba(91,79,232,0.4); color:var(--purple2); }
.nav-left { display:flex; align-items:center; gap:14px; }
.nav-right { display:flex; align-items:center; gap:10px; }
.nav-user-pill { display:flex; align-items:center; gap:8px; background:var(--surface); border:1px solid var(--border); border-radius:30px; padding:4px 12px 4px 4px; }
.nav-avatar { width:30px; height:30px; border-radius:50%; background:linear-gradient(135deg,var(--purple),#C8102E); display:flex; align-items:center; justify-content:center; font-size:11px; font-weight:700; color:#fff; flex-shrink:0; }
.nav-user-name { font-size:12px; font-weight:600; white-space:nowrap; }
.nav-role-pill { font-size:10px; font-weight:700; padding:2px 8px; border-radius:10px; white-space:nowrap; }
.role-admin { background:rgba(232,184,75,0.15); color:var(--gold); border:1px solid rgba(232,184,75,0.3); }
.role-manager { background:rgba(99,102,241,0.15); color:var(--purple2); border:1px solid rgba(99,102,241,0.3); }
.role-sales { background:rgba(255,255,255,0.08); color:rgba(255,255,255,0.7); border:1px solid rgba(255,255,255,0.15); }
.refresh-btn { font-size:12px; font-weight:600; padding:7px 14px; border-radius:8px; background:rgba(255,255,255,0.06); border:1px solid var(--border2); color:var(--muted); cursor:pointer; transition:all 0.18s; font-family:'DM Sans',sans-serif; }
.refresh-btn:hover { color:var(--text); border-color:var(--border2); }
.hamburger { width:38px; height:38px; border-radius:9px; background:rgba(255,255,255,0.06); border:1px solid var(--border2); display:flex; flex-direction:column; align-items:center; justify-content:center; gap:5px; cursor:pointer; transition:all 0.18s; flex-shrink:0; }
.hamburger:hover { background:rgba(255,255,255,0.1); border-color:var(--purple); }
.hamburger span { display:block; width:16px; height:2px; background:var(--text); border-radius:2px; transition:all 0.22s; }
.hamburger.open span:nth-child(1) { transform:translateY(7px) rotate(45deg); }
.hamburger.open span:nth-child(2) { opacity:0; transform:scaleX(0); }
.hamburger.open span:nth-child(3) { transform:translateY(-7px) rotate(-45deg); }
.nav-dropdown { position:fixed; top:66px; right:16px; min-width:230px; background:var(--surface); border:1px solid var(--border2); border-radius:16px; padding:8px; box-shadow:0 24px 64px rgba(0,0,0,0.6); z-index:500; display:none; animation:dropIn 0.18s ease both; }
.nav-dropdown.open { display:block; }
@keyframes dropIn { from{opacity:0;transform:translateY(-6px);}to{opacity:1;transform:translateY(0);} }
.dd-header { padding:12px 14px 10px; border-bottom:1px solid var(--border); margin-bottom:6px; }
.dd-header-name { font-size:13px; font-weight:700; }
.dd-header-role { font-size:11px; color:var(--muted2); margin-top:2px; }
.dd-item { display:flex; align-items:center; gap:10px; padding:10px 14px; border-radius:10px; font-size:13px; font-weight:600; color:var(--muted); cursor:pointer; transition:all 0.15s; text-decoration:none; border:none; background:none; width:100%; font-family:'DM Sans',sans-serif; text-align:left; }
.dd-item:hover { background:rgba(255,255,255,0.06); color:var(--text); }
.dd-item .dd-icon { font-size:16px; width:24px; text-align:center; flex-shrink:0; }
.dd-divider { height:1px; background:var(--border); margin:6px 4px; }
.dd-item.danger { color:#FC8181; }
.dd-item.danger:hover { background:rgba(239,68,68,0.1); color:#FC8181; }
.dd-admin { display:none; }
.dd-admin.show { display:flex; }
.dd-admin-div { display:none; }
.dd-admin-div.show { display:block; }

/* LAYOUT */
.page { max-width:1400px; margin:0 auto; padding:28px 28px 80px; position:relative; z-index:1; }
.fade-in { animation:fadeIn 0.4s ease; }
@keyframes fadeIn { from{opacity:0;transform:translateY(8px);}to{opacity:1;transform:translateY(0);} }

/* KPI */
.kpi-grid { display:grid; grid-template-columns:repeat(6,1fr); gap:12px; margin-bottom:28px; }
.kpi-card { background:var(--surface); border:1px solid var(--border); border-radius:var(--r); padding:18px 16px; position:relative; overflow:hidden; transition:transform 0.2s; }
.kpi-card:hover { transform:translateY(-2px); }
.kpi-card::before { content:''; position:absolute; top:0; left:0; right:0; height:2px; }
.kpi-p::before{background:var(--purple);} .kpi-r::before{background:var(--red);} .kpi-g::before{background:var(--green);}
.kpi-o::before{background:var(--orange);} .kpi-gold::before{background:var(--gold);} .kpi-b::before{background:#38BDF8;}
.kpi-lbl { font-size:9px; font-weight:700; letter-spacing:0.16em; text-transform:uppercase; color:rgba(255,255,255,0.55); margin-bottom:6px; }
.kpi-val { font-family:'Bebas Neue',sans-serif; font-size:40px; line-height:1; }
.kpi-p .kpi-val{color:var(--purple2);} .kpi-r .kpi-val{color:#FC8181;} .kpi-g .kpi-val{color:#4ADE80;}
.kpi-o .kpi-val{color:var(--orange);} .kpi-gold .kpi-val{color:var(--gold);} .kpi-b .kpi-val{color:#38BDF8;}
.kpi-sub { font-size:10px; color:rgba(255,255,255,0.45); margin-top:2px; }

.section-hd { display:flex; align-items:center; justify-content:space-between; margin-bottom:14px; }
.section-title { font-size:11px; font-weight:700; letter-spacing:0.16em; text-transform:uppercase; color:rgba(255,255,255,0.75); display:flex; align-items:center; gap:8px; }
.section-title::before { content:''; display:inline-block; width:16px; height:2px; background:var(--purple); border-radius:2px; }
.section-count { font-size:11px; font-weight:600; color:var(--muted2); }

/* TABS */
.tabs { display:flex; gap:4px; margin-bottom:20px; background:var(--surface); border:1px solid var(--border); border-radius:10px; padding:4px; width:fit-content; flex-wrap:wrap; }
.tab { padding:8px 18px; border-radius:7px; font-size:12px; font-weight:600; color:var(--muted); cursor:pointer; transition:all 0.18s; border:none; background:transparent; font-family:'DM Sans',sans-serif; display:flex; align-items:center; gap:6px; }
.tab.active { background:var(--surface3); color:var(--text); }
.tab-badge { font-size:10px; font-weight:700; padding:1px 7px; border-radius:10px; background:var(--red); color:#fff; }
.tab-badge.purple { background:var(--purple); }
.tab-badge-verify { background:rgba(249,115,22,0.2); color:var(--orange); border:1px solid rgba(249,115,22,0.3); animation:pulse-dot 2s ease infinite; }

/* ALERT */
.alert-banner { background:rgba(200,16,46,0.12); border:1px solid rgba(200,16,46,0.3); border-radius:var(--r); padding:14px 18px; margin-bottom:16px; display:flex; align-items:center; gap:12px; animation:pulse-border 2s ease infinite; }
@keyframes pulse-border{0%,100%{border-color:rgba(200,16,46,0.3);}50%{border-color:rgba(200,16,46,0.6);}}
.alert-dot { width:10px; height:10px; border-radius:50%; background:var(--red); animation:pulse-dot 1.5s ease infinite; flex-shrink:0; }
@keyframes pulse-dot{0%,100%{opacity:1;transform:scale(1);}50%{opacity:0.5;transform:scale(0.8);}}
.alert-text { font-size:13px; font-weight:600; color:#FC8181; }
.alert-sub { font-size:11px; color:rgba(252,129,129,0.6); margin-top:1px; }

/* ENTRIES */
.entries-list { display:flex; flex-direction:column; gap:10px; }
.entry-card { background:var(--surface); border:1px solid var(--border); border-radius:16px; overflow:hidden; transition:all 0.2s; }
.entry-card:hover { border-color:var(--border2); }
.entry-card.hot { border-color:rgba(200,16,46,0.35); background:rgba(200,16,46,0.04); }
.entry-card.aging { border-color:rgba(249,115,22,0.35); background:rgba(249,115,22,0.04); }
.entry-card.claimed { border-color:rgba(34,197,94,0.25); }
.entry-main { padding:18px 20px; display:grid; grid-template-columns:auto 1fr auto; gap:16px; align-items:start; }
.temp-badge { width:52px; height:52px; border-radius:12px; display:flex; flex-direction:column; align-items:center; justify-content:center; flex-shrink:0; font-family:'Bebas Neue',sans-serif; }
.temp-badge .temp-num { font-size:26px; line-height:1; }
.temp-badge .temp-lbl { font-size:8px; letter-spacing:0.1em; opacity:0.7; }
.temp-hot { background:rgba(200,16,46,0.2); border:1px solid rgba(200,16,46,0.4); color:#FC8181; }
.temp-warm { background:rgba(249,115,22,0.2); border:1px solid rgba(249,115,22,0.4); color:var(--orange); }
.temp-cool { background:rgba(91,79,232,0.15); border:1px solid rgba(91,79,232,0.3); color:var(--purple2); }
.entry-name { font-size:16px; font-weight:700; margin-bottom:3px; }
.entry-meta { font-size:12px; color:var(--muted); display:flex; flex-wrap:wrap; gap:12px; margin-bottom:6px; }
.entry-meta span { display:flex; align-items:center; gap:4px; }
.entry-tags { display:flex; flex-wrap:wrap; gap:6px; }
.entry-tag { font-size:10px; font-weight:600; padding:3px 10px; border-radius:20px; letter-spacing:0.04em; }
.tag-outcome-sold{background:rgba(34,197,94,0.15);color:#4ADE80;border:1px solid rgba(34,197,94,0.2);}
.tag-outcome-appt{background:rgba(91,79,232,0.15);color:var(--purple2);border:1px solid rgba(91,79,232,0.2);}
.tag-outcome-follow{background:rgba(232,184,75,0.15);color:var(--gold);border:1px solid rgba(232,184,75,0.2);}
.tag-outcome-other{background:rgba(255,255,255,0.06);color:var(--muted);border:1px solid var(--border);}
.tag-followup{background:rgba(249,115,22,0.15);color:var(--orange);border:1px solid rgba(249,115,22,0.25);}
.tag-claimed{background:rgba(34,197,94,0.12);color:#4ADE80;border:1px solid rgba(34,197,94,0.2);}
.tag-pending{background:rgba(255,255,255,0.05);color:var(--muted);border:1px solid var(--border);}
.tag-hot{background:rgba(200,16,46,0.15);color:#FC8181;border:1px solid rgba(200,16,46,0.25);animation:pulse-dot 2s ease infinite;}
.verified-badge{display:inline-flex;align-items:center;gap:3px;font-size:10px;font-weight:700;padding:3px 10px;border-radius:20px;background:rgba(34,197,94,0.12);color:#4ADE80;border:1px solid rgba(34,197,94,0.2);}
.entry-right { display:flex; flex-direction:column; align-items:flex-end; gap:8px; flex-shrink:0; }
.entry-time { font-size:11px; color:var(--muted2); font-family:'DM Mono',monospace; }
.claim-btn { padding:8px 16px; border-radius:8px; font-size:12px; font-weight:700; background:linear-gradient(135deg,var(--purple),var(--purple2)); color:#fff; border:none; cursor:pointer; font-family:'DM Sans',sans-serif; transition:all 0.18s; white-space:nowrap; }
.claim-btn:hover { transform:translateY(-1px); box-shadow:0 4px 12px rgba(91,79,232,0.4); }
.claimed-by { font-size:11px; color:#4ADE80; font-weight:600; text-align:right; }
.expand-toggle { width:100%; padding:10px 20px; border:none; border-top:1px solid var(--border); background:transparent; color:var(--muted2); font-size:11px; font-weight:600; cursor:pointer; font-family:'DM Sans',sans-serif; transition:all 0.15s; text-align:left; display:flex; align-items:center; gap:6px; }
.expand-toggle:hover { background:rgba(255,255,255,0.03); color:var(--muted); }
.entry-expand { border-top:1px solid var(--border); padding:18px 20px; display:none; background:var(--surface2); }
.entry-expand.open { display:block; }
.expand-grid { display:grid; grid-template-columns:1fr 1fr 1fr; gap:16px; margin-bottom:16px; }
.expand-section-title { font-size:10px; font-weight:700; letter-spacing:0.14em; text-transform:uppercase; color:var(--muted2); margin-bottom:10px; }
.expand-row { display:flex; justify-content:space-between; align-items:baseline; padding:5px 0; border-bottom:1px solid rgba(255,255,255,0.04); }
.expand-row:last-child { border-bottom:none; }
.expand-key { font-size:11px; color:var(--muted); }
.expand-val { font-size:12px; font-weight:600; color:var(--text); text-align:right; max-width:180px; word-break:break-word; }
.manager-panel { background:var(--surface3); border:1px solid var(--border2); border-radius:10px; padding:16px; margin-top:16px; }
.manager-panel-title { font-size:10px; font-weight:700; letter-spacing:0.14em; text-transform:uppercase; color:var(--purple2); margin-bottom:12px; }
.manager-fields { display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:12px; }
.field-group { display:flex; flex-direction:column; gap:6px; }
.field-label { font-size:10px; font-weight:600; letter-spacing:0.1em; text-transform:uppercase; color:var(--muted2); }
.field-select,.field-textarea { background:var(--surface2); border:1.5px solid var(--border); border-radius:8px; color:var(--text); font-family:'DM Sans',sans-serif; font-size:12px; padding:9px 12px; outline:none; width:100%; transition:border-color 0.18s; -webkit-appearance:none; }
.field-select:focus,.field-textarea:focus { border-color:var(--purple); }
.field-textarea { resize:none; min-height:60px; }
.save-btn { padding:9px 20px; border-radius:8px; font-size:12px; font-weight:700; background:linear-gradient(135deg,var(--purple),var(--purple2)); color:#fff; border:none; cursor:pointer; font-family:'DM Sans',sans-serif; transition:all 0.18s; }
.save-btn:hover { transform:translateY(-1px); box-shadow:0 4px 12px rgba(91,79,232,0.35); }
.save-success { font-size:12px; color:#4ADE80; font-weight:600; opacity:0; transition:opacity 0.3s; }
.empty-state { text-align:center; padding:60px 20px; }
.empty-icon { font-size:48px; margin-bottom:12px; }
.empty-text { font-size:15px; color:var(--muted); font-weight:600; }
.loading { text-align:center; padding:60px; }
.dots { display:flex; gap:6px; justify-content:center; }
.dots span { width:8px; height:8px; border-radius:50%; background:var(--purple); animation:dotBounce 1s infinite; }
.dots span:nth-child(2){animation-delay:0.15s;} .dots span:nth-child(3){animation-delay:0.3s;}
@keyframes dotBounce{0%,80%,100%{transform:scale(0.6);opacity:0.3;}40%{transform:scale(1);opacity:1;}}

/* EXPORT */
.export-bar { display:flex; gap:10px; margin-bottom:14px; }
.export-btn { padding:8px 16px; border-radius:8px; font-size:11px; font-weight:700; border:1px solid var(--border); background:var(--surface); color:var(--muted); cursor:pointer; font-family:'DM Sans',sans-serif; transition:all 0.18s; }
.export-btn:hover { color:var(--text); border-color:var(--border2); }
.export-csv:hover { border-color:rgba(34,197,94,0.4); color:#4ADE80; }
.export-pdf:hover { border-color:rgba(91,79,232,0.4); color:var(--purple2); }

/* EDIT MODAL */
.mgr-modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:600;display:none;align-items:center;justify-content:center;padding:20px;}
.mgr-modal-overlay.open{display:flex;}
.mgr-modal-box{background:var(--surface);border:1px solid var(--border2);border-radius:20px;width:100%;max-width:680px;max-height:90vh;overflow-y:auto;position:relative;}
.mgr-modal-box::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--purple),var(--purple2));border-radius:20px 20px 0 0;}
.mgr-modal-header{padding:24px 28px 0;display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;}
.mgr-modal-title{font-family:'Bebas Neue',sans-serif;font-size:30px;letter-spacing:0.04em;color:var(--text);}
.mgr-modal-close{background:none;border:none;color:var(--muted);font-size:22px;cursor:pointer;padding:4px 8px;border-radius:6px;transition:color 0.18s;}
.mgr-modal-close:hover{color:var(--text);}
.mgr-modal-body{padding:0 28px 28px;}
.mgr-modal-section{font-size:9px;font-weight:700;letter-spacing:0.18em;text-transform:uppercase;color:var(--purple2);margin:20px 0 12px;padding-bottom:6px;border-bottom:1px solid var(--border2);}
.mgr-modal-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
.mgr-modal-grid.cols3{grid-template-columns:1fr 1fr 1fr;}
.mgr-field{display:flex;flex-direction:column;gap:6px;}
.mgr-label{font-size:9px;font-weight:700;letter-spacing:0.14em;text-transform:uppercase;color:var(--muted2);}
.mgr-input,.mgr-select,.mgr-textarea{background:var(--surface2);border:1.5px solid var(--border2);border-radius:9px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:13px;padding:10px 13px;transition:border-color 0.18s;-webkit-appearance:none;width:100%;}
.mgr-input:focus,.mgr-select:focus,.mgr-textarea:focus{outline:none;border-color:var(--purple);box-shadow:0 0 0 3px rgba(99,102,241,0.12);}
.mgr-textarea{resize:none;min-height:80px;}
.mgr-select option{background:var(--surface2);}
.mgr-modal-footer{display:flex;gap:10px;margin-top:24px;padding-top:18px;border-top:1px solid var(--border);}
.mgr-save-btn{flex:1;padding:13px;border-radius:10px;background:linear-gradient(135deg,var(--purple),var(--purple2));color:#fff;border:none;font-family:'DM Sans',sans-serif;font-size:14px;font-weight:700;cursor:pointer;transition:all 0.18s;}
.mgr-save-btn:hover{transform:translateY(-1px);box-shadow:0 6px 16px rgba(99,102,241,0.35);}
.mgr-cancel-btn{padding:13px 22px;border-radius:10px;background:var(--surface2);border:1.5px solid var(--border2);color:var(--muted);font-family:'DM Sans',sans-serif;font-size:14px;font-weight:600;cursor:pointer;transition:all 0.18s;}
.mgr-cancel-btn:hover{color:var(--text);}
.mgr-del-btn{padding:13px 16px;border-radius:10px;background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);color:#FC8181;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:600;cursor:pointer;transition:all 0.18s;}
.mgr-del-btn:hover{background:rgba(239,68,68,0.2);}
.mgr-toast{position:fixed;bottom:28px;left:50%;transform:translateX(-50%) translateY(80px);background:var(--surface);border:1px solid var(--border2);border-radius:12px;padding:12px 22px;font-size:13px;font-weight:600;color:var(--text);z-index:999;transition:transform 0.35s cubic-bezier(0.16,1,0.3,1);box-shadow:0 12px 32px rgba(0,0,0,0.4);white-space:nowrap;}
.mgr-toast.show{transform:translateX(-50%) translateY(0);}
.mgr-toast.green{border-color:rgba(34,197,94,0.4);color:#4ADE80;}
.edit-entry-btn{padding:7px 14px;border-radius:8px;font-size:11px;font-weight:700;background:rgba(99,102,241,0.12);border:1px solid rgba(99,102,241,0.3);color:var(--purple2);cursor:pointer;font-family:'DM Sans',sans-serif;transition:all 0.18s;white-space:nowrap;}
.edit-entry-btn:hover{background:rgba(99,102,241,0.22);transform:translateY(-1px);}
.crm-btn{padding:7px 14px;border-radius:8px;font-size:11px;font-weight:700;background:rgba(34,197,94,0.12);border:1px solid rgba(34,197,94,0.3);color:#4ADE80;cursor:pointer;font-family:'DM Sans',sans-serif;transition:all 0.18s;white-space:nowrap;display:flex;align-items:center;gap:5px;}
.crm-btn:hover{background:rgba(34,197,94,0.22);transform:translateY(-1px);}
.crm-btn:disabled{opacity:0.4;pointer-events:none;}
.crm-badge{font-size:9px;font-weight:700;padding:2px 7px;border-radius:10px;background:rgba(34,197,94,0.15);color:#4ADE80;border:1px solid rgba(34,197,94,0.2);letter-spacing:0.06em;white-space:nowrap;}
.range-btn{padding:6px 13px;border-radius:7px;background:var(--surface2);border:1px solid var(--border2);color:var(--muted);font-family:'DM Sans',sans-serif;font-size:11px;font-weight:600;cursor:pointer;transition:all 0.18s;}
.range-btn:hover{color:var(--text);border-color:var(--purple2);background:rgba(99,102,241,0.1);}
.rpt-row{display:flex;align-items:center;gap:10px;margin-bottom:10px;}
.rpt-bar-wrap{flex:1;height:8px;background:rgba(255,255,255,0.07);border-radius:4px;overflow:hidden;}
.rpt-bar{height:100%;border-radius:4px;transition:width 0.6s ease;}
.rpt-label{font-size:12px;font-weight:600;color:var(--text);min-width:140px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.rpt-count{font-family:'DM Mono',monospace;font-size:12px;font-weight:600;color:var(--muted);min-width:28px;text-align:right;}
.rpt-kpi-card{background:var(--surface);border:1px solid var(--border2);border-radius:14px;padding:18px;position:relative;overflow:hidden;}
.rpt-kpi-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;}
.rpt-kpi-lbl{font-size:9px;font-weight:700;letter-spacing:0.14em;text-transform:uppercase;color:rgba(255,255,255,0.45);margin-bottom:6px;}
.rpt-kpi-val{font-family:'Bebas Neue',sans-serif;font-size:44px;line-height:1;color:#fff;}
.rpt-kpi-sub{font-size:11px;color:rgba(255,255,255,0.4);margin-top:3px;}

/* VERIFY SALES QUEUE */
.verify-queue{display:flex;flex-direction:column;gap:12px;margin-top:16px;}
.vq-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);overflow:hidden;transition:border-color 0.2s;}
.vq-card:hover{border-color:var(--border2);}
.vq-main{display:flex;align-items:center;justify-content:space-between;padding:18px 20px;gap:16px;}
.vq-info{flex:1;min-width:0;}
.vq-name{font-size:15px;font-weight:700;margin-bottom:3px;}
.vq-meta{font-size:12px;color:var(--muted);display:flex;flex-wrap:wrap;gap:8px;margin-bottom:6px;}
.vq-meta span{display:flex;align-items:center;gap:3px;}
.vq-rep{font-size:11px;font-weight:600;color:var(--purple2);background:rgba(99,102,241,0.12);padding:2px 10px;border-radius:12px;display:inline-block;}
.vq-actions{display:flex;gap:8px;flex-shrink:0;}
.vq-confirm{padding:10px 18px;border-radius:8px;font-size:12px;font-weight:700;background:rgba(34,197,94,0.15);border:1px solid rgba(34,197,94,0.3);color:#4ADE80;cursor:pointer;font-family:'DM Sans',sans-serif;transition:all 0.18s;white-space:nowrap;}
.vq-confirm:hover{background:rgba(34,197,94,0.25);transform:translateY(-1px);}
.vq-reject{padding:10px 18px;border-radius:8px;font-size:12px;font-weight:700;background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.25);color:#FC8181;cursor:pointer;font-family:'DM Sans',sans-serif;transition:all 0.18s;white-space:nowrap;}
.vq-reject:hover{background:rgba(239,68,68,0.2);transform:translateY(-1px);}
.vq-date{font-size:11px;color:var(--muted2);font-family:'DM Mono',monospace;margin-bottom:4px;}
.vq-empty{text-align:center;padding:48px 20px;color:var(--muted2);}
.vq-empty-icon{font-size:40px;margin-bottom:12px;}
.vq-empty-text{font-size:14px;font-weight:600;color:var(--muted);}
.vq-empty-sub{font-size:12px;color:var(--muted2);margin-top:4px;}
.vq-reject-panel{display:none;padding:16px 20px;background:var(--surface2);border-top:1px solid var(--border);}
.vq-reject-panel.open{display:block;}
.vq-reject-grid{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px;}
.vq-reject-pill{padding:8px 16px;border-radius:20px;font-size:12px;font-weight:600;border:1.5px solid var(--border);color:var(--muted);cursor:pointer;background:transparent;font-family:'DM Sans',sans-serif;transition:all 0.15s;}
.vq-reject-pill:hover{border-color:var(--border2);color:var(--text);}
.vq-reject-pill.sel{border-color:var(--orange);background:rgba(249,115,22,0.12);color:var(--orange);}
.vq-reject-label{font-size:10px;font-weight:700;letter-spacing:0.12em;text-transform:uppercase;color:var(--muted2);margin-bottom:6px;}
.vq-reject-textarea{width:100%;background:var(--surface3);border:1.5px solid var(--border2);border-radius:9px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:13px;padding:10px 13px;min-height:60px;resize:none;outline:none;}
.vq-reject-textarea:focus{border-color:var(--orange);}
.vq-reject-submit{padding:10px 20px;border-radius:8px;font-size:12px;font-weight:700;background:var(--orange);border:none;color:#fff;cursor:pointer;font-family:'DM Sans',sans-serif;transition:all 0.18s;}
.vq-reject-submit:hover{opacity:0.9;transform:translateY(-1px);}
.vq-reject-submit:disabled{opacity:0.35;cursor:not-allowed;}

@media(max-width:1100px){.kpi-grid{grid-template-columns:repeat(3,1fr);}}
@media(max-width:768px){
  .page{padding:16px 16px 60px;}
  .kpi-grid{grid-template-columns:repeat(2,1fr);}
  .entry-main{grid-template-columns:auto 1fr;grid-template-rows:auto auto;}
  .entry-right{flex-direction:row;align-items:center;grid-column:1/-1;}
  .expand-grid{grid-template-columns:1fr;}
  .manager-fields{grid-template-columns:1fr;}
  .nav-user-name{display:none;}
  .vq-main{flex-direction:column;align-items:stretch;}
  .vq-actions{justify-content:stretch;}
  .vq-confirm,.vq-reject{flex:1;text-align:center;}
  .tabs{flex-wrap:wrap;}
}
</style>
</head>
<body>
<div class="bg-orb1"></div>
<div class="bg-orb2"></div>

<!-- NAV -->
<nav>
  <div class="nav-left">
    <div class="nav-brand">Performance Dashboard</div>
    <div class="nav-live">‚óè LIVE</div>
  </div>
  <div class="nav-right">
    <button class="refresh-btn" onclick="loadAll()">‚Üª Refresh</button>
    <div class="nav-user-pill">
      <div class="nav-avatar" id="nav-avatar">‚Äî</div>
      <span class="nav-user-name" id="nav-name"></span>
      <span class="nav-role-pill" id="nav-role"></span>
    </div>
    <div class="hamburger" id="hamburger" onclick="toggleMenu(event)">
      <span></span><span></span><span></span>
    </div>
  </div>
</nav>

<!-- DROPDOWN -->
<div class="nav-dropdown" id="nav-dropdown">
  <div class="dd-header">
    <div class="dd-header-name" id="dd-name"></div>
    <div class="dd-header-role" id="dd-role"></div>
  </div>
  <a href="app.html" class="dd-item"><span class="dd-icon">üè†</span> Home</a>
  <a href="service-to-sales-log.html" class="dd-item"><span class="dd-icon">üìã</span> S2S Entry</a>
  <button class="dd-item" onclick="goReports()"><span class="dd-icon">üìä</span> Reports</button>
  <a href="scorecards.html" class="dd-item"><span class="dd-icon">üèÜ</span> Scorecards</a>
  <div class="dd-divider dd-admin-div" id="admin-div"></div>
  <a href="admin-panel.html" class="dd-item dd-admin" id="admin-link"><span class="dd-icon">‚öôÔ∏è</span> Admin Panel</a>
  <div class="dd-divider"></div>
  <button class="dd-item danger" onclick="signOut()"><span class="dd-icon">üö™</span> Sign Out</button>
</div>

<div class="page">
  <!-- KPIs -->
  <div class="kpi-grid fade-in" id="kpi-row">
    <div class="kpi-card kpi-p"><div class="kpi-lbl">Today's Entries</div><div class="kpi-val" id="kpi-today">‚Äî</div></div>
    <div class="kpi-card kpi-r"><div class="kpi-lbl">Hot Leads</div><div class="kpi-val" id="kpi-hot">‚Äî</div><div class="kpi-sub">Score 8-10</div></div>
    <div class="kpi-card kpi-g"><div class="kpi-lbl">Sold Today</div><div class="kpi-val" id="kpi-sold">‚Äî</div></div>
    <div class="kpi-card kpi-o"><div class="kpi-lbl">Unclaimed</div><div class="kpi-val" id="kpi-unclaimed">‚Äî</div><div class="kpi-sub">Hot leads</div></div>
    <div class="kpi-card kpi-gold"><div class="kpi-lbl">Avg Temp</div><div class="kpi-val" id="kpi-avg">‚Äî</div><div class="kpi-sub">Today</div></div>
    <div class="kpi-card kpi-b"><div class="kpi-lbl">Follow-Up Due</div><div class="kpi-val" id="kpi-followup">‚Äî</div><div class="kpi-sub">No contact 24h+</div></div>
  </div>

  <!-- Hot banner -->
  <div id="hot-banner" style="display:none;" class="alert-banner fade-in">
    <div class="alert-dot"></div>
    <div>
      <div class="alert-text" id="hot-banner-text">üî• Unclaimed hot leads need attention</div>
      <div class="alert-sub">Claim and action these leads before they leave the lot</div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab active" onclick="switchTab('all',this)">All Entries <span class="tab-badge purple" id="tab-all-count">0</span></button>
    <button class="tab" onclick="switchTab('hot',this)">üî• Hot Leads <span class="tab-badge" id="tab-hot-count">0</span></button>
    <button class="tab" onclick="switchTab('aging',this)">‚ö†Ô∏è Needs Follow-Up <span class="tab-badge" id="tab-aging-count">0</span></button>
    <button class="tab" onclick="switchTab('unclaimed',this)">Unclaimed <span class="tab-badge" id="tab-unclaimed-count">0</span></button>
    <button class="tab" id="tab-verify" onclick="switchTab('verify',this)">‚úÖ Verify Sales <span class="tab-badge tab-badge-verify" id="tab-verify-count">0</span></button>
    <button class="tab" id="tab-reports" onclick="switchTab('reports',this)">üìä Reports</button>
  </div>

  <!-- Export -->
  <div class="export-bar" id="export-bar">
    <button class="export-btn export-csv" onclick="exportS2SCSV()">‚¨á S2S Entries ‚Äî CSV</button>
    <button class="export-btn export-pdf" onclick="exportS2SPDF()">üñ® S2S Entries ‚Äî Print / PDF</button>
  </div>
  <div class="section-hd" id="section-hd">
    <div class="section-title">S2S Entries</div>
    <div class="section-count" id="showing-count"></div>
  </div>

  <!-- Verify Sales Panel -->
  <div id="verify-panel" style="display:none;">
    <div class="section-hd">
      <div class="section-title">Pending Sale Verification</div>
      <div class="section-count" id="verify-showing-count"></div>
    </div>
    <div class="verify-queue" id="verify-queue"></div>
  </div>

  <!-- Reports Panel -->
  <div id="reports-panel" style="display:none;">
    <div style="background:var(--surface);border:1px solid var(--border2);border-radius:16px;padding:24px;margin-bottom:20px;">
      <div style="font-size:10px;font-weight:700;letter-spacing:0.16em;text-transform:uppercase;color:var(--muted2);margin-bottom:16px;">üìÖ Report Filters</div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr auto;gap:12px;align-items:end;">
        <div><div style="font-size:10px;font-weight:600;letter-spacing:0.1em;text-transform:uppercase;color:var(--muted2);margin-bottom:6px;">From</div><input type="date" id="rpt-from" style="width:100%;background:var(--surface2);border:1.5px solid var(--border2);border-radius:9px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:13px;padding:10px 12px;outline:none;"></div>
        <div><div style="font-size:10px;font-weight:600;letter-spacing:0.1em;text-transform:uppercase;color:var(--muted2);margin-bottom:6px;">To</div><input type="date" id="rpt-to" style="width:100%;background:var(--surface2);border:1.5px solid var(--border2);border-radius:9px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:13px;padding:10px 12px;outline:none;"></div>
        <div><div style="font-size:10px;font-weight:600;letter-spacing:0.1em;text-transform:uppercase;color:var(--muted2);margin-bottom:6px;">Rep</div><select id="rpt-rep" style="width:100%;background:var(--surface2);border:1.5px solid var(--border2);border-radius:9px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:13px;padding:10px 12px;outline:none;-webkit-appearance:none;"><option value="">All Reps</option><option>Tyler Doyle</option><option>Andrew Kirk</option><option>DJ Rogers</option><option>Kody McCann</option></select></div>
        <div><div style="font-size:10px;font-weight:600;letter-spacing:0.1em;text-transform:uppercase;color:var(--muted2);margin-bottom:6px;">Source</div><select id="rpt-source" style="width:100%;background:var(--surface2);border:1.5px solid var(--border2);border-radius:9px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:13px;padding:10px 12px;outline:none;-webkit-appearance:none;"><option value="s2s">Service-to-Sales</option></select></div>
        <button onclick="runReport()" style="padding:10px 22px;border-radius:9px;background:linear-gradient(135deg,var(--purple),var(--purple2));color:#fff;border:none;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:700;cursor:pointer;white-space:nowrap;">Run Report ‚Üí</button>
      </div>
      <div style="display:flex;gap:8px;margin-top:14px;flex-wrap:wrap;">
        <span style="font-size:10px;font-weight:600;color:var(--muted2);align-self:center;text-transform:uppercase;letter-spacing:0.08em;">Quick:</span>
        <button onclick="setRange('today')" class="range-btn">Today</button>
        <button onclick="setRange('yesterday')" class="range-btn">Yesterday</button>
        <button onclick="setRange('week')" class="range-btn">This Week</button>
        <button onclick="setRange('month')" class="range-btn">This Month</button>
        <button onclick="setRange('last30')" class="range-btn">Last 30 Days</button>
        <button onclick="setRange('all')" class="range-btn">All Time</button>
      </div>
    </div>
    <div id="rpt-output" style="display:none;">
      <div id="rpt-kpis" style="display:grid;grid-template-columns:repeat(5,1fr);gap:12px;margin-bottom:20px;"></div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px;">
        <div style="background:var(--surface);border:1px solid var(--border2);border-radius:16px;padding:22px;"><div style="font-size:10px;font-weight:700;letter-spacing:0.14em;text-transform:uppercase;color:var(--muted2);margin-bottom:16px;">By Rep</div><div id="rpt-by-rep"></div></div>
        <div style="background:var(--surface);border:1px solid var(--border2);border-radius:16px;padding:22px;"><div style="font-size:10px;font-weight:700;letter-spacing:0.14em;text-transform:uppercase;color:var(--muted2);margin-bottom:16px;">By Outcome</div><div id="rpt-by-source"></div></div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px;">
        <div style="background:var(--surface);border:1px solid var(--border2);border-radius:16px;padding:22px;"><div style="font-size:10px;font-weight:700;letter-spacing:0.14em;text-transform:uppercase;color:var(--muted2);margin-bottom:16px;">Lead Temperature</div><div id="rpt-mgr-inv"></div></div>
        <div style="background:var(--surface);border:1px solid var(--border2);border-radius:16px;padding:22px;">
          <div style="font-size:10px;font-weight:700;letter-spacing:0.14em;text-transform:uppercase;color:var(--muted2);margin-bottom:16px;">Daily Breakdown</div>
          <div style="overflow-x:auto;">
            <table style="width:100%;border-collapse:collapse;" id="rpt-daily-table">
              <thead><tr style="background:var(--surface2);"><th style="padding:8px 12px;text-align:left;font-size:10px;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;color:var(--muted2);">Date</th><th style="padding:8px 12px;text-align:center;font-size:10px;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;color:var(--muted2);">Total</th><th style="padding:8px 12px;text-align:center;font-size:10px;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;color:var(--muted2);">Sold</th><th style="padding:8px 12px;text-align:center;font-size:10px;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;color:var(--muted2);">Close%</th></tr></thead>
              <tbody id="rpt-daily-body"></tbody>
            </table>
          </div>
          <div style="margin-top:12px;"><button onclick="exportReportCSV()" style="padding:7px 14px;border-radius:7px;background:rgba(34,197,94,0.12);border:1px solid rgba(34,197,94,0.3);color:#4ADE80;font-size:11px;font-weight:700;cursor:pointer;font-family:'DM Sans',sans-serif;">‚¨á Export CSV</button></div>
        </div>
      </div>
    </div>
    <div id="rpt-empty" style="text-align:center;padding:60px 24px;color:var(--muted);"><div style="font-size:48px;margin-bottom:16px;opacity:0.4;">üìä</div><div style="font-size:16px;font-weight:600;margin-bottom:8px;">Select a date range and run your report</div><div style="font-size:13px;color:var(--muted2);">Filter by rep, date range, or data source</div></div>
  </div>

  <!-- Entries -->
  <div class="entries-list fade-in" id="entries-list">
    <div class="loading"><div class="dots"><span></span><span></span><span></span></div></div>
  </div>
</div>

<!-- Edit Modal -->
<div class="mgr-modal-overlay" id="mgr-edit-modal">
  <div class="mgr-modal-box">
    <div class="mgr-modal-header"><div class="mgr-modal-title">Edit Entry</div><button class="mgr-modal-close" onclick="closeMgrEdit()">‚úï</button></div>
    <div class="mgr-modal-body">
      <input type="hidden" id="mgr-edit-id">
      <div class="mgr-modal-section">Customer</div>
      <div class="mgr-modal-grid">
        <div class="mgr-field"><label class="mgr-label">First Name</label><input class="mgr-input" id="mgr-first" type="text"></div>
        <div class="mgr-field"><label class="mgr-label">Last Name</label><input class="mgr-input" id="mgr-last" type="text"></div>
        <div class="mgr-field"><label class="mgr-label">Phone</label><input class="mgr-input" id="mgr-phone" type="text"></div>
        <div class="mgr-field"><label class="mgr-label">Email</label><input class="mgr-input" id="mgr-email" type="text"></div>
        <div class="mgr-field"><label class="mgr-label">Contact Preference</label><select class="mgr-select" id="mgr-contact-pref"><option value="">‚Äî</option><option>Phone Call</option><option>Text</option><option>Email</option><option>No Preference</option></select></div>
        <div class="mgr-field"><label class="mgr-label">Best Time</label><select class="mgr-select" id="mgr-best-time"><option value="">‚Äî</option><option>Morning (8am‚Äì12pm)</option><option>Afternoon (12‚Äì5pm)</option><option>Evening (5‚Äì8pm)</option><option>Anytime</option></select></div>
      </div>
      <div class="mgr-modal-section">Vehicle & Service</div>
      <div class="mgr-modal-grid cols3">
        <div class="mgr-field"><label class="mgr-label">Year</label><input class="mgr-input" id="mgr-year" type="text"></div>
        <div class="mgr-field"><label class="mgr-label">Make</label><input class="mgr-input" id="mgr-make" type="text"></div>
        <div class="mgr-field"><label class="mgr-label">Model</label><input class="mgr-input" id="mgr-model" type="text"></div>
        <div class="mgr-field"><label class="mgr-label">Trim</label><input class="mgr-input" id="mgr-trim" type="text"></div>
        <div class="mgr-field"><label class="mgr-label">Mileage</label><input class="mgr-input" id="mgr-miles" type="text"></div>
        <div class="mgr-field"><label class="mgr-label">RO #</label><input class="mgr-input" id="mgr-ro" type="text"></div>
        <div class="mgr-field"><label class="mgr-label">Repair Cost</label><input class="mgr-input" id="mgr-repair" type="text"></div>
        <div class="mgr-field"><label class="mgr-label">Service Advisor</label><input class="mgr-input" id="mgr-advisor" type="text"></div>
        <div class="mgr-field"><label class="mgr-label">Ownership</label><input class="mgr-input" id="mgr-ownership" type="text"></div>
      </div>
      <div class="mgr-modal-section">Trade & Finance</div>
      <div class="mgr-modal-grid">
        <div class="mgr-field"><label class="mgr-label">Trade Interest</label><input class="mgr-input" id="mgr-trade-interest" type="text"></div>
        <div class="mgr-field"><label class="mgr-label">Trade ACV</label><input class="mgr-input" id="mgr-trade-acv" type="text"></div>
        <div class="mgr-field"><label class="mgr-label">Expected Value</label><input class="mgr-input" id="mgr-trade-expect" type="text"></div>
        <div class="mgr-field"><label class="mgr-label">VOI</label><input class="mgr-input" id="mgr-voi" type="text"></div>
        <div class="mgr-field"><label class="mgr-label">Budget</label><input class="mgr-input" id="mgr-budget" type="text"></div>
        <div class="mgr-field"><label class="mgr-label">Timeline</label><input class="mgr-input" id="mgr-timeline" type="text"></div>
      </div>
      <div class="mgr-modal-section">Sales</div>
      <div class="mgr-modal-grid">
        <div class="mgr-field"><label class="mgr-label">Submitter</label><select class="mgr-select" id="mgr-submitter"><option>Tyler Doyle</option><option>Andrew Kirk</option><option>DJ Rogers</option><option>Kody McCann</option></select></div>
        <div class="mgr-field"><label class="mgr-label">Score</label><input class="mgr-input" id="mgr-score" type="text"></div>
        <div class="mgr-field"><label class="mgr-label">Outcome</label><select class="mgr-select" id="mgr-outcome"><option value="">‚Äî</option><option>New Vehicle Sold</option><option>Used Vehicle Sold</option><option>Appointment Set</option><option>Follow-Up Required</option><option>Not Interested</option><option>Demo Completed</option></select></div>
        <div class="mgr-field"><label class="mgr-label">Emotion</label><input class="mgr-input" id="mgr-emotion" type="text"></div>
      </div>
      <div class="mgr-field" style="margin-top:14px;"><label class="mgr-label">Notes</label><textarea class="mgr-textarea" id="mgr-notes"></textarea></div>
      <div class="mgr-modal-footer">
        <button class="mgr-save-btn" onclick="saveMgrEdit()">Save Changes</button>
        <button class="mgr-cancel-btn" onclick="closeMgrEdit()">Cancel</button>
        <button class="mgr-del-btn" onclick="deleteMgrEntry()">üóë Delete</button>
      </div>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="mgr-toast" id="mgr-toast"></div>

<script>
const SB_URL='https://jbkgwtohwsbaorhvuuqb.supabase.co';
const SB_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impia2d3dG9od3NiYW9yaHZ1dXFiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5NjkwNDIsImV4cCI6MjA4NzU0NTA0Mn0.GRXOYbIuVDxU9-FEBYmyd1QmytVUrMIAxbnOSfepzuU';
let H={'Content-Type':'application/json','apikey':SB_KEY,'Authorization':'Bearer '+SB_KEY,'Prefer':'return=minimal'};
function _refreshH(){ const t=window.sbSession?.access_token||SB_KEY; H={'Content-Type':'application/json','apikey':SB_KEY,'Authorization':'Bearer '+t,'Prefer':'return=minimal'}; }

// NAV INIT ‚Äî deferred to SB_AUTH
let currentRep=null;
function _initDashNav(user){
  currentRep={name:user.name,role:user.role,initials:user.initials};
  document.getElementById('nav-avatar').textContent=user.initials;
  document.getElementById('nav-name').textContent=user.name;
  const roleEl=document.getElementById('nav-role');
  roleEl.textContent=user.role;
  roleEl.className='nav-role-pill '+(user.role==='Admin'?'role-admin':user.role==='Manager'?'role-manager':'role-sales');
  document.getElementById('dd-name').textContent=user.name;
  document.getElementById('dd-role').textContent=user.role+' ¬∑ ServiceBridge';
  if(user.role==='Admin'){document.getElementById('admin-link').classList.add('show');document.getElementById('admin-div').classList.add('show');}
  if(user.role!=='Admin'&&user.role!=='Manager'){const vTab=document.getElementById('tab-verify');if(vTab)vTab.style.display='none';}
}

function toggleMenu(e){e.stopPropagation();document.getElementById('hamburger').classList.toggle('open');document.getElementById('nav-dropdown').classList.toggle('open');}
document.addEventListener('click',()=>{document.getElementById('hamburger').classList.remove('open');document.getElementById('nav-dropdown').classList.remove('open');});
document.getElementById('nav-dropdown').addEventListener('click',e=>e.stopPropagation());
function goReports(){document.getElementById('nav-dropdown').classList.remove('open');document.getElementById('hamburger').classList.remove('open');switchTab('reports',document.getElementById('tab-reports'));}
function signOut(){if(window.signOut)window.signOut();else{sessionStorage.removeItem('sb_rep');window.location.replace('/login.html');}}

// DATA
let allEntries=[],currentTab='all';

async function loadAll(){
  try{
    const res=await fetch(`${SB_URL}/rest/v1/s2s_entries?select=*&order=id.desc&limit=500`,{headers:{'apikey':SB_KEY,'Authorization':'Bearer '+(window.sbSession?.access_token||SB_KEY)}});
    allEntries=await res.json();
    renderKPIs();renderEntries();renderVerifyQueue();
  }catch(e){
    document.getElementById('entries-list').innerHTML='<div class="empty-state"><div class="empty-icon">‚ö†Ô∏è</div><div class="empty-text">Failed to load. Check connection.</div></div>';
  }
}

const isHot=e=>parseInt(e.eng_score)>=8;
const isAging=e=>{if(!e.created_at)return false;return(Date.now()-new Date(e.created_at))/36e5>=24&&(!e.followup_status||e.followup_status==='Pending')&&!e.manager_claimed_by;};
const isUnclaimed=e=>isHot(e)&&!e.manager_claimed_by;
const isSold=e=>e.outcome&&(e.outcome.toLowerCase().includes('sold')||e.outcome.includes('New Vehicle')||e.outcome.includes('Used Vehicle'));

function renderKPIs(){
  const today=allEntries.filter(e=>new Date(e.created_at).toDateString()===new Date().toDateString());
  const hot=allEntries.filter(isHot),unc=allEntries.filter(isUnclaimed),aging=allEntries.filter(isAging);
  const sold=today.filter(isSold);
  const temps=today.filter(e=>e.eng_score).map(e=>parseInt(e.eng_score));
  document.getElementById('kpi-today').textContent=today.length;
  document.getElementById('kpi-hot').textContent=hot.length;
  document.getElementById('kpi-sold').textContent=sold.length;
  document.getElementById('kpi-unclaimed').textContent=unc.length;
  document.getElementById('kpi-avg').textContent=temps.length?(temps.reduce((a,b)=>a+b,0)/temps.length).toFixed(1):'‚Äî';
  document.getElementById('kpi-followup').textContent=aging.length;
  document.getElementById('tab-all-count').textContent=allEntries.length;
  document.getElementById('tab-hot-count').textContent=hot.length;
  document.getElementById('tab-aging-count').textContent=aging.length;
  document.getElementById('tab-unclaimed-count').textContent=unc.length;
  const banner=document.getElementById('hot-banner');
  if(unc.length>0){banner.style.display='flex';document.getElementById('hot-banner-text').textContent=`üî• ${unc.length} unclaimed hot lead${unc.length>1?'s':''} need immediate attention`;}
  else banner.style.display='none';
}

function switchTab(tab,el){
  currentTab=tab;
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  el.classList.add('active');
  const isRpt=tab==='reports',isVerify=tab==='verify';
  document.getElementById('reports-panel').style.display=isRpt?'block':'none';
  document.getElementById('verify-panel').style.display=isVerify?'block':'none';
  document.getElementById('entries-list').style.display=(isRpt||isVerify)?'none':'flex';
  document.getElementById('section-hd').style.display=(isRpt||isVerify)?'none':'flex';
  document.getElementById('export-bar').style.display=(isRpt||isVerify)?'none':'flex';
  if(isRpt&&!document.getElementById('rpt-from').value){const now=new Date();document.getElementById('rpt-from').value=new Date(now.getFullYear(),now.getMonth(),1).toISOString().slice(0,10);document.getElementById('rpt-to').value=now.toISOString().slice(0,10);}
  if(isVerify)renderVerifyQueue();
  if(!isRpt&&!isVerify)renderEntries();
}

function renderEntries(){
  let f=allEntries;
  if(currentTab==='hot')f=allEntries.filter(isHot);
  else if(currentTab==='aging')f=allEntries.filter(isAging);
  else if(currentTab==='unclaimed')f=allEntries.filter(isUnclaimed);
  document.getElementById('showing-count').textContent=`${f.length} entries`;
  const list=document.getElementById('entries-list');
  if(!f.length){list.innerHTML='<div class="empty-state"><div class="empty-icon">‚úÖ</div><div class="empty-text">No entries in this view.</div></div>';return;}
  list.innerHTML=f.map(e=>buildEntryCard(e)).join('');
}

const tempClass=s=>{const n=parseInt(s);return n>=8?'temp-hot':n>=5?'temp-warm':'temp-cool';};
function outcomeTag(o){
  if(!o)return`<span class="entry-tag tag-outcome-other">‚Äî</span>`;
  if(o.includes('New')||o.includes('Used')||o.toLowerCase().includes('sold'))return`<span class="entry-tag tag-outcome-sold">‚úì ${o}</span>`;
  if(o.includes('Appt')||o.includes('Appointment'))return`<span class="entry-tag tag-outcome-appt">üìÖ ${o}</span>`;
  if(o.includes('Follow'))return`<span class="entry-tag tag-outcome-follow">‚Ü© ${o}</span>`;
  return`<span class="entry-tag tag-outcome-other">${o}</span>`;
}
function followupTag(e){
  const s=e.followup_status||'Pending';
  if(s==='Pending')return`<span class="entry-tag tag-pending">‚è≥ Follow-Up Pending</span>`;
  if(s==='Closed')return`<span class="entry-tag tag-claimed">‚úì Closed</span>`;
  return`<span class="entry-tag tag-followup">‚Ü© ${s}</span>`;
}

function buildEntryCard(e){
  const sc=parseInt(e.eng_score)||0,hot=sc>=8,aging=isAging(e),claimed=!!e.manager_claimed_by;
  const cls=hot?'hot':aging?'aging':claimed?'claimed':'';
  const t=e.timestamp||(e.created_at?new Date(e.created_at).toLocaleString('en-US',{month:'short',day:'numeric',hour:'numeric',minute:'2-digit'}):'‚Äî');
  return`<div class="entry-card ${cls}" id="card-${e.id}">
  <div class="entry-main">
    <div class="temp-badge ${tempClass(sc)}"><div class="temp-num">${sc||'‚Äî'}</div><div class="temp-lbl">TEMP</div></div>
    <div class="entry-info">
      <div class="entry-name">${e.first_name||''} ${e.last_name||''}</div>
      <div class="entry-meta">
        <span>üë§ ${e.submitter||'Unknown'}</span>
        ${e.veh_year||e.veh_make?`<span>üöó ${e.veh_year||''} ${e.veh_make||''} ${e.veh_model||''}</span>`:''}
        ${e.repair_cost?`<span>üîß $${e.repair_cost}</span>`:''}
        ${e.phone?`<span>üìû ${e.phone}</span>`:''}
      </div>
      <div class="entry-tags">
        ${e.verified_sold?'<span class="verified-badge">‚úÖ Verified Sale</span>':''}
        ${outcomeTag(e.outcome)}${followupTag(e)}
        ${hot?'<span class="entry-tag tag-hot">üî• HOT LEAD</span>':''}
        ${claimed?`<span class="entry-tag tag-claimed">‚úì Claimed: ${e.manager_claimed_by}</span>`:''}
        ${aging?'<span class="entry-tag tag-followup">‚ö†Ô∏è 24h No Contact</span>':''}
      </div>
    </div>
    <div class="entry-right">
      <div class="entry-time">${t}</div>
      <button class="edit-entry-btn" onclick="openMgrEdit(${e.id})">‚úèÔ∏è Edit</button>
      ${e.crm_pushed_at?`<div class="crm-badge">‚úì In DriveCentric</div>`:`<button class="crm-btn" id="crm-btn-${e.id}" onclick="pushToCRM(${e.id},this)"><span>üöÄ</span> Push to CRM</button>`}
      ${!claimed&&hot?`<button class="claim-btn" onclick="claimLead(${e.id})">‚ö° Claim Lead</button>`:''}
      ${claimed?`<div class="claimed-by">‚úì ${e.manager_claimed_by}</div>`:''}
    </div>
  </div>
  <button class="expand-toggle" onclick="toggleExpand(${e.id},this)"><span>‚ñº</span> View Details & Action</button>
  <div class="entry-expand" id="expand-${e.id}">
    <div class="expand-grid">
      <div>
        <div class="expand-section-title">Customer</div>
        ${expandRow('Phone',e.phone)}${expandRow('Email',e.email)}${expandRow('Contact Pref',e.contact_pref)}${expandRow('Best Time',e.best_time)}${expandRow('Emotion',e.cust_emotion)}
      </div>
      <div>
        <div class="expand-section-title">Vehicle & Service</div>
        ${expandRow('Vehicle',[e.veh_year,e.veh_make,e.veh_model,e.veh_trim].filter(Boolean).join(' '))}
        ${expandRow('Mileage',e.veh_miles)}${expandRow('Ownership',e.veh_ownership)}${expandRow('RO #',e.ro_num)}${expandRow('Advisor',e.svc_advisor)}${expandRow('Repair Cost',e.repair_cost?'$'+e.repair_cost:null)}
      </div>
      <div>
        <div class="expand-section-title">Trade & Finance</div>
        ${expandRow('Trade Interest',e.trade_interest)}${expandRow('Trade ACV',e.trade_acv?'$'+e.trade_acv:null)}${expandRow('Expected',e.trade_expect?'$'+e.trade_expect:null)}${expandRow('VOI',e.voi)}${expandRow('Budget',e.voi_budget)}${expandRow('Timeline',e.timeline)}
      </div>
    </div>
    ${e.notes?`<div style="background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:14px;font-size:13px;color:var(--muted);"><strong style="color:var(--text);">Rep Notes:</strong> ${e.notes}</div>`:''}
    <div class="manager-panel">
      <div class="manager-panel-title">‚ö° Manager Action</div>
      <div class="manager-fields">
        <div class="field-group"><div class="field-label">Follow-Up Status</div><select class="field-select" id="fs-${e.id}">${['Pending','Called','Left VM','Texted','Came Back In','Appointment Set','No Contact','Closed'].map(s=>`<option value="${s}" ${(e.followup_status||'Pending')===s?'selected':''}>${s}</option>`).join('')}</select></div>
        <div class="field-group"><div class="field-label">Manager Outcome</div><select class="field-select" id="mo-${e.id}">${['','Sold New','Sold Used','Appointment Set','Working Deal','Not Interested','Needs Follow-Up','No Show'].map(s=>`<option value="${s}" ${(e.manager_outcome||'')===s?'selected':''}>${s||'‚Äî Select ‚Äî'}</option>`).join('')}</select></div>
      </div>
      <div class="field-group" style="margin-bottom:12px;"><div class="field-label">Coaching / Action Notes</div><textarea class="field-textarea" id="mn-${e.id}" placeholder="What action was taken?">${e.manager_notes||''}</textarea></div>
      <div style="display:flex;align-items:center;gap:12px;"><button class="save-btn" onclick="saveAction(${e.id})">Save Action</button><span class="save-success" id="saved-${e.id}">‚úì Saved</span></div>
    </div>
  </div>
</div>`;
}

function expandRow(k,v){if(!v||String(v).trim()==='')return'';return`<div class="expand-row"><span class="expand-key">${k}</span><span class="expand-val">${v}</span></div>`;}
function toggleExpand(id,btn){const p=document.getElementById('expand-'+id);p.classList.toggle('open');btn.querySelector('span').textContent=p.classList.contains('open')?'‚ñ≤':'‚ñº';}

// ACTIONS
async function claimLead(id){
  const n=currentRep?currentRep.name:(prompt('Your name:','Manager')||'Manager');
  const at=new Date().toLocaleString('en-US',{month:'short',day:'numeric',hour:'numeric',minute:'2-digit'});
  try{await fetch(`${SB_URL}/rest/v1/s2s_entries?id=eq.${id}`,{method:'PATCH',headers:H,body:JSON.stringify({manager_claimed_by:n,manager_claimed_at:at,followup_status:'Called'})});await loadAll();}
  catch(e){alert('Error claiming lead');}
}

async function saveAction(id){
  const fs=document.getElementById('fs-'+id)?.value,mo=document.getElementById('mo-'+id)?.value,mn=document.getElementById('mn-'+id)?.value;
  try{
    await fetch(`${SB_URL}/rest/v1/s2s_entries?id=eq.${id}`,{method:'PATCH',headers:H,body:JSON.stringify({followup_status:fs,manager_outcome:mo,manager_notes:mn})});
    const el=document.getElementById('saved-'+id);el.style.opacity='1';setTimeout(()=>el.style.opacity='0',2500);
    const i=allEntries.findIndex(e=>e.id===id);if(i!==-1){allEntries[i].followup_status=fs;allEntries[i].manager_outcome=mo;allEntries[i].manager_notes=mn;}
    renderKPIs();
  }catch(e){alert('Error saving');}
}

async function pushToCRM(id,btn){
  const e=allEntries.find(x=>x.id===id);if(!e)return;
  const name=`${e.first_name||''} ${e.last_name||''}`.trim()||'this customer';
  if(!confirm(`Push ${name} to DriveCentric?`))return;
  btn.disabled=true;btn.innerHTML='<span>‚è≥</span> Sending...';
  try{
    const res=await fetch('/api/send-to-crm',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(e)});
    const data=await res.json();if(!res.ok)throw new Error(data.error);
    const at=new Date().toLocaleString('en-US',{month:'short',day:'numeric',hour:'numeric',minute:'2-digit'});
    await fetch(`${SB_URL}/rest/v1/s2s_entries?id=eq.${id}`,{method:'PATCH',headers:H,body:JSON.stringify({crm_pushed_at:at,crm_pushed:true})});
    const i=allEntries.findIndex(x=>x.id===id);if(i!==-1)allEntries[i].crm_pushed_at=at;
    btn.outerHTML=`<div class="crm-badge">‚úì In DriveCentric</div>`;
    showMgrToast(`‚úì ${name} pushed to DriveCentric`,'green');
  }catch(err){btn.disabled=false;btn.innerHTML='<span>üöÄ</span> Push to CRM';showMgrToast('Failed to push ‚Äî check API setup');}
}

function showMgrToast(msg,type=''){const el=document.getElementById('mgr-toast');el.textContent=msg;el.className='mgr-toast show '+type;setTimeout(()=>el.className='mgr-toast',3000);}

// EDIT MODAL
async function openMgrEdit(id){
  const e=allEntries.find(x=>x.id===id);if(!e)return;
  const f={'mgr-edit-id':e.id,'mgr-first':e.first_name||'','mgr-last':e.last_name||'','mgr-phone':e.phone||'','mgr-email':e.email||'','mgr-contact-pref':e.contact_pref||'','mgr-best-time':e.best_time||'','mgr-year':e.veh_year||'','mgr-make':e.veh_make||'','mgr-model':e.veh_model||'','mgr-trim':e.veh_trim||'','mgr-miles':e.veh_miles||'','mgr-ro':e.ro_num||'','mgr-repair':e.repair_cost||'','mgr-advisor':e.svc_advisor||'','mgr-ownership':e.veh_ownership||'','mgr-trade-interest':e.trade_interest||'','mgr-trade-acv':e.trade_acv||'','mgr-trade-expect':e.trade_expect||'','mgr-voi':e.voi||'','mgr-budget':e.voi_budget||'','mgr-timeline':e.timeline||'','mgr-submitter':e.submitter||'','mgr-score':e.eng_score||'','mgr-outcome':e.outcome||'','mgr-emotion':e.cust_emotion||'','mgr-notes':e.notes||''};
  Object.entries(f).forEach(([id,v])=>{const el=document.getElementById(id);if(el)el.value=v;});
  document.getElementById('mgr-edit-modal').classList.add('open');
}
function closeMgrEdit(){document.getElementById('mgr-edit-modal').classList.remove('open');}
async function saveMgrEdit(){
  const id=parseInt(document.getElementById('mgr-edit-id').value);
  const p={first_name:document.getElementById('mgr-first').value,last_name:document.getElementById('mgr-last').value,phone:document.getElementById('mgr-phone').value,email:document.getElementById('mgr-email').value,contact_pref:document.getElementById('mgr-contact-pref').value,best_time:document.getElementById('mgr-best-time').value,veh_year:document.getElementById('mgr-year').value,veh_make:document.getElementById('mgr-make').value,veh_model:document.getElementById('mgr-model').value,veh_trim:document.getElementById('mgr-trim').value,veh_miles:document.getElementById('mgr-miles').value,ro_num:document.getElementById('mgr-ro').value,repair_cost:document.getElementById('mgr-repair').value,svc_advisor:document.getElementById('mgr-advisor').value,veh_ownership:document.getElementById('mgr-ownership').value,trade_interest:document.getElementById('mgr-trade-interest').value,trade_acv:document.getElementById('mgr-trade-acv').value,trade_expect:document.getElementById('mgr-trade-expect').value,voi:document.getElementById('mgr-voi').value,voi_budget:document.getElementById('mgr-budget').value,timeline:document.getElementById('mgr-timeline').value,submitter:document.getElementById('mgr-submitter').value,eng_score:document.getElementById('mgr-score').value,outcome:document.getElementById('mgr-outcome').value,cust_emotion:document.getElementById('mgr-emotion').value,notes:document.getElementById('mgr-notes').value};
  try{await fetch(`${SB_URL}/rest/v1/s2s_entries?id=eq.${id}`,{method:'PATCH',headers:H,body:JSON.stringify(p)});
    const i=allEntries.findIndex(e=>e.id===id);if(i!==-1)allEntries[i]={...allEntries[i],...p};
    closeMgrEdit();showMgrToast('‚úì Entry updated','green');renderKPIs();renderEntries();
  }catch{showMgrToast('Error saving ‚Äî check connection');}
}
async function deleteMgrEntry(){
  if(!confirm('Delete this entry permanently?'))return;
  const id=parseInt(document.getElementById('mgr-edit-id').value);
  try{await fetch(`${SB_URL}/rest/v1/s2s_entries?id=eq.${id}`,{method:'DELETE',headers:H});allEntries=allEntries.filter(e=>e.id!==id);closeMgrEdit();showMgrToast('Entry deleted');renderKPIs();renderEntries();}
  catch{showMgrToast('Error deleting');}
}
document.getElementById('mgr-edit-modal').addEventListener('click',function(e){if(e.target===this)closeMgrEdit();});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// VERIFY SALES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getUnverifiedSales(){
  return allEntries.filter(e=>isSold(e)&&!e.verified_sold&&!e.deleted_at&&!e.verification_rejected);
}

function renderVerifyQueue(){
  const unverified=getUnverifiedSales();
  const badge=document.getElementById('tab-verify-count');
  if(badge)badge.textContent=unverified.length;
  const queue=document.getElementById('verify-queue');
  if(!queue)return;
  document.getElementById('verify-showing-count').textContent=`${unverified.length} pending`;
  if(!unverified.length){queue.innerHTML='<div class="vq-empty"><div class="vq-empty-icon">‚úÖ</div><div class="vq-empty-text">All sales verified</div><div class="vq-empty-sub">No pending verifications at this time</div></div>';return;}
  queue.innerHTML=unverified.map(e=>{
    const name=`${e.first_name||''} ${e.last_name||''}`.trim()||'Unknown Customer';
    const veh=[e.veh_year,e.veh_make,e.veh_model].filter(Boolean).join(' ')||'Vehicle TBD';
    const date=e.created_at?new Date(e.created_at).toLocaleDateString('en-US',{month:'short',day:'numeric',hour:'numeric',minute:'2-digit'}):'‚Äî';
    const repair=e.repair_cost?'$'+e.repair_cost:'';
    return`<div class="vq-card" id="vq-card-${e.id}"><div class="vq-main"><div class="vq-info"><div class="vq-date">${date}</div><div class="vq-name">${name}</div><div class="vq-meta"><span>üöó ${veh}</span>${repair?`<span>üîß ${repair}</span>`:''}<span>üìä ${e.outcome||'‚Äî'}</span></div><div class="vq-rep">üë§ ${e.submitter||'Unknown'}</div></div><div class="vq-actions"><button class="vq-confirm" onclick="confirmSale(${e.id})">‚úÖ Confirm Sale</button><button class="vq-reject" onclick="openRejectPanel(${e.id})">‚ùå Reject</button></div></div><div class="vq-reject-panel" id="vq-reject-${e.id}"><div class="vq-reject-label">What's the correct outcome?</div><div class="vq-reject-grid"><button class="vq-reject-pill" onclick="selectRejectOutcome(this,${e.id},'Appointment Set')">üìÖ Appointment Set</button><button class="vq-reject-pill" onclick="selectRejectOutcome(this,${e.id},'Follow-Up Required')">üîî Follow-Up Required</button><button class="vq-reject-pill" onclick="selectRejectOutcome(this,${e.id},'Not Interested')">‚úó Not Interested</button><button class="vq-reject-pill" onclick="selectRejectOutcome(this,${e.id},'Working Deal')">ü§ù Working Deal</button><button class="vq-reject-pill" onclick="selectRejectOutcome(this,${e.id},'No Show')">üëª No Show</button></div><div style="margin-bottom:12px;"><div class="vq-reject-label">Rejection note (optional)</div><textarea class="vq-reject-textarea" id="vq-reject-note-${e.id}" placeholder="Why is this being rejected?"></textarea></div><button class="vq-reject-submit" id="vq-reject-submit-${e.id}" onclick="submitRejection(${e.id})" disabled>Submit Rejection</button></div></div>`;
  }).join('');
}

const rejectOutcomes={};

async function confirmSale(id){
  const verifier=currentRep?currentRep.name:'Manager';
  if(!confirm('Confirm this sale as verified?'))return;
  try{
    await fetch(`${SB_URL}/rest/v1/s2s_entries?id=eq.${id}`,{method:'PATCH',headers:H,body:JSON.stringify({verified_sold:true,verified_by:verifier,verified_at:new Date().toISOString()})});
    const i=allEntries.findIndex(e=>e.id===id);if(i!==-1){allEntries[i].verified_sold=true;allEntries[i].verified_by=verifier;allEntries[i].verified_at=new Date().toISOString();}
    showMgrToast('‚úÖ Sale verified','green');renderVerifyQueue();renderKPIs();renderEntries();
  }catch(e){showMgrToast('Error verifying sale');}
}

function openRejectPanel(id){const p=document.getElementById('vq-reject-'+id);if(p)p.classList.toggle('open');}

function selectRejectOutcome(el,id,outcome){
  el.closest('.vq-reject-grid').querySelectorAll('.vq-reject-pill').forEach(p=>p.classList.remove('sel'));
  el.classList.add('sel');rejectOutcomes[id]=outcome;
  const btn=document.getElementById('vq-reject-submit-'+id);if(btn)btn.disabled=false;
}

async function submitRejection(id){
  const newOutcome=rejectOutcomes[id];if(!newOutcome)return;
  const verifier=currentRep?currentRep.name:'Manager';
  const note=document.getElementById('vq-reject-note-'+id)?.value||'';
  const entry=allEntries.find(e=>e.id===id);
  const originalOutcome=entry?entry.outcome:'';
  try{
    await fetch(`${SB_URL}/rest/v1/s2s_entries?id=eq.${id}`,{method:'PATCH',headers:H,body:JSON.stringify({outcome:newOutcome,original_outcome:originalOutcome,verified_sold:false,verification_rejected:true,rejection_reason:`${verifier}: ${note||'Outcome corrected to '+newOutcome}`,verified_by:verifier,verified_at:new Date().toISOString()})});
    const i=allEntries.findIndex(e=>e.id===id);if(i!==-1){allEntries[i].outcome=newOutcome;allEntries[i].original_outcome=originalOutcome;allEntries[i].verified_sold=false;allEntries[i].verification_rejected=true;}
    delete rejectOutcomes[id];showMgrToast(`‚ùå Sale rejected ‚Üí ${newOutcome}`,'');renderVerifyQueue();renderKPIs();renderEntries();
  }catch(e){showMgrToast('Error rejecting sale');}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// REPORTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setRange(r){
  const now=new Date(),fmt=d=>d.toISOString().slice(0,10),start=d=>{const x=new Date(d);x.setHours(0,0,0,0);return x;};
  let from,to;
  if(r==='today'){from=start(now);to=now;}
  else if(r==='yesterday'){const y=new Date(now);y.setDate(y.getDate()-1);from=start(y);to=new Date(y);to.setHours(23,59,59);}
  else if(r==='week'){from=start(new Date(now.setDate(now.getDate()-now.getDay())));to=new Date();}
  else if(r==='month'){from=new Date(new Date().getFullYear(),new Date().getMonth(),1);to=new Date();}
  else if(r==='last30'){from=new Date(Date.now()-30*864e5);to=new Date();}
  else{from=new Date('2025-01-01');to=new Date();}
  document.getElementById('rpt-from').value=fmt(from);document.getElementById('rpt-to').value=fmt(to);runReport();
}

let rptS2S=[],rptExportData=[];
async function runReport(){
  const from=document.getElementById('rpt-from').value,to=document.getElementById('rpt-to').value;
  if(!from||!to){alert('Please select a date range.');return;}
  document.getElementById('rpt-empty').style.display='none';document.getElementById('rpt-output').style.display='none';
  let url=`${SB_URL}/rest/v1/s2s_entries?select=*&created_at=gte.${from}T00:00:00&created_at=lte.${to}T23:59:59&order=created_at.asc&limit=2000`;
  const rep=document.getElementById('rpt-rep').value;if(rep)url+=`&submitter=eq.${encodeURIComponent(rep)}`;
  const r=await fetch(url,{headers:{'apikey':SB_KEY,'Authorization':'Bearer '+(window.sbSession?.access_token||SB_KEY)}});rptS2S=await r.json();renderReport();
}

function renderReport(){
  if(!rptS2S.length){document.getElementById('rpt-empty').style.display='block';document.getElementById('rpt-empty').innerHTML='<div style="font-size:48px;margin-bottom:16px;opacity:0.4;">üì≠</div><div style="font-size:16px;font-weight:600;color:var(--muted);">No entries found for this date range</div>';return;}
  document.getElementById('rpt-output').style.display='block';
  const sold=rptS2S.filter(e=>(e.outcome||'').toLowerCase().includes('sold')).length;
  const demo=rptS2S.filter(e=>(e.outcome||'').includes('Demo')).length;
  const appt=rptS2S.filter(e=>(e.outcome||'').includes('Appointment')).length;
  const cr=rptS2S.length>0?Math.round(sold/rptS2S.length*100):0;
  document.getElementById('rpt-kpis').innerHTML=[{lbl:'S2S Entries',val:rptS2S.length,c:'#6366F1',sub:'in range'},{lbl:'Sold',val:sold,c:'#22C55E',sub:'closed'},{lbl:'Demos',val:demo,c:'#F59E0B',sub:'test drives'},{lbl:'Appointments',val:appt,c:'#60A5FA',sub:'set'},{lbl:'Close Rate',val:cr+'%',c:'#F97316',sub:'to sold'}].map(k=>`<div class="rpt-kpi-card" style="border-top-color:${k.c};"><div class="rpt-kpi-lbl">${k.lbl}</div><div class="rpt-kpi-val" style="color:${k.c};">${k.val}</div><div class="rpt-kpi-sub">${k.sub}</div></div>`).join('');
  const repC={},outC={};rptS2S.forEach(e=>{repC[e.submitter||'Unknown']=(repC[e.submitter||'Unknown']||0)+1;outC[e.outcome||'Unknown']=(outC[e.outcome||'Unknown']||0)+1;});
  renderBarChart('rpt-by-rep',repC,'#6366F1');renderBarChart('rpt-by-source',outC,'#F59E0B');
  const hot=rptS2S.filter(e=>parseInt(e.eng_score||0)>=8).length,warm=rptS2S.filter(e=>{const sc=parseInt(e.eng_score||0);return sc>=5&&sc<8;}).length,cool=rptS2S.filter(e=>parseInt(e.eng_score||0)<5).length;
  document.getElementById('rpt-mgr-inv').innerHTML=rBarRow('üî• Hot (8-10)',hot,rptS2S.length,'#EF4444')+rBarRow('üå° Warm (5-7)',warm,rptS2S.length,'#F59E0B')+rBarRow('‚ùÑ Cool (1-4)',cool,rptS2S.length,'#60A5FA');
  const byDay={};rptS2S.forEach(e=>{const d=e.created_at?e.created_at.slice(0,10):'Unknown';if(!byDay[d])byDay[d]={t:0,s:0};byDay[d].t++;if((e.outcome||'').toLowerCase().includes('sold'))byDay[d].s++;});
  const sorted=Object.entries(byDay).sort((a,b)=>b[0].localeCompare(a[0]));rptExportData=sorted;
  document.getElementById('rpt-daily-body').innerHTML=sorted.map(([date,d])=>{const cr=d.t>0?Math.round(d.s/d.t*100):0;const dl=new Date(date+'T12:00:00').toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'});return`<tr style="border-bottom:1px solid var(--border);"><td style="padding:8px 12px;font-size:12px;font-weight:600;">${dl}</td><td style="padding:8px 12px;text-align:center;font-family:'DM Mono',monospace;font-size:12px;font-weight:700;color:var(--purple2);">${d.t}</td><td style="padding:8px 12px;text-align:center;font-size:12px;font-weight:700;color:#4ADE80;">${d.s||'‚Äî'}</td><td style="padding:8px 12px;text-align:center;font-size:12px;font-weight:700;color:${cr>=20?'#4ADE80':cr>=10?'#F59E0B':'#FC8181'};">${cr}%</td></tr>`;}).join('');
}
function renderBarChart(id,counts,color){const sorted=Object.entries(counts).sort((a,b)=>b[1]-a[1]),max=sorted[0]?.[1]||1;document.getElementById(id).innerHTML=sorted.length?sorted.map(([l,c])=>rBarRow(l,c,max,color)).join(''):'<div style="color:var(--muted2);font-size:13px;">No data</div>';}
function rBarRow(label,count,max,color){return`<div class="rpt-row"><div class="rpt-label" title="${label}">${label}</div><div class="rpt-bar-wrap"><div class="rpt-bar" style="width:${Math.round(count/(max||1)*100)}%;background:${color};"></div></div><div class="rpt-count">${count}</div></div>`;}
function exportReportCSV(){if(!rptExportData.length)return alert('Run a report first.');const blob=new Blob([['Date,Total,Sold,CloseRate',...rptExportData.map(([d,v])=>[d,v.t,v.s,v.t>0?Math.round(v.s/v.t*100)+'%':'0%'].join(','))].join('\n')],{type:'text/csv'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='report.csv';a.click();}

// EXPORT
function toCSV(rows,headers){const esc=v=>{if(v==null)return'';const s=String(v).replace(/"/g,'""');return s.includes(',')||s.includes('"')||s.includes('\n')?`"${s}"`:s;};return[headers.join(','),...rows.map(r=>headers.map(h=>esc(r[h])).join(','))].join('\n');}
function exportS2SCSV(){if(!allEntries.length)return alert('No entries loaded yet.');const h=['id','submitter','first_name','last_name','phone','email','veh_year','veh_make','veh_model','repair_cost','eng_score','outcome','verified_sold','verified_by','followup_status','manager_outcome','manager_claimed_by','manager_notes','notes','created_at'];const blob=new Blob([toCSV(allEntries,h)],{type:'text/csv'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`s2s-entries-${new Date().toISOString().slice(0,10)}.csv`;a.click();}
function exportS2SPDF(){if(!allEntries.length)return alert('No entries loaded yet.');const date=new Date().toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'});const rows=allEntries.map(e=>`<tr><td>${e.submitter||'‚Äî'}</td><td>${e.first_name||''} ${e.last_name||''}</td><td>${e.phone||'‚Äî'}</td><td>${e.veh_year||''} ${e.veh_make||''} ${e.veh_model||''}</td><td>${e.repair_cost?'$'+e.repair_cost:'‚Äî'}</td><td style="text-align:center;font-weight:700;">${e.eng_score||'‚Äî'}</td><td>${e.outcome||'‚Äî'}</td><td>${e.verified_sold?'‚úÖ':'‚è≥'}</td><td>${e.created_at?new Date(e.created_at).toLocaleString('en-US',{month:'short',day:'numeric',hour:'numeric',minute:'2-digit'}):'‚Äî'}</td></tr>`).join('');const html=`<!DOCTYPE html><html><head><title>S2S Export</title><style>body{font-family:Arial,sans-serif;font-size:11px;padding:24px;}h1{font-size:18px;margin-bottom:4px;}.sub{color:#666;font-size:12px;margin-bottom:16px;}table{width:100%;border-collapse:collapse;}th{background:#1a1a2e;color:#fff;padding:8px 10px;text-align:left;font-size:10px;text-transform:uppercase;letter-spacing:0.08em;}td{padding:7px 10px;border-bottom:1px solid #eee;}tr:nth-child(even) td{background:#f9f9f9;}@media print{body{padding:0;}}</style></head><body><h1>ServiceBridge ‚Äî S2S Entries</h1><div class="sub">Gallatin CDJR ¬∑ Exported ${date} ¬∑ ${allEntries.length} entries</div><table><thead><tr><th>Rep</th><th>Customer</th><th>Phone</th><th>Vehicle</th><th>Repair $</th><th>Temp</th><th>Outcome</th><th>Verified</th><th>Date</th></tr></thead><tbody>${rows}</tbody></table></body></html>`;const w=window.open('','_blank');w.document.write(html);w.document.close();setTimeout(()=>w.print(),500);}

// AUTH-GATED INIT
(async function(){
  const{currentUser}=await SB_AUTH.init({requiredRole:'any'});
  _initDashNav(currentUser);
  _refreshH();
  await loadAll();
})();
</script>
</body>
</html>
