<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ServiceBridge ‚Äî Manager Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #07070E;
  --surface: #0F0F1A;
  --surface2: #161625;
  --surface3: #1C1C30;
  --border: rgba(255,255,255,0.07);
  --border2: rgba(255,255,255,0.13);
  --text: #EEE8FF;
  --muted: rgba(238,232,255,0.4);
  --muted2: rgba(238,232,255,0.22);
  --purple: #5B4FE8;
  --purple2: #7B72F0;
  --red: #C8102E;
  --green: #22C55E;
  --gold: #E8B84B;
  --orange: #F97316;
  --r: 12px;
}
* { margin:0; padding:0; box-sizing:border-box; }
body {
  background: var(--bg);
  color: var(--text);
  font-family: 'DM Sans', sans-serif;
  min-height: 100vh;
  -webkit-font-smoothing: antialiased;
}

/* BG */
.bg-orb1 { position:fixed; top:-200px; right:-150px; width:600px; height:600px; border-radius:50%; background:radial-gradient(circle,rgba(91,79,232,0.12) 0%,transparent 70%); pointer-events:none; z-index:0; }
.bg-orb2 { position:fixed; bottom:-200px; left:-100px; width:500px; height:500px; border-radius:50%; background:radial-gradient(circle,rgba(200,16,46,0.08) 0%,transparent 70%); pointer-events:none; z-index:0; }

/* NAV */
nav {
  position: sticky; top:0; z-index:100;
  background: rgba(7,7,14,0.92);
  backdrop-filter: blur(16px);
  border-bottom: 1px solid var(--border);
  padding: 0 28px;
  height: 58px;
  display: flex; align-items:center; justify-content:space-between;
}
nav::after { content:''; position:absolute; bottom:0; left:0; right:0; height:1px; background:linear-gradient(90deg,var(--purple),transparent,var(--red),transparent); }
.nav-brand { font-family:'Bebas Neue',sans-serif; font-size:22px; letter-spacing:0.06em; background:linear-gradient(90deg,#fff,rgba(255,255,255,0.6)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
.nav-right { display:flex; align-items:center; gap:16px; }
.nav-badge { font-size:11px; font-weight:600; padding:4px 12px; border-radius:20px; background:rgba(91,79,232,0.2); border:1px solid rgba(91,79,232,0.4); color:var(--purple2); }
.nav-link { font-size:12px; font-weight:600; color:var(--muted); text-decoration:none; padding:6px 12px; border-radius:7px; transition:all 0.18s; }
.nav-link:hover { color:var(--text); background:rgba(255,255,255,0.05); }
.refresh-btn { font-size:12px; font-weight:600; padding:7px 14px; border-radius:8px; background:rgba(255,255,255,0.06); border:1px solid var(--border2); color:var(--muted); cursor:pointer; transition:all 0.18s; font-family:'DM Sans',sans-serif; }
.refresh-btn:hover { color:var(--text); border-color:var(--border2); }

/* LAYOUT */
.page { max-width:1400px; margin:0 auto; padding:28px 28px 80px; position:relative; z-index:1; }

/* KPI ROW */
.kpi-grid { display:grid; grid-template-columns:repeat(6,1fr); gap:12px; margin-bottom:28px; }
.kpi-card {
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:var(--r);
  padding:18px 16px;
  position:relative; overflow:hidden;
  transition: transform 0.2s;
}
.kpi-card:hover { transform:translateY(-2px); }
.kpi-card::before { content:''; position:absolute; top:0; left:0; right:0; height:2px; }
.kpi-p::before { background:var(--purple); }
.kpi-r::before { background:var(--red); }
.kpi-g::before { background:var(--green); }
.kpi-o::before { background:var(--orange); }
.kpi-gold::before { background:var(--gold); }
.kpi-b::before { background:#38BDF8; }
.kpi-lbl { font-size:9px; font-weight:700; letter-spacing:0.16em; text-transform:uppercase; color:var(--muted2); margin-bottom:6px; }
.kpi-val { font-family:'Bebas Neue',sans-serif; font-size:40px; line-height:1; }
.kpi-p .kpi-val { color:var(--purple2); }
.kpi-r .kpi-val { color:#FC8181; }
.kpi-g .kpi-val { color:#4ADE80; }
.kpi-o .kpi-val { color:var(--orange); }
.kpi-gold .kpi-val { color:var(--gold); }
.kpi-b .kpi-val { color:#38BDF8; }
.kpi-sub { font-size:10px; color:var(--muted2); margin-top:2px; }

/* SECTION HEADER */
.section-hd {
  display:flex; align-items:center; justify-content:space-between;
  margin-bottom:14px;
}
.section-title {
  font-size:11px; font-weight:700;
  letter-spacing:0.16em; text-transform:uppercase;
  color:var(--muted);
  display:flex; align-items:center; gap:8px;
}
.section-title::before { content:''; display:inline-block; width:16px; height:2px; background:var(--purple); border-radius:2px; }
.section-count { font-size:11px; font-weight:600; color:var(--muted2); }

/* TABS */
.tabs { display:flex; gap:4px; margin-bottom:20px; background:var(--surface); border:1px solid var(--border); border-radius:10px; padding:4px; width:fit-content; }
.tab { padding:8px 18px; border-radius:7px; font-size:12px; font-weight:600; color:var(--muted); cursor:pointer; transition:all 0.18s; border:none; background:transparent; font-family:'DM Sans',sans-serif; display:flex; align-items:center; gap:6px; }
.tab.active { background:var(--surface3); color:var(--text); }
.tab-badge { font-size:10px; font-weight:700; padding:1px 7px; border-radius:10px; background:var(--red); color:#fff; }
.tab-badge.purple { background:var(--purple); }

/* ALERT BANNER */
.alert-banner {
  background: rgba(200,16,46,0.12);
  border: 1px solid rgba(200,16,46,0.3);
  border-radius:var(--r);
  padding:14px 18px;
  margin-bottom:16px;
  display:flex; align-items:center; gap:12px;
  animation: pulse-border 2s ease infinite;
}
@keyframes pulse-border {
  0%,100% { border-color:rgba(200,16,46,0.3); }
  50% { border-color:rgba(200,16,46,0.6); }
}
.alert-dot { width:10px; height:10px; border-radius:50%; background:var(--red); animation:pulse-dot 1.5s ease infinite; flex-shrink:0; }
@keyframes pulse-dot { 0%,100%{opacity:1;transform:scale(1);} 50%{opacity:0.5;transform:scale(0.8);} }
.alert-text { font-size:13px; font-weight:600; color:#FC8181; }
.alert-sub { font-size:11px; color:rgba(252,129,129,0.6); margin-top:1px; }

/* ENTRY CARDS */
.entries-list { display:flex; flex-direction:column; gap:10px; }

.entry-card {
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:16px;
  overflow:hidden;
  transition:all 0.2s;
}
.entry-card:hover { border-color:var(--border2); }
.entry-card.hot { border-color:rgba(200,16,46,0.35); background:rgba(200,16,46,0.04); }
.entry-card.aging { border-color:rgba(249,115,22,0.35); background:rgba(249,115,22,0.04); }
.entry-card.claimed { border-color:rgba(34,197,94,0.25); }

.entry-main {
  padding:18px 20px;
  display:grid;
  grid-template-columns:auto 1fr auto auto;
  gap:16px;
  align-items:start;
}

/* Temp badge */
.temp-badge {
  width:52px; height:52px; border-radius:12px;
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  flex-shrink:0;
  font-family:'Bebas Neue',sans-serif;
}
.temp-badge .temp-num { font-size:26px; line-height:1; }
.temp-badge .temp-lbl { font-size:8px; letter-spacing:0.1em; opacity:0.7; }
.temp-hot { background:rgba(200,16,46,0.2); border:1px solid rgba(200,16,46,0.4); color:#FC8181; }
.temp-warm { background:rgba(249,115,22,0.2); border:1px solid rgba(249,115,22,0.4); color:var(--orange); }
.temp-cool { background:rgba(91,79,232,0.15); border:1px solid rgba(91,79,232,0.3); color:var(--purple2); }

/* Entry info */
.entry-info {}
.entry-name { font-size:16px; font-weight:700; margin-bottom:3px; }
.entry-meta { font-size:12px; color:var(--muted); display:flex; flex-wrap:wrap; gap:12px; margin-bottom:6px; }
.entry-meta span { display:flex; align-items:center; gap:4px; }
.entry-tags { display:flex; flex-wrap:wrap; gap:6px; }
.entry-tag {
  font-size:10px; font-weight:600;
  padding:3px 10px; border-radius:20px;
  letter-spacing:0.04em;
}
.tag-outcome-sold { background:rgba(34,197,94,0.15); color:#4ADE80; border:1px solid rgba(34,197,94,0.2); }
.tag-outcome-appt { background:rgba(91,79,232,0.15); color:var(--purple2); border:1px solid rgba(91,79,232,0.2); }
.tag-outcome-follow { background:rgba(232,184,75,0.15); color:var(--gold); border:1px solid rgba(232,184,75,0.2); }
.tag-outcome-other { background:rgba(255,255,255,0.06); color:var(--muted); border:1px solid var(--border); }
.tag-followup { background:rgba(249,115,22,0.15); color:var(--orange); border:1px solid rgba(249,115,22,0.25); }
.tag-claimed { background:rgba(34,197,94,0.12); color:#4ADE80; border:1px solid rgba(34,197,94,0.2); }
.tag-pending { background:rgba(255,255,255,0.05); color:var(--muted); border:1px solid var(--border); }
.tag-hot { background:rgba(200,16,46,0.15); color:#FC8181; border:1px solid rgba(200,16,46,0.25); animation:pulse-dot 2s ease infinite; }

/* Entry right side */
.entry-right { display:flex; flex-direction:column; align-items:flex-end; gap:8px; flex-shrink:0; }
.entry-time { font-size:11px; color:var(--muted2); font-family:'DM Mono',monospace; }
.claim-btn {
  padding:8px 16px; border-radius:8px;
  font-size:12px; font-weight:700;
  background:linear-gradient(135deg,var(--purple),var(--purple2));
  color:#fff; border:none; cursor:pointer;
  font-family:'DM Sans',sans-serif;
  transition:all 0.18s;
  white-space:nowrap;
}
.claim-btn:hover { transform:translateY(-1px); box-shadow:0 4px 12px rgba(91,79,232,0.4); }
.claimed-by { font-size:11px; color:#4ADE80; font-weight:600; text-align:right; }

/* Expand panel */
.entry-expand {
  border-top:1px solid var(--border);
  padding:18px 20px;
  display:none;
  background:var(--surface2);
}
.entry-expand.open { display:block; }
.expand-grid { display:grid; grid-template-columns:1fr 1fr 1fr; gap:16px; margin-bottom:16px; }
.expand-section-title { font-size:10px; font-weight:700; letter-spacing:0.14em; text-transform:uppercase; color:var(--muted2); margin-bottom:10px; }
.expand-row { display:flex; justify-content:space-between; align-items:baseline; padding:5px 0; border-bottom:1px solid rgba(255,255,255,0.04); }
.expand-row:last-child { border-bottom:none; }
.expand-key { font-size:11px; color:var(--muted); }
.expand-val { font-size:12px; font-weight:600; color:var(--text); text-align:right; max-width:180px; word-break:break-word; }

/* Manager action panel */
.manager-panel {
  background:var(--surface3);
  border:1px solid var(--border2);
  border-radius:10px;
  padding:16px;
  margin-top:16px;
}
.manager-panel-title { font-size:10px; font-weight:700; letter-spacing:0.14em; text-transform:uppercase; color:var(--purple2); margin-bottom:12px; display:flex; align-items:center; gap:6px; }
.manager-fields { display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:12px; }
.field-group { display:flex; flex-direction:column; gap:6px; }
.field-label { font-size:10px; font-weight:600; letter-spacing:0.1em; text-transform:uppercase; color:var(--muted2); }
.field-select, .field-textarea, .field-input {
  background:var(--surface);
  border:1px solid var(--border2);
  border-radius:8px;
  color:var(--text);
  font-family:'DM Sans',sans-serif;
  font-size:13px;
  padding:9px 12px;
  width:100%;
  transition:border-color 0.18s;
}
.field-select:focus, .field-textarea:focus, .field-input:focus {
  outline:none; border-color:var(--purple);
}
.field-textarea { resize:vertical; min-height:70px; }
.field-select option { background:var(--surface2); }
.save-btn {
  padding:9px 20px; border-radius:8px;
  font-size:12px; font-weight:700;
  background:linear-gradient(135deg,var(--purple),var(--purple2));
  color:#fff; border:none; cursor:pointer;
  font-family:'DM Sans',sans-serif;
  transition:all 0.18s;
}
.save-btn:hover { transform:translateY(-1px); box-shadow:0 4px 12px rgba(91,79,232,0.4); }
.save-success { font-size:11px; color:#4ADE80; font-weight:600; margin-left:10px; opacity:0; transition:opacity 0.3s; }

/* Toggle expand btn */
.expand-toggle {
  width:100%; background:none; border:none;
  border-top:1px solid var(--border);
  color:var(--muted); font-size:11px; font-weight:600;
  padding:10px; cursor:pointer; font-family:'DM Sans',sans-serif;
  transition:all 0.18s; letter-spacing:0.04em;
  display:flex; align-items:center; justify-content:center; gap:6px;
}
.expand-toggle:hover { color:var(--text); background:rgba(255,255,255,0.03); }

/* SCORECARDS PAGE */
.score-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:16px; margin-bottom:28px; }
.score-card {
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:16px;
  overflow:hidden;
  transition:transform 0.2s;
}
.score-card:hover { transform:translateY(-3px); }
.score-card-header {
  padding:20px 20px 14px;
  display:flex; align-items:center; gap:12px;
  border-bottom:1px solid var(--border);
}
.score-avatar {
  width:44px; height:44px; border-radius:50%;
  background:linear-gradient(135deg,var(--purple),var(--purple2));
  display:flex; align-items:center; justify-content:center;
  font-size:14px; font-weight:700; color:#fff; flex-shrink:0;
}
.score-avatar.rank1 { background:linear-gradient(135deg,#E8B84B,#F59E0B); }
.score-avatar.rank2 { background:linear-gradient(135deg,#94A3B8,#64748B); }
.score-avatar.rank3 { background:linear-gradient(135deg,#C87B4B,#92400E); }
.score-name { font-size:15px; font-weight:700; }
.score-role { font-size:11px; color:var(--muted); }
.score-rank { margin-left:auto; font-family:'Bebas Neue',sans-serif; font-size:28px; color:var(--muted2); }
.score-rank.rank1 { color:var(--gold); }
.score-stats { padding:16px 20px; display:grid; grid-template-columns:1fr 1fr; gap:10px; }
.score-stat { text-align:center; }
.score-stat-val { font-family:'Bebas Neue',sans-serif; font-size:28px; line-height:1; }
.score-stat-lbl { font-size:9px; font-weight:600; letter-spacing:0.12em; text-transform:uppercase; color:var(--muted2); margin-top:2px; }
.score-bar-wrap { padding:0 20px 16px; }
.score-bar-label { display:flex; justify-content:space-between; font-size:10px; color:var(--muted2); margin-bottom:5px; }
.score-bar-track { height:4px; background:rgba(255,255,255,0.07); border-radius:2px; overflow:hidden; }
.score-bar-fill { height:100%; border-radius:2px; background:linear-gradient(90deg,var(--purple),var(--purple2)); transition:width 1s ease; }

/* LEADERBOARD TABLE */
.leaderboard {
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:16px;
  overflow:hidden;
}
.lb-header {
  display:grid;
  grid-template-columns:40px 1fr 80px 80px 80px 80px 100px;
  padding:12px 20px;
  background:var(--surface2);
  border-bottom:1px solid var(--border);
}
.lb-col-hd { font-size:9px; font-weight:700; letter-spacing:0.14em; text-transform:uppercase; color:var(--muted2); text-align:center; }
.lb-col-hd:nth-child(2) { text-align:left; }
.lb-row {
  display:grid;
  grid-template-columns:40px 1fr 80px 80px 80px 80px 100px;
  padding:14px 20px;
  border-bottom:1px solid var(--border);
  align-items:center;
  transition:background 0.15s;
}
.lb-row:last-child { border-bottom:none; }
.lb-row:hover { background:rgba(255,255,255,0.025); }
.lb-rank { font-family:'Bebas Neue',sans-serif; font-size:20px; color:var(--muted2); text-align:center; }
.lb-rank.r1 { color:var(--gold); }
.lb-rank.r2 { color:#94A3B8; }
.lb-rank.r3 { color:#C87B4B; }
.lb-name-cell { display:flex; align-items:center; gap:10px; }
.lb-avatar { width:32px; height:32px; border-radius:50%; background:linear-gradient(135deg,var(--purple),var(--purple2)); display:flex; align-items:center; justify-content:center; font-size:11px; font-weight:700; color:#fff; flex-shrink:0; }
.lb-name { font-size:13px; font-weight:600; }
.lb-role { font-size:10px; color:var(--muted); }
.lb-cell { text-align:center; font-size:13px; font-weight:600; }
.lb-cell.hot { color:#FC8181; }
.lb-cell.sold { color:#4ADE80; }
.lb-conv { text-align:center; }
.conv-pill { display:inline-block; padding:3px 10px; border-radius:20px; font-size:11px; font-weight:700; }
.conv-high { background:rgba(34,197,94,0.15); color:#4ADE80; }
.conv-mid { background:rgba(232,184,75,0.15); color:var(--gold); }
.conv-low { background:rgba(255,255,255,0.06); color:var(--muted); }

/* EMPTY */
.empty-state { text-align:center; padding:48px 24px; color:var(--muted); }
.empty-icon { font-size:36px; margin-bottom:12px; opacity:0.5; }
.empty-text { font-size:14px; }

/* LOADING */
.loading { text-align:center; padding:40px; color:var(--muted); }
.dots span { display:inline-block; width:7px; height:7px; border-radius:50%; background:var(--purple); margin:0 3px; animation:dotpulse 1.2s ease infinite; }
.dots span:nth-child(2){animation-delay:0.2s;} .dots span:nth-child(3){animation-delay:0.4s;}
@keyframes dotpulse{0%,100%{opacity:1;}50%{opacity:0.3;}}

@keyframes fadeUp { from{opacity:0;transform:translateY(12px);}to{opacity:1;transform:translateY(0);} }
.fade-in { animation:fadeUp 0.4s ease both; }

@media(max-width:1100px){ .kpi-grid{grid-template-columns:repeat(3,1fr);} .score-grid{grid-template-columns:repeat(2,1fr);} }
@media(max-width:768px){
  .page{padding:16px 16px 60px;}
  .kpi-grid{grid-template-columns:repeat(2,1fr);}
  .entry-main{grid-template-columns:auto 1fr; grid-template-rows:auto auto;}
  .entry-right{flex-direction:row; align-items:center; grid-column:1/-1;}
  .expand-grid{grid-template-columns:1fr;}
  .manager-fields{grid-template-columns:1fr;}
  .score-grid{grid-template-columns:1fr 1fr;}
  .lb-header,.lb-row{grid-template-columns:32px 1fr 60px 60px 70px;}
  .lb-col-hd:nth-child(4),.lb-cell.hot,.lb-col-hd:nth-child(6){display:none;}
}
</style>
</head>
<body>
<div class="bg-orb1"></div>
<div class="bg-orb2"></div>

<nav>
  <div style="display:flex;align-items:center;gap:16px;">
    <div class="nav-brand">ServiceBridge</div>
    <div class="nav-badge" id="live-badge">‚óè LIVE</div>
  </div>
  <div class="nav-right">
    <a href="login.html" class="nav-link">Rep Login</a>
    <a href="scorecards.html" class="nav-link">Scorecards</a>
    <a href="admin-panel.html" class="nav-link">Admin</a>
    <button class="refresh-btn" onclick="loadAll()">‚Üª Refresh</button>
  </div>
</nav>

<div class="page">

  <!-- KPIs -->
  <div class="kpi-grid fade-in" id="kpi-row">
    <div class="kpi-card kpi-p"><div class="kpi-lbl">Today's Entries</div><div class="kpi-val" id="kpi-today">‚Äî</div></div>
    <div class="kpi-card kpi-r"><div class="kpi-lbl">Hot Leads</div><div class="kpi-val" id="kpi-hot">‚Äî</div><div class="kpi-sub">Score 8-10</div></div>
    <div class="kpi-card kpi-g"><div class="kpi-lbl">Sold Today</div><div class="kpi-val" id="kpi-sold">‚Äî</div></div>
    <div class="kpi-card kpi-o"><div class="kpi-lbl">Unclaimed</div><div class="kpi-val" id="kpi-unclaimed">‚Äî</div><div class="kpi-sub">Hot leads</div></div>
    <div class="kpi-card kpi-gold"><div class="kpi-lbl">Avg Temp</div><div class="kpi-val" id="kpi-avg">‚Äî</div><div class="kpi-sub">Today</div></div>
    <div class="kpi-card kpi-b"><div class="kpi-lbl">Follow-Up Due</div><div class="kpi-val" id="kpi-followup">‚Äî</div><div class="kpi-sub">No contact 24h+</div></div>
  </div>

  <!-- Hot lead alert banner -->
  <div id="hot-banner" style="display:none;" class="alert-banner fade-in">
    <div class="alert-dot"></div>
    <div>
      <div class="alert-text" id="hot-banner-text">üî• Unclaimed hot leads need attention</div>
      <div class="alert-sub">Claim and action these leads before they leave the lot</div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab active" onclick="switchTab('all',this)">All Entries <span class="tab-badge purple" id="tab-all-count">0</span></button>
    <button class="tab" onclick="switchTab('hot',this)">üî• Hot Leads <span class="tab-badge" id="tab-hot-count">0</span></button>
    <button class="tab" onclick="switchTab('aging',this)">‚ö†Ô∏è Needs Follow-Up <span class="tab-badge" id="tab-aging-count">0</span></button>
    <button class="tab" onclick="switchTab('unclaimed',this)">Unclaimed <span class="tab-badge" id="tab-unclaimed-count">0</span></button>
  </div>

  <div class="section-hd">
    <div class="section-title">S2S Entries</div>
    <div class="section-count" id="showing-count"></div>
  </div>

  <div class="entries-list fade-in" id="entries-list">
    <div class="loading"><div class="dots"><span></span><span></span><span></span></div></div>
  </div>

</div>

<script>
const SB_URL = 'https://jbkgwtohwsbaorhvuuqb.supabase.co';
const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impia2d3dG9od3NiYW9yaHZ1dXFiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5NjkwNDIsImV4cCI6MjA4NzU0NTA0Mn0.GRXOYbIuVDxU9-FEBYmyd1QmytVUrMIAxbnOSfepzuU';
const H = { 'apikey': SB_KEY, 'Authorization': 'Bearer ' + SB_KEY, 'Content-Type': 'application/json' };

let allEntries = [];
let currentTab = 'all';
const MANAGER = 'Manager'; // could be dynamic

async function loadAll() {
  try {
    const res = await fetch(`${SB_URL}/rest/v1/s2s_entries?select=*&order=id.desc&limit=200`, { headers: H });
    allEntries = await res.json();
    renderKPIs();
    renderEntries();
  } catch(e) {
    document.getElementById('entries-list').innerHTML = '<div class="empty-state"><div class="empty-icon">‚ö†Ô∏è</div><div class="empty-text">Failed to load. Check connection.</div></div>';
  }
}

function isHot(e) { return parseInt(e.eng_score) >= 8; }
function isAging(e) {
  if (!e.created_at) return false;
  const hrs = (Date.now() - new Date(e.created_at)) / 36e5;
  return hrs >= 24 && (!e.followup_status || e.followup_status === 'Pending') && !e.manager_claimed_by;
}
function isUnclaimed(e) { return isHot(e) && !e.manager_claimed_by; }

function renderKPIs() {
  const today = allEntries.filter(e => {
    const d = new Date(e.created_at);
    const now = new Date();
    return d.toDateString() === now.toDateString();
  });
  const hot = allEntries.filter(isHot);
  const unclaimed = allEntries.filter(isUnclaimed);
  const aging = allEntries.filter(isAging);
  const sold = today.filter(e => e.outcome && (e.outcome.includes('New') || e.outcome.includes('Used') || e.outcome.toLowerCase().includes('sold')));
  const temps = today.filter(e => e.eng_score).map(e => parseInt(e.eng_score));
  const avg = temps.length ? (temps.reduce((a,b)=>a+b,0)/temps.length).toFixed(1) : '‚Äî';

  document.getElementById('kpi-today').textContent = today.length;
  document.getElementById('kpi-hot').textContent = hot.length;
  document.getElementById('kpi-sold').textContent = sold.length;
  document.getElementById('kpi-unclaimed').textContent = unclaimed.length;
  document.getElementById('kpi-avg').textContent = avg;
  document.getElementById('kpi-followup').textContent = aging.length;

  document.getElementById('tab-all-count').textContent = allEntries.length;
  document.getElementById('tab-hot-count').textContent = hot.length;
  document.getElementById('tab-aging-count').textContent = aging.length;
  document.getElementById('tab-unclaimed-count').textContent = unclaimed.length;

  const banner = document.getElementById('hot-banner');
  if (unclaimed.length > 0) {
    banner.style.display = 'flex';
    document.getElementById('hot-banner-text').textContent = `üî• ${unclaimed.length} unclaimed hot lead${unclaimed.length>1?'s':''} need immediate attention`;
  } else {
    banner.style.display = 'none';
  }
}

function switchTab(tab, el) {
  currentTab = tab;
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  renderEntries();
}

function renderEntries() {
  let filtered = allEntries;
  if (currentTab === 'hot') filtered = allEntries.filter(isHot);
  else if (currentTab === 'aging') filtered = allEntries.filter(isAging);
  else if (currentTab === 'unclaimed') filtered = allEntries.filter(isUnclaimed);

  document.getElementById('showing-count').textContent = `${filtered.length} entries`;
  const list = document.getElementById('entries-list');

  if (!filtered.length) {
    list.innerHTML = '<div class="empty-state"><div class="empty-icon">‚úÖ</div><div class="empty-text">No entries in this view.</div></div>';
    return;
  }

  list.innerHTML = filtered.map(e => buildEntryCard(e)).join('');
}

function tempClass(score) {
  const s = parseInt(score);
  if (s >= 8) return 'temp-hot';
  if (s >= 5) return 'temp-warm';
  return 'temp-cool';
}

function outcomeTag(outcome) {
  if (!outcome) return `<span class="entry-tag tag-outcome-other">‚Äî</span>`;
  if (outcome.includes('New') || outcome.includes('Used') || outcome.toLowerCase().includes('sold')) return `<span class="entry-tag tag-outcome-sold">‚úì ${outcome}</span>`;
  if (outcome.includes('Appt') || outcome.includes('Appointment')) return `<span class="entry-tag tag-outcome-appt">üìÖ ${outcome}</span>`;
  if (outcome.includes('Follow')) return `<span class="entry-tag tag-outcome-follow">‚Ü© ${outcome}</span>`;
  return `<span class="entry-tag tag-outcome-other">${outcome}</span>`;
}

function followupTag(e) {
  const status = e.followup_status || 'Pending';
  if (status === 'Pending') return `<span class="entry-tag tag-pending">‚è≥ Follow-Up Pending</span>`;
  if (status === 'Closed') return `<span class="entry-tag tag-claimed">‚úì Closed</span>`;
  return `<span class="entry-tag tag-followup">‚Ü© ${status}</span>`;
}

function buildEntryCard(e) {
  const score = parseInt(e.eng_score) || 0;
  const hot = score >= 8;
  const aging = isAging(e);
  const claimed = !!e.manager_claimed_by;
  const cardClass = hot ? 'hot' : aging ? 'aging' : claimed ? 'claimed' : '';

  const timeStr = e.timestamp || (e.created_at ? new Date(e.created_at).toLocaleString('en-US',{month:'short',day:'numeric',hour:'numeric',minute:'2-digit'}) : '‚Äî');

  return `<div class="entry-card ${cardClass}" id="card-${e.id}">
    <div class="entry-main">
      <div class="temp-badge ${tempClass(score)}">
        <div class="temp-num">${score || '‚Äî'}</div>
        <div class="temp-lbl">TEMP</div>
      </div>
      <div class="entry-info">
        <div class="entry-name">${e.first_name||''} ${e.last_name||''}</div>
        <div class="entry-meta">
          <span>üë§ ${e.submitter||'Unknown'}</span>
          ${e.veh_year||e.veh_make ? `<span>üöó ${e.veh_year||''} ${e.veh_make||''} ${e.veh_model||''}</span>` : ''}
          ${e.repair_cost ? `<span>üîß $${e.repair_cost}</span>` : ''}
          ${e.phone ? `<span>üìû ${e.phone}</span>` : ''}
        </div>
        <div class="entry-tags">
          ${outcomeTag(e.outcome)}
          ${followupTag(e)}
          ${hot ? '<span class="entry-tag tag-hot">üî• HOT LEAD</span>' : ''}
          ${claimed ? `<span class="entry-tag tag-claimed">‚úì Claimed: ${e.manager_claimed_by}</span>` : ''}
          ${aging ? '<span class="entry-tag tag-followup">‚ö†Ô∏è 24h No Contact</span>' : ''}
        </div>
      </div>
      <div class="entry-right">
        <div class="entry-time">${timeStr}</div>
        ${!claimed && hot ? `<button class="claim-btn" onclick="claimLead(${e.id})">‚ö° Claim Lead</button>` : ''}
        ${claimed ? `<div class="claimed-by">‚úì ${e.manager_claimed_by}</div>` : ''}
      </div>
    </div>
    <button class="expand-toggle" onclick="toggleExpand(${e.id}, this)">
      <span>‚ñº</span> View Details & Action
    </button>
    <div class="entry-expand" id="expand-${e.id}">
      <div class="expand-grid">
        <div>
          <div class="expand-section-title">Customer</div>
          ${expandRow('Phone', e.phone)} ${expandRow('Email', e.email)} ${expandRow('Contact Pref', e.contact_pref)} ${expandRow('Best Time', e.best_time)} ${expandRow('Emotion', e.cust_emotion)}
        </div>
        <div>
          <div class="expand-section-title">Vehicle & Service</div>
          ${expandRow('Vehicle', [e.veh_year,e.veh_make,e.veh_model,e.veh_trim].filter(Boolean).join(' '))}
          ${expandRow('Mileage', e.veh_miles)} ${expandRow('Ownership', e.veh_ownership)} ${expandRow('RO #', e.ro_num)} ${expandRow('Advisor', e.svc_advisor)} ${expandRow('Repair Cost', e.repair_cost ? '$'+e.repair_cost : null)} ${expandRow('Repair Ratio', e.repair_ratio)}
        </div>
        <div>
          <div class="expand-section-title">Trade & Finance</div>
          ${expandRow('Trade Interest', e.trade_interest)} ${expandRow('Trade ACV', e.trade_acv ? '$'+e.trade_acv : null)} ${expandRow('Expected', e.trade_expect ? '$'+e.trade_expect : null)} ${expandRow('Equity', e.trade_equity)} ${expandRow('VOI', e.voi)} ${expandRow('Budget', e.voi_budget)} ${expandRow('Timeline', e.timeline)} ${expandRow('Finance Conv', e.finance_conv)}
        </div>
      </div>
      ${e.notes ? `<div style="background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:14px;font-size:13px;color:var(--muted);"><strong style="color:var(--text);">Rep Notes:</strong> ${e.notes}</div>` : ''}
      <div class="manager-panel">
        <div class="manager-panel-title">‚ö° Manager Action</div>
        <div class="manager-fields">
          <div class="field-group">
            <div class="field-label">Follow-Up Status</div>
            <select class="field-select" id="fs-${e.id}">
              ${['Pending','Called','Left VM','Texted','Came Back In','Appointment Set','No Contact','Closed'].map(s=>`<option value="${s}" ${(e.followup_status||'Pending')===s?'selected':''}>${s}</option>`).join('')}
            </select>
          </div>
          <div class="field-group">
            <div class="field-label">Manager Outcome</div>
            <select class="field-select" id="mo-${e.id}">
              ${['','Sold New','Sold Used','Appointment Set','Working Deal','Not Interested','Needs Follow-Up','No Show'].map(s=>`<option value="${s}" ${(e.manager_outcome||'')===s?'selected':''}>${s||'‚Äî Select ‚Äî'}</option>`).join('')}
            </select>
          </div>
        </div>
        <div class="field-group" style="margin-bottom:12px;">
          <div class="field-label">Coaching / Action Notes</div>
          <textarea class="field-textarea" id="mn-${e.id}" placeholder="What action was taken? Who worked this customer? Any coaching notes...">${e.manager_notes||''}</textarea>
        </div>
        <div style="display:flex;align-items:center;gap:12px;">
          <button class="save-btn" onclick="saveAction(${e.id})">Save Action</button>
          <span class="save-success" id="saved-${e.id}">‚úì Saved</span>
          ${e.manager_claimed_by ? `<span style="font-size:11px;color:var(--muted);">Claimed by ${e.manager_claimed_by} ¬∑ ${e.manager_claimed_at||''}</span>` : ''}
        </div>
      </div>
    </div>
  </div>`;
}

function expandRow(key, val) {
  if (!val || val.trim() === '') return '';
  return `<div class="expand-row"><span class="expand-key">${key}</span><span class="expand-val">${val}</span></div>`;
}

function toggleExpand(id, btn) {
  const panel = document.getElementById('expand-'+id);
  const open = panel.classList.contains('open');
  panel.classList.toggle('open');
  btn.querySelector('span').textContent = open ? '‚ñº' : '‚ñ≤';
}

async function claimLead(id) {
  const claimedAt = new Date().toLocaleString('en-US',{month:'short',day:'numeric',hour:'numeric',minute:'2-digit'});
  const managerName = prompt('Your name (claiming this lead):','Manager') || 'Manager';
  try {
    await fetch(`${SB_URL}/rest/v1/s2s_entries?id=eq.${id}`, {
      method: 'PATCH',
      headers: H,
      body: JSON.stringify({ manager_claimed_by: managerName, manager_claimed_at: claimedAt, followup_status: 'Called' })
    });
    await loadAll();
  } catch(e) { alert('Error claiming lead'); }
}

async function saveAction(id) {
  const followup_status = document.getElementById('fs-'+id)?.value;
  const manager_outcome = document.getElementById('mo-'+id)?.value;
  const manager_notes = document.getElementById('mn-'+id)?.value;
  try {
    await fetch(`${SB_URL}/rest/v1/s2s_entries?id=eq.${id}`, {
      method: 'PATCH',
      headers: H,
      body: JSON.stringify({ followup_status, manager_outcome, manager_notes })
    });
    const saved = document.getElementById('saved-'+id);
    saved.style.opacity = '1';
    setTimeout(() => { saved.style.opacity = '0'; }, 2500);
    // Update local data
    const idx = allEntries.findIndex(e => e.id === id);
    if (idx !== -1) { allEntries[idx].followup_status = followup_status; allEntries[idx].manager_outcome = manager_outcome; allEntries[idx].manager_notes = manager_notes; }
    renderKPIs();
  } catch(e) { alert('Error saving'); }
}

loadAll();
setInterval(loadAll, 60000);
</script>
</body>
</html>
