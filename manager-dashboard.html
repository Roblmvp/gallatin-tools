<!DOCTYPE html>
<html lang="en">
<head>
<script>
(function(){
  var rep = null;
  try { rep = JSON.parse(sessionStorage.getItem('sb_rep') || 'null'); } catch(e) {}
  if (!rep || !rep.name || !rep.role) { window.location.replace('/login.html'); }
})();
</script>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#06080E">
<title>Dashboard ‚Äî ServiceBridge</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Instrument+Serif:ital@0;1&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #06080E; --bg2: #0C0F18;
  --surface: #111520; --surface2: #171C2A; --surface3: #1D2333;
  --red: #E01B36; --red-soft: rgba(224,27,54,0.10);
  --gold: #D4A73A; --gold-soft: rgba(212,167,58,0.10);
  --green: #2DD4A0; --green-soft: rgba(45,212,160,0.10);
  --blue: #6C70F0; --blue-soft: rgba(108,112,240,0.10);
  --orange: #F59E0B; --orange-soft: rgba(245,158,11,0.10);
  --purple: #A855F7;
  --text: #EDEEF2; --text2: rgba(237,238,242,0.62); --text3: rgba(237,238,242,0.34);
  --border: rgba(255,255,255,0.06); --border2: rgba(255,255,255,0.10); --border3: rgba(255,255,255,0.16);
  --r: 14px; --rsm: 10px; --rlg: 18px;
  --spring: cubic-bezier(0.16, 1, 0.3, 1);
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
html{scroll-behavior:smooth;}
body{background:var(--bg);color:var(--text);font-family:'Plus Jakarta Sans',-apple-system,sans-serif;min-height:100vh;overflow-x:hidden;-webkit-font-smoothing:antialiased;font-size:15px;line-height:1.5;letter-spacing:-0.01em;}
.bg-noise{position:fixed;inset:0;z-index:0;pointer-events:none;opacity:0.35;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E");}
.bg-grad{position:fixed;inset:0;z-index:0;pointer-events:none;background:radial-gradient(ellipse 60% 50% at 20% 0%,rgba(224,27,54,0.06) 0%,transparent 70%),radial-gradient(ellipse 50% 60% at 80% 100%,rgba(108,112,240,0.04) 0%,transparent 70%);}

/* Header */
.hdr{display:flex;align-items:center;justify-content:space-between;padding:14px 20px 12px;padding-top:max(14px,env(safe-area-inset-top));border-bottom:1px solid var(--border);background:rgba(6,8,14,0.92);backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);position:sticky;top:0;z-index:200;}
.hdr::after{content:'';position:absolute;bottom:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--red),var(--blue),transparent);opacity:0.4;}
.hdr-l{display:flex;align-items:center;gap:10px;}
.hdr-logo{width:30px;height:30px;background:var(--red);border-radius:8px;display:flex;align-items:center;justify-content:center;}
.hdr-logo svg{width:14px;height:14px;}
.hdr-t{font-family:'Instrument Serif',Georgia,serif;font-size:17px;letter-spacing:-0.01em;}
.hdr-r{display:flex;align-items:center;gap:8px;position:relative;}
.live{font-size:10px;font-weight:700;padding:4px 10px;border-radius:20px;background:var(--green-soft);border:1px solid rgba(45,212,160,0.25);color:var(--green);letter-spacing:0.06em;display:flex;align-items:center;gap:5px;}
.live-dot{width:6px;height:6px;border-radius:50%;background:var(--green);animation:pulse 2s ease infinite;}
@keyframes pulse{0%,100%{opacity:1;}50%{opacity:0.4;}}
.hdr-user{font-size:11px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:0.1em;}
.ham{background:none;border:1px solid var(--border2);border-radius:8px;width:32px;height:32px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;cursor:pointer;transition:all 0.18s;padding:0;flex-shrink:0;}
.ham:hover{border-color:rgba(255,255,255,0.18);background:rgba(255,255,255,0.03);}
.ham span{display:block;width:14px;height:1.5px;background:rgba(255,255,255,0.55);border-radius:2px;transition:all 0.2s;}
.ham.open span:nth-child(1){transform:translateY(5.5px) rotate(45deg);}
.ham.open span:nth-child(2){opacity:0;}
.ham.open span:nth-child(3){transform:translateY(-5.5px) rotate(-45deg);}
.nav-ov{position:fixed;inset:0;z-index:190;display:none;}
.nav-ov.open{display:block;}
.nav-dd{position:absolute;top:calc(100% + 8px);right:0;background:var(--surface);border:1px solid var(--border2);border-radius:var(--r);min-width:230px;padding:6px;box-shadow:0 20px 60px rgba(0,0,0,0.6);z-index:201;opacity:0;transform:translateY(-8px) scale(0.97);pointer-events:none;transition:all 0.18s var(--spring);}
.nav-dd.open{opacity:1;transform:translateY(0) scale(1);pointer-events:all;}
.di{display:flex;align-items:center;gap:10px;padding:11px 14px;border-radius:var(--rsm);font-size:13px;font-weight:600;color:var(--text2);text-decoration:none;cursor:pointer;transition:all 0.15s;}
.di:hover{background:rgba(255,255,255,0.04);color:var(--text);}
.di.ap{background:var(--red-soft);color:#F87171;}
.di-ic{font-size:14px;width:20px;text-align:center;}
.ddv{height:1px;background:var(--border);margin:4px 0;}
.dd-admin{display:none;}
.dd-admin.show{display:flex;}
.ddv.dd-admin.show{display:block;}
.nui{display:flex;align-items:center;justify-content:space-between;padding:8px 14px 4px;}
.nud{font-size:11px;font-weight:700;color:var(--text3);letter-spacing:0.08em;}
.nrp{font-size:9px;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;padding:3px 8px;border-radius:20px;}
.r-admin{background:var(--blue-soft);color:var(--blue);border:1px solid rgba(108,112,240,0.2);}
.r-manager{background:var(--gold-soft);color:var(--gold);border:1px solid rgba(212,167,58,0.2);}
.r-sales{background:rgba(255,255,255,0.05);color:var(--text2);border:1px solid rgba(255,255,255,0.08);}

/* Page */
.page{max-width:1200px;margin:0 auto;padding:22px 20px 80px;position:relative;z-index:1;}

/* KPI row */
.kpis{display:grid;grid-template-columns:repeat(6,1fr);gap:10px;margin-bottom:18px;}
.kpi{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:15px 14px;position:relative;overflow:hidden;transition:transform 0.2s var(--spring);}
.kpi:hover{transform:translateY(-2px);}
.kpi::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;}
.kb::before{background:var(--blue);}.kr::before{background:var(--red);}.kg::before{background:var(--green);}
.ko::before{background:var(--orange);}.kd::before{background:var(--gold);}.kp::before{background:var(--purple);}
.kpi-l{font-size:9px;font-weight:700;letter-spacing:0.12em;text-transform:uppercase;color:var(--text3);margin-bottom:5px;}
.kpi-v{font-family:'Instrument Serif',Georgia,serif;font-size:34px;line-height:1;}
.kb .kpi-v{color:var(--blue);}.kr .kpi-v{color:#F87171;}.kg .kpi-v{color:var(--green);}
.ko .kpi-v{color:var(--orange);}.kd .kpi-v{color:var(--gold);}.kp .kpi-v{color:var(--purple);}

/* Alert banner */
.alert-banner{background:var(--red-soft);border:1px solid rgba(224,27,54,0.25);border-radius:var(--r);padding:14px 18px;margin-bottom:14px;display:none;align-items:center;gap:12px;animation:pBorder 2s ease infinite;}
@keyframes pBorder{0%,100%{border-color:rgba(224,27,54,0.25);}50%{border-color:rgba(224,27,54,0.5);}}
.a-dot{width:10px;height:10px;border-radius:50%;background:var(--red);animation:pulse 1.5s ease infinite;flex-shrink:0;}
.a-txt{font-size:13px;font-weight:700;color:#F87171;}
.a-sub{font-size:11px;color:rgba(248,113,113,0.6);margin-top:1px;}

/* Tabs */
.tabs{display:flex;gap:4px;margin-bottom:14px;background:var(--surface);border:1px solid var(--border);border-radius:var(--rsm);padding:4px;width:fit-content;overflow-x:auto;}
.tb{padding:8px 14px;border-radius:7px;font-size:12px;font-weight:700;color:var(--text3);cursor:pointer;transition:all 0.18s;border:none;background:transparent;font-family:'Plus Jakarta Sans',sans-serif;display:flex;align-items:center;gap:6px;white-space:nowrap;}
.tb.ac{background:var(--surface3);color:var(--text);}
.tb-badge{font-size:10px;font-weight:700;padding:1px 7px;border-radius:10px;background:var(--red);color:#fff;}

/* Export */
.exp-bar{display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap;}
.exp{display:inline-flex;align-items:center;gap:6px;padding:8px 14px;border-radius:var(--rsm);font-size:12px;font-weight:700;cursor:pointer;border:none;font-family:'Plus Jakarta Sans',sans-serif;transition:all 0.18s;}
.exp-csv{background:var(--green-soft);border:1px solid rgba(45,212,160,0.2);color:var(--green);}
.exp-csv:hover{background:rgba(45,212,160,0.18);}
.exp-pdf{background:var(--red-soft);border:1px solid rgba(224,27,54,0.2);color:#F87171;}
.exp-pdf:hover{background:rgba(224,27,54,0.18);}

.sh{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;}
.sh-t{font-size:10px;font-weight:700;letter-spacing:0.14em;text-transform:uppercase;color:var(--text3);}
.sh-c{font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--text3);}

/* Entry cards */
.el{display:flex;flex-direction:column;gap:8px;}
.ec{background:var(--surface);border:1px solid var(--border);border-radius:16px;overflow:hidden;transition:all 0.2s;}
.ec:hover{border-color:var(--border2);}
.ec.hot{border-color:rgba(224,27,54,0.3);background:rgba(224,27,54,0.03);}
.ec.aging{border-color:rgba(245,158,11,0.3);background:rgba(245,158,11,0.03);}
.em{padding:14px 16px;display:grid;grid-template-columns:auto 1fr auto;gap:12px;align-items:start;}
.tb2{width:46px;height:46px;border-radius:12px;display:flex;flex-direction:column;align-items:center;justify-content:center;flex-shrink:0;font-family:'JetBrains Mono',monospace;}
.tb2 .tn{font-size:20px;font-weight:700;line-height:1;}
.tb2 .tl{font-size:8px;font-weight:600;letter-spacing:0.06em;opacity:0.7;}
.t-hot{background:var(--red-soft);border:1px solid rgba(224,27,54,0.3);color:#F87171;}
.t-warm{background:var(--orange-soft);border:1px solid rgba(245,158,11,0.3);color:var(--orange);}
.t-cool{background:var(--blue-soft);border:1px solid rgba(108,112,240,0.3);color:var(--blue);}
.en{font-size:15px;font-weight:700;margin-bottom:3px;}
.emeta{font-size:12px;color:var(--text3);display:flex;flex-wrap:wrap;gap:8px;margin-bottom:5px;}
.emeta span{display:flex;align-items:center;gap:3px;}
.etags{display:flex;flex-wrap:wrap;gap:5px;}
.et{font-size:10px;font-weight:700;padding:3px 10px;border-radius:20px;letter-spacing:0.03em;}
.et-sold{background:var(--green-soft);color:var(--green);border:1px solid rgba(45,212,160,0.2);}
.et-appt{background:var(--blue-soft);color:var(--blue);border:1px solid rgba(108,112,240,0.2);}
.et-follow{background:var(--gold-soft);color:var(--gold);border:1px solid rgba(212,167,58,0.2);}
.et-other{background:rgba(255,255,255,0.04);color:var(--text3);border:1px solid var(--border);}
.et-hot{background:var(--red-soft);color:#F87171;border:1px solid rgba(224,27,54,0.2);animation:pulse 2s ease infinite;}
.et-claimed{background:var(--green-soft);color:var(--green);border:1px solid rgba(45,212,160,0.2);}
.et-aging{background:var(--orange-soft);color:var(--orange);border:1px solid rgba(245,158,11,0.2);}
.eright{display:flex;flex-direction:column;align-items:flex-end;gap:5px;flex-shrink:0;}
.etime{font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--text3);}
.cbtn{padding:6px 13px;border-radius:8px;font-size:11px;font-weight:700;background:var(--blue);color:#fff;border:none;cursor:pointer;font-family:'Plus Jakarta Sans',sans-serif;transition:all 0.18s;white-space:nowrap;}
.cbtn:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(108,112,240,0.3);}
.clby{font-size:11px;color:var(--green);font-weight:600;text-align:right;}
.ebtn{padding:5px 11px;border-radius:8px;font-size:11px;font-weight:700;background:var(--blue-soft);border:1px solid rgba(108,112,240,0.2);color:var(--blue);cursor:pointer;font-family:'Plus Jakarta Sans',sans-serif;transition:all 0.18s;white-space:nowrap;}
.ebtn:hover{background:rgba(108,112,240,0.18);}
.crm{padding:5px 11px;border-radius:8px;font-size:11px;font-weight:700;background:var(--green-soft);border:1px solid rgba(45,212,160,0.2);color:var(--green);cursor:pointer;font-family:'Plus Jakarta Sans',sans-serif;transition:all 0.18s;white-space:nowrap;}
.crm:hover{background:rgba(45,212,160,0.18);}
.crm:disabled{opacity:0.4;pointer-events:none;}
.crm-ok{font-size:9px;font-weight:700;padding:2px 7px;border-radius:10px;background:var(--green-soft);color:var(--green);border:1px solid rgba(45,212,160,0.2);white-space:nowrap;}

/* Expand toggle */
.ext{width:100%;background:none;border:none;border-top:1px solid var(--border);color:var(--text3);font-size:11px;font-weight:600;padding:9px;cursor:pointer;font-family:'Plus Jakarta Sans',sans-serif;transition:all 0.18s;display:flex;align-items:center;justify-content:center;gap:5px;}
.ext:hover{color:var(--text);background:rgba(255,255,255,0.02);}
.ee{border-top:1px solid var(--border);padding:16px;display:none;background:var(--surface2);}
.ee.open{display:block;}
.eg{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px;margin-bottom:12px;}
.est{font-size:9px;font-weight:700;letter-spacing:0.12em;text-transform:uppercase;color:var(--text3);margin-bottom:8px;}
.er{display:flex;justify-content:space-between;align-items:baseline;padding:3px 0;border-bottom:1px solid var(--border);}
.er:last-child{border-bottom:none;}
.erk{font-size:11px;color:var(--text3);}
.erv{font-size:12px;font-weight:600;color:var(--text);text-align:right;max-width:160px;word-break:break-word;}

/* Manager action panel */
.mp{background:var(--surface3);border:1px solid var(--border2);border-radius:var(--rsm);padding:14px;margin-top:12px;}
.mp-t{font-size:10px;font-weight:700;letter-spacing:0.12em;text-transform:uppercase;color:var(--blue);margin-bottom:10px;}
.mf{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px;}
.fg{display:flex;flex-direction:column;gap:4px;}
.fl{font-size:9px;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;color:var(--text3);}
.fi{background:var(--surface);border:1px solid var(--border2);border-radius:8px;color:var(--text);font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;padding:9px 12px;width:100%;transition:border-color 0.18s;-webkit-appearance:none;}
.fi:focus{outline:none;border-color:var(--blue);box-shadow:0 0 0 3px rgba(108,112,240,0.08);}
.fi option{background:var(--surface2);}
textarea.fi{resize:vertical;min-height:60px;}
.sv{padding:8px 16px;border-radius:8px;font-size:12px;font-weight:700;background:var(--blue);color:#fff;border:none;cursor:pointer;font-family:'Plus Jakarta Sans',sans-serif;transition:all 0.18s;}
.sv:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(108,112,240,0.3);}
.sv-ok{font-size:11px;color:var(--green);font-weight:600;margin-left:10px;opacity:0;transition:opacity 0.3s;}

/* Funnel tab */
.fnl-period{display:flex;gap:6px;margin-bottom:18px;flex-wrap:wrap;}
.fnl-pb{padding:7px 16px;border-radius:8px;background:var(--surface2);border:1px solid var(--border2);color:var(--text3);font-family:'Plus Jakarta Sans',sans-serif;font-size:12px;font-weight:600;cursor:pointer;transition:all 0.18s;}
.fnl-pb:hover{color:var(--text);border-color:var(--blue);}
.fnl-pb.ac{background:var(--blue-soft);border-color:rgba(108,112,240,0.3);color:#818CF8;}
.fnl-rev{background:var(--surface);border:1px solid var(--border);border-radius:var(--rlg);padding:20px;margin-bottom:20px;position:relative;overflow:hidden;}
.fnl-rev::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--green),var(--gold));}
.fnl-rev-v{font-family:'Instrument Serif',Georgia,serif;font-size:42px;color:var(--green);line-height:1;}
.fnl-rev-l{font-size:13px;color:var(--text2);margin-top:6px;line-height:1.4;}
.fnl-rev-n{font-size:11px;color:var(--text3);margin-top:8px;font-style:italic;}
.fnl-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--rlg);padding:20px;margin-bottom:20px;}
.fnl-card-t{font-size:10px;font-weight:700;letter-spacing:0.14em;text-transform:uppercase;color:var(--text3);margin-bottom:16px;}
.fnl-stage{display:flex;align-items:center;gap:14px;margin-bottom:14px;position:relative;}
.fnl-stage:last-child{margin-bottom:0;}
.fnl-num{min-width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:800;color:#fff;flex-shrink:0;}
.fnl-info{flex:1;min-width:0;}
.fnl-name{font-size:13px;font-weight:700;color:var(--text);margin-bottom:2px;}
.fnl-meta{display:flex;align-items:center;gap:8px;font-size:12px;}
.fnl-count{font-family:'JetBrains Mono',monospace;font-weight:600;color:var(--text);}
.fnl-pct{font-family:'JetBrains Mono',monospace;font-weight:600;padding:1px 7px;border-radius:6px;font-size:11px;}
.fnl-drop{font-size:11px;color:var(--text3);}
.fnl-bar-wrap{flex:0 0 200px;height:10px;background:rgba(255,255,255,0.04);border-radius:5px;overflow:hidden;}
.fnl-bar{height:100%;border-radius:5px;transition:width 0.8s var(--spring);}
.fnl-arrow{position:absolute;left:13px;top:28px;bottom:-14px;width:2px;background:rgba(255,255,255,0.06);}
.fnl-stage:last-child .fnl-arrow{display:none;}
@media(max-width:600px){
  .fnl-bar-wrap{flex:0 0 100px;}
  .fnl-stage{gap:10px;}
  .fnl-rep-grid{grid-template-columns:1fr!important;}
}
.fnl-toggle{display:flex;align-items:center;gap:10px;margin-bottom:18px;}
.fnl-tog-btn{padding:7px 14px;border-radius:8px;background:var(--surface2);border:1px solid var(--border2);color:var(--text3);font-family:'Plus Jakarta Sans',sans-serif;font-size:12px;font-weight:600;cursor:pointer;transition:all 0.18s;}
.fnl-tog-btn.ac{background:var(--blue-soft);border-color:rgba(108,112,240,0.3);color:#818CF8;}
.fnl-rep-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
.fnl-rep-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:14px;position:relative;}
.fnl-rep-name{font-size:13px;font-weight:700;color:var(--text);margin-bottom:10px;}
.fnl-rep-best{position:absolute;top:10px;right:12px;font-size:10px;font-weight:700;color:var(--gold);background:var(--gold-soft);padding:2px 8px;border-radius:6px;}
.fnl-mini-stage{display:flex;align-items:center;gap:8px;margin-bottom:6px;}
.fnl-mini-label{font-size:11px;color:var(--text3);min-width:70px;}
.fnl-mini-bar-wrap{flex:1;height:6px;background:rgba(255,255,255,0.04);border-radius:3px;overflow:hidden;}
.fnl-mini-bar{height:100%;border-radius:3px;transition:width 0.6s var(--spring);}
.fnl-mini-count{font-family:'JetBrains Mono',monospace;font-size:11px;font-weight:600;color:var(--text3);min-width:24px;text-align:right;}
.fnl-mini-pct{font-family:'JetBrains Mono',monospace;font-size:10px;font-weight:600;min-width:36px;text-align:right;padding:1px 4px;border-radius:4px;}

/* Reports tab */
.rpt-f{background:var(--surface);border:1px solid var(--border);border-radius:var(--rlg);padding:20px;margin-bottom:16px;}
.rpt-ft{font-size:10px;font-weight:700;letter-spacing:0.14em;text-transform:uppercase;color:var(--text3);margin-bottom:12px;}
.rpt-g{display:grid;grid-template-columns:1fr 1fr 1fr 1fr auto;gap:10px;align-items:end;}
.rpt-l{font-size:9px;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;color:var(--text3);margin-bottom:4px;}
.rpt-i{width:100%;background:var(--bg2);border:1.5px solid var(--border2);border-radius:var(--rsm);color:var(--text);font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;padding:10px 12px;outline:none;-webkit-appearance:none;}
.rpt-i:focus{border-color:var(--blue);}
.rpt-i option{background:var(--surface);}
.rpt-run{padding:10px 20px;border-radius:var(--rsm);background:var(--blue);color:#fff;border:none;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;font-weight:700;cursor:pointer;white-space:nowrap;transition:all 0.18s;}
.rpt-run:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(108,112,240,0.3);}
.rbns{display:flex;gap:6px;margin-top:10px;flex-wrap:wrap;align-items:center;}
.rb-lbl{font-size:10px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:0.08em;}
.rb{padding:5px 12px;border-radius:7px;background:var(--surface2);border:1px solid var(--border2);color:var(--text3);font-family:'Plus Jakarta Sans',sans-serif;font-size:11px;font-weight:600;cursor:pointer;transition:all 0.18s;}
.rb:hover{color:var(--text);border-color:var(--blue);background:var(--blue-soft);}
.rkpis{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-bottom:16px;}
.rkpi{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:14px;position:relative;overflow:hidden;}
.rkpi::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;}
.rkpi-l{font-size:9px;font-weight:700;letter-spacing:0.12em;text-transform:uppercase;color:var(--text3);margin-bottom:5px;}
.rkpi-v{font-family:'Instrument Serif',Georgia,serif;font-size:38px;line-height:1;color:#fff;}
.rkpi-s{font-size:11px;color:var(--text3);margin-top:3px;}
.rpt-bar-row{display:flex;align-items:center;gap:10px;margin-bottom:7px;}
.rpt-bar-label{font-size:12px;font-weight:600;color:var(--text);min-width:120px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.rpt-bar-wrap{flex:1;height:8px;background:rgba(255,255,255,0.06);border-radius:4px;overflow:hidden;}
.rpt-bar{height:100%;border-radius:4px;transition:width 0.6s ease;}
.rpt-bar-count{font-family:'JetBrains Mono',monospace;font-size:12px;font-weight:600;color:var(--text3);min-width:28px;text-align:right;}
.rpt-c{background:var(--surface);border:1px solid var(--border);border-radius:var(--rlg);padding:18px;margin-bottom:14px;}
.rpt-ct{font-size:10px;font-weight:700;letter-spacing:0.14em;text-transform:uppercase;color:var(--text3);margin-bottom:12px;}

/* Edit Modal */
.mo{position:fixed;inset:0;background:rgba(0,0,0,0.75);z-index:600;display:none;align-items:center;justify-content:center;padding:20px;}
.mo.open{display:flex;}
.mb{background:var(--surface);border:1px solid var(--border2);border-radius:var(--rlg);width:100%;max-width:660px;max-height:90vh;overflow-y:auto;position:relative;}
.mb::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--blue),var(--red));border-radius:var(--rlg) var(--rlg) 0 0;}
.mh{padding:22px 24px 0;display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;}
.mt{font-family:'Instrument Serif',Georgia,serif;font-size:24px;color:var(--text);}
.mc{background:none;border:none;color:var(--text3);font-size:20px;cursor:pointer;padding:4px 8px;border-radius:6px;transition:color 0.15s;}
.mc:hover{color:var(--text);}
.mbd{padding:0 24px 24px;}
.msec{font-size:9px;font-weight:700;letter-spacing:0.14em;text-transform:uppercase;color:var(--blue);margin:16px 0 10px;padding-bottom:4px;border-bottom:1px solid var(--border);}
.mg{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.mg3{grid-template-columns:1fr 1fr 1fr;}
.mfl{display:flex;flex-direction:column;gap:4px;}
.mlbl{font-size:9px;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;color:var(--text3);}
.min{background:var(--bg2);border:1.5px solid var(--border2);border-radius:var(--rsm);color:var(--text);font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;padding:9px 12px;transition:border-color 0.18s;-webkit-appearance:none;width:100%;}
.min:focus{outline:none;border-color:var(--blue);box-shadow:0 0 0 3px rgba(108,112,240,0.08);}
.min option{background:var(--surface);}
textarea.min{resize:vertical;min-height:70px;}
.mfoot{display:flex;gap:10px;margin-top:18px;}
.msave{flex:1;padding:12px;border-radius:var(--rsm);background:var(--blue);color:#fff;border:none;font-family:'Plus Jakarta Sans',sans-serif;font-size:14px;font-weight:700;cursor:pointer;transition:all 0.18s;}
.msave:hover{transform:translateY(-1px);box-shadow:0 6px 16px rgba(108,112,240,0.3);}
.mcan{padding:12px 18px;border-radius:var(--rsm);background:var(--bg2);border:1.5px solid var(--border2);color:var(--text3);font-family:'Plus Jakarta Sans',sans-serif;font-size:14px;font-weight:600;cursor:pointer;}
.mcan:hover{color:var(--text);}
.mdel{padding:12px 14px;border-radius:var(--rsm);background:var(--red-soft);border:1px solid rgba(224,27,54,0.25);color:#FC8181;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;font-weight:600;cursor:pointer;}
.mdel:hover{background:rgba(224,27,54,0.18);}

/* Toast */
.toast{position:fixed;bottom:28px;left:50%;transform:translateX(-50%) translateY(80px);background:var(--surface);border:1px solid var(--border2);border-radius:12px;padding:12px 22px;font-size:13px;font-weight:600;color:var(--text);z-index:999;transition:transform 0.35s var(--spring);box-shadow:0 12px 32px rgba(0,0,0,0.4);white-space:nowrap;}
.toast.show{transform:translateX(-50%) translateY(0);}
.toast.grn{border-color:rgba(45,212,160,0.3);color:var(--green);}

/* Loading */
.ld{text-align:center;padding:40px;color:var(--text3);font-size:13px;}
.sp{display:inline-block;width:16px;height:16px;border:2px solid var(--border2);border-top-color:var(--blue);border-radius:50%;animation:spin 0.7s linear infinite;margin-right:8px;vertical-align:middle;}
@keyframes spin{to{transform:rotate(360deg);}}
.empty{text-align:center;padding:50px 20px;color:var(--text3);}
.empty-icon{font-size:32px;margin-bottom:10px;opacity:0.4;}
.empty-t{font-family:'Instrument Serif',Georgia,serif;font-size:18px;color:var(--text2);margin-bottom:4px;}
.empty-s{font-size:12px;}

@keyframes fadeUp{from{opacity:0;transform:translateY(12px);}to{opacity:1;transform:translateY(0);}}
.fi-in{animation:fadeUp 0.4s ease both;}

@media(max-width:900px){.kpis{grid-template-columns:repeat(3,1fr);}.eg{grid-template-columns:1fr 1fr;}.rpt-g{grid-template-columns:1fr 1fr;}.rkpis{grid-template-columns:repeat(3,1fr);}}
@media(max-width:600px){.page{padding:16px 14px 80px;}.kpis{grid-template-columns:repeat(2,1fr);}.em{grid-template-columns:auto 1fr;}.eright{flex-direction:row;flex-wrap:wrap;}.eg{grid-template-columns:1fr;}.mf{grid-template-columns:1fr;}.mg,.mg3{grid-template-columns:1fr;}.rpt-g{grid-template-columns:1fr;}.rkpis{grid-template-columns:1fr 1fr;}.fu-kpis{grid-template-columns:1fr 1fr;}.fu-top{flex-wrap:wrap;}.fu-sched{flex-direction:column;align-items:stretch;}.fu-sched input[type=date]{width:100%;}}

/* ‚ïê‚ïê‚ïê Follow-Ups Tab ‚ïê‚ïê‚ïê */
.fu-kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:20px;}
.fu-kpi{background:var(--surface);border:1px solid var(--border);border-radius:var(--rsm);padding:14px 16px;position:relative;overflow:hidden;}
.fu-kpi::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;}
.fk-red::before{background:var(--red);} .fk-gold::before{background:var(--gold);} .fk-blue::before{background:var(--blue);} .fk-green::before{background:var(--green);}
.fu-kpi-v{font-family:'Instrument Serif',Georgia,serif;font-size:28px;line-height:1;}
.fk-red .fu-kpi-v{color:#F87171;} .fk-gold .fu-kpi-v{color:var(--gold);} .fk-blue .fu-kpi-v{color:var(--blue);} .fk-green .fu-kpi-v{color:var(--green);}
.fu-kpi-l{font-size:9px;font-weight:700;letter-spacing:0.12em;text-transform:uppercase;color:var(--text3);margin-top:2px;}
.fu-sec{margin-bottom:20px;}
.fu-sec-hdr{display:flex;align-items:center;gap:8px;margin-bottom:10px;}
.fu-sec-t{font-size:10px;font-weight:700;letter-spacing:0.14em;text-transform:uppercase;color:var(--text3);}
.fu-sec-badge{font-family:'JetBrains Mono',monospace;font-size:10px;font-weight:700;padding:2px 8px;border-radius:10px;}
.fu-sec-badge.b-red{background:var(--red-soft);color:#F87171;border:1px solid rgba(224,27,54,0.2);}
.fu-sec-badge.b-gold{background:var(--gold-soft);color:var(--gold);border:1px solid rgba(212,167,58,0.2);}
.fu-sec-badge.b-blue{background:var(--blue-soft);color:var(--blue);border:1px solid rgba(108,112,240,0.2);}
.fu-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);margin-bottom:8px;overflow:hidden;transition:all 0.18s;}
.fu-card:hover{border-color:var(--border2);}
.fu-card.overdue{border-left:3px solid var(--red);}
.fu-card.today{border-left:3px solid var(--gold);}
.fu-card.upcoming{border-left:3px solid var(--blue);}
.fu-top{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;cursor:pointer;gap:10px;}
.fu-left{flex:1;min-width:0;}
.fu-cust{font-weight:700;font-size:14px;color:var(--text);display:flex;align-items:center;gap:8px;}
.fu-temp{font-family:'JetBrains Mono',monospace;font-size:10px;font-weight:700;padding:2px 7px;border-radius:6px;flex-shrink:0;}
.fu-t-hot{background:rgba(224,27,54,0.15);color:#F87171;} .fu-t-warm{background:var(--gold-soft);color:var(--gold);} .fu-t-cool{background:rgba(255,255,255,0.06);color:var(--text3);}
.fu-meta{font-size:12px;color:var(--text3);margin-top:2px;}
.fu-right{display:flex;align-items:center;gap:6px;flex-shrink:0;}
.fu-due{font-family:'JetBrains Mono',monospace;font-size:11px;font-weight:600;padding:4px 10px;border-radius:6px;}
.fu-due.d-over{background:var(--red-soft);color:#F87171;} .fu-due.d-today{background:var(--gold-soft);color:var(--gold);} .fu-due.d-soon{background:var(--blue-soft);color:var(--blue);}
.fu-expand{display:none;padding:0 16px 16px;border-top:1px solid var(--border);}
.fu-expand.open{display:block;padding-top:14px;}
.fu-actions{display:flex;gap:6px;margin-bottom:14px;flex-wrap:wrap;}
.fu-abtn{font-size:12px;font-weight:600;padding:7px 14px;border-radius:8px;border:1px solid var(--border2);background:var(--surface2);color:var(--text);cursor:pointer;transition:all 0.15s;font-family:'Plus Jakarta Sans',sans-serif;}
.fu-abtn:hover{background:var(--surface3);border-color:var(--border3);}
.fu-abtn.a-call{border-color:rgba(45,212,160,0.3);color:var(--green);}
.fu-abtn.a-text{border-color:rgba(108,112,240,0.3);color:var(--blue);}
.fu-abtn.a-email{border-color:rgba(212,167,58,0.3);color:var(--gold);}
.fu-abtn.a-done{border-color:rgba(45,212,160,0.3);color:var(--green);background:var(--green-soft);}
.fu-abtn.a-lost{border-color:rgba(224,27,54,0.2);color:#F87171;}
.fu-sched{display:flex;gap:8px;align-items:center;margin-bottom:14px;flex-wrap:wrap;}
.fu-sched input[type=date]{background:var(--bg2);border:1px solid var(--border2);border-radius:8px;color:var(--text);font-family:'Plus Jakarta Sans',sans-serif;font-size:12px;padding:7px 12px;outline:none;width:160px;}
.fu-sched input:focus{border-color:var(--blue);}
.fu-note{width:100%;background:var(--bg2);border:1px solid var(--border2);border-radius:8px;color:var(--text);font-family:'Plus Jakarta Sans',sans-serif;font-size:12px;padding:8px 12px;resize:none;outline:none;margin-bottom:10px;min-height:42px;}
.fu-note:focus{border-color:var(--blue);}
.fu-timeline{margin-top:10px;border-top:1px solid var(--border);padding-top:12px;}
.fu-tl-t{font-size:9px;font-weight:700;letter-spacing:0.12em;text-transform:uppercase;color:var(--text3);margin-bottom:8px;}
.fu-tl-item{display:flex;gap:10px;margin-bottom:8px;position:relative;padding-left:16px;}
.fu-tl-item::before{content:'';position:absolute;left:4px;top:7px;width:6px;height:6px;border-radius:50%;background:var(--border3);}
.fu-tl-item.tl-call::before{background:var(--green);} .fu-tl-item.tl-text::before{background:var(--blue);} .fu-tl-item.tl-email::before{background:var(--gold);} .fu-tl-item.tl-done::before{background:var(--green);} .fu-tl-item.tl-lost::before{background:var(--red);}
.fu-tl-item::after{content:'';position:absolute;left:6px;top:15px;width:1px;height:calc(100% + 2px);background:var(--border);}
.fu-tl-item:last-child::after{display:none;}
.fu-tl-date{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text3);flex-shrink:0;min-width:70px;}
.fu-tl-act{font-size:12px;font-weight:600;color:var(--text);}
.fu-tl-note{font-size:11px;color:var(--text3);margin-top:1px;}
.fu-tl-by{font-size:10px;color:var(--text3);font-style:italic;}
.fu-empty{text-align:center;padding:24px;color:var(--text3);font-size:13px;}

/* ‚ïê‚ïê‚ïê Audit History ‚ïê‚ïê‚ïê */
.modal-tabs{display:flex;gap:2px;margin-bottom:16px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:3px;}
.modal-tab{flex:1;padding:8px 0;text-align:center;font-size:12px;font-weight:700;color:var(--text3);cursor:pointer;border-radius:6px;border:none;background:none;font-family:'Plus Jakarta Sans',sans-serif;transition:all 0.15s;}
.modal-tab.active{background:var(--surface3);color:var(--text);}
.modal-panel{display:none;}.modal-panel.active{display:block;}
.audit-list{max-height:400px;overflow-y:auto;}
.audit-item{padding:12px 0;border-bottom:1px solid var(--border);}
.audit-item:last-child{border-bottom:none;}
.audit-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;}
.audit-action{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.08em;padding:2px 8px;border-radius:6px;}
.audit-action.a-edit{background:var(--blue-soft);color:var(--blue);}
.audit-action.a-delete{background:var(--red-soft);color:#F87171;}
.audit-when{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text3);}
.audit-who{font-size:12px;font-weight:600;color:var(--text2);margin-bottom:6px;}
.audit-changes{display:flex;flex-direction:column;gap:3px;}
.audit-change{font-size:11px;color:var(--text3);display:flex;gap:4px;align-items:baseline;flex-wrap:wrap;}
.audit-field{font-weight:700;color:var(--text2);font-family:'JetBrains Mono',monospace;font-size:10px;}
.audit-old{color:#F87171;text-decoration:line-through;}
.audit-new{color:var(--green);font-weight:600;}
.audit-arrow{color:var(--text3);opacity:0.5;}
.audit-empty{text-align:center;padding:30px;color:var(--text3);font-size:12px;font-style:italic;}

/* ‚ïê‚ïê‚ïê Follow-Up Task Badges ‚ïê‚ïê‚ïê */
.fu-badge{display:inline-flex;align-items:center;gap:4px;font-family:'JetBrains Mono',monospace;font-size:10px;font-weight:700;padding:3px 8px;border-radius:6px;white-space:nowrap;}
.fu-badge.fb-overdue{background:var(--red-soft);color:#F87171;border:1px solid rgba(224,27,54,0.2);animation:fuPulse 2s ease infinite;}
.fu-badge.fb-hot{background:var(--red-soft);color:#F87171;border:1px solid rgba(224,27,54,0.2);}
.fu-badge.fb-warm{background:var(--gold-soft);color:var(--gold);border:1px solid rgba(212,167,58,0.2);}
.fu-badge.fb-cool{background:var(--blue-soft);color:var(--blue);border:1px solid rgba(108,112,240,0.2);}
.fu-badge.fb-done{background:var(--green-soft);color:var(--green);border:1px solid rgba(45,212,160,0.2);}
@keyframes fuPulse{0%,100%{opacity:1;box-shadow:0 0 0 0 rgba(224,27,54,0.3);}50%{opacity:0.85;box-shadow:0 0 0 4px rgba(224,27,54,0);}}
.fu-work-btn{font-size:10px;font-weight:700;padding:4px 10px;border-radius:6px;border:1px solid rgba(45,212,160,0.3);background:var(--green-soft);color:var(--green);cursor:pointer;font-family:'Plus Jakarta Sans',sans-serif;transition:all 0.15s;white-space:nowrap;}
.fu-work-btn:hover{background:rgba(45,212,160,0.18);border-color:rgba(45,212,160,0.5);}

/* Mark Worked mini modal */
.mw-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.65);z-index:500;align-items:center;justify-content:center;}
.mw-overlay.open{display:flex;}
.mw-box{background:var(--surface);border:1px solid var(--border2);border-radius:var(--rlg);padding:24px;max-width:420px;width:90%;box-shadow:0 24px 80px rgba(0,0,0,0.5);}
.mw-title{font-family:'Instrument Serif',Georgia,serif;font-size:20px;margin-bottom:4px;}
.mw-sub{font-size:12px;color:var(--text3);margin-bottom:16px;}
.mw-note{width:100%;background:var(--bg2);border:1px solid var(--border2);border-radius:8px;color:var(--text);font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;padding:10px 14px;resize:none;outline:none;min-height:80px;margin-bottom:14px;}
.mw-note:focus{border-color:var(--blue);}
.mw-foot{display:flex;gap:8px;justify-content:flex-end;}
.mw-cancel{padding:8px 16px;border-radius:8px;border:1px solid var(--border2);background:none;color:var(--text3);font-size:12px;font-weight:600;cursor:pointer;font-family:'Plus Jakarta Sans',sans-serif;}
.mw-save{padding:8px 20px;border-radius:8px;border:none;background:var(--green);color:#000;font-size:12px;font-weight:700;cursor:pointer;font-family:'Plus Jakarta Sans',sans-serif;transition:all 0.15s;}
.mw-save:hover{box-shadow:0 4px 16px rgba(45,212,160,0.3);}

/* ‚ïê‚ïê‚ïê Queue Panel ‚ïê‚ïê‚ïê */
.q-kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:20px;}
.q-kpi{background:var(--surface);border:1px solid var(--border);border-radius:var(--rsm);padding:14px 16px;position:relative;overflow:hidden;}
.q-kpi::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;}
.qk-red::before{background:var(--red);} .qk-gold::before{background:var(--gold);} .qk-green::before{background:var(--green);}
.q-kpi-v{font-family:'Instrument Serif',Georgia,serif;font-size:28px;line-height:1;}
.qk-red .q-kpi-v{color:#F87171;} .qk-gold .q-kpi-v{color:var(--gold);} .qk-green .q-kpi-v{color:var(--green);}
.q-kpi-l{font-size:9px;font-weight:700;letter-spacing:0.12em;text-transform:uppercase;color:var(--text3);margin-top:2px;}
.q-refresh{font-size:10px;font-weight:700;color:var(--text3);background:none;border:1px solid var(--border2);border-radius:6px;padding:3px 10px;cursor:pointer;font-family:'Plus Jakarta Sans',sans-serif;transition:all 0.15s;}
.q-refresh:hover{border-color:var(--border3);color:var(--text);}
.q-sec{margin-bottom:24px;}
.q-sec-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;}
.q-sec-left{display:flex;align-items:center;gap:8px;}
.q-sec-t{font-size:10px;font-weight:700;letter-spacing:0.14em;text-transform:uppercase;color:var(--text3);}
.q-sec-badge{font-family:'JetBrains Mono',monospace;font-size:10px;font-weight:700;padding:2px 8px;border-radius:10px;}
.q-sec-badge.qb-red{background:var(--red-soft);color:#F87171;border:1px solid rgba(224,27,54,0.2);}
.q-sec-badge.qb-gold{background:var(--gold-soft);color:var(--gold);border:1px solid rgba(212,167,58,0.2);}
.qc{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);margin-bottom:8px;overflow:hidden;transition:all 0.2s;}
.qc:hover{border-color:var(--border2);}
.qc.qc-overdue{border-left:3px solid var(--red);animation:qcPulse 2.5s ease infinite;}
.qc.qc-hot{border-left:3px solid var(--red);}
.qc.qc-warm{border-left:3px solid var(--gold);}
@keyframes qcPulse{0%,100%{box-shadow:0 0 0 0 rgba(224,27,54,0);}50%{box-shadow:0 0 0 3px rgba(224,27,54,0.12);}}
.qc-top{display:flex;align-items:center;gap:12px;padding:14px 16px;}
.qc-temp{width:42px;height:42px;border-radius:10px;display:flex;flex-direction:column;align-items:center;justify-content:center;flex-shrink:0;font-family:'JetBrains Mono',monospace;}
.qc-temp.qt-hot{background:rgba(224,27,54,0.12);color:#F87171;} .qc-temp.qt-warm{background:var(--gold-soft);color:var(--gold);} .qc-temp.qt-cool{background:rgba(255,255,255,0.04);color:var(--text3);}
.qc-temp-n{font-size:16px;font-weight:800;line-height:1;}
.qc-temp-l{font-size:7px;font-weight:700;text-transform:uppercase;letter-spacing:0.06em;opacity:0.7;}
.qc-info{flex:1;min-width:0;}
.qc-name{font-weight:700;font-size:14px;color:var(--text);}
.qc-meta{font-size:12px;color:var(--text3);margin-top:1px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.qc-right{display:flex;flex-direction:column;align-items:flex-end;gap:4px;flex-shrink:0;}
.qc-due{font-family:'JetBrains Mono',monospace;font-size:11px;font-weight:700;padding:3px 8px;border-radius:6px;white-space:nowrap;}
.qc-due.qd-over{background:var(--red-soft);color:#F87171;} .qc-due.qd-hot{background:var(--red-soft);color:#F87171;} .qc-due.qd-warm{background:var(--gold-soft);color:var(--gold);} .qc-due.qd-cool{background:var(--blue-soft);color:var(--blue);}
.qc-elapsed{font-size:10px;color:var(--text3);font-family:'JetBrains Mono',monospace;}
.qc-actions{display:flex;gap:5px;padding:0 16px 12px;flex-wrap:wrap;}
.qc-btn{font-size:11px;font-weight:700;padding:5px 12px;border-radius:7px;border:1px solid var(--border2);background:var(--surface2);color:var(--text2);cursor:pointer;font-family:'Plus Jakarta Sans',sans-serif;transition:all 0.15s;position:relative;}
.qc-btn:hover{background:var(--surface3);border-color:var(--border3);color:var(--text);}
.qc-btn.qb-work{border-color:rgba(45,212,160,0.3);color:var(--green);}
.qc-btn.qb-work:hover{background:var(--green-soft);}
.qc-btn.qb-view{border-color:rgba(108,112,240,0.3);color:var(--blue);}
.qc-reassign-wrap{position:relative;display:inline-block;}
.qc-reassign-dd{display:none;position:absolute;top:100%;left:0;margin-top:4px;background:var(--surface);border:1px solid var(--border2);border-radius:8px;min-width:180px;padding:4px;box-shadow:0 12px 40px rgba(0,0,0,0.5);z-index:50;}
.qc-reassign-dd.open{display:block;}
.qc-reassign-opt{display:flex;align-items:center;gap:8px;padding:8px 12px;border-radius:6px;font-size:12px;font-weight:600;color:var(--text2);cursor:pointer;transition:all 0.1s;}
.qc-reassign-opt:hover{background:rgba(255,255,255,0.04);color:var(--text);}
.qc-reassign-av{width:22px;height:22px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:800;background:var(--surface3);color:var(--text3);}
.q-empty{text-align:center;padding:30px;color:var(--text3);font-size:13px;}
@media(max-width:600px){.q-kpis{grid-template-columns:1fr 1fr 1fr;}.qc-top{flex-wrap:wrap;}.qc-actions{gap:4px;}.qc-meta{white-space:normal;}}
</style>
</head>
<body>
<div class="bg-noise"></div>
<div class="bg-grad"></div>

<header class="hdr">
  <div class="hdr-l">
    <div class="hdr-logo"><svg viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2.5" stroke-linecap="round"><path d="M3 3v18h18"/><path d="M7 16l4-8 4 4 4-6"/></svg></div>
    <div class="hdr-t">Dashboard</div>
  </div>
  <div class="hdr-r">
    <div class="live"><div class="live-dot"></div> LIVE</div>
    <span class="hdr-user" id="hdr-user"></span>
    <button class="ham" id="ham" onclick="toggleMenu()" aria-label="Menu"><span></span><span></span><span></span></button>
    <div class="nav-dd" id="nav-dd">
      <div class="nui"><span class="nud" id="nud"></span><span class="nrp" id="nrp"></span></div>
      <div class="ddv"></div>
      <a href="app.html" class="di"><span class="di-ic">üè†</span> Home</a>
      <a href="service-to-sales-log.html" class="di"><span class="di-ic">üìã</span> S2S Entry</a>
      <a href="manager-dashboard.html" class="di ap"><span class="di-ic">üìä</span> Dashboard</a>
      <a href="scorecards.html" class="di"><span class="di-ic">üèÜ</span> Scorecards</a>
      <div class="ddv dd-admin" id="ddv-admin"></div>
      <a href="admin-panel.html" class="di dd-admin" id="dd-admin"><span class="di-ic">‚öôÔ∏è</span> Admin Panel</a>
    </div>
  </div>
</header>
<div class="nav-ov" id="nav-ov" onclick="closeMenu()"></div>

<div class="page">
  <!-- KPIs -->
  <div class="kpis fi-in">
    <div class="kpi kb"><div class="kpi-l">Total Contacts</div><div class="kpi-v" id="k-total">‚Äî</div></div>
    <div class="kpi kr"><div class="kpi-l">Hot Leads (8+)</div><div class="kpi-v" id="k-hot">‚Äî</div></div>
    <div class="kpi kg"><div class="kpi-l">Sold</div><div class="kpi-v" id="k-sold">‚Äî</div></div>
    <div class="kpi ko"><div class="kpi-l">Appt Set</div><div class="kpi-v" id="k-appt">‚Äî</div></div>
    <div class="kpi kd"><div class="kpi-l">Avg Temp</div><div class="kpi-v" id="k-avg">‚Äî</div></div>
    <div class="kpi kp"><div class="kpi-l">Conv Rate</div><div class="kpi-v" id="k-conv">‚Äî</div></div>
  </div>

  <!-- Alert -->
  <div class="alert-banner" id="alert-banner">
    <div class="a-dot"></div>
    <div><div class="a-txt" id="alert-txt">üî• Hot leads need attention</div><div class="a-sub" id="alert-sub"></div></div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tb ac" onclick="showTab('all',this)">All <span class="tb-badge" id="badge-all">0</span></button>
    <button class="tb" onclick="showTab('hot',this)">üî• Hot</button>
    <button class="tb" onclick="showTab('aging',this)">‚è∞ Aging</button>
    <button class="tb" onclick="showTab('unclaimed',this)">üì≠ Unclaimed</button>
    <button class="tb" onclick="showTab('followups',this)">üìÖ Follow-Ups</button>
    <button class="tb" onclick="showTab('queue',this)">‚ö° Queue <span class="tb-badge" id="badge-queue" style="background:var(--red-soft);color:#F87171;border-color:rgba(224,27,54,0.2);">0</span></button>
    <button class="tb" onclick="showTab('funnel',this)">üîª Funnel</button>
    <button class="tb" onclick="showTab('reports',this)">üìä Reports</button>
  </div>

  <div class="exp-bar fi-in">
    <button class="exp exp-csv" onclick="exportCSV()">‚¨á Export CSV</button>
    <button class="exp exp-pdf" onclick="exportPrint()">üñ® Print View</button>
  </div>

  <!-- ENTRIES -->
  <div id="tab-entries">
    <div class="sh"><div class="sh-t" id="sh-label">All Entries</div><div class="sh-c" id="sh-count">‚Äî</div></div>
    <div class="el" id="entries-list"><div class="ld"><span class="sp"></span> Loading...</div></div>
  </div>

  <!-- FOLLOW-UPS -->
  <div id="tab-followups" style="display:none;">
    <div class="fu-kpis">
      <div class="fu-kpi fk-red"><div class="fu-kpi-v" id="fu-overdue">0</div><div class="fu-kpi-l">Overdue</div></div>
      <div class="fu-kpi fk-gold"><div class="fu-kpi-v" id="fu-today">0</div><div class="fu-kpi-l">Due Today</div></div>
      <div class="fu-kpi fk-blue"><div class="fu-kpi-v" id="fu-upcoming">0</div><div class="fu-kpi-l">Upcoming</div></div>
      <div class="fu-kpi fk-green"><div class="fu-kpi-v" id="fu-complete">0</div><div class="fu-kpi-l">Completed</div></div>
    </div>
    <div id="fu-overdue-sec"></div>
    <div id="fu-today-sec"></div>
    <div id="fu-upcoming-sec"></div>
  </div>

  <!-- QUEUE -->
  <div id="tab-queue" style="display:none;">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;">
      <div style="font-family:'Instrument Serif',Georgia,serif;font-size:20px;">Unworked Lead Queue</div>
      <button class="q-refresh" onclick="refreshQueue()">‚Üª Refresh</button>
    </div>
    <div class="q-kpis">
      <div class="q-kpi qk-red"><div class="q-kpi-v" id="q-hot">0</div><div class="q-kpi-l">Hot Unworked</div></div>
      <div class="q-kpi qk-gold"><div class="q-kpi-v" id="q-overdue">0</div><div class="q-kpi-l">Overdue</div></div>
      <div class="q-kpi qk-green"><div class="q-kpi-v" id="q-worked">0</div><div class="q-kpi-l">Worked Today</div></div>
    </div>
    <div id="q-hot-sec"></div>
    <div id="q-overdue-sec"></div>
  </div>

  <!-- FUNNEL -->
  <div id="tab-funnel" style="display:none;">
    <div class="fnl-period">
      <button class="fnl-pb ac" onclick="setFunnelPeriod('week',this)">This Week</button>
      <button class="fnl-pb" onclick="setFunnelPeriod('month',this)">This Month</button>
      <button class="fnl-pb" onclick="setFunnelPeriod('all',this)">All Time</button>
    </div>
    <div id="fnl-revenue"></div>
    <div class="fnl-toggle">
      <button class="fnl-tog-btn ac" id="fnl-team-btn" onclick="setFunnelView('team')">Team Funnel</button>
      <button class="fnl-tog-btn" id="fnl-rep-btn" onclick="setFunnelView('reps')">Per-Rep Comparison</button>
    </div>
    <div id="fnl-team-view"></div>
    <div id="fnl-rep-view" style="display:none;"></div>
  </div>

  <!-- REPORTS -->
  <div id="tab-reports" style="display:none;">
    <div class="rpt-f">
      <div class="rpt-ft">Filter Report</div>
      <div class="rpt-g">
        <div><div class="rpt-l">From</div><input type="date" class="rpt-i" id="rpt-from"></div>
        <div><div class="rpt-l">To</div><input type="date" class="rpt-i" id="rpt-to"></div>
        <div><div class="rpt-l">Rep</div><select class="rpt-i" id="rpt-rep"><option value="">All Reps</option><option>Tyler Doyle</option><option>Andrew Kirk</option><option>DJ Rogers</option><option>Kody McCann</option></select></div>
        <div><div class="rpt-l">Outcome</div><select class="rpt-i" id="rpt-outcome"><option value="">All</option><option>Sold</option><option>Appointment Set</option><option>Follow-Up Required</option><option>Not Interested</option></select></div>
        <button class="rpt-run" onclick="runReport()">Run Report</button>
      </div>
      <div class="rbns">
        <span class="rb-lbl">Quick:</span>
        <button class="rb" onclick="setRange(7)">7 Days</button>
        <button class="rb" onclick="setRange(14)">14 Days</button>
        <button class="rb" onclick="setRange(30)">30 Days</button>
        <button class="rb" onclick="setRange(90)">90 Days</button>
        <button class="rb" onclick="setRange(0)">All Time</button>
      </div>
    </div>
    <div class="rkpis" id="rpt-kpis"></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;" id="rpt-charts">
      <div class="rpt-c"><div class="rpt-ct">Entries by Rep</div><div id="chart-rep"></div></div>
      <div class="rpt-c"><div class="rpt-ct">Outcome Distribution</div><div id="chart-outcome"></div></div>
    </div>
  </div>
</div>

<!-- EDIT MODAL -->
<div class="mo" id="edit-modal">
  <div class="mb">
    <div class="mh"><div class="mt">Edit Entry <span style="font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--text3);margin-left:6px;" id="ed-id-display"></span></div><button class="mc" onclick="closeModal()">‚úï</button></div>
    <div class="mbd">
      <input type="hidden" id="ed-id">
      <div class="modal-tabs" id="modal-tabs">
        <button class="modal-tab active" onclick="switchModalTab('edit')">‚úèÔ∏è Edit</button>
        <button class="modal-tab" onclick="switchModalTab('history')" id="history-tab" style="display:none;">üìã History</button>
      </div>
      <div class="modal-panel active" id="panel-edit">
        <div class="msec">Customer Info</div>
        <div class="mg">
          <div class="mfl"><label class="mlbl">First Name</label><input class="min" id="ed-first"></div>
          <div class="mfl"><label class="mlbl">Last Name</label><input class="min" id="ed-last"></div>
          <div class="mfl"><label class="mlbl">Phone</label><input class="min" id="ed-phone"></div>
          <div class="mfl"><label class="mlbl">Email</label><input class="min" id="ed-email"></div>
        </div>
        <div class="msec">Vehicle</div>
        <div class="mg mg3">
          <div class="mfl"><label class="mlbl">Year</label><input class="min" id="ed-year"></div>
          <div class="mfl"><label class="mlbl">Make</label><input class="min" id="ed-make"></div>
          <div class="mfl"><label class="mlbl">Model</label><input class="min" id="ed-model"></div>
        </div>
        <div class="msec">Status</div>
        <div class="mg">
          <div class="mfl"><label class="mlbl">Repair Cost</label><input class="min" id="ed-repair"></div>
          <div class="mfl"><label class="mlbl">Engagement Score</label><input class="min" id="ed-score" type="number" min="1" max="10"></div>
          <div class="mfl"><label class="mlbl">Outcome</label><select class="min" id="ed-outcome"><option>New Vehicle Sold</option><option>Used Vehicle Sold</option><option>Appointment Set</option><option>Follow-Up Required</option><option>Not Interested</option></select></div>
          <div class="mfl"><label class="mlbl">Submitter</label><select class="min" id="ed-submitter"><option>Tyler Doyle</option><option>Andrew Kirk</option><option>DJ Rogers</option><option>Kody McCann</option></select></div>
        </div>
        <div class="msec">Notes</div>
        <div class="mfl"><textarea class="min" id="ed-notes" rows="3"></textarea></div>
        <div class="mfoot">
          <button class="mcan" onclick="closeModal()">Cancel</button>
          <button class="mdel" onclick="softDeleteEntry()">üóë Archive</button>
          <button class="msave" onclick="saveEdit()">‚úì Save Changes</button>
        </div>
      </div>
      <div class="modal-panel" id="panel-history">
        <div class="audit-list" id="audit-list"><div class="audit-empty">Loading audit history...</div></div>
      </div>
    </div>
  </div>
</div>
<!-- MARK WORKED MODAL -->
<div class="mw-overlay" id="mw-modal">
  <div class="mw-box">
    <div class="mw-title">‚úì Mark Follow-Up Worked</div>
    <div class="mw-sub" id="mw-sub">Entry #‚Äî</div>
    <input type="hidden" id="mw-fuid">
    <textarea class="mw-note" id="mw-note" placeholder="What happened? (e.g. Called, set appointment for Friday, customer excited about Wrangler...)"></textarea>
    <div class="mw-foot">
      <button class="mw-cancel" onclick="closeMW()">Cancel</button>
      <button class="mw-save" id="mw-save" onclick="submitMW()">‚úì Mark Worked</button>
    </div>
  </div>
</div>
<div class="toast" id="toast"></div>

<script>
const SB_URL='https://jbkgwtohwsbaorhvuuqb.supabase.co';
const SB_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impia2d3dG9od3NiYW9yaHZ1dXFiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5NjkwNDIsImV4cCI6MjA4NzU0NTA0Mn0.GRXOYbIuVDxU9-FEBYmyd1QmytVUrMIAxbnOSfepzuU';
const H={'apikey':SB_KEY,'Authorization':'Bearer '+SB_KEY,'Content-Type':'application/json'};
const rep=JSON.parse(sessionStorage.getItem('sb_rep')||'null');
let ALL=[];let TASKS=[];let currentTab='all';
const canClaim=rep&&(rep.role==='admin'||rep.role==='manager');

// Nav
(function(){
  if(!rep)return;
  const first=rep.first_name||rep.name.split(' ')[0];
  document.getElementById('hdr-user').textContent=first;
  document.getElementById('nud').textContent=rep.name;
  const p=document.getElementById('nrp');
  const r=(rep.role||'sales').toLowerCase();
  p.textContent=r.charAt(0).toUpperCase()+r.slice(1);
  p.className='nrp '+(r==='admin'?'r-admin':r==='manager'?'r-manager':'r-sales');
  if(r==='admin'){document.getElementById('dd-admin').classList.add('show');document.getElementById('ddv-admin').classList.add('show');}
})();

function toggleMenu(){const h=document.getElementById('ham'),d=document.getElementById('nav-dd'),o=document.getElementById('nav-ov');const op=d.classList.contains('open');h.classList.toggle('open',!op);d.classList.toggle('open',!op);o.classList.toggle('open',!op);}
function closeMenu(){document.getElementById('ham').classList.remove('open');document.getElementById('nav-dd').classList.remove('open');document.getElementById('nav-ov').classList.remove('open');}

// Load
// (init logic moved to initDash at bottom of script)

function renderKPIs(){
  const n=ALL.length;
  const sold=ALL.filter(e=>e.outcome&&(e.outcome.includes('New')||e.outcome.includes('Used'))).length;
  const hot=ALL.filter(e=>parseInt(e.eng_score)>=8).length;
  const appt=ALL.filter(e=>e.outcome==='Appointment Set').length;
  const temps=ALL.map(e=>parseInt(e.eng_score)).filter(t=>!isNaN(t));
  const avg=temps.length?(temps.reduce((a,b)=>a+b,0)/temps.length).toFixed(1):'‚Äî';
  document.getElementById('k-total').textContent=n;
  document.getElementById('k-hot').textContent=hot;
  document.getElementById('k-sold').textContent=sold;
  document.getElementById('k-appt').textContent=appt;
  document.getElementById('k-avg').textContent=avg;
  document.getElementById('k-conv').textContent=n?Math.round((sold/n)*100)+'%':'0%';
  document.getElementById('badge-all').textContent=n;
  // hot alert
  const unclaimed=ALL.filter(e=>parseInt(e.eng_score)>=8&&!e.manager_claimed_by);
  const ab=document.getElementById('alert-banner');
  if(unclaimed.length>0){ab.style.display='flex';document.getElementById('alert-txt').textContent=`üî• ${unclaimed.length} hot lead${unclaimed.length>1?'s':''} unclaimed`;document.getElementById('alert-sub').textContent='Claim these leads before they go cold';}
}

function getFiltered(){
  const now=Date.now();
  const dayMs=86400000;
  if(currentTab==='hot')return ALL.filter(e=>parseInt(e.eng_score)>=8);
  if(currentTab==='aging')return ALL.filter(e=>{if(!e.created_at)return false;const age=now-new Date(e.created_at).getTime();return age>2*dayMs&&(!e.outcome||e.outcome==='Follow-Up Required');});
  if(currentTab==='unclaimed')return ALL.filter(e=>!e.manager_claimed_by);
  return ALL;
}

function getTaskForEntry(entryId){return TASKS.find(t=>t.entry_id===entryId);}
function fuBadgeHtml(e){
  const t=getTaskForEntry(e.id);
  if(!t) return '';
  if(t.completed_at) return '<span class="fu-badge fb-done">‚úÖ Worked</span>';
  const now=Date.now(),due=new Date(t.due_at).getTime();
  const diff=due-now;
  if(diff<=0){
    const overMin=Math.round(Math.abs(diff)/60000);
    const label=overMin>=60?Math.floor(overMin/60)+'h '+overMin%60+'m overdue':overMin+'m overdue';
    return `<span class="fu-badge fb-overdue">üî¥ ${label}</span>`;
  }
  const min=Math.round(diff/60000);
  if(min<=30) return `<span class="fu-badge fb-hot">üî¥ Due in ${min}m</span>`;
  if(min<=120) return `<span class="fu-badge fb-warm">üü° Due in ${min>=60?Math.floor(min/60)+'h '+(min%60)+'m':min+'m'}</span>`;
  const hrs=Math.round(min/60);
  return `<span class="fu-badge fb-cool">üîµ Due in ${hrs}h</span>`;
}
function fuBtnHtml(e){
  const t=getTaskForEntry(e.id);
  if(!t||t.completed_at) return '';
  return `<button class="fu-work-btn" onclick="event.stopPropagation();openMW('${t.id}',${e.id},'${(e.first_name||'').replace(/'/g,"\\'")} ${(e.last_name||'').replace(/'/g,"\\'")}')">Mark Worked</button>`;
}

function renderEntries(){
  const list=getFiltered();
  const labels={'all':'All Entries','hot':'Hot Leads (8+)','aging':'Aging Follow-Ups','unclaimed':'Unclaimed Entries'};
  document.getElementById('sh-label').textContent=labels[currentTab]||'All Entries';
  document.getElementById('sh-count').textContent=list.length+' entries';
  const el=document.getElementById('entries-list');
  if(!list.length){el.innerHTML='<div class="empty"><div class="empty-icon">üì≠</div><div class="empty-t">No entries found</div><div class="empty-s">Adjust filters or check back later.</div></div>';return;}
  el.innerHTML=list.map(e=>{
    const sc=parseInt(e.eng_score)||0;
    const tcls=sc>=8?'t-hot':sc>=5?'t-warm':'t-cool';
    const task=getTaskForEntry(e.id);
    const isOverdue=task&&!task.completed_at&&new Date(task.due_at).getTime()<Date.now();
    const cls=sc>=8?'hot':(isOverdue?'hot':(currentTab==='aging'?'aging':''));
    const veh=[e.veh_year,e.veh_make,e.veh_model].filter(Boolean).join(' ')||'‚Äî';
    const otag=!e.outcome?'et-other':e.outcome.includes('Sold')?'et-sold':e.outcome==='Appointment Set'?'et-appt':e.outcome==='Follow-Up Required'?'et-follow':'et-other';
    const time=e.created_at?new Date(e.created_at).toLocaleString('en-US',{month:'short',day:'numeric',hour:'numeric',minute:'2-digit'}):(e.timestamp||'‚Äî');
    const claimed=e.manager_claimed_by;
    const crmDone=e.crm_entry&&e.crm_entry.toLowerCase().includes('yes');
    let ageTag='';
    if(e.created_at){const hrs=(Date.now()-new Date(e.created_at).getTime())/3600000;if(hrs>48&&(!e.outcome||e.outcome==='Follow-Up Required'))ageTag='<span class="et et-aging">‚è∞ Aging</span>';}
    return`<div class="ec ${cls}" id="ec-${e.id}">
      <div class="em">
        <div class="tb2 ${tcls}"><div class="tn">${sc||'?'}</div><div class="tl">temp</div></div>
        <div>
          <div class="en">${e.first_name||''} ${e.last_name||''}</div>
          <div class="emeta"><span>üöó ${veh}</span><span>üë§ ${e.submitter||'‚Äî'}</span>${e.phone?`<span>üìû ${e.phone}</span>`:''}</div>
          <div class="etags">
            <span class="et ${otag}">${e.outcome||'Pending'}</span>
            ${sc>=8?'<span class="et et-hot">üî• Hot Lead</span>':''}
            ${claimed?`<span class="et et-claimed">‚úì ${claimed}</span>`:''}
            ${crmDone?'<span class="crm-ok">CRM ‚úì</span>':''}
            ${ageTag}
            ${fuBadgeHtml(e)}
          </div>
        </div>
        <div class="eright">
          <div class="etime">${time}</div>
          ${!claimed?(canClaim?`<button class="cbtn" onclick="claimEntry(${e.id},event)">Claim</button>`:''):`<div class="clby">Claimed by ${claimed}</div>`}
          <div style="display:flex;gap:5px;margin-top:2px;">
            <button class="ebtn" onclick="openEdit(${e.id})">Edit</button>
            <button class="crm" onclick="pushCRM(${e.id})" ${crmDone?'disabled':''}>CRM${crmDone?' ‚úì':''}</button>
            ${fuBtnHtml(e)}
          </div>
        </div>
      </div>
      <button class="ext" onclick="toggleExpand(${e.id})">Details ‚ñæ</button>
      <div class="ee" id="ee-${e.id}">
        <div class="eg">
          <div><div class="est">Customer</div>
            ${[['Name',`${e.first_name||''} ${e.last_name||''}`],['Phone',e.phone||'‚Äî'],['Email',e.email||'‚Äî'],['Contact Pref',e.contact_pref||'‚Äî']].map(([k,v])=>`<div class="er"><span class="erk">${k}</span><span class="erv">${v}</span></div>`).join('')}
          </div>
          <div><div class="est">Vehicle</div>
            ${[['Vehicle',veh],['Mileage',e.veh_miles?Number(e.veh_miles).toLocaleString()+' mi':'‚Äî'],['Ownership',e.veh_ownership||'‚Äî'],['Condition',e.veh_condition||'‚Äî']].map(([k,v])=>`<div class="er"><span class="erk">${k}</span><span class="erv">${v}</span></div>`).join('')}
          </div>
          <div><div class="est">Service & Sales</div>
            ${[['Visit Reason',e.visit_reason||'‚Äî'],['Repair Cost',e.repair_cost||'‚Äî'],['Cost vs Value',e.repair_ratio||'‚Äî'],['Emotion',e.cust_emotion||'‚Äî'],['Timeline',e.timeline||'‚Äî'],['Finance',e.finance_conv||'‚Äî']].map(([k,v])=>`<div class="er"><span class="erk">${k}</span><span class="erv">${v}</span></div>`).join('')}
          </div>
        </div>
        ${e.notes?`<div style="background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:12px;"><div class="est">Notes</div><div style="font-size:13px;color:var(--text2);">${e.notes}</div></div>`:''}
        <div class="mp">
          <div class="mp-t">Manager Action Panel</div>
          <div class="mf">
            <div class="fg"><label class="fl">Mgr Outcome</label><select class="fi" id="mo-${e.id}"><option value="">Select...</option><option>Verified Sold</option><option>Appointment Confirmed</option><option>Working ‚Äî Active</option><option>Lost ‚Äî No Follow-Up</option><option>Lost ‚Äî Competitor</option><option>Lost ‚Äî Financing</option></select></div>
            <div class="fg"><label class="fl">Follow-Up Status</label><select class="fi" id="fs-${e.id}"><option value="">Select...</option><option>Pending</option><option>Contacted</option><option>Scheduled</option><option>Complete</option><option>No Response</option></select></div>
          </div>
          <div class="fg" style="margin-bottom:10px;"><label class="fl">Manager Notes</label><textarea class="fi" id="mn-${e.id}" rows="2" placeholder="Add notes...">${e.manager_notes||''}</textarea></div>
          <div style="display:flex;align-items:center;"><button class="sv" onclick="saveMgr(${e.id})">Save</button><span class="sv-ok" id="svok-${e.id}">‚úì Saved</span></div>
        </div>
      </div>
    </div>`;
  }).join('');
  // pre-fill manager selects
  list.forEach(e=>{
    if(e.manager_outcome){const s=document.getElementById('mo-'+e.id);if(s)s.value=e.manager_outcome;}
    if(e.followup_status){const s=document.getElementById('fs-'+e.id);if(s)s.value=e.followup_status;}
  });
}

function showTab(tab,btn){
  currentTab=tab;
  document.querySelectorAll('.tb').forEach(t=>t.classList.remove('ac'));
  btn.classList.add('ac');
  document.getElementById('tab-entries').style.display='none';
  document.getElementById('tab-reports').style.display='none';
  document.getElementById('tab-followups').style.display='none';
  document.getElementById('tab-queue').style.display='none';
  document.getElementById('tab-funnel').style.display='none';
  if(tab==='reports'){document.getElementById('tab-reports').style.display='block';runReport();}
  else if(tab==='followups'){document.getElementById('tab-followups').style.display='block';renderFollowUps();}
  else if(tab==='queue'){document.getElementById('tab-queue').style.display='block';renderQueue();}
  else if(tab==='funnel'){document.getElementById('tab-funnel').style.display='block';renderFunnel();}
  else{document.getElementById('tab-entries').style.display='block';renderEntries();}
}

function toggleExpand(id){const el=document.getElementById('ee-'+id);el.classList.toggle('open');}

async function claimEntry(id,evt){
  if(!canClaim){showToast('Only managers can claim leads');return;}
  const name=rep?rep.name:'Manager';
  await fetch(`${SB_URL}/rest/v1/s2s_entries?id=eq.${id}`,{method:'PATCH',headers:H,body:JSON.stringify({manager_claimed_by:name})});
  const e=ALL.find(x=>x.id===id);if(e)e.manager_claimed_by=name;
  renderEntries();renderKPIs();showToast('‚úì Lead claimed by '+name);
}

async function pushCRM(id){
  await fetch(`${SB_URL}/rest/v1/s2s_entries?id=eq.${id}`,{method:'PATCH',headers:H,body:JSON.stringify({crm_entry:'Yes ‚Äî entered in CRM'})});
  const e=ALL.find(x=>x.id===id);if(e)e.crm_entry='Yes ‚Äî entered in CRM';
  renderEntries();showToast('‚úì CRM status updated');
}

async function saveMgr(id){
  const mo=document.getElementById('mo-'+id).value;
  const fs=document.getElementById('fs-'+id).value;
  const mn=document.getElementById('mn-'+id).value;
  await fetch(`${SB_URL}/rest/v1/s2s_entries?id=eq.${id}`,{method:'PATCH',headers:H,body:JSON.stringify({manager_outcome:mo,followup_status:fs,manager_notes:mn})});
  const e=ALL.find(x=>x.id===id);if(e){e.manager_outcome=mo;e.followup_status=fs;e.manager_notes=mn;}
  const ok=document.getElementById('svok-'+id);ok.style.opacity='1';setTimeout(()=>ok.style.opacity='0',2000);
}

// Edit modal with audit trail
function switchModalTab(tab){
  document.querySelectorAll('#modal-tabs .modal-tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.modal-panel').forEach(p=>p.classList.remove('active'));
  if(tab==='edit'){document.querySelector('#modal-tabs .modal-tab:first-child').classList.add('active');document.getElementById('panel-edit').classList.add('active');}
  else{document.getElementById('history-tab').classList.add('active');document.getElementById('panel-history').classList.add('active');}
}

async function openEdit(id){
  const e=ALL.find(x=>x.id===id);if(!e)return;
  document.getElementById('ed-id').value=e.id;
  document.getElementById('ed-id-display').textContent='#'+e.id;
  document.getElementById('ed-first').value=e.first_name||'';
  document.getElementById('ed-last').value=e.last_name||'';
  document.getElementById('ed-phone').value=e.phone||'';
  document.getElementById('ed-email').value=e.email||'';
  document.getElementById('ed-year').value=e.veh_year||'';
  document.getElementById('ed-make').value=e.veh_make||'';
  document.getElementById('ed-model').value=e.veh_model||'';
  document.getElementById('ed-repair').value=e.repair_cost||'';
  document.getElementById('ed-score').value=e.eng_score||'';
  document.getElementById('ed-outcome').value=e.outcome||'';
  document.getElementById('ed-submitter').value=e.submitter||'';
  document.getElementById('ed-notes').value=e.notes||'';
  // Show history tab for admin/manager only
  const isPriv=rep&&(rep.role==='admin'||rep.role==='manager');
  document.getElementById('history-tab').style.display=isPriv?'':'none';
  // Reset to edit tab
  switchModalTab('edit');
  document.getElementById('edit-modal').classList.add('open');
  // Load audit history in background
  if(isPriv) loadAuditHistory(id);
}

function closeModal(){document.getElementById('edit-modal').classList.remove('open');}
document.getElementById('edit-modal').addEventListener('click',function(ev){if(ev.target===this)closeModal();});

async function loadAuditHistory(entryId){
  const el=document.getElementById('audit-list');
  el.innerHTML='<div class="audit-empty">Loading audit history...</div>';
  try{
    const res=await fetch(`${SB_URL}/rest/v1/s2s_audit_log?entry_id=eq.${entryId}&order=changed_at.desc&limit=50`,{headers:H});
    if(!res.ok){el.innerHTML='<div class="audit-empty">Failed to load history</div>';return;}
    const logs=await res.json();
    if(!logs.length){el.innerHTML='<div class="audit-empty">No edit history ‚Äî this entry has never been modified</div>';return;}
    el.innerHTML=logs.map(log=>{
      const when=new Date(log.changed_at);
      const dateStr=when.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'})+' at '+when.toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit',hour12:true});
      const isDelete=log.action==='delete';
      // Compute changed fields
      let changesHtml='';
      if(!isDelete&&log.old_values&&log.new_values){
        const TRACKED=['first_name','last_name','phone','email','veh_year','veh_make','veh_model','repair_cost','eng_score','outcome','submitter','notes','follow_up_status','manager_outcome','manager_notes','followup_status','manager_claimed_by','crm_entry','next_followup_date'];
        const diffs=[];
        TRACKED.forEach(k=>{
          const ov=(log.old_values[k]??'').toString();
          const nv=(log.new_values[k]??'').toString();
          if(ov!==nv) diffs.push({field:k,old:ov||'(empty)',new:nv||'(empty)'});
        });
        if(diffs.length){
          changesHtml=`<div class="audit-changes">${diffs.map(d=>`<div class="audit-change"><span class="audit-field">${d.field.replace(/_/g,' ')}</span> <span class="audit-old">${truncate(d.old,40)}</span> <span class="audit-arrow">‚Üí</span> <span class="audit-new">${truncate(d.new,40)}</span></div>`).join('')}</div>`;
        } else {
          changesHtml='<div style="font-size:11px;color:var(--text3);font-style:italic;">Metadata update (no visible field changes)</div>';
        }
      } else if(isDelete){
        changesHtml='<div style="font-size:11px;color:#F87171;font-weight:600;">Entry archived (soft delete)</div>';
      }
      return`<div class="audit-item">
        <div class="audit-hdr"><span class="audit-action ${isDelete?'a-delete':'a-edit'}">${log.action}</span><span class="audit-when">${dateStr}</span></div>
        <div class="audit-who">by ${log.changed_by}</div>
        ${changesHtml}
      </div>`;
    }).join('');
  }catch(e){el.innerHTML='<div class="audit-empty">Error loading history: '+e.message+'</div>';}
}

function truncate(s,n){return s.length>n?s.slice(0,n)+'‚Ä¶':s;}

async function saveEdit(){
  const id=document.getElementById('ed-id').value;
  const p={first_name:document.getElementById('ed-first').value,last_name:document.getElementById('ed-last').value,phone:document.getElementById('ed-phone').value,email:document.getElementById('ed-email').value,veh_year:document.getElementById('ed-year').value,veh_make:document.getElementById('ed-make').value,veh_model:document.getElementById('ed-model').value,repair_cost:document.getElementById('ed-repair').value,eng_score:document.getElementById('ed-score').value,outcome:document.getElementById('ed-outcome').value,submitter:document.getElementById('ed-submitter').value,notes:document.getElementById('ed-notes').value};
  // The BEFORE UPDATE trigger automatically creates the audit log entry
  await fetch(`${SB_URL}/rest/v1/s2s_entries?id=eq.${id}`,{method:'PATCH',headers:H,body:JSON.stringify(p)});
  const e=ALL.find(x=>x.id==id);if(e)Object.assign(e,p);
  closeModal();renderEntries();renderKPIs();showToast('‚úì Entry updated (audit logged)','grn');
}

async function softDeleteEntry(){
  if(!confirm('Archive this entry? It will be hidden from all views but preserved in the audit log and can be recovered.'))return;
  const id=parseInt(document.getElementById('ed-id').value);
  const deletedBy=rep?rep.name:'Unknown';
  try{
    const res=await fetch(`${SB_URL}/rest/v1/rpc/soft_delete_entry`,{method:'POST',headers:H,body:JSON.stringify({p_entry_id:id,p_deleted_by:deletedBy})});
    if(!res.ok){const err=await res.json();showToast('Error: '+(err.message||'Delete failed'));return;}
    ALL=ALL.filter(x=>x.id!==id);
    closeModal();renderEntries();renderKPIs();showToast('‚úì Entry archived by '+deletedBy);
  }catch(e){showToast('Error: '+e.message);}
}

// ‚ïê‚ïê‚ïê Funnel Analytics ‚ïê‚ïê‚ïê
let funnelPeriod='week';
let funnelView='team';

function setFunnelPeriod(period,btn){
  funnelPeriod=period;
  document.querySelectorAll('.fnl-pb').forEach(b=>b.classList.remove('ac'));
  if(btn)btn.classList.add('ac');
  renderFunnel();
}

function setFunnelView(view){
  funnelView=view;
  document.getElementById('fnl-team-btn').classList.toggle('ac',view==='team');
  document.getElementById('fnl-rep-btn').classList.toggle('ac',view==='reps');
  document.getElementById('fnl-team-view').style.display=view==='team'?'block':'none';
  document.getElementById('fnl-rep-view').style.display=view==='reps'?'block':'none';
  renderFunnel();
}

function getFunnelData(entries){
  const contacts=entries.length;
  const warm=entries.filter(e=>(parseInt(e.eng_score)||0)>=5).length;
  const hot=entries.filter(e=>(parseInt(e.eng_score)||0)>=8).length;
  const appt=entries.filter(e=>e.outcome==='Appointment Set').length;
  const sold=entries.filter(e=>e.outcome&&(e.outcome.includes('New Vehicle Sold')||e.outcome.includes('Used Vehicle Sold'))).length;
  return{contacts,warm,hot,appt,sold};
}

function funnelColor(pct,goodThresh,poorThresh){
  if(pct>=goodThresh)return{bg:'var(--green)',soft:'var(--green-soft)',text:'#2DD4A0',label:'Good'};
  if(pct>=poorThresh)return{bg:'var(--gold)',soft:'var(--gold-soft)',text:'#D4A73A',label:'Average'};
  return{bg:'var(--red)',soft:'var(--red-soft)',text:'#F87171',label:'Poor'};
}

function funnelPeriodLabel(){
  if(funnelPeriod==='week')return'this week';
  if(funnelPeriod==='month')return'this month';
  return'all time';
}

function filterByPeriod(data){
  const now=new Date();
  if(funnelPeriod==='week'){
    const d=now.getDay();const diff=d===0?6:d-1;
    const start=new Date(now);start.setDate(start.getDate()-diff);start.setHours(0,0,0,0);
    return data.filter(e=>e.created_at&&new Date(e.created_at)>=start);
  }
  if(funnelPeriod==='month'){
    const start=new Date(now.getFullYear(),now.getMonth(),1);
    return data.filter(e=>e.created_at&&new Date(e.created_at)>=start);
  }
  return data;
}

function renderFunnel(){
  const filtered=filterByPeriod(ALL);
  const d=getFunnelData(filtered);
  const stages=[
    {name:'Contacts Logged',count:d.contacts,prev:d.contacts,good:100,poor:0,icon:'üìã',color:'var(--blue)'},
    {name:'Warm+ Leads',count:d.warm,prev:d.contacts,good:40,poor:20,icon:'üå°Ô∏è',color:'var(--gold)'},
    {name:'Hot Leads',count:d.hot,prev:d.warm,good:35,poor:15,icon:'üî•',color:'var(--red)'},
    {name:'Appointments Set',count:d.appt,prev:d.hot,good:25,poor:10,icon:'üìÖ',color:'var(--green)'},
    {name:'Vehicles Sold',count:d.sold,prev:d.appt,good:60,poor:30,icon:'üöó',color:'var(--purple)'},
  ];

  // Revenue
  const revenue=d.sold*2800;
  const revenueStr=revenue.toLocaleString('en-US',{style:'currency',currency:'USD',minimumFractionDigits:0});
  document.getElementById('fnl-revenue').innerHTML=`
    <div class="fnl-rev">
      <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;">
        <div>
          <div style="font-size:10px;font-weight:700;letter-spacing:0.14em;text-transform:uppercase;color:var(--text3);margin-bottom:6px;">Estimated S2S Revenue</div>
          <div class="fnl-rev-v">${revenueStr}</div>
          <div class="fnl-rev-l">ServiceBridge generated an estimated <strong style="color:var(--green);">${revenueStr}</strong> in front-end gross ${funnelPeriodLabel()}</div>
          <div class="fnl-rev-n">(Based on $2,800 avg gross ‚Äî verify against actuals in DMS)</div>
        </div>
        <div style="text-align:center;">
          <div style="font-family:'Instrument Serif',Georgia,serif;font-size:48px;color:${d.sold>0?'var(--green)':'var(--text3)'};">${d.sold}</div>
          <div style="font-size:11px;color:var(--text3);text-transform:uppercase;letter-spacing:0.1em;">Units Sold</div>
        </div>
      </div>
    </div>`;

  // Team funnel
  const maxCount=Math.max(d.contacts,1);
  let teamHtml='<div class="fnl-card"><div class="fnl-card-t">Conversion Funnel ‚Äî '+funnelPeriodLabel().replace(/^\w/,c=>c.toUpperCase())+'</div>';
  stages.forEach((s,i)=>{
    const pct=i===0?100:(s.prev>0?Math.round((s.count/s.prev)*100):0);
    const c=i===0?{bg:'var(--blue)',soft:'var(--blue-soft)',text:'#818CF8',label:'‚Äî'}:funnelColor(pct,s.good,s.poor);
    const barW=Math.max((s.count/maxCount)*100,2);
    const dropoff=i>0&&s.prev>0?s.prev-s.count:0;
    teamHtml+=`
      <div class="fnl-stage">
        <div class="fnl-arrow"></div>
        <div class="fnl-num" style="background:${c.bg};">${i+1}</div>
        <div class="fnl-info">
          <div class="fnl-name">${s.icon} ${s.name}</div>
          <div class="fnl-meta">
            <span class="fnl-count">${s.count}</span>
            ${i>0?`<span class="fnl-pct" style="background:${c.soft};color:${c.text};">${pct}%</span>`:''}
            ${dropoff>0?`<span class="fnl-drop">‚Üì ${dropoff} dropped</span>`:''}
          </div>
        </div>
        <div class="fnl-bar-wrap"><div class="fnl-bar" style="width:${barW}%;background:${c.bg};"></div></div>
      </div>`;
  });
  teamHtml+='</div>';
  document.getElementById('fnl-team-view').innerHTML=teamHtml;

  // Per-rep comparison
  const reps={};
  filtered.forEach(e=>{const r=e.submitter||'Unknown';if(!reps[r])reps[r]=[];reps[r].push(e);});
  const repNames=Object.keys(reps).sort((a,b)=>reps[b].length-reps[a].length);

  // Find best performer at each stage
  const bestAt={contacts:'',warm:'',hot:'',appt:'',sold:''};
  let bestVals={contacts:0,warm:0,hot:0,appt:0,sold:0};
  repNames.forEach(name=>{
    const rd=getFunnelData(reps[name]);
    if(rd.contacts>bestVals.contacts){bestVals.contacts=rd.contacts;bestAt.contacts=name;}
    if(rd.warm>bestVals.warm){bestVals.warm=rd.warm;bestAt.warm=name;}
    if(rd.hot>bestVals.hot){bestVals.hot=rd.hot;bestAt.hot=name;}
    if(rd.appt>bestVals.appt){bestVals.appt=rd.appt;bestAt.appt=name;}
    if(rd.sold>bestVals.sold){bestVals.sold=rd.sold;bestAt.sold=name;}
  });

  const miniStages=[
    {key:'contacts',label:'Contacts',color:'var(--blue)'},
    {key:'warm',label:'Warm+',color:'var(--gold)'},
    {key:'hot',label:'Hot',color:'var(--red)'},
    {key:'appt',label:'Appt Set',color:'var(--green)'},
    {key:'sold',label:'Sold',color:'var(--purple)'},
  ];

  let repHtml='<div class="fnl-rep-grid">';
  repNames.forEach(name=>{
    const rd=getFunnelData(reps[name]);
    const vals={contacts:rd.contacts,warm:rd.warm,hot:rd.hot,appt:rd.appt,sold:rd.sold};
    const maxV=Math.max(rd.contacts,1);
    const badges=[];
    Object.keys(bestAt).forEach(k=>{if(bestAt[k]===name&&bestVals[k]>0)badges.push(k);});
    const badgeHtml=badges.length>0?`<span class="fnl-rep-best">‚òÖ Best ${badges[0]}</span>`:'';

    repHtml+=`<div class="fnl-rep-card">${badgeHtml}<div class="fnl-rep-name">${name}</div>`;
    miniStages.forEach((s,i)=>{
      const count=vals[s.key];
      const prev=i===0?count:(i===1?vals.contacts:i===2?vals.warm:i===3?vals.hot:vals.appt);
      const pct=i===0?'':prev>0?Math.round((count/prev)*100)+'%':'0%';
      const barW=Math.max((count/maxV)*100,2);
      const c=i===0?{soft:'var(--blue-soft)',text:'#818CF8'}:
              (prev>0&&(count/prev)*100>=[0,40,35,25,60][i])?{soft:'var(--green-soft)',text:'#2DD4A0'}:
              (prev>0&&(count/prev)*100>=[0,20,15,10,30][i])?{soft:'var(--gold-soft)',text:'#D4A73A'}:
              {soft:'var(--red-soft)',text:'#F87171'};
      repHtml+=`
        <div class="fnl-mini-stage">
          <div class="fnl-mini-label">${s.label}</div>
          <div class="fnl-mini-bar-wrap"><div class="fnl-mini-bar" style="width:${barW}%;background:${s.color};"></div></div>
          <div class="fnl-mini-count">${count}</div>
          ${i>0?`<div class="fnl-mini-pct" style="background:${c.soft};color:${c.text};">${pct}</div>`:''}
        </div>`;
    });
    repHtml+='</div>';
  });
  repHtml+='</div>';
  document.getElementById('fnl-rep-view').innerHTML=repNames.length>0?repHtml:'<div style="color:var(--text3);text-align:center;padding:32px;">No data for this period</div>';
}

// Reports
function setRange(days){
  const to=new Date();
  document.getElementById('rpt-to').value=to.toISOString().slice(0,10);
  if(days===0){document.getElementById('rpt-from').value='2024-01-01';}
  else{const fr=new Date(to);fr.setDate(fr.getDate()-days);document.getElementById('rpt-from').value=fr.toISOString().slice(0,10);}
  runReport();
}

function runReport(){
  const from=document.getElementById('rpt-from').value;
  const to=document.getElementById('rpt-to').value;
  const repF=document.getElementById('rpt-rep').value;
  const outF=document.getElementById('rpt-outcome').value;
  let data=ALL.filter(e=>{
    if(!e.created_at)return true;
    const d=e.created_at.slice(0,10);
    if(from&&d<from)return false;if(to&&d>to)return false;
    if(repF&&e.submitter!==repF)return false;
    if(outF){if(outF==='Sold')return e.outcome&&(e.outcome.includes('New')||e.outcome.includes('Used'));return e.outcome===outF;}
    return true;
  });
  const n=data.length;
  const sold=data.filter(e=>e.outcome&&(e.outcome.includes('New')||e.outcome.includes('Used'))).length;
  const hot=data.filter(e=>parseInt(e.eng_score)>=8).length;
  const appt=data.filter(e=>e.outcome==='Appointment Set').length;
  const temps=data.map(e=>parseInt(e.eng_score)).filter(t=>!isNaN(t));
  const avg=temps.length?(temps.reduce((a,b)=>a+b,0)/temps.length).toFixed(1):'‚Äî';
  const colors=['var(--blue)','var(--red)','var(--green)','var(--orange)','var(--gold)'];
  document.getElementById('rpt-kpis').innerHTML=[
    ['Total Contacts',n],['Hot Leads',hot],['Sold',sold],['Appointments',appt],['Avg Temp',avg]
  ].map(([l,v],i)=>`<div class="rkpi" style="--c:${colors[i]};"><div style="position:absolute;top:0;left:0;right:0;height:2px;background:${colors[i]};"></div><div class="rkpi-l">${l}</div><div class="rkpi-v" style="color:${colors[i]};">${v}</div></div>`).join('');

  // Rep bars
  const reps={};data.forEach(e=>{const s=e.submitter||'Unknown';reps[s]=(reps[s]||0)+1;});
  const maxR=Math.max(...Object.values(reps),1);
  const repColors={'Tyler Doyle':'var(--gold)','Andrew Kirk':'var(--blue)','DJ Rogers':'var(--green)','Kody McCann':'var(--red)'};
  document.getElementById('chart-rep').innerHTML=Object.entries(reps).sort((a,b)=>b[1]-a[1]).map(([name,count])=>`<div class="rpt-bar-row"><div class="rpt-bar-label">${name}</div><div class="rpt-bar-wrap"><div class="rpt-bar" style="width:${(count/maxR)*100}%;background:${repColors[name]||'var(--purple)'};"></div></div><div class="rpt-bar-count">${count}</div></div>`).join('')||'<div style="color:var(--text3);font-size:12px;padding:12px;">No data</div>';

  // Outcome bars
  const outcomes={};data.forEach(e=>{const o=e.outcome||'Pending';outcomes[o]=(outcomes[o]||0)+1;});
  const maxO=Math.max(...Object.values(outcomes),1);
  const oColors={'New Vehicle Sold':'var(--green)','Used Vehicle Sold':'var(--green)','Appointment Set':'var(--blue)','Follow-Up Required':'var(--gold)','Not Interested':'var(--text3)'};
  document.getElementById('chart-outcome').innerHTML=Object.entries(outcomes).sort((a,b)=>b[1]-a[1]).map(([name,count])=>`<div class="rpt-bar-row"><div class="rpt-bar-label">${name}</div><div class="rpt-bar-wrap"><div class="rpt-bar" style="width:${(count/maxO)*100}%;background:${oColors[name]||'var(--purple)'};"></div></div><div class="rpt-bar-count">${count}</div></div>`).join('')||'<div style="color:var(--text3);font-size:12px;padding:12px;">No data</div>';
}

// Exports
function exportCSV(){
  if(!ALL.length)return alert('No entries.');
  const keys=Object.keys(ALL[0]);
  const csv=[keys.join(','),...ALL.map(e=>keys.map(k=>`"${(e[k]??'').toString().replace(/"/g,'""')}"`).join(','))].join('\n');
  const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'}));a.download=`s2s-dashboard-${new Date().toISOString().slice(0,10)}.csv`;a.click();
}
function exportPrint(){
  const date=new Date().toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
  const rows=ALL.map(e=>`<tr><td>${e.submitter||'‚Äî'}</td><td>${e.first_name||''} ${e.last_name||''}</td><td>${e.phone||'‚Äî'}</td><td>${[e.veh_year,e.veh_make,e.veh_model].filter(Boolean).join(' ')||'‚Äî'}</td><td style="text-align:center;font-weight:700;">${e.eng_score||'‚Äî'}</td><td>${e.outcome||'‚Äî'}</td><td>${e.manager_claimed_by||'Unclaimed'}</td><td>${e.followup_status||'‚Äî'}</td></tr>`).join('');
  const w=window.open('','_blank');
  w.document.write(`<!DOCTYPE html><html><head><title>S2S Dashboard</title><style>body{font-family:Arial,sans-serif;font-size:11px;padding:24px;}h1{font-size:18px;margin-bottom:4px;}.sub{color:#666;font-size:12px;margin-bottom:16px;}table{width:100%;border-collapse:collapse;}th{background:#0C0C14;color:#fff;padding:8px 10px;text-align:left;font-size:10px;text-transform:uppercase;letter-spacing:0.08em;}td{padding:7px 10px;border-bottom:1px solid #eee;}tr:nth-child(even) td{background:#f9f9f9;}</style></head><body><h1>ServiceBridge ‚Äî Dashboard Export</h1><div class="sub">Gallatin CDJR ¬∑ ${date} ¬∑ ${ALL.length} entries</div><table><thead><tr><th>Rep</th><th>Customer</th><th>Phone</th><th>Vehicle</th><th>Temp</th><th>Outcome</th><th>Claimed By</th><th>Follow-Up</th></tr></thead><tbody>${rows}</tbody></table></body></html>`);
  w.document.close();setTimeout(()=>w.print(),500);
}

function showToast(msg,cls){const t=document.getElementById('toast');t.textContent=msg;t.className='toast show'+(cls?' '+cls:'');setTimeout(()=>t.className='toast',3000);}

// ‚ïê‚ïê‚ïê FOLLOW-UP SYSTEM ‚ïê‚ïê‚ïê
let FU_LOG=[];

async function loadFollowUpLog(){
  try{const res=await fetch(`${SB_URL}/rest/v1/s2s_followup_log?select=*&order=created_at.desc&limit=500`,{headers:H});if(res.ok)FU_LOG=await res.json();}catch(e){console.error(e);}
}

function todayStr(){return new Date().toISOString().slice(0,10);}

function getFollowUpEntries(){
  const today=todayStr();
  const needsFollowUp=ALL.filter(e=>{
    if(!e.next_followup_date)return false;
    if(e.follow_up_status==='Complete'||e.follow_up_status==='No Response')return false;
    if(e.manager_outcome&&(e.manager_outcome.includes('Lost')||e.manager_outcome==='Verified Sold'))return false;
    return true;
  });
  const overdue=needsFollowUp.filter(e=>e.next_followup_date<today).sort((a,b)=>a.next_followup_date.localeCompare(b.next_followup_date));
  const todayList=needsFollowUp.filter(e=>e.next_followup_date===today);
  const upcoming=needsFollowUp.filter(e=>e.next_followup_date>today).sort((a,b)=>a.next_followup_date.localeCompare(b.next_followup_date));
  const complete=ALL.filter(e=>e.follow_up_status==='Complete').length;
  return{overdue,today:todayList,upcoming,complete};
}

function renderFollowUps(){
  const{overdue,today:todayList,upcoming,complete}=getFollowUpEntries();
  document.getElementById('fu-overdue').textContent=overdue.length;
  document.getElementById('fu-today').textContent=todayList.length;
  document.getElementById('fu-upcoming').textContent=upcoming.length;
  document.getElementById('fu-complete').textContent=complete;

  function renderSection(containerId,items,label,badgeCls,cardCls,dueCls){
    const el=document.getElementById(containerId);
    if(!items.length){el.innerHTML='';return;}
    el.innerHTML=`<div class="fu-sec"><div class="fu-sec-hdr"><div class="fu-sec-t">${label}</div><span class="fu-sec-badge ${badgeCls}">${items.length}</span></div>${items.map(e=>renderFUCard(e,cardCls,dueCls)).join('')}</div>`;
  }

  renderSection('fu-overdue-sec',overdue,'üö® Overdue','b-red','overdue','d-over');
  renderSection('fu-today-sec',todayList,'üìå Due Today','b-gold','today','d-today');
  renderSection('fu-upcoming-sec',upcoming,'üìÖ Upcoming','b-blue','upcoming','d-soon');
}

function renderFUCard(e,cardCls,dueCls){
  const sc=parseInt(e.eng_score)||0;
  const tempCls=sc>=8?'fu-t-hot':sc>=5?'fu-t-warm':'fu-t-cool';
  const veh=[e.veh_year,e.veh_make,e.veh_model].filter(Boolean).join(' ')||'‚Äî';
  const daysUntil=Math.round((new Date(e.next_followup_date)-new Date(todayStr()))/(86400000));
  const dueLabel=daysUntil<0?`${Math.abs(daysUntil)}d overdue`:daysUntil===0?'Today':`In ${daysUntil}d`;
  const logs=FU_LOG.filter(l=>l.entry_id===e.id);
  const tmrw=new Date();tmrw.setDate(tmrw.getDate()+1);
  const nextDefault=tmrw.toISOString().slice(0,10);

  return`<div class="fu-card ${cardCls}">
    <div class="fu-top" onclick="document.getElementById('fue-${e.id}').classList.toggle('open')">
      <div class="fu-left">
        <div class="fu-cust">${e.first_name||''} ${e.last_name||''} <span class="fu-temp ${tempCls}">${sc}/10</span></div>
        <div class="fu-meta">${veh} ¬∑ ${e.submitter||'‚Äî'} ¬∑ ${e.phone||'‚Äî'}${e.outcome?' ¬∑ '+e.outcome:''}</div>
      </div>
      <div class="fu-right">
        <div class="fu-due ${dueCls}">${dueLabel}</div>
      </div>
    </div>
    <div class="fu-expand" id="fue-${e.id}">
      <div style="font-size:10px;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;color:var(--text3);margin-bottom:8px;">Log Activity</div>
      <div class="fu-actions">
        <button class="fu-abtn a-call" onclick="logFU(${e.id},'Called','Phone')">üìû Called</button>
        <button class="fu-abtn a-text" onclick="logFU(${e.id},'Texted','Text')">üí¨ Texted</button>
        <button class="fu-abtn a-email" onclick="logFU(${e.id},'Emailed','Email')">‚úâÔ∏è Emailed</button>
        <button class="fu-abtn a-done" onclick="logFU(${e.id},'Closed ‚Äî Sold','Done')">‚úì Sold</button>
        <button class="fu-abtn a-done" onclick="logFU(${e.id},'Appointment Confirmed','Done')">üìÖ Appt Set</button>
        <button class="fu-abtn a-lost" onclick="logFU(${e.id},'Lost ‚Äî No Response','Lost')">‚úó Lost</button>
      </div>
      <div class="fu-sched">
        <span style="font-size:11px;font-weight:600;color:var(--text3);">Next follow-up:</span>
        <input type="date" id="fud-${e.id}" value="${nextDefault}">
        <button class="fu-abtn" onclick="scheduleFU(${e.id})" style="font-size:11px;">Set Date</button>
      </div>
      <textarea class="fu-note" id="fun-${e.id}" placeholder="Add notes about this follow-up..." rows="2"></textarea>
      ${logs.length?`<div class="fu-timeline"><div class="fu-tl-t">Activity Timeline (${logs.length})</div>${logs.slice(0,8).map(l=>{
        const cls=l.method==='Phone'?'tl-call':l.method==='Text'?'tl-text':l.method==='Email'?'tl-email':l.outcome&&l.outcome.includes('Lost')?'tl-lost':'tl-done';
        const d=new Date(l.created_at);
        return`<div class="fu-tl-item ${cls}"><div class="fu-tl-date">${d.toLocaleDateString('en-US',{month:'short',day:'numeric'})}</div><div><div class="fu-tl-act">${l.action}</div>${l.notes?`<div class="fu-tl-note">${l.notes}</div>`:''}${l.next_date?`<div class="fu-tl-note">‚Üí Next: ${l.next_date}</div>`:''}<div class="fu-tl-by">by ${l.logged_by}</div></div></div>`;
      }).join('')}${logs.length>8?`<div style="font-size:11px;color:var(--text3);padding-left:16px;">+ ${logs.length-8} more</div>`:''}</div>`:'<div style="font-size:11px;color:var(--text3);font-style:italic;">No activity logged yet</div>'}
    </div>
  </div>`;
}

async function logFU(entryId,action,method){
  const notes=document.getElementById('fun-'+entryId).value.trim();
  const nextDate=document.getElementById('fud-'+entryId).value||null;
  const logBy=rep?rep.name:'Manager';

  // Determine if this is a closing action
  const isClose=action.includes('Sold')||action.includes('Confirmed')||action.includes('Lost');
  const newStatus=isClose?(action.includes('Lost')?'No Response':'Complete'):'Contacted';
  const mgrOutcome=action.includes('Sold')?'Verified Sold':action.includes('Confirmed')?'Appointment Confirmed':action.includes('Lost')?'Lost ‚Äî No Follow-Up':null;

  // Insert activity log
  await fetch(`${SB_URL}/rest/v1/s2s_followup_log`,{method:'POST',headers:{...H,'Prefer':'return=minimal'},body:JSON.stringify({entry_id:entryId,action,method:method||null,notes:notes||null,logged_by:logBy,next_date:isClose?null:nextDate,outcome:isClose?action:null})});

  // Update the entry
  const patch={follow_up_status:newStatus,followup_count:(ALL.find(x=>x.id===entryId)?.followup_count||0)+1};
  if(!isClose&&nextDate) patch.next_followup_date=nextDate;
  if(isClose){patch.next_followup_date=null;if(mgrOutcome)patch.manager_outcome=mgrOutcome;}
  if(notes) patch.manager_notes=notes;

  await fetch(`${SB_URL}/rest/v1/s2s_entries?id=eq.${entryId}`,{method:'PATCH',headers:H,body:JSON.stringify(patch)});

  // Update local state
  const entry=ALL.find(x=>x.id===entryId);
  if(entry) Object.assign(entry,patch);
  FU_LOG.unshift({entry_id:entryId,action,method,notes:notes||null,logged_by:logBy,next_date:isClose?null:nextDate,outcome:isClose?action:null,created_at:new Date().toISOString()});

  document.getElementById('fun-'+entryId).value='';
  renderFollowUps();renderKPIs();
  showToast(`‚úì ${action} logged for #${entryId}`,'grn');
}

async function scheduleFU(entryId){
  const nextDate=document.getElementById('fud-'+entryId).value;
  if(!nextDate){showToast('Select a date first');return;}
  await fetch(`${SB_URL}/rest/v1/s2s_entries?id=eq.${entryId}`,{method:'PATCH',headers:H,body:JSON.stringify({next_followup_date:nextDate})});
  const entry=ALL.find(x=>x.id===entryId);if(entry)entry.next_followup_date=nextDate;
  // Log the schedule action
  const logBy=rep?rep.name:'Manager';
  await fetch(`${SB_URL}/rest/v1/s2s_followup_log`,{method:'POST',headers:{...H,'Prefer':'return=minimal'},body:JSON.stringify({entry_id:entryId,action:'Follow-up scheduled',logged_by:logBy,next_date:nextDate})});
  FU_LOG.unshift({entry_id:entryId,action:'Follow-up scheduled',logged_by:logBy,next_date:nextDate,created_at:new Date().toISOString()});
  renderFollowUps();showToast(`‚úì Follow-up scheduled for ${nextDate}`,'grn');
}

// ‚ïê‚ïê‚ïê MARK WORKED MODAL ‚ïê‚ïê‚ïê
function openMW(fuId,entryId,custName){
  document.getElementById('mw-fuid').value=fuId;
  document.getElementById('mw-sub').textContent=`${custName} ¬∑ Entry #${entryId}`;
  document.getElementById('mw-note').value='';
  document.getElementById('mw-modal').classList.add('open');
}
function closeMW(){document.getElementById('mw-modal').classList.remove('open');}
document.getElementById('mw-modal').addEventListener('click',function(ev){if(ev.target===this)closeMW();});

async function submitMW(){
  const fuId=document.getElementById('mw-fuid').value;
  const note=document.getElementById('mw-note').value.trim();
  const worker=rep?rep.name:'Unknown';
  const btn=document.getElementById('mw-save');
  btn.textContent='Saving...';btn.disabled=true;
  try{
    const res=await fetch(`${SB_URL}/rest/v1/rpc/complete_followup`,{
      method:'POST',headers:H,
      body:JSON.stringify({p_followup_id:fuId,p_worker:worker,p_note:note||null})
    });
    if(!res.ok){const err=await res.json();showToast('Error: '+(err.message||'Failed'));btn.textContent='‚úì Mark Worked';btn.disabled=false;return;}
    const data=await res.json();
    // Update local state
    const task=TASKS.find(t=>t.id===fuId);
    if(task){task.completed_at=new Date().toISOString();task.completed_by=worker;task.outcome_note=note;}
    if(data.entry_id){const entry=ALL.find(x=>x.id===data.entry_id);if(entry)entry.follow_up_status='Complete';}
    closeMW();renderEntries();renderKPIs();showToast('‚úì Follow-up marked as worked','grn');
  }catch(e){showToast('Error: '+e.message);}
  btn.textContent='‚úì Mark Worked';btn.disabled=false;
}

// ‚ïê‚ïê‚ïê QUEUE SYSTEM ‚ïê‚ïê‚ïê
let ACTIVE_REPS=[];

async function loadActiveReps(){
  try{const res=await fetch(`${SB_URL}/rest/v1/sb_users_public?active=eq.true&select=name,first_name,role&order=name`,{headers:H});if(res.ok)ACTIVE_REPS=await res.json();}catch(e){console.error(e);}
}

function fmtElapsed(ms){
  const m=Math.abs(Math.floor(ms/60000));
  if(m<60) return m+'m';
  const h=Math.floor(m/60),rm=m%60;
  if(h<24) return h+'h '+(rm>0?rm+'m':'');
  const d=Math.floor(h/24);return d+'d '+h%24+'h';
}

function getQueueData(){
  const now=Date.now();
  const open=TASKS.filter(t=>!t.completed_at);
  const hotOpen=open.filter(t=>{
    const e=ALL.find(x=>x.id===t.entry_id);
    return e&&parseInt(e.eng_score)>=8;
  }).sort((a,b)=>new Date(a.due_at)-new Date(b.due_at));
  const allOverdue=open.filter(t=>new Date(t.due_at).getTime()<now)
    .sort((a,b)=>new Date(a.due_at)-new Date(b.due_at));
  const todayStart=new Date();todayStart.setHours(0,0,0,0);
  const workedToday=TASKS.filter(t=>t.completed_at&&new Date(t.completed_at)>=todayStart).length;
  return{hotOpen,allOverdue,workedToday};
}

function updateQueueBadge(){
  const{hotOpen}=getQueueData();
  document.getElementById('badge-queue').textContent=hotOpen.length;
}

function renderQueue(){
  const{hotOpen,allOverdue,workedToday}=getQueueData();
  document.getElementById('q-hot').textContent=hotOpen.length;
  document.getElementById('q-overdue').textContent=allOverdue.length;
  document.getElementById('q-worked').textContent=workedToday;

  function renderQSec(containerId,items,label,badgeCls){
    const el=document.getElementById(containerId);
    if(!items.length){el.innerHTML=`<div class="q-sec"><div class="q-sec-hdr"><div class="q-sec-left"><div class="q-sec-t">${label}</div><span class="q-sec-badge ${badgeCls}">0</span></div></div><div class="q-empty">All clear ‚Äî nothing here üéâ</div></div>`;return;}
    el.innerHTML=`<div class="q-sec"><div class="q-sec-hdr"><div class="q-sec-left"><div class="q-sec-t">${label}</div><span class="q-sec-badge ${badgeCls}">${items.length}</span></div></div>${items.map(t=>renderQCard(t)).join('')}</div>`;
  }
  renderQSec('q-hot-sec',hotOpen,'üî• Hot Unworked','qb-red');
  // Filter allOverdue to exclude those already shown in hot queue
  const hotIds=new Set(hotOpen.map(t=>t.id));
  const overdueOnly=allOverdue.filter(t=>!hotIds.has(t.id));
  renderQSec('q-overdue-sec',overdueOnly,'‚è∞ All Overdue','qb-gold');
}

function renderQCard(t){
  const e=ALL.find(x=>x.id===t.entry_id);
  if(!e) return '';
  const sc=parseInt(e.eng_score)||0;
  const tempCls=sc>=8?'qt-hot':sc>=5?'qt-warm':'qt-cool';
  const veh=[e.veh_year,e.veh_make,e.veh_model].filter(Boolean).join(' ')||'‚Äî';
  const now=Date.now(),due=new Date(t.due_at).getTime();
  const diff=due-now;
  const isOverdue=diff<=0;
  const cardCls=isOverdue?'qc-overdue':sc>=8?'qc-hot':'qc-warm';
  let dueLbl,dueCls;
  if(isOverdue){dueLbl='Overdue '+fmtElapsed(Math.abs(diff));dueCls='qd-over';}
  else if(diff<1800000){dueLbl='Due in '+fmtElapsed(diff);dueCls='qd-hot';}
  else if(diff<7200000){dueLbl='Due in '+fmtElapsed(diff);dueCls='qd-warm';}
  else{dueLbl='Due in '+fmtElapsed(diff);dueCls='qd-cool';}
  const created=e.created_at?new Date(e.created_at):new Date();
  const elapsed=fmtElapsed(now-created.getTime());
  const repsHtml=ACTIVE_REPS.filter(r=>r.name!==t.assigned_to).map(r=>{
    const ini=r.name.split(' ').map(w=>w[0]).join('');
    return `<div class="qc-reassign-opt" onclick="reassignTask('${t.id}',${e.id},'${r.name.replace(/'/g,"\\'")}',this)"><div class="qc-reassign-av">${ini}</div>${r.first_name||r.name}</div>`;
  }).join('');

  return`<div class="qc ${cardCls}" id="qc-${t.id}">
    <div class="qc-top">
      <div class="qc-temp ${tempCls}"><div class="qc-temp-n">${sc}</div><div class="qc-temp-l">temp</div></div>
      <div class="qc-info">
        <div class="qc-name">${e.first_name||''} ${e.last_name||''}</div>
        <div class="qc-meta">üöó ${veh} ¬∑ üë§ ${t.assigned_to} ¬∑ ${e.phone||'‚Äî'}</div>
      </div>
      <div class="qc-right">
        <div class="qc-due ${dueCls}">${dueLbl}</div>
        <div class="qc-elapsed">‚è± ${elapsed} ago</div>
      </div>
    </div>
    <div class="qc-actions">
      <button class="qc-btn qb-work" onclick="openMW('${t.id}',${e.id},'${(e.first_name||'').replace(/'/g,"\\'")} ${(e.last_name||'').replace(/'/g,"\\'")}')">‚úì Mark Worked</button>
      <div class="qc-reassign-wrap">
        <button class="qc-btn" onclick="toggleReassign('${t.id}')">‚Üª Reassign</button>
        <div class="qc-reassign-dd" id="qrd-${t.id}">${repsHtml}</div>
      </div>
      <button class="qc-btn qb-view" onclick="openEdit(${e.id})">View Entry</button>
    </div>
  </div>`;
}

function toggleReassign(taskId){
  // Close all other open dropdowns first
  document.querySelectorAll('.qc-reassign-dd.open').forEach(dd=>{if(dd.id!=='qrd-'+taskId)dd.classList.remove('open');});
  document.getElementById('qrd-'+taskId).classList.toggle('open');
}
// Close reassign dropdowns on outside click
document.addEventListener('click',function(ev){
  if(!ev.target.closest('.qc-reassign-wrap')) document.querySelectorAll('.qc-reassign-dd.open').forEach(dd=>dd.classList.remove('open'));
});

async function reassignTask(taskId,entryId,newRep,optEl){
  try{
    await Promise.all([
      fetch(`${SB_URL}/rest/v1/s2s_followups?id=eq.${taskId}`,{method:'PATCH',headers:H,body:JSON.stringify({assigned_to:newRep})}),
      fetch(`${SB_URL}/rest/v1/s2s_entries?id=eq.${entryId}`,{method:'PATCH',headers:H,body:JSON.stringify({submitter:newRep})})
    ]);
    const task=TASKS.find(x=>x.id===taskId);if(task)task.assigned_to=newRep;
    const entry=ALL.find(x=>x.id===entryId);if(entry)entry.submitter=newRep;
    document.querySelectorAll('.qc-reassign-dd.open').forEach(dd=>dd.classList.remove('open'));
    renderQueue();renderEntries();updateQueueBadge();
    showToast(`‚úì Lead reassigned to ${newRep.split(' ')[0]}`,'grn');
  }catch(e){showToast('Reassign failed: '+e.message);}
}

async function refreshQueue(){
  try{
    const[eRes,tRes]=await Promise.all([
      fetch(`${SB_URL}/rest/v1/s2s_entries?select=*&deleted_at=is.null&order=id.desc&limit=1000`,{headers:H}),
      fetch(`${SB_URL}/rest/v1/s2s_followups?select=*&order=due_at.desc&limit=2000`,{headers:H})
    ]);
    if(eRes.ok) ALL=await eRes.json();
    if(tRes.ok) TASKS=await tRes.json();
  }catch(e){console.error(e);}
  renderQueue();renderKPIs();renderEntries();updateQueueBadge();
  showToast('‚úì Queue refreshed');
}

// Auto-refresh every 60s
let _queueInterval=null;
function startQueueRefresh(){
  if(_queueInterval)clearInterval(_queueInterval);
  _queueInterval=setInterval(()=>{
    if(currentTab==='queue') renderQueue();
    updateQueueBadge();
  },60000);
}

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ
async function initDash(){
  await Promise.all([
    (async()=>{try{const res=await fetch(`${SB_URL}/rest/v1/s2s_entries?select=*&deleted_at=is.null&order=id.desc&limit=1000`,{headers:H});if(res.ok)ALL=await res.json();}catch(e){console.error(e);}})(),
    (async()=>{try{const res=await fetch(`${SB_URL}/rest/v1/s2s_followups?select=*&order=due_at.desc&limit=2000`,{headers:H});if(res.ok)TASKS=await res.json();}catch(e){console.error(e);}})(),
    loadFollowUpLog(),
    loadActiveReps()
  ]);
  renderKPIs();renderEntries();updateQueueBadge();
  const now=new Date(),d30=new Date(now);d30.setDate(d30.getDate()-30);
  document.getElementById('rpt-from').value=d30.toISOString().slice(0,10);
  document.getElementById('rpt-to').value=now.toISOString().slice(0,10);
  startQueueRefresh();
}

initDash();
</script>
</body>
</html>
