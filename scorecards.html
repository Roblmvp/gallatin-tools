<!DOCTYPE html>
<html lang="en">
<head>
<script>
(function(){
  var rep = null;
  try { rep = JSON.parse(sessionStorage.getItem('sb_rep') || 'null'); } catch(e) {}
  if (!rep || !rep.name || !rep.role) { window.location.replace('/login.html'); }
})();
</script>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#06080E">
<title>Scorecards â€” ServiceBridge</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Instrument+Serif:ital@0;1&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #06080E; --bg2: #0C0F18;
  --surface: #111520; --surface2: #171C2A; --surface3: #1D2333;
  --red: #E01B36; --red-soft: rgba(224,27,54,0.10);
  --gold: #D4A73A; --gold-soft: rgba(212,167,58,0.10);
  --green: #2DD4A0; --green-soft: rgba(45,212,160,0.10);
  --blue: #6C70F0; --blue-soft: rgba(108,112,240,0.10);
  --orange: #F59E0B; --orange-soft: rgba(245,158,11,0.10);
  --purple: #A855F7; --purple-soft: rgba(168,85,247,0.10);
  --text: #EDEEF2; --text2: rgba(237,238,242,0.62); --text3: rgba(237,238,242,0.34);
  --border: rgba(255,255,255,0.06); --border2: rgba(255,255,255,0.10); --border3: rgba(255,255,255,0.16);
  --r: 14px; --rsm: 10px; --rlg: 18px;
  --spring: cubic-bezier(0.16, 1, 0.3, 1);
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
html{scroll-behavior:smooth;}
body{background:var(--bg);color:var(--text);font-family:'Plus Jakarta Sans',-apple-system,sans-serif;min-height:100vh;overflow-x:hidden;-webkit-font-smoothing:antialiased;font-size:15px;line-height:1.5;letter-spacing:-0.01em;}
.bg-noise{position:fixed;inset:0;z-index:0;pointer-events:none;opacity:0.35;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E");}
.bg-grad{position:fixed;inset:0;z-index:0;pointer-events:none;background:radial-gradient(ellipse 60% 50% at 50% 0%,rgba(212,167,58,0.06) 0%,transparent 60%),radial-gradient(ellipse 50% 60% at 80% 100%,rgba(108,112,240,0.04) 0%,transparent 70%);}

/* Header */
.hdr{display:flex;align-items:center;justify-content:space-between;padding:14px 20px 12px;padding-top:max(14px,env(safe-area-inset-top));border-bottom:1px solid var(--border);background:rgba(6,8,14,0.92);backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);position:sticky;top:0;z-index:100;}
.hdr::after{content:'';position:absolute;bottom:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--gold),var(--red),transparent);opacity:0.5;}
.hdr-l{display:flex;align-items:center;gap:10px;}
.hdr-logo{width:30px;height:30px;background:var(--gold);border-radius:8px;display:flex;align-items:center;justify-content:center;}
.hdr-logo svg{width:14px;height:14px;}
.hdr-t{font-family:'Instrument Serif',Georgia,serif;font-size:17px;letter-spacing:-0.01em;}
.hdr-r{display:flex;align-items:center;gap:8px;position:relative;}
.hdr-user{font-size:11px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:0.1em;}
.ham{background:none;border:1px solid var(--border2);border-radius:8px;width:32px;height:32px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;cursor:pointer;transition:all 0.18s;padding:0;flex-shrink:0;}
.ham:hover{border-color:rgba(255,255,255,0.18);background:rgba(255,255,255,0.03);}
.ham span{display:block;width:14px;height:1.5px;background:rgba(255,255,255,0.55);border-radius:2px;transition:all 0.2s;}
.ham.open span:nth-child(1){transform:translateY(5.5px) rotate(45deg);}
.ham.open span:nth-child(2){opacity:0;}
.ham.open span:nth-child(3){transform:translateY(-5.5px) rotate(-45deg);}
.nav-ov{position:fixed;inset:0;z-index:190;display:none;}
.nav-ov.open{display:block;}
.nav-dd{position:absolute;top:calc(100% + 8px);right:0;background:var(--surface);border:1px solid var(--border2);border-radius:var(--r);min-width:230px;padding:6px;box-shadow:0 20px 60px rgba(0,0,0,0.6);z-index:201;opacity:0;transform:translateY(-8px) scale(0.97);pointer-events:none;transition:all 0.18s var(--spring);}
.nav-dd.open{opacity:1;transform:translateY(0) scale(1);pointer-events:all;}
.di{display:flex;align-items:center;gap:10px;padding:11px 14px;border-radius:var(--rsm);font-size:13px;font-weight:600;color:var(--text2);text-decoration:none;cursor:pointer;transition:all 0.15s;}
.di:hover{background:rgba(255,255,255,0.04);color:var(--text);}
.di.ap{background:var(--gold-soft);color:var(--gold);}
.di-ic{font-size:14px;width:20px;text-align:center;}
.ddv{height:1px;background:var(--border);margin:4px 0;}
.dd-admin{display:none;}.dd-admin.show{display:flex;}.ddv.dd-admin.show{display:block;}
.nui{display:flex;align-items:center;justify-content:space-between;padding:8px 14px 4px;}
.nud{font-size:11px;font-weight:700;color:var(--text3);letter-spacing:0.08em;}
.nrp{font-size:9px;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;padding:3px 8px;border-radius:20px;}
.r-admin{background:var(--blue-soft);color:var(--blue);border:1px solid rgba(108,112,240,0.2);}
.r-manager{background:var(--gold-soft);color:var(--gold);border:1px solid rgba(212,167,58,0.2);}
.r-sales{background:rgba(255,255,255,0.05);color:var(--text2);border:1px solid rgba(255,255,255,0.08);}

/* Page */
.page{max-width:1000px;margin:0 auto;padding:24px 20px 80px;position:relative;z-index:1;}

/* Period Tabs */
.ptabs{display:flex;gap:4px;margin-bottom:22px;background:var(--surface);border:1px solid var(--border);border-radius:var(--rsm);padding:4px;width:fit-content;}
.pt{padding:8px 18px;border-radius:7px;font-size:12px;font-weight:700;color:var(--text3);cursor:pointer;transition:all 0.18s;border:none;background:transparent;font-family:'Plus Jakarta Sans',sans-serif;white-space:nowrap;}
.pt.ac{background:var(--surface3);color:var(--text);}

/* Section Header */
.sh{display:flex;align-items:flex-end;justify-content:space-between;margin-bottom:16px;}
.sh-t{font-family:'Instrument Serif',Georgia,serif;font-size:28px;letter-spacing:-0.02em;line-height:1.1;}
.sh-s{font-size:12px;color:var(--text3);margin-top:3px;}
.sh-r{font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--text3);}

/* â•â•â• PODIUM â•â•â• */
.podium{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:28px;}
.pod{background:var(--surface);border:1px solid var(--border);border-radius:var(--rlg);padding:24px 20px;position:relative;overflow:hidden;text-align:center;transition:transform 0.2s var(--spring);}
.pod:hover{transform:translateY(-3px);}
.pod::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;}
.pod-1::before{background:linear-gradient(90deg,var(--gold),#E8C555);}
.pod-2::before{background:linear-gradient(90deg,#A0AEC0,#CBD5E1);}
.pod-3::before{background:linear-gradient(90deg,#CD7F32,#D4956A);}
.pod-1{order:2;} .pod-2{order:1;} .pod-3{order:3;}
.pod-rank{font-family:'JetBrains Mono',monospace;font-size:10px;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;margin-bottom:10px;}
.pod-1 .pod-rank{color:var(--gold);} .pod-2 .pod-rank{color:#94A3B8;} .pod-3 .pod-rank{color:#CD7F32;}
.pod-trophy{font-size:36px;margin-bottom:8px;line-height:1;}
.pod-avatar{width:56px;height:56px;border-radius:16px;margin:0 auto 12px;display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:700;color:#fff;font-family:'JetBrains Mono',monospace;border:2px solid var(--border);}
.pod-1 .pod-avatar{background:linear-gradient(135deg,var(--gold),var(--orange));border-color:rgba(212,167,58,0.4);box-shadow:0 8px 24px rgba(212,167,58,0.2);}
.pod-2 .pod-avatar{background:linear-gradient(135deg,#64748B,#94A3B8);border-color:rgba(148,163,184,0.3);}
.pod-3 .pod-avatar{background:linear-gradient(135deg,#CD7F32,#D4956A);border-color:rgba(205,127,50,0.3);}
.pod-name{font-family:'Instrument Serif',Georgia,serif;font-size:20px;margin-bottom:2px;color:var(--text);}
.pod-role{font-size:10px;font-weight:600;letter-spacing:0.04em;color:var(--text3);margin-bottom:14px;}
.pod-stats{display:grid;grid-template-columns:1fr 1fr;gap:6px;}
.pod-stat{background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:8px 6px;}
.pod-stat-v{font-family:'JetBrains Mono',monospace;font-size:18px;font-weight:700;line-height:1;}
.pod-1 .pod-stat-v{color:var(--gold);} .pod-2 .pod-stat-v{color:#94A3B8;} .pod-3 .pod-stat-v{color:#CD7F32;}
.pod-stat-l{font-size:8px;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;color:var(--text3);margin-top:2px;}
.pod-score{margin-top:10px;padding-top:10px;border-top:1px solid var(--border);}
.pod-score-lbl{font-size:9px;font-weight:700;letter-spacing:0.12em;text-transform:uppercase;color:var(--text3);margin-bottom:4px;}
.pod-score-bar{height:6px;background:rgba(255,255,255,0.06);border-radius:3px;overflow:hidden;}
.pod-score-fill{height:100%;border-radius:3px;transition:width 0.8s ease;}
.pod-score-val{font-family:'JetBrains Mono',monospace;font-size:12px;font-weight:700;margin-top:4px;}
.pod-1 .pod-score-val{color:var(--gold);} .pod-2 .pod-score-val{color:#94A3B8;} .pod-3 .pod-score-val{color:#CD7F32;}

/* â•â•â• FULL LEADERBOARD â•â•â• */
.lb{background:var(--surface);border:1px solid var(--border);border-radius:var(--rlg);overflow:hidden;margin-bottom:28px;}
.lb-head{display:grid;grid-template-columns:40px 1fr 80px 80px 80px 80px 100px;gap:8px;padding:12px 18px;background:var(--surface2);font-size:9px;font-weight:700;letter-spacing:0.12em;text-transform:uppercase;color:var(--text3);align-items:center;}
.lb-row{display:grid;grid-template-columns:40px 1fr 80px 80px 80px 80px 100px;gap:8px;padding:14px 18px;border-bottom:1px solid var(--border);align-items:center;transition:background 0.12s;}
.lb-row:hover{background:rgba(255,255,255,0.02);}
.lb-row:last-child{border-bottom:none;}
.lb-rank{font-family:'JetBrains Mono',monospace;font-size:14px;font-weight:700;text-align:center;}
.lb-rank.r1{color:var(--gold);} .lb-rank.r2{color:#94A3B8;} .lb-rank.r3{color:#CD7F32;} .lb-rank.r4{color:var(--text3);}
.lb-rep{display:flex;align-items:center;gap:10px;}
.lb-av{width:32px;height:32px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:#fff;font-family:'JetBrains Mono',monospace;flex-shrink:0;}
.lb-name{font-weight:700;font-size:14px;color:var(--text);}
.lb-sub{font-size:10px;color:var(--text3);margin-top:1px;}
.lb-val{font-family:'JetBrains Mono',monospace;font-size:14px;font-weight:600;text-align:center;color:var(--text);}
.lb-bar-wrap{display:flex;align-items:center;gap:8px;}
.lb-bar-bg{flex:1;height:6px;background:rgba(255,255,255,0.06);border-radius:3px;overflow:hidden;}
.lb-bar-fill{height:100%;border-radius:3px;transition:width 0.8s ease;}
.lb-bar-pct{font-family:'JetBrains Mono',monospace;font-size:11px;font-weight:600;min-width:36px;text-align:right;}

/* â•â•â• TREND CHARTS â•â•â• */
.trends{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px;margin-bottom:28px;}
.trend-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--rlg);padding:20px;overflow:hidden;}
.trend-title{font-size:10px;font-weight:700;letter-spacing:0.14em;text-transform:uppercase;color:var(--text3);margin-bottom:14px;}
.trend-bars{display:flex;align-items:flex-end;gap:4px;height:100px;}
.trend-col{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;}
.trend-bar{width:100%;border-radius:4px 4px 0 0;transition:height 0.6s ease;min-height:2px;}
.trend-lbl{font-size:8px;font-weight:600;color:var(--text3);letter-spacing:0.04em;white-space:nowrap;}
.trend-v{font-family:'JetBrains Mono',monospace;font-size:9px;font-weight:700;color:var(--text2);}

/* â•â•â• INSIGHTS â•â•â• */
.insights{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:28px;}
.insight{background:var(--surface);border:1px solid var(--border);border-radius:var(--rlg);padding:20px;position:relative;overflow:hidden;}
.insight::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;}
.ins-blue::before{background:var(--blue);} .ins-green::before{background:var(--green);}
.ins-gold::before{background:var(--gold);} .ins-red::before{background:var(--red);}
.insight-icon{font-size:24px;margin-bottom:10px;}
.insight-title{font-size:10px;font-weight:700;letter-spacing:0.14em;text-transform:uppercase;color:var(--text3);margin-bottom:6px;}
.insight-val{font-family:'Instrument Serif',Georgia,serif;font-size:32px;line-height:1;margin-bottom:4px;}
.ins-blue .insight-val{color:var(--blue);} .ins-green .insight-val{color:var(--green);}
.ins-gold .insight-val{color:var(--gold);} .ins-red .insight-val{color:#F87171;}
.insight-desc{font-size:12px;color:var(--text3);}

/* Loading / Empty */
.ld{text-align:center;padding:40px;color:var(--text3);font-size:13px;}
.sp{display:inline-block;width:16px;height:16px;border:2px solid var(--border2);border-top-color:var(--blue);border-radius:50%;animation:spin 0.7s linear infinite;margin-right:8px;vertical-align:middle;}
@keyframes spin{to{transform:rotate(360deg);}}
@keyframes fadeUp{from{opacity:0;transform:translateY(12px);}to{opacity:1;transform:translateY(0);}}
.fi{animation:fadeUp 0.4s ease both;}

@media(max-width:900px){.podium{grid-template-columns:1fr;}.pod-1,.pod-2,.pod-3{order:unset;}.lb-head,.lb-row{grid-template-columns:32px 1fr 60px 60px 60px 60px 80px;}.trends{grid-template-columns:1fr;}.insights{grid-template-columns:1fr;}}
@media(max-width:600px){.page{padding:18px 14px 80px;}.lb-head,.lb-row{grid-template-columns:28px 1fr 50px 50px;font-size:11px;}.lb-head>:nth-child(n+5),.lb-row>:nth-child(n+5){display:none;}}
</style>
</head>
<body>
<div class="bg-noise"></div>
<div class="bg-grad"></div>

<header class="hdr">
  <div class="hdr-l">
    <div class="hdr-logo"><svg viewBox="0 0 24 24" fill="none" stroke="#000" stroke-width="2.5" stroke-linecap="round"><path d="M6 9l6-6 6 6"/><path d="M12 3v14"/><path d="M5 21h14"/></svg></div>
    <div class="hdr-t">Scorecards</div>
  </div>
  <div class="hdr-r">
    <span class="hdr-user" id="hdr-user"></span>
    <button class="ham" id="ham" onclick="toggleMenu()" aria-label="Menu"><span></span><span></span><span></span></button>
    <div class="nav-dd" id="nav-dd">
      <div class="nui"><span class="nud" id="nud"></span><span class="nrp" id="nrp"></span></div>
      <div class="ddv"></div>
      <a href="app.html" class="di"><span class="di-ic">ğŸ </span> Home</a>
      <a href="service-to-sales-log.html" class="di"><span class="di-ic">ğŸ“‹</span> S2S Entry</a>
      <a href="manager-dashboard.html" class="di"><span class="di-ic">ğŸ“Š</span> Dashboard</a>
      <a href="scorecards.html" class="di ap"><span class="di-ic">ğŸ†</span> Scorecards</a>
      <div class="ddv dd-admin" id="ddv-admin"></div>
      <a href="admin-panel.html" class="di dd-admin" id="dd-admin"><span class="di-ic">âš™ï¸</span> Admin Panel</a>
    </div>
  </div>
</header>
<div class="nav-ov" id="nav-ov" onclick="closeMenu()"></div>

<div class="page">
  <div class="sh fi">
    <div>
      <div class="sh-t">Leaderboard</div>
      <div class="sh-s">Gallatin CDJR â€” S2S Performance Rankings</div>
    </div>
    <div class="sh-r" id="sync-label">â€”</div>
  </div>

  <div class="ptabs fi" style="animation-delay:0.05s;">
    <button class="pt ac" onclick="setPeriod('week',this)">This Week</button>
    <button class="pt" onclick="setPeriod('month',this)">This Month</button>
    <button class="pt" onclick="setPeriod('all',this)">All Time</button>
  </div>

  <!-- Podium -->
  <div class="podium fi" id="podium" style="animation-delay:0.1s;"><div class="ld"><span class="sp"></span> Loading...</div></div>

  <!-- Full Leaderboard -->
  <div class="lb fi" id="leaderboard" style="animation-delay:0.15s;"></div>

  <!-- Trend Charts -->
  <div style="margin-bottom:10px;"><div class="sh-s" style="font-size:10px;font-weight:700;letter-spacing:0.14em;text-transform:uppercase;color:var(--text3);">Weekly Trends</div></div>
  <div class="trends fi" id="trends" style="animation-delay:0.2s;"></div>

  <!-- Insights -->
  <div style="margin-bottom:10px;"><div class="sh-s" style="font-size:10px;font-weight:700;letter-spacing:0.14em;text-transform:uppercase;color:var(--text3);">Performance Insights</div></div>
  <div class="insights fi" id="insights" style="animation-delay:0.25s;"></div>
</div>

<script>
const SB_URL='https://jbkgwtohwsbaorhvuuqb.supabase.co';
const SB_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impia2d3dG9od3NiYW9yaHZ1dXFiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5NjkwNDIsImV4cCI6MjA4NzU0NTA0Mn0.GRXOYbIuVDxU9-FEBYmyd1QmytVUrMIAxbnOSfepzuU';
const H={'apikey':SB_KEY,'Authorization':'Bearer '+SB_KEY,'Content-Type':'application/json'};
const rep=JSON.parse(sessionStorage.getItem('sb_rep')||'null');
let ALL=[];let period='week';

const REP_COLORS={'Tyler Doyle':{bg:'linear-gradient(135deg,#D4A73A,#F59E0B)',bar:'var(--gold)'},'Andrew Kirk':{bg:'linear-gradient(135deg,#6C70F0,#A855F7)',bar:'var(--blue)'},'DJ Rogers':{bg:'linear-gradient(135deg,#2DD4A0,#14B8A6)',bar:'var(--green)'},'Kody McCann':{bg:'linear-gradient(135deg,#E01B36,#F87171)',bar:'var(--red)'}};
const REPS=['Tyler Doyle','Andrew Kirk','DJ Rogers','Kody McCann'];

// Nav
(function(){
  if(!rep)return;
  document.getElementById('hdr-user').textContent=rep.first_name||rep.name.split(' ')[0];
  document.getElementById('nud').textContent=rep.name;
  const p=document.getElementById('nrp');
  const r=(rep.role||'sales').toLowerCase();
  p.textContent=r.charAt(0).toUpperCase()+r.slice(1);
  p.className='nrp '+(r==='admin'?'r-admin':r==='manager'?'r-manager':'r-sales');
  if(r==='admin'){document.getElementById('dd-admin').classList.add('show');document.getElementById('ddv-admin').classList.add('show');}
})();
function toggleMenu(){const h=document.getElementById('ham'),d=document.getElementById('nav-dd'),o=document.getElementById('nav-ov');const op=d.classList.contains('open');h.classList.toggle('open',!op);d.classList.toggle('open',!op);o.classList.toggle('open',!op);}
function closeMenu(){document.getElementById('ham').classList.remove('open');document.getElementById('nav-dd').classList.remove('open');document.getElementById('nav-ov').classList.remove('open');}

// Init
async function init(){
  try{const res=await fetch(`${SB_URL}/rest/v1/s2s_entries?select=*&order=id.desc&limit=2000`,{headers:H});if(res.ok)ALL=await res.json();}catch(e){console.error(e);}
  document.getElementById('sync-label').textContent='Updated '+new Date().toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:true});
  render();
}

function setPeriod(p,btn){period=p;document.querySelectorAll('.pt').forEach(t=>t.classList.remove('ac'));btn.classList.add('ac');render();}

function getFiltered(){
  const now=new Date();
  if(period==='week'){const start=new Date(now);start.setDate(start.getDate()-start.getDay());start.setHours(0,0,0,0);return ALL.filter(e=>e.created_at&&new Date(e.created_at)>=start);}
  if(period==='month'){const start=new Date(now.getFullYear(),now.getMonth(),1);return ALL.filter(e=>e.created_at&&new Date(e.created_at)>=start);}
  return ALL;
}

function calcStats(entries){
  return REPS.map(name=>{
    const mine=entries.filter(e=>e.submitter===name);
    const contacts=mine.length;
    const sold=mine.filter(e=>e.outcome&&(e.outcome.includes('New')||e.outcome.includes('Used'))).length;
    const hot=mine.filter(e=>parseInt(e.eng_score)>=8).length;
    const appt=mine.filter(e=>e.outcome==='Appointment Set').length;
    const temps=mine.map(e=>parseInt(e.eng_score)).filter(t=>!isNaN(t));
    const avgTemp=temps.length?(temps.reduce((a,b)=>a+b,0)/temps.length):0;
    // Composite score: weighted formula favoring quality
    const score=Math.round((sold*40)+(appt*15)+(hot*10)+(contacts*5)+(avgTemp*3));
    return{name,contacts,sold,hot,appt,avgTemp:avgTemp.toFixed(1),score,initials:name.split(' ').map(w=>w[0]).join('')};
  }).sort((a,b)=>b.score-a.score);
}

function render(){
  const data=getFiltered();
  const stats=calcStats(data);
  renderPodium(stats);
  renderLeaderboard(stats);
  renderTrends(data);
  renderInsights(data,stats);
}

function renderPodium(stats){
  const el=document.getElementById('podium');
  if(stats.length<3){el.innerHTML='<div style="text-align:center;padding:30px;color:var(--text3);">Not enough reps for podium</div>';return;}
  const medals=['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'];
  const classes=['pod-1','pod-2','pod-3'];
  el.innerHTML=stats.slice(0,3).map((s,i)=>{
    const c=REP_COLORS[s.name]||{bg:'var(--surface3)',bar:'var(--purple)'};
    const maxScore=stats[0].score||1;
    return`<div class="pod ${classes[i]}">
      <div class="pod-rank">${['1st Place','2nd Place','3rd Place'][i]}</div>
      <div class="pod-trophy">${medals[i]}</div>
      <div class="pod-avatar" style="background:${c.bg};">${s.initials}</div>
      <div class="pod-name">${s.name}</div>
      <div class="pod-role">${s.name==='Tyler Doyle'?'S2S Manager':'Sales Consultant'}</div>
      <div class="pod-stats">
        <div class="pod-stat"><div class="pod-stat-v">${s.contacts}</div><div class="pod-stat-l">Contacts</div></div>
        <div class="pod-stat"><div class="pod-stat-v">${s.sold}</div><div class="pod-stat-l">Sold</div></div>
        <div class="pod-stat"><div class="pod-stat-v">${s.hot}</div><div class="pod-stat-l">Hot Leads</div></div>
        <div class="pod-stat"><div class="pod-stat-v">${s.avgTemp}</div><div class="pod-stat-l">Avg Temp</div></div>
      </div>
      <div class="pod-score">
        <div class="pod-score-lbl">Composite Score</div>
        <div class="pod-score-bar"><div class="pod-score-fill" style="width:${(s.score/maxScore)*100}%;background:${c.bar};"></div></div>
        <div class="pod-score-val">${s.score} pts</div>
      </div>
    </div>`;
  }).join('');
}

function renderLeaderboard(stats){
  const el=document.getElementById('leaderboard');
  const maxContacts=Math.max(...stats.map(s=>s.contacts),1);
  el.innerHTML=`<div class="lb-head"><div>#</div><div>Rep</div><div style="text-align:center;">Contacts</div><div style="text-align:center;">Sold</div><div style="text-align:center;">Hot</div><div style="text-align:center;">Avg Temp</div><div>Score</div></div>`+
  stats.map((s,i)=>{
    const c=REP_COLORS[s.name]||{bg:'var(--surface3)',bar:'var(--purple)'};
    const rankCls=i===0?'r1':i===1?'r2':i===2?'r3':'r4';
    return`<div class="lb-row">
      <div class="lb-rank ${rankCls}">${i+1}</div>
      <div class="lb-rep"><div class="lb-av" style="background:${c.bg};">${s.initials}</div><div><div class="lb-name">${s.name}</div><div class="lb-sub">${s.name==='Tyler Doyle'?'S2S Manager':'Sales'}</div></div></div>
      <div class="lb-val">${s.contacts}</div>
      <div class="lb-val" style="color:${s.sold>0?'var(--green)':'var(--text3)'};">${s.sold}</div>
      <div class="lb-val" style="color:${s.hot>0?'#F87171':'var(--text3)'};">${s.hot}</div>
      <div class="lb-val">${s.avgTemp}</div>
      <div class="lb-bar-wrap"><div class="lb-bar-bg"><div class="lb-bar-fill" style="width:${stats[0].score?(s.score/stats[0].score)*100:0}%;background:${c.bar};"></div></div><div class="lb-bar-pct" style="color:${c.bar};">${s.score}</div></div>
    </div>`;
  }).join('');
}

function renderTrends(){
  const el=document.getElementById('trends');
  // Build last 8 weeks of data
  const now=new Date();
  const weeks=[];
  for(let i=7;i>=0;i--){
    const start=new Date(now);start.setDate(start.getDate()-start.getDay()-(i*7));start.setHours(0,0,0,0);
    const end=new Date(start);end.setDate(end.getDate()+7);
    const weekEntries=ALL.filter(e=>e.created_at&&new Date(e.created_at)>=start&&new Date(e.created_at)<end);
    weeks.push({
      label:'W'+(8-i),
      contacts:weekEntries.length,
      hot:weekEntries.filter(e=>parseInt(e.eng_score)>=8).length,
      sold:weekEntries.filter(e=>e.outcome&&(e.outcome.includes('New')||e.outcome.includes('Used'))).length,
    });
  }
  const maxC=Math.max(...weeks.map(w=>w.contacts),1);
  const maxH=Math.max(...weeks.map(w=>w.hot),1);
  const maxS=Math.max(...weeks.map(w=>w.sold),1);

  function barChart(data,key,max,color){
    return`<div class="trend-bars">${data.map(w=>`<div class="trend-col"><div class="trend-v">${w[key]}</div><div class="trend-bar" style="height:${Math.max((w[key]/max)*80,2)}px;background:${color};"></div><div class="trend-lbl">${w.label}</div></div>`).join('')}</div>`;
  }

  el.innerHTML=`
    <div class="trend-card"><div class="trend-title">ğŸ“‹ Total Contacts</div>${barChart(weeks,'contacts',maxC,'var(--blue)')}</div>
    <div class="trend-card"><div class="trend-title">ğŸ”¥ Hot Leads</div>${barChart(weeks,'hot',maxH,'var(--red)')}</div>
    <div class="trend-card"><div class="trend-title">ğŸ† Vehicles Sold</div>${barChart(weeks,'sold',maxS,'var(--green)')}</div>
  `;
}

function renderInsights(data,stats){
  const el=document.getElementById('insights');
  const n=data.length;
  const sold=data.filter(e=>e.outcome&&(e.outcome.includes('New')||e.outcome.includes('Used'))).length;
  const hot=data.filter(e=>parseInt(e.eng_score)>=8).length;
  const temps=data.map(e=>parseInt(e.eng_score)).filter(t=>!isNaN(t));
  const avgTemp=temps.length?(temps.reduce((a,b)=>a+b,0)/temps.length).toFixed(1):'â€”';
  const convRate=n?Math.round((sold/n)*100):0;
  const topRep=stats[0]||{name:'â€”',score:0};
  const hotConv=hot?Math.round((data.filter(e=>parseInt(e.eng_score)>=8&&e.outcome&&(e.outcome.includes('New')||e.outcome.includes('Used'))).length/hot)*100):0;

  el.innerHTML=`
    <div class="insight ins-blue"><div class="insight-icon">ğŸ“Š</div><div class="insight-title">Avg Buying Temp</div><div class="insight-val">${avgTemp}</div><div class="insight-desc">Across ${n} total contacts this period</div></div>
    <div class="insight ins-green"><div class="insight-icon">ğŸ¯</div><div class="insight-title">Conversion Rate</div><div class="insight-val">${convRate}%</div><div class="insight-desc">${sold} sold out of ${n} contacts</div></div>
    <div class="insight ins-gold"><div class="insight-icon">ğŸ‘‘</div><div class="insight-title">Top Performer</div><div class="insight-val">${topRep.name.split(' ')[0]}</div><div class="insight-desc">${topRep.score} pts Â· ${topRep.contacts} contacts Â· ${topRep.sold} sold</div></div>
    <div class="insight ins-red"><div class="insight-icon">ğŸ”¥</div><div class="insight-title">Hot Lead Close Rate</div><div class="insight-val">${hotConv}%</div><div class="insight-desc">${hot} hot leads (8+) this period</div></div>
  `;
}

init();
</script>
</body>
</html>
