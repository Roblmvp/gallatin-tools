<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Rep Scorecards ‚Äî ServiceBridge</title>
<!-- ‚ïê‚ïê SUPABASE AUTH ‚ïê‚ïê -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script src="/auth-guard.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --ink:#080B14;--red:#C8102E;--gold:#C49A2A;--green:#22C55E;--blue:#6366F1;
  --text:#FFFFFF;--muted:rgba(255,255,255,0.45);--muted2:rgba(255,255,255,0.30);
  --border:rgba(255,255,255,0.08);--card:rgba(255,255,255,0.04);
  --surface:rgba(255,255,255,0.03);--surface2:rgba(255,255,255,0.05);--surface3:rgba(255,255,255,0.08);
  --purple:#6366F1;--purple2:#818CF8;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--ink);color:var(--text);font-family:'DM Sans',sans-serif;min-height:100vh;overflow-x:hidden;}
.bg-orb1{position:fixed;top:-180px;right:-120px;width:500px;height:500px;background:radial-gradient(circle,rgba(200,16,46,0.08),transparent 70%);pointer-events:none;z-index:0;}
.bg-orb2{position:fixed;bottom:-200px;left:-100px;width:600px;height:600px;background:radial-gradient(circle,rgba(99,102,241,0.06),transparent 70%);pointer-events:none;z-index:0;}

/* Nav */
nav{position:sticky;top:0;z-index:100;background:rgba(8,11,20,0.85);backdrop-filter:blur(20px);border-bottom:1px solid var(--border);padding:0 24px;height:56px;display:flex;align-items:center;justify-content:space-between;}
.nav-left{display:flex;align-items:center;gap:10px;}
.nav-brand{font-family:'Bebas Neue',sans-serif;font-size:22px;letter-spacing:0.04em;color:var(--red);}
.nav-right{display:flex;align-items:center;gap:12px;}
.nav-user{font-size:13px;font-weight:600;color:var(--text);}
.nav-role-pill{font-size:10px;font-weight:700;letter-spacing:0.08em;text-transform:uppercase;padding:3px 10px;border-radius:20px;background:rgba(99,102,241,0.15);color:var(--purple2);border:1px solid rgba(99,102,241,0.2);}
.role-admin{background:rgba(200,16,46,0.15);color:#FC8181;border-color:rgba(200,16,46,0.2);}
.role-manager{background:rgba(196,154,42,0.15);color:var(--gold);border-color:rgba(196,154,42,0.2);}
.hamburger{display:flex;flex-direction:column;gap:4px;background:none;border:none;cursor:pointer;padding:6px;}
.hamburger span{display:block;width:20px;height:2px;background:var(--muted);border-radius:2px;transition:0.2s;}
.hamburger.open span:nth-child(1){transform:rotate(45deg) translate(4px,4px);}
.hamburger.open span:nth-child(2){opacity:0;}
.hamburger.open span:nth-child(3){transform:rotate(-45deg) translate(4px,-4px);}
.nav-dropdown{position:absolute;top:56px;right:16px;background:rgba(16,18,32,0.97);backdrop-filter:blur(20px);border:1px solid var(--border);border-radius:14px;padding:8px;min-width:220px;display:none;box-shadow:0 20px 60px rgba(0,0,0,0.5);}
.nav-dropdown.open{display:block;}
.dd-item{display:flex;align-items:center;gap:10px;padding:10px 14px;border-radius:8px;color:var(--text);text-decoration:none;font-size:13px;font-weight:500;transition:background 0.15s;}
.dd-item:hover,.dd-item.active{background:var(--surface3);}
.dd-icon{font-size:16px;width:24px;text-align:center;}
.dd-divider{height:1px;background:var(--border);margin:6px 14px;}
.nav-overlay{position:fixed;inset:0;z-index:99;display:none;}
.nav-overlay.open{display:block;}

/* Page */
.page{max-width:960px;margin:0 auto;padding:28px 20px 80px;position:relative;z-index:1;}
.page-header{margin-bottom:28px;}
.page-eyebrow{font-size:10px;font-weight:700;letter-spacing:0.16em;text-transform:uppercase;color:var(--muted2);margin-bottom:6px;}
.page-title{font-family:'Bebas Neue',sans-serif;font-size:44px;letter-spacing:0.02em;line-height:1;}
.page-sub{font-size:14px;color:var(--muted);}

/* Refresh bar */
.refresh-bar{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;padding:10px 16px;background:var(--surface);border:1px solid var(--border);border-radius:10px;}
.refresh-status{font-size:11px;color:var(--muted);display:flex;align-items:center;gap:6px;}
.refresh-dot{width:6px;height:6px;border-radius:50%;background:var(--green);display:inline-block;animation:pulse-dot 2s infinite;}
@keyframes pulse-dot{0%,100%{opacity:1;}50%{opacity:0.3;}}
.refresh-btn{background:var(--surface3);border:1px solid var(--border);color:var(--text);font-size:11px;font-weight:600;padding:5px 14px;border-radius:7px;cursor:pointer;font-family:'DM Sans',sans-serif;transition:all 0.15s;display:flex;align-items:center;gap:5px;}
.refresh-btn:hover{background:var(--surface2);border-color:rgba(255,255,255,0.15);}
.refresh-btn.spinning .refresh-icon{animation:spin 0.8s linear infinite;}
@keyframes spin{from{transform:rotate(0deg);}to{transform:rotate(360deg);}}

/* Period tabs */
.period-tabs{display:flex;gap:4px;background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:4px;width:fit-content;margin-bottom:28px;}
.period-tab{padding:7px 18px;border-radius:7px;font-size:12px;font-weight:600;color:var(--muted);cursor:pointer;border:none;background:transparent;font-family:'DM Sans',sans-serif;transition:all 0.18s;}
.period-tab.active{background:var(--surface3);color:var(--text);}

/* Podium */
.podium{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;margin-bottom:28px;align-items:end;}
.podium-card{border-radius:20px;overflow:hidden;border:1px solid var(--border);transition:transform 0.25s;}
.podium-card:hover{transform:translateY(-4px);}
.podium-card.rank1{background:linear-gradient(160deg,#1C1810 0%,#2A2010 100%);border-color:rgba(232,184,75,0.3);box-shadow:0 20px 60px rgba(232,184,75,0.12);}
.podium-card.rank2{background:linear-gradient(160deg,#131320 0%,#1A1A2E 100%);border-color:rgba(148,163,184,0.2);}
.podium-card.rank3{background:linear-gradient(160deg,#1A1008 0%,#221408 100%);border-color:rgba(200,123,75,0.2);}
.podium-top{padding:28px 24px 20px;text-align:center;position:relative;}
.podium-rank-icon{font-size:32px;margin-bottom:12px;}
.podium-avatar{width:60px;height:60px;border-radius:50%;margin:0 auto 12px;display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:700;color:#fff;}
.rank1 .podium-avatar{background:linear-gradient(135deg,#E8B84B,#F59E0B);box-shadow:0 8px 20px rgba(232,184,75,0.3);}
.rank2 .podium-avatar{background:linear-gradient(135deg,#94A3B8,#64748B);}
.rank3 .podium-avatar{background:linear-gradient(135deg,#C87B4B,#92400E);}
.podium-name{font-family:'Bebas Neue',sans-serif;font-size:28px;letter-spacing:0.04em;margin-bottom:2px;}
.rank1 .podium-name{color:var(--gold);}
.podium-role{font-size:11px;color:var(--muted);margin-bottom:8px;}
.podium-score{font-family:'Bebas Neue',sans-serif;font-size:56px;line-height:1;}
.rank1 .podium-score{color:var(--gold);}
.rank2 .podium-score{color:#94A3B8;}
.rank3 .podium-score{color:#C87B4B;}
.podium-score-lbl{font-size:10px;color:var(--muted2);letter-spacing:0.1em;text-transform:uppercase;margin-bottom:8px;}

/* Streak badge */
.streak-badge{display:inline-flex;align-items:center;gap:4px;font-size:11px;font-weight:700;padding:3px 10px;border-radius:20px;background:rgba(251,146,60,0.15);color:#FB923C;border:1px solid rgba(251,146,60,0.25);margin-bottom:4px;}
.streak-badge.cold{background:rgba(255,255,255,0.05);color:var(--muted2);border-color:var(--border);}

/* Today vs Yesterday */
.tvs{font-size:11px;font-weight:600;margin-top:2px;}
.tvs-up{color:var(--green);}
.tvs-down{color:#FC8181;}
.tvs-same{color:var(--muted);}

/* Gap to leader */
.gap-leader{font-size:10px;color:var(--muted2);margin-top:2px;}

/* Personal best */
.pb-badge{display:inline-flex;align-items:center;gap:3px;font-size:10px;font-weight:700;padding:2px 8px;border-radius:12px;background:rgba(34,197,94,0.12);color:#4ADE80;border:1px solid rgba(34,197,94,0.2);margin-top:4px;}

.podium-stats{border-top:1px solid var(--border);padding:16px 24px;display:grid;grid-template-columns:repeat(3,1fr);gap:8px;text-align:center;}
.ps-val{font-family:'Bebas Neue',sans-serif;font-size:22px;line-height:1;}
.ps-lbl{font-size:9px;font-weight:600;letter-spacing:0.1em;text-transform:uppercase;color:var(--muted2);margin-top:2px;}
.rank1 .ps-val{color:var(--gold);}

/* Leaderboard */
.leaderboard{background:var(--surface);border:1px solid var(--border);border-radius:16px;overflow:hidden;margin-bottom:28px;}
.lb-hd{background:var(--surface2);border-bottom:1px solid var(--border);padding:12px 24px;display:grid;grid-template-columns:44px 1fr 90px 90px 90px 90px 110px;align-items:center;gap:8px;}
.lb-col{font-size:9px;font-weight:700;letter-spacing:0.14em;text-transform:uppercase;color:var(--muted2);text-align:center;}
.lb-col:nth-child(2){text-align:left;}
.lb-row{padding:16px 24px;display:grid;grid-template-columns:44px 1fr 90px 90px 90px 90px 110px;align-items:center;gap:8px;border-bottom:1px solid var(--border);transition:background 0.15s;}
.lb-row:last-child{border-bottom:none;}
.lb-row:hover{background:rgba(255,255,255,0.025);}
.lb-rank-num{font-family:'Bebas Neue',sans-serif;font-size:22px;color:var(--muted2);text-align:center;}
.r1{color:var(--gold)!important;} .r2{color:#94A3B8!important;} .r3{color:#C87B4B!important;}
.lb-rep{display:flex;align-items:center;gap:10px;}
.lb-av{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:#fff;flex-shrink:0;}
.av1{background:linear-gradient(135deg,#E8B84B,#F59E0B);}
.av2{background:linear-gradient(135deg,#94A3B8,#64748B);}
.av3{background:linear-gradient(135deg,#C87B4B,#92400E);}
.av4{background:linear-gradient(135deg,var(--purple),var(--purple2));}
.lb-rep-name{font-size:14px;font-weight:700;}
.lb-rep-role{font-size:10px;color:var(--muted);}
.lb-cell{text-align:center;font-size:14px;font-weight:600;}
.cell-hot{color:#FC8181;} .cell-sold{color:#4ADE80;}
.conv-pill{display:inline-block;padding:4px 12px;border-radius:20px;font-size:11px;font-weight:700;}
.conv-hi{background:rgba(34,197,94,0.15);color:#4ADE80;border:1px solid rgba(34,197,94,0.2);}
.conv-mid{background:rgba(232,184,75,0.15);color:var(--gold);border:1px solid rgba(232,184,75,0.2);}
.conv-lo{background:rgba(255,255,255,0.05);color:var(--muted);border:1px solid var(--border);}

/* Trend bars */
.trend-section{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:24px;margin-bottom:28px;}
.trend-title{font-size:10px;font-weight:700;letter-spacing:0.14em;text-transform:uppercase;color:var(--muted2);margin-bottom:14px;}
.trend-rep-row{display:flex;align-items:center;gap:10px;margin-bottom:10px;}
.trend-name{font-size:12px;font-weight:600;width:60px;flex-shrink:0;}
.trend-bar-wrap{flex:1;height:10px;background:var(--surface3);border-radius:6px;overflow:hidden;}
.trend-bar{height:100%;border-radius:6px;transition:width 0.6s ease;}
.trend-val{font-family:'Bebas Neue',sans-serif;font-size:18px;width:36px;text-align:right;flex-shrink:0;}
.trend-label{font-size:10px;color:var(--muted2);width:60px;flex-shrink:0;}

/* Insights */
.insights-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-bottom:28px;}
.insight-card{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:20px;text-align:center;}
.ic-gold{border-color:rgba(232,184,75,0.2);background:linear-gradient(160deg,rgba(232,184,75,0.04),transparent);}
.ic-purple{border-color:rgba(99,102,241,0.2);background:linear-gradient(160deg,rgba(99,102,241,0.04),transparent);}
.ic-green{border-color:rgba(34,197,94,0.2);background:linear-gradient(160deg,rgba(34,197,94,0.04),transparent);}
.insight-icon{font-size:28px;margin-bottom:8px;}
.insight-title{font-size:10px;font-weight:700;letter-spacing:0.12em;text-transform:uppercase;color:var(--muted2);margin-bottom:8px;}
.insight-val{font-family:'Bebas Neue',sans-serif;color:var(--text);margin-bottom:4px;}
.insight-desc{font-size:11px;color:var(--muted);}

/* Activity Ticker */
.ticker-section{background:var(--surface);border:1px solid var(--border);border-radius:16px;overflow:hidden;margin-bottom:28px;}
.ticker-header{display:flex;align-items:center;justify-content:space-between;padding:14px 20px;border-bottom:1px solid var(--border);background:var(--surface2);}
.ticker-title{font-size:10px;font-weight:700;letter-spacing:0.14em;text-transform:uppercase;color:var(--muted2);display:flex;align-items:center;gap:8px;}
.ticker-live{width:7px;height:7px;border-radius:50%;background:#FC8181;animation:pulse-dot 1.5s infinite;}
.ticker-count{font-size:11px;color:var(--muted);font-weight:500;}
.ticker-list{max-height:400px;overflow-y:auto;}
.ticker-item{display:flex;align-items:flex-start;gap:12px;padding:12px 20px;border-bottom:1px solid var(--border);transition:background 0.15s;}
.ticker-item:last-child{border-bottom:none;}
.ticker-item:hover{background:rgba(255,255,255,0.015);}
.ticker-item.new-entry{animation:ticker-flash 1.5s ease;}
@keyframes ticker-flash{0%{background:rgba(99,102,241,0.12);}100%{background:transparent;}}
.ticker-time{font-size:10px;color:var(--muted2);white-space:nowrap;min-width:60px;padding-top:2px;font-weight:500;}
.ticker-body{flex:1;min-width:0;}
.ticker-rep{font-size:12px;font-weight:700;margin-bottom:2px;}
.ticker-detail{font-size:11px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.ticker-temp{display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;border-radius:8px;font-size:12px;font-weight:800;flex-shrink:0;}
.ticker-temp-hot{background:rgba(200,16,46,0.2);color:#FC8181;border:1px solid rgba(200,16,46,0.3);}
.ticker-temp-warm{background:rgba(232,184,75,0.15);color:var(--gold);border:1px solid rgba(232,184,75,0.2);}
.ticker-temp-cool{background:rgba(255,255,255,0.06);color:var(--muted);border:1px solid var(--border);}
.ticker-empty{padding:40px 20px;text-align:center;color:var(--muted2);font-size:13px;}

/* Verified sold indicator */
.sold-detail{font-size:11px;margin-top:2px;display:flex;align-items:center;gap:6px;}
.sold-verified{color:#4ADE80;font-weight:600;}
.sold-pending{color:var(--gold);font-weight:600;}
.sold-check{display:inline-flex;align-items:center;gap:2px;font-size:10px;font-weight:700;padding:2px 7px;border-radius:10px;background:rgba(34,197,94,0.12);color:#4ADE80;border:1px solid rgba(34,197,94,0.2);}
.sold-pend-badge{display:inline-flex;align-items:center;gap:2px;font-size:10px;font-weight:700;padding:2px 7px;border-radius:10px;background:rgba(249,115,22,0.12);color:var(--gold);border:1px solid rgba(249,115,22,0.2);}

/* Loading */
.loading{text-align:center;padding:80px 20px;}
.dots{display:inline-flex;gap:6px;}
.dots span{width:8px;height:8px;border-radius:50%;background:var(--purple);animation:dot-bounce 1.2s infinite;}
.dots span:nth-child(2){animation-delay:0.15s;}
.dots span:nth-child(3){animation-delay:0.3s;}
@keyframes dot-bounce{0%,80%,100%{transform:scale(0.6);opacity:0.3;}40%{transform:scale(1);opacity:1;}}

/* Fade in */
.fade-in{animation:fadeUp 0.4s ease;}
@keyframes fadeUp{from{opacity:0;transform:translateY(12px);}to{opacity:1;transform:translateY(0);}}

/* Mobile */
@media(max-width:768px){
  .page-title{font-size:32px;}
  .podium{grid-template-columns:1fr;gap:12px;}
  .podium-card.rank1{order:-1;}
  .lb-hd,.lb-row{grid-template-columns:36px 1fr 70px 70px 90px;padding:12px 14px;}
  .lb-col:nth-child(4),.lb-col:nth-child(5),.lb-cell:nth-child(4),.lb-cell:nth-child(5){display:none;}
  .insights-grid{grid-template-columns:1fr;}
  .podium-score{font-size:40px;}
  .podium-name{font-size:22px;}
}
@media(max-width:480px){
  .lb-hd,.lb-row{grid-template-columns:32px 1fr 60px 60px 80px;}
}
</style>
</head>
<body>
<div class="bg-orb1"></div>
<div class="bg-orb2"></div>

<nav>
  <div class="nav-left">
    <div class="nav-brand">ServiceBridge</div>
    <span style="font-size:12px;color:var(--muted);font-weight:500;">/ Rep Scorecards</span>
  </div>
  <div class="nav-right">
    <span class="nav-user" id="nav-user-name"></span>
    <span class="nav-role-pill" id="nav-role-pill"></span>
    <button class="hamburger" id="hamburger" onclick="toggleMenu()" aria-label="Menu">
      <span></span><span></span><span></span>
    </button>
  </div>
  <div class="nav-dropdown" id="nav-dropdown">
    <a href="app.html" class="dd-item"><span class="dd-icon">üè†</span> Home</a>
    <a href="service-to-sales-log.html" class="dd-item"><span class="dd-icon">üìã</span> S2S Entry</a>
    <a href="manager-dashboard.html" class="dd-item"><span class="dd-icon">üìä</span> Performance Dashboard</a>
    <a href="scorecards.html" class="dd-item active"><span class="dd-icon">üèÜ</span> Scorecards</a>
    <div class="dd-divider dd-admin" id="dd-admin-divider"></div>
    <a href="admin-panel.html" class="dd-item dd-admin" id="dd-admin-link"><span class="dd-icon">‚öôÔ∏è</span> Admin Panel</a>
  </div>
</nav>
<div class="nav-overlay" id="nav-overlay" onclick="closeMenu()"></div>

<div class="page">
  <div class="page-header fade-in">
    <div class="page-eyebrow">Gallatin CDJR ¬∑ ServiceBridge</div>
    <div class="page-title">Rep Scorecards</div>
    <div class="page-sub">Performance leaderboard ¬∑ S2S conversion rankings</div>
  </div>

  <div class="refresh-bar fade-in" id="refresh-bar">
    <div class="refresh-status">
      <span class="refresh-dot"></span>
      <span id="refresh-label">Live ¬∑ Updated just now</span>
    </div>
    <button class="refresh-btn" id="refresh-btn" onclick="manualRefresh()">
      <span class="refresh-icon">‚Üª</span> Refresh
    </button>
  </div>

  <div class="period-tabs">
    <button class="period-tab active" onclick="setPeriod('week',this)">This Week</button>
    <button class="period-tab" onclick="setPeriod('month',this)">This Month</button>
    <button class="period-tab" onclick="setPeriod('all',this)">All Time</button>
  </div>

  <div id="main-content">
    <div class="loading"><div class="dots"><span></span><span></span><span></span></div></div>
  </div>

  <div id="ticker-container"></div>
</div>

<script>
const SB_URL = 'https://jbkgwtohwsbaorhvuuqb.supabase.co';
const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impia2d3dG9od3NiYW9yaHZ1dXFiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5NjkwNDIsImV4cCI6MjA4NzU0NTA0Mn0.GRXOYbIuVDxU9-FEBYmyd1QmytVUrMIAxbnOSfepzuU';
let H = {'apikey':SB_KEY,'Authorization':`Bearer ${SB_KEY}`,'Content-Type':'application/json'};
function _refreshH(){ const t=window.sbSession?.access_token||SB_KEY; H={'apikey':SB_KEY,'Authorization':'Bearer '+t,'Content-Type':'application/json'}; }

const REPS = [
  {name:'Andrew Kirk',initials:'AK',role:'Sales Rep'},
  {name:'DJ Rogers',initials:'DJ',role:'Sales Rep'},
  {name:'Kody McCann',initials:'KM',role:'Sales Rep'},
];

let allEntries = [];
let allEntriesHistorical = [];
let period = 'week';
let lastRefreshTime = null;
let refreshInterval = null;
let tickerInterval = null;

// ‚îÄ‚îÄ NAV ‚îÄ‚îÄ
function initNav(user) {
  if (!user) return;
  const nameEl = document.getElementById('nav-user-name');
  const pillEl = document.getElementById('nav-role-pill');
  if (nameEl) nameEl.textContent = user.first;
  if (pillEl) {
    const role = user.role.toLowerCase();
    pillEl.textContent = user.role;
    pillEl.className = 'nav-role-pill ' + (role === 'admin' ? 'role-admin' : role === 'manager' ? 'role-manager' : '');
  }
  if (user.role === 'Admin') {
    const d = document.getElementById('dd-admin-divider'); if(d) d.style.display='block';
    const l = document.getElementById('dd-admin-link'); if(l) l.style.display='flex';
  }
}
function toggleMenu(){
  const dd=document.getElementById('nav-dropdown'),hb=document.getElementById('hamburger'),ov=document.getElementById('nav-overlay');
  const open=dd.classList.toggle('open');hb.classList.toggle('open');ov.classList.toggle('open');
}
function closeMenu(){
  document.getElementById('nav-dropdown').classList.remove('open');
  document.getElementById('hamburger').classList.remove('open');
  document.getElementById('nav-overlay').classList.remove('open');
}

// ‚îÄ‚îÄ DATA ‚îÄ‚îÄ
async function loadAll() {
  try {
    const res = await fetch(`${SB_URL}/rest/v1/s2s_entries?select=*&order=created_at.desc&limit=5000`, {headers:H});
    if (!res.ok) throw new Error('Failed to load');
    allEntriesHistorical = await res.json();
    allEntries = [...allEntriesHistorical];
    lastRefreshTime = new Date();
    updateRefreshLabel();
    render();
    renderTicker();
  } catch(e) {
    document.getElementById('main-content').innerHTML = `<div style="text-align:center;padding:60px 20px;color:#FC8181;">
      <div style="font-size:28px;margin-bottom:12px;">‚ö†Ô∏è</div>
      <div style="font-size:15px;font-weight:600;margin-bottom:6px;">Failed to load data</div>
      <div style="font-size:12px;color:var(--muted);">${e.message}</div>
      <button onclick="loadAll()" style="margin-top:16px;padding:8px 20px;border-radius:8px;background:var(--surface3);border:1px solid var(--border);color:var(--text);font-size:13px;cursor:pointer;">Retry</button>
    </div>`;
  }
}

function filterByPeriod(entries) {
  const now = new Date();
  if (period === 'week') {
    const day = now.getDay(), diff = day === 0 ? 6 : day - 1;
    const start = new Date(now); start.setDate(now.getDate() - diff); start.setHours(0,0,0,0);
    return entries.filter(e => new Date(e.created_at) >= start);
  }
  if (period === 'month') {
    const start = new Date(now.getFullYear(), now.getMonth(), 1);
    return entries.filter(e => new Date(e.created_at) >= start);
  }
  return entries;
}

function setPeriod(p, el) {
  period = p;
  document.querySelectorAll('.period-tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  render();
}

// ‚îÄ‚îÄ SCORING ‚îÄ‚îÄ
function calcStats(repName, entries) {
  const mine = entries.filter(e => (e.submitter || '') === repName);
  const total = mine.length;
  const hot = mine.filter(e => parseInt(e.eng_score) >= 8).length;
  const soldEntries = mine.filter(e => {
    const o = (e.outcome || '').toLowerCase();
    return o.includes('sold') || o.includes('new vehicle') || o.includes('used vehicle');
  });
  const verifiedSold = soldEntries.filter(e => e.verified_sold === true).length;
  const pendingSold = soldEntries.filter(e => !e.verified_sold).length;
  const sold = soldEntries.length;
  const appt = mine.filter(e => {
    const o = (e.outcome || '').toLowerCase();
    return o.includes('appt') || o.includes('appointment');
  }).length;
  const temps = mine.map(e => parseInt(e.eng_score)).filter(t => !isNaN(t) && t > 0);
  const avgTemp = temps.length > 0 ? (temps.reduce((a,b)=>a+b,0)/temps.length).toFixed(1) : 0;
  const conv = total > 0 ? Math.round((sold/total)*100) : 0;
  // Verified sold = 5 pts, pending sold = 2.5 pts (half credit)
  const soldScore = (verifiedSold * 5) + (pendingSold * 2.5);
  const score = (total * 2) + (hot * 3) + soldScore + (appt * 2) + parseFloat(avgTemp);
  return { total, hot, sold, verifiedSold, pendingSold, appt, avgTemp, conv, score: Math.round(score) };
}

// ‚îÄ‚îÄ STREAK TRACKER ‚îÄ‚îÄ
function calcStreak(repName) {
  const repEntries = allEntriesHistorical.filter(e => (e.submitter || '') === repName);
  if (repEntries.length === 0) return 0;

  const datesSet = new Set();
  repEntries.forEach(e => {
    const d = new Date(e.created_at);
    datesSet.add(`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`);
  });

  let streak = 0;
  const today = new Date();
  today.setHours(0,0,0,0);
  let checkDate = new Date(today);

  // If no entry today yet, start checking from yesterday
  const todayStr = `${checkDate.getFullYear()}-${String(checkDate.getMonth()+1).padStart(2,'0')}-${String(checkDate.getDate()).padStart(2,'0')}`;
  if (!datesSet.has(todayStr)) {
    checkDate.setDate(checkDate.getDate() - 1);
  }

  while (true) {
    const dow = checkDate.getDay();
    // Skip Sundays (0) ‚Äî working days are Mon(1)-Sat(6)
    if (dow === 0) {
      checkDate.setDate(checkDate.getDate() - 1);
      continue;
    }
    const ds = `${checkDate.getFullYear()}-${String(checkDate.getMonth()+1).padStart(2,'0')}-${String(checkDate.getDate()).padStart(2,'0')}`;
    if (datesSet.has(ds)) {
      streak++;
      checkDate.setDate(checkDate.getDate() - 1);
    } else {
      break;
    }
  }
  return streak;
}

function streakBadge(streak) {
  if (streak >= 2) return `<div class="streak-badge">üî• ${streak}-day streak</div>`;
  if (streak === 1) return `<div class="streak-badge cold">1 day</div>`;
  return `<div class="streak-badge cold">No streak</div>`;
}

// ‚îÄ‚îÄ TODAY VS YESTERDAY ‚îÄ‚îÄ
function todayVsYesterday(repName) {
  const now = new Date();
  const todayStart = new Date(now); todayStart.setHours(0,0,0,0);
  const yesterStart = new Date(todayStart); yesterStart.setDate(yesterStart.getDate()-1);

  const todayCount = allEntriesHistorical.filter(e =>
    (e.submitter || '') === repName && new Date(e.created_at) >= todayStart
  ).length;
  const yesterCount = allEntriesHistorical.filter(e =>
    (e.submitter || '') === repName && new Date(e.created_at) >= yesterStart && new Date(e.created_at) < todayStart
  ).length;

  const diff = todayCount - yesterCount;
  if (diff > 0) return `<div class="tvs tvs-up">‚ñ≤ +${diff} contact${diff!==1?'s':''} today vs. yesterday</div>`;
  if (diff < 0) return `<div class="tvs tvs-down">‚ñº ${diff} contact${Math.abs(diff)!==1?'s':''} today vs. yesterday</div>`;
  return `<div class="tvs tvs-same">‚Äî Same as yesterday (${todayCount})</div>`;
}

// ‚îÄ‚îÄ PERSONAL BEST ‚îÄ‚îÄ
function isPersonalBest(repName) {
  const repEntries = allEntriesHistorical.filter(e => (e.submitter || '') === repName);
  if (repEntries.length === 0) return false;

  // Get current week boundaries
  const now = new Date();
  const day = now.getDay(), diff = day === 0 ? 6 : day - 1;
  const thisWeekStart = new Date(now); thisWeekStart.setDate(now.getDate() - diff); thisWeekStart.setHours(0,0,0,0);

  const thisWeekCount = repEntries.filter(e => new Date(e.created_at) >= thisWeekStart).length;
  if (thisWeekCount === 0) return false;

  // Calculate weekly counts for all previous weeks
  const weekCounts = {};
  repEntries.forEach(e => {
    const d = new Date(e.created_at);
    if (d >= thisWeekStart) return; // skip current week
    // Get Monday of that entry's week
    const dow = d.getDay(), wDiff = dow === 0 ? 6 : dow - 1;
    const monday = new Date(d); monday.setDate(d.getDate() - wDiff); monday.setHours(0,0,0,0);
    const key = monday.toISOString().slice(0,10);
    weekCounts[key] = (weekCounts[key] || 0) + 1;
  });

  const prevBest = Math.max(0, ...Object.values(weekCounts));
  return thisWeekCount > prevBest && prevBest > 0;
}

// ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ
function convPill(conv) {
  if (conv >= 20) return `<span class="conv-pill conv-hi">${conv}%</span>`;
  if (conv >= 10) return `<span class="conv-pill conv-mid">${conv}%</span>`;
  return `<span class="conv-pill conv-lo">${conv}%</span>`;
}

function render() {
  const filtered = filterByPeriod(allEntries);
  const repStats = REPS.map((r,i) => {
    const stats = calcStats(r.name, filtered);
    const streak = calcStreak(r.name);
    const pb = isPersonalBest(r.name);
    return { ...r, ...stats, streak, pb, idx:i };
  });
  repStats.sort((a,b) => b.score - a.score);
  const leaderName = repStats[0]?.name || '';
  const leaderScore = repStats[0]?.score || 0;
  const podiumOrder = [repStats[1], repStats[0], repStats[2]].filter(Boolean);

  const html = `
  <div class="podium fade-in">
    ${podiumOrder.map((rep, pi) => {
      const rClass = ['rank2','rank1','rank3'][pi];
      const icon = ['ü•à','ü•á','ü•â'][pi];
      const actualRank = repStats.indexOf(rep);
      const gapHtml = actualRank > 0 ? `<div class="gap-leader">${leaderScore - rep.score} pts behind ${leaderName.split(' ')[0]}</div>` : '';
      return `
      <div class="podium-card ${rClass}">
        <div class="podium-top">
          <div class="podium-rank-icon">${icon}</div>
          <div class="podium-avatar">${rep.initials}</div>
          <div class="podium-name">${rep.name}</div>
          <div class="podium-role">${rep.role}</div>
          ${streakBadge(rep.streak)}
          ${rep.pb ? '<div class="pb-badge">üèÖ New Personal Best</div>' : ''}
          <div class="podium-score">${rep.score}</div>
          <div class="podium-score-lbl">Performance Score</div>
          ${todayVsYesterday(rep.name)}
          ${gapHtml}
        </div>
        <div class="podium-stats">
          <div><div class="ps-val">${rep.total}</div><div class="ps-lbl">Contacts</div></div>
          <div><div class="ps-val">${rep.hot}</div><div class="ps-lbl">Hot Leads</div></div>
          <div>
            <div class="ps-val">${rep.sold}</div>
            <div class="ps-lbl">Sold</div>
            ${rep.sold > 0 ? `<div class="sold-detail">${rep.verifiedSold ? `<span class="sold-check">‚úÖ ${rep.verifiedSold}</span>` : ''}${rep.pendingSold ? `<span class="sold-pend-badge">‚è≥ ${rep.pendingSold}</span>` : ''}</div>` : ''}
          </div>
        </div>
      </div>`;
    }).join('')}
  </div>

  <div class="leaderboard fade-in">
    <div class="lb-hd">
      <div class="lb-col">#</div>
      <div class="lb-col" style="text-align:left;">Rep</div>
      <div class="lb-col">Contacts</div>
      <div class="lb-col">Hot Leads</div>
      <div class="lb-col">Sold</div>
      <div class="lb-col">Avg Temp</div>
      <div class="lb-col">Conv Rate</div>
    </div>
    ${repStats.map((rep, i) => {
      const rankNum = i+1;
      const rClass = rankNum <= 3 ? `r${rankNum}` : '';
      const avC = ['av1','av2','av3','av4'][i] || 'av4';
      const gapHtml = i > 0 ? `<div class="gap-leader">${leaderScore - rep.score} pts behind ${leaderName.split(' ')[0]}</div>` : '';
      return `
      <div class="lb-row">
        <div class="lb-rank-num ${rClass}">${rankNum}</div>
        <div class="lb-rep">
          <div class="lb-av ${avC}">${rep.initials}</div>
          <div>
            <div class="lb-rep-name">${rep.name} ${rep.streak >= 2 ? `<span style="font-size:11px;color:#FB923C;">üî•${rep.streak}</span>` : ''} ${rep.pb ? '<span style="font-size:10px;">üèÖ</span>' : ''}</div>
            <div class="lb-rep-role">${rep.role}</div>
            ${todayVsYesterday(rep.name)}
            ${gapHtml}
          </div>
        </div>
        <div class="lb-cell">${rep.total}</div>
        <div class="lb-cell cell-hot">${rep.hot}</div>
        <div class="lb-cell cell-sold">${rep.sold}${rep.sold > 0 ? `<div class="sold-detail" style="justify-content:center;">${rep.verifiedSold ? `<span class="sold-check">‚úÖ${rep.verifiedSold}</span>` : ''}${rep.pendingSold ? `<span class="sold-pend-badge">‚è≥${rep.pendingSold}</span>` : ''}</div>` : ''}</div>
        <div class="lb-cell">${rep.avgTemp || '‚Äî'}</div>
        <div class="lb-cell">${convPill(rep.conv)}</div>
      </div>`;
    }).join('')}
  </div>

  <div class="trend-section fade-in">
    <div class="trend-title">Contacts Logged</div>
    ${repStats.map(rep => `
    <div class="trend-rep-row">
      <div class="trend-name">${rep.name.split(' ')[0]}</div>
      <div class="trend-bar-wrap"><div class="trend-bar" style="width:${Math.round((rep.total/Math.max(...repStats.map(r=>r.total||1)))*100)||4}%;background:linear-gradient(90deg,var(--purple),var(--purple2));"></div></div>
      <div class="trend-val" style="color:var(--purple2);">${rep.total}</div>
      <div class="trend-label">contacts</div>
    </div>`).join('')}
    <div style="height:16px;"></div>
    <div class="trend-title">Hot Leads (8-10 Temp)</div>
    ${repStats.map(rep => `
    <div class="trend-rep-row">
      <div class="trend-name">${rep.name.split(' ')[0]}</div>
      <div class="trend-bar-wrap"><div class="trend-bar" style="width:${Math.round((rep.hot/Math.max(...repStats.map(r=>r.hot||1)))*100)||4}%;background:linear-gradient(90deg,var(--red),#FC8181);"></div></div>
      <div class="trend-val" style="color:#FC8181;">${rep.hot}</div>
      <div class="trend-label">hot leads</div>
    </div>`).join('')}
    <div style="height:16px;"></div>
    <div class="trend-title">Vehicles Sold</div>
    ${repStats.map(rep => `
    <div class="trend-rep-row">
      <div class="trend-name">${rep.name.split(' ')[0]}</div>
      <div class="trend-bar-wrap"><div class="trend-bar" style="width:${Math.round((rep.sold/Math.max(...repStats.map(r=>r.sold||1)))*100)||4}%;background:linear-gradient(90deg,var(--green),#4ADE80);"></div></div>
      <div class="trend-val" style="color:#4ADE80;">${rep.sold}</div>
      <div class="trend-label">sold</div>
    </div>`).join('')}
  </div>

  <div class="insights-grid fade-in">
    <div class="insight-card ic-gold">
      <div class="insight-icon">üèÜ</div>
      <div class="insight-title">Top Performer</div>
      <div class="insight-val" style="font-size:28px;">${repStats[0]?.name?.split(' ')[0] || '‚Äî'}</div>
      <div class="insight-desc">${repStats[0]?.score || 0} performance score ¬∑ ${repStats[0]?.total || 0} contacts</div>
    </div>
    <div class="insight-card ic-purple">
      <div class="insight-icon">üî•</div>
      <div class="insight-title">Most Hot Leads</div>
      <div class="insight-val" style="font-size:28px;">${[...repStats].sort((a,b)=>b.hot-a.hot)[0]?.name?.split(' ')[0] || '‚Äî'}</div>
      <div class="insight-desc">${[...repStats].sort((a,b)=>b.hot-a.hot)[0]?.hot || 0} hot leads logged this ${period}</div>
    </div>
    <div class="insight-card ic-green">
      <div class="insight-icon">üöó</div>
      <div class="insight-title">Best Conversion</div>
      <div class="insight-val" style="font-size:28px;">${[...repStats].sort((a,b)=>b.conv-a.conv)[0]?.name?.split(' ')[0] || '‚Äî'}</div>
      <div class="insight-desc">${[...repStats].sort((a,b)=>b.conv-a.conv)[0]?.conv || 0}% S2S conversion rate</div>
    </div>
  </div>
  `;

  document.getElementById('main-content').innerHTML = html;
}

// ‚îÄ‚îÄ ACTIVITY TICKER ‚îÄ‚îÄ
function renderTicker() {
  const now = new Date();
  const todayStart = new Date(now); todayStart.setHours(0,0,0,0);
  const todayEntries = allEntriesHistorical
    .filter(e => new Date(e.created_at) >= todayStart)
    .sort((a,b) => new Date(b.created_at) - new Date(a.created_at))
    .slice(0, 10);

  const container = document.getElementById('ticker-container');
  if (todayEntries.length === 0) {
    container.innerHTML = `
    <div class="ticker-section fade-in">
      <div class="ticker-header">
        <div class="ticker-title"><span class="ticker-live"></span> Today's Activity</div>
        <div class="ticker-count">0 entries today</div>
      </div>
      <div class="ticker-empty">No entries logged today yet. Be the first! üöÄ</div>
    </div>`;
    return;
  }

  container.innerHTML = `
  <div class="ticker-section fade-in">
    <div class="ticker-header">
      <div class="ticker-title"><span class="ticker-live"></span> Today's Activity</div>
      <div class="ticker-count">${todayEntries.length} entr${todayEntries.length===1?'y':'ies'} today</div>
    </div>
    <div class="ticker-list">
      ${todayEntries.map(e => {
        const t = new Date(e.created_at);
        const diffMs = now - t;
        const diffMin = Math.floor(diffMs / 60000);
        let timeStr;
        if (diffMin < 1) timeStr = 'Just now';
        else if (diffMin < 60) timeStr = `${diffMin} min ago`;
        else timeStr = `${Math.floor(diffMin/60)}h ${diffMin%60}m ago`;

        const sc = parseInt(e.eng_score) || 0;
        const tempCls = sc >= 8 ? 'ticker-temp-hot' : sc >= 5 ? 'ticker-temp-warm' : 'ticker-temp-cool';
        const tempLabel = sc >= 8 ? 'hot lead' : sc >= 5 ? 'warm contact' : 'contact';
        const vehicle = [e.veh_year || e.vehicle_year, e.veh_make || e.vehicle_make, e.veh_model || e.vehicle_model].filter(Boolean).join(' ');
        const repName = e.submitter || 'Unknown';
        const custName = [e.first_name || e.customer_first, e.last_name || e.customer_last].filter(Boolean).join(' ');

        return `
        <div class="ticker-item">
          <div class="ticker-time">${timeStr}</div>
          <div class="ticker-body">
            <div class="ticker-rep">${repName} logged a ${tempLabel}</div>
            <div class="ticker-detail">${custName ? custName + ' ¬∑ ' : ''}${vehicle ? vehicle : 'Vehicle TBD'}${e.repair_cost ? ' ¬∑ $' + e.repair_cost + ' RO' : ''}</div>
          </div>
          <div class="ticker-temp ${tempCls}">${sc || '‚Äî'}</div>
        </div>`;
      }).join('')}
    </div>
  </div>`;
}

// ‚îÄ‚îÄ LIVE REFRESH ‚îÄ‚îÄ
function updateRefreshLabel() {
  const el = document.getElementById('refresh-label');
  if (!el || !lastRefreshTime) return;
  const diff = Math.floor((new Date() - lastRefreshTime) / 60000);
  if (diff < 1) el.textContent = 'Live ¬∑ Updated just now';
  else if (diff === 1) el.textContent = 'Live ¬∑ Updated 1 min ago';
  else el.textContent = `Live ¬∑ Updated ${diff} min ago`;
}

async function manualRefresh() {
  const btn = document.getElementById('refresh-btn');
  btn.classList.add('spinning');
  btn.disabled = true;
  await loadAll();
  setTimeout(() => { btn.classList.remove('spinning'); btn.disabled = false; }, 600);
}

function startAutoRefresh() {
  // Leaderboard refresh every 5 minutes
  if (refreshInterval) clearInterval(refreshInterval);
  refreshInterval = setInterval(() => { loadAll(); }, 5 * 60 * 1000);

  // Ticker refresh every 2 minutes
  if (tickerInterval) clearInterval(tickerInterval);
  tickerInterval = setInterval(async () => {
    try {
      const todayStart = new Date(); todayStart.setHours(0,0,0,0);
      const res = await fetch(`${SB_URL}/rest/v1/s2s_entries?select=*&created_at=gte.${todayStart.toISOString()}&order=created_at.desc&limit=10`, {headers:H});
      if (res.ok) {
        const fresh = await res.json();
        // Merge fresh today entries into historical
        fresh.forEach(fe => {
          const idx = allEntriesHistorical.findIndex(e => e.id === fe.id);
          if (idx === -1) allEntriesHistorical.unshift(fe);
        });
        allEntries = [...allEntriesHistorical];
        renderTicker();
      }
    } catch(e) { /* silent */ }
  }, 2 * 60 * 1000);

  // Update "X min ago" label every 30 seconds
  setInterval(updateRefreshLabel, 30000);
}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
async function load() {
  const { currentUser } = await SB_AUTH.init({ requiredRole: 'any' });
  initNav(currentUser);
  _refreshH();
  await loadAll();
  startAutoRefresh();
}

load();
</script>
</body>
</html>
