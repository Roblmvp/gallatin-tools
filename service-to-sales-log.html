<!DOCTYPE html>
<html lang="en">
<head>
<script>
(function(){
  var rep = null;
  try { rep = JSON.parse(sessionStorage.getItem('sb_rep') || 'null'); } catch(e) {}
  if (!rep || !rep.name || !rep.role) { window.location.replace('/login.html'); }
})();
</script>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#06080E">
<title>S2S Entry ‚Äî ServiceBridge</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Instrument+Serif:ital@0;1&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #06080E; --bg2: #0C0F18;
  --surface: #111520; --surface2: #171C2A; --surface3: #1D2333;
  --red: #E01B36; --red-soft: rgba(224,27,54,0.10); --red-glow: rgba(224,27,54,0.25);
  --gold: #D4A73A; --gold-soft: rgba(212,167,58,0.10);
  --green: #2DD4A0; --green-soft: rgba(45,212,160,0.10);
  --blue: #6C70F0; --blue-soft: rgba(108,112,240,0.10);
  --orange: #F59E0B; --orange-soft: rgba(245,158,11,0.10);
  --text: #EDEEF2; --text2: rgba(237,238,242,0.62); --text3: rgba(237,238,242,0.34);
  --border: rgba(255,255,255,0.06); --border2: rgba(255,255,255,0.10); --border3: rgba(255,255,255,0.16);
  --r: 14px; --rsm: 10px; --rlg: 18px;
  --spring: cubic-bezier(0.16, 1, 0.3, 1);
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
html { scroll-behavior: smooth; }
body {
  background: var(--bg); color: var(--text);
  font-family: 'Plus Jakarta Sans', -apple-system, sans-serif;
  min-height: 100vh; overflow-x: hidden;
  -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
  font-size: 15px; line-height: 1.5; letter-spacing: -0.01em;
}

/* ‚îÄ‚îÄ Background ‚îÄ‚îÄ */
.bg-noise { position:fixed;inset:0;z-index:0;pointer-events:none;opacity:0.35;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E"); }
.bg-grad { position:fixed;inset:0;z-index:0;pointer-events:none;background:radial-gradient(ellipse 60% 50% at 20% 0%,rgba(224,27,54,0.06) 0%,transparent 70%),radial-gradient(ellipse 50% 60% at 80% 100%,rgba(108,112,240,0.04) 0%,transparent 70%); }

/* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
.app-header {
  display:flex;align-items:center;justify-content:space-between;
  padding:14px 20px 12px; padding-top:max(14px, env(safe-area-inset-top));
  border-bottom:1px solid var(--border);
  background:rgba(6,8,14,0.92);backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);
  position:sticky;top:0;z-index:100;
}
.app-header::after { content:'';position:absolute;bottom:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--red),var(--blue),transparent);opacity:0.4; }
.header-left { display:flex;align-items:center;gap:10px; }
.header-logo { width:30px;height:30px;background:var(--red);border-radius:8px;display:flex;align-items:center;justify-content:center; }
.header-logo svg { width:14px;height:14px; }
.header-title { font-family:'Instrument Serif',Georgia,serif;font-size:17px;letter-spacing:-0.01em;color:var(--text); }
.header-right { display:flex;align-items:center;gap:8px;position:relative; }
.header-user { font-size:11px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:0.1em; }

/* Hamburger */
.hamburger { background:none;border:1px solid var(--border2);border-radius:8px;width:32px;height:32px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;cursor:pointer;transition:all 0.18s;padding:0;flex-shrink:0; }
.hamburger:hover { border-color:rgba(255,255,255,0.18);background:rgba(255,255,255,0.03); }
.hamburger span { display:block;width:14px;height:1.5px;background:rgba(255,255,255,0.55);border-radius:2px;transition:all 0.2s; }
.hamburger.open span:nth-child(1) { transform:translateY(5.5px) rotate(45deg); }
.hamburger.open span:nth-child(2) { opacity:0; }
.hamburger.open span:nth-child(3) { transform:translateY(-5.5px) rotate(-45deg); }

/* Dropdown */
.nav-overlay { position:fixed;inset:0;z-index:190;display:none; }
.nav-overlay.open { display:block; }
.nav-dropdown { position:absolute;top:calc(100% + 8px);right:0;background:var(--surface);border:1px solid var(--border2);border-radius:var(--r);min-width:230px;padding:6px;box-shadow:0 20px 60px rgba(0,0,0,0.6);z-index:201;opacity:0;transform:translateY(-8px) scale(0.97);pointer-events:none;transition:all 0.18s var(--spring); }
.nav-dropdown.open { opacity:1;transform:translateY(0) scale(1);pointer-events:all; }
.dd-item { display:flex;align-items:center;gap:10px;padding:11px 14px;border-radius:var(--rsm);font-size:13px;font-weight:600;color:var(--text2);text-decoration:none;cursor:pointer;transition:all 0.15s; }
.dd-item:hover { background:rgba(255,255,255,0.04);color:var(--text); }
.dd-item.active-page { background:var(--red-soft);color:#F87171; }
.dd-icon { font-size:14px;width:20px;text-align:center; }
.dd-divider { height:1px;background:var(--border);margin:4px 0; }
.dd-admin { display:none; }
.dd-admin.show { display:flex; }
.dd-divider.dd-admin.show { display:block; }
.nav-user-info { display:flex;align-items:center;justify-content:space-between;padding:8px 14px 4px; }
.nav-user-display { font-size:11px;font-weight:700;color:var(--text3);letter-spacing:0.08em; }
.nav-role-pill { font-size:9px;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;padding:3px 8px;border-radius:20px; }
.role-admin { background:var(--blue-soft);color:var(--blue);border:1px solid rgba(108,112,240,0.2); }
.role-manager { background:var(--gold-soft);color:var(--gold);border:1px solid rgba(212,167,58,0.2); }
.role-sales { background:rgba(255,255,255,0.05);color:var(--text2);border:1px solid rgba(255,255,255,0.08); }

/* ‚îÄ‚îÄ Progress Bar ‚îÄ‚îÄ */
.progress-bar {
  display:flex;align-items:center;gap:0;padding:0 20px;
  background:var(--bg2);border-bottom:1px solid var(--border);
  overflow-x:auto;scrollbar-width:none;position:relative;z-index:1;
}
.progress-bar::-webkit-scrollbar { display:none; }
.step {
  display:flex;align-items:center;gap:7px;
  padding:12px 16px 12px 0;
  font-size:10px;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;
  color:var(--text3);border-bottom:2px solid transparent;
  white-space:nowrap;transition:all 0.25s var(--spring);cursor:default;
}
.step.active { color:var(--red);border-bottom-color:var(--red); }
.step.done { color:var(--green);border-bottom-color:var(--green); }
.step-n {
  width:20px;height:20px;border-radius:50%;
  border:1.5px solid currentColor;
  display:flex;align-items:center;justify-content:center;
  font-size:10px;font-family:'JetBrains Mono',monospace;font-weight:500;
  flex-shrink:0;transition:all 0.25s var(--spring);
}
.step.done .step-n { background:var(--green);border-color:var(--green);color:var(--bg); }

/* ‚îÄ‚îÄ Page ‚îÄ‚îÄ */
.page { max-width:800px;margin:0 auto;padding:28px 20px 120px;position:relative;z-index:1; }

/* ‚îÄ‚îÄ Section Headers ‚îÄ‚îÄ */
.section-head { margin:32px 0 14px;display:flex;align-items:flex-end;justify-content:space-between; }
.section-head:first-child { margin-top:0; }
.sh-left {}
.sh-eyebrow { font-size:10px;font-weight:700;letter-spacing:0.16em;text-transform:uppercase;color:var(--red);opacity:0.7;margin-bottom:5px; }
.sh-title { font-family:'Instrument Serif',Georgia,serif;font-size:24px;letter-spacing:-0.02em;color:var(--text);line-height:1.1; }
.sh-desc { font-size:13px;font-weight:450;color:var(--text3);margin-top:4px; }
.sh-num { font-family:'JetBrains Mono',monospace;font-size:11px;font-weight:500;color:var(--text3); }

/* ‚îÄ‚îÄ Cards ‚îÄ‚îÄ */
.card {
  background:var(--surface);border:1px solid var(--border);border-radius:var(--rlg);
  padding:24px 22px;margin-bottom:10px;position:relative;
  animation:fadeUp 0.4s ease both;
}

/* ‚îÄ‚îÄ Submitter Grid ‚îÄ‚îÄ */
.sub-grid { display:grid;grid-template-columns:repeat(auto-fill, minmax(150px,1fr));gap:8px; }
.sub-pill {
  background:var(--bg2);border:1.5px solid var(--border);border-radius:var(--r);
  padding:14px 14px 12px;cursor:pointer;transition:all 0.2s var(--spring);
  position:relative;overflow:hidden;
}
.sub-pill:hover { border-color:var(--border2);background:var(--surface2);transform:translateY(-1px); }
.sub-pill.sel { border-color:rgba(108,112,240,0.5);background:var(--blue-soft);box-shadow:0 0 0 1px rgba(108,112,240,0.3); }
.sub-pill.mgr.sel { border-color:rgba(212,167,58,0.5);background:var(--gold-soft);box-shadow:0 0 0 1px rgba(212,167,58,0.3); }
.sub-pill.sel::before { content:'‚úì';position:absolute;top:10px;right:12px;font-size:11px;color:var(--blue);font-weight:700; }
.sub-pill.mgr.sel::before { color:var(--gold); }
.sub-avatar { width:32px;height:32px;border-radius:8px;background:var(--surface3);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:var(--text3);font-family:'JetBrains Mono',monospace;margin-bottom:8px; }
.sub-pill.sel .sub-avatar { background:linear-gradient(135deg,var(--blue),var(--red));color:#fff;border-color:transparent; }
.sub-pill.mgr.sel .sub-avatar { background:linear-gradient(135deg,var(--gold),var(--orange));color:#fff;border-color:transparent; }
.sub-name { font-size:14px;font-weight:650;color:var(--text);line-height:1.2; }
.sub-role { font-size:10px;font-weight:600;margin-top:3px;color:var(--text3);letter-spacing:0.04em; }
.sub-pill.sel .sub-role { color:var(--blue); }
.sub-pill.mgr.sel .sub-role { color:var(--gold); }

/* ‚îÄ‚îÄ Timestamp ‚îÄ‚îÄ */
.ts-grid { display:grid;grid-template-columns:1fr 1fr;gap:10px; }
.ts-block { background:var(--bg2);border:1px solid var(--border);border-radius:var(--rsm);padding:14px 16px; }
.ts-lbl { font-size:9px;font-weight:700;letter-spacing:0.14em;text-transform:uppercase;color:var(--text3);margin-bottom:6px; }
.ts-val { font-family:'Instrument Serif',Georgia,serif;font-size:20px;color:var(--text);line-height:1; }
.ts-sub { font-size:11px;color:var(--text3);margin-top:4px; }

/* ‚îÄ‚îÄ Form Elements ‚îÄ‚îÄ */
.g2 { display:grid;grid-template-columns:1fr 1fr;gap:14px; }
.g3 { display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px; }
.g4 { display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:14px; }
.s2 { grid-column:span 2; }
.sf { grid-column:1/-1; }
.mt { margin-top:16px; }
.field { display:flex;flex-direction:column;gap:5px; }
.lbl { font-size:10px;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;color:var(--text3);display:flex;align-items:center;gap:4px; }
.req { color:var(--red);font-size:13px;line-height:1; }
.hint { font-size:11px;color:var(--text3);margin-top:-1px;font-style:italic;opacity:0.7; }

input[type=text], input[type=tel], input[type=email],
input[type=number], input[type=date], select, textarea {
  background:var(--bg2);border:1.5px solid var(--border2);border-radius:var(--rsm);
  color:var(--text);font-family:'Plus Jakarta Sans',sans-serif;
  font-size:14px;padding:11px 14px;transition:all 0.18s;outline:none;
  width:100%;-webkit-appearance:none;appearance:none;
}
input:focus, select:focus, textarea:focus {
  border-color:var(--blue);background:var(--surface);
  box-shadow:0 0 0 3px rgba(108,112,240,0.1);
}
input::placeholder, textarea::placeholder { color:var(--text3);opacity:0.6; }
select {
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath fill='rgba(237,238,242,0.34)' d='M5 6L0 0h10z'/%3E%3C/svg%3E");
  background-repeat:no-repeat;background-position:right 14px center;padding-right:38px;cursor:pointer;
}
select option { background:var(--surface); }
textarea { resize:vertical;min-height:88px;line-height:1.6; }

/* ‚îÄ‚îÄ Validation ‚îÄ‚îÄ */
.field-error input, .field-error select, .field-error textarea { border-color:var(--red) !important;background:rgba(224,27,54,0.04) !important; }
.field-error .lbl { color:#F87171 !important; }
.val-msg { font-size:11px;color:#F87171;font-weight:600;margin-top:2px;display:none;animation:fadeIn 0.2s ease; }
.field-error .val-msg { display:block; }
.score-error .score-wrap { outline:2px solid var(--red);border-radius:8px; }
.score-error .val-msg { display:block; }
.pills-error .pill-group { outline:2px solid var(--red);border-radius:8px; }
.pills-error .val-msg { display:block; }
.sub-error { padding:8px 14px;background:var(--red-soft);border:1px solid rgba(224,27,54,0.3);border-radius:var(--rsm);color:#F87171;font-size:12px;font-weight:600;margin-top:6px;display:none; }
.sub-error.show { display:block; }
@keyframes fadeIn { from{opacity:0;transform:translateY(-4px);} to{opacity:1;transform:translateY(0);} }
@keyframes shake { 0%,100%{transform:translateX(0);} 10%,30%,50%,70%,90%{transform:translateX(-4px);} 20%,40%,60%,80%{transform:translateX(4px);} }
.shake { animation:shake 0.4s ease; }
.btn-loading { pointer-events:none;opacity:0.7; }
.btn-spinner { display:inline-block;width:14px;height:14px;border:2px solid rgba(255,255,255,0.3);border-top-color:#fff;border-radius:50%;animation:spin 0.6s linear infinite;vertical-align:middle;margin-right:6px; }
@keyframes spin { to{transform:rotate(360deg);} }
.toast-err { border-color:rgba(224,27,54,0.3) !important; }
.toast-err .toast-dot { background:var(--red) !important; }

.ro-display {
  background:var(--bg2);border:1.5px solid var(--border2);border-radius:var(--rsm);
  padding:11px 14px;font-size:14px;color:var(--text3);font-style:italic;
  min-height:44px;display:flex;align-items:center;
}
.ro-display.filled { font-style:normal;color:var(--gold);font-weight:600;background:var(--gold-soft);border-color:rgba(212,167,58,0.3); }

/* ‚îÄ‚îÄ Pills ‚îÄ‚îÄ */
.pill-group { display:flex;flex-wrap:wrap;gap:7px;margin-top:2px; }
.pill {
  padding:8px 15px;border-radius:20px;
  border:1.5px solid var(--border2);
  font-size:12px;font-weight:600;letter-spacing:0.02em;
  color:var(--text2);cursor:pointer;transition:all 0.18s var(--spring);
  user-select:none;background:var(--bg2);
}
.pill:hover { border-color:var(--border3);color:var(--text);transform:translateY(-1px); }
.p-red { border-color:var(--red)!important;background:var(--red-soft)!important;color:#F87171!important;box-shadow:0 0 0 1px rgba(224,27,54,0.2)!important; }
.p-green { border-color:rgba(45,212,160,0.5)!important;background:var(--green-soft)!important;color:var(--green)!important;box-shadow:0 0 0 1px rgba(45,212,160,0.2)!important; }
.p-blue { border-color:rgba(108,112,240,0.5)!important;background:var(--blue-soft)!important;color:var(--blue)!important;box-shadow:0 0 0 1px rgba(108,112,240,0.2)!important; }
.p-gold { border-color:rgba(212,167,58,0.5)!important;background:var(--gold-soft)!important;color:var(--gold)!important;box-shadow:0 0 0 1px rgba(212,167,58,0.2)!important; }

/* ‚îÄ‚îÄ Toggle ‚îÄ‚îÄ */
.tog-row {
  display:flex;align-items:center;gap:14px;
  padding:14px 16px;background:var(--bg2);
  border:1.5px solid var(--border2);border-radius:var(--rsm);
  cursor:pointer;transition:all 0.18s;
}
.tog-row:hover { border-color:var(--border3); }
.tog-row.on { border-color:rgba(108,112,240,0.4);background:var(--blue-soft); }
.tog { position:relative;width:42px;height:24px;flex-shrink:0; }
.tog input { opacity:0;width:0;height:0;position:absolute; }
.tog-track { position:absolute;inset:0;background:var(--surface3);border-radius:24px;transition:background 0.2s; }
.tog input:checked ~ .tog-track { background:var(--blue); }
.tog-knob { position:absolute;width:18px;height:18px;top:3px;left:3px;background:#fff;border-radius:50%;transition:transform 0.2s var(--spring);box-shadow:0 1px 4px rgba(0,0,0,0.3); }
.tog input:checked ~ .tog-knob { transform:translateX(18px); }
.tog-txt { font-size:14px;font-weight:600;color:var(--text); }
.tog-sub { font-size:11px;color:var(--text3);margin-top:1px; }
.expand { display:none;margin-top:14px;padding-top:14px;border-top:1px solid var(--border); }
.expand.open { display:block; }

/* ‚îÄ‚îÄ Score ‚îÄ‚îÄ */
.score-wrap { display:flex;gap:5px; }
.s-btn {
  flex:1;aspect-ratio:1;max-width:44px;
  border:1.5px solid var(--border2);border-radius:var(--rsm);
  background:var(--bg2);font-size:13px;font-weight:700;color:var(--text3);
  cursor:pointer;transition:all 0.15s var(--spring);
  display:flex;align-items:center;justify-content:center;
  font-family:'JetBrains Mono',monospace;
}
.s-btn:hover { border-color:var(--border3);color:var(--text);transform:translateY(-1px); }
.a1,.a2 { background:rgba(224,27,54,0.15)!important;border-color:rgba(224,27,54,0.4)!important;color:#F87171!important; }
.a3,.a4 { background:rgba(245,158,11,0.15)!important;border-color:rgba(245,158,11,0.4)!important;color:var(--orange)!important; }
.a5,.a6,.a7 { background:var(--blue-soft)!important;border-color:rgba(108,112,240,0.4)!important;color:var(--blue)!important; }
.a8,.a9,.a10 { background:var(--green-soft)!important;border-color:rgba(45,212,160,0.4)!important;color:var(--green)!important; }
.score-labels { font-size:11px;color:var(--text3);margin-top:7px;display:flex;justify-content:space-between; }

/* ‚îÄ‚îÄ Divider ‚îÄ‚îÄ */
.div { border:none;border-top:1px solid var(--border);margin:18px 0; }

/* ‚îÄ‚îÄ Callout ‚îÄ‚îÄ */
.callout {
  background:var(--blue-soft);border:1px solid rgba(108,112,240,0.2);
  border-radius:var(--rsm);padding:12px 16px;
  font-size:12px;color:rgba(108,112,240,0.9);font-weight:500;
  margin-bottom:16px;display:flex;gap:10px;align-items:flex-start;line-height:1.6;
}

/* ‚îÄ‚îÄ Submit Bar ‚îÄ‚îÄ */
.submit-bar {
  background:var(--surface);border:1px solid var(--border2);border-radius:var(--rlg);
  padding:22px 24px;display:flex;align-items:center;justify-content:space-between;
  margin-top:28px;gap:20px;
}
.submit-bar-title { font-family:'Instrument Serif',Georgia,serif;font-size:20px;color:var(--text); }
.submit-bar-sub { font-size:12px;color:var(--text3);margin-top:3px; }
.submit-bar-actions { display:flex;gap:8px;flex-shrink:0; }
.btn-p {
  background:var(--red);color:#fff;border:none;border-radius:var(--rsm);
  font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;font-weight:700;letter-spacing:0.04em;
  padding:12px 28px;cursor:pointer;transition:all 0.18s var(--spring);
  box-shadow:0 4px 16px -4px var(--red-glow);
}
.btn-p:hover { background:#C4162E;transform:translateY(-1px);box-shadow:0 6px 24px -4px var(--red-glow); }
.btn-p:active { transform:scale(0.97); }
.btn-g {
  background:transparent;color:var(--text2);border:1.5px solid var(--border2);
  border-radius:var(--rsm);font-family:'Plus Jakarta Sans',sans-serif;
  font-size:13px;font-weight:600;padding:12px 20px;cursor:pointer;transition:all 0.18s;
}
.btn-g:hover { border-color:var(--border3);color:var(--text); }

/* ‚îÄ‚îÄ Preview ‚îÄ‚îÄ */
.preview-wrap { display:none;margin-top:14px; }
.preview-wrap.open { display:block; }
.preview-card {
  background:var(--surface);border:1px solid var(--border2);border-radius:var(--rlg);
  padding:24px;position:relative;overflow:hidden;
}
.preview-card::before {
  content:'';position:absolute;top:0;left:0;right:0;height:2px;
  background:linear-gradient(90deg,var(--red),var(--gold));
}
.preview-header { display:flex;align-items:center;justify-content:space-between;margin-bottom:18px; }
.preview-label { font-size:10px;font-weight:700;letter-spacing:0.16em;text-transform:uppercase;color:var(--text3); }
.preview-badge { font-size:10px;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;padding:4px 12px;border-radius:20px;border:1px solid var(--border2);color:var(--text3); }
.preview-grid { display:grid;grid-template-columns:140px 1fr;gap:6px 14px; }
.pk { font-size:11px;font-weight:500;color:var(--text3);letter-spacing:0.04em;align-self:center; }
.pv { font-size:13px;color:var(--text2);font-weight:500; }
.pv.hl { color:var(--gold);font-weight:700; }
.pdiv { grid-column:1/-1;border-top:1px solid var(--border);margin:3px 0; }

/* ‚îÄ‚îÄ Toast ‚îÄ‚îÄ */
.toast {
  position:fixed;bottom:28px;left:50%;
  transform:translateX(-50%) translateY(100px);
  background:var(--surface);color:var(--text);
  padding:13px 24px;border-radius:40px;
  font-size:13px;font-weight:600;
  display:flex;align-items:center;gap:10px;
  box-shadow:0 12px 48px rgba(0,0,0,0.5);
  transition:transform 0.4s var(--spring);
  z-index:999;white-space:nowrap;
  border:1px solid var(--border2);
}
.toast.show { transform:translateX(-50%) translateY(0); }
.toast-dot { width:8px;height:8px;border-radius:50%;background:var(--green);flex-shrink:0;animation:pulse 1.4s ease infinite; }
@keyframes pulse { 0%,100%{opacity:1;} 50%{opacity:0.4;} }

/* ‚îÄ‚îÄ Recent Entries ‚îÄ‚îÄ */
.recent-section { margin-top:32px;padding-top:20px;border-top:1px solid var(--border); }
.recent-header { display:flex;align-items:center;justify-content:space-between;margin-bottom:12px; }
.recent-label { font-size:10px;font-weight:700;letter-spacing:0.16em;text-transform:uppercase;color:var(--text3); }
.recent-refresh { font-size:11px;font-weight:600;color:var(--text3);background:none;border:none;cursor:pointer;font-family:'Plus Jakarta Sans',sans-serif;transition:color 0.15s; }
.recent-refresh:hover { color:var(--text); }
.recent-entry {
  display:flex;align-items:center;justify-content:space-between;
  padding:12px 14px;background:var(--bg2);border:1px solid var(--border);
  border-radius:var(--rsm);margin-bottom:6px;transition:all 0.15s;
}
.recent-entry:hover { border-color:var(--border2); }
.re-name { font-size:13px;font-weight:700;color:var(--text); }
.re-name span { color:var(--text3);font-weight:400; }
.re-meta { font-size:11px;color:var(--text3);margin-top:2px; }
.re-edit {
  padding:6px 14px;border-radius:8px;background:var(--blue-soft);
  border:1px solid rgba(108,112,240,0.2);color:var(--blue);
  font-size:12px;font-weight:700;cursor:pointer;
  font-family:'Plus Jakarta Sans',sans-serif;white-space:nowrap;transition:all 0.15s;
}
.re-edit:hover { background:rgba(108,112,240,0.18);transform:translateY(-1px); }

/* ‚îÄ‚îÄ Edit Modal ‚îÄ‚îÄ */
.modal-overlay { position:fixed;inset:0;background:rgba(0,0,0,0.75);z-index:500;display:none;align-items:center;justify-content:center;padding:20px; }
.modal-overlay.open { display:flex; }
.modal-box {
  background:var(--surface);border:1px solid var(--border2);border-radius:var(--rlg);
  width:100%;max-width:600px;max-height:88vh;overflow-y:auto;position:relative;
}
.modal-box::before { content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--blue),var(--red));border-radius:var(--rlg) var(--rlg) 0 0; }
.modal-header { padding:22px 24px 0;display:flex;align-items:center;justify-content:space-between;margin-bottom:18px; }
.modal-title { font-family:'Instrument Serif',Georgia,serif;font-size:24px;color:var(--text); }
.modal-close { background:none;border:none;color:var(--text3);font-size:20px;cursor:pointer;padding:4px 8px;border-radius:6px;transition:color 0.15s; }
.modal-close:hover { color:var(--text); }
.modal-body { padding:0 24px 24px; }
.modal-field { margin-bottom:14px; }
.modal-label { font-size:10px;font-weight:700;letter-spacing:0.12em;text-transform:uppercase;color:var(--text3);display:block;margin-bottom:6px; }
.modal-input,.modal-select,.modal-textarea {
  width:100%;background:var(--bg2);border:1.5px solid var(--border2);border-radius:var(--rsm);
  color:var(--text);font-family:'Plus Jakarta Sans',sans-serif;font-size:14px;
  padding:11px 14px;transition:border-color 0.18s;-webkit-appearance:none;
}
.modal-input:focus,.modal-select:focus,.modal-textarea:focus { outline:none;border-color:var(--blue);box-shadow:0 0 0 3px rgba(108,112,240,0.1); }
.modal-textarea { resize:none;min-height:72px; }
.modal-select option { background:var(--surface); }
.modal-grid { display:grid;grid-template-columns:1fr 1fr;gap:12px; }
.modal-footer { display:flex;gap:10px;margin-top:20px; }
.modal-save { flex:1;padding:13px;border-radius:var(--rsm);background:var(--blue);color:#fff;border:none;font-family:'Plus Jakarta Sans',sans-serif;font-size:14px;font-weight:700;cursor:pointer;transition:all 0.18s; }
.modal-save:hover { transform:translateY(-1px);box-shadow:0 6px 16px rgba(108,112,240,0.3); }
.modal-cancel { padding:13px 20px;border-radius:var(--rsm);background:var(--bg2);border:1.5px solid var(--border2);color:var(--text3);font-family:'Plus Jakarta Sans',sans-serif;font-size:14px;font-weight:600;cursor:pointer; }
.modal-cancel:hover { color:var(--text); }
.modal-del { padding:13px 14px;border-radius:var(--rsm);background:var(--red-soft);border:1px solid rgba(224,27,54,0.25);color:#FC8181;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;font-weight:600;cursor:pointer; }
.modal-del:hover { background:rgba(224,27,54,0.18); }

/* Edit toast */
.edit-toast {
  position:fixed;bottom:28px;left:50%;transform:translateX(-50%) translateY(80px);
  background:var(--surface);border:1px solid var(--border2);border-radius:12px;
  padding:12px 22px;font-size:13px;font-weight:600;color:var(--text);z-index:999;
  transition:transform 0.35s var(--spring);box-shadow:0 12px 32px rgba(0,0,0,0.4);white-space:nowrap;
}
.edit-toast.show { transform:translateX(-50%) translateY(0); }
.edit-toast.green { border-color:rgba(45,212,160,0.3);color:var(--green); }

/* ‚îÄ‚îÄ Animations ‚îÄ‚îÄ */
@keyframes fadeUp { from{opacity:0;transform:translateY(14px);} to{opacity:1;transform:translateY(0);} }

/* ‚îÄ‚îÄ Responsive ‚îÄ‚îÄ */
@media(max-width:680px){
  .page { padding:20px 16px 100px; }
  .card { padding:20px 16px; }
  .g2,.g3,.g4 { grid-template-columns:1fr; }
  .s2,.sf { grid-column:1; }
  .submit-bar { flex-direction:column;text-align:center; }
  .submit-bar-actions { flex-direction:column;width:100%; }
  .btn-p,.btn-g { width:100%;text-align:center; }
  .ts-grid { grid-template-columns:1fr; }
  .preview-grid { grid-template-columns:120px 1fr; }
  .modal-grid { grid-template-columns:1fr; }
}
</style>
</head>
<body>

<div class="bg-noise"></div>
<div class="bg-grad"></div>

<!-- ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ -->
<header class="app-header">
  <div class="header-left">
    <div class="header-logo">
      <svg viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2.5" stroke-linecap="round"><path d="M12 5v14M5 12h14"/></svg>
    </div>
    <div class="header-title">S2S Entry</div>
  </div>
  <div class="header-right">
    <span class="header-user" id="hdr-user"></span>
    <button class="hamburger" id="hamburger" onclick="toggleMenu()" aria-label="Menu">
      <span></span><span></span><span></span>
    </button>
    <div class="nav-dropdown" id="nav-dropdown">
      <div class="nav-user-info">
        <span class="nav-user-display" id="nav-user-display"></span>
        <span class="nav-role-pill" id="nav-role-pill"></span>
      </div>
      <div class="dd-divider"></div>
      <a href="app.html" class="dd-item"><span class="dd-icon">üè†</span> Home</a>
      <a href="service-to-sales-log.html" class="dd-item active-page"><span class="dd-icon">üìã</span> S2S Entry</a>
      <a href="manager-dashboard.html" class="dd-item"><span class="dd-icon">üìä</span> Dashboard</a>
      <a href="scorecards.html" class="dd-item"><span class="dd-icon">üèÜ</span> Scorecards</a>
      <div class="dd-divider dd-admin" id="dd-admin-divider"></div>
      <a href="admin-panel.html" class="dd-item dd-admin" id="dd-admin-link"><span class="dd-icon">‚öôÔ∏è</span> Admin Panel</a>
    </div>
  </div>
</header>
<div class="nav-overlay" id="nav-overlay" onclick="closeMenu()"></div>

<!-- ‚îÄ‚îÄ PROGRESS ‚îÄ‚îÄ -->
<div class="progress-bar">
  <div class="step active" id="s1"><div class="step-n">1</div>Submitter</div>
  <div class="step" id="s2"><div class="step-n">2</div>Customer</div>
  <div class="step" id="s3"><div class="step-n">3</div>Vehicle</div>
  <div class="step" id="s4"><div class="step-n">4</div>Service</div>
  <div class="step" id="s5"><div class="step-n">5</div>Sales</div>
  <div class="step" id="s6"><div class="step-n">6</div>Outcome</div>
</div>

<!-- ‚îÄ‚îÄ PAGE ‚îÄ‚îÄ -->
<div class="page">

  <!-- 01 SUBMITTER -->
  <div class="section-head">
    <div class="sh-left">
      <div class="sh-eyebrow">Step 01</div>
      <div class="sh-title">Who's Logging This?</div>
      <div class="sh-desc">Select your name ‚Äî auto-assigns and timestamps on submit</div>
    </div>
    <div class="sh-num">01 / 06</div>
  </div>
  <div class="card">
    <div class="sub-grid">
      <div class="sub-pill mgr" onclick="selectSub(this,'Tyler Doyle','S2S Manager','manager')">
        <div class="sub-avatar">TD</div>
        <div class="sub-name">Tyler Doyle</div><div class="sub-role">S2S Manager</div>
      </div>
      <div class="sub-pill" onclick="selectSub(this,'Andrew Kirk','Sales Consultant','sales')">
        <div class="sub-avatar">AK</div>
        <div class="sub-name">Andrew Kirk</div><div class="sub-role">Sales</div>
      </div>
      <div class="sub-pill" onclick="selectSub(this,'DJ Rogers','Sales Consultant','sales')">
        <div class="sub-avatar">DJ</div>
        <div class="sub-name">DJ Rogers</div><div class="sub-role">Sales</div>
      </div>
      <div class="sub-pill" onclick="selectSub(this,'Kody McCann','Sales Consultant','sales')">
        <div class="sub-avatar">KM</div>
        <div class="sub-name">Kody McCann</div><div class="sub-role">Sales</div>
      </div>
    </div>
    <input type="hidden" id="sub-name"><input type="hidden" id="sub-role">
    <div class="sub-error" id="sub-error">Select your name to continue</div>
  </div>

  <!-- TIMESTAMP -->
  <div class="card">
    <div class="ts-grid">
      <div class="ts-block"><div class="ts-lbl">Date</div><div class="ts-val" id="ts-date">‚Äî</div><div class="ts-sub" id="ts-day">Loading...</div></div>
      <div class="ts-block"><div class="ts-lbl">Time (CT)</div><div class="ts-val" id="ts-time">‚Äî</div><div class="ts-sub">Auto-captured on submit</div></div>
    </div>
  </div>

  <!-- 02 CUSTOMER -->
  <div class="section-head">
    <div class="sh-left">
      <div class="sh-eyebrow">Step 02</div>
      <div class="sh-title">Customer Information</div>
      <div class="sh-desc">Contact details for follow-up and CRM entry</div>
    </div>
    <div class="sh-num">02 / 06</div>
  </div>
  <div class="card">
    <div class="g2">
      <div class="field" id="f-fname"><label class="lbl">First Name <span class="req">*</span></label><input type="text" id="fname" placeholder="First name"><div class="val-msg">First name is required</div></div>
      <div class="field" id="f-lname"><label class="lbl">Last Name <span class="req">*</span></label><input type="text" id="lname" placeholder="Last name"><div class="val-msg">Last name is required</div></div>
      <div class="field" id="f-phone"><label class="lbl">Phone Number <span class="req">*</span></label><input type="tel" id="phone" placeholder="(615) 000-0000"><div class="val-msg">Phone number is required</div></div>
      <div class="field"><label class="lbl">Email Address</label><input type="email" id="email" placeholder="customer@email.com"></div>
      <div class="field"><label class="lbl">Preferred Contact</label>
        <select id="cpref"><option value="">Select...</option><option>Phone Call</option><option>Text Message</option><option>Email</option><option>No Preference</option></select>
      </div>
      <div class="field"><label class="lbl">Best Time to Reach</label>
        <select id="ctime"><option value="">Select...</option><option>Morning (8am‚Äì12pm)</option><option>Afternoon (12pm‚Äì5pm)</option><option>Evening (5pm‚Äì7pm)</option><option>Anytime</option></select>
      </div>
    </div>
  </div>

  <!-- 03 VEHICLE -->
  <div class="section-head">
    <div class="sh-left">
      <div class="sh-eyebrow">Step 03</div>
      <div class="sh-title">Customer's Current Vehicle</div>
      <div class="sh-desc">The vehicle they drove in for service today</div>
    </div>
    <div class="sh-num">03 / 06</div>
  </div>
  <div class="card">
    <div class="g4">
      <div class="field" id="f-vy"><label class="lbl">Year <span class="req">*</span></label><select id="vy"><option value="">Year</option></select><div class="val-msg">Year is required</div></div>
      <div class="field" id="f-vmk"><label class="lbl">Make <span class="req">*</span></label><select id="vmk"><option value="">Make</option></select><div class="val-msg">Make is required</div></div>
      <div class="field" id="f-vmd"><label class="lbl">Model <span class="req">*</span></label><select id="vmd"><option value="">Model</option></select><div class="val-msg">Model is required</div></div>
      <div class="field"><label class="lbl">Mileage</label><input type="number" id="vmi" placeholder="e.g. 72000"></div>
    </div>
    <div class="g3 mt">
      <div class="field"><label class="lbl">Trim / Package</label><input type="text" id="vtr" placeholder="e.g. Laramie, Sport"></div>
      <div class="field"><label class="lbl">Color</label><input type="text" id="vcl" placeholder="e.g. Bright White"></div>
      <div class="field"><label class="lbl">Ownership</label>
        <select id="vow"><option value="">Select...</option><option>Paid Off / Own Outright</option><option>Financing</option><option>Leasing</option><option>Unknown</option></select>
      </div>
    </div>
    <hr class="div">
    <div class="g3">
      <div class="field"><label class="lbl">Est. Payoff</label><input type="text" id="vpay" placeholder="$0,000"><div class="hint">If financing ‚Äî approx. owed</div></div>
      <div class="field"><label class="lbl">Lease End</label><input type="text" id="vlease" placeholder="MM/YYYY"><div class="hint">If leasing ‚Äî when expires?</div></div>
      <div class="field"><label class="lbl">Condition</label>
        <select id="vcond"><option value="">Select...</option><option>Excellent</option><option>Good</option><option>Fair</option><option>Poor</option></select>
      </div>
    </div>
  </div>

  <!-- 04 SERVICE VISIT -->
  <div class="section-head">
    <div class="sh-left">
      <div class="sh-eyebrow">Step 04</div>
      <div class="sh-title">Service Visit Details</div>
      <div class="sh-desc">Capture the reason for today's visit</div>
    </div>
    <div class="sh-num">04 / 06</div>
  </div>
  <div class="card">
    <div class="callout"><span>‚ÑπÔ∏è</span><span>High-opportunity triggers: repair estimates over $1,500, high-mileage vehicles, repeat failures, or customers expressing frustration.</span></div>
    <div class="g2">
      <div class="field"><label class="lbl">RO #</label><input type="text" id="ro" placeholder="e.g. RO-24871"></div>
      <div class="field"><label class="lbl">Service Advisor</label><input type="text" id="sva" placeholder="Advisor name"></div>
      <div class="field s2"><label class="lbl">Primary Reason for Visit</label>
        <select id="vreason"><option value="">Select...</option><option>Routine Maintenance (Oil, Tires, Filters)</option><option>Scheduled Service / Recall</option><option>Major Mechanical Repair</option><option>Transmission / Drivetrain</option><option>Engine Concern</option><option>Electrical / Technology Issue</option><option>Body / Collision</option><option>High Mileage Service</option><option>Safety ‚Äî Brakes / Suspension</option><option>Customer Pay ‚Äî Other</option><option>Warranty Claim</option></select>
      </div>
    </div>
    <hr class="div">
    <div class="g3">
      <div class="field"><label class="lbl">Est. Repair Cost</label><input type="text" id="rcost" placeholder="$0,000"></div>
      <div class="field"><label class="lbl">Cost vs. Value</label>
        <select id="rratio"><option value="">Select...</option><option>Low ‚Äî Under 20%</option><option>Moderate ‚Äî 20‚Äì40%</option><option>High ‚Äî 40‚Äì75%</option><option>Exceeds vehicle value</option></select>
      </div>
      <div class="field"><label class="lbl">Customer Emotion</label>
        <select id="cemo"><option value="">Select...</option><option>Satisfied / Neutral</option><option>Frustrated with Cost</option><option>Frustrated with Reliability</option><option>Anxious / Stressed</option><option>Open &amp; Receptive</option><option>Excited / Considering Upgrade</option></select>
      </div>
    </div>
    <hr class="div">
    <div class="field"><label class="lbl">Sales Introduction Made?</label>
      <div class="pill-group">
        <div class="pill" onclick="ps(this,'intro','Yes ‚Äî by Service Advisor','p-green')">Yes ‚Äî by Service Advisor</div>
        <div class="pill" onclick="ps(this,'intro','Yes ‚Äî by Sales Team','p-green')">Yes ‚Äî by Sales Team</div>
        <div class="pill" onclick="ps(this,'intro','No ‚Äî walked to showroom','p-blue')">No ‚Äî walked to showroom</div>
        <div class="pill" onclick="ps(this,'intro','No ‚Äî phone/follow-up only','p-gold')">No ‚Äî phone/follow-up only</div>
      </div>
      <input type="hidden" id="intro">
    </div>
  </div>

  <!-- 05 SALES ACTIVITY -->
  <div class="section-head">
    <div class="sh-left">
      <div class="sh-eyebrow">Step 05</div>
      <div class="sh-title">Sales Activity & Engagement</div>
      <div class="sh-desc">Document the sales interaction</div>
    </div>
    <div class="sh-num">05 / 06</div>
  </div>
  <div class="card">
    <div class="field" style="margin-bottom:16px;">
      <label class="lbl">Trade-In Interest</label>
      <div class="tog-row" id="tr-row" onclick="tog('tr-cb','tr-exp','tr-row')">
        <label class="tog" onclick="event.stopPropagation()"><input type="checkbox" id="tr-cb" onchange="tog('tr-cb','tr-exp','tr-row')"><div class="tog-track"></div><div class="tog-knob"></div></label>
        <div><div class="tog-txt">Customer interested in trading</div><div class="tog-sub">Enable to capture trade details</div></div>
      </div>
      <div class="expand" id="tr-exp">
        <div class="g3">
          <div class="field"><label class="lbl">Est. ACV</label><input type="text" id="tacv" placeholder="$0,000"></div>
          <div class="field"><label class="lbl">Customer's Expected</label><input type="text" id="texp" placeholder="$0,000"><div class="hint">What do they think it's worth?</div></div>
          <div class="field"><label class="lbl">Equity Position</label>
            <select id="teq"><option value="">Select...</option><option>Positive Equity</option><option>At or Near Breakeven</option><option>Negative Equity</option><option>Unknown</option></select>
          </div>
        </div>
      </div>
    </div>

    <div class="field" style="margin-bottom:16px;">
      <label class="lbl">Vehicle Shown or Discussed?</label>
      <div class="tog-row" id="vh-row" onclick="tog('vh-cb','vh-exp','vh-row')">
        <label class="tog" onclick="event.stopPropagation()"><input type="checkbox" id="vh-cb" onchange="tog('vh-cb','vh-exp','vh-row')"><div class="tog-track"></div><div class="tog-knob"></div></label>
        <div><div class="tog-txt">Yes ‚Äî a vehicle was presented</div><div class="tog-sub">Enable to capture vehicle of interest</div></div>
      </div>
      <div class="expand" id="vh-exp">
        <div class="g3">
          <div class="field"><label class="lbl">Vehicle of Interest</label><input type="text" id="voi" placeholder="e.g. 2024 Ram 1500 Laramie"></div>
          <div class="field"><label class="lbl">New or Used?</label>
            <select id="voity"><option value="">Select...</option><option>New</option><option>Used / CPO</option><option>Either / Open</option></select>
          </div>
          <div class="field"><label class="lbl">Monthly Budget</label><input type="text" id="voibdg" placeholder="e.g. $500/mo"></div>
        </div>
      </div>
    </div>

    <hr class="div">
    <div class="g2" style="margin-bottom:16px;">
      <div class="field"><label class="lbl">Finance Conversation</label>
        <select id="finconv"><option value="">Select...</option><option>Not Discussed</option><option>Good Credit Mentioned</option><option>Credit Concerns</option><option>Pre-Approval Initiated</option><option>Outside Financing</option><option>Cash Buyer</option></select>
      </div>
      <div class="field"><label class="lbl">Purchase Timeline</label>
        <select id="timeline"><option value="">Select...</option><option>Immediate ‚Äî Ready Now</option><option>Within 30 Days</option><option>1‚Äì3 Months</option><option>3‚Äì6 Months</option><option>6+ Months / Just Looking</option><option>Unknown</option></select>
      </div>
    </div>

    <div class="field" id="f-escore">
      <label class="lbl">Customer Buying Temperature <span class="req">*</span></label>
      <div class="hint" style="margin-bottom:8px;">Rate 1 (cold) to 10 (ready to sign)</div>
      <div class="score-wrap" id="score-wrap"></div>
      <div class="score-labels"><span>Cold</span><span>Warm</span><span>Hot üî•</span></div>
      <input type="hidden" id="escore">
      <div class="val-msg">Select a buying temperature (1‚Äì10)</div>
    </div>
  </div>

  <!-- 06 OUTCOME -->
  <div class="section-head">
    <div class="sh-left">
      <div class="sh-eyebrow">Step 06</div>
      <div class="sh-title">Outcome & Next Steps</div>
      <div class="sh-desc">Record disposition and assign follow-up</div>
    </div>
    <div class="sh-num">06 / 06</div>
  </div>
  <div class="card">
    <div class="field" id="f-outcome" style="margin-bottom:18px;">
      <label class="lbl">Disposition / Outcome <span class="req">*</span></label>
      <div class="pill-group">
        <div class="pill" onclick="ps(this,'outcome','New Vehicle Sold','p-green')">üèÜ New Vehicle Sold</div>
        <div class="pill" onclick="ps(this,'outcome','Used Vehicle Sold','p-green')">üèÜ Used Vehicle Sold</div>
        <div class="pill" onclick="ps(this,'outcome','Appointment Set','p-blue')">üìÖ Appointment Set</div>
        <div class="pill" onclick="ps(this,'outcome','Follow-Up Required','p-gold')">üîî Follow-Up Required</div>
        <div class="pill" onclick="ps(this,'outcome','Not Interested','p-red')">‚úó Not Interested</div>
      </div>
      <input type="hidden" id="outcome">
      <div class="val-msg">Select an outcome</div>
    </div>
    <div class="g2">
      <div class="field"><label class="lbl">Assigned Salesperson</label><div class="ro-display" id="sp-disp">Select your name above to auto-assign</div><input type="hidden" id="sp"></div>
      <div class="field"><label class="lbl">Follow-Up Date</label><input type="date" id="fdate"></div>
      <div class="field"><label class="lbl">Follow-Up Method</label>
        <select id="fmeth"><option value="">Select...</option><option>Phone Call</option><option>Text Message</option><option>Email</option><option>In-Person at Next Visit</option></select>
      </div>
      <div class="field"><label class="lbl">Push to CRM</label>
        <div class="tog-row" id="crm-row" onclick="document.getElementById('crm-cb').checked=!document.getElementById('crm-cb').checked;document.getElementById('crm-row').classList.toggle('on',document.getElementById('crm-cb').checked);">
          <div style="flex:1;"><div style="font-size:13px;font-weight:600;color:var(--text);">Auto-push to CRM</div><div style="font-size:11px;color:var(--text3);margin-top:1px;">Customer will be sent to CRM after entry is logged</div></div>
          <label class="tog"><input type="checkbox" id="crm-cb"><div class="tog-track"></div><div class="tog-knob"></div></label>
        </div>
        <input type="hidden" id="crm" value="">
      </div>
      <div class="field sf"><label class="lbl">Notes & Context</label>
        <textarea id="notes" placeholder="Key objections, preferences, personal details, agreed follow-up talking points..."></textarea>
      </div>
    </div>
  </div>

  <!-- SUBMIT -->
  <div class="submit-bar">
    <div>
      <div class="submit-bar-title">Ready to submit?</div>
      <div class="submit-bar-sub">Logs to Supabase and sends notifications.</div>
    </div>
    <div class="submit-bar-actions">
      <button class="btn-g" onclick="resetForm()">Clear</button>
      <button class="btn-p" id="submit-btn" onclick="submitLog()">Submit Entry ‚Üí</button>
    </div>
  </div>

  <!-- PREVIEW -->
  <div class="preview-wrap" id="preview-wrap">
    <div class="preview-card">
      <div class="preview-header">
        <div class="preview-label">Entry Preview</div>
        <div class="preview-badge">ServiceBridge</div>
      </div>
      <div class="preview-grid" id="preview-grid"></div>
    </div>
  </div>

  <!-- RECENT ENTRIES -->
  <div class="recent-section">
    <div class="recent-header">
      <div class="recent-label">Recent Submissions</div>
      <button class="recent-refresh" onclick="loadRecent()">‚Üª Refresh</button>
    </div>
    <div id="recent-entries"><p style="color:var(--text3);font-size:13px;">Loading...</p></div>
  </div>

</div>

<!-- TOAST -->
<div class="toast" id="toast"><div class="toast-dot"></div><span id="toast-msg">Entry logged successfully ‚úì</span></div>

<!-- EDIT MODAL -->
<div class="modal-overlay" id="edit-modal">
  <div class="modal-box">
    <div class="modal-header">
      <div class="modal-title">Edit Entry</div>
      <button class="modal-close" onclick="closeModal()">‚úï</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="edit-id">
      <div class="modal-grid">
        <div class="modal-field"><label class="modal-label">Submitter</label>
          <select class="modal-select" id="edit-submitter"><option>Tyler Doyle</option><option>Andrew Kirk</option><option>DJ Rogers</option><option>Kody McCann</option></select>
        </div>
        <div class="modal-field"><label class="modal-label">First Name</label><input class="modal-input" id="edit-first" type="text"></div>
      </div>
      <div class="modal-grid">
        <div class="modal-field"><label class="modal-label">Last Name</label><input class="modal-input" id="edit-last" type="text"></div>
        <div class="modal-field"><label class="modal-label">Phone</label><input class="modal-input" id="edit-phone" type="text"></div>
      </div>
      <div class="modal-grid">
        <div class="modal-field"><label class="modal-label">Vehicle Year</label><input class="modal-input" id="edit-year" type="text"></div>
        <div class="modal-field"><label class="modal-label">Make</label><input class="modal-input" id="edit-make" type="text"></div>
      </div>
      <div class="modal-grid">
        <div class="modal-field"><label class="modal-label">Model</label><input class="modal-input" id="edit-model" type="text"></div>
        <div class="modal-field"><label class="modal-label">Repair Cost ($)</label><input class="modal-input" id="edit-repair" type="text"></div>
      </div>
      <div class="modal-grid">
        <div class="modal-field"><label class="modal-label">Outcome</label>
          <select class="modal-select" id="edit-outcome"><option>Sold New</option><option>Sold Used</option><option>Appointment Set</option><option>Working Deal</option><option>Follow-Up Required</option><option>Not Interested</option><option>No Show</option></select>
        </div>
        <div class="modal-field"><label class="modal-label">Engagement Score (1-10)</label><input class="modal-input" id="edit-score" type="number" min="1" max="10"></div>
      </div>
      <div class="modal-field"><label class="modal-label">Notes</label><textarea class="modal-textarea" id="edit-notes"></textarea></div>
      <div class="modal-footer">
        <button class="modal-cancel" onclick="closeModal()">Cancel</button>
        <button class="modal-del" onclick="deleteEntry()">üóë Delete</button>
        <button class="modal-save" onclick="saveEdit()">‚úì Save Changes</button>
      </div>
    </div>
  </div>
</div>
<div class="edit-toast" id="edit-toast"></div>

<script>
const SB_URL = 'https://jbkgwtohwsbaorhvuuqb.supabase.co';
const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impia2d3dG9od3NiYW9yaHZ1dXFiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5NjkwNDIsImV4cCI6MjA4NzU0NTA0Mn0.GRXOYbIuVDxU9-FEBYmyd1QmytVUrMIAxbnOSfepzuU';
const H = {'apikey':SB_KEY,'Authorization':'Bearer '+SB_KEY,'Content-Type':'application/json'};
const currentRep = JSON.parse(sessionStorage.getItem('sb_rep')||'null');

// ‚îÄ‚îÄ NAV INIT ‚îÄ‚îÄ
(function initNav(){
  if(!currentRep) return;
  const first = currentRep.first_name || currentRep.name.split(' ')[0];
  document.getElementById('hdr-user').textContent = first;
  document.getElementById('nav-user-display').textContent = currentRep.name;
  const pillEl = document.getElementById('nav-role-pill');
  const role = (currentRep.role||'sales').toLowerCase();
  pillEl.textContent = role.charAt(0).toUpperCase()+role.slice(1);
  pillEl.className = 'nav-role-pill '+(role==='admin'?'role-admin':role==='manager'?'role-manager':'role-sales');
  if(role==='admin'){
    document.getElementById('dd-admin-link').classList.add('show');
    document.getElementById('dd-admin-divider').classList.add('show');
  }
})();

function toggleMenu(){
  const hb=document.getElementById('hamburger'),dd=document.getElementById('nav-dropdown'),ov=document.getElementById('nav-overlay');
  const isOpen=dd.classList.contains('open');
  hb.classList.toggle('open',!isOpen);dd.classList.toggle('open',!isOpen);ov.classList.toggle('open',!isOpen);
}
function closeMenu(){
  document.getElementById('hamburger').classList.remove('open');
  document.getElementById('nav-dropdown').classList.remove('open');
  document.getElementById('nav-overlay').classList.remove('open');
}

// ‚îÄ‚îÄ CLOCK ‚îÄ‚îÄ
function tick(){
  const n=new Date(),mo=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'],
  da=['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
  document.getElementById('ts-date').textContent=`${mo[n.getMonth()]} ${n.getDate()}, ${n.getFullYear()}`;
  document.getElementById('ts-day').textContent=da[n.getDay()];
  document.getElementById('ts-time').textContent=n.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:true});
}
tick();setInterval(tick,1000);

// ‚îÄ‚îÄ YEARS ‚îÄ‚îÄ
const vy=document.getElementById('vy');
for(let y=new Date().getFullYear()+1;y>=2000;y--) vy.innerHTML+=`<option value="${y}">${y}</option>`;

// ‚îÄ‚îÄ MAKES / MODELS ‚îÄ‚îÄ
const vd={"Acura":["ILX","MDX","RDX","TLX","RLX"],"BMW":["3 Series","5 Series","X3","X5","X7","7 Series"],"Buick":["Enclave","Encore","Encore GX","Envision"],"Cadillac":["CT4","CT5","Escalade","XT4","XT5","XT6"],"Chevrolet":["Colorado","Silverado 1500","Silverado 2500","Equinox","Traverse","Tahoe","Suburban","Malibu","Blazer","Trailblazer"],"Chrysler":["300","Pacifica","Voyager"],"Dodge":["Challenger","Charger","Durango","Grand Caravan"],"Ford":["F-150","F-250","F-350","Explorer","Edge","Escape","Expedition","Mustang","Bronco","Ranger","Maverick"],"GMC":["Sierra 1500","Sierra 2500","Canyon","Terrain","Acadia","Yukon","Yukon XL"],"Honda":["Accord","Civic","CR-V","HR-V","Odyssey","Pilot","Ridgeline","Passport"],"Hyundai":["Elantra","Tucson","Santa Fe","Palisade","Sonata","Kona"],"Jeep":["Wrangler","Grand Cherokee","Cherokee","Compass","Renegade","Gladiator","Wagoneer","Grand Wagoneer"],"Kia":["Sorento","Telluride","Sportage","Forte","K5","Carnival"],"Lexus":["ES","RX","NX","GX","LX","IS"],"Lincoln":["Navigator","Aviator","Corsair","Nautilus"],"Mazda":["CX-5","CX-9","Mazda3","Mazda6","CX-30","MX-5 Miata"],"Mercedes-Benz":["C-Class","E-Class","GLC","GLE","GLS","S-Class"],"Nissan":["Altima","Sentra","Maxima","Rogue","Pathfinder","Frontier","Titan","Murano","Armada"],"Ram":["1500","2500","3500","ProMaster","ProMaster City"],"Subaru":["Outback","Forester","Crosstrek","Ascent","Impreza","Legacy"],"Tesla":["Model 3","Model Y","Model S","Model X"],"Toyota":["Camry","Corolla","RAV4","Highlander","Tacoma","Tundra","4Runner","Sequoia","Sienna","Venza","Prius","Avalon"],"Volkswagen":["Jetta","Tiguan","Atlas","Passat","ID.4"],"Volvo":["XC40","XC60","XC90","S60","V60"]};
const vmk=document.getElementById('vmk'),vmd=document.getElementById('vmd');
Object.keys(vd).sort().forEach(m=>vmk.innerHTML+=`<option value="${m}">${m}</option>`);
vmk.addEventListener('change',()=>{vmd.innerHTML='<option value="">Model</option>';(vd[vmk.value]||[]).forEach(m=>vmd.innerHTML+=`<option value="${m}">${m}</option>`);});

// ‚îÄ‚îÄ SUBMITTER ‚îÄ‚îÄ
function selectSub(el,name,role,type){
  document.querySelectorAll('.sub-pill').forEach(p=>p.classList.remove('sel'));
  el.classList.add('sel');
  document.getElementById('sub-name').value=name;
  document.getElementById('sub-role').value=type;
  document.getElementById('sp').value=name;
  const d=document.getElementById('sp-disp');
  d.textContent=name+' ‚Äî '+role;d.classList.add('filled');
  mark(1);
}

// ‚îÄ‚îÄ PILL SELECT ‚îÄ‚îÄ
function ps(el,fid,val,cls){
  el.closest('.pill-group').querySelectorAll('.pill').forEach(p=>{p.className='pill';});
  el.classList.add(cls);
  document.getElementById(fid).value=val;
  if(fid==='outcome') mark(6);
}

// ‚îÄ‚îÄ TOGGLE ‚îÄ‚îÄ
function tog(cbId,expId,rowId){
  const cb=document.getElementById(cbId),exp=document.getElementById(expId),row=document.getElementById(rowId);
  cb.checked?(exp.classList.add('open'),row.classList.add('on')):(exp.classList.remove('open'),row.classList.remove('on'));
}

// ‚îÄ‚îÄ SCORE ‚îÄ‚îÄ
const sw=document.getElementById('score-wrap');
for(let i=1;i<=10;i++){
  const b=document.createElement('button');
  b.type='button';b.className='s-btn';b.textContent=i;
  b.onclick=function(){
    document.querySelectorAll('.s-btn').forEach(x=>{x.className='s-btn';});
    this.classList.add(`a${i}`);
    document.getElementById('escore').value=i;
    mark(5);
  };
  sw.appendChild(b);
}

// ‚îÄ‚îÄ PHONE FORMAT ‚îÄ‚îÄ
document.getElementById('phone').addEventListener('input',function(){
  let v=this.value.replace(/\D/g,'');
  if(v.length>=6) v=`(${v.slice(0,3)}) ${v.slice(3,6)}-${v.slice(6,10)}`;
  else if(v.length>=3) v=`(${v.slice(0,3)}) ${v.slice(3)}`;
  this.value=v;
});

// ‚îÄ‚îÄ PROGRESS ‚îÄ‚îÄ
function mark(n){const s=document.getElementById(`s${n}`);if(!s)return;s.classList.add('done');s.classList.remove('active');s.querySelector('.step-n').textContent='‚úì';}
['fname','lname'].forEach(id=>document.getElementById(id).addEventListener('input',()=>mark(2)));
['vy','vmk','vmd'].forEach(id=>document.getElementById(id).addEventListener('change',()=>mark(3)));
document.getElementById('vreason').addEventListener('change',()=>mark(4));

// ‚îÄ‚îÄ GET VALUE ‚îÄ‚îÄ
const gv=id=>{const e=document.getElementById(id);return e?(e.value||'‚Äî'):'‚Äî';};

// ‚îÄ‚îÄ SUBMIT ‚îÄ‚îÄ
// ‚îÄ‚îÄ Push to CRM (toggle ‚Äî fires after submit) ‚îÄ‚îÄ
function isCRMEnabled(){ return document.getElementById('crm-cb').checked; }

function executeCRMPush(entry){
  document.getElementById('crm').value='Yes ‚Äî pushed to CRM';
  // Replace this timeout with actual CRM API integration (VinSolutions, DealerSocket, etc.)
  console.log('CRM push fired for:',entry.first_name,entry.last_name,entry.phone);
}

// ‚îÄ‚îÄ Phone auto-format ‚îÄ‚îÄ
document.getElementById('phone').addEventListener('blur',function(){
  let v=this.value.replace(/\D/g,'');
  if(v.length===10) this.value=`(${v.slice(0,3)}) ${v.slice(3,6)}-${v.slice(6)}`;
  else if(v.length===11&&v[0]==='1') this.value=`(${v.slice(1,4)}) ${v.slice(4,7)}-${v.slice(7)}`;
});

// ‚îÄ‚îÄ Validation ‚îÄ‚îÄ
function clearErrors(){
  document.querySelectorAll('.field-error,.score-error,.pills-error').forEach(e=>e.classList.remove('field-error','score-error','pills-error'));
  document.getElementById('sub-error').classList.remove('show');
}

function validateForm(){
  clearErrors();
  const errs=[];
  function req(fid,id){const v=gv(id);if(!v||v==='‚Äî'||v===''){const el=document.getElementById(fid);if(el)el.classList.add('field-error');errs.push(fid);}}
  // Submitter
  if(!gv('sub-name')){document.getElementById('sub-error').classList.add('show');errs.push('sub-error');}
  // Customer
  req('f-fname','fname');req('f-lname','lname');req('f-phone','phone');
  // Vehicle
  req('f-vy','vy');req('f-vmk','vmk');req('f-vmd','vmd');
  // Score
  const sc=gv('escore');
  if(!sc||sc==='‚Äî'||parseInt(sc)<1||parseInt(sc)>10){const sel=document.getElementById('f-escore');if(sel)sel.classList.add('score-error');errs.push('f-escore');}
  // Outcome
  if(!gv('outcome')){const oel=document.getElementById('f-outcome');if(oel)oel.classList.add('pills-error');errs.push('f-outcome');}
  // Phone format check
  const ph=gv('phone').replace(/\D/g,'');
  if(ph&&ph.length<10){const pel=document.getElementById('f-phone');if(pel){pel.classList.add('field-error');pel.querySelector('.val-msg').textContent='Enter a valid 10-digit phone number';}errs.push('f-phone');}
  return errs;
}

function showToast(msg,isError){
  const t=document.getElementById('toast');
  document.getElementById('toast-msg').textContent=msg;
  t.classList.toggle('toast-err',!!isError);
  t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),isError?6000:4000);
}

async function submitLog(){
  // Validate
  const errs=validateForm();
  if(errs.length>0){
    const first=document.getElementById(errs[0]);
    if(first){first.scrollIntoView({behavior:'smooth',block:'center'});first.classList.add('shake');setTimeout(()=>first.classList.remove('shake'),500);}
    showToast(`${errs.length} required field${errs.length>1?'s':''} missing ‚Äî scroll up to fix`,true);
    return;
  }

  // Show loading
  const btn=document.getElementById('submit-btn');
  const origText=btn.textContent;
  btn.innerHTML='<span class="btn-spinner"></span>Submitting...';
  btn.classList.add('btn-loading');

  const n=new Date(),mo=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const ts=`${mo[n.getMonth()]} ${n.getDate()}, ${n.getFullYear()} at ${n.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:true})} CT`;
  const veh=[gv('vy'),gv('vmk'),gv('vmd')].filter(v=>v&&v!=='‚Äî').join(' ')||'‚Äî';
  const cust=(gv('fname')+' '+gv('lname')).trim()||'‚Äî';
  const score=gv('escore');
  const role=gv('sub-role');

  const entry={
    timestamp:ts,entry_type:role==='manager'?'Manager Entry':'Sales Entry',
    submitter:gv('sub-name'),first_name:gv('fname'),last_name:gv('lname'),
    phone:gv('phone'),email:gv('email'),contact_pref:gv('cpref'),best_time:gv('ctime'),
    veh_year:gv('vy')||null,veh_make:gv('vmk'),veh_model:gv('vmd'),veh_miles:gv('vmi')||null,
    veh_trim:gv('vtr'),veh_color:gv('vcl'),veh_ownership:gv('vow'),
    veh_payoff:gv('vpay'),veh_lease:gv('vlease'),veh_condition:gv('vcond'),
    ro_num:gv('ro'),svc_advisor:gv('sva'),visit_reason:gv('vreason'),
    repair_cost:gv('rcost'),repair_ratio:gv('rratio'),cust_emotion:gv('cemo'),
    intro_made:gv('intro'),
    trade_interest:document.getElementById('tr-cb').checked?'Yes':'No',
    trade_acv:gv('tacv'),trade_expect:gv('texp'),trade_equity:gv('teq'),
    voi:gv('voi'),voi_type:gv('voity'),voi_budget:gv('voibdg'),
    finance_conv:gv('finconv'),timeline:gv('timeline'),
    eng_score:parseInt(score),
    outcome:gv('outcome'),salesperson:gv('sp'),
    followup_date:gv('fdate')||null,followup_method:gv('fmeth'),
    crm_entry:gv('crm'),notes:gv('notes'),
  };

  let insertedId=null;
  try{
    const res=await fetch(`${SB_URL}/rest/v1/s2s_entries`,{
      method:'POST',headers:{...H,'Prefer':'return=representation'},body:JSON.stringify(entry)
    });
    if(!res.ok){
      let errMsg='Save failed';
      try{const errData=await res.json();errMsg=errData.message||errData.details||errData.hint||errMsg;}catch(e){}
      btn.textContent=origText;btn.classList.remove('btn-loading');
      showToast(`Error: ${errMsg}`,true);
      return;
    }
    const inserted=await res.json();
    if(inserted&&inserted.length>0) insertedId=inserted[0].id;
  }catch(err){
    btn.textContent=origText;btn.classList.remove('btn-loading');
    showToast(`Network error: ${err.message||'Check connection'}`,true);
    return;
  }

  // Create follow-up task via RPC
  let slaLabel='';
  const sc=parseInt(score);
  if(insertedId){
    try{
      const fuRes=await fetch(`${SB_URL}/rest/v1/rpc/create_followup_task`,{
        method:'POST',headers:H,
        body:JSON.stringify({p_entry_id:insertedId,p_submitter:entry.submitter,p_eng_score:sc})
      });
      if(fuRes.ok){
        const fuData=await fuRes.json();
        slaLabel=fuData.sla_label||'';
      }
    }catch(e){console.warn('Follow-up task creation failed:',e);}
  }

  // Execute CRM push if armed
  if(isCRMEnabled()) executeCRMPush(entry);

  // Reset button
  btn.textContent=origText;btn.classList.remove('btn-loading');

  // Note: Push notifications now handled server-side via Supabase webhook on INSERT
  // The edge function /functions/v1/notify fires automatically

  // Hot lead email
  if(parseInt(score)>=8){
    const recipients=['Rob.l@gallatincdjr.com','Tyler.d@gallatincdjr.com','Joe.s@gallatincdjr.com','Jbarba@weauto.us','dominick.f@gallatincdjr.com','Mich.s@gallatincdjr.com'];
    const tempColor=parseInt(score)>=9?'#C8102E':'#C49A2A';
    const emailHtml=`<!DOCTYPE html><html><body style="margin:0;padding:0;background:#F5F4F1;font-family:Arial,sans-serif;">
<div style="max-width:600px;margin:0 auto;padding:24px 16px;">
  <div style="background:#0C0C14;border-radius:12px 12px 0 0;padding:24px 28px;">
    <div style="font-size:11px;font-weight:600;letter-spacing:0.2em;text-transform:uppercase;color:rgba(255,255,255,0.4);margin-bottom:6px;">Vyaxis ¬∑ ServiceBridge</div>
    <div style="font-size:24px;font-weight:700;color:#fff;margin-bottom:4px;">üî• Hot Lead Alert</div>
    <div style="font-size:13px;color:rgba(255,255,255,0.5);">Gallatin CDJR ¬∑ Service Drive</div>
  </div>
  <div style="background:#fff;padding:28px;border-left:1px solid #E4E2DC;border-right:1px solid #E4E2DC;">
    <div style="display:inline-block;background:${tempColor};color:#fff;border-radius:6px;padding:6px 16px;font-size:14px;font-weight:700;margin-bottom:20px;">üå° Buying Temperature: ${score}/10</div>
    <table style="width:100%;border-collapse:collapse;">
      <tr><td style="padding:8px 0;border-bottom:1px solid #F0EEEB;font-size:11px;font-weight:600;letter-spacing:0.1em;text-transform:uppercase;color:#8C897F;width:35%;">Customer</td><td style="padding:8px 0;border-bottom:1px solid #F0EEEB;font-size:13px;font-weight:600;">${entry.first_name} ${entry.last_name}</td></tr>
      <tr><td style="padding:8px 0;border-bottom:1px solid #F0EEEB;font-size:11px;font-weight:600;letter-spacing:0.1em;text-transform:uppercase;color:#8C897F;">Phone</td><td style="padding:8px 0;border-bottom:1px solid #F0EEEB;font-size:13px;">${entry.phone||'‚Äî'}</td></tr>
      <tr><td style="padding:8px 0;border-bottom:1px solid #F0EEEB;font-size:11px;font-weight:600;letter-spacing:0.1em;text-transform:uppercase;color:#8C897F;">Vehicle</td><td style="padding:8px 0;border-bottom:1px solid #F0EEEB;font-size:13px;">${entry.veh_year||''} ${entry.veh_make||''} ${entry.veh_model||''}</td></tr>
      <tr><td style="padding:8px 0;border-bottom:1px solid #F0EEEB;font-size:11px;font-weight:600;letter-spacing:0.1em;text-transform:uppercase;color:#8C897F;">Visit Reason</td><td style="padding:8px 0;border-bottom:1px solid #F0EEEB;font-size:13px;">${entry.visit_reason||'‚Äî'}</td></tr>
      <tr><td style="padding:8px 0;border-bottom:1px solid #F0EEEB;font-size:11px;font-weight:600;letter-spacing:0.1em;text-transform:uppercase;color:#8C897F;">Repair Cost</td><td style="padding:8px 0;border-bottom:1px solid #F0EEEB;font-size:13px;">${entry.repair_cost||'‚Äî'}</td></tr>
      <tr><td style="padding:8px 0;border-bottom:1px solid #F0EEEB;font-size:11px;font-weight:600;letter-spacing:0.1em;text-transform:uppercase;color:#8C897F;">Equity</td><td style="padding:8px 0;border-bottom:1px solid #F0EEEB;font-size:13px;">${entry.trade_equity||'‚Äî'}</td></tr>
      <tr><td style="padding:8px 0;border-bottom:1px solid #F0EEEB;font-size:11px;font-weight:600;letter-spacing:0.1em;text-transform:uppercase;color:#8C897F;">Timeline</td><td style="padding:8px 0;border-bottom:1px solid #F0EEEB;font-size:13px;">${entry.timeline||'‚Äî'}</td></tr>
      <tr><td style="padding:8px 0;border-bottom:1px solid #F0EEEB;font-size:11px;font-weight:600;letter-spacing:0.1em;text-transform:uppercase;color:#8C897F;">Logged By</td><td style="padding:8px 0;border-bottom:1px solid #F0EEEB;font-size:13px;">${entry.submitter||'‚Äî'}</td></tr>
      <tr><td style="padding:8px 0;font-size:11px;font-weight:600;letter-spacing:0.1em;text-transform:uppercase;color:#8C897F;">Outcome</td><td style="padding:8px 0;font-size:13px;font-weight:600;color:#C49A2A;">${entry.outcome||'‚Äî'}</td></tr>
    </table>
    ${entry.notes?`<div style="background:#F5F4F1;border-radius:6px;padding:14px 16px;margin-top:16px;"><div style="font-size:10px;font-weight:600;letter-spacing:0.1em;text-transform:uppercase;color:#8C897F;margin-bottom:6px;">Notes</div><div style="font-size:13px;">${entry.notes}</div></div>`:''}
    <div style="margin-top:20px;"><a href="https://servicebridge.vyaxis.com/manager-dashboard.html" style="display:inline-block;background:#C8102E;color:#fff;text-decoration:none;border-radius:6px;padding:12px 24px;font-size:13px;font-weight:600;">View in Dashboard ‚Üí</a></div>
  </div>
  <div style="background:#EDECEA;border:1px solid #E4E2DC;border-top:none;border-radius:0 0 12px 12px;padding:16px 28px;text-align:center;">
    <div style="font-size:11px;color:#8C897F;">ServiceBridge by Vyaxis ¬∑ Gallatin CDJR ¬∑ ${ts}</div>
  </div>
</div></body></html>`;
    fetch('/api/send-email',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({to:recipients,subject:`üî• Hot Lead Alert ‚Äî ${entry.first_name} ${entry.last_name} ¬∑ Temp ${score}/10 ¬∑ ${entry.veh_year||''} ${entry.veh_make||''} ${entry.veh_model||''}`,html:emailHtml})}).catch(()=>{});
  }

  // Preview
  const rows=[
    ['üè∑ Entry Type',role==='manager'?'üü° Manager Entry':'üî¥ Sales Entry',true],
    ['üë§ Submitted By',gv('sub-name'),false],['üìÖ Timestamp',ts,false],null,
    ['üë§ Customer',cust,false],['üìû Phone',gv('phone'),false],['‚úâ Email',gv('email'),false],
    ['üì≤ Contact Pref.',gv('cpref'),false],['‚è∞ Best Time',gv('ctime'),false],null,
    ['üöó Vehicle',veh,false],
    ['üìç Mileage',gv('vmi')?Number(gv('vmi')).toLocaleString()+' mi':'‚Äî',false],
    ['üîë Ownership',gv('vow'),false],['üí≥ Equity',gv('teq'),false],['‚öôÔ∏è Condition',gv('vcond'),false],null,
    ['üîß Visit Reason',gv('vreason'),false],['üí∞ Repair Cost',gv('rcost'),false],
    ['üìä Cost vs. Value',gv('rratio'),false],['üòê Customer Mood',gv('cemo'),false],
    ['ü§ù Intro Made',gv('intro'),false],null,
    ['üî• Buying Temp.',score!=='‚Äî'?`${score}/10`:'‚Äî',false],
    ['‚è± Timeline',gv('timeline'),false],['üè¶ Finance',gv('finconv'),false],null,
    ['‚úÖ Outcome',gv('outcome'),true],['üë®‚Äçüíº Salesperson',gv('sp'),false],
    ['üìÜ Follow-Up',gv('fdate'),false],['üìû Follow-Up Via',gv('fmeth'),false],
    ['üíæ CRM Entry',gv('crm'),false],['üìù Notes',gv('notes'),false],
  ];
  let html='';
  rows.forEach(r=>{
    if(!r){html+='<div class="pdiv"></div><div></div>';}
    else html+=`<div class="pk">${r[0]}</div><div class="pv${r[2]?' hl':''}">${r[1]}</div>`;
  });
  document.getElementById('preview-grid').innerHTML=html;
  document.getElementById('preview-wrap').classList.add('open');
  const crmMsg=isCRMEnabled()?' CRM pushed.':'';
  showToast(slaLabel?`Entry logged ‚úì Follow-up due in ${slaLabel}.${crmMsg}`:`Entry logged successfully ‚úì${crmMsg}`,false);
  document.getElementById('preview-wrap').scrollIntoView({behavior:'smooth',block:'start'});
  for(let i=1;i<=6;i++) mark(i);
  clearErrors();
  loadRecent();
}

// ‚îÄ‚îÄ RESET ‚îÄ‚îÄ
function resetForm(){
  clearErrors();
  document.querySelectorAll('input:not([type=checkbox]):not([type=hidden])').forEach(i=>i.value='');
  document.querySelectorAll('select').forEach(s=>s.selectedIndex=0);
  document.querySelectorAll('textarea').forEach(t=>t.value='');
  document.querySelectorAll('input[type=checkbox]').forEach(c=>c.checked=false);
  document.querySelectorAll('.expand').forEach(e=>e.classList.remove('open'));
  document.querySelectorAll('.tog-row').forEach(r=>r.classList.remove('on'));
  document.querySelectorAll('.pill').forEach(p=>p.className='pill');
  document.querySelectorAll('.sub-pill').forEach(p=>p.classList.remove('sel'));
  document.querySelectorAll('.s-btn').forEach(b=>b.className='s-btn');
  document.getElementById('sub-name').value='';document.getElementById('sub-role').value='';
  document.getElementById('escore').value='';document.getElementById('outcome').value='';document.getElementById('intro').value='';
  document.getElementById('crm').value='';
  document.getElementById('crm-cb').checked=false;
  document.getElementById('crm-row').classList.remove('on');
  vmd.innerHTML='<option value="">Model</option>';
  const d=document.getElementById('sp-disp');d.textContent='Select your name above to auto-assign';d.classList.remove('filled');
  document.getElementById('preview-wrap').classList.remove('open');
  for(let i=1;i<=6;i++){const s=document.getElementById(`s${i}`);if(s){s.classList.remove('done','active');s.querySelector('.step-n').textContent=i;}}
  document.getElementById('s1').classList.add('active');
  window.scrollTo({top:0,behavior:'smooth'});
}

// ‚îÄ‚îÄ RECENT ENTRIES ‚îÄ‚îÄ
async function loadRecent(){
  const container=document.getElementById('recent-entries');
  try{
    const res=await fetch(`${SB_URL}/rest/v1/s2s_entries?select=*&order=id.desc&limit=10`,{headers:H});
    const data=await res.json();
    if(!data.length){container.innerHTML='<p style="color:var(--text3);font-size:13px;padding:12px 0;">No entries yet.</p>';return;}
    container.innerHTML=data.map(e=>`
      <div class="recent-entry">
        <div>
          <div class="re-name">${e.submitter||'‚Äî'} <span>¬∑ ${e.first_name||''} ${e.last_name||''}</span></div>
          <div class="re-meta">${e.veh_year||''} ${e.veh_make||''} ${e.veh_model||''} ¬∑ ${e.outcome||'‚Äî'} ¬∑ Score: ${e.eng_score||'‚Äî'} ¬∑ ${e.created_at?new Date(e.created_at).toLocaleString('en-US',{month:'short',day:'numeric',hour:'numeric',minute:'2-digit'}):'‚Äî'}</div>
        </div>
        <button class="re-edit" onclick="openEdit(${e.id})">Edit</button>
      </div>`).join('');
  }catch(err){container.innerHTML='<p style="color:var(--text3);font-size:13px;">Failed to load entries.</p>';}
}

// ‚îÄ‚îÄ EDIT MODAL ‚îÄ‚îÄ
async function openEdit(id){
  const res=await fetch(`${SB_URL}/rest/v1/s2s_entries?id=eq.${id}`,{headers:H});
  const data=await res.json();
  if(!data.length)return;
  const e=data[0];
  document.getElementById('edit-id').value=e.id;
  document.getElementById('edit-submitter').value=e.submitter||'';
  document.getElementById('edit-first').value=e.first_name||'';
  document.getElementById('edit-last').value=e.last_name||'';
  document.getElementById('edit-phone').value=e.phone||'';
  document.getElementById('edit-year').value=e.veh_year||'';
  document.getElementById('edit-make').value=e.veh_make||'';
  document.getElementById('edit-model').value=e.veh_model||'';
  document.getElementById('edit-repair').value=e.repair_cost||'';
  document.getElementById('edit-outcome').value=e.outcome||'';
  document.getElementById('edit-score').value=e.eng_score||'';
  document.getElementById('edit-notes').value=e.notes||'';
  document.getElementById('edit-modal').classList.add('open');
}
function closeModal(){document.getElementById('edit-modal').classList.remove('open');}
document.getElementById('edit-modal').addEventListener('click',function(e){if(e.target===this)closeModal();});

function showEditToast(msg,type=''){
  const el=document.getElementById('edit-toast');
  el.textContent=msg;el.className='edit-toast show '+type;
  setTimeout(()=>el.className='edit-toast',3000);
}

async function saveEdit(){
  const id=document.getElementById('edit-id').value;
  const payload={
    submitter:document.getElementById('edit-submitter').value,
    first_name:document.getElementById('edit-first').value,
    last_name:document.getElementById('edit-last').value,
    phone:document.getElementById('edit-phone').value,
    veh_year:document.getElementById('edit-year').value,
    veh_make:document.getElementById('edit-make').value,
    veh_model:document.getElementById('edit-model').value,
    repair_cost:document.getElementById('edit-repair').value,
    outcome:document.getElementById('edit-outcome').value,
    eng_score:document.getElementById('edit-score').value,
    notes:document.getElementById('edit-notes').value,
  };
  await fetch(`${SB_URL}/rest/v1/s2s_entries?id=eq.${id}`,{method:'PATCH',headers:H,body:JSON.stringify(payload)});
  closeModal();showEditToast('‚úì Entry updated','green');loadRecent();
}

async function deleteEntry(){
  if(!confirm('Delete this entry? Cannot be undone.'))return;
  const id=document.getElementById('edit-id').value;
  await fetch(`${SB_URL}/rest/v1/s2s_entries?id=eq.${id}`,{method:'DELETE',headers:H});
  closeModal();showEditToast('Entry deleted');loadRecent();
}

// ‚îÄ‚îÄ AUTO-SELECT LOGGED-IN USER ‚îÄ‚îÄ
(function autoSelectSub(){
  if(!currentRep) return;
  const pills=document.querySelectorAll('.sub-pill');
  pills.forEach(p=>{
    const nameEl=p.querySelector('.sub-name');
    if(nameEl && nameEl.textContent.trim()===currentRep.name){
      p.click();
    }
  });
})();

loadRecent();
</script>
</body>
</html>
