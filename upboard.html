<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FloorIQ ‚Äî Up Board</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@400;500;600;700;800&family=DM+Mono:wght@500&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root {
    --bg: #05080F;
    --surface: #0C1018;
    --surface2: #121820;
    --border: rgba(255,255,255,0.07);
    --border2: rgba(255,255,255,0.12);
    --text: #EDF2FF;
    --muted: rgba(237,242,255,0.45);
    --muted2: rgba(237,242,255,0.2);
    --up-color: #F97316;
    --up-glow: rgba(249,115,22,0.35);
    --deck-color: #FBBF24;
    --customer-color: #34D399;
    --lunch-color: #60A5FA;
    --out-color: rgba(237,242,255,0.25);
    --red: #EF4444;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    width: 100vw;
    height: 100vh;
    overflow: hidden;
    -webkit-font-smoothing: antialiased;
  }

  /* Animated background grid */
  .bg-grid {
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(255,255,255,0.02) 1px, transparent 1px),
      linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px);
    background-size: 60px 60px;
    z-index: 0;
    pointer-events: none;
  }
  .bg-glow {
    position: fixed;
    top: -30%;
    left: 50%;
    transform: translateX(-50%);
    width: 900px;
    height: 600px;
    background: radial-gradient(ellipse, rgba(249,115,22,0.08) 0%, transparent 70%);
    pointer-events: none;
    z-index: 0;
  }

  /* Layout */
  .wrapper {
    position: relative;
    z-index: 1;
    width: 100vw;
    height: 100vh;
    display: flex;
    flex-direction: column;
    padding: 28px 36px 24px;
    gap: 20px;
  }

  /* Header */
  .header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-shrink: 0;
  }
  .header-left {
    display: flex;
    align-items: center;
    gap: 20px;
  }
  .logo-wrap {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .logo-icon {
    width: 44px;
    height: 44px;
    background: linear-gradient(135deg, #F97316, #EA580C);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 22px;
    box-shadow: 0 0 20px rgba(249,115,22,0.4);
  }
  .logo-text {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 32px;
    letter-spacing: 0.06em;
    color: var(--text);
    line-height: 1;
  }
  .logo-sub {
    font-size: 11px;
    font-weight: 600;
    letter-spacing: 0.16em;
    text-transform: uppercase;
    color: var(--up-color);
    margin-top: 2px;
  }
  .divider-v {
    width: 1px;
    height: 40px;
    background: var(--border2);
  }
  .store-name {
    font-size: 15px;
    font-weight: 700;
    color: var(--muted);
    letter-spacing: 0.04em;
    text-transform: uppercase;
  }

  .header-right {
    display: flex;
    align-items: center;
    gap: 24px;
  }
  .clock {
    font-family: 'DM Mono', monospace;
    font-size: 28px;
    font-weight: 500;
    color: var(--text);
    letter-spacing: 0.04em;
  }
  .clock-date {
    font-size: 11px;
    font-weight: 600;
    color: var(--muted);
    letter-spacing: 0.1em;
    text-transform: uppercase;
    text-align: right;
    margin-top: 2px;
  }
  .live-badge {
    display: flex;
    align-items: center;
    gap: 7px;
    padding: 6px 14px;
    background: rgba(249,115,22,0.1);
    border: 1px solid rgba(249,115,22,0.25);
    border-radius: 100px;
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--up-color);
  }
  .live-dot {
    width: 7px;
    height: 7px;
    border-radius: 50%;
    background: var(--up-color);
    animation: livePulse 1.5s ease infinite;
  }
  @keyframes livePulse {
    0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(249,115,22,0.6); }
    50% { opacity: 0.7; box-shadow: 0 0 0 5px transparent; }
  }

  /* Stats bar */
  .stats-bar {
    display: flex;
    gap: 16px;
    flex-shrink: 0;
  }
  .stat-pill {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 18px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    flex: 1;
  }
  .stat-icon {
    font-size: 18px;
  }
  .stat-label {
    font-size: 10px;
    font-weight: 700;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--muted2);
  }
  .stat-value {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 28px;
    letter-spacing: 0.04em;
    line-height: 1;
    color: var(--text);
  }
  .stat-value.orange { color: var(--up-color); }
  .stat-value.green { color: var(--customer-color); }
  .stat-value.yellow { color: var(--deck-color); }

  /* Rep grid */
  .rep-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 16px;
    flex: 1;
    min-height: 0;
  }

  .rep-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 22px 20px 20px;
    display: flex;
    flex-direction: column;
    gap: 14px;
    position: relative;
    overflow: hidden;
    transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
  }
  .rep-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
    background: transparent;
    transition: background 0.4s;
  }
  .rep-card.status-up {
    border-color: rgba(249,115,22,0.4);
    background: linear-gradient(135deg, rgba(249,115,22,0.08) 0%, var(--surface) 60%);
    box-shadow: 0 0 40px rgba(249,115,22,0.15), inset 0 0 40px rgba(249,115,22,0.03);
    animation: upPulse 3s ease infinite;
  }
  .rep-card.status-up::before { background: linear-gradient(90deg, transparent, var(--up-color), transparent); }
  @keyframes upPulse {
    0%, 100% { box-shadow: 0 0 30px rgba(249,115,22,0.15), inset 0 0 40px rgba(249,115,22,0.03); }
    50% { box-shadow: 0 0 50px rgba(249,115,22,0.25), inset 0 0 40px rgba(249,115,22,0.06); }
  }
  .rep-card.status-deck {
    border-color: rgba(251,191,36,0.3);
    background: linear-gradient(135deg, rgba(251,191,36,0.05) 0%, var(--surface) 60%);
  }
  .rep-card.status-deck::before { background: linear-gradient(90deg, transparent, var(--deck-color), transparent); }
  .rep-card.status-customer {
    border-color: rgba(52,211,153,0.3);
    background: linear-gradient(135deg, rgba(52,211,153,0.05) 0%, var(--surface) 60%);
  }
  .rep-card.status-customer::before { background: linear-gradient(90deg, transparent, var(--customer-color), transparent); }
  .rep-card.status-inactive {
    opacity: 0.45;
  }

  /* Position badge */
  .position-badge {
    position: absolute;
    top: 14px;
    right: 14px;
    width: 26px;
    height: 26px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 14px;
    letter-spacing: 0.05em;
    background: var(--surface2);
    color: var(--muted2);
    border: 1px solid var(--border);
  }
  .rep-card.status-up .position-badge {
    background: rgba(249,115,22,0.15);
    color: var(--up-color);
    border-color: rgba(249,115,22,0.3);
  }

  /* Avatar */
  .rep-top {
    display: flex;
    align-items: center;
    gap: 14px;
  }
  .rep-avatar {
    width: 52px;
    height: 52px;
    border-radius: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 20px;
    letter-spacing: 0.05em;
    flex-shrink: 0;
    position: relative;
  }
  .rep-card.status-up .rep-avatar {
    background: linear-gradient(135deg, #F97316, #EA580C);
    color: #fff;
    box-shadow: 0 4px 16px rgba(249,115,22,0.4);
  }
  .rep-card.status-deck .rep-avatar {
    background: rgba(251,191,36,0.15);
    color: var(--deck-color);
    border: 1px solid rgba(251,191,36,0.3);
  }
  .rep-card.status-customer .rep-avatar {
    background: rgba(52,211,153,0.12);
    color: var(--customer-color);
    border: 1px solid rgba(52,211,153,0.25);
  }
  .rep-card.status-lunch .rep-avatar,
  .rep-card.status-inactive .rep-avatar {
    background: rgba(255,255,255,0.05);
    color: var(--muted2);
    border: 1px solid var(--border);
  }
  .rep-info { flex: 1; min-width: 0; }
  .rep-name {
    font-size: 17px;
    font-weight: 800;
    letter-spacing: -0.3px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    line-height: 1.2;
    margin-bottom: 5px;
  }
  .rep-card.status-inactive .rep-name { color: var(--muted); }

  /* Status tag */
  .status-tag {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 3px 10px;
    border-radius: 100px;
    font-size: 10px;
    font-weight: 700;
    letter-spacing: 0.1em;
    text-transform: uppercase;
  }
  .tag-up { background: rgba(249,115,22,0.2); color: var(--up-color); border: 1px solid rgba(249,115,22,0.3); }
  .tag-deck { background: rgba(251,191,36,0.15); color: var(--deck-color); border: 1px solid rgba(251,191,36,0.25); }
  .tag-customer { background: rgba(52,211,153,0.12); color: var(--customer-color); border: 1px solid rgba(52,211,153,0.2); }
  .tag-lunch { background: rgba(96,165,250,0.12); color: var(--lunch-color); border: 1px solid rgba(96,165,250,0.2); }
  .tag-out { background: rgba(255,255,255,0.05); color: var(--muted); border: 1px solid var(--border); }

  /* Stats row */
  .rep-stats {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 8px;
  }
  .rep-stat {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 9px 10px;
    text-align: center;
  }
  .rep-stat-val {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 22px;
    letter-spacing: 0.04em;
    line-height: 1;
    color: var(--text);
  }
  .rep-card.status-up .rep-stat-val { color: var(--up-color); }
  .rep-card.status-customer .rep-stat-val { color: var(--customer-color); }
  .rep-stat-label {
    font-size: 9px;
    font-weight: 700;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--muted2);
    margin-top: 2px;
  }

  /* Be back timer */
  .be-back-bar {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
    background: rgba(96,165,250,0.08);
    border: 1px solid rgba(96,165,250,0.2);
    border-radius: 10px;
    font-size: 11px;
    font-weight: 600;
    color: var(--lunch-color);
  }

  /* Footer */
  .footer {
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-shrink: 0;
    padding-top: 4px;
    border-top: 1px solid var(--border);
  }
  .footer-left {
    display: flex;
    align-items: center;
    gap: 20px;
  }
  .footer-brand {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 16px;
    letter-spacing: 0.12em;
    color: var(--muted2);
  }
  .footer-brand span { color: var(--up-color); }
  .last-updated {
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    color: var(--muted2);
    letter-spacing: 0.06em;
  }
  .footer-right {
    display: flex;
    align-items: center;
    gap: 16px;
  }
  .legend-item {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 10px;
    font-weight: 600;
    color: var(--muted);
    letter-spacing: 0.06em;
    text-transform: uppercase;
  }
  .legend-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
  }

  /* Empty state */
  .empty-grid {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    flex: 1;
    gap: 16px;
    color: var(--muted);
  }
  .empty-grid .big-icon { font-size: 64px; opacity: 0.3; }
  .empty-grid p { font-size: 18px; font-weight: 600; }

  /* Loading shimmer */
  .shimmer {
    background: linear-gradient(90deg, var(--surface) 25%, var(--surface2) 50%, var(--surface) 75%);
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
    border-radius: 10px;
  }
  @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

  /* Notification toast */
  .toast {
    position: fixed;
    bottom: 32px;
    left: 50%;
    transform: translateX(-50%) translateY(100px);
    background: var(--surface);
    border: 1px solid var(--border2);
    border-radius: 14px;
    padding: 14px 24px;
    font-size: 14px;
    font-weight: 600;
    color: var(--text);
    z-index: 999;
    transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    box-shadow: 0 20px 40px rgba(0,0,0,0.4);
    display: flex;
    align-items: center;
    gap: 10px;
    white-space: nowrap;
  }
  .toast.show { transform: translateX(-50%) translateY(0); }
  .toast.up { border-color: rgba(249,115,22,0.4); }
  .toast.customer { border-color: rgba(52,211,153,0.4); }
</style>
</head>
<body>

<div class="bg-grid"></div>
<div class="bg-glow"></div>

<div class="wrapper">

  <!-- Header -->
  <div class="header">
    <div class="header-left">
      <div class="logo-wrap">
        <div class="logo-icon">‚ö°</div>
        <div>
          <div class="logo-text">FloorIQ</div>
          <div class="logo-sub">Up Board</div>
        </div>
      </div>
      <div class="divider-v"></div>
      <div>
        <div class="store-name">Gallatin CDJR</div>
        <div style="font-size:11px;color:var(--muted2);margin-top:2px;font-weight:500;">Sales Floor ¬∑ Live Rotation</div>
      </div>
    </div>
    <div class="header-right">
      <div class="live-badge"><div class="live-dot"></div>LIVE</div>
      <div>
        <div class="clock" id="clock">--:-- --</div>
        <div class="clock-date" id="clock-date">--- --, ----</div>
      </div>
    </div>
  </div>

  <!-- Stats Bar -->
  <div class="stats-bar">
    <div class="stat-pill">
      <div class="stat-icon">üî•</div>
      <div>
        <div class="stat-label">Up Now</div>
        <div class="stat-value orange" id="stat-up-now">‚Äî</div>
      </div>
    </div>
    <div class="stat-pill">
      <div class="stat-icon">ü§ù</div>
      <div>
        <div class="stat-label">With Customer</div>
        <div class="stat-value green" id="stat-with-customer">‚Äî</div>
      </div>
    </div>
    <div class="stat-pill">
      <div class="stat-icon">üë•</div>
      <div>
        <div class="stat-label">Active Reps</div>
        <div class="stat-value" id="stat-active">‚Äî</div>
      </div>
    </div>
    <div class="stat-pill">
      <div class="stat-icon">üöó</div>
      <div>
        <div class="stat-label">Ups Today</div>
        <div class="stat-value orange" id="stat-ups-today">‚Äî</div>
      </div>
    </div>
    <div class="stat-pill">
      <div class="stat-icon">‚úÖ</div>
      <div>
        <div class="stat-label">Sold Today</div>
        <div class="stat-value green" id="stat-sold-today">‚Äî</div>
      </div>
    </div>
  </div>

  <!-- Rep Grid -->
  <div class="rep-grid" id="rep-grid">
    <!-- Populated by JS -->
    <div style="grid-column:1/-1;display:flex;align-items:center;justify-content:center;gap:12px;color:var(--muted);">
      <div class="shimmer" style="width:100%;height:100%;border-radius:20px;"></div>
    </div>
  </div>

  <!-- Footer -->
  <div class="footer">
    <div class="footer-left">
      <div class="footer-brand">Floor<span>IQ</span> ¬∑ Vyaxis</div>
      <div class="last-updated">Last updated: <span id="last-updated">--:--:--</span></div>
    </div>
    <div class="footer-right">
      <div class="legend-item"><div class="legend-dot" style="background:var(--up-color);"></div>Up Now</div>
      <div class="legend-item"><div class="legend-dot" style="background:var(--deck-color);"></div>On Deck</div>
      <div class="legend-item"><div class="legend-dot" style="background:var(--customer-color);"></div>With Customer</div>
      <div class="legend-item"><div class="legend-dot" style="background:var(--lunch-color);"></div>At Lunch / Be Back</div>
      <div class="legend-item"><div class="legend-dot" style="background:var(--muted2);"></div>Out / Inactive</div>
    </div>
  </div>

</div>

<!-- Toast notification -->
<div class="toast" id="toast"></div>

<script>
  const SB_URL = 'https://jbkgwtohwsbaorhvuuqb.supabase.co';
  const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impia2d3dG9od3NiYW9yaHZ1dXFiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5NjkwNDIsImV4cCI6MjA4NzU0NTA0Mn0.GRXOYbIuVDxU9-FEBYmyd1QmytVUrMIAxbnOSfepzuU';

  const { createClient } = supabase;
  const db = createClient(SB_URL, SB_KEY);

  let reps = [];
  let prevUpNow = null;

  // ‚îÄ‚îÄ‚îÄ Clock ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function updateClock() {
    const now = new Date();
    const time = now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', second: '2-digit', hour12: true });
    const date = now.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' });
    document.getElementById('clock').textContent = time;
    document.getElementById('clock-date').textContent = date;
  }
  setInterval(updateClock, 1000);
  updateClock();

  // ‚îÄ‚îÄ‚îÄ Toast ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function showToast(msg, type = '') {
    const el = document.getElementById('toast');
    el.textContent = msg;
    el.className = 'toast show ' + type;
    setTimeout(() => { el.className = 'toast'; }, 3500);
  }

  // ‚îÄ‚îÄ‚îÄ Initials ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function getInitials(name) {
    return name.split(' ').map(w => w[0]).join('').toUpperCase().slice(0, 2);
  }

  // ‚îÄ‚îÄ‚îÄ Status helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function getStatusClass(status) {
    if (!status) return 'status-inactive';
    const s = status.toLowerCase();
    if (s === 'up now') return 'status-up';
    if (s === 'on deck') return 'status-deck';
    if (s === 'with customer') return 'status-customer';
    if (s === 'at lunch' || s === 'be back') return 'status-lunch';
    return 'status-inactive';
  }
  function getTagClass(status) {
    if (!status) return 'tag-out';
    const s = status.toLowerCase();
    if (s === 'up now') return 'tag-up';
    if (s === 'on deck') return 'tag-deck';
    if (s === 'with customer') return 'tag-customer';
    if (s === 'at lunch' || s === 'be back') return 'tag-lunch';
    return 'tag-out';
  }
  function getStatusEmoji(status) {
    if (!status) return '‚Äî';
    const s = status.toLowerCase();
    if (s === 'up now') return 'üî•';
    if (s === 'on deck') return '‚è≠';
    if (s === 'with customer') return 'ü§ù';
    if (s === 'at lunch') return 'üçΩ';
    if (s === 'be back') return '‚è∞';
    if (s === 'out') return 'üö™';
    return '‚Äî';
  }

  // ‚îÄ‚îÄ‚îÄ Render ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function renderReps(data) {
    const grid = document.getElementById('rep-grid');

    // Sort: Up Now ‚Üí On Deck ‚Üí With Customer ‚Üí Lunch/BeBack ‚Üí Inactive/Out
    const order = { 'up now': 0, 'on deck': 1, 'with customer': 2, 'at lunch': 3, 'be back': 4, 'out': 5, 'inactive': 6 };
    const sorted = [...data].sort((a, b) => {
      const sa = (a.status || 'inactive').toLowerCase();
      const sb = (b.status || 'inactive').toLowerCase();
      const oa = order[sa] ?? 5;
      const ob = order[sb] ?? 5;
      if (oa !== ob) return oa - ob;
      return (a.position || 99) - (b.position || 99);
    });

    // Stats
    const upNow = sorted.filter(r => (r.status || '').toLowerCase() === 'up now');
    const withCustomer = sorted.filter(r => (r.status || '').toLowerCase() === 'with customer');
    const active = sorted.filter(r => !['out', 'inactive', ''].includes((r.status || '').toLowerCase()));
    const totalUps = sorted.reduce((s, r) => s + (r.ups_today || 0), 0);
    const totalSold = sorted.reduce((s, r) => s + (r.sold_today || 0), 0);

    document.getElementById('stat-up-now').textContent = upNow[0]?.rep_name?.split(' ')[0] || '‚Äî';
    document.getElementById('stat-with-customer').textContent = withCustomer.length;
    document.getElementById('stat-active').textContent = active.length;
    document.getElementById('stat-ups-today').textContent = totalUps;
    document.getElementById('stat-sold-today').textContent = totalSold;

    // Toast on rotation change
    if (upNow.length > 0 && upNow[0].rep_name !== prevUpNow) {
      if (prevUpNow !== null) {
        showToast(`üî• ${upNow[0].rep_name} is now UP`, 'up');
      }
      prevUpNow = upNow[0].rep_name;
    }

    // Render cards ‚Äî dynamically adjust columns
    const count = sorted.filter(r => (r.status || 'inactive').toLowerCase() !== 'inactive').length || sorted.length;
    const cols = count <= 3 ? count : count <= 6 ? 3 : count <= 8 ? 4 : 4;
    grid.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;

    grid.innerHTML = sorted.map((rep, i) => {
      const statusClass = getStatusClass(rep.status);
      const tagClass = getTagClass(rep.status);
      const initials = rep.initials || getInitials(rep.rep_name || '?');
      const isBeBack = (rep.status || '').toLowerCase() === 'be back';
      const beBackTime = rep.be_back_time ? new Date(rep.be_back_time).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }) : null;

      return `
        <div class="rep-card ${statusClass}" style="animation-delay:${i * 0.05}s">
          <div class="position-badge">${i + 1}</div>
          <div class="rep-top">
            <div class="rep-avatar">${initials}</div>
            <div class="rep-info">
              <div class="rep-name">${rep.rep_name || 'Unknown'}</div>
              <span class="status-tag ${tagClass}">${getStatusEmoji(rep.status)} ${rep.status || 'Inactive'}</span>
            </div>
          </div>
          ${isBeBack && beBackTime ? `
            <div class="be-back-bar">‚è∞ Back at ${beBackTime}</div>
          ` : ''}
          <div class="rep-stats">
            <div class="rep-stat">
              <div class="rep-stat-val">${rep.ups_today || 0}</div>
              <div class="rep-stat-label">Ups</div>
            </div>
            <div class="rep-stat">
              <div class="rep-stat-val">${rep.sold_today || 0}</div>
              <div class="rep-stat-label">Sold</div>
            </div>
            <div class="rep-stat">
              <div class="rep-stat-val">${rep.ups_today > 0 ? Math.round((rep.sold_today || 0) / rep.ups_today * 100) : 0}%</div>
              <div class="rep-stat-label">Close%</div>
            </div>
          </div>
        </div>
      `;
    }).join('');

    // Update last-updated timestamp
    const now = new Date();
    document.getElementById('last-updated').textContent = now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', second: '2-digit' });
  }

  // ‚îÄ‚îÄ‚îÄ Fetch data ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function fetchReps() {
    const { data, error } = await db
      .from('up_rotation')
      .select('*')
      .order('position', { ascending: true });

    if (error) {
      console.error('Supabase error:', error);
      return;
    }

    reps = data || [];
    renderReps(reps);
  }

  // ‚îÄ‚îÄ‚îÄ Realtime subscription ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function subscribeToChanges() {
    db.channel('up_rotation_changes')
      .on('postgres_changes', {
        event: '*',
        schema: 'public',
        table: 'up_rotation'
      }, (payload) => {
        fetchReps();
      })
      .subscribe();
  }

  // ‚îÄ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  fetchReps();
  subscribeToChanges();

  // Fallback poll every 15 seconds in case realtime drops
  setInterval(fetchReps, 15000);
</script>
</body>
</html>
